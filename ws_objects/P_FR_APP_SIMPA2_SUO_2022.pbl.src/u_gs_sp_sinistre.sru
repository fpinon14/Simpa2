$PBExportHeader$u_gs_sp_sinistre.sru
$PBExportComments$---} User Object pour la gestion des sinistres. (W_SIN)
forward
global type u_gs_sp_sinistre from u_gs_sp_sinistre_anc
end type
end forward

global type u_gs_sp_sinistre from u_gs_sp_sinistre_anc
string issysadm = ""
long ildernieridprod = 0
long ildernieridrev = 0
end type
global u_gs_sp_sinistre u_gs_sp_sinistre

type variables
Public :
	String			isReferentielApp
	Boolean			ib2EmeTourPI052 // [PI052]	

Private :
	u_gs_sp_sinistre_2 iUoGsSpSinistre2  // [20241112110249883][DIVOBJ][JFF]
	u_gs_sp_sinistre iuoThis // [20241112110249883][DIVOBJ][JFF]
	
	u_Libelle_Dga		iUoLibelle
	N_Cst_Saisie_Validation_Sinistre	invSaisieValSin

	PictureButton		iPbControler

	u_DataWindow_Detail	idw_LstInter
	u_DataWindow_Detail	idw_LstGti
	u_DataWindow_Detail	idw_LstContact
	u_DataWindow_Detail	idw_LstwCommande
	u_DataWindow_Detail	idw_wDivDet
	u_DataWindow		idw_DosSuiviPar

	u_DataWindow		idw_BoiteArchive
	u_DataWindow 		idw_wDivSin

	DataWindow		idw_CodeGarantie
	DataWindow		idw_CodeCondition
	DataWindow		idw_Piece
	DataWindow		idw_Motif
	DataWindow		idw_Franchise
	DataWindow		idw_Plafond
	DataWindow		idw_Delai
	DataWindow		idw_Garantie
	DataWindow		idw_Condition
	DataWindow		idw_ParaProd
	DataWindow		idw_wParaInfo
	DataWindow		idw_wDetail
	DataWindow		idw_wPiece
	DataWindow		idw_wRefus
	DataWindow		idw_wFrais
	DataWindow		idw_wCourrier
	DataWindow		idw_Police
	DataWindow		idw_wParaPlafond
	DataWindow		idw_wRegGti
	DataWindow		idw_wreg_frais_annexe_frn // [PM80_FA12_FRANEX]
	DataWindow		idw_Corbeille
	DataWindow		idw_Article
	DataWindow		idw_CmdTypFrn
	DataWindow		idw_CmdTypArt
//Migration PB8-WYNIWYG-03/2006 OR
//variable supprimée car existant dans l'ancêtre
//	DataWindow		idw_DetPro	// DCMP 030027
//Fin Migration PB8-WYNIWYG-03/2006 OR
	DataWindow		idw_Boutique	// DCMP 030135
	DataWindow		idw_Commune	// DCMP 030362
	DataWindow		idw_TacImei
	DataWindow		idw_Mail	// DCMP 030408
	DataWindow		idw_Autorisation
	DataWindow		idw_DivPro
	DataWindow		idddw_CodeCar_wDivSin_Charg_Tempo, idddw_Code_wDivSin_Charg_Tempo
	DataWindow		idw_CodEqVal
	DataWindow		idw_stk_Ifr, idddw_IfrMarque, idddw_IfrModele
	DataWindow		idw_CodeMB
	DataWindow		idddw_DtyMarque, idddw_DtyModele
	DataWindow		idw_CodeRF
	DataWindow		idwStkCodicDarty
	DataWindow		idw_DivPDet

	// SVE DCMP 040020
	DataWindow		iDddwTypeDoc
	DataWindow		iDwStkWCourBlobSve
	DataWindow		iDwCompo

	String			isCodeIProv
	String			isCodRecu
	String			isDteCourCli
	String			isFicTraceAdr
//Migration PB8-WYNIWYG-03/2006 OR
//variable supprimée car existant dans l'ancêtre
//	String			isRepWin
//Fin Migration PB8-WYNIWYG-03/2006 OR
	String			isIMEICtrl
	String			isIMEIClient
	String			isFicSig   // DCMP 040020 SVE

	Long			ilTotVar

	Long			ilIdNatSin
	Long			ilIdTerrit
	Long			ilIdDetSin

	Integer			ilCodEtatMac, ilCodEtatOpe, ilCodEtat 

	Date			idDteAch, idDteOuvLig, idDteResil

	DateTime			idtDteSurv

	Boolean			ibAltContact
	Boolean			ibAltContactSherpa 
	Boolean			ibAltTelephonie
	Boolean			ibAltOuvFenVal
	Boolean			ibAltCourrier   // True, au moin un courrier à Edt.
	Boolean			ibAltCmdMobile // Gestion Cmd de mobile
	Boolean			ibAltCommune   // DCMP 030362 Gestion des commune O/N
	Boolean			ibSaisieValidation  // SVE DCMP 040020
	Boolean			ibCodicDartyValide
	Boolean			ibPI052_GenEdtKsl2 // [PI052]
	Boolean			ibPM506_AssureARisque // [PM506-1]
	Boolean			ibDp385 // [MCO602_PNEU]
	Boolean			ibMIG1_CourEmailing // [MIG1_COUR_EMAILING]
	
	
	String			isTabVarOrange[7,2] // 3 Dim : D1=Inter, D2=Code cour Orange D3=Nb cour

	String			isCodTypRecu		// [DCMP090616]
	
	ListBox			ilbFichier
	string isListEnvZ0[6] = {'Z014','Z017','Z040','Z041','Z042','Z043'} // [DCMP050251]
	constant integer K_DEFAUT = 1  // [CRAO_LOT1] : Constante pour uf_gestong_divers_majzone
	constant integer K_MAJZONE = 2 // [CRAO_LOT1] : Constante pour uf_gestong_divers_majzone

	constant integer K_NB_MX_CAR_MDP_NET = 6 // [SITE_CMDE] Nbre de caractère maximum pour la génération du mdp donnant accès à l'extranet.
	constant integer K_NB_MX_CAR_MDP_NET_BTQ = 6 // [WEBSIM2].[FRANCE] Nbre de caractère maximum pour la génération du mdp donnant accès à l'extranet.	
	//	Constantes pour définir les options
	constant integer K_DP85_GESTIONPGC = 85 // [DCMP070284] : Option 85 : Gestion Prise en charge garantie constructeur
	
//	soapconnection isoapcnx // [MIG_PB2022] soapconnection obsolète
	
	StaticText		istPauseAPI_LAB  // [PM506-1]

	u_Transaction_Hub_Prestataire itrHubPrestataire  // [HP252_276_HUB_PRESTA]
	StaticText		istAttenteDiverse  // [HP252_276_HUB_PRESTA]
	
	DataStore 		idsHubDonneesPrestaSimpa2 // [HP252_276_HUB_PRESTA]


end variables

forward prototypes
public subroutine uf_traitement (integer aitype, ref s_pass astpass)
private subroutine uf_preparermodifier (ref s_pass astpass)
private subroutine uf_tb_coordonnees ()
private subroutine uf_tb_nature ()
private subroutine uf_tb_sanssuite ()
private subroutine uf_tb_validation ()
private function string uf_titre (integer aitype)
private subroutine uf_controlersaisie (ref s_pass astpass)
private subroutine uf_zn_altbloc ()
private subroutine uf_controlergestion (ref s_pass astpass)
private subroutine uf_terminervalider (ref s_pass astpass)
private subroutine uf_chargerrevision ()
private subroutine uf_zn_altssui ()
private subroutine uf_cast_dtesurv ()
private function string uf_determiner_composition ()
private subroutine uf_determiner_macro (ref string astxtcompo1, long alliginter)
private subroutine uf_effacer_fichier_word ()
private function boolean uf_enregistrer_w_inter_blob_data ()
private subroutine uf_enregistrer_w_inter_blob_blob (ref s_pass astpass)
private function string uf_determiner_data_interlocuteur (long alcptinter)
private subroutine uf_determiner_data_interlocuteur_liste_p (long alcptinter)
private subroutine uf_determiner_data_interlocuteur_liste_r (long alcptinter)
private subroutine uf_determiner_data_interlocuteur_liste_g (long alcptinter)
private function string uf_calcul_montant_inter ()
private function boolean uf_determiner_etat_garantie (integer aitype)
private subroutine uf_calculrevision_initial ()
private subroutine uf_gestion_str2nul ()
private subroutine uf_calcul_w_reg_gti ()
private subroutine uf_ecriretrace_adresse ()
private subroutine uf_preparervalider (ref s_pass astpass)
private function boolean uf_ctl_nature_contact ()
private function boolean uf_rech_nouveau_contact (long alnature[], long alnbcontact)
private function string uf_controlergestion_commandes ()
private subroutine uf_tb_telephonie ()
private subroutine uf_activerbmgme (boolean abactiv)
private subroutine uf_controlersaisie_commune (ref string astext, ref string aspos)
private function boolean uf_gestionboitearchive ()
private subroutine uf_epuration_zonecommune (ref string asville, ref integer aicode)
private function string uf_format_numtel (string asvarstr)
private subroutine uf_controlersaisie_boutique (integer alcas, ref string astext, ref string aspos)
private function string uf_determiner_casparticulier (ref string asidnatcour, integer aiidinter)
private subroutine uf_determiner_data_inter_numletchq (long alcptinter, decimal adcmtareg, ref string asval)
private subroutine uf_terminervalider_inter ()
public subroutine uf_initialiser_sve (ref s_pass astpasssve, ref n_cst_saisie_validation_sinistre anvsaisievalsin, ref listbox albfichier)
public function string uf_getdatainter (integer alidinter)
private function string uf_determiner_courrier (ref integer aidroitinter[])
private subroutine uf_determiner_courrier_majdroit (string asidnatcour, integer aiidi, ref integer aidroitinter[])
private subroutine uf_initialiser_sign_personnalisee ()
public function boolean uf_getautorisation2 (long aliddroit)
private subroutine uf_gestong_divers ()
private subroutine uf_terminervalider_wdivsin ()
private function string uf_controlergestion_ongletdivers (ref string asong)
private subroutine uf_terminervalider_wcourrier ()
public subroutine uf_gestong_divers_dddw (string asdata, string asnomcol, long alrow)
private subroutine uf_gestong_divers_defautzone (string asnomzone, integer aiidprod, long alrow)
private subroutine uf_gestong_divers_caspart_liste (string asnomzone, integer aiidprod)
private subroutine uf_gestong_divers_caspart_finaux ()
public function string uf_determiner_referentiel (string astypeapp)
private subroutine uf_initialiserfenetre (ref s_pass astpassdga)
public function string uf_gestong_divers_trouver (string asnomzone)
private function boolean uf_validation_finale_darty_mail_tel ()
private function boolean uf_validation_finale_darty_mail_nomade ()
private function boolean uf_terminervalider_wdivsin_caspart ()
private subroutine uf_tb_dteresil ()
private subroutine uf_gestion_dtefingti_orangev2 (date addteresil, string ascas)
private subroutine uf_gestion_dtefingti (date addteresil, string ascas)
private function integer uf_zn_dteresil ()
private function string uf_determiner_etat (integer aitype, string ascas, ref long alcodetat)
private function long uf_zn_dtesurv ()
private function long uf_zn_heusurv ()
private function long uf_zn_boutique ()
private function long uf_zn_numimeiport ()
private function long uf_zn_trt_divsin_vallst (string asdata, string asnomcol, long alrow)
private function long uf_zn_trt_divsin_codic (string asdata, string asnomcol, long alrow, boolean abforcer)
private function long uf_zn_trt_divsin_valdte (string asdata, string asnomcol, long alrow)
private function long uf_zn_trt_divsin_provisionfrais (string asdata, string asnomcol, long alrow, boolean abforcer)
public function long uf_zn_trt (ref s_pass astpass)
public function long uf_zn_trt_divsin (string asdata, string asnomcol, long alrow, string asnomzone)
public function long uf_paraexist (string astextcompo, string aspara[])
private function long uf_decompo_adr_mail ()
private function long uf_zn_trt_divsin_dteticket (string asdata, string asnomcol, long alrow)
public subroutine uf_getautorisation (string asidnatcour, ref string asbin, ref boolean abmodifcour, ref boolean abvalauto, ref boolean abvalidation, integer aiidi)
private function boolean uf_validation_finale_trt_particuliers ()
private function boolean uf_validation_finale_mds_mail_nomade (string ascasgestionmds)
private function boolean uf_validation_finale_mvl_mail_cycle ()
private function long uf_zn_numimei_numport ()
private function long uf_zn_numport ()
public subroutine uf_gestong_divers_setfocus (string asnomzone)
private function string uf_gestion_mdp_extranet_cmde (string ascas)
private function long uf_zn_trt_divsin_rgn_mdp_net (string asdata, string asnomcol, long alrow)
private subroutine uf_determiner_courrier_forcage_web (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
private function boolean uf_gestioncp (string ascas, integer aiidinter, string ascodinter)
private function long uf_zn_codmotssui ()
private function long uf_zn_trt_divsin_duree_gti_origine (string asdata, string asnomcol, long alrow)
public function boolean uf_controlergestion_ctrlreglfactu ()
private function boolean uf_controlergestion_accordassureur (string ascas)
private subroutine uf_determiner_courrier_forcage_o2m (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
public function datetime uf_lire_date_achat ()
private function boolean uf_validation_finale_horaire ()
public subroutine uf_correction_bug_w_para_plafond ()
public function string uf_controler_param_aig ()
private function boolean uf_validation_finale_scf_mail_ech_expr ()
public function boolean uf_getautorisation (string assection, integer aino)
private subroutine uf_controlersaisie_sms (ref string astext, ref string aspos)
private subroutine uf_determiner_data_sinistre_plafpec (ref string asmtpecmonnaie, ref string asmtpeccentimes)
private function long uf_zn_trt_divsin_moderemplacement (string asdata, string asnomcol, long alrow)
private function boolean uf_validation_finale_envoi_sms ()
private subroutine uf_determiner_data_propo_appareil (ref string aspropoappareil)
private function boolean uf_validation_finale_mcy_mail_telnomade ()
private function boolean uf_validation_finale_envoi_sms_rbsurfact (integer ioptiondp)
public subroutine uf_controlersaisie_pecweb (ref string astext, ref string aspos)
private subroutine uf_set_profilfacturation ()
private subroutine uf_determiner_courrier_forcage (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
private subroutine uf_determiner_courrier_forcage_scfechexp (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
private function long uf_zn_trt_divsin_num_fact (string asdata, string asnomcol, long alrow)
private function boolean uf_validation_finale_mcy_mail_telnomade1 ()
private function boolean uf_validation_finale_mcy_mail_telnomade2 ()
private function boolean uf_validation_finale_ex5_mail_pec ()
public function string uf_gestion_mdp_extranet_cmde_boutique (string ascas)
private function long uf_zn_trt_divsin_rgn_mdp_net_btq (string asdata, string asnomcol, long alrow)
private function string uf_epurezone (string asvaleur)
private function boolean uf_validation_finale_eco_mail_remplpc ()
private function boolean uf_validation_finale_sav_carrefour_mail ()
private function boolean uf_validation_finale_rdc_mail_bonachat ()
private function boolean uf_validation_finale_grosbill_mailaxaprs ()
private function boolean uf_validation_finale_grosbill_mailgrbcmd ()
private subroutine uf_determiner_courrier_forcage_auchan (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
public subroutine uf_gestong_divers_majzone (string asnomzone, long alrow, integer aitrt, any aavalue)
private function boolean uf_validation_finale_eco_mail_remplpc2 ()
private function boolean uf_validation_finale_eco_mail_demenlevt ()
private function boolean uf_validation_finale_eco_mail_refus ()
private function boolean uf_controlergestion_bge ()
private function boolean uf_validation_finale_mbs_mail ()
private function boolean uf_validation_finale_lde_mail ()
private subroutine uf_gestion_dtefingti_dp29 (string asduree, string asunite, string asdureeminmaj, string asuniteminmaj, boolean abecraser)
private subroutine uf_validation_finale (ref s_pass astpass)
private function boolean uf_validation_finale_mail_pec_assure ()
private function long uf_zn_trt_divsin_recupo2m (string asdata, string asnomcol, long alrow)
private function long uf_zn_natsin ()
private subroutine uf_determiner_courrier_forcage_psm (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
private function boolean uf_validation_finale_cds_mail_pec ()
private function boolean uf_validation_finale_confo_mail_refus ()
private function long uf_zn_id_detsin ()
private function integer uf_zn_altedit ()
private function boolean uf_validation_finale_mds_mail_tel_pm191 ()
private function boolean uf_validation_finale_mds_mail_nomade1_19 ()
private function boolean uf_validation_finale_mds_mail_nomade2_19 ()
private function string uf_createxml_ksl (string asobjet, string asmailfrom, string asmaildest, string ascodemaquette, string ascas, s_pass astpass)
private function boolean uf_validation_finale_darty_mail_nomade19 ()
private function boolean uf_validation_finale_darty_mail_tel19 ()
private function boolean uf_validation_finale_darty_mail_tel29 ()
private function boolean uf_validation_finale_darty_mail_nomade29 ()
private function boolean uf_validation_finale_darty_mail_nomade39 ()
private function boolean uf_validation_finale_darty_mail_nomade49 ()
private function boolean uf_validation_finale_mbs_mail_devis_pm19 ()
private function boolean uf_validation_finale_mbs_mail_diag_pm191 ()
private function boolean uf_validation_finale_mbs_mail_nomade_191 ()
private function boolean uf_validation_finale_mbs_mail_tel1_pm191 ()
private function boolean uf_validation_finale_mbs_mail_tel2_pm191 ()
private function boolean uf_validation_finale_converlance_mail ()
private function boolean uf_validation_finale_msg_dp206 (string asvalcar)
private function long uf_zn_trt_divsin_franchise_paybox (string asdata, string asnomcol, long alrow)
private function long uf_zn_trt_divsin_dim_sup_150cm (string asdata, string asnomcol, long alrow)
private function long uf_zn_trt_divsin_poids_sup_30kg (string asdata, string asnomcol, long alrow)
private function boolean uf_validation_finale_ore_mail ()
private function boolean uf_validation_finale_omt_mail ()
private function boolean uf_validation_finale_mcprotect_mail_tn ()
private function boolean uf_validation_finale_mcprotect_mail_tn1 ()
private function boolean uf_validation_finale_mcprotect_mail_tn2 ()
private function boolean uf_validation_finale_sav_carrefour_mail2 ()
private function boolean uf_validation_finale_lbe_mail ()
private function long uf_zn_trt_divsin_typapprecneu (string asdata, string asnomcol, long alrow, boolean abforcer)
private function boolean uf_validation_finale_oop_mail ()
private function boolean uf_validation_finale_eco_mail_samsung ()
private function long uf_zn_trt_divsin_gti_non_activee (string asdata, string asnomcol, long alrow)
private function string uf_controlergestion_caution (ref boolean abmessage, string ascas)
private function long uf_zn_id_territ (boolean abmodified)
public function boolean uf_controlergestion_sanction_eco_usa ()
private function boolean uf_controler_sepa (string ascodebq, string ascodeag, long alidinter)
private subroutine uf_determiner_courrier_forcage_dp250 (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
private subroutine uf_controler_eco_msg_cg60 ()
private function boolean uf_validation_finale_mail_srr ()
private function boolean uf_validation_finale_advise_mail ()
private function long uf_zn_trt_divsin_telediag_ok (string asdata, string asnomcol, long alrow)
private function boolean uf_validation_finale_advise_mail_2 ()
private function long uf_zn_trt_divsin_cra_last_dte (string asdata, string asnomcol, long alrow)
public subroutine uf_police_orange_v2bis ()
private function boolean uf_validation_finale_mbs_ech_express (long alidgti)
private function long uf_zn_trt_divsin_dcnxdeclaatlas (string asdata, string asnomcol, long alrow)
public function boolean uf_scripting_v2bis ()
private function long uf_zn_trt_divsin_recredit_imm (string asdata, string asnomcol, long alrow)
private function long uf_zn_trt_divsin_interv_serrurier (string asdata, string asnomcol, long alrow)
private function long uf_zn_trt_divsin_pret_app_endommage (string asdata, string asnomcol, long alrow)
private function long uf_zn_trt_divsin_paybox_cb_forcee (string asdata, string asnomcol, long alrow)
private function boolean uf_validation_finale_mbs_ech_express_o2m ()
private subroutine uf_determiner_courrier_forcage_leclerc (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
public function boolean uf_validation_finale_mail_ctl_imei ()
public function boolean uf_scripting_v2bis_ent ()
public function boolean uf_pi052_droitparam (string ascas)
private function long uf_zn_trt_divsin_dte_restit_app_pret (string asdata, string asnomcol, long alrow)
public function string uf_controlergestion_mobilzen2 ()
public function string uf_controlergestion_ajoutparaauto ()
private subroutine uf_determiner_courrier_forcage_sbe_sfr (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
private function boolean uf_validation_finale_mail_sogedep ()
private function string uf_controlergestion_frais_compensation ()
private function boolean uf_validation_finale_qdr_ibe_mail ()
private function string uf_determiner_data_sinistre (ref string asdatainter[], string ascas, integer aicasinter, ref s_pass atabvariable[], ref string astabcodevar[])
public function string uf_controlergestion_a_rep_force ()
private subroutine uf_determiner_courrier_forcage_dp288 (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
private function boolean uf_validation_finale_atech_mail ()
private subroutine uf_determiner_courrier_forcage_mbs (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
private function string uf_controlergestion_cplt_adh_paybox (string ascas)
private function boolean uf_validation_finale_samsung_mail_refus ()
private function boolean uf_validation_finale_samsung_mail_rempl ()
public function string uf_controlergestion_auditassureurelsa ()
public subroutine uf_determiner_data_recup_adr_pickup ()
public function long uf_zn_marqport (string ascas)
public function long uf_zn_modlport ()
private subroutine uf_determiner_courrier_forcage_o2m_pm280 (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
public function string uf_getreponse_script (string asclequest, boolean abcode)
public function string uf_controlergestion_interdirereglpresta ()
private function long uf_zn_trt_divsin_degolocalisation (string asdata, string asnomcol, long alrow)
private function boolean uf_validation_finale_advise5_mail ()
private function long uf_zn_trt_divsin_taille_ecran (string asdata, string asnomcol, long alrow)
private subroutine uf_determiner_courrier_forcage_dp170 (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour)
public function boolean uf_controlergestion_typ_app_ds (string ascas)
private subroutine uf_controler_saisie_email (ref string astext, ref string aspos)
private function boolean uf_validation_finale_advise6_mail ()
private function long uf_zn_trt_divsin_pceillisiblecasto (string asdata, string asnomcol, long alrow)
private function long uf_zn_trt_divsin_forcer_refus_1676 (string asdata, string asnomcol, long alrow)
private function boolean uf_controlergestion_orangeparnasse (string ascas)
private function long uf_zn_trt_divsin_typapparecaneu (string asdata, string asnomcol, long alrow, boolean abforcer)
public function boolean uf_controlergestion_refareexp_cordon ()
private function boolean uf_validation_finale_advise_aas_mail ()
private function boolean uf_validation_finale_samsung_infopec ()
private function boolean uf_controlergestion_pm445 ()
private function string uf_controlergestion_redrbtqcentralpsm ()
private function boolean uf_validation_finale_adviserepa_mail (string ascas)
private subroutine uf_ajoutdynamiquedivpro ()
public function boolean uf_validation_finale_courhtmlviawssaga2 ()
private subroutine uf_preparermodifier_modifdynparam (string ascas)
public function boolean uf_controlergestion_rembfranchisecb ()
private function boolean uf_controlergestion_dt458 ()
private function string uf_controlergestion_pm506 ()
private function boolean uf_decoder_dp347 (long adcidgti, long adcidnatsin, long adcidmotif, ref string aslibmemoire, boolean abcocherresilautoadh, ref integer aicodresiladh)
public subroutine uf_creerdossier (string asnomfichier)
private function boolean uf_gestionrepcourrierlocal ()
public subroutine uf_modification_para_dynamique_dp359 (string asidnatcour, ref string astxtcompo)
private function long uf_zn_trt_divsin_dysfonc_extranet_franch (string asdata, string asnomcol, long alrow)
private function string uf_controlergestion_interassureur ()
private function string uf_validation_finale_sql_hubprestataire (ref datastore adshubdonneesprestasimpa2)
private function boolean uf_gestiontranssqlhubpresta (string ascas)
public subroutine uf_initialiser_dw_desc (ref u_datawindow_detail adw_inter, ref u_datawindow_detail adw_gti, ref datawindow adw_norm[], ref u_libelle_dga aulibelle, ref u_datawindow_detail adw_contact, ref datawindow adw_corbeille, ref u_datawindow adw_dossuivipar, ref u_datawindow_detail adw_lstwcommande, ref u_datawindow adw_boitearchive, ref u_datawindow adw_wdivsin, ref u_datawindow_detail adw_wdivdet, ref picturebutton apbcontroler, ref statictext astpauseapi_lab, ref statictext astattente_diverse)
private function long uf_zn_trt_divsin_typ_presta (string asdata, string asnomcol, long alrow)
public subroutine uf_set_valinstance (string ascas, string asval)
end prototypes

public subroutine uf_traitement (integer aitype, ref s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Traitement (PUBLIC)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 10:29:33
//* Libellé			: 
//* Commentaires	: 
//*
//* Arguments		: Integer		aiType			(Val)	Type de traitement
//*					  s_Pass			astPass			(Réf) Structure de passage
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ PAR		Date		 Modification
//       JFF   12/06/2014 [PI052]
//*-----------------------------------------------------------------

Choose Case aiType
Case 1					// INITIALISATION		(Ue_Initialiser de la fenêtre)
	Uf_InitialiserFenetre ( astPass )

Case 2					// MODIFICATION		(Wf_PreparerModifier)

	Uf_PreparerModifier ( astPass )

Case 4					// CONTROLE SAISIE	(Wf_ControlerSaisie) + (Wf_ControlerGestion)
	// [PI052]
	/*
	If F_CLE_A_TRUE ( "PI052" ) Then
		If Not ib2EmeTourPI052 Then
			Uf_ControlerSaisie 	( astPass )
		End If 
		
		If ib2EmeTourPI052 Then		
			astPass.sTab [ 1 ] = ""
		End If 
		
		If	astPass.sTab [ 1 ] = "" Then
			Uf_ControlerGestion ( astPass )
		End If

	Else */
		Uf_ControlerSaisie 	( astPass )
		If	astPass.sTab [ 1 ] = "" Then
			Uf_ControlerGestion ( astPass )
		End If
//	End If

Case 6					// PREPARER VALIDER	(Wf_PreparerValider)
	Uf_PreparerValider ( astPass )

Case 7					// TERMINER VALIDER	(Wf_TerminerValider)
	Uf_TerminerValider ( astPass )

Case 8					// On se trouve sur l'événement Ue_Enabled, 
							// on vient de la fenêtre des Garanties (W_DETAIL)


Case 9					// On va faire un UPDATE pour les Blobs.
	Uf_Enregistrer_W_Inter_Blob_Blob ( astPass )

Case 10					// Il s'agit d'envoyer la validation Finale
	Uf_Validation_Finale ( astPass )		


	


End Choose





end subroutine

private subroutine uf_preparermodifier (ref s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_PreparerModifier (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 10:49:34
//* Libellé			: 
//* Commentaires	: Préparation de la modification d'un sinistre.
//*
//* Arguments		: s_Pass			astPass			(Réf) Structure de passage
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ 			PAR		Date		  Modification
//* DCMP000056	JFF		17/02/2000 Insertion d'un nouveau message
//* #1			JFF		24/04/2001 CONTACTDNT : Gestion contacts.
//* #2		   JFF		05/09/2002 Gestion de la gestion de contact uniquement pour Sherpa
//* #3			JFF		15/01/2003 A l'ouverture on met en majuscule certaines zones de téléphonie
//* #5			CAG		17/02/2003 SFR Must : Codes Orian envoyés par SFR sont faux donc la gamme
//*														 déterminée est fausse. => shunt : on met à null 
//*														 les codes orian marque et modèle
//* #6		  	CAG    	05/03/2003 DCMP 030135 : Ajout d'une table des boutiques
//* #7			JFF		03/03/2004 DCMP 040098 : Modification pour ORANGE Marketing.
//* #8  			JFF    	15/06/2004 Gestion onglet Divers
//* #9  			JFF    	18/05/2005 Rôle de facturation
//* #10			JCA		22/08/2006 Mise en place du retrieve de DET_PRO avec pour paramètre l'identifiant produit
//* #11			PHG		09/11/2006 [DCMP060405] Gestion Multi-Référentiel
//*										  & regroupement de uf_preparermodifier 1 et 2
//* #12 		   JFF      18/12/2006 Modification particulière pour Mondovelo
//* #13			PHG		25/12/2007 [CRAO_LOT2] Desactivation Option 19 et données associées
//*											- Suppression de is_IMEI_Control.
//* #14        JFF	   06/02/2006  [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
//* #15			JFF		29/08/2007	[DCMP070587] - Charte souplesse SFR
//* #16   	   JFF      02/09/2009 [DCMP090327].[SBETV]
//* #17			FPI		06/10/2009	[DCMP090595]
//* #18			PHG		08/10/2009	[DCMP090585] Affichage du libelle boutique sur option DP 122
//* #19			FPI		12/10/2009	[DCMP090616] Zone dos_duivi_par obligatoire
//* #20        JFF      06/11/2009  [20091106201707453] On shunt la fonction si Factu
//* #21		   FPI		25/02/2010	[DCMP100122] Report de la date d'adhésion sur date achat et ouv_ligne
//* 		      JFF      04/11/2010  [PC301].[LOT2]
//				   FPI		02/02/2011	[PC364]
//				   JFF		23/06/2011	[PM02].[DP175]
//				   JFF		14/09/2011	[PM72]
//				   FPI		14/09/2011	[ITSM92321] 
//				   FPI		04/04/2012	[PM194] DP 210 - Forçage de la territorialité
//					JFF      17/04/2012  [ITSM112924]
//             JFF      23/05/2012  [PM103][1]
//             JFF      26/11/2012  [PC877]
//             JFF      11/02/2013  [PC896_CDISCOUNT]	
//             JFF      07/05/2013  [PC938_ORANGE_V3]
//             JFF      24/05/2013  [PC512-5_ORANGE_V2_BIS]
//			FPI		25/06/2013	[VDoc11244]
//			FPI		14/08/2013	[DT058]
//       JFF   12/12/2013 [PC947&977]
//       JFF  20/02/2014 [VDOC13754]
//       JFF   08/04/2014 [PM255]
//		FPI	20/05/2014 [PM261-1]
//       JFF   18/03/2014 [DT076_ADVISE_V3]
//		FPI	2/07/2014	[VDOC14765]
//		FPI	10/07/2014	[VDoc14816]
//    JFF   30/07/2014 [PM234-4_V1]
//		FPI	28/10/2014 [VDoc15725]
//		FPI	21/01/2015	[VDOC16492]
//		FPI	30/01/2015	[VDOC16586]
//    JFF   04/02/2015 [PM234-6]
//    JFF   12/05/2015 [ITSM292811][ADVISE]
//    JFF   12/10/2015 [PC694-4]
//    JFF   05/11/2015 [VDOC19090]
//    JFF   07/06/2016 [DT227]
//    JFF   17/06/2016 [ITSM390803]
//	FPI 	24/06/2016	 [VDOC21200]
//       JFF   11/10/2016 [DT076-2]
// 		FPI		21/10/2016	[PI056] dte_ach_port en datetime
//       JFF   07/11/2016 [PC151259]
//       JFF   13/04/2017 [DT288-1]
// 		JFF	  26/04/2017  [ITSM459081] 
//       JFF   29/05/2017 [PC151259-2]
//       JFF   09/09/2017 [ITSM481539]
//       JFF   05/10/2017 [PC171918]
//       JFF   05/02/2018 [PM360-2]
//       JFF   12/02/2018 [DT346]
//       JFF   06/03/2018 [DT341]
//       JFF   06/03/2018 [VDOC25774]
// 		FPI	12/03/2018 [PI056] dte_fin_gti en datetime
//       JFF   01/10/2018 [PM445-1]
//       JFF   28/02/2019 [VDOC27557]
//       JFF   15/05/2019 [DT386_EXTR_AXA]
//       JFF   17/09/2019 [DT447]
//       JFF   22/10/2019 [PI087_PM473_2]
//       JFF   26/11/2019 [PC192290]
//       JFF   23/06/2020 [PC202553_SELECTRA]
//       JFF   02/12/2020 [VDOC29906]
//		   JFF   06/05/2021 [TRI_BOUTIQUE] Evol tri boutique param
//       JFF   28/09/2021 [20210928162035633] gestion d'un caractère de fin de chaine(@) pour ne pas perdre les espace de fin de chaine
//       JFF   01/02/2022 [RS_1807_1793]
// 	   JFF   19/04/2022 [NVX_MSG_SELECTRA]
// 		JFF   01/07/2022 [PRBLE_DIF_BNP]
//       JFF  26/04/2023 [RS5045_REF_MATP]
//       JFF   29/08/2023 [RS5666_DOS_SUIVI_PAR]
//       JFF   04/09/2023 [RS5656_MOD_PCE_DIF]
//       JFF   04/09/2023  [RS5656_MOD_PCE_DIF]
//       JFF   05/08/2024  [MCO602_PNEU]
//       JFF   19/12/2024 [MIG1_COUR_EMAILING]
//       JFF   12/02/2025 [HUB875]
//*-----------------------------------------------------------------

String sCol[], sValCar, sValCar2, sIdAdh, sSIREN, sVal, sVal2, sPctRisque, sAltPart 
String sIdEntrepot, sChaineSin, sRetSql, sValMail, sChaineModeleCP, sIdGti, sIdDetail
Long lIdProd, lIdRev, lIdEts, lDELTAProd, lDELTAEts, lVal, lCodTel, lIdCarte, lFUSIONProd, lFUSIONIdCarte, lCpt
Long lIdOrianMarq, lIdOrianModl, lTotInter, lDeb, lFin, lTotDP, lCptDP, dcIdInter, dcIdDoc
Long lRow, lRow2, lPresenceParamPM02, lRowDS, lCptInter, lIdSin, lIdProdAdh
Long lCptDetPro, lCptDT288, lTotDT288, lRet, lIdArch, lIdSeq
Boolean bRet, bActiv, bVal, bScriptTrouve, bRet2
DataWindowChild	dwChild, dwChild1
Date dDteFinGti, dDteFinGtiPrec, sDteNull, dDteAdh, dDteAchPort, dDteOuvLig, dDteDecl // #21 - Ajout dDteOuvLig
Datetime dtDteSurv
Long lDeb2			//	#21
String	sCodAdh, sDELTA, sFUSION, sFUSION_Aqu, sFUSION_Orne, sNull
Int		iDELTA, iDELTASLASH, iFUSION, iFUSIONSLASH
Integer	iIdFam // #11 [DCMP060405] 
n_cst_string	lnvString // #18 [DCMP090585]
String sMarqApp, sModlApp 
Decimal {2}	dcPrixPublicIFR, dcPrixPublicDS
DateTime dtDtePivotDT1288-1, dtCreeLeDos
n_cst_attrib_key	lnv_Key[] 			
Long dcIdSin, dcIdProd, dcIdEts
Int  iNbAutreSin, iPctRisque, iIdInterModeleDP, iTot_gTInterCP 
Long lVal1
String sZnDS_pceSherpaRacine, sZnDS_pceSherpa, sValTemp, sIdPce, sEtatPCe, sDteAnalysePce, sVal1
Int iZnDS_pceSherpa, iPos, iRow
Boolean bFin
Int iTInterCPNull [] // [RS5045_REF_MATP]
String sTModeleCPNull [] // [RS5045_REF_MATP]


// Vérifie si accès SIMPA2 autorisé
F_Couper_Acces_SIMPA2 ()

// Vérif temps connexion
F_Verif_temps_cnx ( gdtCnx )

bScriptTrouve = False
bRet = True
SetNull ( sNull )
SetNull ( sDteNull )
SetNull ( dcIdInter )
SetNull ( dcIdDoc )

idw_LstContact.Reset ()
idw_LstWcommande.Reset ()
idw_DosSuiviPar.Hide ()
isReferentielApp = ""
If isTypeTrt = "S" Then iPbControler.Enabled = TRUE
ibCodicDartyValide = FALSE
gsCasGestion = ""
gsBinDroit = sNull
gsCodeRetPrixIfr = ""
gTInterCP = iTInterCPNull // [RS5045_REF_MATP]
gTModeleCP = sTModeleCPNull // [RS5045_REF_MATP]


ib2EmeTourPI052 = False // [PI052]
invSaisieValSin.ibTimerPI052 = FALSE // [PI052]
invSaisieValSin.ibPI052_GenEdtKsl = FALSE // [PI052]
invSaisieValSin.ibFinGenerationPDFOk = FALSE // [PI052]
ibPI052_GenEdtKsl2 = FALSE // [PI052]

ibPM506_AssureARisque = False // [PM506-1]
ibDp385 = False

ibMIG1_CourEmailing = False // [MIG1_COUR_EMAILING]

// Armement pour les ZVAR du courrier
// [PM255]
gsAdrCivPickUp = ""
gsAdrNomPickUp = ""
gsAdrPreNomPickUp = ""
gsAdr1PickUp = ""
gsAdr2PickUp = ""
gsAdrCpltPickUp = ""
gsAdrVillePickUp = ""
gsAdrCpPickUp = ""
gsCodePickUp = ""
gsHorairePickUp = ""

iUoOng.Uf_ChangerOnglet ("01")	

// [PC192290]
If ISValid ( gdsPieceSherpa) Then gdsPieceSherpa.Reset ()

/*------------------------------------------------------------------*/
/* On initialise la DDDW à vide sur ID_ETS maintenant, car elle     */
/* peut changer de valeur en fonction du COD_ADH.                   */
/*------------------------------------------------------------------*/
idw_wSin.GetChild ( "ID_ETS", dwChild )
dwChild.InsertRow ( 0 )

/*------------------------------------------------------------------*/
/* On met dans une variable d'instance la provenance du courrier    */
/* recu. Cette information est récupérée dans W_QUEUE. On va s'en   */
/* servir pour la fonction Uf_Determiner_Courrier.                  */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On positionne aussi le type de document recu (C)ourrier,         */
/* (T)éléphone, (F)ax, (Q)uestionnaire.                             */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On positionne aussi la date du dernier courrier client.          */
/* (DTE_COUR_CLI).                                                  */
/*------------------------------------------------------------------*/
isCodeIProv 	= astPass.sTab[ 3 ]
isCodRecu		= astPass.sTab[ 4 ]
isDteCourCli	= astPass.sTab[ 5 ]
isCodTypRecu	= astPass.sTab[ 6 ]	//#19

// [PM72]
glIdSinMemPM72 = Long ( astPass.sTab [ 1 ] ) 

// [RS5045_REF_MATP]
lIdSin = Dec ( astPass.sTab [ 1 ] ) 

Choose Case isTypeTrt 
	Case "S", "V"
		sRetSql = Fill ( " ", 20 )
		SQLCA.PS_PRESENCE_WSIN (Dec ( astPass.sTab [ 1 ] ), sRetSql )
		F_Commit ( SQLCA, True )
		If sRetSql = "ABSENT" Then
			stMessage.berreurg=FALSE
			stMessage.bouton=Ok!
			stMessage.icon=Information!
			stMessage.stitre="Gestion des sinistres - SIMPA2"
			stMessage.scode ="WSIN741"
			f_message(stMessage)
			astPass.bRetour = FALSE
			Return 
		End If
End Choose

/*------------------------------------------------------------------*/
/* On récupére l'enregistrement.                                    */
/*------------------------------------------------------------------*/
If	idw_wSin.Retrieve ( Dec ( astPass.sTab [ 1 ] ) ) <= 0 Then bRet = False

	dtCreeLeDos = idw_wSin.GetItemDateTime ( 1, "CREE_LE") // [DT288-1]

	// #14
	idw_wSin.SetItem ( 1, "NUM_PORT", F_Format_Num_Tel ( Trim ( Upper ( idw_wSin.GetItemString ( 1, "NUM_PORT" ) ) ), TRUE ) )
	
/*------------------------------------------------------------------*/
/* Lecture des autorisation pour ce produit et ce gestionnaire.	  */
/*------------------------------------------------------------------*/
	idw_Autorisation.Retrieve ( Upper ( stGlb.sCodOper ), idw_wSin.GetItemNumber ( 1, "ID_PROD" ) )

	gbModeReprise_223 = This.uf_GetAutorisation2 ( 223 )

/*------------------------------------------------------------------*/
/* On garde le dernier N° de produit en mémoire pour éviter de le   */
/* recharger si besoin.                                             */
/*------------------------------------------------------------------*/
If	bRet Then
/*------------------------------------------------------------------*/
/* On arme les variables d'instance pour les zones ID_NATSIN,       */
/* ID_TERRIT, ID_DETSIN. Ces valeurs seront testées à la fin pour   */
/* vérifier si elles ont bougé. Fonction Uf_ControlerSaisie ().     */
/*------------------------------------------------------------------*/
	ilIdNatSin	= idw_wSin.GetItemNumber ( 1, "ID_NATSIN" )
	ilIdTerrit	= idw_wSin.GetItemNumber ( 1, "ID_TERRIT" )
	ilIdDetSin	= idw_wSin.GetItemNumber ( 1, "ID_DETSIN" )

	// #13 [CRAO_LOT2] On enleve la gestion de is_IMEICtrl
	//isIMEICtrl = idw_wSin.GetItemString  ( 1, "REF_CIE" )
	//If IsNull ( isIMEICtrl ) Then isIMEICtrl = " "

	isIMEIClient = idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" )
	If IsNull ( isIMEIClient ) Then isIMEIClient = " "

   idDteAch =  Date (idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" )) // [PI056]
	If IsNull ( idDteAch ) Then idDteAch = Date ( "01/01/1900" )

   idDteOuvLig = Date (idw_wSin.GetItemDateTime ( 1, "DTE_OUVLIG_PORT" )) // [PI056]
	If IsNull ( idDteOuvLig ) Then  idDteOuvLig = Date ( "01/01/1900" )

   idDteResil = idw_wSin.GetItemDate ( 1, "DTE_RESIL" )
	If IsNull ( idDteResil ) Then  idDteResil = Date ( "01/01/1900" )

/*------------------------------------------------------------------*/
/* On arme un variable d'instance pour la zone DTE_SURV.            */
/*------------------------------------------------------------------*/
	idtDteSurv	= idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )
	
	lIdProd	= idw_wSin.GetItemNumber ( 1, "ID_PROD" )
	
	// [LECT_PRODREV]
//	If	lIdProd <> ilDernierIdProd Then 
	If True Then 
/*------------------------------------------------------------------*/
/* On charge les informations des colonnes ID_NAT_SIN, ID_TERRIT,   */
/* ID_DETSIN.                                                       */
/*------------------------------------------------------------------*/
		idw_wSin.GetChild ( "ID_NATSIN", dwChild )
		dwChild.SetTransObject ( This.itrTrans )
		dwChild.Retrieve ( lIdProd, "+NS" )

		idw_wSin.GetChild ( "ID_TERRIT", dwChild )
		dwChild.SetTransObject ( This.itrTrans )
		dwChild.Retrieve ( lIdProd, "+TR" )

		idw_wSin.GetChild ( "ID_DETSIN", dwChild )
		dwChild.SetTransObject ( This.itrTrans )
		dwChild.Retrieve ( lIdProd, "+DT" )

		/*------------------------------------------------------------------*/
		/* #8                                                               */
		/*------------------------------------------------------------------*/
		idw_DivPro.Retrieve ( lIdProd )

		If isTypeTrt = "S" Then 
			This.uf_AjoutDynamiqueDivPro ()
		End If 
		
		idw_DivPro.Sort ()

		idw_DivPDet.Retrieve ( lIdProd )
		idw_DivPDet.Sort ()

		/*------------------------------------------------------------------*/
		/* #10                                                              */
		/*------------------------------------------------------------------*/
		idw_DetPro.Retrieve ( lIdProd )
		idw_DetPro.Sort ()
		
		//* #16 [DCMP090327].[SBETV]
		lTotDp = idw_DetPro.RowCount ()
		For lCptDp = 1 To lTotDp 
			sValCar = idw_DetPro.GetItemString ( lCptDP, "VAL_CAR" )
			sValCar2 = idw_DetPro.GetItemString ( lCptDP, "VAL_CAR2" ) 
			
			If IsNull ( sValCar ) Then sValCar = ""
			If IsNull ( sValCar2 ) Then sValCar2 = ""
			
			idw_DetPro.SetItem ( lCptDp, "VAL_CAR", sValCar + sValCar2 )
		Next
		//* :#16 [DCMP090327].[SBETV]

		// [MCO602_PNEU]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 385 )
		ibDp385 = lDeb > 0 // On ne demande pas le num_port
	
		// [MIG1_COUR_EMAILING]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 390 )
		ibMIG1_CourEmailing = lDeb > 0
		iUoGsSpSinistre2.uf_Set_ValInstance ( "ibMIG1_CourEmailing", String ( ibMIG1_CourEmailing) )
	

		// [DT447]		
		This.uf_PreparerModifier_ModifDynParam ( "DT447" )			
		// /[DT447]		
		// [Dt288]

		This.uf_PreparerModifier_ModifDynParam ( "DT288-1" )
		
		If	idw_Produit.Retrieve ( lIdProd ) <= 0 Then 
			bRet = False
		Else
			
/*------------------------------------------------------------------*/
/* #11 [DCMP060405] PHG 09/11/2006                                  */
/* Gestion Multi Référentiel - regroupement par famille de code.    */
/* On gère les marques par famille de code                          */
/* - Déport du chargement des marques dans uf_preparer_modifier     */
/* - Si l'Option 73 est définie, on filtre avec la famille          */
/*   indiquée dans val_num de Det-Pro.                              */
/* - Si elle n'est pas définie, on ne filtre pas.                   */
/* J'ai respecté l'architecture actuelle, ou le chargement est fait */
/* à deux endroit :	                                               */
/* - Une fois dans la dddw des marque de la dw de saisie pricipale  */
/*	  des Sinistres.                                                  */ 
/* - Une fois dans une dw de stockage des marque, qui est passée    */
/*   en suite en paramêtre à différentes fenetres filles.           */
/*------------------------------------------------------------------*/

			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 73 )
			If lDeb > 0 Then
				iIdFam = idw_DetPro.object.val_num[lDeb]
				// Initialisation de la dropdown marq_port
				idw_wsin.object.marq_port.dddw.name = "dddw_spb_codeparfamille"
				idw_wSin.GetChild ( "MARQ_PORT", dwChild )
				//dwChild.dataobject = "dddw_spb_codeparfamille"
				dwChild.SetTransObject ( This.itrTrans )
				dwChild.Retrieve ( "-MB", iIdFam )
				
				// Initialisation de la dw de sotkcage de la liste des marque
				idw_CodeMB.dataobject = "dddw_spb_codeparfamille"
				idw_CodeMB.SetTransObject(this.iTrTrans)
				idw_CodeMB.Retrieve ( "-MB", iIdFam )
			Else
				// Initialisation de la dropdown marq_port
				idw_wsin.object.marq_port.dddw.name = "dddw_spb_code"
				idw_wSin.GetChild ( "MARQ_PORT", dwChild )
				//dwChild.dataobject = "dddw_spb_code"
				dwChild.SetTransObject ( This.itrTrans )
				dwChild.Retrieve ( "-MB" )
				
				// Initialisation de la dw de sotkcage de la liste des marque
				idw_CodeMB.dataobject = "dddw_spb_code"
				idw_CodeMB.SetTransObject(this.iTrTrans)
				idw_CodeMB.Retrieve ( "-MB" )
			End If
			dwChild.SetSort ( "LIB_CODE A" )
			dwChild.Sort ()
			idw_CodeMB.SetSort ( "LIB_CODE A" )
			idw_CodeMB.Sort ()
// Fin #11 [DCMP060405]			

/*------------------------------------------------------------------*/
/* #1 : On mémorise la Gestion Contact.									  */
/*------------------------------------------------------------------*/
			ibAltContact = idw_Produit.GetItemString ( 1, "ALT_CONTACT" ) = "O"
			ibAltContactSherpa = False

/*------------------------------------------------------------------*/
/* #2 : JFF le 04/09/2002														  */
/*------------------------------------------------------------------*/
			If Not ibAltContact Then
				ibAltContactSherpa = idw_Produit.GetItemString ( 1, "ALT_CONTACT" ) = "S"
			End If

			ibAltOuvFenVal = idw_Produit.GetItemString ( 1, "ALT_OUVFENVAL" ) = "O"
			ibAltCmdMobile = idw_Produit.GetItemString ( 1, "ALT_CMD_MOBILE" ) = "O"


/*------------------------------------------------------------------*/
/* On mémorise la Gestion de la téléphonie.								  */
/*------------------------------------------------------------------*/
			lCodTel = idw_Produit.GetItemNumber ( 1, "COD_TEL" )
/*------------------------------------------------------------------*/
/* # Modification SFR # Le 17/07/2002                               */
/*------------------------------------------------------------------*/
/* On charge une seule fois les horaires de rendez-vous et la       */
/* table Zone_Fournisseur. Les instances des DW sont positionnées dans  */
/* la fonction uf_Initialiser_Sfr.                                  */
/*------------------------------------------------------------------*/
/* CAG : 27/09/02 + Activation du bouton Gamme                      */
/*------------------------------------------------------------------*/
			bActiv = FALSE
			If lCodTel > 0 Then
				bActiv = TRUE
			End If
			This.uf_ActiverBmGme ( bActiv )

			If	lCodTel = 21	Then
				This.uf_Generer_HoraireRdv ()
			End If

			ibAltTelephonie = lCodTel > 0

			/*------------------------------------------------------------------*/
			/* #6 : Chargement de la table boutique                             */
			/*------------------------------------------------------------------*/
			If idw_Produit.GetItemString ( 1, "ALT_COD_BOUTIQUE" ) = "O" Then
				idw_Boutique.Retrieve ( lIdProd )
				
				// [TRI_BOUTIQUE] Evol tri boutique param
				F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 358 ) 
				If lDeb > 0 Then
					sValCar = idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) 
					sValCar = lnvString.of_getkeyvalue( sValCar, "TRI", ";")
					If Not IsNull ( sValCar ) And Trim ( sValCar ) <> "" Then 
						idw_Boutique.SetSort ( sValCar )
					Else 
						idw_Boutique.SetSort ( "ADR_VILLE A" )							
					End If 
				Else 
					idw_Boutique.SetSort ( "ADR_VILLE A" )
				End If 
					
				idw_Boutique.Sort ()
				
				//#18 [DCMP090585] On fixe par code la displaycolumn suivant l'option DP 122
				F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 122 )
				If lDeb > 0 Then
					choose case upper(lnvString.of_getkeyvalue( idw_DetPro.object.val_car[lDeb], "AFF", ";"))
						case "VILLE"
							idw_wsin.object.id_orian_boutique.dddw.displaycolumn = "c_aff_adrville"
						case "NOM"
							idw_wsin.object.id_orian_boutique.dddw.displaycolumn = "c_aff_adrnom"
						case else
							idw_wsin.object.id_orian_boutique.dddw.displaycolumn = "id_boutique"
					End Choose
				Else
					idw_wsin.object.id_orian_boutique.dddw.displaycolumn = "id_boutique"
				End IF
				// Fin #18 [DCMP090585]

			End If 

			If ibAltTelephonie Then

				/*----------------------------------------------------------------------------*/
				/* Gestion de la téléphonie : Si Adh en base DMS alors dte_achat =            */
				/* dte_ouvlig                                                                 */
				/* sinon les deux dates sont distinctes.                                      */
				/*----------------------------------------------------------------------------*/
				If idDteOuvLig = 1900-01-01 Then
					// [MCO602_PNEU]
					If F_CLE_A_TRUE ( "MCO602_PNEU" ) Then
						F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 383 )
						If lDeb <= 0 Then
							idw_wSin.SetItem ( 1, "DTE_OUVLIG_PORT", idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ) )  // [PI056]							
						End IF 
					Else 			
						idw_wSin.SetItem ( 1, "DTE_OUVLIG_PORT", idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ) )  // [PI056]
					End If					
				End If
			   idDteOuvLig = Date(idw_wSin.GetItemDateTime ( 1, "DTE_OUVLIG_PORT" )) // [PI056]
				If IsNull ( idDteOuvLig ) Then  idDteOuvLig = Date ( "01/01/1900" )
			End If

/*------------------------------------------------------------------*/
/* On s'occupe de populiser les etablissements en fonction du       */
/* COD_ADH de la table PRODUIT. Si COD_ADH = 2,4,5.                 */
/*------------------------------------------------------------------*/
			idw_wSin.GetChild ( "ID_ETS", dwChild )
			dwChild.SetTransObject ( This.itrTrans )
			dwChild.Retrieve ( lIdProd, -1 )

/*------------------------------------------------------------------*/
/* On s'occupe de populiser les codes courriers des                 */
/* interlocuteurs. Il faut filtrer les lignes pour ne pas faire     */
/* apparaitre les questionnaires.                                   */
/*------------------------------------------------------------------*/
			idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
			dwChild.SetTransObject ( This.itrTrans )
			dwChild.Retrieve ( lIdProd )
			dwChild.SetFilter ( "Left ( ID_NAT_COUR, 1 ) <> 'Q'" )
			dwChild.Filter ()

/*------------------------------------------------------------------*/
/* On s'occupe de récupérer la liste des garanties définies pour    */
/* le produit. (Table CODE_GARANTIE).                               */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On partage les données pour populiser le libellé GTI sans avoir  */
/* à refaire un retrieve.                                           */
/*------------------------------------------------------------------*/
			idw_CodeGarantie.Retrieve ( lIdProd )
			idw_LstGti.GetChild ( "ID_GTI", dwChild )
			idw_CodeGarantie.ShareData ( dwChild )

/*------------------------------------------------------------------*/
/* On s'occupe de récupérer la liste des paragraphes disponibles    */
/* pour le produit. Ces paragraphes seront utilisés dans la         */
/* fenêtre des interlocuteurs. (Table PARA_PROD).                   */
/*------------------------------------------------------------------*/
			idw_ParaProd.Retrieve ( lIdProd )

/*------------------------------------------------------------------*/
/* On récupére la liste des conditions pour les événements. (+EV)   */
/* On fera un share de ces données sur la fenêtre du détail.        */
/*------------------------------------------------------------------*/
			idw_CodeCondition.Retrieve ( lIdProd, "+EV" )

/*------------------------------------------------------------------*/
/* Si la révision n'est pas déterminée, (Cas d'une déclaration      */
/* nouvelle) on essaye de la calculer avant toute chose.            */
/*------------------------------------------------------------------*/
			lIdRev = idw_wSin.GetItemNumber ( 1, "ID_REV" )
			If	lIdRev = -1 Then
				Uf_CalculRevision_Initial ()
			End If

/*------------------------------------------------------------------*/
/* On charge les informations relatives à la révision.              */
/* ( PIECE / MOTIF / FRANCHISE / PLAFOND / DELAI ).                 */
/*------------------------------------------------------------------*/
			Uf_ChargerRevision ()

			ilDernierIdProd	= lIdProd
			ilDernierIdRev		= idw_wSin.GetItemNumber ( 1, "ID_REV" )
		
		End If

	Else
/*------------------------------------------------------------------*/
/* On est dans le même produit, mais pour la révision il faut       */
/* faire le test.                                                   */
/*------------------------------------------------------------------*/
		lIdRev = idw_wSin.GetItemNumber ( 1, "ID_REV" )
/*------------------------------------------------------------------*/
/* Si la révision n'est pas déterminée, (Cas d'une déclaration      */
/* nouvelle) on essaye de la calculer avant toute chose.            */
/*------------------------------------------------------------------*/
		If	lIdRev = -1 Then
			Uf_CalculRevision_Initial ()
		End If

/*------------------------------------------------------------------*/
/* Le 27/01/1999                                                    */
/* Il ne faut pas oublier de réarmer la valeur de lIdRev avec la    */
/* zone ID_REV. Celle ci vient en effet d'être armée sur            */
/* Uf_CalculerRevision_Initial ().                                  */
/*------------------------------------------------------------------*/
		lIdRev = idw_wSin.GetItemNumber ( 1, "ID_REV" )

		// [LECT_PRODREV]
//		If	lIdRev <> ilDernierIdRev Then 
		IF True Then
			Uf_ChargerRevision ()
			ilDernierIdRev		= lIdRev
		End If
	End If
End If

If	bRet Then

/*------------------------------------------------------------------*/
/* DCMP050018 : L Fouquier                                          */
/*------------------------------------------------------------------*/
	This.uf_Gestion_DteFinGti (sDteNull, "BASE")

/*------------------------------------------------------------------*/
/* #1 : si la gestion contacts est à 'O' alors on les charge.		  */
/*------------------------------------------------------------------*/
	If ibAltContact Then
		If idw_LstContact.Retrieve ( Dec ( astPass.sTab [ 1 ] )  ) > 0 Then
			idw_LstContact.SetSort ( "CREE_LE D") 
			idw_LstContact.Sort () 
			idw_LstContact.SelectRow ( 0, False )
			idw_LstContact.SelectRow ( 1, True )
		End If
	End If

/*------------------------------------------------------------------*/
/* #2 : JFF le 04/09/2002														  */
/*------------------------------------------------------------------*/
	If ibAltContact Or ibAltContactSherpa Then
		idw_DosSuiviPar.Reset ()
		idw_DosSuiviPar.Retrieve ( Dec ( astPass.sTab [ 1 ] ) )
		If idw_DosSuiviPar.RowCount () <= 0 Then idw_DosSuiviPar.InsertRow ( 0 )

		idw_DosSuiviPar.GetChild ( "DOS_SUIVI_PAR", dwChild1 )
		dwChild1.SetFilter ( "ID_CORB = " + String ( idw_Produit.GetItemNumber ( 1, "ID_CORB") ) )
		dwChild1.Filter ()
		idw_DosSuiviPar.Show ()

		If isTypeTrt = "V" Then 
			idw_DosSuiviPar.Uf_Proteger ( { "DOS_SUIVI_PAR" } , "1" )
		Else
			idw_DosSuiviPar.Uf_Proteger ( { "DOS_SUIVI_PAR" } , "0" )
		End If
	Else
		idw_DosSuiviPar.Hide ()
		idw_DosSuiviPar.SetItem ( 1, "DOS_SUIVI_PAR", stNul.Str )
	End If


// [RS5666_DOS_SUIVI_PAR]
idw_DosSuiviPar.Hide ()
idw_DosSuiviPar.SetItem ( 1, "DOS_SUIVI_PAR", stNul.Str )


/*------------------------------------------------------------------*/
/* Gestion des commandes.														  */
/*------------------------------------------------------------------*/
	If ibAltCmdMobile Then
		If idw_LstwCommande.Retrieve ( Dec ( astPass.sTab [ 1 ] )  ) > 0 Then
         idw_LstwCommande.SetSort ( "ID_SEQ D") 
			idw_LstwCommande.Sort ( ) 
		End If
	End If


/*------------------------------------------------------------------*/
/* Le chargement de la table article se fera lae plus tard possible */
/* afin d'avoir le dernier maj, c'est pourquoi je ne charge pas la  */
/* dw ici, mais sur la création ou l'ouverture du détail.			  */
/*------------------------------------------------------------------*/
// Charge idw_Article, voir ouverture d'un détail.

/*------------------------------------------------------------------*/
/* On récupére la liste des interlocuteurs.                         */
/*------------------------------------------------------------------*/
idw_LstInter.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )

uf_decompo_adr_mail()

// [RS5045_REF_MATP]
If F_CLE_NUMERIQUE ( "RS5045_REF_MATP" ) >= 3 Then
	sChaineModeleCP = Space ( 100 )
	SQLCA.PS_S_W_COURRIER_MODELE_WORD ( lIdSin, sChaineModeleCP )
End If 

// Pour MRA
If isTypeTrt = "S"	Then	
	lTotInter = idw_LstInter.Rowcount ()
	For lCpt  = 1 To lTotInter
		
		iIdInterModeleDP = idw_LstInter.GetItemNumber ( lCpt, "ID_I" ) 
		sAltPart = idw_LstInter.GetItemString ( lCpt, "ALT_PART" ) 
		
		idw_LstInter.SetItem ( lCpt, "NUM_LET_CHEQUE", sNull )

		// PM255
		sValMail = idw_LstInter.GetItemString ( lCpt, "ADR_MAIL" ) 
		If sValMail = "VIDE" Then
			idw_LstInter.SetItem ( lCpt, "ADR_MAIL", sNull )
		End If
	
		// [RS5045_REF_MATP]
		If F_CLE_NUMERIQUE ( "RS5045_REF_MATP" ) >= 3 Then
			If sAltPart = "O" Then
				sValCar = lnvString.of_getkeyvalue( sChaineModeleCP, "ID_I_" + String ( iIdInterModeleDP ), ";")			
		
				iTot_gTInterCP = UpperBound ( gTInterCP )
			
				gTInterCP  [ iTot_gTInterCP + 1 ] = iIdInterModeleDP
				gTModeleCP [ iTot_gTInterCP + 1 ] = sValCar 
							
			End If 
		End If 		
	Next 
End If 
/*------------------------------------------------------------------*/
/* On récupére les paragraphes assignés aux interlocuteurs.         */
/*------------------------------------------------------------------*/
	idw_wParaInfo.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )

/*------------------------------------------------------------------*/
/* On récupére les frais assignés aux interlocuteurs.               */
/*------------------------------------------------------------------*/
	idw_wFrais.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )

/*------------------------------------------------------------------*/
/* On récupére la liste des garanties.                              */
/*------------------------------------------------------------------*/
	idw_LstGti.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )

/*------------------------------------------------------------------*/
/* On récupére la liste des détails.                                */
/*------------------------------------------------------------------*/
	idw_wDetail.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )

/*------------------------------------------------------------------*/
/* On récupére les pièces assignées au dossier.                     */
/*------------------------------------------------------------------*/
	idw_wPiece.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )

/*------------------------------------------------------------------*/
/* On récupére les refus assignés au dossier.                       */
/*------------------------------------------------------------------*/
	idw_wRefus.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )

/*------------------------------------------------------------------*/
/* On récupére les paragraphed de plafond.                          */
/*------------------------------------------------------------------*/
	idw_wParaPlafond.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )

/*------------------------------------------------------------------*/
/* #8                                                               */
/*------------------------------------------------------------------*/
	/*------------------------------------------------------------------*/
	/* Les deux retrieve ci-dessous ne servent en fait à rien. Il       */
	/* s'agit juste de mettre quelquechose dans la DDDW afin qu'elle    */
	/* soit initialisée. Le contenu sera réélement armé dans            */
	/* uf_GestOng_Divers                                                */
	/* Un reset des dwchild étant fait plus loin, ce code doit donc être*/
	/* exécuté à chaque affichage.												  */
	/*------------------------------------------------------------------*/
	idw_wDivSin.GetChild ( "VAL_LST_CAR", dwChild  )
	dwChild.SetTransObject ( This.itrTrans )
	dwChild.Retrieve ( "-FR" )
	idw_wDivSin.GetChild ( "VAL_LST_NBRE", dwChild  )
	dwChild.SetTransObject ( This.itrTrans )
	dwChild.Retrieve ( "-FR" )

	idw_wDivSin.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" )) 
	idw_wDivSin.SetSort ( "CPT_TRI A")
	idw_wDivSin.Sort ()
	idw_wDivSin.SetRow ( idw_wDivSin.rowcount() )

	idw_wDivDet.GetChild ( "VAL_LST_CAR", dwChild  )
	dwChild.SetTransObject ( This.itrTrans )
	dwChild.Retrieve ( "-FR" )
	idw_wDivDet.GetChild ( "VAL_LST_NBRE", dwChild  )
	dwChild.SetTransObject ( This.itrTrans )
	dwChild.Retrieve ( "-FR" )

	idw_wDivDet.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" )) 
	idw_wDivDet.Sort ()
	idw_wDivDet.SetRow ( idw_wDivDet.rowcount() )

/*------------------------------------------------------------------*/
/* On arme la chaîne de retour pour le titre de la fenêtre.         */
/*------------------------------------------------------------------*/
	astPass.sTab [ 1 ] = Uf_Titre ( 1 )

/*------------------------------------------------------------------*/
/* On gére les TabOrder uniquement en saisie.                       */
/*------------------------------------------------------------------*/
	If isTypeTrt = "S"	Then	
		Uf_Tb_Nature ()					// Nature, Territ., Détail
		Uf_Tb_Coordonnees ()				// Coordonnées assuré
		Uf_Tb_SansSuite ()				// Sans suite
		Uf_Tb_Telephonie ()				// Gestion des zones de téléphonie
		Uf_Tb_DteResil ()
	End If

	idw_wSin.SetColumn ( idw_wSin.ilPremCol )

/*------------------------------------------------------------------*/
/* On s'occupe de la date de survenance. Découpage des zones.       */
/*------------------------------------------------------------------*/
	Uf_Cast_DteSurv ()

/*------------------------------------------------------------------*/
/* On supprime tous les fichiers Word précédents.                   */
/*------------------------------------------------------------------*/
	Uf_Effacer_Fichier_Word ()

/*------------------------------------------------------------------*/
/* Le 03/06/1999. Modif DGA.                                        */
/* On gére le cas de la modification de la date de fin de garantie  */
/* pour un complément. Pour une déclaration, DTE_FIN_GTI est égale  */
/* à DTE_FIN_GTI_PREC. Si DTE_FIN_GTI est différente de             */
/* DTE_FIN_GTI_PREC, on affiche un message d'avertissement. Si      */
/* DTE_FIN_GTI_PREC est NULL, il s'agit d'un sinistre SIMPA1.       */
/*------------------------------------------------------------------*/
	dDteFinGti		= Date(idw_wSin.GetItemDateTime ( 1, "DTE_FIN_GTI" )) // [PI056]
	dDteFinGtiPrec = Date(idw_wSin.GetItemDateTime ( 1, "DTE_FIN_GTI_PREC" )) // [PI056]

	sCodAdh			= idw_Produit.GetItemString ( 1, "COD_ADH" )

// #20 [20091106201707453] On shunt la fonction si Factu
	If	sCodAdh = "1" And isTypeTrt <> "C" And Not this.uf_GetAutorisation2(208) Then
		If	dDteFinGti <> dDteFinGtiPrec	Then
/*------------------------------------------------------------------*/
/* Changement de la date de fin de garantie.                        */
/*------------------------------------------------------------------*/
					stMessage.sTitre		= "Gestion des sinistres - SIMPA2"
					stMessage.Icon			= Information!
					stMessage.bErreurG	= False
					stMessage.sVar[1]		= String ( dDteFinGtiPrec, "dd/mm/yyyy" )
					stMessage.sCode		= "WSIN320"
					stMessage.bTrace		= False

					f_Message ( stMessage )
		End If
	End If

/*------------------------------------------------------------------*/
/* On bascule le focus sur le 1er Onglet (DataWindow de SINISTRE)   */
/* par défaut.                                                      */
/*------------------------------------------------------------------*/
	iuoOng.Uf_ChangerOnglet ( "01" )

/*------------------------------------------------------------------*/
/* Modification DBI le 16/10/1998                                   */
/* J'ai ajouté une zone cod_adh sur Dw_1 qui permet d'afficher ou   */
/* non les informations                                             */
/* ID_CARTE, ID_TYP_CARTE, DTE_RESIL, DTE_FIN_GTI, COD_OPT          */
/*------------------------------------------------------------------*/
	sCodAdh	=	idw_Produit.GetItemString ( 1, "COD_ADH" )
	idw_wSin.SetItem ( 1, "COD_ADH", sCodAdh )


/*------------------------------------------------------------------*/
/* DCMP000056 : Le 17/02/2000 JFF                                   */
/* affichage d'un message pour certaine caisse et certain BIN de    */
/* cartes. Cela concerne actuellement le produit 13400 pour les     */
/* comptes DELTA.                                                   */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On récupère la liste des caisses concernés dans le fichier Ini   */
/* + La caisse en cours sur le sinistre.                            */ 
/* [13400_DELTA]																	  */
/* CAISSE = 13400/66,901/2001     											  */
/*-------------------------------------------------------------------*/
	sDELTA  = Trim ( ProfileString ( stGlb.sFichierIni, "13400_DELTA","CAISSE","" ) )
	lIdEts  = idw_wSin.GetItemNumber ( 1, "ID_ETS" )
	
	// Si au moins une caisse est concernée alors...
	If sDELTA <> "" Then
		
		sDELTA += ","
		iDELTA  = 1
	
		// Tant qu'une virgule sera trouvé...
		Do While iDELTA > 0

			iDELTA = Pos ( sDELTA, "," )
			If iDELTA > 0 Then

				iDELTASLASH	= Pos ( sDELTA, "/" )
				lDELTAProd = Long ( Left ( sDELTA, iDELTASLASH - 1 ) )
				lDELTAEts  = Long ( Mid  ( sDELTA, iDELTASLASH + 1, iDELTA - iDELTASLASH - 1 ) )

				// Si le découpage de la caisse contenue dans la chaine
				// correspond au produit et à la caisse en cours...
				If lDELTAProd = lIdProd and lDELTAEts = lIdEts Then

					iDELTA = 0

					sDELTA = Space ( 35 )
					itrTrans.IM_S01_GROUPE ( lIdEts, sDELTA )

					// "Vérifier s'il existe un compte DELTA"
					stMessage.sTitre		= "Gestion des sinistres - SIMPA2"
					stMessage.sCode		= "WSIN330"
					stMessage.Icon			= Information!
					stMessage.bErreurG	= False
					stMessage.bTrace		= False
					stMessage.sVar[1]		= sDELTA
			
					f_Message ( stMessage )
	
						
				Else
					// On découpe ce qui se trouve devant le prémière
					// virgule trouvée à chaque tour.
					sDELTA = Mid ( sDELTA, iDELTA + 1, Len ( sDELTA ) )
				End If
	
			End If
		Loop
	
	End If

/*----------------------------------------------------------------------------*/
/* DCMP020260 : Le 07/07/2002 CAG                                             */
/* Insertion d'un message d'information pour le produit 13400 sur             */
/* certains id_carte																            */
/* fait aussi sur le bouton controler de la fenêtre (dans uf_controlersaisie) */
/*----------------------------------------------------------------------------*/
/* DCMP 020397 : le 03/12/2002 CAG                                  */
/* Modifications par rapport à la DCMP précédente : message         */
/* différent en fonction de l'id_groupe                             */
/*------------------------------------------------------------------*/
/* DMDI 8667 : le 03/02/2003 CAG                                    */
/*             retrait du msg pour les caisses de l'Orne				  */
/*------------------------------------------------------------------*/

	sFUSION_Aqu   	= Trim ( ProfileString ( stGlb.sFichierIni, "13400_FUSION_AQUITAINE","ID_CARTE","" ) )

	lIdCarte  = idw_wSin.GetItemNumber ( 1, "ID_CARTE" )

	For lCpt = 1 To 1

		Choose Case lCpt
			Case 1
				sFUSION = sFUSION_Aqu
				stMessage.sCode = "WSIN390"
		End Choose

		// Si au moins un id_carte est concerné alors...
		If sFUSION <> "" Then
		
			sFUSION += ","
			iFUSION = 1
	
			// Tant qu'une virgule sera trouvé...
			Do While iFUSION > 0

				iFUSION = Pos ( sFUSION, "," )
				If iFUSION > 0 Then

					iFUSIONSLASH	= Pos ( sFUSION, "/" )
					lFUSIONProd = Long ( Left ( sFUSION, iFUSIONSLASH - 1 ) )
					lFUSIONIdCarte  = Long ( Mid  ( sFUSION, iFUSIONSLASH + 1, iFUSION - iFUSIONSLASH - 1 ) )

					// Si le découpage de la caisse contenue dans la chaine
					// correspond au produit et à la caisse en cours...
					If lFUSIONProd = lIdProd and lFUSIONIdCarte = lIdCarte Then

						iFUSION = 0

						sFUSION = Space ( 35 )

						// "Vérifier adhésion au contrat"
						stMessage.sTitre		= "Gestion des sinistres - SIMPA2"
						stMessage.Icon			= Information!
						stMessage.bErreurG	= False
						stMessage.bTrace		= False
			
						f_Message ( stMessage )
	
						
					Else
						// On découpe ce qui se trouve devant la première
						// virgule trouvée à chaque tour.
						sFUSION = Mid ( sFUSION, iFUSION + 1, Len ( sFUSION ) )
					End If
	
				End If
			Loop
	
		End If

	Next

End If

// #11 Passage en PB8 permet de regrouper les deux sources
// Uf_PreparerModifier2 ( astPass )

bRet = True
SetNull ( sNull )
SetNull ( sDteNull )

/*------------------------------------------------------------------*/
/* #3 JFF le 15/01/2003                                             */
/* Ces zones rappatriée de la mini peuvent être en minuscules.		  */
/* Cela peut gêner pour le fichier de commandes CEGETEL.				  */
/*------------------------------------------------------------------*/
idw_wSin.SetItem ( 1, "NUM_PORT", Trim ( Upper ( idw_wSin.GetItemString ( 1, "NUM_PORT" ) ) ) )
idw_wSin.SetItem ( 1, "NUM_IMEI_PORT", Trim ( Upper ( idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) ) ) )
idw_wSin.SetItem ( 1, "ID_CONTRAT_ABONNE", Trim ( Upper ( idw_wSin.GetItemString ( 1, "ID_CONTRAT_ABONNE" ) ) ) )

// [ITSM112924]
sValCar = Trim ( Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) )
sValCar = F_Remplace ( sValCar, '"', 'P' )
sValCar = F_Remplace ( sValCar, "''", 'P' )
sValCar = F_Remplace ( sValCar, "'", 'P' )
sValCar = F_Remplace ( sValCar, ";", ' ' )	
idw_wSin.SetItem ( 1, "MARQ_PORT", sValCar )

sValCar = Trim ( Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) )
sValCar = F_Remplace ( sValCar, '"', 'P' )
sValCar = F_Remplace ( sValCar, "''", 'P' )
sValCar = F_Remplace ( sValCar, "'", 'P' )
sValCar = F_Remplace ( sValCar, ";", ' ' )		
idw_wSin.SetItem ( 1, "MODL_PORT", sValCar )
// [ITSM112924]

/*------------------------------------------------------------------*/
/* #5                                                               */
/*------------------------------------------------------------------*/
SetNull ( lIdOrianMarq )
SetNull ( lIdOrianModl )
idw_wSin.SetItem ( 1, "ID_ORIAN_MARQUE", lIdOrianMarq )
idw_wSin.SetItem ( 1, "ID_ORIAN_MODELE", lIdOrianModl )

/*------------------------------------------------------------------*/
/* DGA. Le 21/08/2003.                                              */
/* Gestion des boites archives.                                     */
/*------------------------------------------------------------------*/
astPass.bTab[1] = uf_GestionBoiteArchive ()
/*------------------------------------------------------------------*/
/* Le bouton PB_BOITEARCHIVE sera rendu Visible/Invisible au        */
/* retour de la fonction sur la fenêtre W_TM_SP_SINISTRE.           */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* #7 : Utilisation de la zone REF_CIE pour la saisie d'un IMEI de  */
/* controle sur option 19.														  */
/*------------------------------------------------------------------*/
/* #13 [CRAO_LOT2] Champ IMEI_CTRL desactivé: */
/*
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 19 )
If lDeb > 0 Then
	idw_Wsin.Modify ( "ref_cie_t.text = 'IMEI Ctrl'" ) 
Else
	idw_Wsin.Modify ( "ref_cie_t.text = 'Ref Cie'" ) 
End If
*/
// remplacé par :
idw_Wsin.Modify ( "ref_cie_t.text = 'Ref Cie'" ) 


/*------------------------------------------------------------------*/
/* On masque les copie des zones Marque/Modele                      */
/*------------------------------------------------------------------*/
idw_Wsin.Modify ( "marq_port2.visible = 0" ) 
idw_Wsin.Modify ( "modl_port2.visible = 0" ) 

idw_Wsin.Modify ( "marq_port3.visible = 0" ) 
idw_Wsin.Modify ( "modl_port3.visible = 0" ) 

// Mondovelo, vu avec MLB 13/12 en réunion présentation
// #12
//F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 72 )
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 133 )	// #21 - [DCMP100122]

If lDeb > 0 Then
	dDteAdh = idw_Wsin.GetItemDate ( 1, "DTE_ADH" )
	dDteAchPort = Date(idw_Wsin.GetItemDateTime ( 1, "DTE_ACH_PORT" ) ) // [PI056]
	dDteOuvLig = Date(idw_wSin.GetItemDateTime ( 1, "DTE_OUVLIG_PORT" ) ) // #21 // [PI056]

	If IsNull ( dDteAchPort ) Or dDteAchPort=1900-01-01 Then // #21 - [DCMP100122] - Ajout de 01/01/1900
		idw_Wsin.SetItem ( 1, "DTE_ACH_PORT", dDteAdh )
		idDteAch = dDteAdh
	End If
	
	// #21- [DCMP100122]
	F_RechDetPro ( lDeb2, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 72 )	
	
	If lDeb2 <=0 Then
		If IsNull ( dDteOuvLig ) Or dDteOuvLig=1900-01-01 Then 
			idw_Wsin.SetItem ( 1, "DTE_OUVLIG_PORT", dDteAdh )
			idDteOuvLig = dDteAdh
		End If
	End if
	// Fin #21
End If

iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_TypeApp ( "AUT", "", -1, TRUE ) // [20241112110249883][DIVOBJ][JFF]

/*------------------------------------------------------------------*/
/* Le gestionnaire a-t-il le droit d'utiliser la sig elec ?         */
/* (aboslument à cet endroit et pas dans uf_init...					  */
/*------------------------------------------------------------------*/
This.uf_Initialiser_Sign_Personnalisee ()

/*------------------------------------------------------------------*/
/* Initialisation de l'onglet DIVERS.                               */
/*------------------------------------------------------------------*/
uf_GestOng_Divers ()

/*------------------------------------------------------------------*/
/* #9 Rôle de facturation, droit -NA/208									  */
/*------------------------------------------------------------------*/
// #17
//If This.uf_GetAutorisation2 ( 208 ) Then idw_wSin.SetItem ( 1, "ALT_EDIT", "N" )
This.uf_Set_profilfacturation( )
// Fin #17

// [PC301].[LOT2]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 152 )
If lDeb > 0 Then
	idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
	lVal = idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )
	
	If Not IsNull ( lVal ) Then
		lRow = dwChild.Find ( "ID_BOUTIQUE = " + String ( lVal ), 1, dwChild.RowCount () )
	End If
	lRow2 = idw_WDivSin.Find ( "NOM_ZONE = 'choix_pack'", 1,  idw_WDivSin.RowCount () ) 
	
	If lRow2 > 0 Then
		If lRow > 0 Then
			sIdEntrepot = dwChild.GetItemString ( lRow, "ADR_MAIL" )
		Else 
			sIdEntrepot = ""
		End If	
		This.uf_gestong_divers_majzone( "CHOIX_PACK", lRow2, K_MAJZONE, sIdEntrepot )				
	End If
End If
// [PC301].[LOT2]

// [PC364]
idw_wsin.Modify( "t_13.Text='N° Contrat'" )

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 161 )
If lDeb > 0 Then
	sValCar=idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sValCar=lnvString.of_getkeyvalue( sValCar, "NOUVEAU_LIBELLE_11_car_max", ";")
	If not (isNull(sValCar) or sValCar = "") Then
		idw_wsin.Modify( "t_13.Text='" + Left(sValCar,11) + "'" )
	End if
End If
// :[PC364]

// #15
This.uf_ControlerGestion_AccordAssureur ( "ALERTE" )

// [PM02].[DP175]
/* N'est plus utilisé comme il devrait l'etre et pertube la gestion, DPG ne se prononcant jamais auprès d'EPG
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 175 )
If lDeb <= 0 Then
	lPresenceParamPM02 = 0
	SELECT count(*) 
	INTO   :lPresenceParamPM02  
	FROM   sysadm.param_ftu_brk 
	WHERE  id_prod = :lIdProd
	USING  SQLCA;
	
	If lPresenceParamPM02 = 0 Then
		stMessage.sTitre		= "Contrôle PM02 - Paramètrage absent"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= False
		stMessage.bTrace		= False
		stMessage.sCode		= "WSIN704"

		f_Message ( stMessage )
	End If
End If
*/
// :[PM02].[DP175]

// [VDoc4587]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 177)

If lDeb > 0 Then
	sValCar =idw_WSin.GetItemString(1,"NUM_IMEI_PORT")
	If (Not isNull(sValCar)) and Len(sValCar) > 0 Then idw_WSin.uf_proteger( {"NUM_IMEI_PORT"}, "1")
End if
// :[VDoc4587]

// [ITSM92321]
If isTypeTrt="S" And sCodAdh <> "3" Then
	idw_WSin.GetChild("ID_ETS",dwChild)
	lRow = dwChild.Find( "ID_ETS=" + String(idw_wsin.GetItemNumber(1,"ID_ETS")) , 1, dwChild.RowCount())
	If lRow <= 0 Then
		stMessage.berreurg=FALSE
		stMessage.bouton=Ok!
		stMessage.icon=Information!
		stMessage.stitre="Gestion des sinistres - SIMPA2"
		stMessage.scode ="WSIN709"
		
		f_message(stMessage)
	End if
End if
//: [ITSM92321]


// [PM194] 
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 210 )
If lDeb > 0 Then
	If idw_lstgti.Find("COD_ETAT = 200",1, idw_lstgti.RowCount()) <= 0 And &
		idw_WSin.GetItemNumber(1,"COD_ETAT") <> 200 Then
		
			idw_WSin.SetItem(1,"ID_TERRIT", idw_DetPro.GetItemNumber( lDeb, "ID_CODE_NUM") ) 
		
	End if
End if
// :[PM194] 
			
// [VDOC4684]
This.Uf_GetAutorisation ( "", gsBINDroit, bVal, bVal, bVal, -1 )

// [PM103][1]
lRowDS = idw_wDivSin.Find ( "Upper ( NOM_ZONE ) = 'DOSSIER_BASE_MANUELLE'", 1, idw_wDivSin.RowCount () ) 
If gbModeReprise_223 And idw_wSin.GetItemNumber ( 1, "COD_ETAT" ) = 0 And lRowDS	<= 0 Then

	lRowDS = idw_wDivSin.InsertRow (0)

	idw_wDivSin.SetItem ( lRowDS, "ID_SIN", idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )
	idw_wDivSin.SetItem ( lRowDS, "NOM_ZONE", "dossier_base_manuelle" )
	idw_wDivSin.SetItem ( lRowDS, "LIB_LABEL", "Dossier repris d'une base manuelle" )
	idw_wDivSin.SetItem ( lRowDS, "ID_TYP_LISTE", "-XX" )
	idw_wDivSin.SetItem ( lRowDS, "ALT_LISTE_CODECAR", "N" )
	idw_wDivSin.SetItem ( lRowDS, "ID_TYP_ZONE", "X" )
	idw_wDivSin.SetItem ( lRowDS, "ALT_OBLIG", "N" )
	idw_wDivSin.SetItem ( lRowDS, "ALT_PROT", "O" )
	idw_wDivSin.SetItem ( lRowDS, "CPT_TRI", 1000 )
	idw_wDivSin.SetItem ( lRowDS, "VAL_DTE", stNul.dtm ) // [PI056].20190926
	idw_wDivSin.SetItem ( lRowDS, "VAL_CAR", "O" )
	idw_wDivSin.SetItem ( lRowDS, "VAL_NBRE", stNul.lng)
	idw_wDivSin.SetItem ( lRowDS, "VAL_MT", stNul.dcm )
	idw_wDivSin.SetItem ( lRowDS, "ALT_SUPP", "N" )
	idw_wDivSin.SetItem ( lRowDS, "CREE_LE", DateTime ( Today (), Now () ) )
	idw_wDivSin.SetItem ( lRowDS, "MAJ_LE", DateTime ( Today (), Now () ) )
	idw_wDivSin.SetItem ( lRowDS, "MAJ_PAR", stGlb.sCodOper )
End If

lRowDS = idw_wDivSin.Find ( "Upper ( NOM_ZONE ) = 'DOSSIER_BASE_MANUELLE'", 1, idw_wDivSin.RowCount () ) 
If gbModeReprise_223 And lRowDS <= 0 And isTypeTrt = "S" Then
	stMessage.berreurg=FALSE
	stMessage.bouton=Ok!
	stMessage.icon=Exclamation!
	stMessage.stitre="Gestion des sinistres - SIMPA2"
	stMessage.scode ="WSIN725"
	
	f_message(stMessage)
	iPbControler.Enabled = False
End If 

If lRowDS > 0 And isTypeTrt = "S" Then
	lTotInter = idw_LstInter.RowCount ()
	For lCptInter = 1 To lTotInter
		If idw_LstInter.GetItemString ( lCptInter, "COD_INTER" ) <> "F" And &
			( idw_LstInter.GetItemString ( lCptInter, "COD_MODE_REG" ) = "XX" Or &
			  idw_LstInter.GetItemString ( lCptInter, "COD_MODE_REG" ) = "XA" ) Then 
			  
			  idw_LstInter.SetItem ( lCptInter, "COD_MODE_REG", stNul.str ) 
		End if	 
		
		If idw_LstInter.GetItemString ( lCptInter, "COD_INTER" ) = "F" And &
			( idw_LstInter.GetItemString ( lCptInter, "COD_MODE_REG" ) = "XX" Or &
			  idw_LstInter.GetItemString ( lCptInter, "COD_MODE_REG" ) = "XA" ) Then 
			  
			  idw_LstInter.SetItem ( lCptInter, "COD_MODE_REG", "FM" ) 
		End if	 
	Next
End If
// [PM103][1]


// [PC896_CDISCOUNT]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 233 )		
If lDeb > 0 Then

	sValCar=lnvString.of_getkeyvalue( idw_DetPro.GetItemString(lDeb,"VAL_CAR"), "NUM_SERIE", ";")
	sValCar2 = idw_WSin.GetItemString ( 1, "NUM_IMEI_PORT" )
	If Len ( Trim ( sValCar ) ) > 0  And ( IsNull ( sValCar2 ) Or Len ( Trim ( sValCar2 ) ) <= 0  )Then
		idw_WSin.SetItem ( 1, "NUM_IMEI_PORT", sValCar )
	End If

	sValCar=lnvString.of_getkeyvalue( idw_DetPro.GetItemString(lDeb,"VAL_CAR"), "MARQUE", ";")
	sValCar2 = idw_WSin.GetItemString ( 1, "MARQ_PORT" )
	If Len ( Trim ( sValCar ) ) > 0  And ( IsNull ( sValCar2 ) Or Len ( Trim ( sValCar2 ) ) <= 0  )Then
		idw_WSin.SetItem ( 1, "MARQ_PORT", sValCar )
	End If
	
End If	
// [PC896_CDISCOUNT]	

// [PC938_ORANGE_V3]
sVal = This.uf_GestOng_Divers_Trouver ( "SHT_RPLPRETVOL" )
lVal = idw_WSin.GetItemNumber ( 1, "COD_ETAT" )

If sVal = "O" And lVal = 0 Then
	stMessage.berreurg=FALSE
	stMessage.bouton=Ok!
	stMessage.icon=Information!
	stMessage.stitre="Remplacement Anticipé sur Vol"
	stMessage.scode ="WSIN743"
	f_message(stMessage)
End If
// /[PC938_ORANGE_V3]

// [PC512-5_ORANGE_V2_BIS] // [PM234-4_V1]
This.uf_Police_Orange_V2BIS ()
// [PC512-5_ORANGE_V2_BIS]	
	
// [VDoc11244]
// [VDOC13754]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 231 )
If lDeb > 0 and isTypeTrt = "S" And Not This.uf_GetAutorisation2 ( 208 ) Then
	stMessage.berreurg=FALSE
	stMessage.bouton=Ok!
	stMessage.icon=Information!
	stMessage.stitre="Justificatif SAV Orange Open Pro"
	stMessage.scode ="WSIN753"
	f_message(stMessage)
End if
// :[VDoc11244]

// [DT058]
If bRet Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 246 )
	If lDeb > 0 Then
		uf_zn_id_territ(FALSE )
	End if
End if
// :[DT058]

// [PC947&977]
// [ITSM292811][ADVISE]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 252 )
If lDeb > 0 Then
	lRow = idw_LstInter.Find ( "ID_FOUR = 'ADV' AND COD_INTER = 'F'", 1, idw_LstInter.RowCount())
	If lRow > 0 Then
		idw_LstInter.SetItem ( lRow, "COD_MODE_REG", "XA" )
	End IF 

	// [PC151259]
	sVal = lnvString.of_getkeyvalue ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "VARIANTE", ";")
	
	// On passe Hors Advise 5 sur la variante
	If sVal = "" Then
		lRow = idw_LstInter.Find ( "ID_FOUR = 'PSM' AND COD_INTER = 'F'", 1, idw_LstInter.RowCount())
		If lRow > 0 Then
			idw_LstInter.SetItem ( lRow, "COD_MODE_REG", "XA" )
		End IF 
	End If		
	
	// [DT076-2]
	lRow = idw_LstInter.Find ( "ID_FOUR = 'BK2' AND COD_INTER = 'F'", 1, idw_LstInter.RowCount())
	If lRow > 0 Then
		idw_LstInter.SetItem ( lRow, "COD_MODE_REG", "XA" )
	End IF 	
End If

/*
If stGLB.sCodOper = "JFF" and idw_WSin.GetItemNumber ( 1, "ID_PROD" ) = 81701 Then
	idw_wSin.SetItem ( 1, "ID_CONTRAT_ABONNE", "12345" )
End If
*/

// [PM261-1]
If isTypeTrt="S" Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 260 )
	If lDeb > 0 Then
		dDteAdh = idw_Wsin.GetItemDate ( 1, "DTE_ADH" )
		dtDteSurv =  idw_Wsin.GetItemDateTime ( 1, "DTE_SURV" )
		If DaysAfter(dDteAdh,Date(dtDteSurv)) <= 30 Then
			stMessage.sTitre		= "Saisie de sinistre"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WSIN771"
			F_Message ( stMessage )
		End If 
	End if
End if
// :[PM261-1]

// [DT076_ADVISE_V3]
// Pour Advise, si boutique 3084 alors on transforme en 3087 cofère NDC DT076 V3
// [VDOC14765] - Fermeture boutique Advise
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 252 )
If lDeb > 0 Then

	// [PC151259-2] // [PC171918]
	sVal2 = lnvString.of_getkeyvalue ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "VARIANTE", ";")
	Choose Case sVal2 
		Case "FULL_SERENITY_ADV_5", "ADVISE_6"
			lRow = idw_wDivSin.Find ( "Upper (NOM_ZONE) = 'PROCESS_PRS'", 1, idw_wDivSin.RowCount () ) 
			If lRow >0 Then 
				sVal = Trim ( Upper ( idw_wDivSin.GetItemString ( lRow, "VAL_CAR" ) ) )
				lRow2 = idw_wDivSin.Find ( "Upper (NOM_ZONE) = 'FRN_REPA_ADH'", 1, idw_wDivSin.RowCount () ) 			
				If lRow2 >0 Then 
					sVal2 = Trim ( Upper ( idw_wDivSin.GetItemString ( lRow2, "VAL_CAR" ) ) )			
					If ( IsNull ( sVal ) Or sVal = "" ) And sVal2 = "PSM" Then
						This.uf_gestong_divers_majzone( "PROCESS_PRS", lRow, K_MAJZONE, "2116" )
					End If
				End If
			End If	
	End Choose 
	
	sVal =Trim ( This.uf_GestOng_Divers_Trouver ( "COD_BOUTIQUE_ADH" ) )
	lRow = idw_wdivsin.Find("NOM_ZONE='cod_boutique_adh'",1, idw_wdivsin.RowCount())
	
	// [VDOC21200]
	uf_gestong_divers_majzone( "COD_BOUTIQUE_ADH", lRow, K_MAJZONE , "9999" ) 

	




/*
		Choose Case sVal
			Case "3087", "3083"
				uf_gestong_divers_majzone( "COD_BOUTIQUE_ADH", lRow, K_MAJZONE , "3084" ) 	// [VDoc14816]
			Case "3074"
				uf_gestong_divers_majzone( "COD_BOUTIQUE_ADH", lRow, K_MAJZONE , "3078" )
			Case "3085"
				uf_gestong_divers_majzone( "COD_BOUTIQUE_ADH", lRow, K_MAJZONE , "3086" ) // [VDoc15725]
			Case "3096", "3098"
				uf_gestong_divers_majzone( "COD_BOUTIQUE_ADH", lRow, K_MAJZONE , "3091" ) // [VDOC16492]
			Case "3101", "3095"
				uf_gestong_divers_majzone( "COD_BOUTIQUE_ADH", lRow, K_MAJZONE , "3097" ) // [VDOC16586][VDOC19090]
			Case "3094"
				uf_gestong_divers_majzone( "COD_BOUTIQUE_ADH", lRow, K_MAJZONE , "3092" ) 
			Case "3090"
				uf_gestong_divers_majzone( "COD_BOUTIQUE_ADH", lRow, K_MAJZONE , "3089" ) 
		End Choose
*/

	// [292811][ADVISE]
	sVal = This.uf_GestOng_Divers_Trouver ( "COD_BOUTIQUE_ADH" )
	If IsNumber ( sVal ) And Len ( Trim ( sVal )) >0 And Not IsNull ( sVal ) Then
		idw_wsin.SetItem ( 1, "ID_ORIAN_BOUTIQUE", Long ( sVal ) )
	Else 
		idw_wDivSin.SetItem ( lRow,"ALT_PROT", "N" )			
	End If
	
End If
// [DT076_ADVISE_V3]


// [PM234-6]
/*
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 94 )
	For lCptDetPro = lDeb To lFin
		sVal = lnvString.of_getkeyvalue ( idw_DetPro.GetItemString ( lCptDetPro, "VAL_CAR" ), "COD_DW", ";")
		Choose Case sVal 
			Case "V2BIS_ENT"
				This.Uf_Scripting_V2BIS_ENT ()
				bScriptTrouve = True
		End Choose
	Next
End If
*/
// [PM234-4_V1]


// [PM234-4_V1]
If Not bScriptTrouve Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 94 )
	For lCptDetPro = lDeb To lFin
		sVal = lnvString.of_getkeyvalue ( idw_DetPro.GetItemString ( lCptDetPro, "VAL_CAR" ), "COD_DW", ";")
		Choose Case sVal 
			Case "ORANGE_V2BIS"
				This.Uf_Scripting_V2BIS ()
		End Choose
	Next
End If
// [PM234-4_V1]

// [PC694-4] // [PC151425]
If isTypeTrt = "S" Then
	This.uf_ControlerGestion_Cplt_Adh_PayBox ( "OUVERTURE" )
End If


This.uf_PI052_DroitParam ( "DESACT" )
This.uf_PI052_DroitParam ( "RECH" )

If isReferentielApp = "IFR" Then
	
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 150 )
	If lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "VARIANTE", ";") = "PRIX_ORANGE" Then
		lDeb = 0
	End If
	
	If lDeb <= 0 Then
		sMarqApp = idw_WSin.GetItemString ( 1 , "MARQ_PORT" ) 
		sModlApp = idw_WSin.GetItemString ( 1 , "MODL_PORT" ) 
		SQLCA.PS_S_SAGA2_INTERRO_IFR ( sMarqApp, sModlApp, dcPrixPublicIFR ) // Rien à voir avec SAGA2, c'est juste une interro IFR

		dcPrixPublicDS = Dec ( Trim ( This.uf_GestOng_Divers_Trouver ( "MT_VAL_PUBLIQUE" ) ) )
		If IsNull ( dcPrixPublicDS ) Then dcPrixPublicDS = 0
		
		If IsNull ( dcPrixPublicIFR ) Then dcPrixPublicIFR = 0
		
		If dcPrixPublicIFR > 0 And dcPrixPublicDS > 0 And dcPrixPublicIFR > dcPrixPublicDS Then
			stMessage.sTitre		= "Saisie de sinistre"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WSIN811"
			stMessage.sVar[1] 	= String ( dcPrixPublicDS )		
			stMessage.sVar[2] 	= String ( dcPrixPublicIFR )
			F_Message ( stMessage )
		End IF
	End If					
End If

// [ITSM456410] 
This.uf_ControlerGestion_Typ_App_ds( "PREPA_MOD" ) 

// [PM360-2]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 324 )
If lDeb <= 0 Then	
	idw_LstInter.Modify ( "rib_cpt.format='[GENERAL]~tfill (~~'XX~~', 9) + right (rib_cpt, 2)'" )
Else 
	idw_LstInter.Modify ( "rib_cpt.format='[GENERAL]'" )		
End If


// [DT346]
If isTypeTrt = "S" Then
	This.uf_ControlerGestion_OrangeParnasse ( "PREPA_MOD" )
End If

// [DT341]
// [ITSM530047]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 275 )
If lDeb > 0 Then	
	dcIdSin		= idw_wSin.GetItemNumber ( 1, "ID_SIN" )
	dcIdProd		= idw_wSin.GetItemNumber ( 1, "ID_PROD" )
	dcIdEts		= idw_wSin.GetItemNumber ( 1, "ID_ETS" )
	sIdAdh		= idw_wSin.GetItemString ( 1, "ID_ADH" )
	dtDteSurv	= DateTime ( idw_wSin.GetItemDate ( 1, "DTE_SURV_DATE" ) )
				
	iNbAutreSin = 0
	SQLCA.PS_S_W_GTI_NBSIN_REGL_REPAR_REMPL ( dcIdSin, dcIdProd, dcIdEts, sIdAdh, dtDteSurv, iNbAutreSin )
	
	If iNbAutreSin >= 2 Then
		stMessage.sTitre		= "Sinistre(s) indemnisé(s)"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sCode		= "WSIN819"
		stMessage.sVar[1] 	= String ( iNbAutreSin + 1 )	// On parlera dans le message de la "déclaration", donc +1
		F_Message ( stMessage )		
	End If
End If	

// [VDOC25774]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 306 )
If lDeb >= 0 Then
	If idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) = "292ACC" Then
		stMessage.sTitre		= "Information"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sCode		= "WSIN820"
		stMessage.sVar[1] 	= String ( iNbAutreSin )		
		F_Message ( stMessage )			
	End If 
End If 


// [PM445-1]
If isTypeTrt = "S" Then 
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )

	lVal = idw_LstwCommande.Find ( &
			"ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER', 'A_DIAGNOSTIQUER' ) AND " + &
			"ISNULL ( DTE_RCP_FRN ) AND LEN ( ID_BON_TRANSP ) > 0 AND " + &
			"POS ( INFO_FRN_SPB_CPLT, 'PRBLE_LIVRAISON' ) > 0 AND " + &
			"POS ( INFO_FRN_SPB_CPLT, 'PERTE_ALLER' ) > 0 AND " + &
			"COD_ETAT IN ( 'ECT', 'ECL' )", &
			1, idw_LstwCommande.RoWCount () )

	If lVal > 0 Then 

		lVal = idw_LstwCommande.GetItemNumber ( lVal, "ID_SEQ" )

//				" AND CPT_VALIDE > 0" +  &		
		lVal = idw_LstwCommande.Find ( &
				"( ID_TYP_ART NOT IN ( 'DEV', 'AEF', 'CAS', 'SMS', 'BAM', 'ALE', 'ACC', 'PCM', 'MAI', 'REL', 'PST', 'RES', 'REA', 'PRS', 'EDI', 'RST' ) " + &
				"  OR " + &
				"  ( ID_TYP_ART = 'RST' AND POS ( INFO_SPB_FRN_CPLT, 'RST_CMDE+SUIVI=OUI' ) > 0 ) " + &
				") " + &
				" AND ( STATUS_GC NOT IN ( 176 ) AND COD_ETAT <> 'ANN' ) " + &
				" AND ID_SEQ > " + String ( lVal ) &					
				, 1, idw_LstwCommande.RowCount ()) 			
				
		lVal1 = idw_wDetail.Find ( "ID_I_REG = 0 AND COD_ETAT = 600", 1, idw_wDetail.RowCount() )
			

		// Hors Orange V3
		If lDeb <= 0 Then
			
			If lVal <= 0 And lVal1 <= 0 Then
				stMessage.sTitre		= "Information"
				stMessage.Icon			= Exclamation!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= OK!
				stMessage.sCode		= "WSIN826"
				F_Message ( stMessage )			
			End If 

		// OrangeV3
		ELse 
	
			If lVal <= 0 And lVal1 <= 0 And This.uf_getautorisation2 ( 9 ) Then
				stMessage.sTitre		= "Information"
				stMessage.Icon			= Exclamation!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= OK!
				stMessage.sCode		= "WSIN827"
				F_Message ( stMessage )				
			End If
			
		End If	
	End If	
End If

// [VDOC27557]
If isTypeTrt = "S" Then 

	sVal = This.uf_GestOng_Divers_Trouver ( "DOSSIER_BLOQUE_DR" )
	
	If sVal = "O" Then
		If Pos ( gsDroitDosBloqueDR, "#" + stGlb.sCodOper + "#" ) <= 0 Then 
			iPbControler.Enabled = False
			stMessage.sTitre		= "Dossier en expertise"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WSIN839"
			F_Message ( stMessage )
		Else 
			stMessage.sTitre		= "ALERTE Lutte AB&AT"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WSIN840"
			F_Message ( stMessage )	
			
			// [PM506-1]
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 346 )
			If lDeb > 0 Then
				sPctRisque = lnvString.of_getkeyvalue( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "PCT_RISQUE", ";") 
				sPctRisque = F_Remplace ( sPctRisque, "%", "" ) 
				sPctRisque = Trim ( sPctRisque )
				If IsNull ( sPctRisque ) Or sPctRisque = "" Then sPctRisque = "100"
				If Not IsNumber ( sPctRisque ) Then sPctRisque = "100"
				iPctRisque = Integer ( sPctRisque )				
				
				sVal = uf_GestOng_Divers_Trouver ( "PM506_PERSON_A_RISQUE" )
				sVal = F_Remplace ( sVal, "%", "" ) 
				sVal = Trim ( sVal )
				If IsNumber ( sVal ) Then 
					If integer ( sVal ) >= iPctRisque Then
						stMessage.sTitre		= "Dossier en audit"
						stMessage.Icon			= Exclamation!
						stMessage.bErreurG	= FALSE
						stMessage.Bouton		= OK!
						stMessage.sVar[1]    = sVal
						stMessage.sCode		= "WSIN862"
						F_Message ( stMessage )	
					End IF 
				End If 
			End If 
			
		End If 	
	End If 	
End If 	

// [DT386_EXTR_AXA]
If isTypeTrt = "S" Then 
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 335 )
	lRow = idw_LstWcommande.RowCount()		
	IF lDeb > 0 And lRow <= 0 Then
		stMessage.sTitre		= "Info importante"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sCode		= "WSIN845"
		F_Message ( stMessage )			
	End If 
ENd If 

// [PC192290]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 345 )
If lDeb > 0 And isTypeTrt = "S" Then
	
	sZnDS_pceSherpaRacine = "sznds_pcesherpa_"
	iZnDS_pceSherpa = 1 
	sVal = ""

	Do While TRUE
		sZnDS_pceSherpa = Upper ( sZnDS_pceSherpaRacine + String ( iZnDS_pceSherpa ) )
		lRow = idw_wdivsin.Find( "Upper(NOM_ZONE)='" + sZnDS_pceSherpa + "'",1,idw_wdivsin.RowCount()) 
		
		If lRow <= 0 Then Exit
		
		sVal += This.uf_GestOng_Divers_Trouver ( sZnDS_pceSherpa )
		
		idw_wdivsin.DeleteRow ( lRow ) 
		
		iZnDS_pceSherpa += 1
	Loop 
	
	// [20210928162035633]
	sVal = F_Remplace ( sVal, "@", "" ) // On enlève le caractère de fin de chaine
	
	Do While sVal <> ""

		iPos = Pos ( sVal, "#" )  
		sValTemp = Left ( sVal, iPos - 1 )
		
		// [RS5656_MOD_PCE_DIF]
		sIdGti = lnvString.of_getkeyvalue (sValTemp, "IGA", ";")
		sIdDetail = lnvString.of_getkeyvalue (sValTemp, "IDT", ";")
		IF sIdGti = "" Then sIdGti = "-1"
		IF sIdDetail = "" Then sIdDetail = "-1"			
		
		sIdPce = lnvString.of_getkeyvalue (sValTemp, "IP", ";")
		sEtatPce = lnvString.of_getkeyvalue (sValTemp, "EP", ";")
		sDteAnalysePce = lnvString.of_getkeyvalue (sValTemp, "DA", ";")
		
		iRow = gdsPieceSherpa.InsertRow ( 0 )

		// [RS5656_MOD_PCE_DIF]
		gdsPieceSherpa.SetItem ( iRow, "ID_GTI", Integer (sIdGti) )
		gdsPieceSherpa.SetItem ( iRow, "ID_DETAIL", Integer (sIdDetail) )

		gdsPieceSherpa.SetItem ( iRow, "ID_PCE", Integer (sIdPce) ) 
		gdsPieceSherpa.SetItem ( iRow, "ETAT_PCE", sEtatPce ) 
		gdsPieceSherpa.SetItem ( iRow, "DTE_ANALYSE_PCE", DateTime ( sDteAnalysePce ) ) 
		gdsPieceSherpa.SetItem ( iRow, "ID_I", 0 )
		
		sVal = Mid ( sVal, iPos + 1, Len ( sVal ) ) 
		
	Loop
	
	Do While Not bFin
		stMessage.sTitre		= "Info importante"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= YESNO!
		stMessage.sCode		= "WSIN853"
		If F_Message ( stMessage ) = 1 Then bFin = TRUE
	Loop
		
	
End IF 

// [PC202553_SELECTRA]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 348 )
If lDeb > 0 Then
	If idw_WSin.GetItemNumber(1,"COD_ETAT") = 0 And &
		This.uf_GestOng_Divers_Trouver ( "TYPE_APP" ) = "TEL" &
	Then		
		idw_WSin.SetItem (1,"NUM_IMEI_PORT", stNul.str )
	End If 
	
	// [NVX_MSG_SELECTRA]
	sVal = uf_GestOng_Divers_Trouver ( "FRANCHISE_PAYBOX" ) 
	sVal1 = uf_GestOng_Divers_Trouver ( "MT_FRANCHISE_PAYBOX" ) 
	lRow  = idw_wFrais.find ( "MT_FRAIS > 0 AND ID_TYP_FRAIS = 7 AND COD_ETAT = 600", 1, idw_wFrais.RowCount ())
	
	If sVal = "N" and dec ( sVal1 ) > 0 And lRow > 0 Then
		bFin = False
		Do While Not bFin
			stMessage.sTitre		= "ATTENTION ! Dossier refusé"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= YESNO!
			stMessage.sCode		= "WSIN880"
			If F_Message ( stMessage ) = 1 Then bFin = TRUE
		Loop		
	End If 		
	
End If 

// [VDOC29906]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 357 )
If lDeb > 0 Then
	dtDteSurv =  idw_Wsin.GetItemDateTime ( 1, "DTE_SURV" )
	dDteDecl =  idw_Wsin.GetItemDate ( 1, "DTE_DECL" )
	
	If F_PLUS_DATE ( Date ( dtDteSurv ), 7, "M" ) < Date ( dDteDecl ) Then
		bFin = False
		Do While Not bFin
			stMessage.sTitre		= "vDoc29906 : Info importante"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= YESNO!
			stMessage.sCode		= "WSIN868"
			If F_Message ( stMessage ) = 1 Then bFin = TRUE
		Loop
	End IF 
End IF 


// [RS_1807_1793]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 360)
If lDeb > 0 Then
	Choose Case idw_Wsin.GetItemNumber ( 1, "COD_ETAT" )
		Case 0, 100
			sVal=lnvString.of_getkeyvalue( idw_DetPro.GetItemString(lDeb, "VAL_CAR"), "ID_CAS", ";")
			If sVal = "RS_1807_1793_MSG_PAC_CAISSE_AFFILIE" Then
				bFin = False
				Do While Not bFin
					stMessage.sTitre		= "RS1807-1793 : Caisse affiliée"
					stMessage.Icon			= Exclamation!
					stMessage.bErreurG	= FALSE
					stMessage.Bouton		= YESNO!
					stMessage.sCode		= "WSIN878"
					If F_Message ( stMessage ) = 1 Then bFin = TRUE
				Loop
			End If 
	End Choose 
End If 

// [PRBLE_DIF_BNP]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 362)
If lDeb > 0 Then

	sValCar = idw_WSin.GetItemString ( 1, "MARQ_PORT" )
	If IsNull ( sValCar ) Then sValCar = ""
	If sValCar <> "PAS_DE_MARQUE" Then
		SetNull ( sValCar )
		idw_WSin.SetItem ( 1, "MARQ_PORT", sValCar )
	End If
	
	sValCar = idw_WSin.GetItemString ( 1, "MODL_PORT" )
	If IsNull ( sValCar ) Then sValCar = ""
	If sValCar <> "PAS_DE_MODELE" Then
		SetNull ( sValCar )
		idw_WSin.SetItem ( 1, "MODL_PORT", sValCar )
	End If
	
	SetNull ( sValCar )
	idw_WSin.SetItem ( 1, "NUM_IMEI_PORT", sValCar )
	idw_WSin.SetItem ( 1, "NUM_PORT", sValCar )		
	
End IF 


// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	lDeb = idw_LstwCommande.Find ("POS (INFO_SPB_FRN_CPLT, 'ID_HUB_PRESTA') > 0 AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If ldeb > 0 Then
		lIdSeq = idw_LstwCommande.GetItemNumber ( lDeb, "ID_SEQ" ) 
		
		If lnvString.of_getkeyvalue ( idw_LstwCommande.GetItemString ( lDeb,"INFO_SPB_FRN_CPLT" ), "HP_ID_HUB_PRESTA", ";") = "" Then
			lDeb = 0
		End If 
	End If 
	
	If lDeb > 0 Then
		dcIdSin = idw_wSin.GetItemNumber ( 1, "ID_SIN" )
		lRow = idsHubDonneesPrestaSimpa2.Retrieve ( 2, dcIdSin, lIdSeq ) 
	End IF 	
End If

// [HUB875]
If F_CLE_A_TRUE ( "HUB875" ) Then
	If SQLCA.PS_DETECTION_ERREUR_DP393 ( lIdProd ) < 0 Then
		
		Do While Not bFin
			stMessage.berreurg=FALSE
			stMessage.bouton=YESNO!
			stMessage.icon=Exclamation!
			stMessage.stitre="Gestion des sinistres - SIMPA2"
			stMessage.scode ="WSIN919"
			If F_Message ( stMessage ) = 1 Then bFin = TRUE
		Loop
		
		iPbControler.Enabled = False
	End IF 
End If

// === A LAISSER A LA FIN ===== CODER AU DESSUS =====
// [PI087_PM473_2]
// Gestion de la trace de consultation (d'encours) ici ET je Commit. 
If isTypeTrt = "C" Then 

	dcIdSin = idw_wSin.GetItemNumber ( 1, "ID_SIN" )
	lRet = SQLCA.PS_I_PI087_TRACE_DOSSIER_V01 ( dcIdSin, "CONSULTATION", stGLB.sCodOper, dcIdInter, dcIdDoc )
	
	bRet2 = SQLCA.SqlCode = 0 And SQLCA.SqlDbCode = 0 And lRet > 0
	
	F_Commit ( SQLCA, bRet2 ) 
	
	If Not bRet2 Then
		stMessage.sTitre		= "Consultation d'un dossier"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= False
		stMessage.sVar[1] 	= "PS_I_PI087_TRACE_DOSSIER"
		stMessage.sVar[2] 	= String ( SQLCA.SqlDbCode )
		stMessage.sVar[3] 	= SQLCA.SqlErrText
		stMessage.sCode		= "WSIN849"
		F_Message ( stMessage )
	End If 
End If 	

astPass.bRetour = bRet



end subroutine

private subroutine uf_tb_coordonnees ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Tb_Coordonnees (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 17:35:30
//* Libellé			: 
//* Commentaires	: Gestion des TabOrder pour les coordonnées
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//*-----------------------------------------------------------------

/*------------------------------------------------------------------*/
/* Cette fonction concerne les zones suivantes :                    */
/* ADR_1, ADR_2, ADR_CP, ADR_VILLE, NUM_FAX, NUM_TELB, NUM_TELD.    */
/*------------------------------------------------------------------*/

String sCol[ 7 ]

sCol[  1 ] = "ADR_1"
sCol[  2 ] = "ADR_2"
sCol[  3 ] = "ADR_CP"
sCol[  4 ] = "ADR_VILLE"
sCol[  5 ] = "NUM_FAX"
sCol[  6 ] = "NUM_TELB"
sCol[  7 ] = "NUM_TELD"

///*------------------------------------------------------------------*/
///* Si on gére les adresses pour les adhésion SPB, la modification   */
///* des coordonnées est interdite. Si la zone COD_PROV_PERS = W,     */
///* (et que l'on ne gére pas les coordonnées), on autorise la        */
///* saisie des coordonnées.                                          */
///*------------------------------------------------------------------*/
//sCodAdh 		= idw_Produit.GetItemString ( 1, "COD_ADH" )
//lCodAdrDms	= idw_Produit.GetItemNumber ( 1, "COD_ADR_DMS" )
//
//If	( sCodAdh = "1" Or sCodAdh = "6" ) And lCodAdrDms = 1 Then
//	idw_wSin.Uf_Proteger ( { "ADR_1", "ADR_2", "ADR_CP", "ADR_VILLE" }, "1" )
//Else
//	sCodProvPers = idw_wSin.GetItemString ( 1, "COD_PROV_PERS" )	
//	If	sCodProvPers = "W"	Then
//		idw_wSin.Uf_Proteger ( sCol, "0" )
//	Else
//		idw_wSin.Uf_Proteger ( sCol, "1" )
//	End If
//End If

/*------------------------------------------------------------------*/
/* Le 19/01/1999.                                                   */
/* Suite modification, la saisie sur toutes les zones de            */
/* coordonnées ADRESSE est interdite. La modification se fera sur   */
/* l'interlocuteur.                                                 */
/*------------------------------------------------------------------*/
idw_wSin.Uf_Proteger ( sCol, "1" )

end subroutine

private subroutine uf_tb_nature ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Tb_Nature (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 17:35:30
//* Libellé			: 
//* Commentaires	: Gestion des TabOrder pour Nature, Territorialité, Détail, Date et Heure Survenance
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

/*------------------------------------------------------------------*/
/* Cette fonction concerne les zones suivantes :                    */
/* ID_NATSIN, ID_TERRIT, ID_DETSIN, DTE_SURV, HEU_SURV.             */
/*------------------------------------------------------------------*/
String sCol[ 4 ]
Long lTotDet, lCpt, lCodEtat
String sHeuDet
Boolean bHeuSurv

/*------------------------------------------------------------------*/
/* Le 04/12/1998:                                                   */
/* Modification pour l'heure de survenance. La zone devient non     */
/* saisissable si l'un des détails réglés posséde une heure de      */
/* positionnée.                                                     */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Il faut faire ce test avant toute chose, sinon l'armement de la  */
/* valeur ilPremCol sera faux.                                      */
/*------------------------------------------------------------------*/

lTotDet = idw_wDetail.RowCount ()
bHeuSurv = True
For	lCpt = 1 To lTotDet
		lCodEtat = idw_wDetail.GetItemNumber ( lCpt, "COD_ETAT" )
		sHeuDet	= idw_wDetail.GetItemString ( lCpt, "HEU_DET" )

		If	lCodEtat = 600 And Not IsNull ( sHeuDet ) Then
			bHeuSurv = False
			Exit
		End If
Next

If	bHeuSurv	Then
	idw_wSin.Uf_Proteger ( { "HEU_SURV" }, "0" )

	idw_wSin.ilPremCol	= 15						// Zne HEU_SURV
	idw_wSin.isNomCol		= "HEU_SURV"
Else
	idw_wSin.Uf_Proteger ( { "HEU_SURV" }, "1" )
End If


sCol[  1 ] = "ID_NATSIN"
sCol[  2 ] = "ID_TERRIT"
sCol[  3 ] = "ID_DETSIN"
sCol[  4 ] = "DTE_SURV_DATE"

/*------------------------------------------------------------------*/
/* Si le montant réglé est supérieur strictement à zéro, les zones  */
/* ne sont pas saisissables.                                        */
/*------------------------------------------------------------------*/

If	idw_wSin.GetItemNumber ( 1, "MT_REG" ) > 0 Then
	idw_wSin.Uf_Proteger ( sCol, "1" )
	
	idw_wSin.ilPremCol	= 37						// Zne REF_CIE
	idw_wSin.isNomCol		= "REF_CIE"

	idw_wSin.ilDernCol	= 47						// Zne ALT_BLOC

Else
	idw_wSin.Uf_Proteger ( sCol, "0" )

	idw_wSin.ilPremCol	= 56						// Zne DTE_SURV_DATE
	idw_wSin.isNomCol		= "DTE_SURV_DATE"

	If	idw_wSin.GetItemString ( 1, "ALT_SSUI" ) = "O"	Then
		idw_wSin.ilDernCol	= 44						// Zne COD_MOT_SSUI
	Else
		idw_wSin.ilDernCol	= 43						// Zne ALT_SSUI
	End If

End If

end subroutine

private subroutine uf_tb_sanssuite ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Tb_SansSuite (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 17:35:30
//* Libellé			: 
//* Commentaires	: Gestion des TabOrder pour ALT_SSUI, COD_MOT_SSUI.
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

/*------------------------------------------------------------------*/
/* Cette fonction concerne les zones suivantes :                    */
/* ALT_SSUI, COD_MOT_SSUI.                                          */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* LE 18/11/2005 JFF : Je shunt ce code qui se révèle est gênant    */
/* avec le soldage automatique des dossiers sur lesquels des frais  */
/* d'envois ont été réglés.                                         */
/*------------------------------------------------------------------*/

String sCol[ 2 ]

sCol[  1 ] = "ALT_SSUI"
sCol[  2 ] = "COD_MOT_SSUI"

idw_wSin.Uf_Proteger ( sCol, "0" )
Return

/*------------------------------------------------------------------*/
/* Si le montant réglé est supérieur strictement à zéro, les zones  */
/* ne sont pas saisissables.                                        */
/*------------------------------------------------------------------*/

If	idw_wSin.GetItemNumber ( 1, "MT_REG" ) > 0 Then
	idw_wSin.Uf_Proteger ( sCol, "1" )
Else
	idw_wSin.Uf_Proteger ( sCol, "0" )
End If

end subroutine

private subroutine uf_tb_validation ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Tb_Validation (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 17:35:30
//* Libellé			: 
//* Commentaires	: Gestion des TabOrder en consultaion/Validation.
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//* #1	 CAG	 17/07/2002	  Modification SFR #
//* #2	 CAG	 08/11/2002	  La zone id_orian_boutique devient saisissable
//*								  si cod_adh <> 1 et 6 => gestion de la zone
//*-----------------------------------------------------------------

String sCol[]
Int	 iCpt, iTot

/*------------------------------------------------------------------*/
/* Cette fonction concerne toutes les zones.                        */
/*------------------------------------------------------------------*/
sCol [  1 ] = "REF_CIE"
sCol [  2 ] = "DTE_SURV_DATE"
sCol [  3 ] = "HEU_SURV"
sCol [  4 ] = "ID_NATSIN"
sCol [  5 ] = "ID_TERRIT"
sCol [  6 ] = "ID_DETSIN"
sCol [  7 ] = "ADR_1"
sCol [  8 ] = "ADR_2"
sCol [  9 ] = "ADR_CP"
sCol [ 10 ] = "ADR_VILLE"
sCol [ 11 ] = "NUM_FAX"
sCol [ 12 ] = "NUM_TELB"
sCol [ 13 ] = "NUM_TELD"
sCol [ 14 ] = "ALT_SSUI"
sCol [ 15 ] = "COD_MOT_SSUI"
sCol [ 16 ] = "ALT_BLOC"
sCol [ 17 ] = "ALT_EDIT"
/*------------------------------------------------------------------*/
/* # 1											                             */
/*------------------------------------------------------------------*/
sCol [ 18 ] = "NUM_PORT"
sCol [ 19 ] = "NUM_IMEI_PORT"
sCol [ 20 ] = "MARQ_PORT"
sCol [ 21 ] = "MODL_PORT"
sCol [ 22 ] = "DTE_ACH_PORT"
sCol [ 23 ] = "DTE_OUVLIG_PORT"
/*------------------------------------------------------------------*/
/* # 2											                             */
/*------------------------------------------------------------------*/
sCol [ 24 ] = "ID_ORIAN_BOUTIQUE"
sCol [ 25 ] = "DTE_RESIL"

idw_wSin.Uf_Proteger ( sCol, "1" )




end subroutine

private function string uf_titre (integer aitype);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Titre (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 12/01/1998 22:30:41
//* Libellé			: 
//* Commentaires	: Mettre un titre dans la fenêtre MASTER
//*
//* Arguments		: Integer		aiType			(Val)	Type de choix
//*
//* Retourne		: String			Titre de la fenêtre
//*
//*-----------------------------------------------------------------

/*------------------------------------------------------------------*/
/* Le titre de la fenêtre se décompose ainsi :                      */
/* LIB_COURT (ID_PROD) (Rév : ID_REV) / Sinistre N° ID_SIN / COD_CIV NOM PRENOM    */
/*------------------------------------------------------------------*/

String sRet, sCodCiv, sNom, sPrenom

Choose Case aiType
Case 1
	sCodCiv	= idw_wSin.Describe ( "Evaluate ( 'LookUpDisplay ( COD_CIV )', 1 ) " )
	sNom		= idw_wSin.GetItemString ( 1, "NOM" )
	sPrenom	= idw_wSin.GetItemString ( 1, "PRENOM" )

End Choose

If	IsNull ( sNom ) 		Then sNom = ""
If	IsNull ( sPrenom )	Then sPrenom = ""

sRet =	idw_Produit.GetItemString ( 1, "LIB_COURT" )									+ " ("					+ &
			String ( idw_Produit.GetItemNumber ( 1, "ID_PROD" ) ) 					+ ") (Rév : "			+ &
			String ( idw_wSin.GetItemNumber ( 1, "ID_REV" ) ) 							+ ") / Sinistre N° "	+ &
			String ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )							+ " / " 					+ &
			sCodCiv																					+ " " 					+ &
			sNom																						+ " " 					+ &
			sPrenom

Return ( sRet )
end function

private subroutine uf_controlersaisie (ref s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_ControlerSaisie (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 10:49:34
//* Libellé			: 
//* Commentaires	: Contrôle de saisie du sinistre
//*
//* Arguments		: s_Pass			astPass			(Réf) Structure de passage
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ 			PAR		Date		  Modification
//* DCMP000055	JFF		17/02/2000 Insertion d'un controle de saisie (TC)
//* DCMP020260	CAG		07/07/2002 Insertion d'un controle de saisie	(13400)
//* #1			CAG		08/11/2002 Ctrl de saisie sur l'id_orian_boutique
//* #2			JFF 		11/04/2003 Je vire les caractère suivant ' " du message
//* #3			CAG   	16/06/2003 Modification de la marque portable en dddw
//* #4			CAG		17/06/2003 Vérification de la conformité de l'id_contrat_abonne pr cmde CEGETEL 5707
//* #5			JFF		30/06/2003 Suite demande de D. Talmat la modif #4 se reporte aussi pour Produit 5712
//* #6		   CAG	   04/08/2003 Modif du libellé du msg concernant la modif #3
//* #7			JFF		22/08/2003 DCMP 030362 : Contrôle des communes sur W_INTER et W_COMMANDES
//* #8			JFF		01/09/2003 Contrôle de la validité des TAC IMEI/Marques
//* #9			JFF		13/11/2003 Pour DARTY, la date d'achat du mobile est oblig.
//* #10			JFF		03/03/2004 DCMP 040098 : Modification pour ORANGE Marketing.
//* #11        MADM     12/07/2006 DCMP 050393 : Gestion de refus automatique entre évènement et nature de sinistre
//* #12        JCA     	21/09/2006 DCMP 006651
//* #13        JFF      14/12/2006 Modification du Contrôle (Il y a avait un bug)
//* #14			PHG		27/12/2006 [CRAO_LOT1] : Gestion de Controle D'activité IMEI v2
//*										  - Lecture de l'Option det_pro 75
//*										  - Desactivation IMEI Obligatoire si Option 75 activée	
//* #15			PHG		25/01/2007 [CRAO_LOT2] Dseactivation Option 19 et champs IMEI Ctrl
//* #16		   JFF	   19/02/2006  [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
//* #17			PHG		13/09/2007 [DCMP070612] Déconnexion Ctrl TAC/IMEI si Role 208
//* #18			PHG		09/08/2008 [DCMP080625] Désactivation Controle
//*															Marque/modele obligatoire
//* #19			JFF		20/10/2008 [FNAC_PROD_ECH_TECH]
//* #20  		JFF   	31/03/2009  [20090331230441250]
//* #21			FPI		05/08/2009	[DCMP090366] Controle de saisie mail
//* #22			FPI		03/02/2010	[20100203.FPI] Epuration du message
//* 				JFF		03/06/2010  [DCMP100397] Numéro de facture Attitude
//					FPI		18/06/2010  [Shunte_WSIN695.role_factu] On shunte le message WSIN695 pour la facturation
//* 				FPI		03/02/2010	[20100625.FPI] Epuration du message
//*            JFF      30/06/2010  [PM50_CRAO]
//					FPI		09/11/2010	[20101109.FPI] Suppression des tab dans "num_imei_port" et "modl_port".
// 				FPI		14/03/2011	[PC434]
//					FPI		03/05/2011	[PC494]
//             JFF      21/12/2011  [PC398][Point_31]
//             JFF      15/01/2013  [PC801_V10]
//             JFF      18/03/2014  [PC13279_MOBILEO]
//       		JFF   	28/09/2016  [DT262]
// 				FPI		21/10/2016	[PI056] dte_ach_port en datetime
//					FPI		31/07/2017	[CTL_MAIL] Ajout contrôle des emails
//       		JFF   	15/05/2019 	[DT386_EXTR_AXA]
//        		JFF   	05/08/2024  [MCO602_PNEU]
//        		JFF   	31/07/2025  [BUG_INTER]
//*-----------------------------------------------------------------

String 				sCol [], sErr [], sVal [], sValFinale, sValQuote, sFind, sMarq, sIdContratAbonne, sIMEI, s15Zero
String 				sNouvelleLigne, sText, sPos, sOng, sHeure, sCodAdh, sCodModeReg, sIdAdh, sAltValide, sTC, sFUSION_Aqu, sFUSION_Orne, sFUSION
String				sPosRef, sIMEICorrige, sTypeApp, sIMEIOrigLu,sIdEvtDetPro, sValTempo, sDtePivot
String 				sVal1, sVal2
Long 					lCpt, lNbrCol, lTotInter, lTotGti, lCodEtat, lIdGti, lTotDetail, lIdProd, lIdCarte, lFUSIONProd, lFUSIONIdCarte
Long					lCptQT1, iCptQT, iPosQT, lRow, lDeb2, lFin2, lDeb, lFin, lCodTel, lVal, lCodEtatSin, lCodEtatSinActuel, lIdGtiDetPro, lCpt2, lIdEvt
Int					iTC, iFUSION, iFUSIONSLASH
Time					tTime
Boolean				bModifGti, bModifDteSurv, bAltBloc, bOkPourCtrl, bDejaRegleUnefois, bPresenceDuneCmdeAValider, bFin
//Boolean 				bOption19 // #15 [CRAO_LOT2]
DateTime 			dtDteSurv
DataWindowChild	dwChild
Date					dDteVal, dCreeLe
boolean 				bPec, bCmd // #12
Boolean				bOption75, bOktoMsg		// #14 [CRAO_LOT1]
Boolean				bPresenceCmdeWeb // #16
string				sCraCtrlImei, sNumPort	// #14 [CRAO_LOT1]
string				sCraCptDmde, sCraSuiviImei // #14 [CRAO_LOT1]
string				sModl // #18 [DCMP080625]
n_cst_string		lnvString // #18 [DCMP080625]
String 				sValNumFact 

sNouvelleLigne		= "~r~n"
sPos					= ""
sOng					= "01"
sText					= sNouvelleLigne
s15Zero				= Fill ( "0", 15 )
lCodTel				= idw_Produit.GetItemNumber ( 1, "COD_TEL" )
bPec					= false // #12
bCmd					= false // #12
bPresenceCmdeWeb  = This.uf_Gestion_Mdp_Extranet_Cmde ( "PRESENCE_CMDE_WEB" ) = "1"
sNumPort 			= Trim ( idw_wSin.GetItemString ( 1, "NUM_PORT" ) ) // #14
dCreeLe				= Date (idw_wsin.GetItemDateTime (1, "CREE_LE" ) ) // #16

// [PM50_CRAO]
If This.uf_GestOng_Divers_Trouver( "CRA_CTRL_IMEI" ) = "O" Then
	idw_Wsin.SetItem ( 1, "ALT_EDIT", "N" )
End If
// :[PM50_CRAO]

/*------------------------------------------------------------------*/
/* #1 			                                                     */
/*------------------------------------------------------------------*/
This.uf_ControlerSaisie_Boutique (2, sText, sPos)

/*------------------------------------------------------------------*/
/* #7 : DCMP 030362                                                 */
/*------------------------------------------------------------------*/
This.uf_ControlerSaisie_Commune ( sText, sPos )

/*------------------------------------------------------------------*/
/* #8 																				  */
/*------------------------------------------------------------------*/
//	[20101109.FPI]
sIMEI=Trim ( idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) )
If not isNull(sIMEI) Then
	sImei=f_remplace(sImei,"" + CharA(9),"")
	idw_wSin.SetItem( 1, "NUM_IMEI_PORT",sIMEI ) 
End if
//	:[20101109.FPI]

/*------------------------------------------------------------------*/
/* #10 : Utilisation de la zone REF_CIE pour la saisie d'un IMEI de */
/* controle sur option 19.														  */
/*------------------------------------------------------------------*/
// #15 [CRAO_LOT2] une fois deconexion option 19 faite supprimer cette partie.
// F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 19 )
// bOption19 = lDeb > 0 

/*------------------------------------------------------------------*/
/* #14 : [CRAO_LOT1] Mémorisation de l'activation de l'option       */
/*       det_pro 75 : "Gestion CR Activite IMEI"                    */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 75 )
bOption75 = lDeb > 0 

bAltBloc = idw_Wsin.GetItemString ( 1, "ALT_BLOC" ) = "O"

// #21 [DCMP090366]
If Not bAltBloc Then
	This.uf_ControlerSaisie_pecweb ( sText, sPos )
End If

//* #19	[FNAC_PROD_ECH_TECH]
If Not bAltBloc Then
	This.uf_ControlerSaisie_SMS ( sText, sPos )
End If

sCol[ 1 ] = "ADR_1"
sCol[ 2 ] = "ADR_CP"
sCol[ 3 ] = "ADR_VILLE"
sCol[ 4 ] = "ID_NATSIN"
sCol[ 5 ] = "ID_DETSIN"
sCol[ 6 ] = "ID_TERRIT"
sCol[ 7 ] = "DTE_ACH_PORT"  // #9
sCol[ 8 ] = "DTE_RESIL"

sErr[ 1 ] = " - La première ligne d'adresse"
sErr[ 2 ] = " - Le code postal"
sErr[ 3 ] = " - La ville"
sErr[ 4 ] = " - La nature du sinistre"
sErr[ 5 ] = " - Le détail du sinistre"
sErr[ 6 ] = " - La territorialité de survenance"
//sErr[ 7 ] = " - La date d'achat du mobile" // #9
sErr[ 7 ] = " - La date d'achat de l'appareil" // [PC434]
sErr[ 8 ] = " - La date de résiliation"


ilCodEtatMac = 0
ilCodEtatOpe = 0
ilCodEtat    = 0
bDejaRegleUnefois = idw_Wsin.GetItemDecimal ( 1, "MT_REG" ) > 0 
// #13
bPresenceDuneCmdeAValider = idw_LstwCommande.Find ( "COD_ETAT   = 'CNV' AND CPT_VALIDE <= 0" , 1, idw_LstwCommande.RowCount () ) > 0

This.uf_Determiner_Etat ( 1, "CALCULER", lCodEtatSin )					// COD_DEC_MAC
This.uf_Determiner_Etat ( 2, "CALCULER", lCodEtatSin )					// COD_DEC_OPE
This.uf_Determiner_Etat ( 3, "CALCULER", lCodEtatSin )					// COD_ETAT

// #13
If bPresenceDuneCmdeAValider And Not bDejaRegleUnefois Then
	bOkPourCtrl = TRUE
ElseIF lCodEtatSin = 550 Then
	bOkPourCtrl = Not bDejaRegleUnefois
Else
	bOkPourCtrl = FALSE
End If 

lNbrCol = UpperBound ( sCol )

stMessage.bErreurG	= TRUE
stMessage.sCode		= "GENE001"

/*------------------------------------------------------------------*/
/* On transforme toutes les chaines vides en NULL avant de          */
/* commencer.                                                       */
/*------------------------------------------------------------------*/
Uf_Gestion_Str2Nul ()

// #18 [DCMP080625] lecture de la marque et du modele pour le controle
sMarq 		= Trim ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) )
sModl 		= Trim ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) )

//	[20101109.FPI]
If not isNull(sModl) Then
	sModl=f_remplace(sModl,"" + CharA(9),"")
	idw_wSin.SetItem( 1, "MODL_PORT",sModl ) 
End if
//	:[20101109.FPI]

/*------------------------------------------------------------------*/
/* Le 19/01/1999.                                                   */
/* Si la zone MODIF_ADR est à (O)ui, on arme la valeur ALT_ADR à    */
/* (O)ui. La valeur MODIF_ADR est armée sur la fonction             */
/* Uf_ControlerSaisie () du UserObjet INTERLOCUTEUR. Elle est       */
/* utilisée comme une variable d'instance. La zone ALT_ADR est      */
/* stockée sur le moteur. Elle sera utilisée lors de la validation  */
/* définitive du dossier.                                           */
/*------------------------------------------------------------------*/
If	idw_wSin.GetItemString ( 1, "MODIF_ADR" ) = "O"	Then idw_wSin.SetItem ( 1, "ALT_ADR", "O" )

/*------------------------------------------------------------------*/
/* Si ALT_SSUI est positionné à OUI, il faut oblogatoirement avoir  */
/* un COD_MOT_SSUI renseigné, mais différent de 0.                  */
/*------------------------------------------------------------------*/
If	idw_wSin.GetItemString ( 1, "ALT_SSUI" ) = "O" And  &
	( idw_wSin.GetItemNumber ( 1, "COD_MOT_SSUI" ) = 0 Or IsNull ( idw_wSin.GetItemNumber ( 1, "COD_MOT_SSUI" ) ) ) Then
	sPos = "COD_MOT_SSUI"
	sText = sText + " - Le motif du sans suite" + sNouvelleLigne
End If

/*------------------------------------------------------------------*/
/* Si l'heure de survenance est positionnée mais que la date est    */
/* vide, il faut interdire la saisie.                               */
/*------------------------------------------------------------------*/
sHeure = idw_wSin.GetItemString ( 1, "HEU_SURV" )
If	IsNull ( idw_wSin.GetItemDate ( 1, "DTE_SURV_DATE" ) ) And ( sHeure <> "" Or Not IsNull ( sHeure ) ) Then
	sPos = "DTE_SURV_DATE"
	sText = sText + " - La date de survenance (Si l'heure est présente)" + sNouvelleLigne
Else
/*------------------------------------------------------------------*/
/* Dans le cas contraire, on positionne la date de survenance au    */
/* bon format.                                                      */
/*------------------------------------------------------------------*/
	If IsNull ( sHeure ) Or sHeure = "" Then
		tTime = 00:00:00
	Else
		tTime = Time ( Left ( sHeure, 2 ) + ":" + Right ( sHeure, 2 ) )
	End If
	idw_wSin.SetItem ( 1, "DTE_SURV", DateTime ( idw_wSin.GetItemDate ( 1, "DTE_SURV_DATE" ), tTime ) )
End If

/*----------------------------------------------------------------------*/
/* L'IMEI doit faire 15 chiffres s'il est saisi                         */
/*----------------------------------------------------------------------*/
/* [CRAO_LOT1.001] Retour MOA                                           */
/* Le cas "controle IMEI " doit etre cochée par défaut à la déclaration.*/
/* Si Option 75 ET que le compteur de demande est null ET que l'IMEI    */
/* est saisi.																				*/
/* est null, et que la case n'est pas cochée, on la coche					*/
/*                                                                      */
/* Ce cochage automatique, encadré dans ce code par :                   */
/* // [CRAO_LOT1.001] et // Fin [CRAO_LOT1.001]                         */
/* sera à virer sur instruction du responsable d'application lors de la */
/* mise en production d'une DCMP automatisant l'initialisation par 	   */
/* defaut d'une donnée de l'onglet "Divers" via Sherpa SCrpiting        */
/*----------------------------------------------------------------------*/

sTypeApp = Upper ( This.uf_GestOng_Divers_Trouver ( "TYPE_APP" ) )
sCraCtrlImei = Upper ( This.uf_GestOng_Divers_Trouver ( "CRA_CTRL_IMEI" ) ) // #14 [CRAO_LOT1]

If sTypeApp = "TEL" And sPos = "" And Not bAltBloc And lCodTel > 0 Then
	
	sIMEI 	   = Trim ( idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) )
	sIMEIOrigLu = Trim ( idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT", Primary!, TRUE ) )

	// [CRAO_LOT1.001]
	if bOption75 and sCraCtrlIMEI <> 'O' then 
		sCraSuiviImei = trim(Upper ( This.uf_GestOng_Divers_Trouver ( "CRA_SUIVI_IMEI" ) ) )
		sCraCptDmde =   trim(Upper ( This.uf_GestOng_Divers_Trouver ( "CRA_CPT_DMDE" ) ) )
		//#18 [DCMP080625] Cette initialisation n'est valable que si la marque/modele est saisi.
		if ( len(sCraSuiviImei ) = 0 or isnull(sCraSuiviImei) ) 						and 									&
			( long(sCraCptDmde ) = 0 or isnull(sCraCptDmde) ) 							and 									&
			Not (lnvString.of_IsEmpty(sMarq) or (lnvString.of_IsEmpty(sModl) ) ) and 	/* #18 [DCMP080625] */	&
			Not ( isnull(sIMEI) or len(sIMEI) = 0 ) then
			lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_CTRL_IMEI'", 1 , idw_wdivsin.Rowcount()+1 )
			if lRow > 0 then 
				uf_gestong_divers_majzone( "CRA_CTRL_IMEI", lRow, K_MAJZONE, 'O')
				idw_Wsin.SetItem ( 1, "ALT_EDIT", "N" ) // [PM50_CRAO]
				sCraCtrlImei = 'O'
			End If
		End If
	End If
	// Fin [CRAO_LOT1.001]

	// Validité IMEI	
	If sIMEIOrigLu <> Fill ( "0", 15 ) Or Date ( idw_wSin.GetItemDateTime ( 1, "CREE_LE") ) > 2006-02-01 Then
	// #14 [CRAO_LOT1] : Si Option 75, alors on peut saisir un IMEI vide, Mais si IMEI saisi OU
	//	si Contrôle IMEI demandé, il doit etre Ok.
		if bOption75 and sPos = ""  then
			if sCraCtrlImei = "O" then 
				bOktoMsg = Not F_IMEI ( sIMEI, sIMEICorrige )
			else
				bOktoMsg = Not F_IMEI ( sIMEI, sIMEICorrige ) and ( trim(sIMEI) <> ""  and Not isnull(sIMEI) )
			End If
		Else // Autres Options : L'IMEI doit etre non nul et valide.
			bOktoMsg = (sPos = "" And Not F_IMEI ( sIMEI, sIMEICorrige ) )
		End If
		if bOktoMsg then
			// [DT262]
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 308 )
			If lDeb > 0 Then
				If Trim ( sIMEI ) <> "" And Not IsNull ( sIMEI ) Then lDeb = 0
				// Traduction : Le contrôle du DT262 ne s'applique que sur un IMEI non saisie, vide, sinon 
				// S'il est saisi, mais non valide, le contrôle qui suit s'applique toujours.
			End If 
			
			If lDeb <= 0 Then								
				if bOption75 then
					sText = sText + " - Un n°IMEI valide (de 15 chiffres) ( Car controle IMEI Demandé )" + sNouvelleLigne
				else
					sText = sText + " - Un n°IMEI valide (de 15 chiffres)" + sNouvelleLigne
				End If
				If sPos = "" Then sPos = "NUM_IMEI_PORT"
			End If				
		End If
	End If
End If

/*------------------------------------------------------------------*/
/* #14 [CRAO_LOT1] Le N° d'appel doit être saisi si demande de ctrl */
/* IMEI																				  */
/* #16 Complèment d'entrée sur le test logique (bPresenceCmdeWeb)   */
/*------------------------------------------------------------------*/
//* #22 [20090331230441250]
/*If ( ( bOption75 and sCraCtrlImei = "O" ) Or bPresenceCmdeWeb ) And &
   sTypeApp = "TEL" And sPos = "" And Not bAltBloc And lCodTel > 0 Then */

// [MCO602_PNEU] and Not iDp385 
If sTypeApp = "TEL" And sPos = "" And Not bAltBloc And lCodTel > 0 And Not uf_Getautorisation2( 208 ) and Not ibDp385 Then
	If bOption75 Then
		If sCraCtrlImei = "O" Then
			If	IsNull ( sNumPort  ) Or sNumPort = "" Then
				// #19 [ENABLE] Utilisation de _t()
				sText = sText + " - Le n° de ligne du téléphone portable sinistré" + sNouvelleLigne
				If sPos = "" Then sPos = "NUM_PORT" 
			End IF
		End If
	Else
		If	IsNull ( sNumPort  ) Or sNumPort = "" Then
			// #19 [ENABLE] Utilisation de _t()
			sText = sText + " - Le n° de ligne du téléphone portable sinistré" + sNouvelleLigne
			If sPos = "" Then sPos = "NUM_PORT" 
		End IF
	End If
End If
/*
If ( ( bOption75 and sCraCtrlImei = "O" ) Or bPresenceCmdeWeb ) And &
   sTypeApp = "TEL" And sPos = "" And Not bAltBloc And lCodTel > 0 Then 
	
	If	IsNull ( sNumPort  ) Or sNumPort = "" Then
		// #19 [ENABLE] Utilisation de _t()
		sText = sText + _t(" - Le n° de ligne du téléphone portable sinistré") + sNouvelleLigne
		If sPos = "" Then sPos = "NUM_PORT" 
	End IF
End If
*/
//* :#22 [20090331230441250]

// #16 Test sur le format du num tel portable
// [MCO602_PNEU] and Not iDp385 
sDtePivot = "21/02/2007"
If sTypeApp = "TEL" And sPos = "" And Not bAltBloc And lCodTel > 0 And dCreele >= Date ( sDtePivot ) and Not ibDp385 Then
	sValTempo = F_Format_Num_Tel ( sNumPort, FALSE )
	If	Not IsNull ( sValTempo ) And sValTempo <> "" Then
		//[NUM_TEL_07]
		If Not IsNumber ( sValTempo ) Or ( Left ( sValTempo, 2 ) <> "06" And Left ( sValTempo, 2 ) <> "07" ) Or Len ( sValTempo ) <> 10 Then
			sText = sText + " - Un n° de ligne valide (n° du téléphone portable sinistré)" + sNouvelleLigne
			If sPos = "" Then sPos = "NUM_PORT" 
		End If				
	End If	
End If


/*------------------------------------------------------------------*/
/* Le N° série doit être saisie												  */
/*------------------------------------------------------------------*/
// [DT262]
sIMEI = Trim ( idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) )
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 308 )
If lDeb > 0 Then
	If Trim ( sIMEI ) <> "" And Not IsNull ( sIMEI ) Then lDeb = 0
	// Traduction : Le contrôle du DT262 ne s'applique que sur un IMEI non saisie, vide, sinon 
	// S'il est saisi, mais non valide, le contrôle qui suit s'applique toujours.
End If 

// [MCO602_PNEU]
If F_CLE_A_TRUE ( "MCO602_PNEU" ) Then
	F_RechDetPro ( lDeb2, lFin2, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 382 )	
Else
	lDeb2 = 0
End If

// [MCO602_PNEU]
If lDeb2 <= 0 And lDeb <= 0 And sTypeApp <> "TEL" And sTypeApp <> "" And sPos = "" And Not bAltBloc And lCodTel > 0 Then
	If	IsNull ( sIMEI  ) Or sIMEI = "" Then
		sText = sText + " - Un n° de série" + sNouvelleLigne
		If sPos = "" Then sPos = "NUM_IMEI_PORT" 
	End If
End If


/*------------------------------------------------------------------*/
/* Modification DBI le 05/10/1998                                   */
/* Il faut ouvrir les garanties qui vont être mises en jeu          */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Le 17/12/1998:                                                   */
/* Si le dossier est SANS SUITE, la saisie des garanties n'est pas  */
/* obligatoire.                                                     */
/*------------------------------------------------------------------*/
If	idw_LstGti.RowCount () = 0 And idw_wSin.GetItemString ( 1, "ALT_SSUI" ) = "N" Then
	If sPos = "" Then sPos = "ID_NATSIN"
	sText = sText + " - Les garanties mises en jeu" + sNouvelleLigne
	sOng = "02"
End If

/*------------------------------------------------------------------*/
/* Si ID_ADH est NULL et que le type d'adhésion est égal à 3 ou 4   */
/* (Méthode par carte), il faut positionner ID_CARTE et             */
/* ID_TYPE_CARTE. (Cas ou la personne supprime le contenu de la     */
/* zone et on ne déclenche pas un ItemChanged! ).                   */
/*------------------------------------------------------------------*/
sCodAdh = idw_Produit.GetItemString ( 1, "COD_ADH" )
If	IsNull ( idw_wSin.GetItemString ( 1, "ID_ADH" ) )	And ( sCodAdh = "3" Or sCodAdh = "4" )	Then
	idw_wSin.SetItem ( 1, "ID_CARTE", 0 )
	idw_wSin.SetItem ( 1, "ID_TYPE_CARTE", "00" )
End If

/*------------------------------------------------------------------*/
/* La date de survenance est obligatoire pour les produits avec     */
/* COD_ADH = 1,2,5,6.                                               */
/*------------------------------------------------------------------*/
dtDteSurv = idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )
If	( sCodAdh = "1" Or sCodAdh = "2" Or sCodAdh = "5" Or sCodAdh = "6" ) And IsNull ( dtDteSurv ) Then
	If	sPos = "" Then sPos = "DTE_SURV_DATE"
	sText = sText + " - La date de survenance" + sNouvelleLigne
End If

/*------------------------------------------------------------------*/
/* On vérifie simplement les colonnes obligatoires.                 */
/* ADR_1, ADR_CP, ADR_VILLE, ID_NATSIN, ID_DETSIN, ID_TERRIT.       */
/*------------------------------------------------------------------*/
For	lCpt = 1 To 3
	sVal[ lCpt ] = Trim ( idw_wSin.GetItemString ( 1, sCol[ lCpt ] ) )
Next

For	lCpt = 4 To 6
	sVal[ lCpt ] = String ( idw_wSin.GetItemNumber ( 1, sCol[ lCpt ] ) )
Next

/*------------------------------------------------------------------*/
/* #9: Gestion DTE_ACH_PORT obligatoire -DP, 10                     */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 10 )
If lDeb > 0 And Not ( bAltBloc ) Then
	// #13
	If bPresenceDuneCmdeAValider Or bOkPourCtrl Then
		 	sVal[ 7 ] = String ( idw_wSin.GetItemDateTime ( 1, sCol[ 7 ] ) , "dd/mm/yyyy" ) // [PI056]
	Else
		sVal[ 7 ] = "01/01/1900"
	End If
Else
	sVal[ 7 ] = "01/01/1900"
End If

sVal[ 8 ] = "01/01/1900"  // On simule, DTE_RESIL n'est pas géré à cet endroit, mais plus loin.

For	lCpt = 1 To lNbrCol
	If ( IsNull ( sVal[ lCpt ] ) or Trim ( sVal[ lCpt ] ) = ""	Or Trim ( sVal[ lCpt ] ) = "0" ) And bOkPourCtrl Then

		If sPos = "" Then sPos = sCol[ lCpt ]
		sText = sText + sErr[ lCpt ] + sNouvelleLigne

	End If
Next

/*------------------------------------------------------------------*/
/* Modification DBI du 05/10/1998                                   */
/* On traite a part le cas de l'id_adh qui ne doit pas être null    */
/* uniquement si cod_adh = 1,2,5 ou 6.                              */
/*------------------------------------------------------------------*/
sIdAdh = Trim ( idw_wSin.GetItemString ( 1, "ID_ADH" ) )

If ( IsNull ( sIdAdh ) or sIdAdh = "" )	And	&
	( sCodAdh = "1" Or sCodAdh = "2" Or sCodAdh = "5" Or sCodAdh = "6" ) Then

	If sPos = "" Then sPos = "ID_ADH"
	sText = sText + " - Le numéro d'adhésion" + sNouvelleLigne

End If

/*------------------------------------------------------------------*/
/* On va vérifier la zone MT_A_REG de chacun des interlocuteurs.    */
/* Si le montant est supérieur à zéro, la zone COD_MODE_REG est     */
/* obligatoire.                                                     */
/*------------------------------------------------------------------*/
lTotInter = idw_LstInter.RowCount ()

// [BUG_INTER]
If NOT F_CLE_A_TRUE ( "BUG_INTER" ) Then
	For	lCpt = 1	To lTotInter
			sCodModeReg = idw_LstInter.GetItemString ( lCpt, "COD_MODE_REG" )
			If	idw_LstInter.GetItemNumber ( lCpt, "MT_A_REG" ) > 0 Then
				If	IsNull ( sCodModeReg ) Or sCodModeReg = ""	Then
					If sPos = "" Then sPos = "REF_CIE"					// On se repositionne sur la zone REF_CIE
					sText = sText + " - Le mode de règlement pour l'interlocuteur " + &
								idw_LstInter.GetItemString ( lCpt, "NOM" ) + sNouvelleLigne
				End If
			End If
	Next
End IF 

/*------------------------------------------------------------------*/
/* On vérifie maintenant si les zones ID_NATSIN, ID_TERRIT,         */
/* ID_DETSIN viennent de changer pendant la saisie du               */
/* gestionnaire. Si c'est le cas on affiche un message              */
/* d'avertissement et on positionne toutes les garanties avec       */
/* ALT_VALIDE = 'O' à NON CONTROLER.                                */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Les zones ne peuvent pas être NULLES. Elles sont armées avec     */
/* des valeurs à 0 dans la création des travaux.                    */
/*------------------------------------------------------------------*/
If	sPos = "" Then
	If	sVal[ 4 ] <> String ( ilIdNatSin ) Then
		If	sPos = "" Then sPos = sCol[ 4 ]
		sText = sText + sErr[ 4 ] + sNouvelleLigne
	End If

	If	sVal[ 5 ] <> String ( ilIdDetSin ) Then
		If	sPos = "" Then sPos = sCol[ 5 ]
		sText = sText + sErr[ 5 ] + sNouvelleLigne
	End If

	If	sVal[ 6 ] <> String ( ilIdTerrit ) Then
		If	sPos = "" Then sPos = sCol[ 6 ]
		sText = sText + sErr[ 6 ] + sNouvelleLigne
	End If

	dDteVal = idw_wSin.GetItemDate ( 1, "DTE_RESIL" ) 
	If IsNull ( dDteVal ) Then dDteVal = 1900-01-01

	If	dDteVal <> idDteResil Then
		If	sPos = "" Then sPos = "DTE_RESIL" 
		sText = sText + sErr[ 8 ] + sNouvelleLigne
	End If

	If lCodTel > 0 Then
		dDteVal = Date(idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ) ) // [PI056]
		If IsNull ( dDteVal ) Then dDteVal = 1900-01-01

		If	dDteVal <> idDteAch Then
			If	sPos = "" Then sPos = "DTE_ACH_PORT" 
			sText = sText + sErr[ 7 ] + sNouvelleLigne
		End If

		dDteVal = Date(idw_wSin.GetItemDateTime ( 1, "DTE_OUVLIG_PORT" ) ) // [PI056]
		If IsNull ( dDteVal ) Then dDteVal = 1900-01-01

		If	dDteVal <> idDteOuvLig Then
			If	sPos = "" Then sPos = "DTE_OUVLIG_PORT" 
			sText = sText + " - La date d'ouverture de ligne du mobile" + sNouvelleLigne
		End If
	End If 
	/*------------------------------------------------------------------*/
	/* #15 [CRAO_LOT2] PHG 25/06/2007                                   */
	/* Deconnexion Option 19                                            */
	/* ctrl pour IMEI client à déporter sur                             */
	/* bOption75 ,suppression de la partie IMEI_ctrl                    */
	/*------------------------------------------------------------------*/
//	// #10
//	If bOption19 Then // [CRAO_LOT2.TAG] ctrl pour IMEI client à déporter sur
//							// bOption75 ,supprimer partie IMEI_ctrl
//		If	idw_Wsin.GetItemString ( 1, "REF_CIE" ) <> isIMEICtrl Then
//			If	sPos = "" Then sPos = "REF_CIE"
//			sText = sText + " - L'IMEI de controle" + sNouvelleLigne
//		End If
//
//		If	idw_Wsin.GetItemString ( 1, "NUM_IMEI_PORT" ) <> isIMEIClient Then
//			If	sPos = "" Then sPos = "NUM_IMEI_PORT"
//			sText = sText + " - L'IMEI du client" + sNouvelleLigne
//		End If
//	End If
// REMPLACE PAR :
	If bOption75 Then 
		If	idw_Wsin.GetItemString ( 1, "NUM_IMEI_PORT" ) <> isIMEIClient Then
			If	sPos = "" Then sPos = "NUM_IMEI_PORT"
			sText = sText + " - L'IMEI du client" + sNouvelleLigne
		End If
	End If

	If	sPos <> "" Then
		lTotGti = idw_LstGti.RowCount ()
		For	lCpt = 1	To lTotGti
				lCodEtat		= idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" )
				sAltValide	= idw_LstGti.GetItemString ( lCpt, "ALT_VALIDE" )

				If	lCodEtat = 100 Or lCodEtat = 500 Or lCodEtat = 550 Or &
					( lCodEtat = 200 )	Then

//					( lCodEtat = 200 And sAltValide = "O" ) // Modif JFF le 14/05/2005 à suivre.

					idw_LstGti.SetItem ( lCpt, "COD_ETAT", 0 )
					idw_LstGti.SetItem ( lCpt, "COD_DEC_MAC", 0 )
					idw_LstGti.SetItem ( lCpt, "COD_DEC_OPE", 0 )
					idw_LstGti.SetItem ( lCpt, "ALT_VALIDE", "O" )
					bModifGti	= True
				End If
		Next

		/*------------------------------------------------------------------*/
		/* #11 MADM : DCMP 050393                                           */
		/*------------------------------------------------------------------*/
		lTotDetail = idw_wDetail.RowCount ()
		For	lCpt = 1	To lTotDetail
				lCodEtat		= idw_wDetail.GetItemNumber ( lCpt, "COD_ETAT" )
				sAltValide	= idw_wDetail.GetItemString ( lCpt, "ALT_VALIDE" )
				lIdGti		= idw_wDetail.GetItemNumber ( lCpt, "ID_GTI" )
				lIdEvt		= idw_wDetail.GetItemNumber ( lCpt, "ID_EVT" )

				F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 63 ) 
				If lDeb > 0 Then	
					For lCpt2 = lDeb To lFin
						lIdGtiDetPro = idw_DetPro.GetItemNumber ( lCpt2, "ID_CODE_NUM" )
						sIdEvtDetPro = idw_DetPro.GetItemString ( lCpt2, "ID_CODE_CAR" )
						If	( lCodEtat = 100 Or lCodEtat = 500 Or ( lCodEtat = 200 And sAltValide = "O" )	) And &
							( lIdGti = lIdGtiDetPro ) And (lIdEvt = long(sIdEvtDetPro)) Then
							idw_wDetail.SetItem ( lCpt, "COD_ETAT", 0 )
							idw_wDetail.SetItem ( lCpt, "COD_DEC_MAC", 0 )
							idw_wDetail.SetItem ( lCpt, "COD_DEC_OPE", 0 )
							idw_wDetail.SetItem ( lCpt, "ALT_VALIDE", "O" )
							bModifGti	= True
						End If
					Next
				End If
		Next
		/*------------------------------------------------------------------*/
		/* #11 MADM : FIN DCMP 030362                                       */
		/*------------------------------------------------------------------*/
	End If

/*------------------------------------------------------------------*/
/* On teste la zone DTE_SURV. Cette zone est au format DateTime     */
/* et vient d'être armée dans cette fonction.                       */
/*------------------------------------------------------------------*/

	dtDteSurv = idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )

	If	idtDteSurv <> dtDteSurv	Then
		If	sPos = "" Then sPos = "DTE_SURV_DATE"
		sText = sText + " - La date de survenance" + sNouvelleLigne
	End If

	If	sPos <> "" Then
		lTotGti = idw_LstGti.RowCount ()
		For	lCpt = 1	To lTotGti
				lCodEtat		= idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" )
				sAltValide	= idw_LstGti.GetItemString ( lCpt, "ALT_VALIDE" )
				lIdGti		= idw_LstGti.GetItemNumber ( lCpt, "ID_GTI" )

/*------------------------------------------------------------------*/
/* Le 27/05/1999.                                                   */
/* Modif DGA. Gestion des UF Téléphone Mobile.                      */
/*------------------------------------------------------------------*/
				If	( lCodEtat = 100 Or lCodEtat = 500 Or lCodEtat = 550 Or ( lCodEtat = 200 And sAltValide = "O" )	) And	&
					( lIdGti = 2 Or lIdGti = 4 Or lIdGti = 7 Or lIdGti = 8 ) Then

					idw_LstGti.SetItem ( lCpt, "COD_ETAT", 0 )
					idw_LstGti.SetItem ( lCpt, "COD_DEC_MAC", 0 )
					idw_LstGti.SetItem ( lCpt, "COD_DEC_OPE", 0 )
					idw_LstGti.SetItem ( lCpt, "ALT_VALIDE", "O" )
					bModifDteSurv	= True
				End If
		Next

		lTotDetail = idw_wDetail.RowCount ()
		For	lCpt = 1	To lTotDetail
				lCodEtat		= idw_wDetail.GetItemNumber ( lCpt, "COD_ETAT" )
				sAltValide	= idw_wDetail.GetItemString ( lCpt, "ALT_VALIDE" )
				lIdGti		= idw_wDetail.GetItemNumber ( lCpt, "ID_GTI" )

/*------------------------------------------------------------------*/
/* Le 27/05/1999.                                                   */
/* Modif DGA. Gestion des UF Téléphone Mobile.                      */
/*------------------------------------------------------------------*/
				If	( lCodEtat = 100 Or lCodEtat = 500 Or ( lCodEtat = 200 And sAltValide = "O" )	) And &
					( lIdGti = 2 Or lIdGti = 4 Or lIdGti = 7 Or lIdGti = 8 ) Then

					idw_wDetail.SetItem ( lCpt, "COD_ETAT", 0 )
					idw_wDetail.SetItem ( lCpt, "COD_DEC_MAC", 0 )
					idw_wDetail.SetItem ( lCpt, "COD_DEC_OPE", 0 )
					idw_wDetail.SetItem ( lCpt, "ALT_VALIDE", "O" )
					bModifDteSurv	= True
				End If
		Next
	End If
/*------------------------------------------------------------------*/
/* Si aucune garantie n'est impactée, on n'affiche pas de message   */
/* d'erreur.                                                        */
/*------------------------------------------------------------------*/
	If	Not bModifDteSurv And Not bModifGti Then 
		sPos = ""
	Else
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN240"
	End If

/*------------------------------------------------------------------*/
/* On réarme les variables d'instances.                             */
/*------------------------------------------------------------------*/
	ilIdNatSin	= idw_wSin.GetItemNumber ( 1, "ID_NATSIN" )
	ilIdTerrit	= idw_wSin.GetItemNumber ( 1, "ID_TERRIT" )
	ilIdDetSin	= idw_wSin.GetItemNumber ( 1, "ID_DETSIN" )

	idtDteSurv = dtDteSurv

	/*------------------------------------------------------------------*/
	/* #15 [CRAO_LOT2] PHG 25/06/2007                                   */
	/* Deconnexion Option 19                                            */
	/* ctrl pour IMEI client à déporter sur                             */
	/* bOption75 ,suppression de la partie IMEI_ctrl                    */
	/*------------------------------------------------------------------*/
//	// #10
//	If bOption19 Then// [CRAO_LOT2.TAG] : ctrl pour IMEI client à déporter sur
//							// bOption75 ,supprimer partie IMEI_ctrl
//		isIMEICtrl = idw_wSin.GetItemString  ( 1, "REF_CIE" )
//		If IsNull ( isIMEICtrl ) Then isIMEICtrl = " "
//	
//		isIMEIClient = idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" )
//		If IsNull ( isIMEIClient ) Then isIMEIClient = " "
//	End If
	// REMPLACE PAR :
	If bOption75 Then
		isIMEIClient = idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" )
		If IsNull ( isIMEIClient ) Then isIMEIClient = " "
	End If

   idDteAch = Date( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ) ) // [PI056]
	If IsNull ( idDteAch ) Then idDteAch = Date ( "01/01/1900" )
	
   idDteOuvLig = Date (idw_wSin.GetItemDateTime ( 1, "DTE_OUVLIG_PORT" )) // [PI056]
	If IsNull ( idDteOuvLig ) Then  idDteOuvLig = Date ( "01/01/1900" )

   idDteResil = idw_wSin.GetItemDate ( 1, "DTE_RESIL" )
	If IsNull ( idDteResil ) Then idDteResil = Date ( "01/01/1900" )


End If

/*------------------------------------------------------------------*/
/* #1                                                               */
/*------------------------------------------------------------------*/
If sPos = "" Then
	uf_ControlerSaisie_Boutique ( 1, sText, sPos )
End If

// [PC494]
if sMarq="PAS DE MARQUE" and sPos="" Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 169 )
	If lDeb <= 0  Then
		sPos="MARQ_PORT"
		sText="La marque de l'appareil"
		stMessage.sCode="WSIN130"
		stMessage.bErreurG	= FALSE
	End if
End if
//:[PC494]

/*------------------------------------------------------------------*/
/* #3 CAG 16/06/2003                                                */
/*------------------------------------------------------------------*/
/* Si le gest n'a pas modifié la marque, vérif que celle des adh    */
/* est bien conforme à la base.												  */
/*------------------------------------------------------------------*/
/* #6 CAG 04/08/2003                                                */
/*------------------------------------------------------------------*/
If sPos = "" Then
	Choose Case isReferentielApp
		Case "IFR"
			sPosRef = "MARQ_PORT2"
			sMarq = idw_wSin.GetItemString ( 1, sPosRef )
			sFind = "MARQUE = '" + sMarq + "'"

		Case "REF_CODIC_DARTY"
			sPosRef = "MARQ_PORT3"
			sMarq = idw_wSin.GetItemString ( 1, sPosRef )
			sFind = "MARQUE = '" + sMarq + "'"

		Case Else

			// [DT386_EXTR_AXA]
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 336 )
			If lDeb > 0 Then
				sFind = "LIB_CODE = 'PAS_DE_MARQUE'" // Juste afin de trouver qqchose
			Else
				sPosRef = "MARQ_PORT"
				sMarq = idw_wSin.GetItemString ( 1, sPosRef )
				sFind = "LIB_CODE = '" + sMarq + "'"
			End If
	End Choose

	If Not IsNull ( sMarq ) And sMarq <> "" Then
		idw_wSin.GetChild ( sPosRef, dwChild )
		lRow = dwChild.Find ( sFind, 1, dwChild.RowCount () )
		If lRow <= 0 Then
			sPos 						= sPosRef
			stMessage.bErreurG	= FALSE
			sText 					= "La marque de l'appareil"
			stMessage.sCode		= "WSIN410"
		End If
	End If
End If

If sPos = "" Then
	Choose Case isReferentielApp
		Case "IFR"
			sPosRef = "MODL_PORT2"
			sMarq = idw_wSin.GetItemString ( 1, sPosRef )
			sFind = "REFERENCE = '" + sMarq + "'"

		Case "REF_CODIC_DARTY"
			sPosRef = "MODL_PORT3"
			sMarq = idw_wSin.GetItemString ( 1, sPosRef )
			sFind = "REFERENCE = '" + sMarq + "'"

		Case Else
			// Pas de controle, saisie libre
			SetNull ( sMarq )
	End Choose

	If Not IsNull ( sMarq ) And sMarq <> "" Then
		idw_wSin.GetChild ( sPosRef, dwChild )
		lRow = dwChild.Find ( sFind, 1, dwChild.RowCount () )
		If lRow <= 0 Then
			sPos 						= sPosRef
			stMessage.bErreurG	= FALSE
			sText 					= "Le modèle de l'appareil"
			stMessage.sCode		= "WSIN411"
		End If
	End If
End If

/*------------------------------------------------------------------*/
/* #4 CAG 17/06/2003                                                */
/*	#5 JFF 30/06/2003																  */
/*------------------------------------------------------------------*/
If sPos = "" Then
	sFind = "ID_FOUR = 'CEG' AND COD_ETAT = 'CNV'"
	lRow = idw_LstwCommande.Find ( sFind, 1, idw_LstwCommande.RowCount () )
	lIdProd = idw_wSin.GetItemNumber ( 1, "ID_PROD" )
	sIdContratAbonne = idw_wSin.GetItemString ( 1, "ID_CONTRAT_ABONNE" )
	If IsNull ( sIdContratAbonne ) Then sIdContratAbonne = ""

	Choose Case lIdProd 
		Case 5712, 5707
			If Len ( sIdContratAbonne ) <> 8 And lRow > 0 Then
				sPos 						= "ID_CONTRAT_ABONNE"
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN430"
			End If
	End Choose
End If

// #12
if sPos = "" and not bDejaRegleUnefois then
	if idw_wDivDet.RowCount() > 0 then
		if idw_wDivDet.Find ( "upper(NOM_ZONE) = 'PEC' AND VAL_LST_CAR = 'O'", 1, idw_wDivDet.RowCount() ) > 0 then
			bPec = true
		end if
	end if

	if idw_LstwCommande.RowCount() > 0 then
		bCmd = true
	end if 

	// Le renseignement de la nature de sinistre, du detail de sinistre 
	// et de la territorialité est obligatoire lors d'une prise en charge
	// ou lors de la presence d'une commande sur le detail
	if	bPec or bCmd then 
		// Nature de sinistre non renseigné
		if sVal[ 4 ] = '0' then
			If	sPos = "" Then sPos = sCol[ 4 ]
			sText = sText + sErr[ 4 ] + sNouvelleLigne
		end if
		// Detail de sinistre non renseigné
		if sVal[ 5 ] = '0' then
			If	sPos = "" Then sPos = sCol[ 5 ]
			sText = sText + sErr[ 5 ] + sNouvelleLigne
		end if
		// Territorialité non renseigné
		if sVal[ 6 ] = '0' then
			If	sPos = "" Then sPos = sCol[ 6 ]
			sText = sText + sErr[ 6 ] + sNouvelleLigne
		end if

		stMessage.bErreurG	= false
		stMessage.sCode		= "WSIN245"
	end if
end if
// #12 - FIN



/*------------------------------------------------------------------*/
/* Affichage de la chaîne correspondant au message d'erreur         */
/*------------------------------------------------------------------*/
If	sPos <> "" Then

	stMessage.sTitre		= "Contrôle de saisie du sinistre"
	stMessage.Icon			= Information!
	stMessage.sVar[1] 	= sText

	f_Message ( stMessage )

	If	Not IsNull ( sOng ) And iuoOng.Uf_RecupererOngletCourant () <> sOng Then
		iuoOng.Uf_ChangerOnglet ( sOng )
	End If

End If

//[PC398][Point_31]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 105 )
//: [PC398][Point_31] Ajout du lDeb > 0 dans le IF ci-dessous

//[DCMP100397] 
If lDeb> 0 And not this.uf_getautorisation2( 208) Then // [Shunte_WSIN695.role_factu]
	lRow = idw_wDivSin.find ( "UPPER ( NOM_ZONE ) = 'NUM_FACT'", 1, idw_wDivSin.RowCount () ) 
	If lRow > 0 And idw_wSin.GetItemString ( 1, "ALT_BLOC" ) <> "O" Then
	
		sValNumFact = Trim ( This.uf_GestOng_Divers_Trouver ( "NUM_FACT" ) )
		If IsNull ( sValNumFact ) Then sValNumFact = ""
		
		If Len ( sValNumFact ) <> 10 Or Not IsNumber ( sValNumFact ) Then
			stMessage.sTitre		= "Contrôle de saisie du sinistre"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= False
			stMessage.sCode = "WSIN695"
			f_Message ( stMessage )
			If sPos = "" Then sPos = "NUM_PORT" 
		End If
	End If
End if
// :[DCMP100397]

// [PC801_V10]
lRow = idw_wDivSin.Find ( "UPPER ( NOM_ZONE ) = 'FRANCHISE_PAYBOX'", 1, idw_wDivSin.Rowcount () )
If lRow > 0 And Not bAltBloc Then
	sVal1 = uf_GestOng_Divers_Trouver ( "FRANCHISE_PAYBOX" )
	If sVal1 = "O" Then
		sVal1 = uf_GestOng_Divers_Trouver ( "MODE_PAIEMENT" )
		If IsNull ( sVal1 ) Or Len ( Trim ( sVal1 ) ) = 0 Then
			stMessage.sTitre		= "Contrôle de saisie du sinistre"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= False
			stMessage.sCode = "WSIN740"
			f_Message ( stMessage )
			If sPos = "" Then sPos = "NUM_PORT"					
		End If
		
		If sVal1 = "CHQ" Then
			sVal1 = uf_GestOng_Divers_Trouver ( "REF_CHEQUE_FRANCHISE" )
			If IsNull ( sVal1 ) Or Len ( Trim ( sVal1 ) ) = 0 Then
				stMessage.sTitre		= "Contrôle de saisie du sinistre"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= False
				stMessage.sCode = "WSIN738"
				f_Message ( stMessage )
				If sPos = "" Then sPos = "NUM_PORT"					
			End If
		End If
		
	End If 
End If
// [PC801_V10]
		
// [PC13279_MOBILEO]
lRow = idw_wdivsin.Find("nom_zone='typapp_arec_aneu'", 1 , idw_wdivsin.Rowcount()+1 )
If lRow > 0 Then
	sVal1 = This.uf_GestOng_Divers_Trouver ( "TYPAPP_AREC_ANEU" )				
	If Trim ( sVal1 ) = "" Or IsNull ( sVal1 ) Then
		stMessage.sTitre		= "Contrôle de saisie du sinistre"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= False
		stMessage.sCode = "WSIN764"
		f_Message ( stMessage )
		If sPos = "" Then sPos = "ALT_BLOC"					
	End If 
End If	
// [PC13279_MOBILEO]

		

////// CODER AU DESSUS DE CETTE LIGNE SI SPOS INITIALISE ......		
		
astPass.sTab [ 1 ] = sPos

/*------------------------------------------------------------------*/
/* DCMP000055 : Le 17/02/2000 JFF                                   */
/* Insertion d'un controle de saisie sur le message lié au sinistre */
/* pour certain produit. Dérénavant, pour certain produit, il       */
/* faudrra saisir dans la zone message, un commentaire contenant    */
/* au moins la chaine "TC:".                                        */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On récupère la liste des produits concernés dans le fichier Ini  */
/* + Le produit en cours sur le sinistre.                           */
/*------------------------------------------------------------------*/
sTC     = Trim ( ProfileString ( stGlb.sFichierIni, "VERIF_TC","PRODUIT","" ) )
lIdProd = idw_wSin.GetItemNumber ( 1, "ID_PROD" )

// Si au moins un produit est concerné alors...
If sTC <> "" Then
	
	sTC += ","
	iTC  = 1

	// Tant qu'une virgule sera trouvé...
	Do While iTC > 0

		iTC = Pos ( sTC, "," )
		If iTC > 0 Then

			// Si le découpage du produit de la chaine
			// correspond au produit en cours...
			If Long ( Left ( sTC, iTC - 1 ) ) = lIdProd Then

				// On vérifie alors que le message contient la
				// chaine "TC:"
				sTC = idw_wSin.GetItemString ( 1, "TXT_MESS" ) 
				iTc = 0
				If Len ( sTc ) > 0 And Not IsNull ( sTC ) Then 
					iTC = Pos ( sTC, "TC:" )
					If iTC <= 0 Then iTC = Pos ( sTC, "TC :" )
				End If

				// Si la chaine "TC:" n'est pas trouvé, on affichera 
				// un message et on sort de la boucle (iTC=0)
				If iTC <= 0 Then 
					iTC   = 0	
					stMessage.sTitre		= "Contrôle de saisie du sinistre"
					stMessage.Icon			= Information!
					stMessage.bErreurG	= False
					stMessage.sCode		= "WSIN340"
					f_Message ( stMessage )

				End If
					
			Else
				// On découpe ce qui se trouve devant la prémière
				// virgule trouvée à chaque tours.
				sTC = Mid ( sTC, iTc + 1, Len ( sTC ) )
			End If

		End If
	Loop

End If

/*------------------------------------------------------------------*/
/* #2 JFF le 11/04/2003                                             */
/*------------------------------------------------------------------*/

sValFinale = idw_wSin.GetItemString ( 1, "TXT_MESS" )
For lCptQT1 = 1 To 6 // #22 : 5 ald 2
	iCptQT 	= 1
	iPosQT	= 1

	Choose Case lCptQT1
		Case 	1
			sValQuote = Char ( 34 ) // "
		Case  2
			sValQuote = Char ( 39 ) // '
		// # 22 - [20100203.FPI] Epuration du message
		Case 3 
			sValQuote = Char ( 9 ) // TAB
		Case 4 
			sValQuote = Char ( 10 ) // LF
		Case 5 
			sValQuote = Char ( 13 ) // CR
		// 	[20100625.FPI]
		Case 6 
			sValQuote = Char ( 11 ) // LF
		
	End Choose 

	Do While iPosQT > 0

		iPosQT = Pos ( sValFinale, sValQuote , iPosQT )
		If  iPosQT > 0 Then
			sValFinale = Replace ( sValFinale, iPosQT, 1, " " )
			iPosQT += 1
		Else
			Exit
		End If
	Loop
Next
idw_wSin.SetItem ( 1, "TXT_MESS", sValFinale )

// [PM50_CRAO]
If This.uf_GestOng_Divers_Trouver( "CRA_CTRL_IMEI" ) = "O" And & 
	idw_Wsin.GetItemString ( 1, "ALT_EDIT" ) = "N" Then
	idw_LstInter.SetItem ( idw_LstInter.Find ( "COD_INTER = 'A'", 1 , idw_LstInter.RowCount () ), "ALT_COURGEST", "N") 
End If
// :[PM50_CRAO]



/*------------------------------------------------------------------*/
/* FIN #2 																		     */
/*------------------------------------------------------------------*/


/*-------------------------------------------------------------------*/
/* DCMP020260 : Le 07/07/2002 CAG                                    */
/* Insertion d'un message d'information pour le produit 13400 sur    */
/* certains id_carte																   */
/* fait aussi à l'affichage de la fenêtre (dans uf_preparermodifier) */
/*-------------------------------------------------------------------*/
/* DCMP 020397 : le 03/12/2002 CAG                                   */
/* Modifications par rapport à la DCMP précédente : message         */
/* différent en fonction de l'id_groupe                             */
/*------------------------------------------------------------------*/
/* DMDI 8667 : le 03/02/2003 CAG                                    */
/*             retrait du msg pour les caisses de l'Orne				  */
/*------------------------------------------------------------------*/
lIdCarte  = idw_wSin.GetItemNumber ( 1, "ID_CARTE" )

If Not IsNull ( lIdCarte ) Then
	sFUSION_Aqu   	= Trim ( ProfileString ( stGlb.sFichierIni, "13400_FUSION_AQUITAINE","ID_CARTE","" ) )

	For lCpt = 1 To 1

		Choose Case lCpt
			Case 1
				sFUSION = sFUSION_Aqu

		End Choose

		// Si au moins un id_carte est concerné alors...
		If sFUSION <> "" Then

			sFUSION += ","
			iFUSION = 1

			// Tant qu'une virgule sera trouvé...
			Do While iFUSION > 0

				iFUSION = Pos ( sFUSION, "," )
				If iFUSION > 0 Then

					iFUSIONSLASH	= Pos ( sFUSION, "/" )
					lFUSIONProd = Long ( Left ( sFUSION, iFUSIONSLASH - 1 ) )
					lFUSIONIdCarte  = Long ( Mid  ( sFUSION, iFUSIONSLASH + 1, iFUSION - iFUSIONSLASH - 1 ) )

					// Si le découpage de la caisse contenue dans la chaine
					// correspond au produit et à la caisse en cours...
					If lFUSIONProd = lIdProd and lFUSIONIdCarte = lIdCarte Then

						iFUSION = 0

						sFUSION = Space ( 35 )

						// "Vérifier adhésion au contrat"
						stMessage.sTitre		= "Contrôle de saisie du sinistre"
						stMessage.Icon			= Information!
						stMessage.bErreurG	= False
						stMessage.sCode = "WSIN390"
						f_Message ( stMessage )

					Else
						// On découpe ce qui se trouve devant la première
						// virgule trouvée à chaque tour.
						sFUSION = Mid ( sFUSION, iFUSION + 1, Len ( sFUSION ) )
					End If

				End If
			Loop

		End If

	Next
End If


end subroutine

private subroutine uf_zn_altbloc ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_AltBloc (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 08/01/1998 17:14:39
//* Libellé			: 
//* Commentaires	: Controle de ALT_BLOC
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

/*------------------------------------------------------------------*/
/* On vient de bloquer le dossier, on passe le COD_ETAT à 1.        */
/*------------------------------------------------------------------*/
If	idw_wSin.GetText () = "O" Then
	idw_wSin.SetItem ( 1, "COD_ETAT", 1 )
	idw_wSin.SetItem ( 1, "COD_DEC_MAC", 1 )
	idw_wSin.SetItem ( 1, "COD_DEC_OPE", 1 )
Else
/*------------------------------------------------------------------*/
/* On vient de débloquer le dossier, on positionne le COD_ETAT à 0  */
/* (Non controlé). Il sera armé lors du contrôle de                 */
/* gestion.(Normalement!!).                                         */
/*------------------------------------------------------------------*/
	idw_wSin.SetItem ( 1, "COD_ETAT", 0 )
	idw_wSin.SetItem ( 1, "COD_DEC_MAC", 0 )
	idw_wSin.SetItem ( 1, "COD_DEC_OPE", 0 )
End If


end subroutine

private subroutine uf_controlergestion (ref s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_ControlerGestion (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 10:49:34
//* Libellé			: 
//* Commentaires	: Contrôle de gestion du sinistre
//*
//* Arguments		: s_Pass			astPass			(Réf) Structure de passage
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ 			PAR		Date		  Modification
//* #1			CAG   	16/06/2003 Modification de la marque portable en dddw
//* #2			JFF		03/03/2004 DCMP 040098 : Modification pour ORANGE Marketing.
//* #3			JFF		12/03/2004 DCMP 
//* #4			JFF		16/07/2004 DCMP 040192 : Gestion zone Type_Prestation sur onglet divers.
//* #5			CAG		11/08/2004 DCMP 040353 : Validation d'un dr Darty impossible si pas de cmde.
//* #6			JFF/DGA  06/04/2006 Migration PB8-SPB-04/2006
//* #7			JFF	   07/04/2006 Migration PB8-SPB-04/2006 - suppression du sPos
//* #8			JFF      07/04/2006 Migration PB8-SPB-04/2006 
//* #9         MADM     31/07/2006 Projet DNTMAIL1/2 Mails sortant en remplacement des courriers
//* #10			JCA		05/09/2006 DCMP 60574 - Ajout de nouvelle nature de document
//* #11			JCA		26/09/2006 DCMP 60651
//* #12			JCA		30/11/2006 Optimisation parametrage
//* #13			PHG		03/01/2007 [CRAO_LOT1] Gestion Cr. Activité IMEI.
//* #14			PHG		25/01/2007 [CRAO_LOT2] DEconnexion Option 19 et report controle option 19 sur option 75
//* #15			JFF	   06/02/2007 [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
//* #16			JFF	   05/04/2007 [SITE_CMDE] Si Regl sur une GTI et CWE sur même GT => Blocage
//* #17			JFF		08/06/2007 [DCMP070393] Correction suite mise en production site de commande
//* #18			JFF		12/07/2007 Problème sur le critère de 3 dossiers, je ramène à 1.
//* #19			JCA		24/07/2007	DCMP 070500 - 
//* #20			JFF		29/08/2007	[DCMP070587] - Charte souplesse SFR
//* #21			PHG		09/09/2008  [DCMP080625] Désactivtion Controle
//*											Marque/modele obligatoire.
//* #22        JFF      05/09/2008  [MICROMANIA]
//* #23			FPI		20/05/2009	[DCMP090254]
//* #24			FPI		12/10/2009	[DCMP090616] Zone dos_suivi_par obligatoire
//* #25			JFF		27/10/2009	[FNAC_PROD_ECH_TECH].[BGE].[20091027112156767]
//					FPI		11/10/2010	[FPI.11102010] Epuration des zones marque & modèle 
//             JFF      13/10/2010  [PC106_ECONOCOM]
//             JFF      19/10/2010  [PM01].[LOT3&4]
//					JFF      24/01/2011  [ITSM_MARYSE]
//					JFF		02/02/2011  [Vdoc2985] et c'est le jour de la marmotte ! ;-)
//				   FPI		14/09/2011	[ITSM92321] 
//					FPI	13/12/2011	[VDoc6141] Num port oblig. si adh facultative (dp 203)
//			FPI	23/01/2012	[20120123.FPI] Interdiction d'avoir une date de surv > date de decl
//			FPI	16/02/2012	[20120216.FPI.2] Interdiction d'avoir une date de surv > date de decl uniquement si en instruction ou à régler
//       JFF   23/05/2012 [PM103][1]
//       JFF   30/10/2012 [VDOC8607]
//		FPI	27/11/2012	[VDoc9391]
//    JFF   15/01/2012  [AJOUT_CTRLE_FNAC]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//		FPI	14/08/2013	[DT058]
//		FPI	09/09/2013 [PC954] - pour le Carrefour Casse Vol, le contrôle du PM01 ne s'applique pas à la garantie 11
//       JFF   13/11/2013 [PC13371_72]
//		FPI	06/01/2014	[VDOC13226]
//       JFF   12/12/2013 [PC947&977]
//       JFF   30/01/2014 [VDOC13534]
//       JFF   05/02/2014 [VDOC12845]
//       JFF   18/03/2014 [PC13279_MOBILEO]
//       JFF   07/05/2013 [DT081_EVOL_PRET_BRIS]
//       JFF   12/06/2014 [PI052]
//       JFF   30/07/2014 [PM234-4_V1]
//       JFF   29/09/2014 [DT081-1_CREDIMM]
//       JFF   25/03/2015 [VDOC17204]
//       JFF   31/03/2015 [DT081-4]
//       JFF   03/04/2015 [ITSM282998]
//       JFF   07/04/2015 [PC13442-1]
//		FPI	14/04/2015	[VDoc17304]
//       JFF   09/04/2015 [DT141]
//			JFF   18/06/2015 [VDOC17959]
//			JFF   05/08/2015 [VDOC18276]
//			FPI	21/09/2015	[ITSM325581]
//       JFF   12/10/2015 [PC694-4]
//       JFF   15/12/2015 [DT191]
//       JFF   23/02/2016 [PM330-1]
//       JFF   04/03/2016 [AUDIT_ASSUREUR_ELSA]
//       JFF   06/04/2016 [ITSM374196]
//       JFF   10/05/2016 [381551_ITSM]
//       JFF   16/06/2016 [PM330-1_MODIF]
// 		FPI	21/10/2016 [PI056] dte_ach_port en datetime
//			JFF   30/11/2016 [ITSM430191] 
//			JFF   12/04/2017 [ITSM456410] 
//       JFF   01/08/2017 [DT288-1][MODIF_CHRISTINE]
//       JFF   31/10/2017 [DT330]
//		   FPI	27/03/2018	[DT339]
//       JFF   17/04/2018 [DT288-4]
//	      JFF   26/09/2018 [VDOC26840]
//       JFF   01/10/2018 [PM445-1]
//       JFF   26/11/2018 [PC874_2_V1]
//       JFF   06/12/2018 [DTE_SURV_<=_TODAY]
//       JFF   07/08/2019 [PM462-1][V3]
//       JFF   13/12/2019 [VDOC28734]
//       JFF   26/11/2019 [PC192290]
//       JFF   10/03/2020 [DT458]
//       JFF   07/03/2020 [VDOC29545]
//       JFF   31/05/2021 [EPUR_MODL]
//       JFF   02/06/2021 [RS_409_BLOC_WTE532]
//		   JFF   16/06/2021 [ID_ETS_A_0] 
//       JFF   22/10/2021 [RS1216]
//* 		JFF   29/03/2022 [CTRLE_CARMA] Ajout Contrôle
//       JFF   11/05/2022 [RS2980_IFR]
//       JFF   22/02/2023 [RS4665_INT_REF_PCE]
//       JFF   14/03/2023 [RS4746_DBLE_BQE_ASS]
//       JFF   30/05/2023 [PMO89_RS4822]
//       JFF   04/09/2023 [RS5656_MOD_PCE_DIF]
//       JFF   04/12/2023 [RS6217_PARA_AUTO]
//       JFF   07/03/2024 [HP252_276_HUB_PRESTA]
//       JFF   19/12/2024 [MIG1_COUR_EMAILING]
//       JFF   22/02/2025 [TRT_APRES_COMMIT][PMO268_MIG48]
//       JFF   31/03/2025 [MON374]
//       JFF   07/05/2013 [MIG19_PSPLAF_SAGA2]
//       JFF   22/07/2025 [MIG165_BOUYGUES]
//*-----------------------------------------------------------------
Long lTotCourrier, lCodEtat, lNbContact, lNbNat, lCptCTact, llig, lCpt, lVal1, lVal2, lVal3, lVal4, lIdOrianBout, lVal5, lVal6 
Long lCptDetail, lTotDetail, lTotCmd, lDeb, lFin, lCptRegFrn, lCodeEtat, lRow, lVal, lIdGti, lIdInter, lRowAss, lTot, lIdDetail 
Long lVal31, lVal21, lIdI, lRow1, lRowIdEvtPce
String 		sPos, sOng, sDosSuiviPar, sRech, sModl, sMarq, sNull, sVal, sBIN, sTypApp, sMail, sIdCour, sMess, sCraSuiviImei 
String		sDataInter[]   
Integer iRet, iDroitInter[]	
Boolean		bRetContact, bAltEdit, bVal, bAuMoinUnCourrier, bBloque, bMessage
DataWindowChild	ddwcNatMsg, dwChild
Date		dDteOuvLigPort, dDteAchPort, dDte
s_Pass	nvTrtAttribGenCour  // #6
s_Pass	stPassData1 // [VDOC12845]
long		lCraCptDmde  // #13 [CRAO_LOT1]
string	sCraCtrlImei // #13 [CRAO_LOT1]
n_cst_string	lnvString // #21 [DCMP080625]
string	sNumPort, sNumImeiPort // #21 [DCMP080625]
Long		lMtreg, lTotPce, lCptPce, lDeb396 
String	sIdAdh, sAltBloc, sVal1, sVal2, sVal3, sCodAdh, sChainePce, sEtatPce
Long lTotInter, lCptInter, lCptDetPro
String sMtFraisAjoute, sAdrMail 
boolean bBlocageGeoloc
Int iIdPce, iIdGtiPce, iIdDetailPce
boolean bLock, bOkIdEts, bOk // #19
Long 		lIdProd, lIdAdh 	// #24
Decimal dcIdSDos
Datetime  dteSurv // [20120123.FPI]
Date dteDecl, dDteSurv, dDteRel 
Decimal {2} dcMtCmde, dcMtARegSin, dcMtARegFrais
String sImei //[VDoc9391]
Boolean bCarrefourCasseVolGti11
Long lLigDiagO2M, lLigCAF
n_cst_attrib_key lnvKey[] // #26  [O2M_DIAG_NOMADE].Lot2
s_Pass	nvTrtAttrib
s_Pass  TabVariable [] // [PI052]
string  TabCodeVar[]  // [PI052]
String  sMessErr // [VDOC17700]
String sMarqApp, sModlApp
Decimal {2} dcPrixPublicIFR, dcPrixPublicDS
DateTime dtCreeLeDos, dtDtePivotDT288-1_LOT2
DateTime dtVal 
Boolean bEnvoyer, bResil, bFin
Long lCptRefus, lTotRefus, lIdMotif, lIdNatSin
String sLibMemoire, sValCtrle, sModeFctDp345
Integer iCodResilAdh, iIdEvtPce 
Boolean 	bDdePceUFAssure, bRefUFAssure, bRegUFAssure 
n_cst_string lnvPFCString
String sCodModeReg, sText

stMessage.sTitre		= "Conrôle de saisie du sinistre"
stMessage.Icon			= Information!
sPos						= ""
sOng						= "01"
bMessage					= True

bOkIdEts=TRUE 			// [ITSM92321]
bRetcontact = FALSE
ibAltCourrier = FALSE
bAltEdit = idw_Wsin.GetItemString ( 1, "ALT_EDIT" ) = "O"
bBloque = idw_wSin.GetItemString ( 1, "ALT_BLOC" ) = "O" 
sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" ) // [PM01].[LOT3&4]
dtCreeLeDos = idw_WSin.GetItemDateTime ( 1, "CREE_LE")
sMarq = Trim ( Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) )
sModl = Trim ( Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) )
bEnvoyer=FALSE // [DT424]
sValCtrle = "N"

// [EPUR_MODL]
// [FPI.11102010] 
If sPos="" Then
	sModl=idw_wsin.GetItemString( 1, "MODL_PORT")
	sMarq=idw_wsin.GetItemString( 1, "MARQ_PORT")
	sImei=idw_wsin.GetItemString( 1, "NUM_IMEI_PORT") //[VDoc9391]
	
	sModl = uf_epurezone( sModl)
	sMarq = uf_epurezone( sMarq)
	sImei = uf_epurezone( sImei) //[VDoc9391]

	idw_wsin.SetItem( 1,"MODL_PORT", sModl)
	idw_wsin.SetItem( 1,"MARQ_PORT", sMarq)
	idw_wsin.SetItem( 1,"NUM_IMEI_PORT", sImei) //[VDoc9391]
End if
// :[FPI.11102010] 

// [PC874_2_V1]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 218)
If lDeb > 0 Then
	dtVal = DateTime ( lnvString.of_getkeyvalue(idw_DetPro.GetItemString(lDeb,"VAL_CAR" ), "DTE_PIVOT_PC874_2", ";") )

	If dtCreeLeDos >= dtVal Then
		lVal = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_CONTROLER_IMEI' AND COD_ETAT NOT IN ( 'CNV', 'ECT')", 1, idw_LstwCommande.RowCount() )
		lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_CONTROLER_IMEI'", 1, idw_LstwCommande.RowCount() )			
		IF lVal > 0 Or lVal1 <= 0 Then
			lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_CTRL_IMEI'", 1 , idw_wdivsin.Rowcount()+1 )
			This.uf_gestong_divers_majzone( "CRA_CTRL_IMEI", lRow, K_MAJZONE, 'N')
		End If 				
	End If 
End If 

// [DT141]
If Not bBloque And sPos = "" Then	
	sPos = This.uf_ControlerGestion_AjoutParaAuto ()
End If

// [CONFO][MEUBLE][PC542]
//  [CONFO][NV_PROCESS]
If Not bBloque  Then
	lVal1 = idw_LstwCommande.find("ID_FOUR = 'CFM' AND ID_TYP_ART = 'CAF'",1,  idw_LstwCommande.rowCount()+1 )	
	lVal2 = idw_wDetail.Find ( "ID_GTI = 51 AND ID_EVT = 934 AND COD_ETAT = 500 AND ID_I_REG >= 0",1,  idw_wDetail.rowCount()+1 )
	lVal3 = idw_LstGti.Find ( "ID_GTI = 51",1, idw_LstGti.rowCount()+1 )
	lVal4 = idw_wDetail.Find ( "ID_GTI <> 51 AND ID_EVT <> 934 AND COD_ETAT = 500 AND ID_I_REG >= 0",1,  idw_wDetail.rowCount()+1 )

	sMtFraisAjoute = lnvString.of_getkeyvalue (idw_LstwCommande.GetItemString ( lVal1, "INFO_SPB_FRN_CPLT" ), "MT_FRAIS_AJOUTE", ";")


	If lVal1 > 0 And lVal2 > 0 And sMtFraisAjoute <> "OUI" Then
		stMessage.sTitre  	= "Controle de gestion des commandes"
		stMessage.Icon			= Question!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= YESNO!
		stMessage.sCode = "COMD717"		
	
		If F_Message ( stMessage ) = 1 Then

			If lVal4 > 0 Then
				stMessage.sTitre  	= "Controle de gestion des commandes"
				stMessage.Icon			= Question!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= Ok!
				stMessage.sCode = "COMD718"		
				sPos	= "ALT_BLOC"
				F_Message ( stMessage )
			Else
				lRow = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.Rowcount () )
				idw_LstInter.SetItem ( lRow, "COD_MODE_REG", "BX" )
				
				dcMtCmde = idw_LstwCommande.GetItemDecimal ( lVal1, "MT_TTC_CMDE" ) + idw_LstGti.GetItemDecimal ( lVal3, "MT_PLAF_AREG" ) 
				idw_LstwCommande.SetItem ( lVal1, "MT_TTC_CMDE", dcMtCmde	)

				lnvString.of_Setkeyvalue ( sMtFraisAjoute, "MT_FRAIS_AJOUTE", "OUI", ";")
				idw_LstwCommande.SetItem ( lVal1, "INFO_SPB_FRN_CPLT", sMtFraisAjoute	)
				
				
			End If
		Else
				lRow = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.Rowcount () )
				IF idw_LstInter.GetItemString ( lRow, "COD_MODE_REG" ) = "BX" Then
					idw_LstInter.SetItem ( lRow, "COD_MODE_REG", stNul.str )
				End If
		End If
	End If
ENd IF	

// [PC694-4]  // [PC151425]
If Not bBloque And sPos = "" Then
	sPos = This.uf_ControlerGestion_Cplt_Adh_PayBox ( "CONTROLE" )
End If

// [DT346]
If Not bBloque And sPos = "" Then
	If Not This.uf_ControlerGestion_OrangeParnasse ( "CTRLE_GES" ) Then sPos = "ALT_BLOC"
End If 

/*------------------------------------------------------------------*/
/* Le gestionnaire peut faire un premier CTRL (Sans blocage), cela  */
/* à pour effet de créér des lignes dans W_COURRIER, puis elle      */
/* fait CTRL (Avec blocage cette fois la) et un UPDATE va partir    */
/* sur W_COURRIER ce qui est anormal. Il faut donc faire un RESET   */
/* sur la DW maintenant.                                            */
/*------------------------------------------------------------------*/
idw_wCourrier.Reset ()

/*------------------------------------------------------------------*/
/* Le dossier n'est pas bloqué ?.                                   */
/*------------------------------------------------------------------*/
If	Not bBloque Then
/*------------------------------------------------------------------*/
/* On doit saisir au moins un interlocuteur.                        */
/*------------------------------------------------------------------*/
	If	idw_LstInter.RowCount () = 0 Then
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN110"
		sPos	= "ADR_1"
		sOng	= "03"
	Else

/*------------------------------------------------------------------*/
/* Modification DBI le 18/08/1998                                   */
/*                                                                  */
/* Gestion du code Etat sur modèle de la garantie                   */
/*------------------------------------------------------------------*/

		If	sPos = ""	Then
/*------------------------------------------------------------------*/
/* On détermine le code état du sinistre.                           */
/*------------------------------------------------------------------*/
			Uf_Determiner_Etat ( 1, "ECRIRE", lVal )					// COD_DEC_MAC
			Uf_Determiner_Etat ( 2, "ECRIRE", lVal )					// COD_DEC_OPE
			sPos = Uf_Determiner_Etat ( 3, "ECRIRE", lVal )			// COD_ETAT
		End If

/*------------------------------------------------------------------*/
/* #4 :                                                             */
/*------------------------------------------------------------------*/
		If sPos = "" Then
			sPos = This.uf_ControlerGestion_OngletDivers ( sOng )
			If sPos <> "" Then iUoOng.Uf_ChangerOnglet ( SOng )	
		End If

/*------------------------------------------------------------------*/
/* Modification DBI le 18/08/1998                                   */
/*                                                                  */
/* Calcul du montant à régler par interlocuteur                     */
/* NB : doit être fait avant calcul du code courrier                */
/*------------------------------------------------------------------*/
		If sPos = "" Then
			sPos	=	Uf_Calcul_Montant_Inter ( )
		End If
	
		// [BUG_INTER]
		If F_CLE_A_TRUE ( "BUG_INTER" ) Then
			If Not bBloque And sPos = "" Then
				For	lCpt = 1	To lTotInter
						sCodModeReg = idw_LstInter.GetItemString ( lCpt, "COD_MODE_REG" )
						If	idw_LstInter.GetItemNumber ( lCpt, "MT_A_REG" ) > 0 Then
							If	IsNull ( sCodModeReg ) Or sCodModeReg = ""	Then
								If sPos = "" Then sPos = "REF_CIE"					// On se repositionne sur la zone REF_CIE
								sText = " - Le mode de règlement pour l'interlocuteur " + idw_LstInter.GetItemString ( lCpt, "NOM" )
											
								stMessage.sTitre		= "Contrôle de saisie"
								stMessage.Icon			= Information!
								stMessage.bErreurG	= FALSE
								stMessage.Bouton		= OK!
								stMessage.sCode		= "GENE001"
								stMessage.sVar[1]		= sText
								F_Message ( stMessage )
								sPos	= "ALT_BLOC"
								Exit

							End If
						End If
				Next
			End IF 
		End IF	
	
	
/*------------------------------------------------------------------*/
/* [DCMP070914].001 Verification paramétrage protocole AIG          */
/*------------------------------------------------------------------*/
		If sPos = "" Then
			sPos =  uf_controler_param_AIG()
		End If

		// [RS4746_DBLE_BQE_ASS]
		/*
		If F_CLE_A_TRUE ( "RS4746_DBLE_BQE_ASS" ) Then
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 363)
			If lDeb > 0 Then
				lRow = idw_LstInter.Find ( "COD_INTER = 'B'", 1, idw_LstInter.Rowcount () )
				lRow1 = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.Rowcount () )
				
				lIdInter = idw_LstInter.GetItemNumber ( lRow1, "ID_I" )
				
				bDdePceUFAssure = idw_wPiece.Find ( "ID_GTI = 7 AND ID_I = " + String ( lIdInter ), 1, idw_wPiece.RowCOunt()) > 0 
				bRefUFAssure = idw_wRefus.Find ( "ID_GTI = 7 AND ID_I = " + String ( lIdInter ), 1, idw_wRefus.RowCOunt()) > 0 
				bRegUFAssure = idw_wDetail.Find ( "ID_GTI = 7 AND ID_I_REG = " + String ( lIdInter )+ " AND COD_ETAT = 500", 1, idw_wDetail.RowCOunt()) > 0 
				
				If lRow > 0 and lRow1 > 0 Then 
					If bDdePceUFAssure Or bRefUFAssure Or bRegUFAssure Then
						idw_LstInter.SetItem ( lRow, "ALT_COURGEST", "D" )						
						idw_LstInter.SetItem ( lRow, "ID_I_DB", lIdInter )
					Else	
						sVal = idw_LstInter.GetItemString ( lRow, "ALT_COURGEST" )
						If sVal = "D" Then
							idw_LstInter.SetItem ( lRow, "ALT_COURGEST", "N" )						
							idw_LstInter.SetItem ( lRow, "ID_I_DB", stNul.inum )
						End If 
					End If 
				End If 
			End IF 
		End If
	  */


/*------------------------------------------------------------------*/
/* Le dossier n'est pas bloqué, il existe au moins un               */
/* interlocuteur, on va déterminer le code courrier.                */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* !!. Si on bloque le dossier, on ne positionne pas les zones      */
/* ID_NAT_COUR et ID_COUR de chacun des interlocuteurs à NULL.      */
/*------------------------------------------------------------------*/
		If sPos = "" And bAltEdit Then sPos = Uf_Determiner_Courrier ( iDroitInter )

/*------------------------------------------------------------------*/
/* On s'occupe maintenant de la composition, si la détermination    */
/* du code courrier marche bien.                                    */
/*------------------------------------------------------------------*/
		If	sPos = "" And bAltEdit Then sPos = Uf_Determiner_Composition ()

/*------------------------------------------------------------------*/
/* #5 CAG 11/08/2004 : si dr Darty et courrier WDE001 il faut au    */
/* moins 3 mobiles cmdés                                            */
/*------------------------------------------------------------------*/
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 11 )
		If lDeb > 0 Then
			idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV' AND ID_TYP_ART = 'TEL'" )
			idw_LstwCommande.Filter ()
			lLig = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.RowCount () )

			// #18 <1 ald <3
			If idw_LstwCommande.RowCount () < 1 And idw_LstInter.GetItemString ( lLig, "ID_COUR" ) = "WDE001" Then
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "COMD076"
				sPos = "ALT_BLOC"
			End If

			idw_LstwCommande.SetFilter ( "" )
			idw_LstwCommande.Filter ()
		End If
		
		// [VDoc17304]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 276 )
		If lDeb > 0 Then
		
			sVal=idw_DetPro.GetItemString(lDeb,"VAL_CAR")
			sVal=lnvString.Of_getkeyvalue( sVal, "ID_COUR", ";")
			
			For lLig=1 to idw_LstInter.RowCount()
				sVal1 = idw_LstInter.GetItemString ( lLig, "COD_MODE_REG")
				If Pos(sVal, "#" + idw_LstInter.GetItemString ( lLig, "ID_COUR" ) + "#") > 0 And &
					Not ( idw_LstInter.GetItemDecimal( lLig, "MT_A_REG") > 0 And Left(sVal1,1) = "V" ) Then
					
					stMessage.bErreurG	= FALSE
					stMessage.sCode		= "WSIN787" 
					stMessage.svar[1] = idw_LstInter.GetItemString ( lLig, "ID_COUR" ) 
					sPos = "ALT_BLOC"
				End If
			Next
		End If
		// :[VDoc17304]
		
		// [ITSM92321]
		sCodAdh=idw_produit.GetItemString( 1, "COD_ADH")
			
		If sPos = "" And Not bBloque and sCodAdh<>"3"  Then
			idw_wsin.getchild( "ID_ETS", dwChild)
			lRow=dwChild.Find( "ID_ETS=" + String(idw_wsin.GetItemNumber(1,"ID_ETS")) , 1, dwChild.RowCount())
			If lRow <= 0 Then
				bOkIdEts=FALSE
				
				lCpt=idw_wrefus.Find("(ALT_MAC='O'  And not isNull(ID_I)) or ALT_OPE='O'",1,idw_wrefus.RowCount())
				bOk=(lCpt <=0)
				
				bOk= bOk And (idw_wpiece.RowCount()=0)
			
				lCpt=idw_lstwcommande.Find("COD_ETAT='CNV'",1,idw_lstwcommande.RowCount())
				bOk=bOk And (lCpt <=0)
				
				bOk=bOk And (idw_wsin.GetItemNumber(1,"COD_ETAT") = 900)
				
				If Not bOk Then
					stMessage.berreurg=FALSE
					stMessage.icon=Information!
					stMessage.stitre="Gestion des sinistres - SIMPA2"
					stMessage.scode ="WSIN710"
					sPos = "ALT_BLOC"
				End if	
				
				// On décoche l'édition
				bAltEdit=FALSE
				idw_Wsin.SetItem ( 1, "ALT_EDIT" ,"N")
			End if
		End if
		//: [ITSM92321]

		// [ID_ETS_A_0] 
		If sPos = "" And Not bBloque and sCodAdh = "3"  Then
				If idw_WSin.GetItemNumber ( 1, "ID_ETS" ) = 0 And idw_WSin.GetItemDecimal ( 1, "MT_A_REG" ) > 0 Then
					stMessage.berreurg=FALSE
					stMessage.bouton=Ok!
					stMessage.icon=Information!
					stMessage.stitre="Gestion des sinistres - SIMPA2"
					stMessage.scode ="WSIN872"
					sPos = "ALT_BLOC"
				End If 
		End If 

		//[VDOC29545]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 350)
		If lDeb > 0 Then
			lRow = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.Rowcount () )
			sVal = idw_LstInter.GetItemString ( lRow, "ALT_COURGEST" )
			If sVal = "N" Then
				sVal = idw_LstInter.GetItemString ( lRow, "ID_COUR" )
				If Mid ( sVal, 5, 1 ) = "R" Then
					stMessage.sTitre		= "Contrôle de saisie du sinistre"
					stMessage.Icon			= Exclamation!
					stMessage.bErreurG	= FALSE
					stMessage.sCode		= "WSIN866" 
					stMessage.bouton		= YesNo!
		
					iRet = F_Message ( stMessage )
					If	iRet = 2 Then
						sPos	= "ALT_BLOC"
						stMessage.sCode	= "WSIN867"
					End If
				End If 
			End IF 
		End If 

		// [RS4665_INT_REF_PCE]
		If Not bBloque And sPos = "" Then
			
			lLig = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.RowCount () )
			If lLig > 0 Then
				sVal = Mid ( idw_LstInter.GetItemString ( lLig, "ID_COUR" ), 4, 1 ) 
			End If 
			
			lCodEtat	= idw_wSin.GetItemNumber ( 1, "COD_ETAT" )
			
			lLig = idw_wrefus.Find( "ID_MOTIF = 603", 1, idw_wrefus.RowCount())
		
			// Critère détecté
			If sVal = "P" And lCodEtat = 200 And lLig > 0 Then
			
				// Le Gt n'a pas le niveau autorisé => Blocage
				If	( Long ( stGLB.sTypOper ) < idw_Produit.GetItemNumber ( 1, "COD_NIV_OPE" )) then
		
					sPos = "ALT_BLOC"
					
					stMessage.sTitre		= "RS4565 : Refus 603 et demande de pièce"
					stMessage.Icon			= Information!
					stMessage.bErreurG	= FALSE
					stMessage.Bouton		= OK!
					stMessage.sCode		= "WSIN891"
			
				// Le Gt a le niveau autorisé => avertissement
				Else 
					
					stMessage.sTitre		= "RS4565 : Refus 603 et demande de pièce"
					stMessage.Icon			= Exclamation!
					stMessage.bErreurG	= FALSE
					stMessage.Bouton		= YESNO!
					stMessage.sCode		= "WSIN892"				


					If F_Message ( stMessage ) = 2 Then 
						bMessage = FALSE
						sPos = "ALT_BLOC"
					End If 
				End If 
			End If 
		End If 

/*------------------------------------------------------------------*/
/* #3 : DCMP 040020 SVE                                             */
/*------------------------------------------------------------------*/
		If ibSaisieValidation And bAltEdit And sPos = "" Then

			// [PI052] // [MIG1_COUR_EMAILING] 
			If Not ib2EmeTourPI052 And Not ibMIG1_CourEmailing Then

				invSaisieValSin.uf_Inscrire_DroitsModifCourrier ( iDroitInter )
				/*----------------------------------------------------------------------------------------------*/
				/* #9 : Ajout du paramétre -1 de l'interlocuteur suite modif  de la fonction uf_GetAutorisation */
				/*----------------------------------------------------------------------------------------------*/
				This.uf_GetAutorisation ( "", sBIN, bVal, bVal, bVal, -1 )
				invSaisieValSin.uf_Inscrire_AutresDroits ( sBIN )
	
				// [PI052]
				sPos = Uf_Determiner_Data_Sinistre ( sDataInter, "COUR_AUTO", -1, TabVariable[], TabCodeVar[] )

			End If

			If	sPos = "" Then
				
				// #6 ajout structure en param ref
				// [PI052] ajout des deux tableau

				// [PI052] // [MIG1_COUR_EMAILING] 
				If Not ib2EmeTourPI052 And Not ibMIG1_CourEmailing Then 

					sPos = invSaisieValSin.uf_Generer_Courrier ( sDataInter, "CHOIX", FALSE, FALSE, bAuMoinUnCourrier, nvTrtAttribGenCour, TabVariable[], TabCodeVar[] )  

					// Debut #8 On ne lance cette partie que dans ce cas
					If nvTrtAttribGenCour.bTab[1] and sPos = "" Then
						
						// #6 Ouverture fenêtre response ici et non plus dans uf_CenererCourrier
						/*---------------------------------------------------------------------------------------------------*/
						/* #9 :01/08/2006 Suite à l'Ajout du canal MAIL, modif du nom de la fenêtre sur l'appel de l'ouverture*/
						/*---------------------------------------------------------------------------------------------------*/
						
						// #10
							/*
							Pour rappel, dans invSaisieValSin.uf_Generer_Courrier, nvTrtAttribGenCour est chargé comme suit: 
								dwNorm[1]	= iDddwTypeDoc
								dwNorm[2]	= idwChoixCourGen
								dwTab[1]		= idwLstInter
								sTab[1]		= isIdAppli
								sTab[2]		= isAutresDroits
							Par conséquent on ajoute les références à det_pro et produit ainsi:
								dwNorm[3]	= idw_Produit
								dwNorm[4]	= idw_DetPro
							*/
						nvTrtAttribGenCour.dwNorm[3]	= idw_Produit
						nvTrtAttribGenCour.dwNorm[4]	= idw_DetPro
						nvTrtAttribGenCour.lTab[1]		= idw_WSin.GetItemNumber ( 1, "ID_PROD" )

						
						// #10 - FIN
	
						OpenWithParm ( W_Trt_Choix_Regen_Courrier_simpa2, nvTrtAttribGenCour ) 
		
						// #6 Ajout SetPointer ici repris de uf_CenererCourrier
						SetPointer ( HourGlass! )
						
						// #6 Réaffection au retour repris de uf_CenererCourrier
						nvTrtAttribGenCour = Message.PowerObjectParm
		
						// [PRBLE_PATCH_MS_WORD]
						// Si del impossible, mettre nvTrtAttribGenCour.sTab[2] = "STOP"
						If Not This.uf_GestionRepCourrierLocal () Then 
							nvTrtAttribGenCour.sTab[2] = "STOP"
						End If 

						// #6 Traitement des cas repris de uf_CenererCourrier
						Choose Case nvTrtAttribGenCour.sTab[2]
							Case "ARRETER"
								sPos = "STOP"
								
							Case "CONTINUER"
								// #6 ajout nouvel appel de uf_GenerCourrier sur nouveau cas "CHOIX_2" avec structure en param ref (non utilisé en retour ici)
								// [PI052] ajout des deux tableau
								sPos = invSaisieValSin.uf_Generer_Courrier ( sDataInter, "CHOIX_2", FALSE, FALSE, bAuMoinUnCourrier, nvTrtAttribGenCour, TabVariable[], TabCodeVar[]  )  

								// [PI052]
								// La technique : On stoppe ici la mécanique car à ce moment un Timer tourne et relancera le contrôle pour un second tour.
								/*
								If F_CLE_A_TRUE ( "PI052" ) Then
									If sPos = "" And invSaisieValSin.ibPI052_GenEdtKsl And invSaisieValSin.ibTimerPI052 Then
										astPass.sTab [ 1 ] = "ALT_BLOC"
										Return
									End If
								End If							
								*/
								
							// #6 Sécurité
							Case Else
								sPos = "STOP"
						End Choose 
		
					// Fin #8
					End If
				End If
				// #6 ajout nouvel appel de uf_GenerCourrier sur nouveau cas "CHOIX_FIN" avec structure en param ref (non utilisé en retour ici)
				// #7 Je ne gère plus le retour dans sPos
				// [PI052] ajout des deux tableaux

				ib2EmeTourPI052 = False
				invSaisieValSin.uf_Generer_Courrier ( sDataInter, "CHOIX_FIN", FALSE, FALSE, bAuMoinUnCourrier, nvTrtAttribGenCour, TabVariable[], TabCodeVar[]  )  				

			End If

			ib2EmeTourPI052 = False
			If bAuMoinUnCourrier Then OpenWithParm ( W_Trt_Capture_Click, "" )

			If	sPos <> ""	Then
				sPos	= "ALT_BLOC"
				iUoOng.Uf_ChangerOnglet ( "01" )

				stMessage.sTitre		= "Génération des courriers"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= OK!
				stMessage.sCode		= "SVE0010"
				
				// [PI052]
				/*
				If F_CLE_A_TRUE ( "PI052" ) Then
					If invSaisieValSin.uf_PI052_DroitParam	( "INFO" ) Then
						stMessage.sCode		= "P234020"
					End If
				End If					
				*/
					
			Else
				idw_Wsin.TriggerEvent ( "ue_ibScriptClientFocus" )  // Affectation à TRUE
			End If

		// Méthode à l'ancienne		
		Else
			// [PI052]
			If sPos = ""	And bOkIdEts Then sPos = Uf_Determiner_Data_Sinistre ( sDataInter, "COUR_AUTO", -1, TabVariable[], TabCodeVar[] )	// [ITSM92321] Ajout de bOkIdEts
		End If
	End If
End If

/*------------------------------------------------------------------*/
/* # Modification SFR # Le 17/07/2002.                              */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Annexe 5. Il est impossible de valider un dossier avec une       */
/* garantie PANNE en cours et un détail en cours, sans COMMANDE     */
/* active pour ce détail.                                           */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Annexe 9. Ce contrôle est faire uniquement si le DOSSIER n'est   */
/* pas bloqué.                                                      */
/*------------------------------------------------------------------*/
/* JFF le 03/03/2003 : Je shunt ce contrôle qui se trouve être 	  */
/* très gênant dans certain cas de gestion.								  */
/* Je laisse le code, si jamais on revenait en arrière.				  */
/*------------------------------------------------------------------*/
/* Début Shunt
If	Not bBloque  And sPos = ""	Then
	If	idw_Produit.GetItemNumber ( 1, "COD_TEL" ) = 21	And idw_wSin.GetItemString ( 1, "ALT_BLOC" ) = "N" Then
		lTotDetail	= idw_wDetail.RowCount ()
		lTotCmd		= idw_LstwCommande.RowCount ()

		For	lCptDetail = 1	To lTotDetail
				If	idw_wDetail.GetItemNumber ( lCptDetail, "ID_GTI" ) = 18			And 	&
					( idw_wDetail.GetItemNumber ( lCptDetail, "COD_ETAT" ) = 100	Or		&
					  idw_wDetail.GetItemNumber ( lCptDetail, "COD_ETAT" ) = 500	Or		&
					  idw_wDetail.GetItemNumber ( lCptDetail, "COD_ETAT" ) = 550 )	Then

					sRech = "ID_GTI = 18 And COD_ETAT <> 'ANN' And ID_DETAIL = " + String ( idw_wDetail.GetItemNumber ( lCptDetail, "ID_DETAIL" ) )

					If idw_LstwCommande.Find ( sRech, 1, idw_wDetail.RowCount () ) = 0	Then
						stMessage.sTitre		= "Gestion SFR"
						stMessage.Icon			= Exclamation!
						stMessage.sVar[1]		= String ( idw_wDetail.GetItemNumber ( lCptDetail, "ID_DETAIL" ) )
						stMessage.bErreurG	= FALSE
						stMessage.Bouton		= OK!
						stMessage.sCode		= "SFRP020"

						sPos	= "ALT_BLOC"
						iUoOng.Uf_ChangerOnglet ( "01" )
						Exit
					End If
				End If
		Next
	End If
End If

FIN Shunt*/

/*------------------------------------------------------------------*/
/* Gestion des contacts                                             */
/*------------------------------------------------------------------*/
If sPos = "" and ibAltcontact Then
	bRetcontact = uf_Ctl_Nature_Contact ( ) 
	If Not bRetContact Then 
		sPos = "ALT_BLOC"
		iUoOng.Uf_ChangerOnglet ("04")	
	End If
End If

If Not bBloque And ibAltTelephonie And sPos = "" Then
	dDteAchPort  = Date(idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ) ) // [PI056]
	dDteOuvLigPort  = Date(idw_wSin.GetItemDateTime ( 1, "DTE_OUVLIG_PORT" ) )  // [PI056]

	If	sPos = "" And Not IsNull ( dDteAchPort  ) And Not IsNull ( dDteOuvLigPort )Then
		If ( Today () < dDteAchPort ) Or ( Today () < dDteOuvLigPort ) Then
			sPos = "ALT_BLOC"
			stMessage.sTitre		= "Contrôle téléphonie"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "TLPH006"
		End If
	End If
End If

/*------------------------------------------------------------------*/
/* Gestion des commandes :                                          */
/* Il est illogique de valider une commande (cpt_valide=0) si le    */
/* dossier est refusé ou si la garantie ou le détail liés à cette   */
/* commande sont refusée.                                           */
/* Je ne test pas volontairement ibAltCmdMobile, je préfère dans les*/
/* contrôler qu'aucune commande ne partent dans ces conditions.	  */
/*------------------------------------------------------------------*/
If Not bBloque And sPos = "" Then
	If idw_wSin.GetItemNumber ( 1, "COD_ETAT" ) <> 1 Then &
		sPos = uf_controlergestion_commandes ()
End If

// #13 [CRAO_LOT2] Saisie Obligatoire de L'IMEI de Controle : Controle Supprimé
///*------------------------------------------------------------------*/
///* #2 : L'IMEI de controle n'est obligatoire que si l'on règle.     */
///*------------------------------------------------------------------*/
///*------------------------------------------------------------------*/
///* #10 : Utilisation de la zone REF_CIE pour la saisie d'un IMEI de */
///* controle sur option 19.														  */
///*------------------------------------------------------------------*/
//If Not bBloque And sPos = "" Then 
//	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 19 )
//	If lDeb > 0 Then
//		Choose Case idw_Wsin.GetItemNumber ( 1, "COD_ETAT" ) 
//			Case 500
//				sVal = idw_Wsin.GetItemString ( 1, "REF_CIE" )
//				If IsNull ( sVal ) Or sVal = "" Then
//					stMessage.sTitre		= "Contrôle Gestion"
//					stMessage.Icon			= Information!
//					stMessage.bErreurG	= TRUE
//					stMessage.sVar [1]	= "~n~r" + " - L'IMEI de contrôle (obligatoire pour régler)" + "~n~r" 
//					stMessage.sCode		= "GENE001"
//					sPos = "REF_CIE"
//				End If
//		End Choose
//	End If
//End If


/*------------------------------------------------------------------*/
/* CAG 28/11/02 : Modification suite à pb de gestion d'un dossier   */
/* dont les frais sont réglés avec id_adh à null :   					  */
/* On oblige la saisie de l'id_adh ou alors le dossier doit être    */
/* bloqué (suite tests JFF, plus de test sur cod_etat)              */
/*------------------------------------------------------------------*/
If Not bBloque And sPos = "" Then
	lMtreg = idw_wSin.GetItemNumber ( 1, "MT_A_REG" )
	lCodEtat = idw_wSin.GetItemNumber ( 1, "COD_ETAT" )
	sIdAdh = idw_wSin.GetItemString ( 1, "ID_ADH" )
	sAltBloc = idw_wSin.GetItemString ( 1, "ALT_BLOC" )
	If idw_wSin.GetItemNumber ( 1, "MT_A_REG" ) > 0 And &
		IsNull ( idw_wSin.GetItemString ( 1, "ID_ADH" ) ) And &
		idw_wSin.GetItemString ( 1, "ALT_BLOC" ) = 'N' Then

		sPos = "ALT_BLOC"
		stMessage.sTitre		= "Contrôle règlement frais d'envoi sur refus"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN380"
		
	End If
End If

// #12 - en cours de developpement
/*------------------------------------------------------------------*/
/* #1 CAG 16/06/2003                                                */
/*------------------------------------------------------------------*/
//If Not bBloque And sPos = "" Then
//	sModl = Trim ( Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) )
//	sMarq = Trim ( Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) )
//	If Not IsNull ( sModl ) And sModl <> "" Then
//		If IsNull ( sMarq ) Or sMarq = "" Then
//			sPos = "MARQ_PORT"
//			stMessage.sTitre		= "Contrôle de saisie du sinistre"
//			stMessage.Icon			= Information!
//			stMessage.bErreurG	= FALSE
//			stMessage.sCode		= "WSIN420"
//		End If
//	End If
//	If Trim ( sMarq ) = "" Then
//		SetNull ( sNull )
//		idw_wSin.SetItem ( 1, "MARQ_PORT", sNull )
//	End If
//End If

If Not bBloque And sPos = "" Then 
	sModl = Trim ( Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) )
	sMarq = Trim ( Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) )
	sNumPort = Trim ( Upper ( idw_wSin.GetItemString ( 1, "NUM_PORT" ) ) )
	sNumImeiPort = Trim ( Upper ( idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) ) )
	
// #21 [DCMP080625] Désactivation du controle de saisie 
// obligatoire des marques et modèle
//	if idw_Produit.GetItemNumber ( 1, "COD_TEL" ) > 0 then
//		If ( IsNull ( sModl ) or sModl = "" ) or &
//			( IsNull ( sMarq ) Or sMarq = "" ) Then
//				sPos = "MARQ_PORT"
//				stMessage.sTitre		= "Contrôle de saisie du sinistre"
//				stMessage.Icon			= Information!
//				stMessage.bErreurG	= FALSE
//				stMessage.sCode		= "WSIN420"
//		End If
//	end If
// #21 [DCMP080625] Note : le controle ci-dessus est remplacé par le suivant :
// Si une Demande de Controle IMEI est cochée et pas de marque et modele.
// => MEssage bloquant
// Explication : Cas possible uniquement si : changement Tel ou IMEI puis suppression
// marque/modele saisie. Un cochage automatique de "cra_ctrl_imei" intervient alors.
// Après analyse, il y a des cas contradictoire ou un cochage auto doit être fait
// et la saisie possible ou de marque/modele null.
// Afin de sécuriser le process, je controle que le controle IMEI peut etre demandé si
// les quatre élément suivant sont saisie Num Tel + Num IMEI + MArque + modele
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 75 )
	if lDeb > 0 Then
		if (lnvString.of_IsEmpty(sNumPort) or lnvString.of_IsEmpty(sNumImeiPort) or &
			lnvString.of_IsEmpty(sMarq) or lnvString.of_IsEmpty(sModl) ) and &
			uf_gestong_divers_trouver( "cra_ctrl_imei") = "O" Then // Si demande cochée, 
																					// et un des 4 element 
																					// necessaire absent
				sPos = "ALT_BLOC"
				iUoOng.Uf_ChangerOnglet ( "04")
				stMessage.sTitre		= "Contrôle de saisie du sinistre"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN423"
			End If
	End If
	//
	SetNull ( sNull )
	
 	If Trim ( sMarq ) = "" Then idw_wSin.SetItem ( 1, "MARQ_PORT", sNull )
	If Trim ( sModl ) = "" Then idw_wSin.SetItem ( 1, "MODL_PORT", sNull )
End If
// #12 - en cours de developpement - FIN


/*------------------------------------------------------------------*/
/* On ne peut régler qu'un seul détail par fournisseur (et un seul  */
/* fournisseur), par validation												  */
/*------------------------------------------------------------------*/
If	Not bBloque And sPos = "" Then
	lTotDetail	= idw_wDetail.RowCount ()
	lCptRegFrn  = 0

		For lCptDetail = 1 To lTotDetail
			lCodeEtat = idw_wDetail.GetItemNumber ( lCptDetail, "COD_ETAT" ) 

			Choose Case lCodeEtat 
				Case 500 // A REGLER
					lRow = idw_LstInter.Find ( "ID_I = " + String ( idw_wDetail.GetItemNumber ( lCptDetail, "ID_I_REG" )) , 1, idw_LstInter.RowCount () ) 
					If idw_LstInter.GetItemString ( lRow, "COD_INTER" ) = "F" Then lCptRegFrn ++
					
			End CHoose
			
			If lCptRegFrn > 1 Then 
				sPos = "ALT_BLOC"
				sOng = "01"
				stMessage.sTitre		= "Contrôle de saisie du sinistre"
				stMessage.Icon			= Exclamation!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN470"
				Exit
			End If
		Next
	
End If		

// #11
if	not bBloque and sPos = "" then
	if	( ilIdNatSin = 0 or ilIdTerrit = 0 or ilIdDetSin = 0 ) and & 
			idw_wSin.GetItemNumber ( 1, "MT_A_REG" ) > 0 and &
			idw_wSin.GetItemNumber ( 1, "MT_REG" ) = 0 then
		sPos = "ID_NATSIN"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN246"
	end if
end if
// #11 - FIN

/* #13 [CRAO_LOT1] Le Compteur de demande ne peut être > 4			  */
if	not bBloque and sPos = "" then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 75 )
	If lDeb > 0 Then
		lCraCptDmde = long ( This.uf_GestOng_Divers_Trouver ( "CRA_CPT_DMDE" ) ) 
		sCraCtrlImei = upper ( This.uf_GestOng_Divers_Trouver ( "CRA_CTRL_IMEI" ) ) 
		if	lCraCptDmde = 4 and sCraCtrlImei = 'O' then 
			sPos = "ALT_BLOC"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "WSIN496"
			// [CRAO_LOT1]Utilisation fonction setfocus sur onglet divers dev par JFF
			POST uf_gestong_divers_setfocus( "CRA_CTRL_IMEI")
		End If
	end if
end if
// #13 - FIN

// #15
If	Not bBloque and sPos = "" then
	If This.uf_Gestion_Mdp_Extranet_Cmde ( "CONTROLE" ) <> "1" Then
		sPos = "ALT_BLOC"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "COMD440"			
	End If
End If	
// /#15

// [WEBSIM2].[FRANCE]
If	Not bBloque and sPos = "" then
	If This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "CONTROLE" ) <> "1" Then
		sPos = "ALT_BLOC"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "COMD622"	// [WEBSIM2] à Créer	!
	End If
End If	
// :[WEBSIM2].[FRANCE]

// #16 #17
If	Not bBloque and sPos = "" then
// [WEBSIM2].[FRANCE] ajout In (WBB....
	lRow = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV', 'CWE') AND ID_FOUR IN ( 'WBA', 'WBB' )", 1, idw_LstwCommande.RowCount ())
	If lRow > 0 Then
	
		lIdGti = idw_LstwCommande.GetItemNumber ( lRow, "ID_GTI" )
		
		lRow = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.RowCount () )		
		lIdInter = idw_LstInter.GetItemNumber ( lRow, "ID_I" )

		lRow = idw_wDetail.Find ( "ID_GTI = " + String ( lIdGti ) + " AND ID_I_REG = " + String ( lIdInter ) + " AND COD_ETAT = 500", 1, idw_wDetail.RowCount () )
		
/* #17
		
		lRow = idw_LstGti.Find ( "ID_GTI = " + String ( lIdGti ) + " AND MT_PLAF_AREG > 0 ", 1, idw_LstGti.RowCount () )
*/		

		// #17

		
		If lRow > 0 Then
			sPos = "ALT_BLOC"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "WSIN530"			
		End If				

	End If
End If	
// /#16

// #19
if	not bBloque and sPos = "" then

	bLock = uf_ControlerGestion_CtrlReglFactu()

	if bLock then
		sPos = "ALT_BLOC"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= false
		stMessage.sCode		= "WSIN600"
	end if				
end if
// #19 - FIN

// #20
if	Not bBloque and sPos = "" then
	bLock = uf_ControlerGestion_AccordAssureur ( "CONTROLE" )

	if bLock then
		sPos = "ALT_BLOC"
	end if				
end if
// #20 - FIN

//* #22 [MICROMANIA]
if	Not bBloque and sPos = "" then
	sVal = idw_WSin.GetItemstring ( 1, "ID_CONTRAT_ABONNE" )
	If ( Trim ( sVal ) = "" Or IsNull ( sVal ) ) And &
		idw_CmdTypFrn.Find ( "ID_CODE_FRN = 'MCM'", 1, idw_CmdTypFrn.Rowcount ()) > 0 And &
		idw_LstwCommande.Find ( "ID_FOUR = 'MCM' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.Rowcount ()) > 0 Then
		sPos = "ALT_BLOC"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= false
		stMessage.sCode		= "WSIN620"
	End If
End If

// #23 [DCMP090254]
if	Not bBloque and sPos = ""  And this.uf_GetAutorisation2(208) then
	lRow=idw_LstInter.Find("COD_INTER <> 'F' AND MT_A_REG > 0",1,idw_LstInter.RowCount())
	
	if lRow > 0 Then
		sPos = "ALT_BLOC"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= false
		stMessage.sCode		= "WSIN660"
	End if
End if

// [PM103]
if	Not bBloque and sPos = ""  And Not this.uf_GetAutorisation2(208) And Not gbModeReprise_223 then
	lRow=idw_LstInter.Find("COD_INTER = 'F' AND MT_A_REG > 0",1,idw_LstInter.RowCount())
	
	if lRow > 0 Then
		sPos = "ALT_BLOC"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= false
		stMessage.sCode		= "WSIN670"
	End if
End if
// #23 - Fin

// [VDOC17700]
if	Not bBloque and sPos = ""  And this.uf_GetAutorisation2 (208) then
	lRow=idw_LstwCommande.Find("COD_ETAT = 'CNV' AND MAJ_PAR <> '" + stGlb.sCodOper + "'",1,idw_LstwCommande.RowCount())
	
	if lRow > 0 Then
		sPos = "ALT_BLOC"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= false
		stMessage.sCode		= "WSIN788"
	End if
End if

if	Not bBloque and sPos = ""  And this.uf_GetAutorisation2 (208) then
	lRow=idw_wCourrier.RowCount()
	
	if lRow > 0 Then
		sPos = "ALT_BLOC"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= false
		stMessage.sCode		= "WSIN789"
	End if
End if

// #25 [FNAC_PROD_ECH_TECH].[BGE].[20091027112156767]
If Not bBloque and sPos = "" and Not uf_getautorisation2( 208 ) Then
	If Not uf_ControlerGestion_BGE () Then
		sPos = "ALT_BLOC"
	End if				
End if
// #25 [FNAC_PROD_ECH_TECH].[BGE].[20091027112156767]

// [PC106_ECONOCOM]
If Not bBloque and sPos = "" Then
	// Recher si mail de décl paramètré.
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 146 )
	If lDeb > 0 Then
		sModl=idw_wsin.GetItemString( 1, "MODL_PORT")
		sMarq=idw_wsin.GetItemString( 1, "MARQ_PORT")
		If IsNull ( sMarq ) Or Len ( Trim ( sMarq ) ) = 0 Or IsNull ( sModl ) Or Len ( Trim ( sModl  )) = 0 Then
			sPos = "ALT_BLOC"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= false
			stMessage.sCode		= "WSIN696"
		End If
	End If
End If
// :[PC106_ECONOCOM]

// [PM01].[LOT3&4]

// [PC954] - pour le Carrefour Casse Vol, le contrôle ne s'applique pas à la garantie 11
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 141 )	
bCarrefourCasseVolGti11=	(lDeb > 0)

If bCarrefourCasseVolGti11 Then
	If idw_wdetail.Find ( "ID_GTI=18 And COD_ETAT <> 900", 1, idw_wDivDet.RowCount() ) > 0 Then 
		lLigCAF=idw_lstwcommande.Find("ID_TYP_ART='CAF' And COD_ETAT <> 'ANN'",1,idw_lstwcommande.RowCount())
		lLigDiagO2M=idw_lstwcommande.Find("ID_TYP_ART='EDI' And ID_FOUR='O2M' And COD_ETAT <> 'ANN'",1,idw_lstwcommande.RowCount())
		If lLigCAF > 0 And lLigDiagO2M <=0 Then bCarrefourCasseVolGti11=FALSE
	End if
End if
// :[PC954]

If (Not bBloque) And sPos="" And (not bCarrefourCasseVolGti11) Then // [PC954] - Ajout du not bCarrefourCasseVolGti11
	
	// [Vdoc2985] ajout 208
	If Not This.uf_GetAutorisation2 ( 208 ) And &
		Date ( idw_WSin.GetItemDateTime ( 1, "CREE_LE" ) ) >= 2010-12-07 And & 
		idw_wDivDet.Find ( "upper(NOM_ZONE) = 'PEC' AND VAL_LST_CAR = 'O'", 1, idw_wDivDet.RowCount() ) > 0 And &
		idw_LstGti.Find ( "ID_GTI IN ( 11, 15, 18 )" , 1, idw_LstGti.RowCount() ) > 0 Then

		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 95 )	
		For lCpt = lDeb To lFin
			If lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ), "TYP_APP", ";") = sTypApp Then
	
				Choose case lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ), "PROCESS", ";") 
					Case "1503", "1504"
						If idw_LstwCommande.Find ( "INFO_SPB_FRN IN (1503, 1504)", 1, lTotCmd ) <= 0 Then				
							sPos = "ALT_BLOC"
							stMessage.sTitre		= "Contrôle de gestion"
							stMessage.Icon			= Information!
							stMessage.bErreurG	= FALSE
							stMessage.sCode		= "WSIN697"
							Exit
						End If
						
					Case "1505"
						If idw_LstwCommande.Find ( "INFO_SPB_FRN IN (1505)", 1, lTotCmd ) <= 0 Then				
							sPos = "ALT_BLOC"
							stMessage.sTitre		= "Contrôle de gestion"
							stMessage.Icon			= Information!
							stMessage.bErreurG	= FALSE
							stMessage.sCode		= "WSIN698"
							Exit							
						End If
						
				End Choose
			End If
		Next
	End If
End If
// :[PM01].[LOT3&4]

// [ITSM_MARYSE]
// [ITSM325581] Ajout du test sur sPos
If sPos="" Then
	lTotInter = idw_LstInter.RowCount ()
	// [MON374]
	If F_CLE_A_TRUE ( "MON374" ) Then
		F_RechDetPro ( lDeb396, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 396 )	
		sVal = ""
		If lDeb396 > 0 Then
			sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "CODE_BANQUE_AUTORISE", ";")
		End IF 
	End IF 
	
	For lCptInter = 1 To lTotInter
	
			sVal1		= idw_LstInter.GetItemString ( lCptInter, "ID_FOUR" )
			sVal2		= idw_LstInter.GetItemString ( lCptInter, "COD_INTER" )
			sAdrMail = idw_LstInter.GetItemString ( lCptInter, "ADR_MAIL" )
			
			sAdrMail = F_EPURE_CHAINE ( sAdrMail, "" ) 
			idw_LstInter.SetItem ( lCptInter, "ADR_MAIL", sAdrMail )
			
			If sVal2 <> "F" and Not IsNull ( sVal1	) Then
				idw_LstInter.SetItem ( lCptInter, "ID_FOUR", stNul.str )
			End If
			
			// [PM159].[Controle_mail] contrôle adresse inter assuré uniquement
			If sPos = "" And Not bBloque Then
				sMail = Trim ( idw_LstInter.GetItemString ( lCptInter, "ADR_MAIL" ) )
				If Not F_Mail_Valide ( sMail ) Then
						sPos = "ALT_BLOC"
						stMessage.sTitre		= "Contrôle de l'adresse mail"
						stMessage.Icon			= Information!
						stMessage.bErreurG	= FALSE
						stMessage.sCode		= "WSIN708"
						Exit
				End If	
			End If
			
			// [MON374]
			If F_CLE_A_TRUE ( "MON374" ) Then
				If lDeb396 > 0 Then
					sVal3 = Trim ( idw_LstInter.GetItemString ( lCptInter, "RIB_BQ" ))
					IF Not IsNull ( sVal ) Then 
						If Pos ( sVal, "#" + sVal3 + "#" ) <= 0 Then
							sPos = "ALT_BLOC"
							stMessage.sTitre		= "Contrôle des RIB"
							stMessage.Icon			= Information!
							stMessage.bErreurG	= FALSE
							stMessage.sVar[1]    = sVal3
							
							sVal = F_REMPLACE ( sVal, "#", "," )
							sVal = Left ( sVal, len ( sVal ) - 1 )
							sVal = Right ( sVal, len ( sVal ) - 1 )
							stMessage.sVar[2]	   = sVal
							
							stMessage.sCode		= "WSIN927"
							Exit
						End If 
					End If 					
				End If 
			End If

			
	Next
End if
// :[ITSM_MARYSE]

// [VDoc6141] 
If sPos="" And Not bBloque Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 203 )	
	If lDeb > 0 Then
		If lnvString.of_isempty( sNumPort )  Then
			sPos = "NUM_PORT"
			stMessage.bErreurG	= FALSE
			stMessage.svar[1]="~n~r- le numéro de portable ~n~r"
			stMessage.sCode		= "GENE001"
		End if
	End if
End if
// :[VDoc6141] 

// [20120123.FPI]
lVal= idw_WSin.getItemNumber(1, "COD_ETAT")
If lVal = 0 or lVal=100 or lVal = 500 Then // [20120216.FPI.2]
	dteDecl= idw_WSin.getItemDate( 1, "DTE_DECL")
	dteSurv= idw_WSin.getItemDateTime( 1, "DTE_SURV")

	// Erreur de saisie - Date de survenance > Date de déclaration
	If Date(dteSurv) > dteDecl Then
		sPos="DTE_SURV_DATE"
		stMessage.bErreurG= False
		stMessage.sCode	= "WSIN720"
	End if
End if
// :[20120123.FPI]

// [DTE_SURV_<=_TODAY]
dteSurv= idw_WSin.getItemDateTime( 1, "DTE_SURV")

If Date ( dteSurv ) > Today () Then
	sPos="DTE_SURV_DATE"
	stMessage.bErreurG= False
	stMessage.sCode	= "WSIN835"
End If 

// [PM103][1]
If gbModeReprise_223 Then
	lTotInter = idw_LstInter.RowCount ()
	For lCptInter = 1 To lTotInter
		sVal = idw_LstInter.GetItemString ( lCptInter, "COD_INTER" )
		
		idw_LstInter.SetItem ( lCptInter, "COD_MODE_REG", "XX" )

	Next
End If

// [PC947&977] ajout not 208
If Not gbModeReprise_223 And Not bBloque And Not uf_getautorisation2( 208 ) And sPos = "" Then
	lTotInter = idw_LstInter.RowCount ()
	For lCptInter = 1 To lTotInter
		If idw_LstInter.GetItemDecimal ( lCptInter, "MT_A_REG" ) > 0 And &
			( idw_LstInter.GetItemString ( lCptInter, "COD_MODE_REG" ) = "XX" Or &
			  idw_LstInter.GetItemString ( lCptInter, "COD_MODE_REG" ) = "XA" ) Then 

			stMessage.sTitre		= "Contrôle de l'adresse mail"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "WSIN726"
			stMessage.bouton		= YesNo!
			
			If F_Message ( stMessage ) = 2 Then 
				bMessage = FALSE
				sPos = "ALT_BLOC"
				stMessage.sCode = ""
				Exit
			Else
				bMessage = False
				stMessage.sCode = ""
			End If
		End if	 
	Next
End If
// :[PM103][1]


//	[AJOUT_CTRLE_FNAC]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 105 )

If lDeb > 0 Then
	lIdOrianBout = idw_wSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )		
	If Not IsNull ( lIdOrianBout ) Then
		idw_wsin.getchild( "ID_ORIAN_BOUTIQUE", dwChild)
		lRow=dwChild.Find( "ID_BOUTIQUE = " + String(idw_wsin.GetItemNumber(1,"ID_ORIAN_BOUTIQUE")) , 1, dwChild.RowCount())
		
		If lRow <= 0 Then
			stMessage.sTitre		= "Contrôle de gestion"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "WSIN737"
			sPos	= "ALT_BLOC"					
		End If
		
	End If 
	
End If
//	:[AJOUT_CTRLE_FNAC]

// [ITSM282998]
// [DT191] 2143
If Not bBloque And sPos = "" Then		
	// [DT191]
	// [VDOC28734]
	lRow = idw_LstwCommande.Find ( "ID_FOUR = 'PSM' AND ID_TYP_ART NOT IN ( 'PST', 'REL' ) AND COD_ETAT = 'CNV' AND INFO_SPB_FRN NOT IN ( 2130 ) AND ID_REF_FOUR NOT IN ( 'PEC_A_RECYCLER', 'REFUSE_A_REEXP' ) ", 1, idw_LstwCommande.RowCount () ) 

	If lRow > 0 Then
		sMess = "WSIN786"

		sVal = Trim ( lnvString.of_getkeyvalue (idw_LstwCommande.GetItemString ( lRow, "INFO_SPB_FRN_CPLT" ), "CODE_BTQ_PSM_CENTRALE", ";"))
		If sVal = "" Or Not IsNumber ( sVal ) Then
			
			idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV'" )
			idw_LstwCommande.Filter ()

			lTot = idw_lstwcommande.RowCount()				
			if lTot > 0 Then
				For lCpt = lTot To 1 Step -1
					idw_LstwCommande.DeleteRow ( lCpt )
				Next 
			End If
			sMess = "WSIN790"

			idw_LstwCommande.SetFilter ( "" )
			idw_LstwCommande.Filter ( )
			idw_LstwCommande.Sort ()					
			
			stMessage.sTitre		= "Contrôle de gestion"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= sMess
			sPos	= "ALT_BLOC"					
		End If
	End IF
End If	

// [PC938_ORANGE_V3]
gProcessTempoOrangeV3 = FALSE
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )

// [DT081_EVOL_PRET_BRIS] clé 2 premet de couper juste ce contrôle
If Not bBloque And lDeb > 0 And sPos = "" Then
	 lVal1 = idw_LstGti.Find ("ID_GTI = 10 AND CPT_VALIDE = 0", 1, idw_LstGti.RowCount () )
	 lVal2 = idw_LstGti.Find ("ID_GTI NOT IN ( 10, 8 ) AND CPT_VALIDE = 0", 1, idw_LstGti.RowCount () )
	 lVal3 = idw_LstGti.Find ("ID_GTI = 10 AND CPT_VALIDE > 0", 1, idw_LstGti.RowCount () )
	 lVal4 = idw_LstGti.Find ("ID_GTI NOT IN ( 10, 8 ) AND CPT_VALIDE > 0", 1, idw_LstGti.RowCount () )
	 
	 If sPos = "" And ( ( lVal1 > 0 And lVal4 > 0 ) Or ( lVal2 > 0 And lVal3 > 0 ) Or ( lVal1 > 0 And lVal2 > 0 )) Then
		stMessage.sTitre		= "Contrôle de gestion"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN765"
		sPos	= "ALT_BLOC"				
	 End if
End If

// Attention au lDeb /|\
If Not bBloque And lDeb > 0 And sPos = "" Then
	lVal = idw_LstGti.Find ( "COD_ETAT=200 AND ID_GTI = 10", 1, idw_LstGti.Rowcount() )
	sVal = uf_GestOng_Divers_Trouver ( "CONF_REFUS_PEC" )
	
	If lVal > 0 And sVal = "N" Then
		stMessage.sTitre		= "Contrôle de gestion"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN744"
		stMessage.Bouton		= YESNO!
		
		If F_MESSAGE ( stMessage ) = 1 Then
		
			// Suite entretien avec Lisette, nouveau process ici.
			sVal = uf_GestOng_Divers_Trouver ( "CONS_APPPRETVOL" )
			
			lRow = idw_LstwCommande.Find ( "ID_GTI = 10 AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET') > 0", 1 , idw_LstwCommande.Rowcount () )
			
			If lRow > 0 Then
				If sVal = "O" Then
					sPos = This.uf_ControlerGestion_Caution ( bMessage, "DEBIT_IMM" )
				Else
					sPos = This.uf_ControlerGestion_Caution ( bMessage, "NOUV_NUM" )
				End If
			Else
				sPos = "OK"
			End If

			If sPos = "OK" Then
				lRow = idw_wdivsin.Find("upper(nom_zone)='CONF_REFUS_PEC'", 1 , idw_wdivsin.Rowcount()+1 )
				This.uf_gestong_divers_majzone( "CONF_REFUS_PEC", lRow, K_MAJZONE, 'O')
				sPos = ""
			End If
			
		Else
			sPos = "ALT_BLOC"
			bMessage = False
		End If
		
	End If
	
	// [PC938_ORANGE_V3]
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
	If Not bBloque And lDeb > 0 And sPos = "" Then
		sPos = This.uf_ControlerGestion_Caution ( bMessage, "1ER_NUM_TRANS" )
	End if 
	
End If

// [DT081-1_CREDIMM]
sVal = uf_GestOng_Divers_Trouver ( "RECREDIT_IMM" )
sVal1 = This.uf_GestOng_Divers_Trouver ( "ETAT_CAUTION_PAYBOX" )

If sVal = "O" Then

	Choose Case sVal1 
		Case "DEBTOT", "DEBPAR", "RECRKO"
			sPos = This.uf_ControlerGestion_Caution ( bMessage, "RECREDIT_IMM" )
			If sPos = "OK" Then
				sPos = ""
			End If
			
	End Choose 
End If

// /[PC938_ORANGE_V3]

// [PM234-4_V1]
// Attention au lDeb /|\
If Not bBloque And lDeb > 0 And sPos = "" Then
	// lDeb au dessus ultra important !
	lVal = idw_WDivSin.Find ( "NOM_ZONE = 'decla_atlas' AND VAL_CAR = 'O'", 1,  idw_WDivSin.RowCount () )
	lVal6 = idw_WDivSin.Find ( "NOM_ZONE = 'dcnx_decla_atlas' AND VAL_CAR = 'O'", 1,  idw_WDivSin.RowCount () )		
	If lVal6 > 0 Then lVal = 0

	// prêt avec caution
	// [VDOC17204]
	lVal1 = 	idw_LstwCommande.Find ( "ID_GTI <> 10 AND COD_ETAT <> 'ANN' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET') > 0 AND POS ( INFO_SPB_FRN_CPLT, 'TYP_APP_PRET=' ) > 0 AND POS ( INFO_SPB_FRN_CPLT, 'TYP_APP_PRET=ENTREE_GAM' ) <= 0 ", 1, idw_LstwCommande.RowCount ())				

	// Prêt entrée de Gam
	lVal2 = 	idw_LstwCommande.Find ( "ID_GTI <> 10 AND COD_ETAT <> 'ANN' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET') > 0 AND POS ( INFO_SPB_FRN_CPLT, 'TYP_APP_PRET=ENTREE_GAM') > 0 ", 1, idw_LstwCommande.RowCount ())

	// Prêt anticipé sur Vol 
	lVal5 =  idw_LstGti.Find ( "ID_GTI = 10", 1, idw_LstGti.Rowcount ())
	lVal3 = 	idw_LstwCommande.Find ( "ID_GTI = 10 AND COD_ETAT <> 'ANN' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET') > 0", 1, idw_LstwCommande.RowCount ())

	// Nums Trans Pay Box Présent
	lVal4= idw_WDivSin.Find ( "NOM_ZONE IN ( 'num_trans_paybox_1', 'num_trans_paybox_2' ) AND LEN ( VAL_CAR ) > 0", 1,  idw_WDivSin.RowCount () )


	If lVal > 0 And lVal4 > 0 And lVal1 <= 0 Then 
		stMessage.sTitre		= "Contrôle de gestion"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "P234012"
		f_Message ( stMessage )
	End If 
	
	If lVal > 0 And lVal4 > 0 And lVal2 > 0 Then 
		stMessage.sTitre		= "Contrôle de gestion"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "P234013"
		sPos	= "ALT_BLOC"				
	End If 

	If lVal > 0 And lVal4 > 0 And lVal5 > 0 And lVal3 <= 0 Then 
		stMessage.sTitre		= "Contrôle de gestion"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "P234014"
		f_Message ( stMessage )
	End If 		

End If
// [PM234-4_V1]

// [PC946_ORANGE_OPPRO]
F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",239)
sVal = lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "VARIANTE", ";")			
If Not bBloque And lDeb > 0 And sVal = "ORANGE_OPEN_PRO" Then

	lCodEtat	= idw_wSin.GetItemNumber ( 1, "COD_ETAT" )
	lVal = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount ())
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET') > 0", 1, idw_LstwCommande.RowCount ())

	If ( lCodEtat = 100 And lVal > 0 And lVal > lVal1 ) Or ( lCodEtat = 500 )  Or ( lCodEtat = 550 ) Then
			sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_CPT_DMDE" ) )
			sVal1 = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_SUIVI_IMEI" ) )				
			If ( IsNull ( sVal ) Or Long ( sVal ) = 0 ) Or Long ( sVal1 ) = 1 Then 
				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN750"
				sPos	= "ALT_BLOC"					
			End IF
	End If 
	
	lVal = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount ())
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET') > 0", 1, idw_LstwCommande.RowCount ())
	sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_CTRL_IMEI" ) )			
	
	If sVal <> "O" And lVal = lVal1 And lVal > 0 Then
		stMessage.sTitre		= "Contrôle de gestion"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN751"
		sPos	= "ALT_BLOC"					
	End If
End If

// [DT058]
If sPos="" Then
	If not uf_controlergestion_sanction_eco_usa( ) Then sPos="ALT_BLOC"
End if

// [RS_409_BLOC_WTE532], par la suite, commenter mais ne pas totalement supprimer, on sait jamais...
/*
	// [PC13371_72]
	If Not bBloque and sPos = "" and Not uf_getautorisation2( 208 ) Then
		lRowAss = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.Rowcount () )
		If lRowAss > 0 Then
			sIdCour = idw_LstInter.GetItemString ( lRowAss , "ID_COUR" )
			If sIdCour = "WTE352" Then
				Choose Case Trim ( Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) )
					Case "APPLE", "SAMSUNG"
						// autorisé
					Case Else
						stMessage.sTitre		= "Contrôle de gestion"
						stMessage.Icon			= Information!
						stMessage.bErreurG	= FALSE
						stMessage.sCode		= "WSIN761"
						sPos	= "ALT_BLOC"						
				End Choose
			End If
		End If
	End If
	// [PC13371_72]
*/

// [VDOC13226]
If sPos="" Then uf_controler_eco_msg_cg60( )
//	:[VDOC13226]

// [VDOC12845]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 255 )
If Not bBloque And lDeb <= 0 Then
	
	stPassData1.dwtab[1] = idw_LstInter
	stPassData1.dwtab[2] = idw_LstwCommande
	stPassData1.dwnorm[1] = idw_wDetail
	
	OpenWithParm ( w_t_resume_action_gestion, stPassData1 ) 
	stPassData1 = Message.PowerObjectParm

	If stPassData1.sTab [1] = "STOP" Then
		bMessage = FALSE
		sPos	= "ALT_BLOC"
	End If
	
End If
// /[VDOC12845]

// [PC13442-1]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 274 )
If lDeb > 0 Then
	If Not bBloque And sPos = "" Then	
		sPos = This.uf_ControlerGestion_MobilZen2 ()
	End If
End If		

// [DT339]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 297 )
If lDeb > 0 Then
	lRow=idw_LstwCommande.Find("ID_FOUR='CMA' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()) 
	If Not bBloque And sPos = "" And lRow > 0 Then
		iUoGsSpSinistre2.uf_controlergestion_carma(lRow)
	End if
End if
// :[DT339]

// [CTRLE_CARMA]
lRow = idw_LstwCommande.Find ( "ID_FOUR='CMA' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()) 
If lRow > 0 Then
	lIdGti = idw_LstwCommande.GetItemNumber ( lRow, "ID_GTI" ) 
	lIdDetail = idw_LstwCommande.GetItemNumber ( lRow, "ID_DETAIL" ) 
	lRow = idw_wDetail.find ( "ID_EVT = 1328 AND ID_GTI = " + String ( lIdGti ) + " AND ID_DETAIL = " + string ( lIdDetail ), 1, idw_wDetail.RowCount())
	If lRow > 0 Then
		Choose Case idw_wDetail.GetItemNumber ( lRow, "COD_ETAT" ) 
			Case 500
				// Ok
			Case Else
				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Exclamation!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN879"
				sPos	= "ALT_BLOC"
		End Choose 
	End If 
End If
// [CTRLE_CARMA]

//	[VDOC17959]
If Not bBloque And sPos = "" Then	
	sPos = This.uf_ControlerGestion_frais_compensation ()
End If

//	[VDOC18276]
If Not bBloque And sPos = "" Then	
	sPos = This.uf_ControlerGestion_a_rep_force ()
End If

// [PM330-1]
If Not bBloque And sPos = "" Then	
	
	// Présence répa irrép. ?
	lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_REPARER' AND COD_ETAT <> 'ANN' AND STATUS_GC IN ( 21, 23 )", 1, idw_LstwCommande.RowCount () )		
	
	// Présence réglement à l'assuré ?
	lVal2 = idw_LstInter.Find ( "COD_INTER = 'A' AND MT_A_REG >0", 1, idw_LstInter.RowCount () )

	// Le réglement est-il forcé ?
	If lVal2 > 0 Then
		dcMtARegFrais = idw_LstInter.GetItemDecimal ( lVal2, "MT_A_REG" ) 
		lIdI = idw_LstInter.GetItemNumber ( lVal2, "ID_I" ) 
		lVal21 =idw_wDetail.Find ( "COD_ETAT = 500 AND ID_I_REG = " + String ( lIdI ) + " AND ALT_REG = 'O'", 1, idw_wDetail.RowCount () )
	End If 
	
	// Présence Commande rempl ?
	lVal3 = idw_LstwCommande.Find ( &
				"COD_ETAT <> 'ANN' AND " + &
				"( ID_TYP_ART NOT IN ( 'DEV', 'AEF', 'CAS', 'SMS', 'BAM', 'ALE', 'ACC', 'PCM', 'MAI', 'REL', 'PST', 'RES', 'REA', 'PRS', 'EDI', 'RST' ) " + &
				"  OR " + &
				"  ( ID_TYP_ART = 'RST' AND POS ( INFO_SPB_FRN_CPLT, 'RST_CMDE+SUIVI=OUI' ) > 0 ) " + &
				") " + &
				" AND COD_ETAT = 'CNV' AND STATUS_GC NOT IN ( 176 )" &
				, 1, idw_LstwCommande.RowCount () ) 

	// PEC du rempl Forcée ?
	If lVal3 > 0 Then
		lIdGti = idw_LstwCommande.GetItemNumber ( lVal3, "ID_GTI" ) 
		lIdDetail = idw_LstwCommande.GetItemNumber ( lVal3, "ID_DETAIL" )
		
		lVal31 = idw_wDivDet.Find ( "ID_GTI = " + String ( lIdGti ) + " AND " + &
											 "ID_DETAIL = " + String ( lIdDetail ) + " AND " + &
											 "UPPER ( NOM_ZONE ) = 'ALT_PEC' AND " + &
											 "VAL_CAR = 'O'", 1, idw_wDivDet.Rowcount() )
											 
	End If 
	

	// Présence refus à réexp ?						
	lVal4 = idw_LstwCommande.Find ( "ID_REF_FOUR ='REFUSE_A_REEXP' AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.Rowcount() )
	
	// [PM330-1_MODIF]
	lVal5 = idw_LstwCommande.Find ( "ID_REF_FOUR ='PEC_A_RECYCLER' AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.Rowcount() )

	dcMtARegSin = idw_wSin.GetItemDecimal ( 1, "MT_A_REG" )
	
	// [PM330-1_MODIF]	
	// [ITSM430191] 
	If dcMtARegSin <> dcMtARegFrais And lVal1 > 0 And ( ( lVal2 > 0 And lVal21 <=0 ) Or ( lVal3 > 0 And lVal31 <= 0 ) ) And (( lVal4 > 0 And lVal5 <=0 ) Or ( lVal4 > 0 And lVal4 < lVal5 ) )Then
		sPos	= "ALT_BLOC"
		stMessage.sTitre = "Contrôle de gestion lié au PM330-1"			
		If lVal2 > 0 Then
			stMessage.bErreurG	= FALSE				
			stMessage.sCode = "WSIN797" 
		End If 

		If lVal3 > 0 Then
			stMessage.bErreurG	= FALSE				
			stMessage.sCode = "WSIN798" 
		End If 
	End If
End If

// [AUDIT_ASSUREUR_ELSA]
If Not bBloque And sPos = "" Then
	sPos = This.uf_ControlerGestion_AuditAssureurElsa ()
End If

// [ITSM374196]
If Not bBloque And sPos = "" And lCodEtat <> 900 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 37 )
	If lDeb > 0 Then
		sVal = Trim ( idw_wSin.GetItemString ( 1, "ID_CONTRAT_ABONNE" ))
		If IsNull ( sVal ) Or sVal = "" Then
			bOk = False
			stMessage.sTitre		= "Abscence n° contrat c-Discount"
			stMessage.Icon		= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WGAR291"
			sPos	= "ALT_BLOC"									
		End If
	End If
End If

// [ITSM374196]
If Not bBloque And sPos = "" And lCodEtat <> 900 Then
	sVal = Trim ( idw_wSin.GetItemString ( 1, "NOM" )) + Trim ( idw_wSin.GetItemString ( 1, "PRENOM" ))
	If IsNull ( sVal ) Or sVal = "" Then
		bOk = False
		stMessage.sTitre		= "Nom ou Prénom vide"
		stMessage.Icon		= Information!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sCode		= "WSIN801"
		sPos	= "ALT_BLOC"									
	End If
End If

// [DT262]
// [DT262]
If Not bBloque And sPos = "" Then
	sPos = This.uf_ControlerGestion_InterdireReglPresta ()
End If

// [DT262] Gestion des vieux Orange, CRAO ancienne méthode
If Not bBloque And sPos = "" Then	
	// [DT262]
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 308 )
	If lDeb > 0 Then 
		sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_CTRL_IMEI" ) )
		sNumImeiPort = Trim ( Upper ( idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) ) )
		sCraSuiviImei = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_SUIVI_IMEI" ) )
		
		If ( sNumImeiPort = "" Or IsNull ( sNumImeiPort ) ) And ( sVal = "O" Or sCraSuiviImei = "2" ) Then
			bOk = False
			stMessage.sTitre		= "Contrôle IMEI"
			stMessage.Icon		= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WSIN806"
			sPos	= "ALT_BLOC"				
		End If
	End If
	
	// [ITSM437534]
	If lDeb > 0 Then 
		sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "CONTESTATION" ) )
		sNumImeiPort = Trim ( Upper ( idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) ) )
		
		If ( sNumImeiPort = "" Or IsNull ( sNumImeiPort ) ) And ( sVal = "O" ) Then
			bOk = False
			stMessage.sTitre		= "Contrôle IMEI"
			stMessage.Icon		= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WSIN810"
			sPos	= "ALT_BLOC"				
		End If
	End If			

End If

If idw_wRefus.Rowcount () <= 0 And idw_wsin.GetItemNumber ( 1, "COD_ETAT" ) = 200 Then
	bOk = False
	stMessage.sTitre		= "Bug technique"
	stMessage.Icon		= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "WSIN803"
	sPos	= "ALT_BLOC"									
End If

If isReferentielApp = "IFR" And sPos = "" Then

	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 150 )
	If lDeb <= 0 Then
		sMarqApp = idw_WSin.GetItemString ( 1 , "MARQ_PORT" ) 
		sModlApp = idw_WSin.GetItemString ( 1 , "MODL_PORT" ) 
		SQLCA.PS_S_SAGA2_INTERRO_IFR ( sMarqApp, sModlApp, dcPrixPublicIFR ) // Rien à voir avec SAGA2, c'est juste une interro IFR

		dcPrixPublicDS = Dec ( Trim ( This.uf_GestOng_Divers_Trouver ( "MT_VAL_PUBLIQUE" ) ) )
		If IsNull ( dcPrixPublicDS ) Then dcPrixPublicDS = 0
		
		If IsNull ( dcPrixPublicIFR ) Then dcPrixPublicIFR = 0
		
		If dcPrixPublicIFR > 0 And dcPrixPublicDS > 0 And dcPrixPublicIFR > dcPrixPublicDS Then
			stMessage.sTitre		= "Saisie de sinistre"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WSIN811"
			stMessage.sVar[1] 	= String ( dcPrixPublicDS )		
			stMessage.sVar[2] 	= String ( dcPrixPublicIFR )
			F_Message ( stMessage )
		End IF
	End If 		
End If

// [ITSM456410] 
If Not bBloque And sPos = "" And idw_wsin.GetItemNumber ( 1, "COD_ETAT" ) <> 900 Then	
	If not uf_ControlerGestion_Typ_App_ds( "CTRLE" ) Then sPos="ALT_BLOC"		
End IF

// [DT288-1_LOT2]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 315)
If lDeb > 0 Then
	dtDtePivotDT288-1_LOT2 = DateTime ( lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DTE_PIVOT_DT288_1_LOT2", ";") )

	// [DT288-1][MODIF_CHRISTINE]
	bBlocageGeoloc = lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BLOCAGE_GEOLOC", ";")  = "OUI"
	sVal = ""
	
	lRow = idw_wdivsin.Find("UPPER(NOM_ZONE)='GEOLOC_SIMPA2'", 1, idw_wdivsin.RowCount())
	If lRow > 0 Then
		sVal1 = idw_wdivsin.GetItemString (lRow, "VAL_CAR") 
		If IsNull ( sVal1 ) or Trim ( sVal1 ) = "" Then sVal1 = "N"
	End If

	lVal = idw_wsin.GetItemNumber ( 1, "COD_ETAT" ) 

	lVal31 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'ALT_PEC' AND VAL_CAR = 'O'", 1, idw_wDivDet.Rowcount() )
	lVal21 =idw_wDetail.Find ( "COD_ETAT = 500 AND ALT_REG = 'O'", 1, idw_wDetail.RowCount () )

	// Condition d'appel du WS revu avec Hélène par rapport à la NDC
	// [DT288-1][MODIF_CHRISTINE]
	If ( ( sVal = "ORANGE_V3BIS" OR sVal = "ORANGE_V3TER" ) &
		  Or &
		  ( bBlocageGeoloc ) &
		) &
		And &
		sMarq = "APPLE" And & 
		sTypApp = "TEL" And &
		dtCreeLeDos >= dtDtePivotDT288-1_LOT2 And &
		( lVal = 500 or lVal = 600 Or idw_LstwCommande.RowCount () > 0  ) And &
		sVal1 = "O" and &
		lVal31 <= 0 And &
		lVal21 <= 0 &
		Then
			bOk = False
			stMessage.sTitre		= "Appareil géolocalisté"
			stMessage.Icon		= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WSIN813"
			sPos	= "ALT_BLOC"	

	End If
End If

// [DT330]
sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "PCE_ILLISIBLE_CASTO" ) )	
If sVal = "O" Then
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'pce_mail_casto'", 1,  idw_WDivSin.RowCount () ) 
	If lRow > 0 Then 
		This.uf_gestong_divers_majzone( "PCE_MAIL_CASTO", lRow, K_MAJZONE, "O" )
	End If		
End If 

// [DT288-4]
If Not bBloque And sPos = "" Then
	If Not This.uf_ControlerGestion_RefAReexp_Cordon ( ) Then sPos = "ALT_BLOC"
End If 

// [PM445-1]
If Not bBloque And sPos = "" Then
	If Not This.uf_ControlerGestion_PM445 () Then 
		sPos = "ALT_BLOC"
		bMessage = False
	End If 
End If 

// [PM445-1]
If Not bBloque And sPos = "" Then
	This.uf_ControlerGestion_RedrBtqCentralPSM ()
End If 

// [DT424]
/*
If F_CLE_A_TRUE ( "DT424" ) Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 268 )
	If lDeb > 0 Then

		// J'ai repris la partie suivante de uf_validation_finale_mail_ctl_imei
		// pour savoir si le mail partiras ou pas
		If lnvString.of_getkeyvalue(idw_detpro.GetItemString(lDeb,"VAL_CAR"), "CONTESTATION_UNIQT",";") <> "OUI" Then
			bEnvoyer=(uf_gestong_divers_trouver( "CRA_CTRL_IMEI") = "O")
		End if
		
		If not bEnvoyer Then
			lRow=idw_wdivsin.Find("Upper(NOM_ZONE)='CONTESTATION' And CPT_VALIDE <=0 And VAL_CAR='O'", 1, idw_wdivsin.rowcount( ))
			bEnvoyer=(lRow > 0)
		End if
		// Fin de reprise
		
		// S'il est suceptible de partir par la suite, je déclenche alors mes propres contrôle.
		If bEnvoyer Then
			lVal = idw_LstwCommande.Find ( "ID_REF_FOUR = 'CONTEST_IMEI' AND COD_ETAT NOT IN ( 'ECT' )", 1, idw_LstwCommande.RowCount() )			
			If lVal > 0 Then
				bOk = False
				stMessage.sTitre		= "Contestation déjà en cours..."
				stMessage.Icon		= Information!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= OK!
				stMessage.sCode		= "WSIN846"
				sPos	= "ALT_BLOC"				
			End If 
			
		End IF 

	End If 
End If
*/

// [PM462-1][V3]
/*
If F_CLE_A_TRUE ( "PM462-1" ) Then
	if	not bBloque and sPos = "" then
	
		bLock = uf_ControlerGestion_RembFranchiseCB ()
	
		if bLock then
			sPos = "ALT_BLOC"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= false
			stMessage.sCode		= "WSIN847"
		end if				
	end if
End If
*/

// [PC192290]
if	not bBloque and sPos = "" then	
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 345)
	If lDeb > 0 Then
		
		// [RS5656_MOD_PCE_DIF]
		// Determination de la Méthode  // [RS5656_MOD_PCE_DIF]
		sModeFctDp345 = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "MODE_FCT", ";")
		If sModeFctDp345 = "" Then sModeFctDp345 = "UNIQUE"

		// /[RS5656_MOD_PCE_DIF]
		
		sChainePce = ""
		lTotPce = gdsPieceSherpa.RowCount () 
		If lTotPce > 0 Then

			For lCptPce = 1 To lTotPce
				If gdsPieceSherpa.GetItemNumber ( lCptPce, "ID_I" ) <> 0 Then Continue
				iIdPce = gdsPieceSherpa.GetItemNumber ( lCptPce, "ID_PCE" ) 

				// [RS5656_MOD_PCE_DIF]
				iIdGtiPce = gdsPieceSherpa.GetItemNumber ( lCptPce, "ID_GTI" ) 
				iIdDetailPce = gdsPieceSherpa.GetItemNumber ( lCptPce, "ID_DETAIL" ) 
				
				If iIdGtiPce > 0 Then
					sChainePce += "Garantie (" + String ( iIdGtiPce ) + ") " + SQLCA.FN_CODE_NUM ( iIdGtiPce, "-GA" ) + "/"						
				End If 

				If iIdDetailPce >= 0 Then
					lRowIdEvtPce = idw_wDetail.Find ( "ID_GTI = " + String ( iIdGtiPce ) + " AND ID_DETAIL = " + String ( iIdDetailPce ), 1,  idw_wDetail.RowCount()) 
					If lRowIdEvtPce > 0 Then
						iIdEvtPce = idw_wDetail.GetItemNumber ( lRowIdEvtPce, "ID_EVT" ) 
						If iIdEvtPce > 0 Then
							sChainePce += "Détail (" + String ( iIdDetailPce ) + ") Evt ( " + String ( iIdEvtPce ) + ") "  + SQLCA.FN_CODE_NUM ( iIdEvtPce, "+EV" ) + "/"						
						End IF 
					End IF 
				End If 

				sChainePce += "Pièce (" + String ( iIdPce ) + ") " + SQLCA.FN_CODE_NUM ( iIdPce, "+PC" ) + " => "
				sEtatPce = gdsPieceSherpa.GetItemString ( lCptPce, "ETAT_PCE" ) 
				sChainePce += SQLCA.FN_CODE_CAR ( sEtatPce, "-WJ" )

				// [RS5656_MOD_PCE_DIF]
				Choose Case sModeFctDp345 
					Case "UNIQUE"
						lRow = idw_wpiece.Find ( "ID_PCE = " + String ( iIdPce ) + " AND ALT_RECLAME = 'O' AND ID_I = 0", 1, idw_wpiece.RowCount () )
					Case "DET_GARANTIE"
						lRow = idw_wpiece.Find ( "ID_GTI = " + String ( iIdGtiPce ) + " AND ID_DETAIL = " + String ( iIdDetailPce ) + " AND ID_PCE = " + String ( iIdPce ) + " AND ALT_RECLAME = 'O' AND ID_I = 0", 1, idw_wpiece.RowCount () )
				End Choose 
				
				If lRow > 0 Then
					sChainePce += ", " + SQLCA.FN_CODE_CAR ( "PRL", "-WJ" )
				End If 
				
				sChainePce = sChainePce + Char ( 10 )
				
			Next 
		End If 

		lTotPce = idw_wPiece.RowCount () 
		If lTotPce > 0 Then
			
			For lCptPce = 1 To lTotPce
				
				If idw_wPiece.GetItemNumber ( lCptPce, "ID_I" ) <> 0 Then Continue

				iIdPce = idw_wPiece.GetItemNumber ( lCptPce, "ID_PCE" ) 				
				
				// [RS5656_MOD_PCE_DIF]
				iIdGtiPce = idw_wPiece.GetItemNumber ( lCptPce, "ID_GTI" ) 
				iIdDetailPce = idw_wPiece.GetItemNumber ( lCptPce, "ID_DETAIL" ) 

				Choose Case sModeFctDp345 
					Case "UNIQUE"
						lRow = gdsPieceSherpa.Find ( "ID_PCE = " + String ( iIdPce ) + " AND ID_I = 0", 1, gdsPieceSherpa.RowCount () )					
					Case "DET_GARANTIE"
						lRow = gdsPieceSherpa.Find ( "ID_GTI = " + String ( iIdGtiPce ) + " AND ID_DETAIL = " + String ( iIdDetailPce ) + " AND ID_PCE = " + String ( iIdPce ) + " AND ID_I = 0", 1, gdsPieceSherpa.RowCount () )					
				End Choose 
				
				If lRow > 0 Then continue
						
				// [RS5656_MOD_PCE_DIF]
				If iIdGtiPce > 0 Then
					sChainePce += "Garantie (" + String ( iIdGtiPce ) + ") " + SQLCA.FN_CODE_NUM ( iIdGtiPce, "-GA" ) + "/"						
				End If 

				If iIdDetailPce >= 0 Then
					lRowIdEvtPce = idw_wDetail.Find ( "ID_GTI = " + String ( iIdGtiPce ) + " AND ID_DETAIL = " + String ( iIdDetailPce ), 1,  idw_wDetail.RowCount()) 
					If lRowIdEvtPce > 0 Then
						iIdEvtPce = idw_wDetail.GetItemNumber ( lRowIdEvtPce, "ID_EVT" ) 
						If iIdEvtPce > 0 Then
							sChainePce += "Détail (" + String ( iIdDetailPce ) + ") Evt ( " + String ( iIdEvtPce ) + ") "  + SQLCA.FN_CODE_NUM ( iIdEvtPce, "+EV" ) + "/"						
						End IF 
					End IF 
				End If 

				sChainePce += "Pièce (" + String ( iIdPce ) + ") " + SQLCA.FN_CODE_NUM ( iIdPce, "+PC" ) + " => "					
					
				sChainePce += SQLCA.FN_CODE_CAR ( "PRL", "-WJ" )				
				
				sChainePce = sChainePce + Char ( 10 )
				
			Next 
		End If 	

		If sChainePce <> "" Then

			stMessage.sTitre		= "Action sur les demandes de pièces"
			stMessage.Icon		= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= YESNO!
			stMessage.sVar[1]    = sChainePce
			stMessage.sCode		= "WSIN851"

			If F_Message ( stMessage ) <> 1 Then
				bOk = False
				sPos	= "ALT_BLOC"
				stMessage.Icon		= Information!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= Ok!
				stMessage.sCode		= "WSIN852"
			End If 
			
		End If 
	End If 	
End If 


// [DT458]
If Not bBloque And Not This.uf_ControlerGestion_DT458 () Then
	sPos = "ALT_BLOC"
End If 

// [DT472]
lTotRefus = idw_wRefus.RowCount ()
lIdNatSin = idw_wSin.GetItemNumber ( 1, "ID_NATSIN" )
sValCtrle = Trim ( uf_GestOng_Divers_Trouver ("RESIL_AUTO_ADH") )

If IsNull ( sValCtrle ) Then sValCtrle = "N"		
	
// Cas spécial unique du 1749 où ce n'est pas un "REFUSE" qui déclenche la resil.
// On sait qu'à la prochaine décla le 1749 se déclenchera donc on résilie à la fin de l'instruction
// de ce dossier, cas détecté et coché à partir de la garantie.
If sValCtrle = "O" Then 
	lTotRefus = 1
	lIdMotif = 1749
	If idw_LstGti.RowCount () > 0 Then
		lIdGti = idw_LstGti.GetItemNumber ( 1, "ID_GTI" )
	End If 
End IF  


For lCptRefus = 1 To lTotRefus 

	If sValCtrle <> "O" Then
		lIdGti = idw_wRefus.GetItemNumber ( lCptRefus, "ID_GTI" )
		lIdMotif = idw_wRefus.GetItemNumber ( lCptRefus, "ID_MOTIF" )
	End If 
	
	bResil = Uf_Decoder_DP347 ( lIdGti, lIdNatSin, lIdMotif, sLibMemoire, FALSE, iCodResilAdh ) 

	If bResil Then

		stMessage.sTitre		= "Résiliation adhésion"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= YESNO!
		
		If sValCtrle <> "O" Then
			stMessage.sVar[1]    = sLibMemoire
			stMessage.sVar[2]    = String ( lIdMotif ) 
			stMessage.sCode		= "WSIN864"
		Else 
			stMessage.sCode		= "WSIN865"				
		End If

		If F_Message ( stMessage ) = 2 Then
			sPos = "ALT_BLOC"
			stMessage.sCode = "GENE184"								
		End If 
		
		Exit
		
	End If
Next 
	
/*------------------------------------------------------------------*/
/* Affichage de la chaîne correspondant au message d'erreur         */
/*------------------------------------------------------------------*/
If	sPos <> "" Then

	// [PM103][1]
	If bMessage Then
		F_Message ( stMessage )
	End If
	// :[PM103][1]

	If	Not IsNull ( sOng ) And iuoOng.Uf_RecupererOngletCourant () <> sOng Then
		sOng = "04"
	End If
/*------------------------------------------------------------------*/
/* S'il n'existe aucun courrier dans W_COURRIER, on va directement  */
/* positionner le dossier en VALIDATION. On affiche un message au   */
/* gestionnaire pour lui demander s'il est d'accord avec cette      */
/* décision.                                                        */
/*------------------------------------------------------------------*/
Else
	lCodEtat			= idw_wSin.GetItemNumber ( 1, "COD_ETAT" )
	lTotCourrier 	= idw_wCourrier.RowCount ()

	ibAltCourrier  = ltotCourrier > 0

	If	lCodEtat <> 1 And idw_wCourrier.RowCount () = 0 Then

		// On n'affichage pas ce message en téléphonie ( perte de temps )
		// [VDOC13534] 208
		If Not ibAltTelephonie And Not This.uf_GetAutorisation2 ( 208 ) Then 
			stMessage.sTitre		= "Contrôle de saisie du sinistre"
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE

			If Not ibSaisieValidation Then  
				stMessage.sCode		= "WSIN270"  // SEV
			Else
				stMessage.sCode		= "WSIN271"  // SVE
			End If 

			stMessage.bouton		= YesNo!

			iRet = F_Message ( stMessage )
			If	iRet = 2 Then
				sPos	= "ALT_BLOC"
				sOng	= "01"
			End If
		End If
	End If

End If

// [PM506-1]
If Not bBloque And sPos = "" Then
	// On n'exploite volontairement pas le retour.
	sPos = This.uf_ControlerGestion_PM506 ()
End IF 

// [VDOC29906]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 357 )
If lDeb > 0 Then
	dteSurv= idw_WSin.getItemDateTime( 1, "DTE_SURV")
	dteDecl= idw_WSin.getItemDate( 1, "DTE_DECL")

	If F_PLUS_DATE ( Date (dteSurv), 7, "M" ) < Date ( DteDecl ) Then
		bFin = False
		Do While Not bFin
			stMessage.sTitre		= "vDoc29906 : Info importante"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= YESNO!
			stMessage.sCode		= "WSIN868"
			If F_Message ( stMessage ) = 1 Then bFin = TRUE
		Loop
	End IF 
End IF 

// [RS1216]
lDeb = idw_LstwCommande.Find("ID_FOUR = 'ELD' AND COD_ETAT = 'CNV' AND MT_TTC_CMDE <= 0", 1, idw_LstwCommande.rowCount()+1)	
If lDeb > 0 Then
	stMessage.sTitre		= "Carte Cadeau ElectroDepot"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= Ok!
	stMessage.sCode		= "WSIN877"
	sPos = "ALT_BLOC"
	F_Message ( stMessage ) 
End IF 

// [PC202553_SELECTRA]
If Not bBloque And sPos = "" Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 348 )
	If lDeb > 0 Then
		
		// [NVX_MSG_SELECTRA]
		sVal = uf_GestOng_Divers_Trouver ( "FRANCHISE_PAYBOX" ) 
		sVal1 = uf_GestOng_Divers_Trouver ( "MT_FRANCHISE_PAYBOX" ) 
		lCodEtat	= idw_wSin.GetItemNumber ( 1, "COD_ETAT" )
		
		If sVal = "O" and dec ( sVal1 ) > 0 And lCodEtat = 200 Then
			stMessage.sTitre		= "ATTENTION ! vous refusez !"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= YESNO!
			stMessage.sCode		= "WSIN881"

			If F_Message ( stMessage ) = 2 Then sPos = "ALT_BLOC"

		End If 		
	End If 
End If


// [RS2980_IFR]
If sPos = "" And gsCodeRetPrixIfr = "URGE" Then
	/*lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () ) + &
			  idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	If lVal1 > 0 Then */
		bFin = False
		Do While Not bFin
			stMessage.sTitre		= "RS2980 : Prix IFR à revoir"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= YESNO!
			stMessage.sCode		= "WSIN882"
			
			stMessage.sVar[1]    = sMarq 
			stMessage.sVar[2]    = sModl
			
			If Time (Today()) < 14:00:00 Then
				stMessage.sVar[3] = "aujourd'hui"
				stMessage.sVar[4] = "15"									
			Else
				stMessage.sVar[3] = "demain"
				stMessage.sVar[4] = "10"									
			End If							
							
			If F_Message ( stMessage ) = 1 Then bFin = TRUE
			sPos	= "ALT_BLOC"
		Loop
	// End If 
End If 

// [PMO89_RS4822]
If Not bBloque And sPos = "" Then
	sPos = This.uf_ControlerGestion_InterAssureur ( )	
End IF 

// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	If Not bBloque And sPos = "" Then
		sPos = iUoGsSpSinistre2.uf_controlergestion_Hub_Prestataire ( )
	End IF 
End If

// [MIG1_COUR_EMAILING]
If F_CLE_A_TRUE ( "MIG1_COUR_EMAILING" ) Then
	If Not bBloque And sPos = "" Then	
		sPos = iUoGsSpSinistre2.uf_controlergestion_EmailingKSL ()
	End If 
End If

// [TRT_APRES_COMMIT][PMO268_MIG48]

If F_CLE_A_TRUE ( "TRT_APRES_COMMIT" ) Then
	If Not bBloque And sPos = "" Then		
		lRow = idw_LstwCommande.Find ( "ID_FOUR = 'BTE' AND ID_TYP_ART = 'CAF' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount () ) 
		If lRow > 0 Then
			stMessage.Icon		   = Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= Ok!
	
			sVal = idw_WSin.GetItemstring ( 1, "ID_CONTRAT_ABONNE" )		
			
			If IsNull ( sVal ) Or Trim ( sVal ) = "" Or Not IsNumber ( sVal ) Then
				sPos	= "ALT_BLOC"
				stMessage.sCode	= "WSIN920"		
				F_Message ( stMessage )
			End If 
			
			lRow = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.Rowcount () )
			sAdrMail = idw_LstInter.GetItemString ( lRow, "ADR_MAIL" )
	
			If IsNull ( sAdrMail ) Or Trim ( sAdrMail ) = "" Then
				sPos	= "ALT_BLOC"
				stMessage.sCode	= "WSIN921"		
				F_Message ( stMessage )			
			End If 
			
		End If 
	End If 		
End IF 

// [MIG19_PSPLAF_SAGA2]
If F_CLE_A_TRUE ( "MIG19_PSPLAF_SAGA2" ) Then
	If Not bBloque And sPos = "" Then	
		sPos = iUoGsSpSinistre2.uf_controlergestion_Deja_Indemnise ()
	End If 
End If

// [MIG165_BOUYGUES]
If F_CLE_A_TRUE ( "MIG165_BOUYGUES" ) Then
	If Not bBloque And sPos = "" Then	
		sPos = iUoGsSpSinistre2.uf_controlergestion_Bouygues ()
	End If 
End If


ib2EmeTourPI052 = False
astPass.sTab [ 1 ] = sPos



end subroutine

private subroutine uf_terminervalider (ref s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_TerminerValider (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 10:49:34
//* Libellé			: 
//* Commentaires	: Fin de la validation
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* #2		   JFF		05/09/2002 Gestion de la gestion de contact uniquement pour Sherpa
//* #3			JFF		16/03/2004 DCMP 040020 SVE
//* #4			JFF      10/04/2006 Migration PB8-SPB-04/2006 - Ajout arg sur PostEvent
//* #5         MADM     31/07/2006 Projet DNTMAIL1/2 Mails sortant en remplacement des courriers
//* #6 			DGA      19/09/2006 Gestion d'un répertoire temporaire DCMP-060643
//* #7			JCA		08/03/2007 DCMP 070161 - Amelioration process DNT - Autorisation de validation avec réglement
//* #8			JFF		08/03/2007 DCMP 070161 - Modif JF suite erreur d'analyse, il est mieux de tester le "MT_A_REGLER > 0"
//*													 Afind de prendre en compte les frais interlocuteurs
//* #9         JFF      21/05/2008 Appel nouvel fonction pour redresser BUg w_para_plafond
//*            JFF      13/12/2010 [DECIMAL_PAPILLON]
//* 				JFF		14/09/2011 [PM72] 
//				   FPI	   12/07/2012	[ITSM120961] problème de maj de "dw_w_div_det"
//       		JFF   	09/09/2022 [PM80_FA12_FRANEX]
//*-----------------------------------------------------------------


String sTab [], sSVE, sBIN, sSql, sVal
Boolean bRet, bVal, bValAuto, bValidation
bRet = True
Long dcIdSin
dcIdSin = idw_wSin.GetItemNumber ( 1, "ID_SIN" )


// #7
string sRech
long lTotDetail, lLigDet
// FIN - #7

// #8
Boolean bMtAReg
// Fin #8

/*------------------------------------------------------------------*/
/* #3                                                               */
/*------------------------------------------------------------------*/
If ibSaisieValidation Then
	sSVE = "SVE"
Else
	sSVE = ""
End If

/*------------------------------------------------------------------*/
/* Mise à jour des INTERLOCUTEURS.                                  */
/*------------------------------------------------------------------*/
This.uf_TerminerValider_Inter ()
If	idw_LstInter.Update () < 0 Then bRet = False

/*------------------------------------------------------------------*/
/* Mise à jour de W_PARA_INFO.                                      */
/*------------------------------------------------------------------*/
If	bRet	Then	
	If	idw_wParaInfo.Update () < 0 Then bRet = False
End If
		
/*------------------------------------------------------------------*/
/* Mise à jour de W_FRAIS.                                          */
/*------------------------------------------------------------------*/
If	bRet	Then	
	If	idw_wFrais.Update () < 0 Then bRet = False
End If

/*------------------------------------------------------------------*/
/* Mise à jour de W_GAR_SIN.                                        */
/*------------------------------------------------------------------*/
If	bRet	Then	
	If	idw_LstGti.Update () < 0 Then bRet = False
End If

/*------------------------------------------------------------------*/
/* Mise à jour de W_DETAIL.                                         */
/*------------------------------------------------------------------*/
If	bRet	Then	
	If	idw_wDetail.Update () < 0 Then bRet = False
End If

/*------------------------------------------------------------------*/
/* Mise à jour de W_PIECE.                                          */
/*------------------------------------------------------------------*/
If	bRet	Then	
	If	idw_wPiece.Update () < 0 Then bRet = False
End If

/*------------------------------------------------------------------*/
/* Mise à jour de W_REFUS.                                          */
/*------------------------------------------------------------------*/
If	bRet	Then
	
	If idw_wRefus.Rowcount () <= 0 And idw_wsin.GetItemNumber ( 1, "COD_ETAT" ) = 200 Then
	  sSql = "Exec sysadm.PS_S01_MAIL 'jff@spb.fr,fpinon@spb.eu', "  +&
	  "'Etat refusé sans motif de refus, sinistre " + String ( idw_wsin.GetItemNumber ( 1, "ID_SIN")) + "', " + &
	  "'Etat refusé sans motif de refus, sinistre " + String ( idw_wsin.GetItemNumber ( 1, "ID_SIN")) + ", " + stGlb.sCodOper + "', " + &
	  "'Mouchard Refus PB'"		    + ", " + &
	  "''"			 		 + ", " + &
	  "null"   				 		 + ", " + &
	  "null"   				 		 + ", " + &
	  "null"   				 		 + ", " + &
	  "null"   				 		 + ", " + &
	  "null"

		F_execute ( sSql, SQLCA )
		
		bRet = FALSE

	End If 
	
	If	idw_wRefus.Update () < 0 Then bRet = False
End If

/*------------------------------------------------------------------*/
/* Mise à jour de W_PARA_PLAFOND.                                   */
/*------------------------------------------------------------------*/
If	bRet	Then	
	This.uf_correction_bug_w_para_plafond () // #9
	If	idw_wParaPlafond.Update () < 0 Then bRet = False
End If

/*------------------------------------------------------------------*/
/* Mise à jour de W_COMMANDE.                                       */
/*------------------------------------------------------------------*/
If	bRet	Then	
	If	idw_LstwCommande.Update () < 0 Then bRet = False
End If

/*------------------------------------------------------------------*/
/* Mise à jour de W_DIV_DET.                                       */
/*------------------------------------------------------------------*/
If	bRet	Then	
	// [ITSM120961]
	// Parfois le filtre est encore sur cette dw
	idw_wDivDet.SetFilter("")
	idw_wDivDet.Filter()
	If	idw_wDivDet.Update () < 0 Then bRet = False
End If

/*------------------------------------------------------------------*/
/* Mise à jour de W_DIV_SIN.                                        */
/*------------------------------------------------------------------*/
If	bRet	Then	
	This.uf_TerminerValider_wDivSin ()	
	bRet = This.uf_TerminerValider_wDivSin_CasPart ()
	If bRet Then
		If	idw_wDivSin.Update () < 0 Then bRet = False
	End If
End If

/*--------------------------------------------------------------------------*/
/* Suppression des commandes non validées des TABLES  W_DIV_SIN et DIV_SIN. */
/* MADM Le 21/04/2005.																		 */	
/*--------------------------------------------------------------------------*/


idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV'" )
idw_LstwCommande.Filter ( )

// [DECIMAL_PAPILLON]
If idw_LstwCommande.Rowcount ( ) <= 0 Then
   sSql = "Exec sysadm.PS_D02_W_DIV_SIN_TRACE " + String ( dcIdSin ) + "."
	F_Execute ( sSql, SQLCA )
	bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDbCode = 0 
End If

idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ( )
idw_LstwCommande.Sort ( )


/*------------------------------------------------------------------*/
/* Mise à jour de CONTACT.                                     	  */
/* JFF Le 30/04/2001.															  */
/*------------------------------------------------------------------*/
If	bRet And ibaltContact Then
	bRet = idw_LstContact.Update () > 0
End If

/*------------------------------------------------------------------*/
/* Mise à jour de DOS_SUIVI_PAR (sur 'routage').                 	  */
/* JFF Le 30/04/2001.															  */
/*------------------------------------------------------------------*/
/* #2 : JFF le 04/09/2002														  */
/*------------------------------------------------------------------*/
If	bRet And ( ibAltContact Or ibAltContactSherpa ) Then
	bRet = idw_DosSuiviPar.Update () > 0
End If


/*------------------------------------------------------------------*/
/* Mise à jour de W_REG_GTI.                                        */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Avant toute chose, on va supprimer tous les enregistrements      */
/* précédents                                                       */
/*------------------------------------------------------------------*/
If	bRet	Then
	itrTrans.DW_D01_W_REG_GTI ( dcIdSin )
	bRet = F_Procedure ( stMessage, itrTrans, "DW_D01_W_REG_GTI" )
End If

If	bRet	Then	
	If	idw_wRegGti.Update () < 0 Then bRet = False
End If

// [PM80_FA12_FRANEX]
If	idw_wreg_frais_annexe_frn.Update () < 0 Then bRet = False

/*------------------------------------------------------------------*/
/* Mise à jour de W_COURRIER.                                       */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Avant toute chose, on va supprimer tous les courriers existants  */
/* de W_COURRIER.                                                   */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Cette action a pour effet de supprimer tous les courriers du     */
/* sinistre, ainsi que toutes les compositions lièes à ce sinistre  */
/* dans W_INTER_BLOB. (ID_TYP_BLOB = 'DT')                          */
/*------------------------------------------------------------------*/
If	bRet	Then	
	itrTrans.DW_D01_W_COURRIER ( dcIdSin, sSVE )
	bRet = F_Procedure ( stMessage, itrTrans, "DW_D01_W_COURRIER" )
/*------------------------------------------------------------------*/
/* On vient d'armer la structure de Message dans la fonction        */
/* F_Procedure, mais on ne l'affiche pas tout de suite.             */
/*------------------------------------------------------------------*/
End If

/*----------------------------------------------------------------------------*/
/* L'édition est-elle cochée sur le sinistre ?                                */
/*----------------------------------------------------------------------------*/
If idw_wsin.GetItemString ( 1, "ALT_EDIT" ) = "N" Then
	itrTrans.DW_D02_W_COURRIER ( dcIdSin, sSVE )
	
	// Cela afin de passer en cod_etat = 5 Action 1 sur ue_majaccueil
   idw_wCourrier.Reset ()
	ibAltCourrier = False

	bRet = F_Procedure ( stMessage, itrTrans, "DW_D02_W_COURRIER" )
Else
	/*------------------------------------------------------------------*/
	/* Mise à jour de W_COURRIER.                                       */
	/*------------------------------------------------------------------*/
	If	bRet	Then	

		This.uf_TerminerValider_WCourrier ()

		If	idw_wCourrier.Update () < 0 Then bRet = False
	End If

	/*------------------------------------------------------------------*/
	/* Mise à jour de W_INTER_BLOB.                                     */
	/*------------------------------------------------------------------*/
	/* #3 SVE																			  */
	/*------------------------------------------------------------------*/
	If	bRet	Then
		If ibSaisieValidation Then
			bRet = iDwStkWCourBlobSve.Update () > 0 
			
		Else
			bRet = Uf_Enregistrer_W_Inter_Blob_Data ()
		End If 
	End If
	
End If


/*------------------------------------------------------------------*/
/* On ecrit une trace pour l'adresse si besoin.                     */
/*------------------------------------------------------------------*/
If	bRet	Then
	Uf_EcrireTrace_Adresse ()
End If

// [PM72]
glIdSinMemPM72 = 0

/*------------------------------------------------------------------*/
/* Pas de courriers, ouvre-t-on la fenêtre de validation ?			  */
/*------------------------------------------------------------------*/
/* #3 pour la SEV																	  */
/*------------------------------------------------------------------*/
If Not ibSaisieValidation Then
	If bRet And Not ibAltCourrier And ibAltOuvFenVal And idw_wsin.GetItemNumber ( 1, "COD_ETAT" ) > 1 Then
		stGlb.sMessageErreur = String ( iDw_wSin.GetItemNumber ( 1, "ID_SIN" ) )
		idw_wSin.PostEvent ( "ue_Ouvrir_FenValidation", 1, 0 ) // #4
	End If
/*------------------------------------------------------------------*/
/* #3 pour la SVE																	  */
/*------------------------------------------------------------------*/
Else
	/*----------------------------------------------------------------------------------------------*/
	/* #5 : Ajout du paramétre -1 de l'interlocuteur suite modif  de la fonction uf_GetAutorisation */
	/*----------------------------------------------------------------------------------------------*/
	This.uf_GetAutorisation ( "", sBIN, bVal, bValAuto, bValidation, -1 )
	
	// #7
	// si au moins 1 detail est dans l'etat "à régler" (CodEtat = 500)
	// si refus de validation avec réglement 
/* #8
	lTotDetail	= idw_wDetail.RowCount ()
	sRech = "COD_ETAT = 500"
	lLigDet = idw_wDetail.Find ( sRech, 1, lTotDetail )
	Fin #8
*/	
	// FIN - #7

	// #8
	bMtAReg = idw_wSin.GetItemDecimal ( 1, "MT_A_REG" ) > 0 
	// Fin #8

	
	If bRet And idw_wsin.GetItemNumber ( 1, "COD_ETAT" ) > 1 And bValAuto And bValidation Then
		stGlb.sMessageErreur = String ( iDw_wSin.GetItemNumber ( 1, "ID_SIN" ) )
		
// #8		If	lLigDet > 0 and Mid (sBin, 17, 1 ) = '0' Then // #7
		If	bMtAReg and Mid (sBin, 17, 1 ) = '0' Then // #7		
			// on ne passe pas automatique en phase de validation finale
		Else
			idw_wSin.PostEvent ( "ue_Ouvrir_FenValidation", 1, 0 ) // #4
		End If
		
	End If
End If

/*------------------------------------------------------------------*/
/* Destruction en local du fichier contenu les variables ZVAR14 et  */
/* ZVAR15                                                           */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #6. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//FileDelete ( stGlb.sWinDir + "\TEMP\ZV1415.TXT" )
FileDelete ( stGLB.sRepTempo + "ZV1415.TXT" )

// [POSITION_SIMPA2]
If Not bValAuto Then 
	idw_wSin.PostEvent ( "ue_fermerword", 1, 0 ) // #4
	/*
	RUN ( "taskkill /F  /IM WINWORD.EXE /T", minimized! )
	Yield ()
	Yield ()	
	RUN ( "Del " + stGLB.sRepTempo + "*.doc /Q /F", minimized! )	
	Yield ()
	*/
End If 

astPass.bRetour = bRet

end subroutine

private subroutine uf_chargerrevision ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_ChargerRevision (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 17:35:30
//* Libellé			: 
//* Commentaires	: Détermination - et chargement si besoin - de la révision
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* #1	FPI	10/02/2010 [CASTO_SWAP] 
//*			FPI	22/10/2010	[PC516] Ajout refus 1438
//			FPI	17/06/2013	[VDOC10633]
//*-----------------------------------------------------------------

Long dcIdProd, dcIdRev

// #1 -  [CASTO_SWAP] 
Long lCpt,lDeb, lFin, lTot
String sValCar,sValCar2
n_cst_string lnvstring

dcIdRev	= idw_wSin.GetItemNumber ( 1, "ID_REV" )
dcIdProd	= idw_wSin.GetItemNumber ( 1, "ID_PROD" )

If	dcIdRev = -1 Then
/*------------------------------------------------------------------*/
/* La révision n'est pas déterminée, on initialise toutes les DW à  */
/* vide.                                                            */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Pour PIECE ET MOTIF, on récupére la révision -1.                 */
/*------------------------------------------------------------------*/

	idw_Piece.Retrieve ( dcIdProd, dcIdProd )
	idw_Motif.Retrieve ( dcIdProd, dcIdProd )

	idw_Garantie.Reset ()
	idw_Condition.Reset ()
	idw_Franchise.Reset ()
	idw_Plafond.Reset ()
	idw_Delai.Reset ()
	idw_CmdTypFrn.Reset ()
	idw_CmdTypArt.Reset ()

Else

	idw_Piece.Retrieve ( dcIdProd, dcIdRev )
	idw_Motif.Retrieve ( dcIdProd, dcIdRev )
	idw_Garantie.Retrieve ( dcIdProd, dcIdRev )
	idw_Condition.Retrieve ( dcIdProd, dcIdRev )
	idw_Franchise.Retrieve ( dcIdProd, dcIdRev )
	idw_Plafond.Retrieve ( dcIdProd, dcIdRev )
	idw_Delai.Retrieve ( dcIdProd, dcIdRev )

	If ibAltCmdMobile Then 
		idw_CmdTypFrn.Retrieve ( dcIdProd )
		idw_CmdTypArt.Retrieve ( dcIdProd )
	End If

End If

// #1-  [CASTO_SWAP] 
lTot = idw_motif.Rowcount( )
lCpt = idw_motif.Find("ID_MOTIF=644",1,lTot)
If lCpt > 0 Then
	f_rechdetpro(lDeb, lFin, idw_detpro,dcIdProd ,'-DP',132)
	
	If lDeb > 0 Then
		sValCar=idw_detpro.GetItemString(lDeb,"VAL_CAR")
		sValCar=lnvString.of_getkeyvalue( sValCar, "DTE_PIVOT", ";")
		
		Do While lCpt > 0
			sValCar2=idw_motif.GetItemString(lCpt,"LIB_CODE")
			sValCar2=lnvString.of_globalreplace( sValCar2, "[DTE_PIVOT]",sValCar)
		
			idw_motif.SetItem(lCpt,"LIB_CODE",sValCar2)
			If lCpt = lTot Then Exit
			lCpt = idw_motif.Find("ID_MOTIF=644",lCpt+1,lTot)
		Loop
	End if
End if
// Fin #1- [CASTO_SWAP] 

// [PC516]
lCpt = idw_motif.Find("ID_MOTIF=1438",1,lTot)
If lCpt > 0 Then
	f_rechdetpro(lDeb, lFin, idw_detpro,dcIdProd ,'-DP',149)
	
	If lDeb > 0 Then
		sValCar=idw_detpro.GetItemString(lDeb,"VAL_CAR")
		sValCar=lnvString.of_getkeyvalue( sValCar, "DTE_PIVOT", ";")
		
		Do While lCpt > 0
			sValCar2=idw_motif.GetItemString(lCpt,"LIB_CODE")
			sValCar2=lnvString.of_globalreplace( sValCar2, "[DTE_PIVOT]",sValCar)
		
			idw_motif.SetItem(lCpt,"LIB_CODE",sValCar2)
			If lCpt = lTot Then Exit
			lCpt = idw_motif.Find("ID_MOTIF=1438",lCpt+1,lTot)
		Loop
	End if
End if
// :[PC516]

// [VDOC10633]
lCpt = idw_motif.Find("ID_MOTIF=1678",1,lTot)
If lCpt > 0 Then
	f_rechdetpro(lDeb, lFin, idw_detpro,dcIdProd ,'-DP',242)
	
	If lDeb > 0 Then
		sValCar=idw_detpro.GetItemString(lDeb,"VAL_CAR")
		sValCar=lnvString.of_getkeyvalue( sValCar, "MT_MAX_VAL_ACHAT", ";")
		
		Do While lCpt > 0
			sValCar2=idw_motif.GetItemString(lCpt,"LIB_CODE")
			sValCar2=lnvString.of_globalreplace( sValCar2, "[MT_PIVOT]",sValCar)
		
			idw_motif.SetItem(lCpt,"LIB_CODE",sValCar2)
			If lCpt = lTot Then Exit
			lCpt = idw_motif.Find("ID_MOTIF=1678",lCpt+1,lTot)
		Loop
	End if
End if
// :[VDOC10633]

end subroutine

private subroutine uf_zn_altssui ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_AltSsui (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 08/01/1998 17:14:39
//* Libellé			: 
//* Commentaires	: Controle de ALT_SSUI
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

/*------------------------------------------------------------------*/
/* On vient de mettre la zone Sans Suite à NON.                     */
/*------------------------------------------------------------------*/

If idw_wSin.GetText () = "N" Then
	idw_wSin.SetItem ( 1, "COD_MOT_SSUI", 0 )
End If




end subroutine

private subroutine uf_cast_dtesurv ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Cast_DteSurv (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 08/01/1998 17:14:39
//* Libellé			: 
//* Commentaires	: On va décomposer la zone DTE_SURV dans DTE_SURV_DATE et HEU_SURV
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

DateTime dtDteSurv
Time tHeure
String sHeure, sMinute
Time tTime

dtDteSurv	= idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )
If	IsNull ( dtDteSurv )	Then
	idw_wSin.SetItem ( 1, "DTE_SURV_DATE", stNul.Dat )
	idw_wSin.SetItem ( 1, "HEU_SURV", stNul.str )
Else
	sHeure = Trim ( idw_wSin.GetItemString ( 1, "HEU_SURV" ) )

	If Len ( sHeure ) = 4 And IsNumber ( sHeure ) And Not IsNull ( sHeure ) And Long ( Left ( sHeure, 2 ) ) <= 23 And Long ( Right ( sHeure, 2 ) ) <= 59 Then
		idw_wSin.SetItem ( 1, "DTE_SURV", DateTime ( Date ( dtDteSurv ), Time ( Left ( sHeure, 2 ) + ":" + Right ( sHeure, 2 ) + ":00" ) ) )
	End If
	
	// On lit de nouveau
	dtDteSurv	= idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )
	tHeure = Time ( dtDteSurv )

	If	tHeure = 00:00:00	And ( sHeure <> "0000" Or IsNull ( sHeure ) ) Then
		idw_wSin.SetItem ( 1, "HEU_SURV", stNul.str )
	Else
		sHeure	= Left ( String ( tHeure ), 2 )
		sMinute	= Mid ( String ( tHeure ), 4, 2 )
		idw_wSin.SetItem ( 1, "HEU_SURV", sHeure + sMinute )
	End If
	idw_wSin.SetItem ( 1, "DTE_SURV_DATE", Date ( dtDteSurv ) )
End If





end subroutine

private function string uf_determiner_composition ();//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Composition (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 17/06/1998 12:02:09
//* Libellé			: 
//* Commentaires	: Détermination des compositions
//*
//* Arguments		: Aucun
//*
//* Retourne		: String				=	"" -> On continue
//*											<>	"" -> Une erreur est rencontrée, on arrête le contrôle de gestion
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	 11/02/2003	  DCMP030078	Gestion des enveloppes pour SIMPA2
//* #2	 CAG	 10/09/2003	  DCMP 030390 : Si déclar par téléphone, Z017 au lieu
//*										de Z014 suite DCMP 030078
//* #3	 CAG	 15/09/2003	  correction DCMP 030390 : Gestion des doubles
//* #4	 JFF   17/03/2004   DCMP 040020 SVE
//* #5 	 PHG   19/04/2006   [DCMP050251] PHG Reprise regle gestion Z014 pour 
//*								  para Z040-Z043	
//* #6	 PHG	 31/10/2006   [DNTMAIL1-2] Mails Sortant en remplacement 
//*								  des Courriers
//* #7	 JCA	 25/04/2007   DCMP 070051 - Merge des tables [composition] et [courrier] en [cour_prod]
//*       JFF   18/07/2010   [PM159]
//        JFF   18/08/2021 [RS_950_INS_PAR_DYN][RS950]
//       JFF  26/04/2023 [RS5045_REF_MATP]
//       JFF   19/12/2024 [MIG1_COUR_EMAILING]
//*-----------------------------------------------------------------

String sIdCour, sTxtCompo1, sPos, sAltCourGest, sRech, sIdCourJ, sIdNatCour 
String sAltPart, sAltPce, sAltPs, sValTmp, sParaInfo
Int iTot_gTInterCP, iCpt_gTInterCP

Long lCpt, lTotInter, lLig, lIdSin, lIdI, lLigCourrier, lIdIDb, lTotCourrier, lPos, lTotLig, lCptZ, lPos1, lFin
long lPosZ0, lIndex  // #5 [DCMP050251]
String sId_canal, sAdrMail, sAltSuiviMail // #6	PHG 31/10/2006 [DNTMAIL1-2]
long	 lLigTrv  									// #6	PHG 31/10/2006 [DNTMAIL1-2]

long lIdProd // #7


// [MIG1_COUR_EMAILING]
If F_CLE_A_TRUE ( "MIG1_COUR_EMAILING" ) Then
	IF ibMIG1_CourEmailing Then Return ""
End If 

lTotInter	= idw_LstInter.RowCount ()
sPos			= ""

/*------------------------------------------------------------------*/
/* Le RESET sur la DW est fait systématiquement dans la fonction    */
/* Uf_Controler_Gestion ().                                         */
/*------------------------------------------------------------------*/

For	lCpt = 1 To lTotInter
		sIdCour = idw_LstInter.GetItemString ( lCpt, "ID_COUR" )
		
		// #7 l'identifiant produit est toujours renseigné
		lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )
		// FIN - #7 l'identifiant produit est toujours renseigné

/*------------------------------------------------------------------*/
/* S'il n'y a pas de courrier à éditer pour l'interlocuteur, on     */
/* passe au suivant.                                                */
/*------------------------------------------------------------------*/
		If	IsNull ( sIdCour )	Then Continue

/*------------------------------------------------------------------*/
/* On récupére la composition du courrier. On ne gére qu'une seule  */
/* zone de composition sur 248 caractères. (Vu avec Denis, la       */
/* seconde zone ne sert à rien). On ne teste pas la RPC, en effet   */
/* si le paramètrage est bon, on doit forcément récupérer une       */
/* composition.                                                     */
/*------------------------------------------------------------------*/

		sTxtCompo1 = Space ( 248 )

		sIdNatCour = idw_LstInter.GetItemString ( lCpt, "ID_NAT_COUR" ) // Remonter cette ligne plus haut ensuite
		itrTrans.PS_S01_COUR_PROD_V02 ( lIdProd, sIdNatCour, sIdCour, sTxtCompo1 )	
		
		// [RS_950_INS_PAR_DYN][RS950]
		// Si nécéssaire, modification de la chaine si présence de paragraphe dynamique piloté par dp/359
		This.uf_Modification_Para_Dynamique_dp359 ( sIdNatCour, sTxtCompo1 )

		If	Not F_Procedure ( stMessage, itrTrans, "PS_S01_COMPOSITION" )	Then
/*------------------------------------------------------------------*/
/* Il y a une erreur dans l'appel de la procédure, la structure     */
/* stMessage vient d'être armée.                                    */
/*------------------------------------------------------------------*/
			sPos = "REF_CIE"
			Exit
		Else

			Uf_Determiner_Macro ( sTxtCompo1, lCpt )

			/*------------------------------------------------------------------*/
			/* #1 : CAG 17/02/03, DCMP030078, Gestion d'enveloppes.			     */
			/* Uniquement pour le Z014 (enveloppe), on place ce paragraghe en   */
			/* fin de composition si c'est un questionnaire, dans le cas        */
			/* contraire, c'est déjà fait dans uf_Determiner_Macro              */
			/*------------------------------------------------------------------*/
			/* #2 CAG 10/09/2003                                                */
			/*------------------------------------------------------------------*/
			/* #5 [DCMP050251]	PHG	19/04/2006                               */
			/* Application des regle de gestion du paragraphe Z014 aux          */
			/* paragraphe Z040, Z041, Z042, Z043                                */
			/*------------------------------------------------------------------*/
			// #5 [DCMP050251]
			//If idw_LstInter.GetItemString ( lCpt, "ALT_QUEST" ) = "O" And Pos ( sTxtCompo1, "Z014" ) = 0 And Pos ( sTxtCompo1, "Z017" ) = 0 Then
			// remplacé par
			If idw_LstInter.GetItemString ( lCpt, "ALT_QUEST" ) = "O" 	&
				And uf_ParaExist(sTxtCompo1, isListEnvZ0 ) = 0				&
				Then
				
				lTotLig = idw_wParaInfo.RowCount ()
	
				For	lCptZ = 1 To lTotLig
					sParaInfo = idw_wParaInfo.GetItemString ( lCptZ, "ID_PARA" ) + "." + idw_wParaInfo.GetItemString ( lCptZ, "CPT_VER" )
					// #5 [DCMP050251]
					//If Upper ( idw_wParaInfo.GetItemString ( lCptZ, "ID_PARA" ) ) = "Z014" Or &
					//	Upper ( idw_wParaInfo.GetItemString ( lCptZ, "ID_PARA" ) ) = "Z017" Then
					// remplace par
					If uf_ParaExist(Upper ( idw_wParaInfo.GetItemString ( lCptZ, "ID_PARA" ) ), &
											isListEnvZ0 ) > 0 Then
						sTxtCompo1 += sParaInfo
						Continue
					End If

				Next
			End If

/*------------------------------------------------------------------*/
/* Si la composition du courrier est vide, on arrete tout. On       */
/* supprime toutes les lignes que l'on vient d'inserer pour ne pas  */
/* avoir de déphasage. Le gestionnaire doit bloquer son dossier.    */
/* Il ne doit pas y avoir d'INSERT dans W_COURRIER.                 */
/*------------------------------------------------------------------*/
			If	IsNull ( sTxtCompo1 ) Or sTxtCompo1 = ""	Then
/*------------------------------------------------------------------*/
/* On arme la structure de message maintenant, mais le message va   */
/* être affiché dans le contrôle de gestion.                        */
/*------------------------------------------------------------------*/
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= StopSign!
				stMessage.sCode		= "WSIN180"
				stMessage.sVar[1] 	= sIdCour
				sPos = "REF_CIE"
				Exit

			End If

/*------------------------------------------------------------------*/
/* On insére une ligne dans W_COURRIER. On positionne la zone       */
/* ID_CPT à ZERO (0), cela correspond au 1er courrier possible      */
/* pour l'interlocuteur. On postionne la zone ID_I_DB à NULL.       */
/*------------------------------------------------------------------*/
			lLig		= idw_wCourrier.InsertRow ( 0 )
			lIdSin	= idw_wSin.GetItemNumber ( 1, "ID_SIN" )
			lIdI		= idw_LstInter.GetItemNumber ( lCpt, "ID_I" )	

			idw_wCourrier.SetItem ( lLig, "ID_SIN",		lIdSin															)	
			idw_wCourrier.SetItem ( lLig, "ID_I",			lIdI																)

			idw_wCourrier.SetItem ( lLig, "ID_CPT",		0																	)
			idw_wCourrier.SetItem ( lLig, "ID_COUR",		sIdCour															)
/*------------------------------------------------------------------*/
/* #3 Gestion du courrier d'origine, si par la suite le courrier    */
/* auto devient un CP (cour auto modifié)                           */
/*------------------------------------------------------------------*/
			idw_wCourrier.SetItem ( lLig, "ID_COUR_ORIG",sIdCour															)

			sAltPart	= idw_LstInter.GetItemString ( lCpt, "ALT_PART" )
			sAltPce	= idw_LstInter.GetItemString ( lCpt, "ALT_PCE" )
			sAltPs	= idw_LstInter.GetItemString ( lCpt, "ALT_PS" )
/*------------------------------------------------------------------*/
/* Si les zones ALT_XXX sont positionnées à 'E', il faut les        */
/* remettre à 'N'. L'information est nécessaire pour la             */
/* suppression sur W_INTER_BLOB.                                    */
/*------------------------------------------------------------------*/
			If	sAltPart	= "E"	Then sAltPart	= "N"
			If	sAltPs	= "E"	Then sAltPs		= "N"
			If	sAltPce	= "E"	Then sAltPce	= "N"

			idw_wCourrier.SetItem ( lLig, "ALT_PART",		sAltPart															)
			idw_wCourrier.SetItem ( lLig, "ALT_PCE",		sAltPce															)
			idw_wCourrier.SetItem ( lLig, "ALT_PS",		sAltPs															)
			idw_wCourrier.SetItem ( lLig, "TXT_COMPO1",	sTxtCompo1)


/*--------------------------------------------------------------------------------------------------*/
/* #2 30/10/2006 [DNTMAIL1-2] PHG                                                                   */
/* Report code de l'open de la fenetre appelante suivante point 4.5 spécification DNTMAIL1/2        */ 
/* Initialisation du canal selon la régle suivante : Si champ ADR_MAIL est renseigné                */
/* et que la zone ALT_SUIVI_MAIL est coché alors c'est un envoi par MAIL SINON envoi par COURRIER   */
/*--------------------------------------------------------------------------------------------------*/
		
			lLigTrv  = idw_LstInter.Find ("ID_I = " + String ( lIdI ), 1, idw_LstInter.RowCount()+1)
						
			sAltSuiviMail = idw_LstInter.GetItemString (lLigTrv , "ALT_SUIVI_MAIL")
			//[DNTMAIL1-2_MEP_DEF] Forçage à supprimer lors de la MEP finale.
			// [PM159]
			sAltSuiviMail = "O" // [PM159]				
			
			sAdrMail =      idw_LstInter.GetItemString (lLigTrv , "ADR_MAIL")
								 
			IF sAltSuiviMail = "O" And NOT (Isnull (sAdrMail) OR Trim ( sAdrMail ) = "" ) THEN
				sId_canal = "MA"
			Else
				sId_canal = "CO"
			End If
			idw_wCourrier.SetItem ( lLig, "ID_CANAL",	sId_Canal)
			// Fin [DNTMAIL1-2] PHG 31/10/2006
			
/*------------------------------------------------------------------*/
/* Les zones CREE_LE, MAJ_LE, MAJ_PAR seront armées sur le          */
/* SqlPreview de la DW.                                             */
/*------------------------------------------------------------------*/
	End If
Next

If	sPos = ""	Then
/*------------------------------------------------------------------*/
/* On s'occupe maintenant des doubles.                              */
/*------------------------------------------------------------------*/
	For	lCpt = 1 To lTotInter
			sAltCourGest = idw_LstInter.GetItemString ( lCpt, "ALT_COURGEST" )
			If	sAltCourGest = "D"	Then

/*------------------------------------------------------------------*/
/* On récupére le code de l'interlocuteur pour le double.           */
/*------------------------------------------------------------------*/
				lIdIDb = idw_LstInter.GetItemNumber ( lCpt, "ID_I_DB" )

				sRech				= "ID_I = " + String ( lIdIDB ) + " And ID_CPT = 0"
				lTotCourrier	= idw_wCourrier.RowCount ()
				lLigCourrier	= idw_wCourrier.Find ( sRech, 1, lTotCourrier )
			
				lLig		= idw_wCourrier.InsertRow ( 0 )
				lIdSin	= idw_wSin.GetItemNumber ( 1, "ID_SIN" )
				lIdI		= idw_LstInter.GetItemNumber ( lCpt, "ID_I" )
				
				idw_wCourrier.SetItem ( lLig, "ID_SIN",		lIdSin																				)
				idw_wCourrier.SetItem ( lLig, "ID_I",			lIdI																					)

				idw_wCourrier.SetItem ( lLig, "ID_CPT",		1																				)
				idw_wCourrier.SetItem ( lLig, "ID_COUR",		idw_wCourrier.GetItemString ( lLigCourrier, "ID_COUR" 		)		)
/*------------------------------------------------------------------*/
/* #3 Gestion du courrier d'origine, si par la suite le courrier    */
/* auto devient un CP (cour auto modifié)                           */
/*------------------------------------------------------------------*/
				idw_wCourrier.SetItem ( lLig, "ID_COUR_ORIG",idw_wCourrier.GetItemString ( lLigCourrier, "ID_COUR_ORIG"	)		)

				idw_wCourrier.SetItem ( lLig, "ALT_PART",		idw_wCourrier.GetItemString ( lLigCourrier, "ALT_PART" 		)		)
				idw_wCourrier.SetItem ( lLig, "ALT_PCE",		idw_wCourrier.GetItemString ( lLigCourrier, "ALT_PCE" 		)		)
				idw_wCourrier.SetItem ( lLig, "ALT_PS",		idw_wCourrier.GetItemString ( lLigCourrier, "ALT_PS" 			)		)

				/*------------------------------------------------------------------*/
				/* #1 : JFF 11/02/03, DCMP030078, Gestion d'enveloppes Z014.	     */
				/* Suppression de l'enveloppe pour le double.							  */
				/*------------------------------------------------------------------*/
				/* #3 : CAG 15/09/03 : correction DCMP 030390 :  gestion des doubles*/
				/*------------------------------------------------------------------*/

				sValTmp = idw_wCourrier.GetItemString ( lLigCourrier, "TXT_COMPO1" )
				
				// #5 [DCMP050251]
//				lPos = Pos ( sValTmp, "Z014" )
//				lPos1 = Pos ( sValTmp, "Z017" )
//				If lPos > 0 Then
//					// On supprime l'eveloppe
//					sValTmp = Replace ( sValTmp, lPos, 8, "" )
//				ElseIf lPos1 > 0 Then
//					sValTmp = Replace ( sValTmp, lPos1, 8, "" )
//				End If
//				remplacé par :
				For lIndex = 1 to UpperBound(isListEnvZ0)
					lPosZ0 = Pos ( sValTmp, isListEnvZ0[lIndex] )
					If lPosZ0 > 0 Then
						// On supprime l'eveloppe
						sValTmp = Replace ( sValTmp, lPosZ0, 8, "" )
					End If
				Next 

				idw_wCourrier.SetItem ( lLig, "TXT_COMPO1",	sValTmp )

				idw_wCourrier.SetItem ( lLig, "ID_I_DB",		lIdIDB )
/*--------------------------------------------------------------------------------------------------*/
/* #2 06/11/2006 [DNTMAIL1-2] PHG                                                                   */
/* Report code de l'open de la fenetre appelante suivante point 4.5 spécification DNTMAIL1/2        */ 
/* Initialisation du canal selon la régle suivante : Si champ ADR_MAIL est renseigné                */
/* et que la zone ALT_SUIVI_MAIL est coché alors c'est un envoi par MAIL SINON envoi par COURRIER   */
/*--------------------------------------------------------------------------------------------------*/
		
				lLigTrv  = idw_LstInter.Find ("ID_I = " + String ( lIdI ), 1, idw_LstInter.RowCount()+1)
							
				sAltSuiviMail = idw_LstInter.GetItemString (lLigTrv , "ALT_SUIVI_MAIL")
				//[DNTMAIL1-2_MEP_DEF] Forçage à supprimer lors de la MEP finale.
				// [PM159]
				sAltSuiviMail = "O" // [PM159]
				
				sAdrMail =      idw_LstInter.GetItemString (lLigTrv , "ADR_MAIL")
									 
				IF sAltSuiviMail = "O" And NOT (Isnull (sAdrMail) OR Trim ( sAdrMail ) = "" ) THEN
					sId_canal = "MA"
				Else
					sId_canal = "CO"
				End If
				idw_wCourrier.SetItem ( lLig, "ID_CANAL",	sId_Canal)
				// Fin [DNTMAIL1-2] PHG 31/10/2006

/*------------------------------------------------------------------*/
/* Les zones CREE_LE, MAJ_LE, MAJ_PAR seront armées sur le          */
/* SqlPreview de la DW.                                             */
/*------------------------------------------------------------------*/
			End If
	Next
End If

If	sPos = ""	Then
/*------------------------------------------------------------------*/
/* On s'occupe maintenant du courrier joint.                        */
/*------------------------------------------------------------------*/
	For	lCpt = 1 To lTotInter
			sAltCourGest = idw_LstInter.GetItemString ( lCpt, "ALT_COURGEST" )
			If	sAltCourGest = "J"	Then
/*------------------------------------------------------------------*/
/* On récupére la composition du courrier joint.                    */
/*------------------------------------------------------------------*/
				sIdCourJ		= idw_LstInter.GetItemString ( lCpt, "ID_COURJ" )

				// #7 l'identifiant produit est toujours renseigné
				lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )
				// FIN - #7 l'identifiant produit est toujours renseigné
				
				sTxtCompo1 	= Space ( 248 )

				itrTrans.PS_S01_COUR_PROD_V02 ( lIdProd, sIdCourJ, sIdCourJ, sTxtCompo1 )			

				// [RS_950_INS_PAR_DYN][RS950]
				// Si nécéssaire, modification de la chaine si présence de paragraphe dynamique piloté par dp/359
				This.uf_Modification_Para_Dynamique_dp359 ( sIdNatCour, sTxtCompo1 )
					
				If	Not F_Procedure ( stMessage, itrTrans, "PS_S01_COUR_PROD" )	Then
//				If	Not F_Procedure ( stMessage, itrTrans, "PS_S01_COMPOSITION" )	Then

				// FIN - #7 Ajout de l'argument à la procédure PS_S01_COMPOSITION

/*------------------------------------------------------------------*/
/* Il y a une erreur dans l'appel de la procédure, la structure     */
/* stMessage vient d'être armée.                                    */
/*------------------------------------------------------------------*/
					sPos = "REF_CIE"
					Exit
				Else
/*------------------------------------------------------------------*/
/* Si la composition du courrier est vide, on arrete tout. On       */
/* supprime toutes les lignes que l'on vient d'inserer pour ne pas  */
/* avoir de déphasage. Le gestionnaire doit bloquer son dossier.    */
/* Il ne doit pas y avoir d'INSERT dans W_COURRIER.                 */
/*------------------------------------------------------------------*/
					If	IsNull ( sTxtCompo1 ) Or sTxtCompo1 = ""	Then
/*------------------------------------------------------------------*/
/* On arme la structure de message maintenant, mais le message va   */
/* être affiché dans le contrôle de gestion.                        */
/*------------------------------------------------------------------*/
						stMessage.bErreurG	= FALSE
						stMessage.Icon			= StopSign!
						stMessage.sCode		= "WSIN180"
						stMessage.sVar[1] 	= sIdCourJ
						sPos = "REF_CIE"
						Exit
					End If
				End If
						
				lLig		= idw_wCourrier.InsertRow ( 0 )

				lIdSin	= idw_wSin.GetItemNumber ( 1, "ID_SIN" )
				lIdI		= idw_LstInter.GetItemNumber ( lCpt, "ID_I" )
				
				idw_wCourrier.SetItem ( lLig, "ID_SIN",		lIdSin																				)
				idw_wCourrier.SetItem ( lLig, "ID_I",			lIdI																					)

				idw_wCourrier.SetItem ( lLig, "ID_CPT",		1																						)
				idw_wCourrier.SetItem ( lLig, "ID_COUR",		sIdCourJ																				)

/*------------------------------------------------------------------*/
/* #3 Gestion du courrier d'origine, si par la suite le courrier    */
/* auto devient un CP (cour auto modifié)                           */
/*------------------------------------------------------------------*/
				idw_wCourrier.SetItem ( lLig, "ID_COUR_ORIG",sIdCourJ																				)


				idw_wCourrier.SetItem ( lLig, "ALT_PART",		"N" 																					)
				idw_wCourrier.SetItem ( lLig, "ALT_PCE",		"N"																					)
				idw_wCourrier.SetItem ( lLig, "ALT_PS",		"N"																					)
				idw_wCourrier.SetItem ( lLig, "TXT_COMPO1",	sTxtCompo1																			)

/*--------------------------------------------------------------------------------------------------*/
/* #2 06/11/2006 [DNTMAIL1-2] PHG                                                                   */
/* Report code de l'open de la fenetre appelante suivante point 4.5 spécification DNTMAIL1/2        */ 
/* Initialisation du canal selon la régle suivante : Si champ ADR_MAIL est renseigné                */
/* et que la zone ALT_SUIVI_MAIL est coché alors c'est un envoi par MAIL SINON envoi par COURRIER   */
/*--------------------------------------------------------------------------------------------------*/
		
				lLigTrv  = idw_LstInter.Find ("ID_I = " + String ( lIdI ), 1, idw_LstInter.RowCount()+1)
							
				sAltSuiviMail = idw_LstInter.GetItemString (lLigTrv , "ALT_SUIVI_MAIL")
				//[DNTMAIL1-2_MEP_DEF] Forçage à supprimer lors de la MEP finale.
				// [PM159]
				sAltSuiviMail = "O" // [PM159]					
				
				sAdrMail =      idw_LstInter.GetItemString (lLigTrv , "ADR_MAIL")
									 
				IF sAltSuiviMail = "O" And NOT (Isnull (sAdrMail) OR Trim ( sAdrMail ) = "" ) THEN
					sId_canal = "MA"
				Else
					sId_canal = "CO"
				End If
				idw_wCourrier.SetItem ( lLig, "ID_CANAL",	sId_Canal)
				// Fin [DNTMAIL1-2] PHG 31/10/2006

/*------------------------------------------------------------------*/
/* Les zones CREE_LE, MAJ_LE, MAJ_PAR seront armées sur le          */
/* SqlPreview de la DW.                                             */
/*------------------------------------------------------------------*/
			End If
	Next
End If

Return ( sPos )
end function

private subroutine uf_determiner_macro (ref string astxtcompo1, long alliginter);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Macro (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 19/06/1998 11:04:15
//* Libellé			: 
//* Commentaires	: Remplacement de toutes les chaines macros dans la composition
//*
//* Arguments		: String			asTxtCompo1				(Réf)	Composition à remplacer
//*					  Long			alLigInter				(Val) N° de la ligne d'interlocuteur 
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ 			PAR		Date		Modification
//* DCMP990455	JFF		04/10/99 Insertion du paragraphe VIDE.001 avant
//*										ou après chaque paragraphe d'information.
//* DCMP030078	JFF  #1	10/02/2003 Gestion des enveloppes DCMP 030078
//* DCMP030390 CAG  #2  10/09/2003 Si déclar par téléphone, Z017 au lieu
//*						   	de Z014 suite DCMP 030078
//* DCMP050251	PHG		19/04/2006	Application des regle de gestion du
//*											paragraphe z014 aux paragraphes listé
//*											dans le tableau (instance) isListEnvZ0	
//*-----------------------------------------------------------------

Long lIdI, lPos, lCpt, lIdGti, lIdDetail, lLigDetail, lLigGti
Long lTotLig, lTotDetail, lTotGti

String sFiltre, sFiltreNull, sRechDetail, sRechGti
String sCompoPce, sPiece, sCompoRef, sRefus, sCompoPara, sParaInfo, sCompoPlaf, sPlafond
String sIdCour, sVal   // DCMP

lIdI			= idw_LstInter.GetItemNumber ( alLigInter, "ID_I" )
lTotDetail	= idw_wDetail.RowCount ()
lTotGti		= idw_LstGti.RowCount ()
// DCMP990455
sIdCour		= idw_LstInter.GetItemString ( alLigInter, "ID_COUR" ) 


sCompoPce 	= ""
sCompoRef 	= ""
sCompoPlaf 	= ""
sCompoPara	= ""
sFiltreNull	= ""

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Substitution du paragraphe MACP.                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
lPos = Pos ( asTxtCompo1, "MACP", 1 )

If	lPos > 0	Then
/*------------------------------------------------------------------*/
/* On récupére la liste des pièces pour la garantie.                */
/*------------------------------------------------------------------*/
	sFiltre	= "ID_I = " + String ( lIdI ) + " And ID_DETAIL = -1"
	idw_wPiece.SetFilter ( sFiltre )
	idw_wPiece.Filter ()
	idw_wPiece.Sort ()

	lTotLig = idw_wPiece.RowCount ()
	
	For	lCpt = 1 To lTotLig
			sPiece = idw_wPiece.GetItemString ( lCpt, "ID_PARA" ) + "." + &
			idw_wPiece.GetItemString ( lCpt, "CPT_VER" )
/*------------------------------------------------------------------*/
/* On vérifie que cette pièce n'est pas déjà réclamée.              */
/*------------------------------------------------------------------*/
			If	Pos ( sCompoPce, sPiece, 1 ) = 0	Then			
				sCompoPce = sCompoPce + sPiece
			End If
	Next

/*------------------------------------------------------------------*/
/* On récupére la liste des pièces pour tous les détails.           */
/*------------------------------------------------------------------*/
	sFiltre	= "ID_I = " + String ( lIdI ) + " And ID_DETAIL <> -1"
	idw_wPiece.SetFilter ( sFiltre )
	idw_wPiece.Filter ()
	idw_wPiece.Sort ()

	lTotLig = idw_wPiece.RowCount ()
	
	For	lCpt = 1 To lTotLig
/*------------------------------------------------------------------*/
/* On vérifie pour le détail si le gestionnaire veut voir           */
/* apparaître le paragraphe.                                        */
/*------------------------------------------------------------------*/
			lIdGti		= idw_wPiece.GetItemNumber ( lCpt, "ID_GTI" )
			lIdDetail	= idw_wPiece.GetItemNumber ( lCpt, "ID_DETAIL" )
			sRechDetail	= "ID_GTI = " + String ( lIdGti ) + " And ID_DETAIL = " + String ( lIdDetail ) + " And ALT_COUR = 'O'"

			lLigDetail	= idw_wDetail.Find ( sRechDetail, 1, lTotDetail )
			If	lLigDetail > 0	Then
				sPiece = idw_wPiece.GetItemString ( lCpt, "ID_PARA" ) + "." + idw_wPiece.GetItemString ( lCpt, "CPT_VER" )
/*------------------------------------------------------------------*/
/* On vérifie que cette pièce n'est pas déjà réclamée.              */
/*------------------------------------------------------------------*/
				If	Pos ( sCompoPce, sPiece, 1 ) = 0	Then			
					sCompoPce = sCompoPce + sPiece
				End If
			End If
	Next

/*------------------------------------------------------------------*/
/* On enléve le filtre sur W_PIECE.                                 */
/*------------------------------------------------------------------*/
	idw_wPiece.SetFilter ( sFiltreNull )
	idw_wPiece.Filter ()
	idw_wPiece.Sort ()

/*------------------------------------------------------------------*/
/* On insére la liste des pièces dans la chaîne de composition.     */
/*------------------------------------------------------------------*/
	asTxtCompo1 = Replace ( asTxtCompo1, lPos, 8, sCompoPce )
End If

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Substitution du paragraphe MACR.                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
lPos = Pos ( asTxtCompo1, "MACR", 1 )

If	lPos > 0	Then
/*------------------------------------------------------------------*/
/* On récupére la liste des refus pour la garantie.                 */
/*------------------------------------------------------------------*/
	sFiltre	= "ID_I = " + String ( lIdI ) + " And ID_DETAIL = -1"
	idw_wRefus.SetFilter ( sFiltre )
	idw_wRefus.Filter ()
	idw_wRefus.Sort ()

	lTotLig = idw_wRefus.RowCount ()
	
	For	lCpt = 1 To lTotLig

			lIdGti		= idw_wRefus.GetItemNumber ( lCpt, "ID_GTI" )
			sRechGti		= "ID_GTI = " + String ( lIdGti ) + " And ALT_VALIDE = 'O'"

			lLigGti		= idw_LstGti.Find ( sRechGti, 1, lTotGti )
			If	lLigGti > 0	Then

				sRefus = idw_wRefus.GetItemString ( lCpt, "ID_PARA" ) + "." + idw_wRefus.GetItemString ( lCpt, "CPT_VER" )
			
/*------------------------------------------------------------------*/
/* On vérifie que ce refus n'est pas déjà coché.                    */
/*------------------------------------------------------------------*/
				If	Pos ( sCompoRef, sRefus, 1 ) = 0	Then			
					sCompoRef = sCompoRef + sRefus
				End If
			End If
	Next

/*------------------------------------------------------------------*/
/* On récupére la liste des refus pour tous les détails.            */
/*------------------------------------------------------------------*/
	sFiltre	= "ID_I = " + String ( lIdI ) + " And ID_DETAIL <> -1"
	idw_wRefus.SetFilter ( sFiltre )
	idw_wRefus.Filter ()
	idw_wRefus.Sort ()

	lTotLig = idw_wRefus.RowCount ()
	
	For	lCpt = 1 To lTotLig
/*------------------------------------------------------------------*/
/* On vérifie pour le refus si le gestionnaire veut voir apparaître */
/* le paragraphe et que ce refus est en cours de validation.        */
/*------------------------------------------------------------------*/
			lIdGti		= idw_wRefus.GetItemNumber ( lCpt, "ID_GTI" )
			lIdDetail	= idw_wRefus.GetItemNumber ( lCpt, "ID_DETAIL" )
			sRechDetail	= "ID_GTI = " + String ( lIdGti ) + " And ID_DETAIL = " + String ( lIdDetail ) + " And ALT_COUR = 'O' And ALT_VALIDE = 'O'"

			lLigDetail	= idw_wDetail.Find ( sRechDetail, 1, lTotDetail )
			If	lLigDetail > 0	Then
				sRefus = idw_wRefus.GetItemString ( lCpt, "ID_PARA" ) + "." + idw_wRefus.GetItemString ( lCpt, "CPT_VER" )
/*------------------------------------------------------------------*/
/* On vérifie que ce refus n'est pas déjà coché.                    */
/*------------------------------------------------------------------*/
				If	Pos ( sCompoRef, sRefus, 1 ) = 0	Then			
					sCompoRef = sCompoRef + sRefus
				End If
			End If
	Next

/*------------------------------------------------------------------*/
/* On enléve le filtre sur W_REFUS.                                 */
/*------------------------------------------------------------------*/
	idw_wRefus.SetFilter ( sFiltreNull )
	idw_wRefus.Filter ()
	idw_wRefus.Sort ()

/*------------------------------------------------------------------*/
/* On insére la liste des refus dans la chaîne de composition.      */
/*------------------------------------------------------------------*/
	asTxtCompo1 = Replace ( asTxtCompo1, lPos, 8, sCompoRef )
End If


/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Substitution du paragraphe MACN.                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
lPos = Pos ( asTxtCompo1, "MACN", 1 )

If	lPos > 0	Then
/*------------------------------------------------------------------*/
/* On récupére la liste des plafonds/franchises pour la garantie.   */
/*------------------------------------------------------------------*/
	sFiltre	= "ID_I = " + String ( lIdI ) + " And ID_DETAIL = -1"
	idw_wParaPlafond.SetFilter ( sFiltre )
	idw_wParaPlafond.Filter ()
	idw_wParaPlafond.Sort ()

	lTotLig = idw_wParaPlafond.RowCount ()
	
	For	lCpt = 1 To lTotLig
/*------------------------------------------------------------------*/
/* Au cours de la validation, on va casser les plafonds             */
/* précédents. Dans la DW, on ne peut donc trouver que des          */
/* plafonds/franchises à faire apparaître.                          */
/*------------------------------------------------------------------*/
			lIdGti		= idw_wParaPlafond.GetItemNumber ( lCpt, "ID_GTI" )
			sPlafond		= idw_wParaPlafond.GetItemString ( lCpt, "ID_PARA" ) + "." + idw_wParaPlafond.GetItemString ( lCpt, "CPT_VER" )
/*------------------------------------------------------------------*/
/* Le paragraphe lié au plafond/franchise peut être NULL. Dans ce   */
/* cas on passe au suivant.                                         */
/*------------------------------------------------------------------*/
			If	IsNull ( sPlafond ) Then Continue			
/*------------------------------------------------------------------*/
/* On vérifie que ce plafond n'est pas déjà réclamé.                */
/*------------------------------------------------------------------*/
			If	Pos ( sCompoPlaf, sPlafond, 1 ) = 0	Then			
				sCompoPlaf = sCompoPlaf + sPlafond
			End If
	Next

/*------------------------------------------------------------------*/
/* On récupére la liste des plafonds/franchises pour tous les       */
/* détails.                                                         */
/*------------------------------------------------------------------*/
	sFiltre	= "ID_I = " + String ( lIdI ) + " And ID_DETAIL <> -1"
	idw_wParaPlafond.SetFilter ( sFiltre )
	idw_wParaPlafond.Filter ()
	idw_wParaPlafond.Sort ()

	lTotLig = idw_wParaPlafond.RowCount ()
	
	For	lCpt = 1 To lTotLig
			lIdGti		= idw_wParaPlafond.GetItemNumber ( lCpt, "ID_GTI" )
			lIdDetail	= idw_wParaPlafond.GetItemNumber ( lCpt, "ID_DETAIL" )
			sRechDetail	= "ID_GTI = " + String ( lIdGti ) + " And ID_DETAIL = " + String ( lIdDetail )

			lLigDetail	= idw_wDetail.Find ( sRechDetail, 1, lTotDetail )
			If	lLigDetail > 0	Then
				sPlafond = idw_wParaPlafond.GetItemString ( lCpt, "ID_PARA" ) + "." + idw_wParaPlafond.GetItemString ( lCpt, "CPT_VER" )
/*------------------------------------------------------------------*/
/* Le paragraphe lié au plafond/franchise peut être NULL. Dans ce   */
/* cas on passe au suivant.                                         */
/*------------------------------------------------------------------*/
				If	IsNull ( sPlafond ) Then Continue			
/*------------------------------------------------------------------*/
/* On vérifie que ce plafond n'est pas déjà réclamé.                */
/*------------------------------------------------------------------*/
				If	Pos ( sCompoPlaf, sPlafond, 1 ) = 0	Then			
					sCompoPlaf = sCompoPlaf + sPlafond
				End If
			End If
	Next

/*------------------------------------------------------------------*/
/* On enléve le filtre sur W_PARA_PLAFOND.                          */
/*------------------------------------------------------------------*/
	idw_wParaPlafond.SetFilter ( sFiltreNull )
	idw_wParaPlafond.Filter ()
	idw_wParaPlafond.Sort ()

/*------------------------------------------------------------------*/
/* On insére la liste des plafonds dans la chaîne de composition.   */
/*------------------------------------------------------------------*/
	asTxtCompo1 = Replace ( asTxtCompo1, lPos, 8, sCompoPlaf )
End If

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Substitution du paragraphe MACI.                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
lPos = Pos ( asTxtCompo1, "MACI", 1 )

If	lPos > 0	Then
/*------------------------------------------------------------------*/
/* On récupére la liste des paragraphes d'information.              */
/*------------------------------------------------------------------*/
	sFiltre	= "ID_I = " + String ( lIdI )
	idw_wParaInfo.SetFilter ( sFiltre )
	idw_wParaInfo.Filter ()
	idw_wParaInfo.Sort ()

	lTotLig = idw_wParaInfo.RowCount ()
	
	For	lCpt = 1 To lTotLig
			sParaInfo = idw_wParaInfo.GetItemString ( lCpt, "ID_PARA" ) + "." + idw_wParaInfo.GetItemString ( lCpt, "CPT_VER" )

			/*------------------------------------------------------------------*/
			/* #1 : JFF 10/02/03, DCMP030078, Gestion d'enveloppes.			     */
			/* Uniquement pour le Z014 (enveloppe), on place ce paragraghe en   */
			/* fin de composition.                                              */
			/*------------------------------------------------------------------*/
			/* #2 CAG 10/09/2003                                                */
			/*------------------------------------------------------------------*/
			/* [DCMP050251]	PHG	19/04/2006                                  */
			/* Application des regle de gestion du paragraphe Z014 aux          */
			/* paragraphe Z040, Z041, Z042, Z043                                */
			/*------------------------------------------------------------------*/
//			If Upper ( idw_wParaInfo.GetItemString ( lCpt, "ID_PARA" ) ) = "Z014" Or Upper ( idw_wParaInfo.GetItemString ( lCpt, "ID_PARA" ) ) = "Z017" Then
//				asTxtCompo1 += sParaInfo
//				Continue
//			End If
//			Est remplacé par
			If uf_ParaExist(Upper ( idw_wParaInfo.GetItemString ( lCpt, "ID_PARA" ) ), isListEnvZ0) > 0 Then
				asTxtCompo1 += sParaInfo
				Continue
			End If

/*------------------------------------------------------------------*/
/* On vérifie que ce paragraphe n'est pas déjà réclamé.             */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* DCMP990455 : Insertion du paragraphe VIDE.001 avant ou après     */
/* 				 chaque paragraphe d'information, sauf si le courrier*/
/*					 est un courrier particulier.                        */
/*------------------------------------------------------------------*/
			If	Pos ( sCompoPce, sParaInfo, 1 ) = 0 Then			
				If Mid ( sIdCour, 2, 1 ) = "C" and ( Mid ( sIdCour, 4, 1 ) = "P" Or Mid ( sIdCour, 5, 1 ) = "R" ) Then
					sCompoPara = sCompoPara + "VIDE.001" + sParaInfo
				Else
					sCompoPara = sCompoPara + sParaInfo + "VIDE.001"
				End If
			End If
	Next

/*------------------------------------------------------------------*/
/* On enléve le filtre sur W_PARAINFO.                              */
/*------------------------------------------------------------------*/
	idw_wParaInfo.SetFilter ( sFiltreNull )
	idw_wParaInfo.Filter ()
	idw_wParaInfo.Sort ()

/*------------------------------------------------------------------*/
/* On insére la liste des paragraphes dans la chaîne de composition.*/
/*------------------------------------------------------------------*/
	asTxtCompo1 = Replace ( asTxtCompo1, lPos, 8, sCompoPara )
End If

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Substitution du paragraphe PIEC.                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
lPos 			= Pos ( asTxtCompo1, "PIEC", 1 )
If	( idw_LstInter.GetItemString ( alLigInter, "ALT_PCE" ) = "N" Or &
	  idw_LstInter.GetItemString ( alLigInter, "ALT_PCE" ) = "E" ) And lPos > 0 Then
	asTxtCompo1 = Replace ( asTxtCompo1, lPos, 8, "" )
End If

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Substitution du paragraphe POST.                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
lPos			= Pos ( asTxtCompo1, "POST", 1 )
sVal 			= Mid ( asTxtCompo1, lPos  , 8 )

If ( lPos > 0 ) Then

	If	( idw_LstInter.GetItemString ( alLigInter, "ALT_PS" ) = "N"			Or &
		  idw_LstInter.GetItemString ( alLigInter, "ALT_PS" ) = "E" ) 		Then
		asTxtCompo1 = Replace ( asTxtCompo1, lPos, 8, "" )

	Else
/*------------------------------------------------------------------*/
/* DCMP990455 : Insertion du paragraphe VIDE.001 avant ou après     */
/* 				 le post-scriptum, sauf si le courrier est un        */
/*              courrier particulier. 										  */
/*------------------------------------------------------------------*/
		If Mid ( sIdCour, 2, 1 ) = "C" and ( Mid ( sIdCour, 4, 1 ) = "P" Or Mid ( sIdCour, 5, 1 ) = "R" ) Then
			asTxtCompo1 = Replace ( asTxtCompo1, lPos, 8, "VIDE.001" + sVal  )
		Else
			asTxtCompo1 = Replace ( asTxtCompo1, lPos, 8, sVal + "VIDE.001"  )
		End If
		
		sVal = ""	

	End If	

End If


end subroutine

private subroutine uf_effacer_fichier_word ();//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Effacer_Fichier_Word (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 04/06/1998 15:16:54
//* Libellé			: 
//* Commentaires	: On supprime tous les fichiers créés par l'objet U_SPB_CP
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* #1 DGA              19/09/2006              Gestion d'un répertoire temporaire DCMP-060643
//*-----------------------------------------------------------------

String sRepWin
Long iRet


If ibSaisieValidation Then
	iRet = invSaisieValSin.uf_CourWord_PurgerTouslesCourriers ()

	// [PI052]
	/*
	If F_CLE_A_TRUE ( "PI052" ) Then
		If iRet < 0 Then
			stMessage.sTitre  	= "Courriers restés ouvert"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= Ok!
			stMessage.sCode = "PI52009 "		
		
		
			If isTypeTrt = "S" Then 
				iPbControler.Enabled = FALSE
				F_Message ( stMessage )
			End If
		End If 
	End If
	*/
Else

	/*------------------------------------------------------------------*/
	/* On va supprimer tous les fichiers qui commencent par CODE        */
	/* APPLI*.* dans le répertoire de travail de Windows.               */
	/*------------------------------------------------------------------*/
	/*------------------------------------------------------------------*/
	/* On arme une variable d'instance qui contient le répertoire       */
	/* Windows dans la fonction Uf_Initialisation de                    */
	/* U_Gs_Sp_Sinistre_Anc.                                            */
	/*------------------------------------------------------------------*/

//	u_DeclarationFuncky uoDeclarationFuncky //[I037] Migration FUNCKy

//	uoDeclarationFuncky = Create u_DeclarationFuncky
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//	sRepWin = isRepWin + "\TEMP\" + stGlb.sCodAppli + "*.*"
	sRepWin = stGLB.sRepTempo + stGlb.sCodAppli + "*.*"

//	uoDeclarationFuncky.Uf_FEraseAll ( sRepWin )
	stGLB.uoWin.Uf_FEraseAll ( sRepWin )
//	Destroy uoDeclarationFuncky

End If
end subroutine

private function boolean uf_enregistrer_w_inter_blob_data ();//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Enregistrer_W_Inter_Blob_Data (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 24/06/1998 10:30:06
//* Libellé			: 
//* Commentaires	: Gestion de table W_INTER_BLOB au niveau des données standards
//*
//* Arguments		: Aucun
//*
//* Retourne		: Boolean			True		= On continue
//*											False		= Il y a un problème
//*
//*-----------------------------------------------------------------
//* #1 DGA              19/09/2006              Gestion d'un répertoire temporaire DCMP-060643
//*-----------------------------------------------------------------

Long 	lTotInter, lCpt, lIdSin, lIdI, lTotwCourrier, lIdCpt
String sAltPce, sAltPs, sAltPart, sNomFic
String sMajPar

DateTime dtCreeLe, dtMajLe

/*------------------------------------------------------------------*/
/* On va d'abord supprimer tous les courriers WORD que le           */
/* gestionnaire a supprimé dans son acte de gestion. La zone        */
/* ALT_XXX est positionnée à 'E' dans l'objet U_SPB_CP.             */
/*------------------------------------------------------------------*/
lIdSin		= idw_wSin.GetItemNumber ( 1, "ID_SIN" )
lTotInter	= idw_LstInter.RowCount ()
sMajPar		= stGLB.sCodOper

For	lCpt = 1 to lTotInter
		lIdI		= idw_LstInter.GetItemNumber ( lCpt, "ID_I" )

		sAltPce	= idw_LstInter.GetItemString ( lCpt, "ALT_PCE" )
		sAltPs	= idw_LstInter.GetItemString ( lCpt, "ALT_PS" )
		sAltPart	= idw_LstInter.GetItemString ( lCpt, "ALT_PART" )

		If	sAltPce = "E"	Then
			itrTrans.IM_D01_W_INTER_BLOB ( lIdSin, lIdI, "PC" )
			If	Not F_Procedure ( stMessage, itrTrans, "IM_D01_W_INTER_BLOB" )	Then Return ( False )
/*------------------------------------------------------------------*/
/* Faire un SetItem sur LstInter ne sert à rien puisqu'il a été     */
/* fait sur SqlPreview de DW_LSTINTER. (Zne ALT_PCE)                */
/*------------------------------------------------------------------*/
		End If

		If	sAltPs = "E"	Then
			itrTrans.IM_D01_W_INTER_BLOB ( lIdSin, lIdI, "PS" )
			If	Not F_Procedure ( stMessage, itrTrans, "IM_D01_W_INTER_BLOB" )	Then Return ( False )
/*------------------------------------------------------------------*/
/* Faire un SetItem sur LstInter ne sert à rien puisqu'il a été     */
/* fait sur SqlPreview de DW_LSTINTER. (Zne ALT_PS)                 */
/*------------------------------------------------------------------*/
		End If

		If	sAltPart	= "E"	Then
			itrTrans.IM_D01_W_INTER_BLOB ( lIdSin, lIdI, "CP" )
			If	Not F_Procedure ( stMessage, itrTrans, "IM_D01_W_INTER_BLOB" )	Then Return ( False )
/*------------------------------------------------------------------*/
/* Faire un SetItem sur LstInter ne sert à rien puisqu'il a été     */
/* fait sur SqlPreview de DW_LSTINTER. (Zne ALT_PART)               */
/*------------------------------------------------------------------*/
		End If

Next

/*------------------------------------------------------------------*/
/* On va maintenant mettre à jour les courriers. Ces courriers      */
/* peuvent être des créations ou des modifications. On va utiliser  */
/* une seule commande pour SqlServer. Cette commande fera           */
/* systématiquement un DELETE puis un INSERT du fichier WORD.       */
/*------------------------------------------------------------------*/
For	lCpt = 1	To lTotInter
		lIdI		= idw_LstInter.GetItemNumber ( lCpt, "ID_I" )
		dtMajLe	= idw_LstInter.GetItemDateTime ( lCpt, "MAJ_LE" )
		dtCreeLe	= dtMajLe

/*------------------------------------------------------------------*/
/* Autre PIECE.                                                     */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//		sNomFic	= isRepWin + "\TEMP\" + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".PC"
		sNomFic	= stGLB.sRepTempo + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".PC"
		sAltPce	= idw_LstInter.GetItemString ( lCpt, "ALT_PCE" )		

//Migration PB8-WYNIWYG-03/2006 FM
//		If	FileExists ( sNomfic ) And sAltPce = "O" Then
		If	f_FileExists ( sNomfic ) And sAltPce = "O" Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
			itrTrans.IM_I01_W_INTER_BLOB ( lIdSin, lIdI, "PC", dtCreeLe, dtMajLe, sMajPar )
			If	Not F_Procedure ( stMessage, itrTrans, "IM_I01_W_INTER_BLOB" )	Then Return ( False )
		End If

/*------------------------------------------------------------------*/
/* POST-SCRIPTUM.                                                   */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//		sNomFic	= isRepWin + "\TEMP\" + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".PS"
		sNomFic	= stGLB.sRepTempo + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".PS"
		sAltPs	= idw_LstInter.GetItemString ( lCpt, "ALT_PS" )

//Migration PB8-WYNIWYG-03/2006 FM
//		If	FileExists ( sNomfic ) And sAltPs = "O" Then
		If	f_FileExists ( sNomfic ) And sAltPs = "O" Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
			itrTrans.IM_I01_W_INTER_BLOB ( lIdSin, lIdI, "PS", dtCreeLe, dtMajLe, sMajPar )
			If	Not F_Procedure ( stMessage, itrTrans, "IM_I01_W_INTER_BLOB" )	Then Return ( False )
		End If

/*------------------------------------------------------------------*/
/* COURRIER PARTICULIER.                                            */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//		sNomFic	= isRepWin + "\TEMP\" + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".CP"
		sNomFic	= stGLB.sRepTempo + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".CP"		
		sAltPart	= idw_LstInter.GetItemString ( lCpt, "ALT_PART" )

//Migration PB8-WYNIWYG-03/2006 FM
//		If	FileExists ( sNomfic ) And sAltPart = "O" Then
		If	f_FileExists ( sNomfic ) And sAltPart = "O" Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
			itrTrans.IM_I01_W_INTER_BLOB ( lIdSin, lIdI, "CP", dtCreeLe, dtMajLe, sMajPar )
			If	Not F_Procedure ( stMessage, itrTrans, "IM_I01_W_INTER_BLOB" )	Then Return ( False )
		End If

Next

/*------------------------------------------------------------------*/
/* On s'occupe maintenant des DATAS. On va parcourir la DataWindow  */
/* W_COURRIER et insérer un enregistrement de DATA pour chacune     */
/* des lignes.                                                      */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Si le dossier est bloqué, la DataWindow est vide donc il n'y a   */
/* aucune insertion. Néammoins les DATAS précédentes seront         */
/* purgées. En effet, on envoie un DELETE systématique sur          */
/* W_COURRIER et W_INTER_BLOB (avec ID_TYP_BLOB = 'DT') (Voir       */
/* Uf_Terminer_Valider).                                            */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* La commande IM_I01_W_INTER_BLOB envoie systématiquement un       */
/* DELETE avant l'INSERT. Dans ce cas précis des DATAS, le DELETE   */
/* ne sert à rien car la commande DW_D01_W_COURRIER en effectue un  */
/* avant. Je laisse ainsi pour ne par réécrire une commande         */
/* d'INSERT toute simple (sans le DELETE).                          */
/*------------------------------------------------------------------*/

lTotwCourrier = idw_wCourrier.RowCount ()

For	lCpt = 1 To lTotwCourrier
/*------------------------------------------------------------------*/
/* On ne doit s'occuper que des courriers 'ORIGINAUX' (ID_CPT=0),   */
/* il ne faut pas s'occuper des doubles (ID_CPT=1).                 */
/*------------------------------------------------------------------*/
		lIdCpt	= idw_wCourrier.GetItemNumber ( lCpt, "ID_CPT" )

		If	lIdCpt = 0	Then
			lIdI		= idw_wCourrier.GetItemNumber ( lCpt, "ID_I" )
			dtCreeLe	= idw_wSin.GetItemDateTime ( 1, "MAJ_LE" )
			dtMajLe	= dtCreeLe

			itrTrans.IM_I01_W_INTER_BLOB ( lIdSin, lIdI, "DT", dtCreeLe, dtMajLe, sMajPar )
			If	Not F_Procedure ( stMessage, itrTrans, "IM_I01_W_INTER_BLOB" )	Then Return ( False )
		End If
Next


Return ( True )
end function

private subroutine uf_enregistrer_w_inter_blob_blob (ref s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Enregistrer_W_Inter_Blob_Blob (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 24/06/1998 10:30:06
//* Libellé			: 
//* Commentaires	: Gestion de table W_INTER_BLOB au niveau des BLOBS
//*
//* Arguments		: s_Pass			astPass			(Réf) Structure de passage
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* #1 DGA              19/09/2006              Gestion d'un répertoire temporaire DCMP-060643
//*-----------------------------------------------------------------

/*------------------------------------------------------------------*/
/* Si on arrive ici c'est que tout c'est bien passé pour les        */
/* commandes SQL du sinistre. On vient donc d'effectuer un COMMIT.  */
/* Il ne reste plus qu'à faire les UPDATEBLOB pour les paragraphes  */
/* WORD ainsi que pour les DATAS des courriers. Si tout se passe    */
/* bien on effectuera un COMMIT, sinon on fera un ROLLBACK. Il y    */
/* aura néammoins un décalage entre les données enregistrées et     */
/* les BLOBS.                                                       */
/*------------------------------------------------------------------*/

Boolean bRet

Blob blTxtBlob

Long lTotInter, lCpt, lIdI, lIdSin

String sNomFic, sAltPce, sAltPs, sAltPart, sErr

bRet			= True
lTotInter	= idw_LstInter.RowCount ()
lIdSin		= idw_wSin.GetItemNumber ( 1, "ID_SIN" )

For	lCpt = 1 To lTotInter
		lIdI		= idw_LstInter.GetItemNumber ( lCpt, "ID_I" )

/*------------------------------------------------------------------*/
/* Autre PIECE.                                                     */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//		sNomFic	= isRepWin + "\TEMP\" + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".PC"
		sNomFic	= stGLB.sRepTempo + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".PC"
		sAltPce	= idw_LstInter.GetItemString ( lCpt, "ALT_PCE" )
		SetNull ( blTxtBlob )

//Migration PB8-WYNIWYG-03/2006 FM
//		If	FileExists ( sNomfic ) And sAltPce = "O"	Then
		If	f_FileExists ( sNomfic ) And sAltPce = "O"	Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
			F_LireFichierBlob ( blTxtBlob, sNomFic )

			UPDATEBLOB	sysadm.w_inter_blob
			SET			txt_blob		= :blTxtBlob
			WHERE			id_sin		= :lIdSin
			AND			id_i			= :lIdI
			AND			id_typ_blob	= 'PC'
			USING			itrTrans			;

			If	itrTrans.SqlCode <> 0 Or itrTrans.SqldbCode <> 0 Then
				sErr	= "au paragraphe AUTRE PIECE (Id_Inter=" + String ( lIdI ) + " - Id_Sin=" + String ( lIdSin ) + ")"
				bRet	= False
				Exit
			End If
		End If

/*------------------------------------------------------------------*/
/* POST-SCRIPTUM.                                                   */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//		sNomFic	= isRepWin + "\TEMP\" + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".PS"
		sNomFic	= stGLB.sRepTempo + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".PS"
		sAltPs	= idw_LstInter.GetItemString ( lCpt, "ALT_PS" )
		SetNull ( blTxtBlob )

//Migration PB8-WYNIWYG-03/2006 FM
//		If	FileExists ( sNomfic ) And sAltPs = "O"	Then
		If	f_FileExists ( sNomfic ) And sAltPs = "O"	Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
			F_LireFichierBlob ( blTxtBlob, sNomFic )

			UPDATEBLOB	sysadm.w_inter_blob
			SET			txt_blob		= :blTxtBlob
			WHERE			id_sin			= :lIdSin
			AND			id_i			= :lIdI
			AND			id_typ_blob	= 'PS'
			USING			itrTrans			;

			If	itrTrans.SqlCode <> 0 Or itrTrans.SqldbCode <> 0 Then
				sErr	= "au paragraphe POST-SCRIPTUM (Id_Inter=" + String ( lIdI ) + " - Id_Sin=" + String ( lIdSin ) + ")"
				bRet = False
				Exit
			End If
		End If

/*------------------------------------------------------------------*/
/* COURRIER PARTICULIER.                                            */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//		sNomFic	= isRepWin + "\TEMP\" + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".CP"
		sNomFic	= stGLB.sRepTempo + String ( lIdI, "0000" ) + ".CP"
		sAltPart	= idw_LstInter.GetItemString ( lCpt, "ALT_PART" )
		SetNull ( blTxtBlob )

//Migration PB8-WYNIWYG-03/2006 FM
//		If	FileExists ( sNomfic ) And sAltPart = "O"	Then
		If	f_FileExists ( sNomfic ) And sAltPart = "O"	Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
			F_LireFichierBlob ( blTxtBlob, sNomFic )

			UPDATEBLOB	sysadm.w_inter_blob
			SET			txt_blob		= :blTxtBlob
			WHERE			id_sin		= :lIdSin
			AND			id_i			= :lIdI
			AND			id_typ_blob	= 'CP'
			USING			itrTrans			;

			If	itrTrans.SqlCode <> 0 Or itrTrans.SqldbCode <> 0 Then
				sErr	= "au COURRIER PARTICULIER (Id_Inter=" + String ( lIdI ) + " - Id_Sin=" + String ( lIdSin ) + ")"
				bRet = False
				Exit
			End If
		End If

/*------------------------------------------------------------------*/
/* DATAS.                                                           */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On ne s'occupe des DATAS que si le dossier n'est pas bloqué.     */
/*------------------------------------------------------------------*/
		If	idw_wSin.GetItemString ( 1, "ALT_BLOC" ) = "N"	Then
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//			sNomFic	= isRepWin + "\TEMP\" + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".DT"
			sNomFic	= stGLB.sRepTempo + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".DT"
			SetNull ( blTxtBlob )
/*------------------------------------------------------------------*/
/* On teste l'existence du fichier, mais celui-ci doit forcément    */
/* exister, en effet on est passé dans la fonction                  */
/* Uf_Determiner_Data_Sinistre().                                   */
/*------------------------------------------------------------------*/
//Migration PB8-WYNIWYG-03/2006 FM
//			If	FileExists ( sNomfic ) Then
			If	f_FileExists ( sNomfic ) Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
				F_LireFichierBlob ( blTxtBlob, sNomFic )

				UPDATEBLOB	sysadm.w_inter_blob
				SET			txt_blob		= :blTxtBlob
				WHERE			id_sin		= :lIdSin
				AND			id_i			= :lIdI
				AND			id_typ_blob	= 'DT'
				USING			itrTrans			;

				If	itrTrans.SqlCode <> 0 Or itrTrans.SqldbCode <> 0 Then
					sErr	= "au fichier des DATAS (Id_Inter=" + String ( lIdI ) + " - Id_Sin=" + String ( lIdSin ) + ")"
					bRet = False
					Exit
				End If
			End If
		End If

Next

If	bRet	Then
//	COMMIT USING itrTrans		;
	F_COMMIT ( itrTrans, TRUE ) // [PI056][TRANCOUNT][JFF][24/01/2020]
Else
//	ROLLBACK USING itrTrans		;
	F_COMMIT ( itrTrans, FALSE ) // [PI056][TRANCOUNT][JFF][24/01/2020]
End If

If	Not bRet	Then
/*------------------------------------------------------------------*/
/* S'il y a un problème, on affiche un message que l'on va tracer.  */
/* Le gestionnaire se retrouve avec un décalage entre ses données   */
/* et les BLOBS.                                                    */
/*------------------------------------------------------------------*/

	stMessage.sTitre		= "Validation des BLOBS (Fonction Uf_Enregistrer_W_Inter_Blob_Blob)"
	stMessage.Icon			= StopSign!
	stMessage.sVar[1] 	= sErr
	stMessage.bErreurG	= False
	stMessage.bTrace		= True
	stMessage.sCode		= "WSIN200"

	f_Message ( stMessage )

End If

astPass.bRetour = bRet
end subroutine

private function string uf_determiner_data_interlocuteur (long alcptinter);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Data_Interlocuteur (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 26/06/1998 11:39:15
//* Libellé			: 
//* Commentaires	: Gestion des DATAS pour les interlocuteurs
//*
//* Arguments		: Long			alCptInter			(Val) N° de l'interlocuteur en cours de traitement
//*
//* Retourne		: String				=	"" -> On continue
//*											<>	"" -> Une erreur est rencontrée, on arrête le contrôle de gestion
//*
//*-----------------------------------------------------------------
//* MAJ 			PAR		Date		Modification
//* DCMP990454	JFF		29/09/99 Affichage d'une info sur le CR afin de savoir s'il provient
//*										de la banque ou de l'assuré.
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   05/01/04	  DCMP 030483 Armement de ZVAR16 pour le code courrier ORANGE et
//*								  le nbre de courrier de l'inter
//			FPI	13/10/2010	[VDoc1416] civilité longue 4 à "Madame, Monsieur" 
//       JFF   06/11/2018 [PM451-1]
//       JFF   17/08/2020 [PM360-4]
//*-----------------------------------------------------------------

Long lLig, lTotCiv, lTotInter, lIdIDouble, lChoixMonnaie
Int  iIdInter
String sVal, sRet, sRech, sPos, sSeparateurMonnaie, sCivLongue

Dec {2} dcMtaReg

DataWindowChild dwChild
long	ll_ret

sRet = ""
sPos = ""

// [MIG1_COUR_EMAILING]
If F_CLE_A_TRUE ( "MIG1_COUR_EMAILING" ) Then
	IF ibMIG1_CourEmailing Then Return ""
End If 


/*------------------------------------------------------------------*/
/* CODE POSTAL DE L'INTERLOCUTEUR                                   */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "ADR_CP" )
	If	sVal = "00000" Then	sVal = ""
	iuoLibelle.Uf_SetValue ( "IADCPO", sVal )
/*------------------------------------------------------------------*/
/* ADRESSE 1 DE L'INTERLOCUTEUR                                     */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "ADR_1" )
	iuoLibelle.Uf_SetValue ( "IADR01", sVal )
/*------------------------------------------------------------------*/
/* ADRESSE 2 DE L'INTERLOCUTEUR                                     */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "ADR_2" )
	iuoLibelle.Uf_SetValue ( "IADR02", sVal )
/*------------------------------------------------------------------*/
/* VILLE DE L'INTERLOCUTEUR                                         */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "ADR_VILLE" )
	iuoLibelle.Uf_SetValue ( "IADVIL", sVal )
/*------------------------------------------------------------------*/
/* CIVILITE COURTE DE L'INTERLOCUTEUR                               */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.Describe ( "Evaluate ( 'LookUpDisplay ( COD_CIV )'," + String ( alCptInter ) + ") " )
	iuoLibelle.Uf_SetValue ( "ICIVIC", sVal )
/*------------------------------------------------------------------*/
/* CIVILITE LONGUE DE L'INTERLOCUTEUR                               */
/*------------------------------------------------------------------*/
	ll_ret = idw_LstInter.GetChild ( "COD_CIV", dwChild )		
	lTotCiv	= dwChild.RowCount ()
	sVal		= idw_LstInter.GetItemString ( alCptInter, "COD_CIV" )

	// [PM451-1]
	If sVal = "5" Then 						// [VDoc1416] [PM451-1]
		sVal = "4"
	End IF 
	
	sRech		= "ID_CODE = " + sVal
	lLig		= dwChild.Find ( sRech, 1, lTotCiv )
	sVal		= dwChild.GetItemString ( lLig, "LIB_CODE_LONG" )

	iuoLibelle.Uf_SetValue ( "ICIVIL", sVal )
/*------------------------------------------------------------------*/
/* MONTANT A REGLER                                                 */
/*------------------------------------------------------------------*/
	dcMtaReg					= idw_LstInter.GetItemNumber ( alCptInter, "MT_A_REG" )
	lChoixMonnaie 			= idw_Produit.GetItemNumber ( 1, "COD_EURO" )
	sSeparateurMonnaie 	= " "

	sVal = F_Monnaie ( dcMtaReg, lChoixMonnaie, sSeparateurMonnaie )
	iuoLibelle.Uf_SetValue ( "IMTREG", sVal )
/*------------------------------------------------------------------*/
/* Dans la foulée, on arme la variable ZVAR20 contenant la zone     */
/* NUM_LET_CHEQUE                                                   */
/*------------------------------------------------------------------*/
	This.uf_Determiner_Data_Inter_NumLetChq ( alCptInter, dcMtaReg, sVal )
	If sVal = "-1" Then
		sPos = "ALT_BLOC"
		Return ( sPos )
	Else
		iuoLibelle.Uf_SetValue ( "ZVAR20", sVal )
	End If

/*------------------------------------------------------------------*/
/* A L'ATTENTION DE                                                 */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "ADR_ATT" )
	iuoLibelle.Uf_SetValue ( "INTATT", sVal )
/*------------------------------------------------------------------*/
/* NOM DE L'INTERLOCUTEUR                                           */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "NOM" )
	iuoLibelle.Uf_SetValue ( "INTLIB", sVal )
/*------------------------------------------------------------------*/
/* VOS REFERENCES 1                                                 */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "V_REF1" )
	iuoLibelle.Uf_SetValue ( "IREF01", sVal )
/*------------------------------------------------------------------*/
/* VOS REFERENCES 2                                                 */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "V_REF2" )
	iuoLibelle.Uf_SetValue ( "IREF02", sVal )
/*------------------------------------------------------------------*/
/* RIB BANQUE DE L'INTERLOCUTEUR                                    */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "RIB_BQ" )
	iuoLibelle.Uf_SetValue ( "IRIBBQ", sVal )	
/*------------------------------------------------------------------*/
/* RIB CLE DE L'INTERLOCUTEUR                                       */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "RIB_CLE" )
	iuoLibelle.Uf_SetValue ( "IRIBCL", sVal )
/*------------------------------------------------------------------*/
/* RIB COMPTE DE L'INTERLOCUTEUR                                    */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "RIB_CPT" )

	// [PM360-4]
	sVal = Fill ( "X", 9 ) + Right ( sVal, 2 ) 
	
	iuoLibelle.Uf_SetValue ( "IRIBCP", sVal )
/*------------------------------------------------------------------*/
/* RIB GUICHET DE L'INTERLOCUTEUR                                   */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "RIB_GUI" )
	iuoLibelle.Uf_SetValue ( "IRIBGU", sVal )

/*------------------------------------------------------------------*/
/* DCMP990454 : Affichage d'une info sur le CR afin de savoir s'il  */
/* provient de la banque ou de l'assuré.                            */
/* On charge dans la variable ZVAR02, le COD_INTER.					  */
/*------------------------------------------------------------------*/
	sVal = idw_LstInter.GetItemString ( alCptInter, "COD_INTER" )
	iuoLibelle.Uf_SetValue ( "ZVAR02", sVal )

/*------------------------------------------------------------------*/
/* #1 DCMP030483																	  */
/* On charge dans la variable ZVAR03, Cher Monsieur DUPONT			  */
/* On prend les données de l'assuré !!, en effet on ne possède pas  */
/* le nom seul de l'inter, il est couplé au prénom malheureusement !*/
/*------------------------------------------------------------------*/
	idw_Wsin.GetChild ( "COD_CIV", dwChild )		
	lTotCiv	= dwChild.RowCount ()
//Migration PB8-WYNIWYG-03/2006 FM
	sRech		= "ID_CODE = " + idw_Wsin.GetItemString ( 1, "COD_CIV" )
//	sRech		= "ID_CODE = '" + idw_Wsin.GetItemString ( 1, "COD_CIV" ) + "'"
//Fin Migration PB8-WYNIWYG-03/2006 FM
	lLig		= dwChild.Find ( sRech, 1, lTotCiv )
	sVal		= dwChild.GetItemString ( lLig, "LIB_CODE_LONG" )
	sCivLongue = sVal

	// [PM451-1]
	Choose Case idw_Wsin.GetItemString ( 1, "COD_CIV" )
		// Masculin
		Case "1" 
			sVal = "Cher " + sCivLongue + " " + idw_Wsin.GetItemString ( 1, "NOM" )
		// Féminin
		Case "2", "3"
			sVal = "Chère " + sCivLongue + " " + idw_Wsin.GetItemString ( 1, "NOM" )
		// [VDoc1416]
		Case "4", "5" // [PM451-1]
			sVal=sCivLongue
		// Rien
		Case Else
			sVal = ""
	End Choose
	
	iuoLibelle.Uf_SetValue ( "ZVAR03", sVal )

/*------------------------------------------------------------------*/
/* ICOURD                                                           */
/*------------------------------------------------------------------*/
	If	idw_LstInter.GetItemString ( alCptInter, "ALT_COURGEST" ) = "D"	Then
		lIdIDouble	= idw_LstInter.GetItemNumber ( alCptInter, "ID_I_DB" )
		sRech			= "ID_I = " + String ( lIdIDouble )
		lTotInter	= idw_LstInter.RowCount ()
		lLig			= idw_LstInter.Find ( sRech, 1, lTotInter )

		sVal = Left ( idw_LstInter.GetItemString ( lLig, "ID_COUR" ), 1 )
		iuoLibelle.Uf_SetValue ( "ICOURD", sVal )
	End If

/*------------------------------------------------------------------*/
/* #1 DCMP030483																	  */
/* Ex : OSSPB006/V00-1															  */		
/* On charge dans la variable ZVAR16, le Le code courrier ORANGE    */
/*------------------------------------------------------------------*/
	iIdInter = idw_LstInter.GetItemNumber ( alCptInter, "ID_I" ) + 1
	If iIdInter <= UpperBound ( isTabVarOrange ) - 1 Then
		sVal = isTabVarOrange [ iIdInter, 1 ] + "-" + isTabVarOrange [ iIdInter, 2 ]
		iuoLibelle.Uf_SetValue ( "ZVAR16", sVal )
	End If

/*------------------------------------------------------------------*/
/* On détermine maintenant les variables de LISTE pour              */
/* l'interlocuteur courant.                                         */
/*------------------------------------------------------------------*/
	Uf_Determiner_Data_Interlocuteur_Liste_P ( alCptInter )
	Uf_Determiner_Data_Interlocuteur_Liste_R ( alCptInter )
	Uf_Determiner_Data_Interlocuteur_Liste_G ( alCptInter )


Return ( sPos )
end function

private subroutine uf_determiner_data_interlocuteur_liste_p (long alcptinter);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Data_Interlocuteur_Liste_P (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 26/06/1998 11:39:15
//* Libellé			: 
//* Commentaires	: Gestion des DATAS pour les interlocuteurs (Liste PCE)
//*
//* Arguments		: Long			alCptInter			(Val) N° de l'interlocuteur en cours de traitement
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* #1	FPI	05/06/2009	[DCMP090315] Modification de INBPCE pour LCL
//*-----------------------------------------------------------------

String sTriActuel, sFiltre, sFiltreNull, sTri, sRech, sIdPara, sIdParaLu, sLib, sVal, sVariable, sCodInter, sIdFour

Long lTotwPiece, lCpt, lTotwDetail, lIdGti, lIdDetail, lLigDet, lIdInter, lLigInter, lCodPce, lRow 

Integer iCptPara, iPos, iTotParaVar

//u_DeclarationFuncky uoDeclarationFuncky //[I037] Migration FUNCKy

//uoDeclarationFuncky = Create u_DeclarationFuncky

Long lDeb, lFin // #1

/*------------------------------------------------------------------*/
/* On récupére le Tri actuel sur la DW wPiece. En effet, on va      */
/* être obligé de changer le tri pendant le traitement. Il faudra   */
/* repositionner le bon ordre de tri à la fin du traitement.        */
/*------------------------------------------------------------------*/
sTriActuel	= idw_wPiece.Describe ( "DataWindow.Table.Sort" )
sTri 			= "ID_PARA A, ID_GTI A, ID_DETAIL A, CPT_TRI A"

/*------------------------------------------------------------------*/
/* On sélectionne toutes les pièces réclamées pour l'interlocuteur  */
/* en cours au niveau des détails. Les pièces réclamées pour la     */
/* garantie ne sont pas a prendre en compte. On ne s'interesse      */
/* qu'aux paragraphes commencant par 'L'                            */
/*------------------------------------------------------------------*/

lIdInter 	= idw_LstInter.GetItemNumber ( alCptInter, "ID_I" )
sFiltreNull = ""
sFiltre 		= "ID_DETAIL <> -1 And Left ( ID_PARA, 1 ) = 'L' And ID_I = " + String ( lIdInter )

idw_wPiece.SetFilter ( sFiltre )
idw_wPiece.Filter ()

idw_wPiece.SetSort ( sTri )
idw_wPiece.Sort ()

lTotwPiece 	= idw_wPiece.RowCount ()
lTotwDetail = idw_wDetail.RowCount ()

sIdParaLu	= ""
sVal			= ""
iCptPara		= 0

For	lCpt = 1 To lTotwPiece
/*------------------------------------------------------------------*/
/* On va vérifier si le libellé du détail doit apparaître sur le    */
/* courrier. (Vérification sur la DW wDetail avec ALT_COUR = 'O').  */
/*------------------------------------------------------------------*/
		lIdGti 		= idw_wPiece.GetItemNumber ( lCpt, "ID_GTI" )
		lIdDetail 	= idw_wPiece.GetItemNumber ( lCpt, "ID_DETAIL" )

/*------------------------------------------------------------------*/
/* Modification DBI du 06/10/1998                                   */
/* Lorsque le gestionnaire saisi une demande de pièce, que la       */
/* machine détermine une refus et que le gestionnaire ne peut pas   */
/* aller contre la décision                                         */
/* machine le détail est refusé alors qu'une pièce est cochée.      */
/* Il ne faut donc pas insérer la pièce dans le courrier.           */
/*------------------------------------------------------------------*/

		sRech = 	"ID_GTI = " + String ( lIdGti ) + " And ID_DETAIL = " + String ( lIdDetail ) + &
					" And ALT_COUR = 'O' AND COD_ETAT = 100"
		lLigDet = idw_wDetail.Find ( sRech, 1, lTotwDetail )
/*------------------------------------------------------------------*/
/* Le libellé du détail ne doit pas apparaître. On passe donc à la  */
/* pièce suivante.                                                  */
/*------------------------------------------------------------------*/
		If	lLigDet = 0	Then Continue

/*------------------------------------------------------------------*/
/* On récupére le nom de paragraphe que l'on vient de trouver.      */
/*------------------------------------------------------------------*/
		sIdPara = idw_wPiece.GetItemString ( lCpt, "ID_PARA" )

/*------------------------------------------------------------------*/
/* Ce paragraphe est-il différent du dernier lu ?                   */
/*------------------------------------------------------------------*/
		If	sIdPara <> sIdParaLu	Then
			If	iCptPara > 1	And iCptPara <> 0	Then
/*------------------------------------------------------------------*/
/* Il y a plus de un paragraphe, il faut remplacer la dernière      */
/* virgule par ' et '.                                              */
/*------------------------------------------------------------------*/
//				iPos = uoDeclarationFuncky.Uf_AtLast ( ",", sVal )
				iPos = LastPos ( sVal, "," )
				sVal = Replace ( sVal, iPos, 2, " et " )
			End If
/*------------------------------------------------------------------*/
/* On insére maintenant la variable dans le tableau. (Sauf dans le  */
/* cas ou iCpt=0 car il s'agit du premier paragraphe que l'on       */
/* traite).                                                         */
/*------------------------------------------------------------------*/
			If	iCptPara >= 1	And iCptPara <> 0 Then
				sVariable = "CP" + sIdParaLu
				iuoLibelle.Uf_SetValue ( sVariable, sVal )
			End If
/*------------------------------------------------------------------*/
/* On réarme les compteurs.                                         */
/*------------------------------------------------------------------*/
			iCptPara		= 1
			sIdParaLu	= sIdPara
			sVal 			= idw_wDetail.GetItemString ( lLigDet, "LIB_DET" )

/*------------------------------------------------------------------*/
/* Le paragraphe que l'on traite est toujous identique, on          */
/* concaténe la variable de liste.                                  */
/*------------------------------------------------------------------*/
		Else
			iCptPara ++
			sLib = idw_wDetail.GetItemString ( lLigDet, "LIB_DET" )
			sVal = sVal + ", " + sLib				
		End If
Next

/*------------------------------------------------------------------*/
/* Il ne reste plus qu'a armer le dernier paragraphe lu dans le     */
/* tableau.                                                         */
/*------------------------------------------------------------------*/
If	iCptPara > 1 And iCptPara <> 0 Then
//	iPos = uoDeclarationFuncky.Uf_AtLast ( ",", sVal )
	iPos = LastPos ( sVal, "," )
	sVal = Replace ( sVal, iPos, 2, " et " )
End If

If	iCptPara >= 1 And iCptPara <> 0 Then
/*------------------------------------------------------------------*/
/* On insére maintenant la variable dans le tableau.                */
/*------------------------------------------------------------------*/
	sVariable = "CP" + sIdParaLu
	iuoLibelle.Uf_SetValue ( sVariable, sVal )
/*------------------------------------------------------------------*/


/* La variable iTotParaVar sert à armer la variable INBPCE.         */
/*------------------------------------------------------------------*/
End If

/*------------------------------------------------------------------*/
/* Modification DBI le 29/09/1998                                   */
/* Le chargement des variables de liste fonctionne correctement     */
/* mais la variable INBPCE pose pb car elle ne tient pas compte     */
/* des paragraphes de pièces des garanties et des détails avec      */
/* para ne commençant pas par L                                     */
/*------------------------------------------------------------------*/

iTotParaVar	= 0
sFiltre 		= "ID_I = " + String ( lIdInter )

idw_wPiece.SetFilter ( sFiltre )
idw_wPiece.Filter ()

idw_wPiece.SetSort ( sTri )
idw_wPiece.Sort ()

lTotwPiece 	= idw_wPiece.RowCount ()
lTotwDetail = idw_wDetail.RowCount ()

sIdParaLu	= ""
sVal			= ""
iCptPara		= 0
iTotParaVar	= 0

For	lCpt = 1 To lTotwPiece

		lIdGti 		= idw_wPiece.GetItemNumber ( lCpt, "ID_GTI" )
		lIdDetail 	= idw_wPiece.GetItemNumber ( lCpt, "ID_DETAIL" )

/*------------------------------------------------------------------*/
/* Dans le cas d'un détail, on vérifie s'il doit apparaitre sur le  */
/* courrier.                                                        */
/*------------------------------------------------------------------*/

		If lIdDetail <> -1 Then
/*------------------------------------------------------------------*/
/* On va vérifier si le libellé du détail doit apparaître sur le    */
/* courrier. (Vérification sur la DW wDetail avec ALT_COUR = 'O').  */
/*------------------------------------------------------------------*/

			sRech = "ID_GTI = " + String ( lIdGti ) + " And ID_DETAIL = " + String ( lIdDetail ) + " And ALT_COUR = 'O'"
			lLigDet = idw_wDetail.Find ( sRech, 1, lTotwDetail )

/*------------------------------------------------------------------*/
/* Le libellé du détail ne doit pas apparaître. On passe donc à la  */
/* pièce suivante.                                                  */
/*------------------------------------------------------------------*/
			If	lLigDet = 0	Then Continue

		End If

/*------------------------------------------------------------------*/
/* On récupére le nom de paragraphe que l'on vient de trouver.      */
/*------------------------------------------------------------------*/
		sIdPara = idw_wPiece.GetItemString ( lCpt, "ID_PARA" )

/*------------------------------------------------------------------*/
/* Ce paragraphe est-il différent du dernier lu ?                   */
/*------------------------------------------------------------------*/
		If	sIdPara <> sIdParaLu	Then

/*------------------------------------------------------------------*/
/* La variable iTotParaVar sert à armer la variable INBPCE.         */
/*------------------------------------------------------------------*/
			iTotParaVar ++
		End If
		sIdParaLu	= sIdPara
Next

/*------------------------------------------------------------------*/
/* On gère maintenant le cas du paragraphe autre pièce.             */
/*------------------------------------------------------------------*/

lLigInter	=	idw_LstInter.Find ( "ID_I = " + String ( lIdInter ), 1, idw_LstInter.RowCount () )

If idw_LstInter.GetItemString ( lLigInter, "ALT_PCE" ) = 'O' Then iTotParaVar ++

/*------------------------------------------------------------------*/
/* On arme la variable INBPCE.                                      */
/*------------------------------------------------------------------*/
sVal = String ( iTotParaVar )
iuoLibelle.Uf_SetValue ( "INBPCE", sVal )

// #1 [DCMP090315]
f_rechdetpro(lDeb, lFin, idw_DetPro, idw_wSin.Getitemnumber( 1, "ID_PROD"),"-DP",113)
if lDeb > 0 and iTotParaVar > 0 Then
	sVal = String ( iTotParaVar + 1)
	iuoLibelle.Uf_SetValue ( "INBPCE", sVal )
End If
// #1 [DCMP090315] - Fin

/*------------------------------------------------------------------*/
/* On positionne le filtre à NULL. On remet l'ordre de tri initial. */
/*------------------------------------------------------------------*/
idw_wPiece.SetFilter ( sFiltreNull )
idw_wPiece.Filter ()

idw_wPiece.SetSort ( sTriActuel )
idw_wPiece.Sort ()

//Destroy uoDeclarationFuncky

end subroutine

private subroutine uf_determiner_data_interlocuteur_liste_r (long alcptinter);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Data_Interlocuteur_Liste_R (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 26/06/1998 11:39:15
//* Libellé			: 
//* Commentaires	: Gestion des DATAS pour les interlocuteurs (Liste REF)
//*
//* Arguments		: Long			alCptInter			(Val) N° de l'interlocuteur en cours de traitement
//*
//* Retourne		: Rien
//*-----------------------------------------------------------------
//* #1   JFF   15/01/2007  DCMP070016 Gestion de libellé de refus.
//*-----------------------------------------------------------------

String sFiltre, sFiltreNull, sRech, sLib, sVal, sTriActuel, sTri, sIdParaLu, sIdPara

Long lTotwRefus, lCpt, lTotwDetail, lIdGti, lIdDetail 
Long lLigDet, lIdInter, lTotwGti, lTotTrt, lCptTrt, lCpt78, lDeb, lFin
String sIdTrt[]

Boolean bDoubleTrt

Integer iCptPara, iPos, iTotParaVar

//u_DeclarationFuncky uoDeclarationFuncky //[I037] Migration FUNCKy

//uoDeclarationFuncky = Create u_DeclarationFuncky

/*------------------------------------------------------------------*/
/* On récupére le Tri actuel sur la DW wRefus. En effet, on va      */
/* être obligé de changer le tri pendant le traitement. Il faudra   */
/* repositionner le bon ordre de tri à la fin du traitement.        */
/*------------------------------------------------------------------*/
sTriActuel	= idw_wRefus.Describe ( "DataWindow.Table.Sort" )
sTri 			= "ID_PARA A, ID_GTI A, ID_DETAIL A, CPT_TRI A"

/*------------------------------------------------------------------*/
/* La DW wRefus est triée sur ID_GTI, ID_DETAIL, CPT_TRI. On va     */
/* trier cette DataWindow pour voir s'il existe au moins un motif   */
/* de positionné pour l'interlocuteur en cours. On va ensuite       */
/* vérifier que le détail associé à ce motif est en cours de        */
/* validation (ALT_VALIDE=O), que le code état du motif est         */
/* refusé(COD_ETAT=XXX) et que le libellé du détail doit            */
/* apparaitre sur le courrier (ALT_COUR=O).                         */
/*------------------------------------------------------------------*/
lIdInter 	= idw_LstInter.GetItemNumber ( alCptInter, "ID_I" )
sFiltreNull = ""
sFiltre 		= "ID_DETAIL <> -1 And ID_I = " + String ( lIdInter )

idw_wRefus.SetFilter ( sFiltre )
idw_wRefus.Filter ()

lTotwRefus 	= idw_wRefus.RowCount ()
lTotwDetail = idw_wDetail.RowCount ()
lTotTrt		= 0

iCptPara		= 0
sVal			= ""

For	lCpt = 1 To lTotwRefus
/*------------------------------------------------------------------*/
/* On va vérifier :                                                 */
/* 	* L'état du détail                                            */
/* 	* Si ce détail est à valider                                  */
/* 	* Si le gestionnaire veut faire apparaître le libellé         */
/*------------------------------------------------------------------*/
		bDoubleTrt	= False
		lIdGti 		= idw_wRefus.GetItemNumber ( lCpt, "ID_GTI" )
		lIdDetail 	= idw_wRefus.GetItemNumber ( lCpt, "ID_DETAIL" )

		sRech = "ID_GTI = " + String ( lIdGti ) + " And ID_DETAIL = " + String ( lIdDetail ) + " And ALT_COUR = 'O' And ALT_VALIDE = 'O' "
		sRech = sRech + " And COD_ETAT = 200"
		lLigDet = idw_wDetail.Find ( sRech, 1, lTotwDetail )
/*------------------------------------------------------------------*/
/* Le détail ne correspond pas, on passe au suivant.                */
/*------------------------------------------------------------------*/
		If	lLigDet = 0	Then Continue

/*------------------------------------------------------------------*/
/* Le 04/01/1999                                                    */
/* Il peut y avoir plusieurs refus pour un même détail. Dans ce     */
/* cas, il ne faut faire apparaître le libellé qu'une seule fois    */
/* sur le courrier.                                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Le 13/01/1999                                                    */
/* Il y a un autre bug. En effet, il peut y avoir N ID_DETAIL       */
/* identiques pour différentes garanties. Il faut donc gérer la     */
/* garantie dans le tableau.                                        */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On gére un tableau des détails armés dans cette boucle. Si le    */
/* détail est déjà présent dans le tableau, on ne traite pas le     */
/* refus. Sinon on ajoute ce détail au tableau.                     */
/*------------------------------------------------------------------*/
		For	lCptTrt	= 1 To lTotTrt
				If	sIdTrt[ lCptTrt ] = String ( lIdGti ) + String ( lIdDetail )	Then bDoubleTrt = True
		Next

		If	Not bDoubleTrt	Then
			lTotTrt ++
			sIdTrt[ lTotTrt ] = String ( lIdGti ) + String ( lIdDetail )
		Else
			Continue
		End If

/*------------------------------------------------------------------*/
/* On arme le libellé.                                              */
/*------------------------------------------------------------------*/
		iCptPara ++
		sLib = idw_wDetail.GetItemString ( lLigDet, "LIB_DET" )

		If	iCptPara = 1	Then
			sVal = sLib
		Else
			sVal = sVal + ", " + sLib
		End If
Next

/*------------------------------------------------------------------*/
/*                                                                  */
/* Modification DBI le 20/10/1998                                   */
/* Il y a un problème lors de l'édition des courriers pour          */
/* lesquels un refus de la garantie est formulé.                    */
/* En effet, la phrase d'introduction au refus a besoin d'un        */
/* libellé et si il s'agit d'un refus pour toute la garantie        */
/* le libellé n'est pas armé.                                       */
/*                                                                  */
/* je vais donc géré 2 cas :                                        */
/*  Refus de la garantie avec au moins 1 détail avec alt_cour =     */
/* 'O'                                                              */
/*   j'utilise le libellé du détail                                 */
/*                                                                  */
/*  Refus de la garantie sans détail avec alt_cour = 'O'            */
/*   je vais chercher un libellé par défaut pour la garantie dans   */
/* le fichier Ini de l'application.                                 */
/*------------------------------------------------------------------*/

sFiltre 		= "ID_DETAIL = -1 And ID_I = " + String ( lIdInter )

idw_wRefus.SetFilter ( sFiltre )
idw_wRefus.Filter ()

lTotwRefus 	= idw_wRefus.RowCount ()
lTotwGti 	= idw_LstGti.RowCount ()

For	lCpt = 1 To lTotwRefus
/*------------------------------------------------------------------*/
/* On va vérifier :                                                 */
/* 	* L'état de la garantie ( 200 refusé )                        */
/* 	* Si elle est à valider                                       */
/*------------------------------------------------------------------*/
		lIdGti 		= idw_wRefus.GetItemNumber ( lCpt, "ID_GTI" )

		sRech = "ID_GTI = " + String ( lIdGti ) + " And ALT_VALIDE = 'O' And COD_ETAT = 200"

		lLigDet = idw_LstGti.Find ( sRech, 1, lTotwGti )
/*------------------------------------------------------------------*/
/* La garantie ne correspond pas, on passe à la suivante.           */
/*------------------------------------------------------------------*/

		If	lLigDet = 0	Then Continue

/*------------------------------------------------------------------*/
/* La garantie est refusée et doit apparaitre  comme tel dans le    */
/* courrier adressé à l'interlocuteur                               */
/* On regarde maintenant si un détail est saisi et si on peut       */
/* utiliser son libellé.                                            */
/*------------------------------------------------------------------*/

		sRech 	= "ID_GTI = " + String ( lIdGti ) + " And ALT_COUR = 'O' And ALT_VALIDE = 'O' "
		lLigDet 	= idw_wDetail.Find ( sRech, 1, lTotwDetail )

		If lLigDet > 0 Then
/*------------------------------------------------------------------*/
/* Un libellé associé à un détail peut convenir. Je regarde s'il    */
/* n'est pas déjà présent dans la variable.                         */
/*------------------------------------------------------------------*/

			sLib 		= idw_wDetail.GetItemString ( lLigDet, "LIB_DET" )
		Else
/*------------------------------------------------------------------*/
/* Aucun libellé de détail. On insère celui par défaut défini pour  */
/* la garantie et présent dans le fichier Ini.                      */
/*------------------------------------------------------------------*/
			// #1
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 78 )
			If lDeb > 0 Then


				// sLib		= ProfileString ( stGlb.sFichierIni, "REFUS_GTI", String ( lIdGti ), "" ) #1

				lDeb = idw_DetPro.Find ( "id_code_num = " + String ( lIdGti ), lDeb, lFin )
				If lDeb > 0 Then
					sLib = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) )
				Else
					sLib = ""
				End If
				
			Else
				sLib = ""
			End If
			// /#1
		End If


		If Pos ( sVal, sLib ) = 0 Then
/*------------------------------------------------------------------*/
/* Le libellé n'est pas présent dans la variable. On l'insère       */
/* maintenant.                                                      */
/*------------------------------------------------------------------*/

			iCptPara ++
			If	iCptPara = 1	Then
				sVal = sLib
			Else
				sVal = sVal + ", " + sLib
			End If
		End If

Next

//*------------------------------------------------------------------*/
//* Fin modification DBI                                             */
//*------------------------------------------------------------------*/


/*------------------------------------------------------------------*/
/* On procéde à la modification de la virgule si besoin.            */
/*------------------------------------------------------------------*/
If	iCptPara > 1	And iCptPara <> 0	Then
//	iPos = uoDeclarationFuncky.Uf_AtLast ( ",", sVal )
	iPos = LastPos ( sVal, "," )
	sVal = Replace ( sVal, iPos, 2, " et " )
End If

/*------------------------------------------------------------------*/
/* On insére maintenant la variable dans le tableau.                */
/*------------------------------------------------------------------*/
If	iCptPara >= 1 And iCptPara <> 0 Then
	iuoLibelle.Uf_SetValue ( "CRLRE1", sVal )
End If

/*------------------------------------------------------------------*/
/* Modification DBI le 29/09/1998                                   */
/* Le calcul de INBREF pose problème car il ne tient pas compte     */
/* des refus de la garantie                                         */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* On arme la variable INBREF.                                      */
/*------------------------------------------------------------------*/

sFiltre 		= "ID_I = " + String ( lIdInter )

idw_wRefus.SetFilter ( sFiltre )
idw_wRefus.Filter ()

idw_wRefus.SetSort ( sTri )
idw_wRefus.Sort 	 ( )

lTotwRefus 	= idw_wRefus.RowCount 	()
lTotwDetail = idw_wDetail.RowCount 	()
lTotwGti		= idw_LstGti.RowCount 	()

sIdParaLu	= ""
iTotParaVar	= 0

For	lCpt = 1 To lTotwRefus

		lIdGti 		= idw_wRefus.GetItemNumber ( lCpt, "ID_GTI"     )
		lIdDetail 	= idw_wRefus.GetItemNumber ( lCpt, "ID_DETAIL"  )
/*------------------------------------------------------------------*/
/* Dans le cas d'un détail, on vérifie s'il doit apparaitre sur le  */
/* courrier.                                                        */
/*------------------------------------------------------------------*/

		If lIdDetail <> -1 Then
/*------------------------------------------------------------------*/
/* On va vérifier si le libellé du détail doit apparaître sur le    */
/* courrier. (Vérification sur la DW wDetail avec ALT_COUR = 'O').  */
/*------------------------------------------------------------------*/

			sRech = "ID_GTI     = " + String ( lIdGti ) 		+ " AND " + &
					  "ID_DETAIL  = " + String ( lIdDetail ) 	+ " AND " + &
					  "ALT_COUR   = 'O'"								+ " AND " + &
					  "COD_ETAT   = 200"								+ " AND " + &
					  "ALT_VALIDE = 'O'"

			lLigDet = idw_wDetail.Find ( sRech, 1, lTotwDetail )

/*------------------------------------------------------------------*/
/* Le libellé du détail ne doit pas apparaître. On passe donc à la  */
/* pièce suivante.                                                  */
/*------------------------------------------------------------------*/

		Else

			sRech   	= 	"ID_GTI     = " + String ( lIdGti ) 		+ " AND " + &
					  		"COD_ETAT   = 200"								+ " AND " + &
					  		"ALT_VALIDE = 'O'"

			lLigDet 	= 	idw_LstGti.Find ( sRech, 1, lTotwGti )

		End If

		If	lLigDet = 0	Then Continue

/*------------------------------------------------------------------*/
/* On récupére le nom de paragraphe que l'on vient de trouver.      */
/*------------------------------------------------------------------*/
		sIdPara = idw_wRefus.GetItemString ( lCpt, "ID_PARA" )

/*------------------------------------------------------------------*/
/* Ce paragraphe est-il différent du dernier lu ?                   */
/*------------------------------------------------------------------*/
		If	sIdPara <> sIdParaLu	Then

/*------------------------------------------------------------------*/
/* La variable iTotParaVar sert à armer la variable INBPCE.         */
/*------------------------------------------------------------------*/
			iTotParaVar ++
		End If
		sIdParaLu	= sIdPara
Next

sVal = String ( iTotParaVar )
iuoLibelle.Uf_SetValue ( "INBREF", sVal )

/*------------------------------------------------------------------*/
/* On positionne le filtre à NULL.                                  */
/*------------------------------------------------------------------*/
idw_wRefus.SetFilter ( sFiltreNull )
idw_wRefus.Filter ()

idw_wRefus.SetSort ( sTriActuel )
idw_wRefus.Sort 	 ( )

//Destroy uoDeclarationFuncky

end subroutine

private subroutine uf_determiner_data_interlocuteur_liste_g (long alcptinter);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Data_Interlocuteur_Liste_G (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 26/06/1998 11:39:15
//* Libellé			: 
//* Commentaires	: Gestion des DATAS pour les interlocuteurs (Liste détail REG)
//*
//* Arguments		: Long			alCptInter			(Val) N° de l'interlocuteur en cours de traitement
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

String sFiltre, sFiltreNull, sLib, sVal

Long lCpt, lTotwDetail, lIdInter, lTotwFrais

Integer iCptPara, iPos

//u_DeclarationFuncky uoDeclarationFuncky //[I037] Migration FUNCKy

//uoDeclarationFuncky = Create u_DeclarationFuncky

lIdInter 	= idw_LstInter.GetItemNumber ( alCptInter, "ID_I" )
iCptPara		= 0
sVal			= ""
sFiltreNull = ""

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Table W_DETAIL.                                                  */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On va trier la DW wDetail sur ID_I_REG. On va ensuite vérifier   */
/* que le détail posséde un code état 'A REGLER' (COD_ETAT=500) et  */
/* que le libellé du détail doit apparaître sur le courrier         */
/* (ALT_COUR=O).                                                    */
/*------------------------------------------------------------------*/
sFiltre 		= "ID_I_REG = " + String ( lIdInter ) + " And ALT_COUR = 'O' And COD_ETAT = 500"

idw_wDetail.SetFilter ( sFiltre )
idw_wDetail.Filter ()
idw_wDetail.Sort ()

lTotwDetail = idw_wDetail.RowCount ()

For	lCpt = 1 To lTotwDetail
/*------------------------------------------------------------------*/
/* On arme le libellé.                                              */
/*------------------------------------------------------------------*/
		iCptPara ++
		sLib = idw_wDetail.GetItemString ( lCpt, "LIB_DET" )
		If	iCptPara = 1	Then
			sVal = sLib
		Else
			sVal = sVal + ", " + sLib
		End If
Next

/*------------------------------------------------------------------*/
/* On positionne le filtre à NULL.                                  */
/*------------------------------------------------------------------*/
idw_wDetail.SetFilter ( sFiltreNull )
idw_wDetail.Filter ()
idw_wDetail.Sort ()

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Table W_FRAIS.                                                   */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On va trier la DW wFrais sur ID_I. On va ensuite vérifier que    */
/* le frais posséde un code état 'A REGLER' (COD_ETAT=500) et que   */
/* le libellé de frais doit apparaitre sur le courrier (ALT_COUR=   */
/* O).                                                              */
/*------------------------------------------------------------------*/
sFiltre 	= "ID_I = " + String ( lIdInter ) + " And ALT_COUR = 'O' And COD_ETAT = 500"

idw_wFrais.SetFilter ( sFiltre )
idw_wFrais.Filter ()
idw_wFrais.Sort ()

lTotwFrais = idw_wFrais.RowCount ()

For	lCpt = 1 To lTotwFrais
/*------------------------------------------------------------------*/
/* On arme le libellé.                                              */
/*------------------------------------------------------------------*/
		iCptPara ++
		sLib = idw_wFrais.GetItemString ( lCpt, "LIB_FRAIS" )
		If	iCptPara = 1	Then
			sVal = sLib
		Else
			sVal = sVal + ", " + sLib
		End If
Next

/*------------------------------------------------------------------*/
/* On positionne le filtre à NULL.                                  */
/*------------------------------------------------------------------*/
idw_wFrais.SetFilter ( sFiltreNull )
idw_wFrais.Filter ()
idw_wFrais.Sort ()


/*------------------------------------------------------------------*/
/* On procéde à la modification de la virgule si besoin.            */
/*------------------------------------------------------------------*/
If	iCptPara > 1	And iCptPara <> 0	Then
//	iPos = uoDeclarationFuncky.Uf_AtLast ( ",", sVal )
	iPos = LastPos ( sVal, "," )
	sVal = Replace ( sVal, iPos, 2, " et " )
End If

/*------------------------------------------------------------------*/
/* On insére maintenant la variable dans le tableau.                */
/*------------------------------------------------------------------*/
If	iCptPara >= 1 And iCptPara <> 0 Then
	iuoLibelle.Uf_SetValue ( "ILREGL", sVal )
End If

//Destroy uoDeclarationFuncky

end subroutine

private function string uf_calcul_montant_inter ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Calcul_Montant_Inter (PRIVATE)
//* Auteur			: DBI
//* Date				: 18/08/1998 15:07:49
//* Libellé			: 
//* Commentaires	: Calcul du Montant à régler par interlocuteur
//*
//* Arguments		: Aucun
//*
//* Retourne		: String
//*
//*-----------------------------------------------------------------
//* #1 	 JCA      13/06/2007 DCMP 070399 - Contrôle de validité du RIB
//* #2    JFF      22/04/2008 Suite Bug remonté par NBE et HM, le contrôle du mode
//*								   de réglement est erroné.
//* #3    JFF      21/05/2008 [3SUISSE].COD_MODE_REG 
//			FPI	11/10/2013	[VDoc12394]
//       JFF   11/10/2016 [DT076-2]
//       JFF   07/11/2016 [PC151259]
// 		JFF   03/03/2017 [VDOC23062]
//       JFF   29/05/2017 [PC151259-2]
//       JFF   06/11/2017 [PC171933]
//       JFF   17/08/2020 [PM360-4]
//*-----------------------------------------------------------------

Long			lCpt, lCptG, lNbInter, lNbGti, lNbDet, lLig, lCptD, lCptF, lNbFrais

Decimal {0}	dcCodEtatG, dcCptIAreg, dcIdI, dcIdGti
Decimal {2}	dcMtAReg, dcMtaRegSin
String	sRech, sModeReg, sRet = "", sVal, sOrdreCheque
string sRibBq, sRibGui, sRibCpt, sRibCle	// #1
// #3 [3SUISSE].COD_MODE_REG 
Long lDeb, lFin, lCptModeReg
n_cst_string lnvPFCString
String sCodInterAutorise, sCodInter
Boolean bAutorise
// #3 [3SUISSE].COD_MODE_REG 

/*------------------------------------------------------------------*/
/* Ce calcul s'effectue à partir de la zone cpt_i_areg de           */
/* w_gar_sin                                                        */
/*                                                                  */
/* Lors du calcul du montant à régler d'une garantie,               */
/* trois cas                                                        */
/* ayant une influence sur le montant à régler par interlocuteur    */
/* peuvent se produire.                                             */
/*                                                                  */
/* cas N° 1 : Il n'y a qu'un seul interlocuteur qui doit faire      */
/* l'objet d'un règlement sur la garantie                           */
/*                                                                  */
/* 	( Cas le plus fréquent )                                      */
/*                                                                  */
/* Ce cas est le plus simple pour connaître le montant à régler à   */
/* l'interlocuteur, il suffit de prendre la zone                    */
/* w_gar_sin.mt_plaf_areg                                           */
/*                                                                  */
/* cas N° 2 : Il y a plusieurs interlocuteurs à régler sur la       */
/* garantie et aucun plafond sur la garantie n'a été détecté.       */
/*                                                                  */
/* Dans ce cas, le montant à régler à l'interlocuteur pour la       */
/* garantie correspond à la somme de w_detail.mt_plaf dont          */
/* code_etat = 500 et id_i_reg = inter en cours                     */
/*                                                                  */
/* Cas n° 3 : Il y a plusieurs interlocuteurs à règler sur la       */
/* garantie et au moins un plafond pour celle ci a été détecté.     */
/*                                                                  */
/*   ( Cas le moins fréquent )                                      */
/*                                                                  */
/* Dans ce cas, l'utilisateur sera bloqué lors du contrôle de la    */
/* garantie car il est impossible pour la machine de répartir le    */
/* montant plafonné entre les différents interlocuteurs.            */
/* L'utilisateur devra forcer les montants des détails pour         */
/* indiquer le montant qu'il souhaite régler et à qui.              */
/*------------------------------------------------------------------*/

lNbInter		=	iDw_LstInter.RowCount ()
lNbGti		=	iDw_LstGti.RowCount   ()
lNbDet		=	iDw_wDetail.RowCount  ()
lNbFrais		=	iDw_wFrais.RowCount   ()
dcMtaRegSin = 0

For lCpt = 1 To lNbInter

	dcMtAReg	=	0
	dcIdI		= 	iDw_LstInter.GetItemNumber ( lCpt, "ID_I" )		

	For lCptG = 1 To lNbGti

		dcCodEtatG	=	iDw_LstGti.GetItemNumber ( lCptG, "COD_ETAT" 	)
		dcCptIAreg	=	iDw_LstGti.GetItemNumber ( lCptG, "CPT_I_AREG" 	)		
		dcIdGti		=	iDw_LstGti.GetItemNumber ( lCptG, "ID_GTI" 		)		

/*------------------------------------------------------------------*/
/* On ne traite la garantie que si elle fait l'objet d'un règlement */
/*------------------------------------------------------------------*/

		If ( dcCodEtatG = 500 ) Or ( dcCodEtatG = 550 ) Then

			sRech	=	"ID_GTI = " + String ( dcIdGti ) + " and COD_ETAT = 500 and ID_I_REG = " + String ( dcIdI )
			lLig	=	idw_wDetail.Find ( sRech, 1, lNbDet )

/*------------------------------------------------------------------*/
/* Il y a au moins un détail à régler à l'interlocuteur             */
/*------------------------------------------------------------------*/

			If lLig > 0 Then
	
				Choose Case dcCptIAreg
				Case 1 
/*------------------------------------------------------------------*/
/* 1 seul interlocuteur à régler sur la garantie                    */
/* On utilise le montant plafonné à régler sur la garantie          */
/*------------------------------------------------------------------*/

					dcMtAReg += iDw_LstGti.GetItemNumber ( lCptG, "MT_PLAF_AREG" )
				Case is > 1
/*------------------------------------------------------------------*/
/* Plusieurs interlocuteurs à régler sur la garantie                */
/* On additionne les montants plafonnés des détails à régler à      */
/* l'interlocuteur                                                  */
/*------------------------------------------------------------------*/

					For lCptD = 1 To lNbDet

						If ( iDw_wDetail.GetItemNumber ( lCptD, "ID_GTI"   ) = dcIdGti ) And &
							( iDw_wDetail.GetItemNumber ( lCptD, "COD_ETAT" ) = 500     ) And &
							( iDw_wDetail.GetItemNumber ( lCptD, "ID_I_REG" ) = dcIdI   ) Then

							dcMtAreg += iDw_wDetail.GetItemNumber ( lCptD, "MT_PLAF" )
						End If
					Next 

				Case Else

/*------------------------------------------------------------------*/
/* Il y a un problème dans la gestion de la garantie                */
/* On arrête le controle car il peut être faux                      */
/*------------------------------------------------------------------*/
					stMessage.sTitre		= "Contrôle sur le sinistre"
					stMessage.Icon			= Information!
					stMessage.bErreurG	= False
					stMessage.sCode		= "WSIN210"
		
					sRet	= "ALT_BLOC"
					Exit
				End Choose
			End If
		End If

	Next

/*------------------------------------------------------------------*/
/* On ajoute au montant à régler les frais qui n'ont pas encore     */
/* été versés                                                       */
/*------------------------------------------------------------------*/

	For lCptF = 1 To lNbFrais

		If ( iDw_wFrais.GetItemNumber ( lCptF, "ID_I"     ) = dcIdI  ) And  &
			( iDw_wFrais.GetItemNumber ( lCptF, "COD_ETAT" ) = 500    ) Then

			dcMtAReg += iDw_wFrais.GetItemNumber ( lCptF, "MT_FRAIS" )
		End If
	Next

	iDw_LstInter.SetItem ( lCpt, "MT_A_REG", dcMtAReg )
/*------------------------------------------------------------------*/
/* On positionne la zone ALT_VALIDE à OUI et cela dans tous les     */
/* cas. (Même si MT_REG est égal à 0). Donc on validera toujours    */
/* l'interlocuteur.                                                 */
/*------------------------------------------------------------------*/
	idw_LstInter.SetItem ( lCpt, "ALT_VALIDE", "O" )

/*------------------------------------------------------------------*/
/* Modif DGA                                                        */
/* Le 14/10/1998.                                                   */
/* On additionne le montant A REGLER pour l'afficher dans la zone   */
/* MT_A_REG.                                                        */
/*------------------------------------------------------------------*/
	dcMtaRegSin += dcMtAReg


// #3 [3SUISSE].COD_MODE_REG 
	If dcMtAReg > 0 Then

		bAutorise = FALSE
		sCodInter = iDw_LstInter.GetItemString ( lCpt, "COD_INTER" )
		sModeReg = iDw_LstInter.GetItemString ( lCpt, "COD_MODE_REG" ) 
		
		// #1 [3SUISSE].COD_MODE_REG 
		If ( sModeReg = "XX" Or sModeReg = "XA" ) And sCodInter = "F" Then 
			bAutorise = TRUE
		Else			
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 100 )
			For lCptModeReg = lDeb To lFin
				
				If Trim ( Upper ( idw_DetPro.GetItemString ( lCptModeReg, "ID_CODE_CAR" ) ) ) = Trim ( Upper ( sModeReg ) ) Then
					sCodInterAutorise = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lCptModeReg, "VAL_CAR" ), "COD_INTER", ";")
					bAutorise = sCodInter = sCodInterAutorise 
					If bAutorise Then Exit
				End If
			Next

		End If
		
		If Not bAutorise Then 
			stMessage.sTitre		= "Contrôle sur le sinistre"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= False
			stMessage.sVar[1]		= iDw_LstInter.GetItemString ( lCpt, "NOM" )
			stMessage.sCode		= "GENE162"
		
			sRet	= "ALT_BLOC"			
		End If

	End If
// :#3 [3SUISSE].COD_MODE_REG 

/*------------------------------------------------------------------*/
/* Vérification en cas de règlement que le mode de règlement est    */
/* connu                                                            */
/* et que s'il s'agit d'un virement le RIB est bien saisi           */
/*------------------------------------------------------------------*/
	// [VDOC23062]
	sModeReg = Trim ( iDw_LstInter.GetItemString ( lCpt, "COD_MODE_REG" ))
	sOrdreCheque = Trim ( iDw_LstInter.GetItemString ( lCpt, "ORDRE_CHEQUE" ) )
	If IsNull ( sOrdreCheque ) Then sOrdreCheque = ""
	If IsNull ( sModeReg ) Then sModeReg = ""		
	IF sModeReg = "C" And sOrdreCheque = "" And dcMtAReg > 0 Then
		stMessage.sTitre		= "Contrôle sur le sinistre"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= False
		stMessage.sVar[1]		= iDw_LstInter.GetItemString ( lCpt, "NOM" )
		stMessage.sCode		= "WSIN231"
		sRet	= "ALT_BLOC"			
	End If 

	If dcMtAReg > 0 Then

// #2		sModeReg = Left ( iDw_LstInter.GetItemString ( lCpt, "COD_MODE_REG" ), 1 )
		sModeReg = iDw_LstInter.GetItemString ( lCpt, "COD_MODE_REG" ) // #2
		
		If isNull ( sModeReg ) Then

			stMessage.sTitre		= "Contrôle sur le sinistre"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= False
			stMessage.sVar[1]		= iDw_LstInter.GetItemString ( lCpt, "NOM" )
			stMessage.sCode		= "WSIN220"
		
			sRet	= "ALT_BLOC"
			Exit
		ElseIf ( sModeReg = "VA" ) Then

				// #1
				sRibBq	= iDw_LstInter.GetItemString ( lCpt, "RIB_BQ"  )
				if sRibBq = "" then setnull(sRibBq)
				
				sRibGui	= iDw_LstInter.GetItemString ( lCpt, "RIB_GUI" )
				if sRibGui = "" then setnull(sRibGui)
				
				sRibCpt	= iDw_LstInter.GetItemString ( lCpt, "RIB_CPT" )
				
				if sRibCpt = "" then setnull(sRibCpt)
				
				sRibCle	= iDw_LstInter.GetItemString ( lCpt, "RIB_CLE" )
				if sRibCle = "" then setnull(sRibCle)
				
				if isNull ( sRibBq + sRibGui + sRibCpt + sRibCle ) Then
				
					stMessage.sTitre		= "Contrôle sur le sinistre"
					stMessage.Icon			= Information!
					stMessage.bErreurG	= False
					stMessage.sVar[1]		= iDw_LstInter.GetItemString ( lCpt, "NOM" )
					stMessage.sCode		= "WSIN230"
		
					sRet	= "ALT_BLOC"
					Exit
				End If
				
				if not f_rib ( sRibBq, sRibGui, sRibCpt, sRibCle ) Then

					stMessage.sTitre		= "Contrôle sur le sinistre"
					stMessage.Icon			= Information!
					stMessage.bErreurG	= False
					stMessage.sVar[1]		= iDw_LstInter.GetItemString ( lCpt, "NOM" )
					stMessage.sCode		= "WSIN580"
		
					sRet	= "ALT_BLOC"
					Exit
				End If
				// #1 - FIN
				
				// [VDoc12394]
				if not uf_controler_sepa( sRibBq, sRibGui,  iDw_LstInter.GetItemNumber ( lCpt, "ID_I" )) Then

					stMessage.sTitre		= "Contrôle sur le sinistre"
					stMessage.Icon			= Information!
					stMessage.bErreurG	= False
					stMessage.sVar[1]		= iDw_LstInter.GetItemString ( lCpt, "NOM" )
					stMessage.sCode		= "WSIN759"						
		
					sRet	= "ALT_BLOC"
					Exit
				End If
				// :[VDoc12394]

		Else
			// [PC151259]
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 252)
			If lDeb > 0 Then 
				sVal = lnvPFCString.of_getkeyvalue ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "VARIANTE", ";")
				
				If iDw_LstInter.GetItemString ( lCpt, "COD_INTER" ) = "F" Then

					// [PC171933]
					Choose Case sVal 
						Case "FULL_SERENITY_ADV_5", "ADVISE_6", "ADVISE_7"
							// [PC151259-2]
							Choose Case iDw_LstInter.GetItemString ( lCpt, "ID_FOUR" )
								Case "ADV" // , "BK2", "EKO", "DGC", "NE1", "NE2", "NE3", "NE4", "NE5", "NE6", "NE7", "SMT", "RAV", "RTP" On ne maintient plus
									idw_LstInter.SetItem ( lCpt, "COD_MODE_REG", "XA" )
							End Choose 
						Case Else 
							Choose Case iDw_LstInter.GetItemString ( lCpt, "ID_FOUR" )
								Case "ADV", "BK2", "PSM"
									idw_LstInter.SetItem ( lCpt, "COD_MODE_REG", "XA" )
							End Choose 
					End Choose
				End If
			End If
		End If
	End If
Next

/*------------------------------------------------------------------*/
/* Modif DGA                                                        */
/* Le 14/10/1998                                                    */
/* Si tout se passe bien, on positionne le montant dans la DW.      */
/* On vérifie au passage que l'on ne réclame pas un questionnaire   */
/* à l'un des interlocuteurs dans le cas ou MT_A_REG > 0.           */
/*------------------------------------------------------------------*/
If	sRet = ""	Then
	idw_wSin.SetItem ( 1, "MT_A_REG", dcMtaRegSin )

	sRech	= "ALT_QUEST = 'O'"
	lLig	= idw_LstInter.Find ( sRech, 1, lNbInter )
	If	lLig > 0 And dcMtaRegSin > 0 Then
		stMessage.sTitre		= "Contrôle sur le sinistre"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= False
		stMessage.sVar[1] 	= idw_LstInter.GetItemString ( lLig, "NOM" )
		stMessage.sCode		= "WSIN260"

		sRet = "ALT_BLOC"
	End If

End If

/*------------------------------------------------------------------*/
/* Si tout se passe bien, on peut armer la DW sur W_REG_GTI.        */
/*------------------------------------------------------------------*/
If	sRet = "" Then
	Uf_Calcul_W_Reg_Gti ()
End If

Return ( sRet )
end function

private function boolean uf_determiner_etat_garantie (integer aitype);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Determiner_Etat_Garantie (PRIVATE)
//* Auteur			: DBI
//* Date				: 18/08/1998 09:27:01
//* Libellé			: 
//* Commentaires	: Détermination du Code Etat du sinistre en fonction des garanties
//*
//* Arguments		: Integer		aiType			(Val) 
//*
//* Retourne		: Boolean
//*
//*-----------------------------------------------------------------

Boolean bRet

Long lTotGti, lCpt

lTotGti	= idw_LstGti.RowCount ()
bRet			= False

Choose Case aiType

Case 0						// Une des garanties est-elle non contrôlée ?
	For	lCpt = 1 To lTotGti
			If	idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 0	Then
				bRet = True
				Exit
			End If
	Next

Case 1						// Une des garanties est-elle bloquée ?
	For	lCpt = 1 To lTotGti
			If	idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 1	Then
				bRet = True
				Exit
			End If
	Next

Case 2						// Toutes les garanties sont-elles sans suite ?
	If	lTotGti > 0	Then bRet = True

	For	lCpt = 1 To lTotGti
			If	idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) <> 900 	Then
				bRet = False
				Exit
			End If
	Next

Case 3						// au moins une garantie refusée ?

	For	lCpt = 1 To lTotGti
			If	idw_LstGti.GetItemNumber    ( lCpt, "COD_ETAT" ) = 200 Then
				bRet = True
				Exit
			End If
	Next


Case 4						// Aucune garantie réglée, à régler ou en cours de règlement ?
	bRet = True

	For	lCpt = 1 To lTotGti
			If	( idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 600	) Or &
				( idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 500	) Or &
				( idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 550	) Then

				bRet = False
				Exit
			End If
	Next

Case 5						// Aucune garantie en demande de pièces ?

	bRet = True

	For	lCpt = 1 To lTotGti
			If	idw_LstGti.GetItemNumber    ( lCpt, "COD_ETAT" ) = 100 Then
				bRet = False
				Exit
			End If
	Next

Case 6						// au moins une garantie en demande de pièces ?

	For	lCpt = 1 To lTotGti
			If	idw_LstGti.GetItemNumber    ( lCpt, "COD_ETAT" ) = 100 Then
				bRet = True
				Exit
			End If
	Next

Case 7						// au moins une des garanties est-elle réglée, à régler ou en cours de règlement ?

	For	lCpt = 1 To lTotGti
			If	( idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 500 ) Or &
				( idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 600 ) Or &
				( idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 550 ) Then

				bRet = True
				Exit
			End If
	Next

Case 8						// au moins une des garanties est-elle en cours de règlement ?

	For	lCpt = 1 To lTotGti
			If	( idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 550 ) Then

				bRet = True
				Exit
			End If
	Next


Case 9						// au moins une des garanties est-elle à régler ?

	For	lCpt = 1 To lTotGti
			If	( idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 500 ) Then

				bRet = True
				Exit
			End If
	Next


Case 10						// au moins une des garanties est-elle réglée ?

	For	lCpt = 1 To lTotGti
			If	( idw_LstGti.GetItemNumber ( lCpt, "COD_ETAT" ) = 600 ) Then

				bRet = True
				Exit
			End If
	Next

End Choose

Return ( bRet )


end function

private subroutine uf_calculrevision_initial ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_CalculRevision_Initial (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 17:35:30
//* Libellé			: 
//* Commentaires	: Détermination de la révision pour la première fois sur le dossier
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//*		FPI	18/01/2011	[PC582-583] Révision corrigé selon DP 158
//*-----------------------------------------------------------------


Long dcIdProd, dcIdRev

DateTime dtDteSurv, dtDteAdh, dtDtePivot
Date dDteOpt, dDteAdh, dDteSurv		

String sIdRev
// 	[PC582-583] 
Long lDeb, lFin
String sValCar, sEffet, sDteEffet
n_cst_string nvString
Date dDteEffet
Boolean bErrDp158

dcIdRev	= idw_wSin.GetItemNumber ( 1, "ID_REV" )
dcIdProd	= idw_wSin.GetItemNumber ( 1, "ID_PROD" )

/*------------------------------------------------------------------*/
/* On vient dans cette fonction si la révision est à -1.            */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Pour les produits avec ADHESION ( 1, 2, 5 ), la zone DTE_ADH     */
/* est obligatoire dans la création des travaux. Pour les produits  */
/* par CARTE la zone DTE_ADH n'est pas saisissable. (Mais elle ne   */
/* sert à rien pour le calcul de la révision).                      */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Donc si la zone DTE_SURV est saisie, et que la révision est à    */
/* -1, il faut déclencher le calcul de la révision.                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* La zone DTE_SURV n'est pas encore castée. Il faut donc prendre   */
/* la zone DTE_SURV et non DTE_SURV_DATE.                           */
/*------------------------------------------------------------------*/
dtDteSurv = idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )

If	Not IsNull ( dtDteSurv ) Then
/*------------------------------------------------------------------*/
/* Le 05/01/1999                                                    */
/* Il y a un problème de calcul de révision sur les produits avec   */
/* changement d'option. (Ex:SECURILION)                             */
/* Si DTE_OPT <> DTE_ADH, on compare les zones DTE_OPT et           */
/* DTE_SURV. Si DTE_OPT <= DTE_SURV, on prend la zone DTE_OPT       */
/* comme pivot, sinon on prend DTE_ADH.                             */
/*------------------------------------------------------------------*/

	dDteOpt		= idw_wSin.GetItemDate ( 1, "DTE_OPT" )
	dDteAdh		= idw_wSin.GetItemDate ( 1, "DTE_ADH" )

	dtDteAdh		= DateTime ( dDteADh )
	dtDtePivot	= dtDteAdh

	If	dDteOpt <> dDteAdh	Then
		If	dDteOpt <= Date ( dtDteSurv )	Then
			dtDtePivot 	= DateTime ( dDteOpt )
		End If
	End If

	sIdRev	= Space ( 4 )

	itrTrans.PS_X_CALC_REVISION ( dcIdProd, dtDteSurv, dtDtePivot, sIdRev )
	dcIdRev 	= Dec ( sIdRev )
	
	// [PC582-583]
	bErrDp158 = FALSE
	
	f_rechdetpro(lDeb, lFin, idw_detpro, idw_wsin.GetItemNumber(1,"ID_PROD"),"-DP", 158)
	If lDeb > 0 Then
		sValCar=idw_detpro.GetItemString(lDeb, "VAL_CAR")
		sEffet=nvString.of_getkeyvalue(sValCar,"EFFET",";")
		
		sDteEffet=nvString.of_getkeyvalue(sValCar,"DTE_EFFET",";")
		
		If Len(sDteEffet) = 0 Then
			// Erreur de param		
		Else
			dDteEffet=Date(sDteEffet)
			Choose Case sEffet
				Case "DTE_SOUS","DTE_ADH"
					dDteAdh		= idw_wSin.GetItemDate ( 1, "DTE_ADH" )
					If dDteAdh > dDteEffet Then	bErrDp158=TRUE
				Case "DTE_SURV"
					dDteSurv		= Date (dtDteSurv)
					If dDteSurv	> dDteEffet Then	bErrDp158=TRUE
				Case Else
					// Erreur de param		
			End Choose
		End if
	End if

	If bErrDp158 Then
		dcIdRev = -1
		stMessage.sVar[1]=nvString. of_getkeyvalue ( sValcar, "CPLT_MESSAGE", ";")
		stMessage.sCode = "WSIN107"
	End if
	
	// :[PC582-583]
	
/*------------------------------------------------------------------*/
/* On vérifie si la procédure ne renvoie pas une erreur.            */
/*------------------------------------------------------------------*/
	If	Not	F_Procedure ( stMessage, itrTrans, "PS_X_CALC_REVISION" )	Then
				stMessage.sTitre	= "Gestion des sinistres - SIMPA2"
				stMessage.Icon		= StopSign!

				F_Message ( stMessage )
	Else
/*------------------------------------------------------------------*/
/* Si dcIdRev = -1, on affiche un message d'avertissement, mais on  */
/* ne bloque pas pas la saisie.                                     */
/*------------------------------------------------------------------*/
		If	dcIdRev = -1 Then
			stMessage.sTitre		= "Gestion des sinistres - SIMPA2"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= False
			If not bErrDp158 Then stMessage.sCode		= "WSIN105"	// [PC582-583] - Ajout du if

			f_Message ( stMessage )
		End If
	End If
End If

idw_wSin.SetItem ( 1, "ID_REV", dcIdRev )
end subroutine

private subroutine uf_gestion_str2nul ();//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Gestion_Str2Nul (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 17/10/1998 18:05:58
//* Libellé			: 
//* Commentaires	: Cette fonction transforme les chaines vides en NULL
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

String sCol[ 10 ]
String sVal
Long lCpt, lNbrCol

/*------------------------------------------------------------------*/
/* Le but de cette fonction est de transformer toutes les zones au  */
/* format STRING dans la DW courante en NULL. Cela évitera d'avoir  */
/* sur le moteurs des zones avec des blancs. Cette fonction doit    */
/* être appelée avant la fonction Uf_ControlerSaisie ().            */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* De plus si les gestionnaire saisi des blancs DEVANT la zone,     */
/* ces caractères sont automatiquement enlevés.                     */
/*------------------------------------------------------------------*/

lNbrCol				= UpperBound ( sCol )

sCol[  1 ] = "ADR_1"
sCol[  2 ] = "ADR_2"
sCol[  3 ] = "ADR_CP"
sCol[  4 ] = "ADR_VILLE"
sCol[  5 ] = "NUM_FAX"
sCol[  6 ] = "NUM_TELB"
sCol[  7 ] = "NUM_TELD"
sCol[  8 ] = "LIEU"
sCol[  9 ] = "TXT_MESS"
sCol[ 10 ] = "REF_CIE"

For	lCpt = 1 To lNbrCol
		sVal = Trim ( idw_wSin.GetItemString ( 1, sCol[ lCpt ] ) )
		If Len ( sVal ) = 0 Then
			idw_wSin.SetItem ( 1, sCol[ lCpt ], stNul.str )
		Else
			idw_wSin.SetItem ( 1, sCol[ lCpt ], sVal )
		End If
Next


end subroutine

private subroutine uf_calcul_w_reg_gti ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Calcul_W_Reg_Gti (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 10/11/1998 18:15:02
//* Libellé			: 
//* Commentaires	: On va insérer des lignes pour chacunes des Garanties réglées
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

Long lTotInter, lCptInter, lTotGti, lCptGti, lTotDet, lCptDet
Long lIdSin, lIdGti, lIdI, lCodEtatGti, lCptIAReg, lLig, lTotFrais, lCptFrais
Long lIdTypFrais, lIdTypFraisLu, lIdEvt, lRgpt

Long lCodRgpt[3]
Boolean bRgpt[3]

Decimal {2} dcMtARegGtiPlaf, dcMtARegGtinPlaf, dcMtAReg, dcMtPlafDet
Decimal {2} dcMtFrais, dcMtTotFrais, dcMtPlafAReg, dcMtRestant
Decimal {2}	dcMtRgpt[3], dcMtRgptDeb[3]

String sRech, sTri, sTriActuel, sFiltre, sFiltreNull

lTotInter	= idw_LstInter.RowCount ()
lTotGti		= idw_LstGti.RowCount ()
lTotDet		= idw_wDetail.RowCount ()
lIdSin		= idw_wSin.GetItemNumber ( 1, "ID_SIN" )

lCodRgpt[1]	= 700
lCodRgpt[2]	= 720
lCodRgpt[3]	= 740

/*------------------------------------------------------------------*/
/* La première chose à faire est de casser toutes les lignes de la  */
/* DW. Le gestionnaire peut faire deux fois CTRL_VAL.               */
/*------------------------------------------------------------------*/
idw_wRegGti.RowsDiscard ( 1, 999, Primary! )

For	lCptInter = 1 To lTotInter
		lIdI 			= idw_LstInter.GetItemNumber ( lCptInter, "ID_I" )
		dcMtAReg		= idw_LstInter.GetItemNumber ( lCptInter, "MT_A_REG" )

		If	dcMtAReg <= 0 Then
			Continue
		End If

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Traitement sur les GARANTIES.                                    */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
		For	lCptGti = 1 To lTotGti
				dcMtARegGtiPlaf	= 0
				dcMtARegGtinPlaf	= 0
				For	lRgpt = 1 To 3
						dcMtRgpt[ lRgpt ] 	= 0
						dcMtRgptDeb[ lRgpt ] = 0
						bRgpt[ lRgpt ] 		= False
				Next

				lCodEtatGti = idw_LstGti.GetItemNumber ( lCptGti, "COD_ETAT" )
				lCptIaReg	= idw_LstGti.GetItemNumber ( lCptGti, "CPT_I_AREG" )
				lIdGti		= idw_LstGti.GetItemNumber ( lCptGti, "ID_GTI" )

/*------------------------------------------------------------------*/
/* Traitement particulier sur la GARANTIE UTILISATIONS              */
/* FRAUDULEUSES.                                                    */
/*------------------------------------------------------------------*/
				If	lIdGti = 7 And ( lCodEtatGti = 500 Or lCodEtatGti = 550 ) Then
					For	lCptDet = 1 To lTotDet
							If	idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) 		= lIdGti 		And	&
								idw_wDetail.GetItemNumber ( lCptDet, "COD_ETAT" ) 		= 500			 	And	&
								idw_wDetail.GetItemNumber ( lCptDet, "ID_I_REG" ) 		= lIdI			And	&
								idw_wDetail.GetItemString ( lCptDet, "ALT_VALIDE" ) 	= "O"				Then

								lIdEvt 		= idw_wDetail.GetItemNumber ( lCptDet, "ID_EVT" )
								dcMtPlafDet = idw_wDetail.GetItemNumber ( lCptDet, "MT_PLAF" )

								If			lIdEvt >= 700 And lIdEvt <= 719	Then
											dcMtRgpt[1] += dcMtPlafDet
								ElseIf	lIdEvt >= 720 And lIdEvt <= 739	Then
											dcMtRgpt[2] += dcMtPlafDet
/*------------------------------------------------------------------*/
/* Le 14/12/1998:                                                   */
/* Pour les UF, il existe des événements en 300, 310 qu'il faut     */
/* positionner dans cette dernière catégorie. On prend donc tous    */
/* les événements restant en compte.                                */
/* //ElseIf	lIdEvt >= 740 And lIdEvt <= 759	Then                   */
/*------------------------------------------------------------------*/
								Else
											dcMtRgpt[3] += dcMtPlafDet
								End If
							End If
					Next

/*------------------------------------------------------------------*/
/* On assigne les montants calculés dans un autre tableau. En       */
/* effet, ces montants vont être répartis dans le cas d'un plafond. */
/*------------------------------------------------------------------*/
					dcMtRgptDeb[] = dcMtRgpt[]

/*------------------------------------------------------------------*/
/* On récupére le montant plafonné de la garantie.                  */
/*------------------------------------------------------------------*/
					dcMtPlafaReg = idw_LstGti.GetItemNumber ( lCptGti, "MT_PLAF_AREG" )
/*------------------------------------------------------------------*/
/* On effectue la répartition.                                      */
/*------------------------------------------------------------------*/
					If	dcMtRgpt[ 3 ] > 0	Then
						If	dcMtRgpt[ 3 ] >= dcMtPlafaReg	Then
							dcMtRgpt[ 3 ] = dcMtPlafaReg
							dcMtRgpt[ 2 ] = 0
							dcMtRgpt[ 1 ] = 0
						Else
							dcMtRestant = dcMtPlafaReg - dcMtRgpt[ 3 ]
							If	dcMtRgpt[ 2 ] >= dcMtRestant	Then
								dcMtRgpt[ 2 ] = dcMtRestant
								dcMtRgpt[ 1 ] = 0
							Else
								dcMtRgpt[ 1 ] = dcMtRestant - dcMtRgpt[ 2 ]
							End If
						End If
					Else
						If	dcMtRgpt[ 2 ] > 0	Then
							If	dcMtRgpt[ 2 ] >= dcMtPlafaReg	Then
								dcMtRgpt[ 2 ] = dcMtPlafaReg
								dcMtRgpt[ 1 ] = 0
							Else
								dcMtRgpt[ 1 ] = dcMtPlafaReg - dcMtRgpt[ 2 ]
							End If
						Else
							dcMtRgpt[ 1 ] = dcMtPlafaReg
						End If
					End If

/*------------------------------------------------------------------*/
/* On vérifie les regroupements qu'il va falloir armer.             */
/*------------------------------------------------------------------*/
					For	lRgpt = 1 To 3
							If	dcMtRgptDeb[ lRgpt ] > 0 Then bRgpt[ lRgpt ] = True
					Next	

/*------------------------------------------------------------------*/
/* On insére les lignes dans la DW W_REG_GTI.                       */
/*------------------------------------------------------------------*/
					For	lRgpt = 1 To 3
							If	bRgpt[ lRgpt ] Then
								lLig		= idw_wRegGti.InsertRow ( 0 )

								idw_wRegGti.SetItem ( lLig, "ID_SIN", lIdSin  )
								idw_wRegGti.SetItem ( lLig, "ID_I", lIdI  )
								idw_wRegGti.SetItem ( lLig, "ID_GTI", lIdGti  )
								idw_wRegGti.SetItem ( lLig, "ID_RGPT", lCodRgpt[ lRgpt ]  )
								idw_wRegGti.SetItem ( lLig, "MT_REG", dcMtRgpt[ lRgpt ]   )
								idw_wRegGti.SetItem ( lLig, "MT_RGPT", dcMtRgptDeb[ lRgpt ]   )
							End If
					Next

					Continue
				End If

/*------------------------------------------------------------------*/
/* On traite la garantie si elle fait l'objet d'un règlement.       */
/*------------------------------------------------------------------*/
				If	lCodEtatGti = 500 Or lCodEtatGti = 550	Then
/*------------------------------------------------------------------*/
/* Il doit y avoir au moins un détail A REGLER. Ce test est         */
/* forcément réalisé dans la fonction Uf_Calcul_Montant_Inter ().   */
/*------------------------------------------------------------------*/
					sRech	=	"ID_GTI = " + String ( lIdGti ) + " and COD_ETAT = 500 and ID_I_REG = " + String ( lIdI )
					lLig	=	idw_wDetail.Find ( sRech, 1, lTotDet )

					If	lLig > 0 Then
						Choose Case lCptIAreg
						Case 1
/*------------------------------------------------------------------*/
/* Il y a un seul interlocuteur de concerné. On utilise la zone     */
/* MT_PLAF_AREG.                                                    */
/*------------------------------------------------------------------*/
							dcMtARegGtiPlaf	= idw_LstGti.GetItemNumber ( lCptGti, "MT_PLAF_AREG" )
							dcMtARegGtinPlaf	= idw_LstGti.GetItemNumber ( lCptGti, "MT_NPLAF_AREG" )
						Case Is > 1
/*------------------------------------------------------------------*/
/* Il y a plusieurs interlocuteurs A REGLER pour cette garantie.    */
/* On additionne les montants plafonnés des détails A REGLER pour   */
/* l'interlocuteur courant.                                         */
/*------------------------------------------------------------------*/
							For	lCptDet = 1 To lTotDet
									If	idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) 		= lIdGti 		And	&
										idw_wDetail.GetItemNumber ( lCptDet, "COD_ETAT" ) 		= 500			 	And	&
										idw_wDetail.GetItemNumber ( lCptDet, "ID_I_REG" ) 		= lIdI			And	&
										idw_wDetail.GetItemString ( lCptDet, "ALT_VALIDE" ) 	= "O"				Then

										dcMtARegGtiPlaf 	+= idw_wDetail.GetItemNumber ( lCptDet, "MT_PLAF" )
										dcMtARegGtinPlaf	+= idw_wDetail.GetItemNumber ( lCptDet, "MT_PLAF" )
									End If
							Next
						End Choose
/*------------------------------------------------------------------*/
/* On insére maintenant une ligne dans W_REG_GTI si le montant      */
/* est supérieur à zéro. Les zones CREE_LE, MAJ_LE, MAJ_PAR seront  */
/* positionnées dans le SqlPreview de la DW.                        */
/*------------------------------------------------------------------*/
						If	dcMtARegGtinPlaf > 0 Then
							lLig		= idw_wRegGti.InsertRow ( 0 )

							idw_wRegGti.SetItem ( lLig, "ID_SIN", lIdSin  )
							idw_wRegGti.SetItem ( lLig, "ID_I", lIdI  )
							idw_wRegGti.SetItem ( lLig, "ID_GTI", lIdGti  )
							idw_wRegGti.SetItem ( lLig, "ID_RGPT", lIdGti  )
							idw_wRegGti.SetItem ( lLig, "MT_REG", dcMtARegGtiPlaf  )
							idw_wRegGti.SetItem ( lLig, "MT_RGPT", dcMtARegGtinPlaf  )
						End If
					End If
				End If
		Next
Next

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Traitement sur les FRAIS.                                        */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* On récupére le Tri actuel sur la DW wFrais. En effet, on va      */
/* être obligé de changer le tri pendant le traitement. Il faudra   */
/* repositionner le bon ordre de tri à la fin du traitement.        */
/*------------------------------------------------------------------*/
sTriActuel	= idw_wFrais.Describe ( "DataWindow.Table.Sort" )
sTri 			= "ID_TYP_FRAIS A"
sFiltreNull	= ""

idw_wFrais.SetSort ( sTri )
idw_wFrais.Sort ()

For	lCptInter = 1 To lTotInter
		lIdI 		= idw_LstInter.GetItemNumber ( lCptInter, "ID_I" )
		dcMtAReg	= idw_LstInter.GetItemNumber ( lCptInter, "MT_A_REG" )
		If	dcMtAReg <= 0 Then
			Continue
		End If

		sFiltre = "ID_I = " + String ( lIdI ) + " And COD_ETAT = 500"
		idw_wFrais.SetFilter ( sFiltre )
		idw_wFrais.Filter ()

		lTotFrais	= idw_wFrais.RowCount ()

		If	lTotFrais > 0 Then
			lIdTypFrais		= idw_wFrais.GetItemNumber ( 1, "ID_TYP_FRAIS" )
			dcMtTotFrais	= idw_wFrais.GetItemNumber ( 1, "MT_FRAIS" )
		End If
		
		For	lCptFrais = 2 To lTotFrais
				lIdTypFraisLu	= idw_wFrais.GetItemNumber ( lCptFrais, "ID_TYP_FRAIS" )
				dcMtFrais		= idw_wFrais.GetItemNumber ( lCptFrais, "MT_FRAIS" )
				
				If	lIdTypFraisLu <> lIdTypFrais	Then
/*------------------------------------------------------------------*/
/* On insére une ligne dans W_REG_GTI.                              */
/*------------------------------------------------------------------*/
					lLig		= idw_wRegGti.InsertRow ( 0 )

					idw_wRegGti.SetItem ( lLig, "ID_SIN", lIdSin  )
					idw_wRegGti.SetItem ( lLig, "ID_I", lIdI  )
					idw_wRegGti.SetItem ( lLig, "ID_GTI", -1  )
					idw_wRegGti.SetItem ( lLig, "ID_RGPT", lIdTypFrais  )
					idw_wRegGti.SetItem ( lLig, "MT_REG", dcMtTotFrais  )
					idw_wRegGti.SetItem ( lLig, "MT_RGPT", dcMtTotFrais  )
	
					lIdTypFrais 	= lIdTypFraisLu
					dcMtTotFrais	= dcMtFrais
					
				Else
					dcMtTotFrais += dcMtFrais
				End If
		Next
/*------------------------------------------------------------------*/
/* On insére la dernière ligne systématiquement.                    */
/*------------------------------------------------------------------*/
		If	lTotFrais > 0 Then
			lLig		= idw_wRegGti.InsertRow ( 0 )

			idw_wRegGti.SetItem ( lLig, "ID_SIN", lIdSin  )
			idw_wRegGti.SetItem ( lLig, "ID_I", lIdI  )
			idw_wRegGti.SetItem ( lLig, "ID_GTI", -1  )
			idw_wRegGti.SetItem ( lLig, "ID_RGPT", lIdTypFrais  )
			idw_wRegGti.SetItem ( lLig, "MT_REG", dcMtTotFrais  )
			idw_wRegGti.SetItem ( lLig, "MT_RGPT", dcMtTotFrais  )
		End If
Next

idw_wFrais.SetFilter ( sFiltreNull )
idw_wFrais.Filter ()

idw_wFrais.SetSort ( sTriActuel )
idw_wFrais.Sort ()
end subroutine

private subroutine uf_ecriretrace_adresse ();//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_EcrireTrace_Adresse ( Private )
//* Auteur			: Erick John Stark
//* Date				: 04/28/97 14:57:25
//* Libellé			: 
//* Commentaires	: 
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

Long lTot, lCpt, lCodAdrDms

String sTrace[13]
String sLigne, sTab, sModifAdr, sCodAdh

/*------------------------------------------------------------------*/
/* On va ecrire une trace dans le fichier.                          */
/* Cette trace contient dans l'ordre                                */
/*                                                                  */
/* ID_SIN							01                                    */
/* ID_PROD 							02                                    */
/* ID_ETS							03                                    */
/* ID_ADH	 						04                                    */
/* ID_SDOS							05                                    */
/* ADR_1		 						06                                    */
/* ADR_2								07                                    */
/* ADR_CP							08                                    */
/* ADR_VILLE						09                                    */
/* NOM								10                                    */
/* PRENOM							11                                    */
/* DOS_MAJ_LE (Fin)				12                                    */
/* DOS_MAJ_PAR (Fin)				13                                    */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le gestionnaire a t-il modifié les coordonnées ?                 */
/*------------------------------------------------------------------*/
sModifAdr = idw_wSin.GetItemString ( 1, "MODIF_ADR" )
If	sModifAdr = "N"	Then
	Return
End If

/*------------------------------------------------------------------*/
/* Le produit est-il géré en ADHESION (COD_ADH = 1 et 6) et gére    */
/* t-on les adresses en adhésion (COD_ADR_DMS = 1)                  */
/*------------------------------------------------------------------*/
sCodAdh 		= idw_Produit.GetItemString ( 1, "COD_ADH" )
lCodAdrDms	= idw_Produit.GetItemNumber ( 1, "COD_ADR_DMS" )

If	( sCodAdh = "1" Or sCodAdh = "6" ) And lCodAdrDms = 1 Then
	sTab = "~t"
	lTot = UpperBound ( sTrace )

	sTrace[  1 ]  = String ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )
	sTrace[  2 ]  = String ( idw_wSin.GetItemNumber ( 1, "ID_PROD" ) )
	sTrace[  3 ]  = String ( idw_wSin.GetItemNumber ( 1, "ID_ETS" ) )
	sTrace[  4 ]  = idw_wSin.GetItemString ( 1, "ID_ADH" )
	sTrace[  5 ]  = String ( idw_wSin.GetItemNumber ( 1, "ID_SDOS" ) )
	sTrace[  6 ]  = Trim ( idw_wSin.GetItemString ( 1, "ADR_1" ) )
	sTrace[  7 ]  = Trim ( idw_wSin.GetItemString ( 1, "ADR_2" ) )
	sTrace[  8 ]  = idw_wSin.GetItemString ( 1, "ADR_CP" )
	sTrace[  9 ]  = Trim ( idw_wSin.GetItemString ( 1, "ADR_VILLE" ) )
	sTrace[ 10 ]  = Trim ( idw_wSin.GetItemString ( 1, "NOM" ) )
	sTrace[ 11 ]  = Trim ( idw_wSin.GetItemString ( 1, "PRENOM" ) )
	sTrace[ 12 ]  = String ( idw_wSin.GetItemDateTime ( 1, "MAJ_LE" ), "dd/mm/yyyy hh:mm:ss.ff" )
	sTrace[ 13 ]  = stGLB.sCodOper

	sLigne	= ""
/*------------------------------------------------------------------*/
/* On vérifie qu'il n'y ait plus de chaîne nulle.                   */
/*------------------------------------------------------------------*/
	For	lCpt = 1 To lTot
			If	IsNull ( sTrace[ lCpt ] ) Or sTrace[ lCpt ] = "''" Then
				sTrace[ lCpt ] = ""
			End If
	Next

/*------------------------------------------------------------------*/
/* On traite les N-1 valeurs, puis la dernière. Pour terminer, on   */
/* ecrit la ligne                                                   */
/*------------------------------------------------------------------*/
	For	lCpt = 1 To lTot - 1
			sLigne = sLigne + sTrace[ lCpt ] + sTab
	Next

	sLigne = sLigne + sTrace[ lTot ]

	f_EcrireFichierText ( isFicTraceAdr, sLigne )
End If

end subroutine

private subroutine uf_preparervalider (ref s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_PreparerValider (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 04/06/1999 11:41:40
//* Libellé			: 
//* Commentaires	: 
//*
//* Arguments		: s_Pass			astPass			(Réf) Structure de passage
//*
//* Retourne		: Rien
//* 
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JFF	  19/02/2006  [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
//* #2	JCA	  07/03/2007  DCMP 070161 - Amelioration process DNT - Autorisation de validation avec réglement
//* #3   JFF     	  03/04/2007  DCMP 070161 - Modif JF suite erreur d'analyse, il est mieux de tester le "MT_A_REG > 0"
//*													 Afind e prendre en compte les frais interlocuteurs
//* #4	LBP	  27/07/2010  [Recup vers SVN] Ajout du controle de rev SVN
//       JFF     17/06/2016  [ITSM390803]
// 		JFF	  26/04/2017  [ITSM459081] 
//       JFF     26/11/2019  [PC192290]
//       JFF     06/04/2020  [PM506-1]
//       JFF     28/09/2021  [20210928162035633] gestion d'un caractère de fin de chaine(@) pour ne pas perdre les espace de fin de chaine
//       JFF     09/09/2022  [PM80_FA12_FRANEX]
//       JFF   04/09/2023 [RS5656_MOD_PCE_DIF]
//*-----------------------------------------------------------------

Boolean bRet
String sFicEssai, sVal 
Long   lIdProd, lRowDs
string sBin, sRech, sValTemp, sZnDS_pceSherpaRacine, sZnDS_pceSherpa, sValTempo 
boolean bVal
long lTotDetail, lLigDet, lRowInter, lIdI, lRowDetail, lIdSin, lIdGti, lIdDetail
Boolean bMtAReg
n_cst_GestionRevSvn nGestionRevSvn
Long lDeb, lFin, lTot, lCpt
n_cst_string lnvPFCString
Int iZnDS_pceSherpa
DateTime dtMajLe
s_Pass	stPassFrAnx

/*------------------------------------------------------------------*/
/* Le 04/06/1999.                                                   */
/* Modif DGA: On vérifie si l'on peut ecrire dans le répertoire de  */
/* TRACE. Si ce n'est pas le cas, on arrete tout.                   */
/*------------------------------------------------------------------*/
sFicEssai = astPass.sTab[1]

If	F_Verifier_Ecriture_Trace ( sFicEssai ) < 0	Then
/*------------------------------------------------------------------*/
/* On affiche un message d'erreur que l'on ne peut tracer. On sort  */
/* ensuite immédiatement de la fonction.                            */
/*------------------------------------------------------------------*/
	stMessage.sTitre		= "Gestion des sinistres - SIMPA2"
	stMessage.Icon			= StopSign!
	stMessage.bErreurG	= TRUE
	stMessage.sCode		= "APPLI09"
   stMessage.bTrace  	= False

	F_Message ( stMessage )
	bRet = False
Else
	
	//[Recup vers SVN] : Ajout du controle de rev SVN
	//[PHG]08/12/2010 : Desactivation Temporaire du contrôle de version
	//bRet = nGestionRevSvn.uf_bVerifRevisionSvn(stGLB.sCodAppli, stGLB.sRevisionSvn, stGLB.bModeCnx )
	bRet = TRUE

	// #1
//	#2 idw_wSin.SetItem ( 1, "NUM_PORT", F_Format_Num_Tel ( Trim ( Upper ( idw_wSin.GetItemString ( 1, "NUM_PORT" ) ) ), FALSE ) )
End If

// #2
// si au moins 1 detail est dans l'etat "à régler" (CodEtat = 500)
// si refus de validation avec réglement 

/* #3 JFF
lTotDetail	= idw_wDetail.RowCount ()
sRech = "COD_ETAT = 500"
lLigDet = idw_wDetail.Find ( sRech, 1, lTotDetail )
   Fin #3
*/

// #3
bMtAReg = idw_wSin.GetItemDecimal ( 1, "MT_A_REG" ) > 0 
// Fin #3

This.uf_GetAutorisation ( "", sBIN, bVal, bVal, bVal, -1 )

/* #3	lLigDet > 0 and &  Remplacé dans le test par bMtAReg */ 
If	bRet and &
   bMtAReg And &  
	Mid (sBin, 17, 1 ) = '0' Then

	stMessage.sTitre		= "Gestion des sinistres - SIMPA2"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= false
	stMessage.sCode		= "WSIN510"

	F_Message ( stMessage )

	bRet = True
End If

if bRet then
	// #1
	idw_wSin.SetItem ( 1, "NUM_PORT", F_Format_Num_Tel ( Trim ( Upper ( idw_wSin.GetItemString ( 1, "NUM_PORT" ) ) ), FALSE ) ) 
end if	
// FIN - #2


// [ITSM390803]
If bRet Then
	// [ITSM459081] 
	sVal = idw_Wsin.GetItemString ( 1, "NOM" ) 
	If IsNull ( sVal ) Or Trim ( sVal ) = "" Then
		idw_Wsin.SetItem ( 1, "NOM", "AUCUN_NOM_TRANSMIS_PAR_SHERPA" )
	End If
End If


// [PC192290]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 345 )
If lDeb > 0 Then
	
	lTot = gdsPieceSherpa.RowCount ()
	sVal = "" 
	For lCpt = 1 To lTot

		// [RS5656_MOD_PCE_DIF]
		sValTemp = String ( gdsPieceSherpa.GetItemNumber ( lCpt, "ID_GTI" ) )
		sVal += "IGA=" + sValTemp + ";"

		sValTemp = String ( gdsPieceSherpa.GetItemNumber ( lCpt, "ID_DETAIL" ) )
		sVal += "IDT=" + sValTemp + ";"
		
		sValTemp = String ( gdsPieceSherpa.GetItemNumber ( lCpt, "ID_PCE" ) )
		sVal += "IP=" + sValTemp + ";"

		sValTemp = gdsPieceSherpa.GetItemString ( lCpt, "ETAT_PCE" ) 
		sVal += "EP=" + sValTemp + ";"

		sValTemp = String ( gdsPieceSherpa.GetItemDateTime ( lCpt, "DTE_ANALYSE_PCE" ), "dd/mm/yyyy hh:mm:ss" )
		sVal += "DA=" + sValTemp 
	
		sVal += "#"
	
	Next
	
	sZnDS_pceSherpaRacine = "sznds_pcesherpa_"
	iZnDS_pceSherpa = 1 

	Do While sVal <> ""

		sZnDS_pceSherpa = sZnDS_pceSherpaRacine + String ( iZnDS_pceSherpa ) 

		lRowDS = idw_wDivSin.Find ( "Upper ( NOM_ZONE ) = '" + Upper ( sZnDS_pceSherpa ) + "'", 1, idw_wDivSin.RowCount () ) 
		If lRowDS <= 0 Then
		
			lRowDS = idw_wDivSin.InsertRow (0)
		
			idw_wDivSin.SetItem ( lRowDS, "ID_SIN", idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )
			idw_wDivSin.SetItem ( lRowDS, "NOM_ZONE", sZnDS_pceSherpa )
			idw_wDivSin.SetItem ( lRowDS, "LIB_LABEL", "Données technique tempo" )
			idw_wDivSin.SetItem ( lRowDS, "ID_TYP_LISTE", "-XX" )
			idw_wDivSin.SetItem ( lRowDS, "ALT_LISTE_CODECAR", "N" )
			idw_wDivSin.SetItem ( lRowDS, "ID_TYP_ZONE", "C" )
			idw_wDivSin.SetItem ( lRowDS, "ALT_OBLIG", "N" )
			idw_wDivSin.SetItem ( lRowDS, "ALT_PROT", "O" )
			idw_wDivSin.SetItem ( lRowDS, "CPT_TRI", 5000 + iZnDS_pceSherpa )
			idw_wDivSin.SetItem ( lRowDS, "VAL_DTE", stNul.dtm ) // [PI056].20190926
			idw_wDivSin.SetItem ( lRowDS, "VAL_CAR", "" )
			idw_wDivSin.SetItem ( lRowDS, "VAL_NBRE", stNul.lng)
			idw_wDivSin.SetItem ( lRowDS, "VAL_MT", stNul.dcm )
			idw_wDivSin.SetItem ( lRowDS, "ALT_SUPP", "N" )
			idw_wDivSin.SetItem ( lRowDS, "CREE_LE", DateTime ( Today (), Now () ) )
			idw_wDivSin.SetItem ( lRowDS, "MAJ_LE", DateTime ( Today (), Now () ) )
			idw_wDivSin.SetItem ( lRowDS, "MAJ_PAR", stGlb.sCodOper )		
		End If
		
		// [20210928162035633] 
		sValTempo = Left ( sVal, 34 ) + "@" // Caractère de fin pour ne pas perdre l'espace
		//sValTempo = Left ( sVal, 35 ) 
		
		idw_wDivSin.SetItem ( lRowDS, "VAL_CAR", sValTempo )			
		
		dtMajLe = DateTime ( Today (), Now () )
		idw_wDivSin.SetItem ( lRowDS, "MAJ_LE", dtMajLe  )
		idw_wDivSin.SetItem ( lRowDS, "MAJ_PAR", stGlb.sCodOper )
		idw_wDivSin.SetItem ( lRowDS, "ALT_SUPP", "N" )

		// [20210928162035633] 
		sVal = Mid ( sVal, 35, Len ( sVal ) ) 
		//sVal = Mid ( sVal, 36, Len ( sVal ) ) 		
		
		iZnDS_pceSherpa += 1
		
	Loop 	
	
End IF 

// [PM506-1]
// Je bloque le dossier tout court
If ibPM506_AssureARisque Then
	idw_Wsin.SetItem ( 1, "ALT_BLOC", "O" ) 
	idw_Wsin.SetItem ( 1, "COD_ETAT", 1 ) 
End If 

// [PM80_FA12_FRANEX]
If bRet And idw_Wsin.GetItemString ( 1, "ALT_BLOC" ) <> "O" Then
	lRowInter = idw_LstInter.find ( "MT_A_REG > 0 AND COD_MODE_REG = 'FM' AND COD_INTER = 'F'", 1, idw_LstInter.RowCount() )
	If lRowInter > 0 Then
		lIdI = idw_LstInter.GetItemNumber ( lRowInter, "ID_I" ) 
		lRowDetail = idw_wDetail.find ( "ID_I_REG = " + String ( lIdI ) + " AND COD_ETAT = 500", 1, idw_wDetail.RowCount() )
		If lRowDetail > 0 Then
			lIdSin = idw_wDetail.GetItemNumber ( lRowDetail, "ID_SIN" ) 
			lIdGti = idw_wDetail.GetItemNumber ( lRowDetail, "ID_GTI" ) 
			lIdDetail = idw_wDetail.GetItemNumber ( lRowDetail, "ID_DETAIL" ) 

			stPassFrAnx.dwNorm[1]	= idw_wreg_frais_annexe_frn
			stPassFrAnx.lTab[1]		= lIdSin
			stPassFrAnx.lTab[2]		= lIdI
			stPassFrAnx.lTab[3]		= lIdGti
			stPassFrAnx.lTab[4]		= lIdDetail
			stPassFrAnx.dcTab[1]		= idw_LstInter.GetItemDecimal ( lRowInter, "MT_A_REG" ) 
			stPassFrAnx.sTab[1]		= idw_LstInter.GetItemString ( lRowInter, "NOM" )

			OpenWithParm ( W_t_sp_frais_annexe_frn, stPassFrAnx ) 
			
		End If 
	End If 
End If 

astPass.bRetour = bRet
end subroutine

private function boolean uf_ctl_nature_contact ();//*-----------------------------------------------------------------
//*
//* Fonction		: uf_Ctl_Nature_Contact (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 30/04/2001 12:59:53
//* Libellé			: Gestion de la nature de contact
//* Commentaires	: 
//*
//* Arguments		: 
//*
//* Retourne		: 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

String		sRech
Decimal{0}	lCodEtat
Long			lLig, lNbContact
Boolean		bRet 	=	True

stMessage.sTitre	=	"Contrôle des natures de contact"
stMessage.bErreurG	= FALSE

lCodEtat				=	idw_wSin.GetItemNumber ( 1, "COD_ETAT" ) 
lNbContact			=	iDw_LstContact.RowCount ()

/*------------------------------------------------------------------*/
/* Je vérifie si tous les contacts possèdent une nature             */
/* un contact ne possède pas de nature lorsqu'il est créé           */
/* automatiquement                                                  */
/* à l'issue d'un travail.                                          */
/*------------------------------------------------------------------*/
bRet		=	uf_Rech_Nouveau_Contact ( { 0 }, lNbContact )

If Not bRet Then
	stMessage.sCode	=	"CONT009"
	f_Message ( stMessage )
	Return ( False )
End If

Choose Case lCodEtat

	Case 200				// Clos refusé

/*------------------------------------------------------------------*/
/* Recherche des natures de contacts impossible                     */
/*------------------------------------------------------------------*/

		bRet	=	uf_Rech_Nouveau_Contact ( { 01, 41 }, lNbContact )

		If Not bRet Then				// Contact impossible trouvé

			stMessage.sCode	=	"CONT007"
			stMessage.sVar[1]	=	"envoi de questionnaire ou règlement"
			stMessage.sVar[2]	=	"refusé"
			f_Message ( stMessage )
			Return ( False )
		End If

/*------------------------------------------------------------------*/
/* Recherche des natures de contacts à confirmer                    */
/*------------------------------------------------------------------*/

		bRet	=	uf_Rech_Nouveau_Contact ( { 02, 03, 81 }, lNbContact )

		If Not bRet Then				// Contact impossible trouvé

			stMessage.bouton	=	OkCancel!
			stMessage.sCode	=	"CONT008"
			stMessage.sVar[1]	=	"demande de pièces"
			stMessage.sVar[2]	=	"refusé"
			If f_Message ( stMessage ) = 2 Then			// Stop

				Return ( False )
			End If
		End If
		
	Case 600				// Clos réglé

/*------------------------------------------------------------------*/
/* Recherche des natures de contacts impossible                     */
/*------------------------------------------------------------------*/

		bRet	=	uf_Rech_Nouveau_Contact ( { 01 }, lNbContact )

		If Not bRet Then				// Contact impossible trouvé

			stMessage.sCode	=	"CONT007"
			stMessage.sVar[1]	=	"envoi de questionnaire"
			stMessage.sVar[2]	=	"réglé"
			f_Message ( stMessage )
			Return ( False )
		End If

/*------------------------------------------------------------------*/
/* Recherche des natures de contacts à confirmer                    */
/*------------------------------------------------------------------*/

		bRet	=	uf_Rech_Nouveau_Contact ( { 02, 03, 21, 81 }, lNbContact )

		If Not bRet Then				// Contact impossible trouvé

			stMessage.bouton	=	OkCancel!
			stMessage.sCode	=	"CONT008"
			stMessage.sVar[1]	=	"demande de pièces ou refus"
			stMessage.sVar[2]	=	"réglé"
			If f_Message ( stMessage ) = 2 Then			// Stop

				Return ( False )
			End If
		End If

	Case 100				// En Cours d'instruction

/*------------------------------------------------------------------*/
/* Recherche des natures de contacts impossible                     */
/*------------------------------------------------------------------*/

		bRet	=	uf_Rech_Nouveau_Contact ( { 41 }, lNbContact )

		If Not bRet Then				// Contact impossible trouvé

			stMessage.sCode	=	"CONT007"
			stMessage.sVar[1]	=	"règlement"
			stMessage.sVar[2]	=	"en cours d'instruction"
			f_Message ( stMessage )
			Return ( False )
		End If

/*------------------------------------------------------------------*/
/* Recherche des natures de contacts à confirmer                    */
/*------------------------------------------------------------------*/

		bRet	=	uf_Rech_Nouveau_Contact ( { 21 }, lNbContact )

		If Not bRet Then				// Contact impossible trouvé

			stMessage.bouton	=	OkCancel!
			stMessage.sCode	=	"CONT008"
			stMessage.sVar[1]	=	"refus"
			stMessage.sVar[2]	=	"en cours d'instruction"
			If f_Message ( stMessage ) = 2 Then			// Stop

				Return ( False )
			End If
		End If

	Case 550				// En cours de règlement

/*------------------------------------------------------------------*/
/* Recherche des natures de contacts impossible                     */
/*------------------------------------------------------------------*/

		bRet	=	uf_Rech_Nouveau_Contact ( { 01 }, lNbContact )

		If Not bRet Then				// Contact impossible trouvé

			stMessage.sCode	=	"CONT007"
			stMessage.sVar[1]	=	"envoi de questionnaire"
			stMessage.sVar[2]	=	"en cours de règlement"
			f_Message ( stMessage )
			Return ( False )
		End If

/*------------------------------------------------------------------*/
/* Recherche des natures de contacts à confirmer                    */
/*------------------------------------------------------------------*/

		bRet	=	uf_Rech_Nouveau_Contact ( { 21 }, lNbContact )

		If Not bRet Then				// Contact impossible trouvé

			stMessage.bouton	=	OkCancel!
			stMessage.sCode	=	"CONT008"
			stMessage.sVar[1]	=	"refus"
			stMessage.sVar[2]	=	"en cours de règlement"
			If f_Message ( stMessage ) = 2 Then			// Stop

				Return ( False )
			End If
		End If

	Case 900				// Sans suite


End Choose

Return ( True )
end function

private function boolean uf_rech_nouveau_contact (long alnature[], long alnbcontact);//*-----------------------------------------------------------------
//*
//* Fonction		: uf_Rech_Nouveau_Contact (PRIVATE)
//* Auteur			: Fabyr JF
//* Date				: 30/04/2001 13:09:38
//* Libellé			: 
//* Commentaires	: 
//*
//* Arguments		: Long	alNature[]	Val

//*					  Long	alNbContact	Val
//*
//* Retourne		: $RETURN$	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Boolean			bRet	=	True
Long				lCpt, lCpt1
DwItemStatus	dwStatus	
Long				lNbVal
Long				lIdNat

For lCpt = 1 To alNbContact

	dwStatus	=	idw_LstContact.GetItemStatus ( lCpt, 0, Primary! )	

/*------------------------------------------------------------------*/
/* Je ne traite que les lignes nouvellement insérées                */
/*------------------------------------------------------------------*/

	If ( dwStatus = New! Or dwStatus = NewModified! ) Or &
		( idw_LstContact.GetItemString ( lCpt, "ALT_VALIDE" ) = 'O' ) Then

		lIdNat	=	idw_LstContact.GetItemNumber ( lCpt, "ID_NAT_MSG" )
		If IsNull ( lIdNat ) Then lIdNat = 0
		lNbVal	=	UpperBound ( alNature )

		For lCpt1 = 1 To lNbVal 

			If alNature [lCpt1] = lIdNat Then

				bRet	=	False
				Exit
			End If
		Next 

		If Not bRet Then Exit
	End If
Next

Return ( bRet )
end function

private function string uf_controlergestion_commandes ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_ControlerGestion_Commande (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/01/1998 17:35:30
//* Libellé			: Contrôle la cohérence finale entre les codes états des 
//*					  Commandes/Prestations et les code états des détails/Gti/dossiers.
//* Commentaires	: 
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ	PAR		Date		Modification
//* #1	CAG	03/02/2003 	Annexe 22 : ne pas faire apparaître le msg
//*									'une gti ne peut ê mise ss suite alors que
//*									des cmdes/prs liées à cette gti sont en cours'
//*									si toutes les cmdes liées à cette gti ont id_bsp > 0
//* #2	CAG	04/02/2003	Suite dmd Orange, bug sur pls cmdes au niveau gestionnaire :
//*									les gestionnaires ne peuvent pas passer plus d'1 cmde
//* #3	JFF	12/08/2003	La suite des n° de séquences des commandes ne doit pas coporter de creux.
//* #4	JFF	12/11/2003	Gestion particuliere pour DARTY
//* #5	JFF	30/12/2003	DCMP 030582 : Suppression du contrôle DARTY
//* #6	JFF	10/05/2005	Darty nomade
//* #7	MADM  10/01/2006	CTRL si SBE en code etat CNV et VA et RIB NULL
//* #8	MADM  09/05/2006	CTRL si CORDON en code etat CNV et VA et RIB NULL
//* #9	JFF   07/12/2006	MADM en placant le #7 et #8 a shunté l'armement de mon lTot, d'où bug
//*									Je le replace à l'emplacement d'origine.
//* #10	JCA	08/10/2007	DCMP 70721 - Suppression d'un contôle pour la cellule facturation fournisseurs
//* #11  JFF   07/10/2007	[DCMP070807] shunt pour le cas C-Discount
//* #12  JFF   21/12/2007	[O2M]
//* #13	PHG	10/01/2008	[O2M].389 : Ajout d'un controle de Gestion : Obligation de Notification 
//*									a O2M par le gestionnaire de sa PEC on de son Refus.
//* #14  JFF   16/01/2008  [O2M] Contrôle générale sur les commandes.
//* #15  JFF   05/02/2008  [O2M]
//* #16  JFF   01/04/2008  [DCMP080256][EEE_PC_ASUS] 
//* #17	JFF	20/10/2008  [FNAC_PROD_ECH_TECH].[20090127140540720]
//* #18	JFF	13/02/2009  [FNAC_PROD_ECH_TECH].[20090213145759303]
//* #19  JFF   10/06/2009  [MOBISQUARE]
//* #20  JFF   03/08/2008  [CAMARA].[PRESTA_WEB_BOUTIQUE]
//* #21  PHG   01/07/2009  [O2M_DIAG_NOMADE] Les Echange EDI euvent concerner CDS et O2M => msg CDS que si CDS
//* #22  JFF   02/09/2009  [DCMP090327].[SBETV]
//* #23  JFF   15/10/2009  [DCMP090421]
//* #24  JFF   27/10/2009  [FNAC_PROD_ECH_TECH].[BGE].[20091027112156767]
//* #25  JFF   25/11/2009  [MSS_DIAG]
//* #26  JFF   22/02/2010  [20100222154741437] Bug relevé par AUR, ladr mai se place plusieurs fois
//* #27  JFF   02/03/2010  [MSS_LOT2]
//*  	   JFF	13/04/2010  [WEBSIM2].[FRANCE]
//*      JFF   24/06/2010  [20100624141637603] Modif Véro 24/06 suite manuqe analyse
//*      JFF   30/06/2010  [PC363_AUCHAN]
//		FPI	16/07/2010	[PC321] 
// 		FPI	11/08/2010	[PM01] Autoriser +ieurs commandes si A_RECUP_A_RECYCLER
//		FPI	29/09/2010	[PC514] Ajout de ACU
//* 		 JFF     04/11/2010 [PC301].[LOT2]
//*      JFF   29/11/2010  [PC474]
//*      JFF   03/12/2010  [DCMP100507/100508/100444]
//*		JFF	06/05/2011  [VDOC3880][VDOC3433]
//*	   JFF   09/06/2011  [VDOC4097]
//*      JFF   05/07/2011  [PC292][AUCHAN]
//*      JFF   08/07/2011  [VDOC4713][VDOC4714]
//*      JFF   01/09/2011  [PC10][DIAG_NOMADE]
//*      JFF   19/09/2011  [PM82][LOT1]
//*      JFF   12/12/2011  [VDOC4970]
//*      JFF   05/01/2012  [RECUP_DONNEE_O2M]
//*      JFF   27/01/2012  [VDOC6381]
//*      JFF   27/01/2012  [VDOC6507]
//*  	   JFF   07/06/2012  [PM103][1]
//*      JFF   31/07/2012  [RECUP_DONNEE_O2M][MANTIS3873]
//*      JFF   06/08/2012  [BLCODE]
//*	   FPI	08/08/2012	[PC10-2] Mantis4061
//*      JFF   10/08/2012  [RECUPDONN_MANTIS4252]
//*      JFF   01/10/2012  [MANTIS4832]
//*      JFF   01/10/2012  [VDOC9235]
//		   FPI	18/12/2012	[PC10-2] Mantis 6082
//       JFF   20/12/2012  [VDOC9390]
//       JFF   03/01/2013  [ITSM140744]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//       JFF   20/06/2013   [VDOC10659]
//		FPI	02/07/2013	[PC954]
//		FPI	16/08/2013	[ITSM170730]
//       JFF   09/09/2013 [PM222-1]
//		FPI	18/11/2013	[PC973].Mantis 9420
//       JFF   28/03/2014 [DT081_EVOL_PRET_BRIS]
//        JFF   01/07/2014   [PC786-1_AUCHAN_GEM][MANTIS11397] 
//		FPI	02/07/2014	[ITSM222849]
//       JFF   02/10/2014 [VDOC15485]
//       JFF   03/10/2014 [VDOC15472]
//		FPI	24/12/2014	[ITSM259207] Correction messages d'erreur
//    JFF   26/05/2015  [ITSM295258] Correctif bug
//		FPI	08/09/2015	[PC13442-2]
//    JFF   24/09/2015  [ITSM326391]
//    JFF   02/10/2015  [ITSM329177]
//    JFF   03/12/2015  [ID_SEQ_SUP_9]
//    JFF   06/11/2015 [VDOC18931]
//    JFF   03/02/2016 [DT191][V3]
//    JFF   23/02/2016 [PM330-1]
//    JFF   11/04/2016 [CTRLE_PRESTA_SIN]
//    JFF   04/05/2016 [PM330-1][ITSM380421]
//    JFF   17/05/2016 [PM280-2]
//    JFF   02/06/2016 [BUG_IPHONE_DESOX]
//    JFF   07/06/2016 [DT227]
//		JFF   24/06/2016 [BUG_C_BAILLY]
//  	FPI	13/07/2016 [BUG_SAL]
//    JFF   01/08/2016 [PM364-1]
//    JFF   07/09/2016 [DT251][M21803]
//    JFF   11/10/2016 [DT227][V3]
//    JFF   21/02/2107 [DT288]
//    JFF   01/08/2017 [DT288-1][MODIF_CHRISTINE]
//		JFF	20/06/2018 [ITSM540748]
//    JFF   03/09/2018 [DT361]
//    JFF   01/10/2018 [PM445-1]
//    JFF   07/03/2024 [HP252_276_HUB_PRESTA]
//    JFF   05/08/2024 [MCO602_PNEU]
//    JFF   30/07/2025 [20250730153200137]
//*-----------------------------------------------------------------

String	sPos, sVar, sVar2, sRech, sTitreCplt, sVal1, sVal2, sVal 
String   sCodModReg , sRibAg , sRibGui , sRibCpt , sRibCle
Boolean	bOk, bOkAffich, bCommander, bMailDARTY, bCDiscount, bAM2DIFFO2MEC, bAM2O2MEC, bPieceAReclamer, bBAMetALE, bWBBetSMS, bErr, bWBBetCAF
Boolean  bCarrefourCarma
Long		lTot, lCodEtatSin, lCodEtat, lCpt, lIdSeq, lIdGti, lIdDetail, lRow, lCptTypArt, lCptCmde, lRowTrv 
Long		lTotCmd, lDeb, lFin , lTotInt, lVal1, lVal2, lVal3, lVal4, lVal5, lVal6, lIdSeqMax
n_cst_string lnvPFCString
Boolean bSavRDC // [PC321]
Boolean bVal1, bVal2, bVal3
Boolean	bCASPART // #16 [DCMP080256][EEE_PC_ASUS] 
Boolean  bForcagePEC, bDiag
DateTime dtDt1, dtDt2, dtDt3, dtCreeLe

dtCreeLe = idw_Wsin.GetItemDateTime ( 1, "CREE_LE" )
sTitreCplt = ""
sPos = ""
bOk  = True
bDiag = False
bCommander = True
bCASPART = False // #16 [DCMP080256][EEE_PC_ASUS] 
lRowTrv = 0
lTotCmd = idw_LstwCommande.RowCount () 
lTotInt = idw_LstInter.RowCount ()
stMessage.sCode = ""
bPieceAReclamer = idw_wPiece.Rowcount () > 0  // #15
bForcagePEC = False

// #10
// !!! Si l'opérateur à un rôle de facturation on n'effectue pas ce contrôle !!!
if this.uf_getautorisation2(208) then return sPos
// FIN - #10

If F_CLE_A_TRUE ( "SHUNT_CTRLE_FORC_PEC" ) Then
	Choose Case stGlb.sCodOper
		Case "JFF", "FPI"
			return sPos
	End Choose
End If

// [CTRLE_PRESTA_SIN]
idw_wDivDet.SetFilter ( "UPPER ( NOM_ZONE ) = 'ALT_PEC' AND VAL_CAR = 'O'" )
idw_wDivDet.Filter ()
bForcagePEC = idw_wDivDet.RowCount() > 0 
idw_wDivDet.SetFilter ( "" )
idw_wDivDet.Filter ()
idw_wDivDet.Sort ()

/*------------------------------------------------------------------*/
/* Gestion particuliere C-DISCOUNT (-DP/37)								  */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 37 )
bCDiscount = lDeb > 0 

idw_LstwCommande.SetFilter ( "ID_FOUR IN ( 'CAR', 'CMA') AND COD_ETAT IN ('CNV', 'ECT')" )
idw_LstwCommande.Filter ( )
bCarrefourCarma = idw_LstwCommande.RowCount () > 0
idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ( )

/*------------------------------------------------------------------*/
/* #2				                                                     */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Cas où l'on ne peut pas passer une 2ème commande (sauf pour      */
/* AG/RG)  DCMP20103                                                */
/*------------------------------------------------------------------*/
sRech = "(COD_ETAT IN ( 'RCF', 'ECT', 'CNV', 'CWE' ) OR ( COD_ETAT = 'ECL' AND ID_TYP_ART <> 'PRS' )) AND ID_TYP_ART <>'EDI'"
lRowTrv = idw_LstwCommande.Find ( sRech, 1, lTotCmd )
If lRowTrv > 0 And lTotCmd > lRowTrv Then
	bCommander = idw_LstwCommande.Find ( sRech, lRowTrv + 1, lTotCmd ) <= 0

	// #20 [CAMARA].[PRESTA_WEB_BOUTIQUE]
	If lTotCmd = 2 Then
		bWBBetSMS = idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT', 'CNV', 'CWE' ) AND ID_FOUR = 'WBB'", 1, lTotCmd ) > 0 And &
						idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT', 'CNV') AND ID_TYP_ART = 'SMS'", 1, lTotCmd ) > 0 

	// [WEBSIM2].[FRANCE]
		bWBBetCAF = idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT', 'CNV') AND ID_FOUR <> 'WBB' AND ID_TYP_ART = 'CAF'", 1, lTotCmd ) > 0 And &
						idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT', 'CNV', 'CWE' ) AND ID_FOUR = 'WBB'", 1, lTotCmd ) > 0 
	
		If bWBBetSMS Then 
			bCommander = bWBBetSMS 
		End If

	// [WEBSIM2].[FRANCE]
		If bWBBetCAF Then
			bCommander = bWBBetCAF
		End IF
		
	End If
	// :#20 [CAMARA].[PRESTA_WEB_BOUTIQUE]		
	
	// [PC321]
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_wsin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 141 )
	bSavRDC = lDeb > 0
	
	If bSavRDC and not gbModeReprise_223 Then
		// Autorisation de commander un BA si la PRS diagnostique un App. Irréparable ou  déclenche un refus réparation < 150€
		sRech = "ID_TYP_ART = 'PRS' AND  COD_ETAT <> 'ANN' AND INFO_SPB_FRN IN (1425, 1442,1443)"
		bCommander =idw_LstwCommande.Find  ( sRech, 1,idw_LstwCommande.RowCount () ) > 0
		
		// [PC954]
		If not bCommander Then
			// Autorisation de commander un BA si la cmd diagnostique O2M est répondue ou l'appareil réceptionné
			sRech = "ID_TYP_ART = 'EDI' AND  COD_ETAT <> 'ANN' AND (STATUS_GC=159 OR COD_ETAT='RFO')"
			bCommander =idw_LstwCommande.Find  ( sRech, 1,idw_LstwCommande.RowCount () ) > 0
		End if
		// [PC954]
	End if
	// :[PC321]
	
	// [PC10][DIAG_NOMADE]

	// [ITSM540748]
	/* Je shunte un contrôle qui n'a pu lieu d'être.. ITSM540748_SHUNT
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_wsin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 46 )
		If lDeb > 0 Then
			// [DT251][M21803]
			sRech = "ID_TYP_ART NOT IN ( 'TEL', 'CAF', 'AEF' ) AND COD_ETAT IN ( 'ECT', 'CNV') AND ID_FOUR in ('MBS', 'CVC','FPC','ATC', 'O2M' )" // [PC10-2] Ajout de CVC // [ITSM170730] Ajout FPC // [PC13442-2] ATC
	
			bCommander =idw_LstwCommande.Find  ( sRech, 1,idw_LstwCommande.RowCount () ) > 0
		End if
	*/
	
	// [PC10][DIAG_NOMADE]

	// [MANTIS3204][MANTIS3265]
	// [RECUP_DONNEE_O2M]
	lVal2 = idw_LstwCommande.Find ( "ID_FOUR <> 'O2M' AND ID_TYP_ART IN ( 'TEL' ) AND COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount () ) 	
	lVal3 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_REF_FOUR IN ( 'PAS_DE_COMMANDE' ) AND COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount () ) 

	If lVal2 > 0 And lVal3 > 0 Then
		bCommander = TRUE
	End If
	// [RECUP_DONNEE_O2M]		
	// [MANTIS3204]

	// [PC938_ORANGE_V3]
	lVal2 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_TYP_ART IN ( 'TEL', 'TPC', 'RST' ) AND COD_ETAT IN ( 'CNV', 'ECT' )", 1, idw_LstwCommande.RowCount () ) 	
	lVal3 = idw_LstwCommande.Find ( "ID_FOUR = 'PSM' AND ID_TYP_ART IN ( 'REL' )  AND COD_ETAT IN ( 'CNV', 'ECT' )", 1, idw_LstwCommande.RowCount () ) 

	If lVal2 > 0 And lVal3 > 0 Then
		bCommander = TRUE
	End If
	// [PC938_ORANGE_V3]

	// [VDOC10659]
	lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'WBA' AND COD_ETAT = 'CWE'", 1, idw_LstwCommande.RowCount ()) 
	lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_TYP_ART NOT IN ( 'PRS', 'EDI', 'DEV', 'CAF', 'AEF', 'CAS', 'SMS', 'BAM', 'ALE', 'ACC', 'PCM', 'MAI', 'REL', 'RST', 'PST', 'RES', 'REA') ", 1, idw_LstwCommande.RowCount ()) 

	If lVal1 > 0 And lVal2 > 0 Then
		bCommander = TRUE
	End If
	// [VDOC10659]	

	// [PC786-1_AUCHAN_GEM]  
	lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'AUC' AND ID_TYP_ART = 'CAF' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount ()) 
	lVal2 = idw_LstwCommande.Find ( "ID_FOUR = 'AUC' AND ID_TYP_ART = 'CAF' AND COD_ETAT = 'CNV' AND ID_GTI = 52", 1, idw_LstwCommande.RowCount ()) 
	lVal3 = idw_LstwCommande.Find ( "ID_FOUR = 'AUC' AND ID_TYP_ART = 'CAF' AND COD_ETAT = 'CNV' AND ID_GTI <> 52", 1, idw_LstwCommande.RowCount ()) 

	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 140 )		
	If lDeb > 0 Then
		sVal=lnvPFCString.of_getkeyvalue( idw_DetPro.GetItemString(lDeb, "VAL_CAR"), "TYPE", ";")
		
		If sVal = "GEM" And lVal1 > 0 And lVal2 > 0 And lVal3 > 0 Then
			bCommander = TRUE
		End If
	End If
	// [PC786-1_AUCHAN_GEM]  

End If


idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV' AND ID_TYP_ART = 'TEL' " )
idw_LstwCommande.Filter ( )
bMailDarty = idw_LstwCommande.RowCount () <= 3 // Mail possible dans ce cas
idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ( )

/*------------------------------------------------------------------*/
/* Si l'on ne peut pas commander et que l'on est gestionnaire       */
/* alors...                                                         */
/* DCMP20103																		  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 45 )  // 3 mob max sél autorisés
If lDeb > 0 Then
		If Not bMailDarty Then
			stMessage.sTitre		= "Commandes"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= Ok!
			stMessage.sCode		= "COMD063"

			sPos = "ALT_BLOC"

			idw_LstwCommande.SetFilter ( "" )
			idw_LstwCommande.Filter ( )
			idw_LstwCommande.Sort ( )
	
			Return sPos
		End If

ElseIf Not bCommander And stGlb.sTypOper < "5" Then
	stMessage.sTitre		= "Commandes"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= Ok!
	stMessage.sCode		= "COMD035"

	sPos = "ALT_BLOC"

	idw_LstwCommande.SetFilter ( "" )
	idw_LstwCommande.Filter ( )
	idw_LstwCommande.Sort ( )

	Return sPos
End If


/*---------------------------------------------------------------------*/
/* Gestion des commandes :                                             */
/* Il est illogique de valider une commande (cpt_valide=0) si le       */
/* dossier est refusé/sans suite ou si la garantie ou le détail liés à */
/* cette commande sont refusés/sans suite.                             */
/* Je ne test pas volontairement ibAltCmdMobile, je préfère dans ts    */
/* les cas contrôler qu'aucune commande ne partent pas dans ces condi- */
/* tions.																				  */
/*---------------------------------------------------------------------*/
/* Le 21/11/2001 JFF : En fait si au moins une commande n'est pas      */
/* en Etat 'ANN' (annuler) ou 'RSP' (Retour SPB), on ne peut pas 		  */
/*	refuser le dossier.         													  */
/*---------------------------------------------------------------------*/
/* Le 03/09/2002 JFF : On accepte le ssuite ou refusé pour les ECL     */
/* pour pour gérer les pannes irréparable SFR.								  */
/*---------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* #5                                                               */
/* Au moins un CET et Aucun autre Frn, alors pas de Ctrl.			  */
/*------------------------------------------------------------------*/
lTot = idw_LstwCommande.RowCount ( )
If idw_LstwCommande.Find ( "ID_FOUR = 'CET'", 1, lTot ) > 0 Then
	If idw_LstwCommande.Find ( "ID_FOUR <> 'CET'", 1, lTot ) <= 0 Then
		Return sPos
	End If
End If

// #13 [O2M].389
//   Si dossier non bloqué 
//    ET
//    Si présence d'une prestation O2M de type A_DIAGNOSTIQUER ET ayant un status_gc > 0 
//    ET
//    Absence d'une prestation O2M de type ( PEC_A_RECYCLER ou REFUSE_A_REEXP ) avec un id_seq > l'id_seq de la presta O2M A_DIAG
//		Msg :
//    	Vous avez reçu une réponse d'O2M suite à une demande de diagnostique,
//    	vous devez avant tout autre action renvoyer un flux vers O2M pour les prévenir, soit de votre prise en charge, soit de votre refus.
// #15
//* #18[FNAC_PROD_ECH_TECH].[20090213145759303]
//* #22 [DCMP090327].[SBETV]
//* #25 [MSS_DIAG]
//* [MSS_DIAG].[##] Revoir les status !!

// #27 [MSS_LOT2]

// [VDOC4097]
// If bOk And Not bPieceAReclamer Then
If bOk Then

	lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'MS1' AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' ) AND STATUS_GC = 175", 1, idw_LstwCommande.RowCount() )
	lVal2 = idw_LstwCommande.Find ( "ID_FOUR = 'MS1' AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' ) AND STATUS_GC = 151", 1, idw_LstwCommande.RowCount() )
	lVal3 = idw_LstwCommande.Find ( "ID_FOUR = 'MS1' AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'CMDE_AUT_ACC', 'PAS_DE_COMMANDE')", 1, idw_LstwCommande.RowCount() )

	// [DCMP100507/100508/100444]
	lVal4 = idw_LstwCommande.Find ( "ID_FOUR = 'MS1' AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP')", 1, idw_LstwCommande.RowCount() )
	lVal5 = idw_LstwCommande.Find ( "ID_FOUR = 'MS1' AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'PEC_A_RECYCLER')", 1, idw_LstwCommande.RowCount() )

   // [VDOC4713][VDOC4714]
	lVal6 = idw_LstwCommande.Find ( "ID_FOUR = 'MS1' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )

	// [VDOC4713][VDOC4714]
	If lVal6 > 0 Then
		If ( ( lVal2 > 0 And This.uf_GestOng_Divers_Trouver( "AUT_ACC_SIN" ) = "O" ) Or lVal1 > 0 ) Then 
			If ( lVal4 > 0 And lVal3 > 0 ) Then
				bOk = False
				stMessage.sTitre		= "Commandes"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= Ok!
				stMessage.sCode		= "COMD649"
			End IF
	
			If ( lVal3 <= 0 And lVal5 > 0 ) Or ( lVal5 <= 0 And lVal3 > 0 ) Or ( lVal5 <= 0 And lVal4 <= 0 ) Then
				bOk = False
				stMessage.sTitre		= "Commandes"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= Ok!
				stMessage.sCode		= "COMD616"
			End IF
		// [DCMP100507/100508/100444]	
		End IF
	End IF	
End If
// :#27 [MSS_LOT2]

// [VDOC4970]
// [BLCODE]
If bOk Then

	lVal1 = idw_LstwCommande.Find ( "ID_FOUR IN ( 'O2M', 'BLC' ) AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' ) AND STATUS_GC = 175", 1, idw_LstwCommande.RowCount() )
	lVal2 = idw_LstwCommande.Find ( "ID_FOUR IN ( 'O2M', 'BLC' ) AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' ) AND STATUS_GC = 151", 1, idw_LstwCommande.RowCount() )
	lVal3 = idw_LstwCommande.Find ( "ID_FOUR IN ( 'O2M', 'BLC' ) AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'CMDE_AUT_ACC', 'PAS_DE_COMMANDE')", 1, idw_LstwCommande.RowCount() )

	// [DCMP100507/100508/100444]
	lVal4 = idw_LstwCommande.Find ( "ID_FOUR IN ( 'O2M', 'BLC' ) AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP')", 1, idw_LstwCommande.RowCount() )
	lVal5 = idw_LstwCommande.Find ( "ID_FOUR IN ( 'O2M', 'BLC' ) AND COD_ETAT <> 'ANN' AND ID_REF_FOUR IN ( 'PEC_A_RECYCLER')", 1, idw_LstwCommande.RowCount() )

	// [VDOC4713][VDOC4714]
	lVal6 = idw_LstwCommande.Find ( "ID_FOUR IN ( 'O2M', 'BLC' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )

	// [VDOC4713][VDOC4714]
	If lVal6 > 0 Then
		If ( ( lVal2 > 0 And This.uf_GestOng_Divers_Trouver( "AUT_ACC_SIN" ) = "O" ) Or lVal1 > 0 ) Then 
			If ( lVal4 > 0 And lVal3 > 0 ) Then
				bOk = False
				stMessage.sTitre		= "Commandes"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= Ok!
				stMessage.sCode		= "COMD649"
			End IF
	
			If ( lVal3 <= 0 And lVal5 > 0 ) Or ( lVal5 <= 0 And lVal3 > 0 ) Or ( lVal5 <= 0 And lVal4 <= 0 ) Then
				bOk = False
				stMessage.sTitre		= "Commandes"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= Ok!
				stMessage.sCode		= "COMD694"
			End IF
		// [DCMP100507/100508/100444]	
		End IF
	End IF	
End If
// :[VDOC4970]

// [BLCODE]
If bOk And Not bPieceAReclamer Then
	// [PC301].[LOT2] Ajout 170
	
	// [VDOC9304_PM82_LOT1]
	// [VDOC15485]
	// [DT141]
	lRow = idw_LstwCommande.find("ID_FOUR IN ('BLC', 'O2M', 'SB1', 'MS1', 'SBE') AND ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND STATUS_GC IN ( 151, 152, 153, 154, 171 ) AND COD_ETAT <> 'ANN'",1,  idw_LstwCommande.rowCount()+1 )
	
	if lRow > 0 Then lIdSeq = idw_LstwCommande.object.id_seq[lRow]
	// #27 [MSS_LOT2]
	if (idw_WSin.GetItemString(1, "ALT_BLOC") <> "O" and Not IsNull(idw_WSin.GetItemString(1, "ALT_BLOC"))) and lRow > 0 Then
		bErr = idw_LstwCommande.Find("ID_FOUR IN ('BLC','O2M', 'SB1', 'MS1', 'SBE') AND ID_REF_FOUR IN ('PEC_A_RECYCLER', 'REFUSE_A_REEXP' ) AND COD_ETAT <> 'ANN' AND ID_SEQ > " + string(lIdSeq), 1, idw_LstwCommande.rowCount()+1 ) = 0 
		
		// [DCMP100507/100508/100444]	ajout1202
		bCASPART = idw_LstwCommande.Find("ID_FOUR IN ('BLC', 'O2M', 'SB1', 'MS1', 'SBE') AND ID_REF_FOUR IN ('ENVOI_DEVIS_ASSURE' ) AND COD_ETAT <> 'ANN' AND ID_SEQ > " + string(lIdSeq), 1, idw_LstwCommande.rowCount()+1 ) > 0 Or &
			 		  idw_LstwCommande.Find("ID_FOUR IN ('BLC', 'O2M', 'SB1', 'MS1', 'SBE') AND INFO_SPB_FRN IN (1262, 1202) AND COD_ETAT <> 'ANN' AND COD_ETAT = 'CNV' AND ID_SEQ > " + string(lIdSeq), 1, idw_LstwCommande.rowCount()+1 ) > 0 

		// [ITSM78303/79027]
		// [ITSM81110]
		If Not bCASPART Then
			bCASPART = idw_LstwCommande.Find("ID_FOUR IN ('BLC', 'O2M', 'SB1', 'MS1', 'SBE') AND STATUS_GC IN (173) AND COD_ETAT <> 'ANN' AND ID_SEQ > " + string(lIdSeq), 1, idw_LstwCommande.rowCount()+1 ) > 0 
		End If

	// [PC301].[LOT2]
		If Not bCASPART then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 152 )
			If lDeb > 0 Then 
				bCASPART = idw_LstwCommande.Find ( "ID_FOUR = 'SB1' AND STATUS_GC IN ( 171 )", 1, idw_LstwCommande.rowCount()+1 ) > 0 
			End If
		End If
	// :[PC301].[LOT2]

		If bErr And Not bCASPART Then
			bOk = FALSE // JFF
			stMessage.sVar[1] = "Vous avez reçu une réponse du centre de diagnostic/broker suite à une demande de diagnostic,~r~nvous devez avant tout autre action renvoyer un flux vers ce dernier pour le prévenir, soit de votre prise en charge, soit de votre refus."
		End If
		
	End If
	bCASPART = False
	// :#27 [MSS_LOT2]
End If
//* :#22 [DCMP090327].[SBETV]

// [PM82][LOT1]
If bOk And Not bPieceAReclamer Then

	// [MANTIS4832]
	// [PM222-1]
	// [VDOC18931]

	// [HP252_276_HUB_PRESTA]
	If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then	
		lVal1 = idw_LstwCommande.Find ( "( ID_REF_FOUR = 'A_REPARER' OR POS ( INFO_SPB_FRN_CPLT, 'A_REPARER_SAV=OUI') > 0 OR ( POS ( INFO_SPB_FRN_CPLT, 'A_CONTROLER_SAV=OUI') > 0 ) AND ID_REF_FOUR = 'A_REPARER' ) AND ID_TYP_ART = 'PRS' AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 153, 154 )", 1, idw_LstwCommande.rowCount()+1 ) 		

		If idw_LstwCommande.Find ( "POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0" , 1, idw_LstwCommande.rowCount() ) > 0 Then

			lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_REPARER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 153 )", 1, idw_LstwCommande.rowCount()+1 ) 								
			
			If lVal1 <= 0 Then
				lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 153, 154 )", 1, idw_LstwCommande.rowCount()+1 ) 
				bDiag = lVal1 > 0 
			End If 
		End If 		
	Else
		lVal1 = idw_LstwCommande.Find ( "( ID_REF_FOUR = 'A_REPARER' OR POS ( INFO_SPB_FRN_CPLT, 'A_REPARER_SAV=OUI') > 0 OR ( POS ( INFO_SPB_FRN_CPLT, 'A_CONTROLER_SAV=OUI') > 0 ) AND ID_REF_FOUR = 'A_REPARER' ) AND ID_TYP_ART = 'PRS' AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 153, 154 )", 1, idw_LstwCommande.rowCount()+1 ) 		
	End If 
	
	// [HP252_276_HUB_PRESTA] Ajout A_DIAG_FORCE
	lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DIAG_FORCE' ) AND COD_ETAT <> 'ANN' ", 1, idw_LstwCommande.rowCount()+1 ) 

	// [PM222-1]
	lVal3 = idw_LstwCommande.Find ( "( ID_REF_FOUR = 'A_DESOXYDER' OR POS ( INFO_SPB_FRN_CPLT, 'A_DESOXYDER_SAV=OUI') > 0 OR ( POS ( INFO_SPB_FRN_CPLT, 'A_CONTROLER_SAV=OUI') > 0) AND ID_REF_FOUR = 'A_DESOXYDER' ) AND ID_TYP_ART = 'PRS' AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 153, 154 )", 1, idw_LstwCommande.rowCount()+1 )
	lVal4 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_DESOXYDER_FORCE') AND COD_ETAT <> 'ANN' ", 1, idw_LstwCommande.rowCount()+1 ) 		
	
	If ( lVal1 > 0 And lVal2 <= 0 ) Then
		bOk = FALSE // JFF
		stMessage.sVar[1] = "Vous avez reçu du prestataire une information indiquant un IMEI/N° Série différent ou illisible, vous devez lui renvoyer une information. Pour ce cas vous ne pouvez renvoyer qu'un REFUS_A_REEXP ou A_REPARER_FORCE"
		If bDiag Then 	// [HP252_276_HUB_PRESTA]
			stMessage.sVar[1] = "Vous avez reçu du prestataire une information indiquant un IMEI/N° Série différent ou illisible, vous devez lui renvoyer une information. Pour ce cas vous ne pouvez renvoyer qu'un REFUS_A_REEXP ou A_DIAG_FORCE"
		End If 
	End If
	
	If ( lVal3 > 0 And lVal4 <= 0 ) Then
		bOk = FALSE // JFF
		stMessage.sVar[1] = "Vous avez reçu du prestataire une information indiquant un IMEI différent ou illisible, vous devez lui renvoyer une information. Pour ce cas vous ne pouvez renvoyer qu'un REFUS_A_REEXP ou A_DESOXYDER_FORCE"
	End If

End If	
// [PM82][LOT1]

// [HP252_276_HUB_PRESTA] 305 Géoloc Hub
If bOk And Not bPieceAReclamer Then
	If idw_LstwCommande.Find ( "POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0" , 1, idw_LstwCommande.rowCount() ) > 0 Then

		lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_REPARER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 305 )", 1, idw_LstwCommande.rowCount()+1 ) 								
		
		If lVal1 <= 0 Then
			lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 305 )", 1, idw_LstwCommande.rowCount()+1 ) 
			bDiag = lVal1 > 0 
		End If 


		lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DIAG_FORCE' ) AND COD_ETAT = 'CNV' ", 1, idw_LstwCommande.rowCount()+1 ) 	
	
		If ( lVal1 > 0 And lVal2 <= 0 ) Then
			bOk = FALSE // JFF
			stMessage.sVar[1] = "Vous avez reçu du prestataire une information indiquant une géolocalisation, vous devez lui renvoyer une information. Pour ce cas vous devez renvoyer un A_REPARER_FORCE après avoir contacté l'assuré pour lui dire de DéGéolocaliser son appareil, et si après plusieurs aller/retour il ne fait pas l'action de DéGéolocaliser l'appareil alors renvoyer un REFUSE_A_REEXP."
			If bDiag Then 	// [HP252_276_HUB_PRESTA]
				stMessage.sVar[1] = "Vous avez reçu du prestataire une information indiquant une géolocalisation, vous devez lui renvoyer une information. Pour ce cas vous devez renvoyer un A_DIAG_FORCE après avoir contacté l'assuré pour lui dire de DéGéolocaliser son appareil, et si après plusieurs aller/retour il ne fait pas l'action de DéGéolocaliser l'appareil alors renvoyer un REFUSE_A_REEXP."
			End If 
		End If	
	End If		
End If 

// [HP252_276_HUB_PRESTA] 169 Incomplet Hub [20250228130407143]
If bOk And Not bPieceAReclamer Then
	If idw_LstwCommande.Find ( "POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0" , 1, idw_LstwCommande.rowCount() ) > 0 Then

		lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_REPARER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 169 )", 1, idw_LstwCommande.rowCount()+1 ) 								
		
		If lVal1 <= 0 Then
			lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 169 )", 1, idw_LstwCommande.rowCount()+1 ) 
			bDiag = lVal1 > 0 
		End If 


		lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DIAG_FORCE' ) AND COD_ETAT = 'CNV' ", 1, idw_LstwCommande.rowCount()+1 ) 	
	
		If ( lVal1 > 0 And lVal2 <= 0 ) Then
			bOk = FALSE // JFF
			stMessage.sVar[1] = "Vous avez reçu du prestataire une information indiquant un appareil incomplet, vous devez lui renvoyer une information. Pour ce cas vous ne pouvez renvoyer qu'un A_REPARER_FORCE s'il renvoie effectivement les accessoirement manquant, sinon un REFUSE_A_REEXP."
			If bDiag Then 	// [HP252_276_HUB_PRESTA]
				stMessage.sVar[1] = "Vous avez reçu du prestataire une information indiquant un appareil incomplet, vous devez lui renvoyer une information. Pour ce cas vous ne pouvez renvoyer qu'un A_DIAG_FORCE s'il renvoie effectivement les accessoirement manquant, sinon un REFUSE_A_REEXP."
			End If 
		End If	
	End If		
End If 


// #15
//* #22 [DCMP090327].[SBETV]
//* #25 [MSS_DIAG]
// [PM103][1]
// [DT141]
If bOk And Not gbModeReprise_223 Then
	lRow = idw_LstwCommande.Find ( "ID_FOUR IN ('BLC', 'O2M', 'SB1', 'MS1', 'SBE') AND COD_ETAT = 'CNV' AND ID_REF_FOUR = 'REFUSE_A_REEXP'", 1, idw_LstwCommande.RowCount () )
	If lRow > 0 Then
		lRow = idw_wParaInfo.Find ( "ID_I = 0 AND ID_PARA = 'Z076'", 1, idw_wParaInfo.RowCount () )
		If lRow <= 0 Then
		
			stMessage.sTitre  	= "Controle de gestion des commandes"
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= YESNO!
			stMessage.sCode = "COMD470"		
		
			If F_Message ( stMessage ) = 2 Then
				bOk = False
				stMessage.svar[1] = "Placez votre paragraphe sur l'onglet Interlocuteur"				
			End If
			stMessage.sCode = ""			

		End If		
	End If
	
End IF// :#15
//* :#22 [DCMP090327].[SBETV]

// #9 JFF le 07/12/2006 !! Ce code doit rester ICI !!! Juste avant le prochain "If bOk" !
//* #22 [DCMP090327].[SBETV]
//* #25 [MSS_DIAG]
// [PC321] Ajout de SCR
// [PM82][LOT1][MANTIS2939] ajout COR, SBE, PSM, 
// [PC801-6][MANTIS14329] ajout TMT
//[CTRLE_PRESTA_SIN]
If bForcagePEC Then
	idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'XXX' )" )
Else
	idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'CNV', 'ECT' ) AND " + &
										  "( ID_FOUR NOT IN ( 'BLC', 'O2M', 'SB1', 'MS1' ,'SCR', 'COR', 'SBE', 'PSM', 'TMT' ) " + &
										  "  OR " + &
										  "  ( ID_FOUR IN ( 'BLC', 'O2M', 'SB1', 'MS1' ,'SCR', 'COR', 'SBE', 'PSM', 'TMT' ) " + &
										  " 	 AND " + &
										  "    ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER', 'A_DIAGNOSTIQUER' ) " + &
										  "  ) " + &
										  ") " ) // #12
End If

idw_LstwCommande.Filter ( )
lTot = idw_LstwCommande.RowCount ( )

// [CTRLE_PRESTA_SIN]
lCodEtatSin = idw_wSin.GetItemNumber ( 1, "COD_ETAT" )
//* :#22 [DCMP090327].[SBETV]

/*------------------------------------------------------------------*/
/* #7																					  */	
/* MADM 10/01/2006																  */	
/* Si au moins une prestation SBE en code etat CNV et code mode     */
/* Reglement de l'assuré VA et RIB à NULL alors Ctrl					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* #8																					  */	
/* MADM 09/05/2006																  */	
/* Ajout du même contrôle que #7 pour le fournisseur CORDON	en remplacement de AEVUM */
/* 																					  */
/*------------------------------------------------------------------*/
/* Shunté sur le [DT288]
if idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR IN ( 'SBE','COR','ANV')", 1, lTot ) > 0 Then
	  lRow = idw_LstInter.Find ("COD_INTER = 'A'" , 1 , lTotInt )
     if lRow > 0 Then
			sCodModReg = idw_LstInter.GetItemString (lRow, "COD_MODE_REG") 
		   sRibAg     = idw_LstInter.GetItemString (lRow, "RIB_BQ")
         sRibGui    = idw_LstInter.GetItemString (lRow, "RIB_GUI")
         sRibCpt 	  = idw_LstInter.GetItemString (lRow, "RIB_CPT")
         sRibCle	  = idw_LstInter.GetItemString (lRow, "RIB_CLE") 
 
         if sCodModReg = "VA" and ( IsNull(sRibAg) Or Trim  (sRibAg) = "" ) and &
											 ( IsNull(sRibGui) Or Trim (sRibGui) = "" ) and &
											 ( IsNull(sRibCpt) Or Trim (sRibCpt) = ""  ) and &
											 ( IsNull(sRibCle) Or Trim (sRibCle) = "" ) Then
            bOk = False
            stMessage.sVar[1] = "Pour toute prestation vers ce fournisseur, si vous choisissez le mode de règlement VIREMENT AUTOMATIQUE pour l'interlocuteur ASSURE, alors vous devez saisir un RIB."
         End if
     End if

End IF
*/

/*------------------------------------------------------------------*/
/* Illogique d'avoir une Cmde à valider et le dossier refusé ou     */
/* sans suite																		  */
/*------------------------------------------------------------------*/
If bOk Then 
	If lTot > 0  Then
		CHOOSE CASE lCodEtatSin 
			CASE 200
				bOk = False
				sVar = "refusé"
			CASE 900
				
				// [PM364-1]
				bOk = True
				sVar = ""

	END CHOOSE

		If Not bOk Then stMessage.sVar[1] = "Le dossier ne peut être " + sVar + " alors que des commandes/prestations sont en cours."		

	End If
End If

If bOk Then 
	For lCpt = 1 To lTot
		lIdGti 	 = idw_LstwCommande.GetItemNumber ( lCpt, "ID_GTI" )
		lIdDetail = idw_LstwCommande.GetItemNumber ( lCpt, "ID_DETAIL" )
		lIdSeq 	 = idw_LstwCommande.GetItemNumber ( lCpt, "ID_SEQ" )

		lRow = idw_LstGti.Find ( "ID_GTI = " + String ( lIdGti ), 1, idw_LstGti.RowCount ()  ) 
		If lRow > 0 Then 

			lCodEtat = idw_LstGti.GetItemNumber ( lRow, "COD_ETAT" ) 

			CHOOSE CASE lCodEtat
				CASE 200
					bOk = False

					sVar = "refusé"
				CASE 900
					// [PM364-1]
					bOk = True
					sVar = ""
					
			END CHOOSE
			
			If Not bOk Then
				/*------------------------------------------------------------------*/
				/* #1				                                                     */
				/*------------------------------------------------------------------*/
				bOkAffich = False
				For lCptCmde = 1 To lTot
					If lIdGti = idw_LstwCommande.GetItemNumber ( lCptCmde, "ID_GTI" )		And &
						idw_LstwCommande.GetItemNumber ( lCptCmde, "ID_BSP" ) = 0			And &
						idw_LstwCommande.GetItemString ( lCptCmde, "ID_TYP_ART" ) = "PRS" Then
						bOkAffich = True
						Exit
					End If
				Next
				If bOkAffich Then
					stMessage.sVar[1] = "Une garantie ne peut être " + sVar + " alors que des commandes/prestations liées à cette garantie sont en cours."
				Else
					bOk = True
				End If
				Exit
			End If


			lRow = idw_wDetail.Find ( "ID_GTI = " + String ( lIdGti ) + "AND ID_DETAIL = " + String ( lIdDetail ), 1, idw_wDetail.RowCount ()  )

			If lRow > 0 Then 

				lCodEtat = idw_wDetail.GetItemNumber ( lRow, "COD_ETAT" ) 

				CHOOSE CASE lCodEtat
					CASE 200
						bOk = False
						sVar = "refusé"
					CASE 900
						// [PM364-1]
						bOk = True
						sVar = ""

				END CHOOSE

				If Not bOk Then 
					stMessage.sVar[1] = "Un détail ne peut être " + sVar + " alors que des commandes/prestations liées à ce détail sont en cours."		
					Exit
				End If

			End If
		End If
	Next
End If


/*------------------------------------------------------------------*/
/* Le 28/11/2001 : Si Au moins une commande n'est pas en ANN ou RPC */
/* on ne peut pas Régler le dossier (500) en revanche il peut être   */
/* en cours de réglement (550).                                     */
/*------------------------------------------------------------------*/
If bOk Then
	For lCptTypArt = 1 To 3 

		If bCDiscount and lCptTypArt <> 3 Then Continue

		// #15 
		If Not bCDiscount and lCptTypArt = 3 Then Continue
		
		CHOOSE CASE lCptTypArt
			CASE 1
				// Pour les prestations, on ne régle pas si au moins une Cmde différente de ces codes état
				// Aurélie Leroux ne placant pas de code état RPC pour les prestations, on permet de
				// régler alors avec le code état ECL.
				// #15 Ajout code RFO				
				idw_LstwCommande.SetFilter ( "COD_ETAT NOT IN ( 'ANN', 'RSP', 'ECL', 'RPC', 'RFO' ) AND ID_TYP_ART = 'PRS'" )
				sVar2 = "prestations"

			CASE 2
				// Pour les commandes, on ne régle pas si au moins une Cmde différente de ces code état
				// Aurélie Leroux place un code état RPC pour les commandes.
				// #15 Ajout code RFO
				idw_LstwCommande.SetFilter ( "COD_ETAT NOT IN ( 'ANN', 'RSP', 'RPC', 'RFO' ) AND ID_TYP_ART <> 'PRS'" )
				sVar2 = "commandes"

			CASE 3
				// Pour C-Discount, on n régle pas si Au moins une réponse n'a pas été reçu
				idw_LstwCommande.SetFilter ( "COD_ETAT = 'RFO' AND ID_TYP_ART = 'EDI'" )
				sVar2 = "informations"


		END CHOOSE



		If bOk Then 
			idw_LstwCommande.Filter ( )
			lTot = idw_LstwCommande.RowCount ( )
			lCodEtatSin = idw_wSin.GetItemNumber ( 1, "COD_ETAT" )

//	#11	If ( lTot > 0  And Not bCDiscount ) Or ( lTot <= 0 And bCDiscount ) Then
			// [PM103][1]
			If ( lTot > 0  And Not bCDiscount And Not bCarrefourCarma And Not gbModeReprise_223 ) Then
// :#11
				idw_LstwCommande.SetFilter ( "" )
				idw_LstwCommande.Filter ( )
				idw_LstwCommande.Sort ( )

				CHOOSE CASE lCodEtatSin 
					CASE 600
						bOk = False
						sVar = "clos réglé"
						
						// [RECUP_DONNEE_O2M][MANTIS3873] // [ITSM127119]
						lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
						lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PAS_DE_COMMANDE' )", 1, idw_LstwCommande.RowCount() )																
						
						If lVal1 > 0 And lVal2 > 0 Then
							bOk = True
						End If
						// [RECUP_DONNEE_O2M][MANTIS3873] // [ITSM127119]
						
						// ITSM140744
						lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_RECUP_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
						If lVal1 > 0 Then
							bOk = True
						End If
						
						lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
						lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
						
						If lVal1 = 1 And lVal2 = 1 Then
							bOk = True
						End If

						lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
						lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
						
						If lVal1 = 1 And lVal2 = 1 Then
							bOk = True
						End If
						
						// [VDOC8041]
						lVal1 = idw_LstwCommande.Find ( "STATUS_GC = 232 AND COD_ETAT IN ( 'CNV', 'ECT')", 1, idw_LstwCommande.RowCount() )															
						bOk = True

					CASE 500
						bOk = False
						sVar = "à régler"

						// Cas de contradiction possible [PC479]
						lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'PEC_A_RECYCLER'  )", 1, idw_LstwCommande.RowCount() )
						lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount() )

						If lVal1 > 0 And lVal2 = lVal1 Then
							bOk = True
						End If

						// [RECUP_DONNEE_O2M][MANTIS3873]
						lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
						lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PAS_DE_COMMANDE' )", 1, idw_LstwCommande.RowCount() )																
						
						If lVal1 > 0 And lVal2 > 0 Then
							bOk = True
						End If
						// [RECUP_DONNEE_O2M][MANTIS3873]
						
						// ITSM140744
						lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_RECUP_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
						If lVal1 > 0 Then
							bOk = True
						End If

						lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
						lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
						
						If lVal1 = 1 And lVal2 = 1 Then
							bOk = True
						End If

						lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
						lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
						
						If lVal1 = 1 And lVal2 = 1 Then
							bOk = True
						End If

						// [MANTIS8085] orange v3
						F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
						If lDeb > 0 Then
							lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND COD_ETAT IN ( 'CNV', 'ECT' )", 1, idw_LstwCommande.RowCount () ) 	
							If lVal1 > 0 Then
								bOk = TRUE
							End If
						End If

						// [VDOC8041]
						lVal1 = idw_LstwCommande.Find ( "STATUS_GC = 232 AND COD_ETAT IN ( 'CNV', 'ECT')", 1, idw_LstwCommande.RowCount() )															
						bOk = True

						
				END CHOOSE


				If Not bOk And lCptTypArt = 3 And bCDiscount Then
					stMessage.sVar[1] = "Le dossier ne peut être " + sVar + " alors que des " + sVar2 + " envoyées au fournisseur sont restées sans réponse de sa part."				

				ElseIf Not bOk Then 
					 stMessage.sVar[1] = "Le dossier ne peut être " + sVar + " alors que des " + sVar2 + " sont en cours."		

				End If

			End If
		End If

		If bOk And Not bCDiscount And Not bCarrefourCarma Then 
			For lCpt = 1 To lTot
				lIdGti 	 = idw_LstwCommande.GetItemNumber ( lCpt, "ID_GTI" )
				lIdDetail = idw_LstwCommande.GetItemNumber ( lCpt, "ID_DETAIL" )
				lIdSeq 	 = idw_LstwCommande.GetItemNumber ( lCpt, "ID_SEQ" )

				lRow = idw_LstGti.Find ( "ID_GTI = " + String ( lIdGti ), 1, idw_LstGti.RowCount ()  ) 

				// [PM103][1]
				If lRow > 0 And Not gbModeReprise_223 Then 

					lCodEtat = idw_LstGti.GetItemNumber ( lRow, "COD_ETAT" ) 

					CHOOSE CASE lCodEtat
						CASE 600
							bOk = False
							sVar = "clos réglé"
							
							
							// [RECUP_DONNEE_O2M][MANTIS3873] // [ITSM127119]
							lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
							lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PAS_DE_COMMANDE' )", 1, idw_LstwCommande.RowCount() )																
							
							If lVal1 > 0 And lVal2 > 0 Then
								bOk = True
							End If
							// [RECUP_DONNEE_O2M][MANTIS3873] // [ITSM127119]

							// ITSM140744
							lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_RECUP_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
							If lVal1 > 0 Then
								bOk = True
							End If
						
							lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
							lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
							
							If lVal1 = 1 And lVal2 = 1 Then
								bOk = True
							End If

							lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
							lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
							
							If lVal1 = 1 And lVal2 = 1 Then
								bOk = True
							End If

							// [VDOC8041]
							lVal1 = idw_LstwCommande.Find ( "STATUS_GC = 232 AND COD_ETAT IN ( 'CNV', 'ECT')", 1, idw_LstwCommande.RowCount() )															
							bOk = True
						
						

						CASE 500
							bOk = False
							sVar = "à régler"
							
							// Cas de contradiction possible [PC479]
							lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'PEC_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )
							lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount() )

								If lVal1 = 1 And lVal2 = lVal1 Then
									bOk = True
								End If
								
							// [RECUP_DONNEE_O2M][MANTIS3873]
							lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
							lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PAS_DE_COMMANDE' )", 1, idw_LstwCommande.RowCount() )																
							
							If lVal1 > 0 And lVal2 > 0 Then
								bOk = True
							End If
							// [RECUP_DONNEE_O2M][MANTIS3873]						

							// ITSM140744
							lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_RECUP_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
							If lVal1 > 0 Then
								bOk = True
							End If

							lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
							lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
							
							If lVal1 = 1 And lVal2 = 1 Then
								bOk = True
							End If
						
							lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
							lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
							
							If lVal1 = 1 And lVal2 = 1 Then
								bOk = True
							End If
							
							// [MANTIS8085] orange v3
							F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
							If lDeb > 0 Then
								lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND COD_ETAT IN ( 'CNV', 'ECT' )", 1, idw_LstwCommande.RowCount () ) 	
								If lVal1 > 0 Then
									bOk = TRUE
								End If
							End If

							// [VDOC8041]
							lVal1 = idw_LstwCommande.Find ( "STATUS_GC = 232 AND COD_ETAT IN ( 'CNV', 'ECT')", 1, idw_LstwCommande.RowCount() )															
							bOk = True

							
					END CHOOSE

					If Not bOk Then 
						stMessage.sVar[1] = "Une garantie ne peut être " + sVar + " alors que des " + sVar2 + " sont en cours."		
						Exit
					End If


					lRow = idw_wDetail.Find ( "ID_GTI = " + String ( lIdGti ) + "AND ID_DETAIL = " + String ( lIdDetail ), 1, idw_wDetail.RowCount ()  )

					// [PM103][1]
					If lRow > 0 And Not gbModeReprise_223 Then 
	
						lCodEtat = idw_wDetail.GetItemNumber ( lRow, "COD_ETAT" ) 

						CHOOSE CASE lCodEtat
							CASE 600
								bOk = False
								sVar = "clos réglé"

								// ITSM140744
								lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_RECUP_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
								If lVal1 > 0 Then
									bOk = True
								End If
								
								lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
								lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
								
								If lVal1 = 1 And lVal2 = 1 Then
									bOk = True
								End If
	
								lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
								lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
								
								If lVal1 = 1 And lVal2 = 1 Then
									bOk = True
								End If

								// [VDOC8041]
								lVal1 = idw_LstwCommande.Find ( "STATUS_GC = 232 AND COD_ETAT IN ( 'CNV', 'ECT')", 1, idw_LstwCommande.RowCount() )															
								bOk = True


							CASE 500
								bOk = False
								sVar = "à régler"

								lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
								lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
								
								If lVal1 = 1 And lVal2 = 1 Then
									bOk = True
								End If
	
								lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )								
								lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )																
								
								If lVal1 = 1 And lVal2 = 1 Then
									bOk = True
								End If


								// ITSM140744
								lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_RECUP_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )								
								If lVal1 > 0 Then
									bOk = True
								End If

								// [VDOC8041]
								lVal1 = idw_LstwCommande.Find ( "STATUS_GC = 232 AND COD_ETAT IN ( 'CNV', 'ECT')", 1, idw_LstwCommande.RowCount() )															
								bOk = True

						END CHOOSE

						If Not bOk Then 
							stMessage.sVar[1] = "Un détail ne peut être " + sVar + " alors que des " + sVar2 + "sont en cours."		
							Exit
						End If

					End If
				End If
			Next
		End If
	Next

	// [PC301].[LOT2] Contradiction pour Carrefour dans un Cas Particulier.
	If Not bOk Then
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 152 )
		If lCodEtatSin = 500 and lDeb > 0 Then
				lVal1 = idw_LstwCommande.Find ( "Id_FOUR IN ( 'CAR', 'CMA' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() )
				If lVal1 > 0 Then
					bOk = True
				End If
		End If
	End If	
	// [PC301].[LOT2]

End If 


If bOk And bCDiscount Then
	//   idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV' AND ID_TYP_ART = 'EDI'" ) // #21 [O2M_DIAG_NOMADE]
   idw_LstwCommande.SetFilter ( "ID_FOUR = 'CDS' AND COD_ETAT = 'CNV' AND ID_TYP_ART = 'EDI'" )
	idw_LstwCommande.Filter ( )

	If idw_LstwCommande.RowCount () > 0 Then 
		stMessage.sTitre		= "EDI C-Discount"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= Ok!
		stMessage.sVar[1]		= String ( idw_LstwCommande.RowCount () )
		stMessage.sCode		= "COMD420"
		F_Message ( stMessage )
	Else
		//idw_LstwCommande.SetFilter ( "COD_ETAT <> 'CNV' AND ID_TYP_ART = 'EDI'" ) // #21 [O2M_DIAG_NOMADE]
      idw_LstwCommande.SetFilter ( "ID_FOUR = 'CDS' AND COD_ETAT <> 'CNV' AND ID_TYP_ART = 'EDI'" )
		idw_LstwCommande.Filter ( )

// [PC474]
// Suite retour re recette de Michelle le 25/11, PV dans le PCC.
//		If idw_LstwCommande.RowCount () <= 0 Then 
//			stMessage.sTitre		= "EDI C-Discount"
//			stMessage.Icon			= Exclamation!
//			stMessage.bErreurG	= FALSE
//			stMessage.Bouton		= YesNo!
//			stMessage.sCode		= "COMD421"
//
//			If F_Message ( stMessage ) = 2 Then 
//				bOk = False
//				stMessage.sTitre		= "Commandes"
//				stMessage.Icon			= Information!
//				stMessage.bErreurG	= FALSE
//				stMessage.Bouton		= Ok!
//				stMessage.sCode		= "COMD422"
//			End If
//		End IF

	End If
End If 


// [VDOC10659]
If bOk Then	
	lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'WBA' AND COD_ETAT = 'CWE'", 1, idw_LstwCommande.RowCount ()) 		
	lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount ()) 				

	If lVal1 > 0 And lVal2 > 0 Then
		stMessage.sTitre		= "Commandes"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= YesNo!
		stMessage.sCode		= "WSIN752"
		If F_Message ( stMessage ) = 1 Then
			// Oui annule cmde Web auto
			idw_LstwCommande.SetItem ( lVal1, "COD_ETAT", "ANN" )
		Else 
			idw_LstwCommande.RowsDiscard ( lVal2, lVal2, Primary! )
		End If
		stMessage.sCode = ""
	End If
End If

//* #22 [DCMP090327].[SBETV]
//* #25 [MSS_DIAG]
// #14
If bOk Then
	// #19 [MOBISQUARE]
	// [PC514] Ajout de 'ACU'
	// [PC321] Ajout de 'SCR'
	// [PC10-2] Mantis4061 - Ajout de CVC
	// [ITSM170730] Ajout FPC
	// [PC13442-2] Ajout ATC
	idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'DEF', 'CWE', 'CNV', 'ECT') AND ID_FOUR NOT IN ( 'CDS', 'DTY', 'MBS', 'O2M', 'MCY', 'SB1', 'MS1','ACU','SCR','CVC','FPC','ATC')" )  
	idw_LstwCommande.Filter ()
	
	bAM2DIFFO2MEC = idw_LstwCommande.Rowcount() >= 2
	
	idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'DEF', 'CWE', 'CNV', 'ECT') AND ID_FOUR IN ('O2M', 'SB1', 'MS1')" )
	idw_LstwCommande.Filter ()
	
	bAM2O2MEC = idw_LstwCommande.Rowcount() >= 2

//* #17 [FNAC_PROD_ECH_TECH].[20090127140540720]
//* #27 [MSS_LOT2] ajout ACC
	idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'DEF', 'CWE', 'CNV', 'ECT') AND ID_FOUR IN ('O2M', 'MS1') AND ID_TYP_ART IN ( 'BAM', 'ALE', 'ACC', 'PCM' )" )
	idw_LstwCommande.Filter ()

	bBAMetALE = idw_LstwCommande.Rowcount() = 2

	idw_LstwCommande.SetFilter ( "" )
	idw_LstwCommande.Filter ( )
	
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'DEF', 'CWE', 'CNV', 'ECT') AND ID_FOUR IN ('O2M', 'SB1', 'MS1' ) AND ID_REF_FOUR IN ( 'PEC_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )
	//* #27 [MSS_LOT2] ajout ACC
   lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'DEF', 'CWE', 'CNV', 'ECT') AND ID_FOUR IN ('O2M', 'SB1', 'MS1' ) AND ID_TYP_ART IN ( 'BAM', 'ALE', 'ACC', 'PCM' )", 1, idw_LstwCommande.RowCount() )

	If lVal1 > 0 And lVal2 > 0 Then
		bCASPART = TRUE		
	End If

// [20100624141637603] Modif Véro 24/06 suite manuqe analyse
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'DEF', 'CWE', 'CNV', 'ECT') AND ID_FOUR IN ('O2M', 'SB1', 'MS1' ) AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP' )", 1, idw_LstwCommande.RowCount() )
	lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'DEF', 'CWE', 'CNV', 'ECT') AND ID_FOUR IN ('O2M', 'SB1', 'MS1' ) AND ID_REF_FOUR IN ( 'PAS_DE_COMMANDE' )", 1, idw_LstwCommande.RowCount() )
	If lVal1 > 0 And lVal2 > 0 Then
		bCASPART = TRUE		
	End If
// :[20100624141637603] 

	// [PM01]
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'DEF', 'CWE', 'CNV', 'ECT') AND ID_FOUR IN ('O2M', 'SB1', 'MS1' ) AND ID_REF_FOUR IN ( 'A_RECUP_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )
	If lVal1 > 0 Then
		bCASPART = TRUE		
	End If
	// :[PM01]
	
	// #27 [MSS_LOT2].[P7].[P10]		
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_FOUR IN ('MS1') AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'DOSSIER_A_CLORE' )", 1, idw_LstwCommande.RowCount() )
	lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT' ) AND ID_FOUR IN ('MS1') AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' )", 1, idw_LstwCommande.RowCount() )

	If lVal2 > 0 And lVal1 > 0 Then
		bCASPART = TRUE		
	End If
	// #27 [MSS_LOT2].[P7]	
	
//* :#17 [FNAC_PROD_ECH_TECH].[20090127140540720]	


	// #16 [DCMP080256][EEE_PC_ASUS]  
	// Gestion des cas particuliers faisant exception à la règle
	Choose Case This.uf_GestOng_Divers_Trouver( "TYPE_APP" )
		Case "PC3"
			idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'CNV', 'ECT') AND ID_FOUR IN ('CEG')" )
			idw_LstwCommande.Filter ()
			
			bCASPART = TRUE
			
	End Choose

//* #17 [FNAC_PROD_ECH_TECH].[20090127140540720]

	// #27 [MSS_LOT2].[P7].[P10]		
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_FOUR IN ('MS1') AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'DOSSIER_A_CLORE' )", 1, idw_LstwCommande.RowCount() )
	lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT' ) AND ID_FOUR IN ('MS1') AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' )", 1, idw_LstwCommande.RowCount() )
	
	If lVal2 > 0 And lVal1 > 0 Then
		bCASPART = TRUE		
	End If
	// #27 [MSS_LOT2].[P7]	


// [DT168]
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_DESOXYDER_FORCE' )", 1, idw_LstwCommande.RowCount() )
	lVal2 = idw_LstwCommande.Find ( "ID_TYP_ART = 'PRS' AND ID_REF_FOUR IN ( 'A_DESOXYDER' ) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount() )
	
	If lVal2 > 0 And lVal1 > 0 Then
		bCASPART = TRUE		
	End If
// [DT168]

// [PM82][LOT1]
	// [HP252_276_HUB_PRESTA]
	If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then	
		lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DIAG_FORCE' )", 1, idw_LstwCommande.RowCount() )
		lVal2 = idw_LstwCommande.Find ( "(( ID_TYP_ART = 'PRS' AND ID_REF_FOUR IN ( 'A_REPARER' )) OR ( ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 )) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount() )
	Else
		lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE' )", 1, idw_LstwCommande.RowCount() )
		lVal2 = idw_LstwCommande.Find ( "ID_TYP_ART = 'PRS' AND ID_REF_FOUR IN ( 'A_REPARER' ) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount() )
	End If 
	
	If lVal2 > 0 And lVal1 > 0 Then
		bCASPART = TRUE		
	End If
// [PM82][LOT1]


// [PC363_AUCHAN] 
// [PC292][AUCHAN] ajout SB1
// [BLCODE]
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_FOUR IN ('O2M', 'SB1', 'BLC') AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'PEC_A_RECYCLER' )", 1, idw_LstwCommande.RowCount() )
	lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_FOUR IN ('O2M', 'SB1', 'BLC') AND ID_REF_FOUR IN ( 'DECISION_SPB' )", 1, idw_LstwCommande.RowCount() )
	
	If lVal2 > 0 And lVal1 > 0 Then
		bCASPART = TRUE		
	End If
// :[PC363_AUCHAN]
// [BLCODE]

	// [PC292][AUCHAN]
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 179 )
	If lDeb > 0 Then
		// [ITSM329177]
		lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV', 'ECT' ) AND ID_FOUR IN ('SB1') AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' )", 1, idw_LstwCommande.RowCount() )		
		lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV', 'ECT' ) AND ID_FOUR IN ('O2M') AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' )", 1, idw_LstwCommande.RowCount() )

		If lVal2 > 0 And lVal1 > 0 Then
			bCASPART = TRUE		
		End If

	  lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'SB1' AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' ) AND COD_ETAT IN ( 'RFO' )", 1, idw_LstwCommande.RowCount () ) 
     lVal2 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' ) AND COD_ETAT IN ( 'ECT' )", 1, idw_LstwCommande.RowCount () ) 
	  lVal3 = idw_LstwCommande.Find ( "ID_FOUR = 'SB1' AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'PEC_A_RECYCLER' ) AND COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount () ) 
	  
		If lVal2 > 0 And lVal1 > 0 And lVal3 > 0 Then
			bCASPART = TRUE		
		End If

	End If
	// :[PC292][AUCHAN]
	
	// [RECUP_DONNEE_O2M][MANTIS3016]
	// [MANTIS3016]
	lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_REF_FOUR IN ( 'PEC_A_RECYCLER' ) AND COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount () ) 
	lVal2 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_TYP_ART IN ( 'TEL' ) AND COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount () ) 	

	If lVal1 > 0 And lVal2 > 0 Then
		bCASPART = TRUE
	End If
	// [MANTIS3016]
	
	// [MANTIS3204]
	lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_REF_FOUR IN ( 'PEC_A_RECYCLER' ) AND COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount () ) 
	lVal2 = idw_LstwCommande.Find ( "ID_FOUR <> 'O2M' AND ID_TYP_ART IN ( 'TEL' ) AND COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount () ) 	
	lVal3 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_REF_FOUR IN ( 'CMDE_AUT_ACC' ) AND COD_ETAT IN ( 'CNV' )", 1, idw_LstwCommande.RowCount () ) 

	If lVal1 > 0 And lVal2 > 0 And lVal3 > 0 Then
		bCASPART = TRUE
	End If
	// [MANTIS3204]

	// PC938_ORANGE_V3
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
	If lDeb > 0 Then
		lVal2 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_TYP_ART IN ( 'PST' ) AND COD_ETAT IN ( 'CNV', 'ECT' )", 1, idw_LstwCommande.RowCount () ) 	
		lVal3 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_TYP_ART IN ( 'PRS' )  AND COD_ETAT IN ( 'CNV', 'ECT' )", 1, idw_LstwCommande.RowCount () ) 

		If lVal2 > 0 And lVal3 > 0 Then
			bCASPART = TRUE
		End If

		lVal2 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_TYP_ART IN ( 'EDI' ) AND COD_ETAT IN ( 'CNV', 'ECT' )", 1, idw_LstwCommande.RowCount () ) 	
		lVal3 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_TYP_ART NOT IN ( 'EDI', 'PRS' )  AND COD_ETAT IN ( 'CNV', 'ECT' )", 1, idw_LstwCommande.RowCount () ) 

		If lVal2 > 0 And lVal3 > 0 Then
			bCASPART = TRUE
		End If
	End If		
		
	// [RECUPDONN_MANTIS4252]
	lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_TYP_ART IN ( 'TEL' ) AND COD_ETAT IN ( 'ECT' )", 1, idw_LstwCommande.RowCount () ) 	
	lVal2 = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND ID_REF_FOUR IN ( 'PEC_A_RECYCLER' ) AND COD_ETAT IN ( 'ECT' )", 1, idw_LstwCommande.RowCount () ) 
	
	If lVal1 > 0 And lVal2 > 0  Then
		bCASPART = TRUE
	End If
	// [RECUPDONN_MANTIS4252]
	// [RECUP_DONNEE_O2M]

	// [PC884_MANTIS6493]
	idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'CNV')" )
	idw_LstwCommande.Filter ()
	lVal1 = idw_LstwCommande.RowCount()

	idw_LstwCommande.SetFilter ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER', 'REFUS_A_REEXPEDIER' ) AND COD_ETAT IN ( 'CNV' )" )
	idw_LstwCommande.Filter ()
	lVal2 = idw_LstwCommande.RowCount()

	If lVal1 = 2 And lVal2 = 1  Then
		bCASPART = TRUE
	End If
	// :[PC884_MANTIS6493]		

	// [PC938_ORANGE_V3]
	idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'CNV', 'ECT')" )
	idw_LstwCommande.Filter ()
	lVal1 = idw_LstwCommande.RowCount()

	idw_LstwCommande.SetFilter ( "ID_TYP_ART IN ( 'RES' ) AND COD_ETAT IN ( 'CNV' )" )
	idw_LstwCommande.Filter ()
	lVal2 = idw_LstwCommande.RowCount()

	If lVal1 = 2 And lVal2 = 1  Then
		bCASPART = TRUE
	End If
	// [PC938_ORANGE_V3]

	// [PC938_ORANGE_V3]
	// PC938_ORV3_M8086
	idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'CNV', 'ECT')" )
	idw_LstwCommande.Filter ()
	lVal1 = idw_LstwCommande.RowCount()

	idw_LstwCommande.SetFilter ( "ID_TYP_ART IN ( 'REA' ) AND COD_ETAT IN ( 'CNV' )" )
	idw_LstwCommande.Filter ()
	lVal2 = idw_LstwCommande.RowCount()

	If lVal1 = 2 And lVal2 = 1  Then
		bCASPART = TRUE
	End If
	// [PC938_ORANGE_V3]

	// [DT081_EVOL_PRET_BRIS]
	idw_LstwCommande.SetFilter ( "COD_ETAT IN ( 'CNV', 'ECT')" )
	idw_LstwCommande.Filter ()
	lVal1 = idw_LstwCommande.RowCount()

	idw_LstwCommande.SetFilter ( "ID_TYP_ART IN ( 'PST' ) AND COD_ETAT IN ( 'CNV', 'ECT' )" )
	idw_LstwCommande.Filter ()
	lVal2 = idw_LstwCommande.RowCount()

	If lVal1 = 2 And lVal2 = 1  Then
		bCASPART = TRUE
	End If
	// [DT081_EVOL_PRET_BRIS]

	
	// [PC786-1_AUCHAN_GEM]
	idw_LstwCommande.SetFilter ( "" )
	idw_LstwCommande.Filter ()

	lVal1 = idw_LstwCommande.Find ( "ID_FOUR = 'AUC' AND ID_TYP_ART = 'CAF' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount ()) 
	lVal2 = idw_LstwCommande.Find ( "ID_FOUR = 'AUC' AND ID_TYP_ART = 'CAF' AND COD_ETAT = 'CNV' AND ID_GTI = 52", 1, idw_LstwCommande.RowCount ()) 
	lVal3 = idw_LstwCommande.Find ( "ID_FOUR = 'AUC' AND ID_TYP_ART = 'CAF' AND COD_ETAT = 'CNV' AND ID_GTI <> 52", 1, idw_LstwCommande.RowCount ()) 

	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 140 )		
	If lDeb > 0 Then
		sVal=lnvPFCString.of_getkeyvalue( idw_DetPro.GetItemString(lDeb, "VAL_CAR"), "TYPE", ";")
		
		If sVal = "GEM" And lVal1 > 0 And lVal2 > 0 And lVal3 > 0 Then
			bCASPART = TRUE
		End If
	End If		

	// [PM445-1]
	idw_LstwCommande.SetFilter ( "ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER', 'A_DIAGNOSTIQUER' ) AND COD_ETAT IN ( 'ECT')" )
	idw_LstwCommande.Filter ()
	lVal1 = idw_LstwCommande.RowCount()

	idw_LstwCommande.SetFilter ( "ID_REF_FOUR IN ( 'NE_PAS_REMPLACER' ) AND COD_ETAT IN ( 'CNV' )" )
	idw_LstwCommande.Filter ()
	lVal2 = idw_LstwCommande.RowCount()

	idw_LstwCommande.SetFilter ( "ID_REF_FOUR IN ( 'A_REMPLACER' ) AND COD_ETAT IN ( 'CNV' )" )
	idw_LstwCommande.Filter ()
	lVal3 = idw_LstwCommande.RowCount()

	If lVal1 = 1 And ( lVal2 = 1  Or lVal3 = 1 ) Then
		bCASPART = TRUE
	End If	

	// [HP252_276_HUB_PRESTA]
	If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
		idw_LstwCommande.SetFilter ( "POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'ANN', 'RFO', 'RPC') AND STATUS_GC = 232" )
		idw_LstwCommande.Filter ()
		lVal1 = idw_LstwCommande.RowCount()
		
		idw_LstwCommande.SetFilter ( "POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND ID_REF_FOUR IN ( 'CODE_VERROU' ) AND COD_ETAT IN ( 'CNV' )" )
		idw_LstwCommande.Filter ()
		lVal2 = idw_LstwCommande.RowCount()		
		
		If lVal1 = 1 And lVal2 = 1  Then
			bCASPART = TRUE
		End If 
	End If
		

//* #20 [CAMARA].[PRESTA_WEB_BOUTIQUE]
// [WEBSIM2].[FRANCE]
	If bBAMetALE Or bWBBetSMS or bWBBetCAF Then bCASPART = TRUE
	
	If ( bAM2DIFFO2MEC Or bAM2O2MEC ) AND NOT bCASPART Then // #16 [DCMP080256][EEE_PC_ASUS] 
		stMessage.sVar[1] = "Vous ne pouvez pas avoir deux commandes en cours."
		bOk = FALSE
	End If
	
	idw_LstwCommande.SetFilter ( "" )
	idw_LstwCommande.Filter ( )
	idw_LstwCommande.Sort ()
	bCASPART = False
End If
// :#14


// #23 [DCMP090421]
If bOk Then
	// [PC973].Mantis 9420 Ajout du process 952
	// [DT191][V3]
	
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND INFO_SPB_FRN IN ( 907, 912, 937, 942, 952, 981, 982, 983, 2141, 2142, 2143 )", 1, idw_LstwCommande.RowCount() )
	
   lVal2 = idw_LstInter.Find ( "COD_INTER = 'A' AND LEN ( TRIM ( ADR_MAIL ) ) > 0", 1, idw_LstInter.RowCount() )
	
	// [VDOC6507]
	lVal3 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_FOUR IN ('O2M', 'BLC')", 1, idw_LstwCommande.RowCount() )		

	// Manque le mail sur l'assuré
	If lVal1 > 0 And lVal2 <= 0 Then
		bOk = False
		stMessage.sTitre		= "Commandes"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= Ok!
		stMessage.sCode		= "COMD567"
	// On complète la commande par l'adresse mail.
	// [VDOC6507]
	ElseIf lVal2 > 0 And ( lVal1 > 0 Or lVal3 > 0 ) Then
		sVar  = Trim ( idw_LstInter.GetItemString ( lVal2, "ADR_MAIL" ))
		
		If lVal3 > 0 And lVal1 <= 0 Then lVal1 = lVal3

		sVar2 = Trim ( idw_LstwCommande.GetItemString ( lVal1, "INFO_SPB_FRN_CPLT" ) )
		
		lnvPFCString.of_Setkeyvalue ( sVar2, "MAIL_ASSURE", sVar, ";")
		idw_LstwCommande.SetItem ( lVal1, "INFO_SPB_FRN_CPLT", sVar2 )
	End If
	
End If
// :#23 [DCMP090421]

// #27 [MSS_LOT2].[P7].[10]
If bOk Then
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND ID_FOUR IN ('MS1') AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'DOSSIER_A_CLORE' )", 1, idw_LstwCommande.RowCount() )
	lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT' ) AND ID_FOUR IN ('MS1') AND ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER' )", 1, idw_LstwCommande.RowCount() )
	
	If lVal2 > 0 And lVal1 > 0 Then
		idw_LstwCommande.SetItem ( lVal2, "COD_ETAT", "RFO" )
	End If
End If
// #27 [MSS_LOT2].[P7].[10] 

// [PC321]
If bOk Then
lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT' ) AND ID_FOUR IN ('SCR') AND INFO_SPB_FRN IN (1425,1426,1450)", 1, idw_LstwCommande.RowCount() )
	
	If lVal1 > 0 Then
		idw_LstwCommande.SetItem ( lVal2, "COD_ETAT", "RPC" )
	End If
End If
// :[PC321]

// [RECUP_DONNEE_O2M]
If bOk Then
	lVal1 = idw_LstwCommande.find("ID_FOUR IN ('O2M') AND ID_REF_FOUR = 'DONNEES_A_RECUPERER' AND COD_ETAT <> 'ANN'",1,  idw_LstwCommande.rowCount()+1 )
	lVal2 = idw_LstwCommande.find("ID_FOUR IN ('O2M') AND ID_REF_FOUR <> 'DONNEES_A_RECUPERER' AND ID_TYP_ART = 'EDI' AND COD_ETAT <> 'ANN'",1,  idw_LstwCommande.rowCount()+1 )
	
	If lVal1 > 0 And lVal2 > 0 Then
		sTitreCplt = "Contrôle Prestation"
		stMessage.sVar[1] = "La prestation DONNEES_A_RECUPERER ne doit être suivi d'aucun autre ordre vers O2M."
		bOk = FALSE
	End If
	
End If
// :[RECUP_DONNEE_O2M]

// [RECUP_DONNEE_O2M][MANTIS3873]
If bOk Then
	lVal2 = idw_LstwCommande.Find ( "(ID_REF_FOUR = 'A_DIAGNOSTIQUER' OR (ID_TYP_ART = 'PRS' AND STATUS_GC = 21 )) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
	If lVal2 > 0 Then
		sVal1 = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( lVal2, "INFO_SPB_FRN_CPLT" ), "RECUP_DONNEES", ";")
		sVal2 = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( lVal2, "INFO_FRN_SPB_CPLT" ), "CGU_PRESENT", ";")
	End If		
	lVal3 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'PAS_DE_COMMANDE' AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
	lVal4 = idw_wDetail.Find ( "ID_EVT = 845 AND ID_GTI <> 8 AND MT_PLAF > 0 AND ID_I_REG = 0 AND COD_ETAT = 500", 1, idw_wDetail.RowCount () )	

	If sVal1 = "OUI" And sVal2 = "OUI" And lVal3 <=0 And lVal4 > 0 Then
			sTitreCplt = "Contrôle Prestation"
			stMessage.sVar[1] = "Votre cas induit la création automatique par le système d'une prestation << PAS_DE_COMMANDE >> vers O2M, afin de les prévenir qu'il n'y aura pas de commande à venir puisque l'on rembourse l'assuré."
			bOk = FALSE
			lIdSeqMax = Long ( idw_LstwCommande.Describe( "Evaluate('Max ( id_seq )', 0)" )) 
			
			idw_LstwCommande.RowsCopy ( lVal2, lVal2, Primary!, idw_LstwCommande, 1, Primary!)
			
			lIdSeqMax += 1 
			
			idw_LstwCommande.SetItem ( 1, "ID_SEQ", lIdSeqMax )
			idw_LstwCommande.SetItem ( 1, "ID_TYP_ART", "PCM" )
			idw_LstwCommande.SetItem ( 1, "ID_MARQ_ART", "PAS DE COMMANDE D'ACCESSOIRE" )
			idw_LstwCommande.SetItem ( 1, "PROBLEME", "" )
			idw_LstwCommande.SetItem ( 1, "DTE_RCP_FRN", stNul.dtm )
			idw_LstwCommande.SetItem ( 1, "DTE_ENV_CLI", stNul.dtm )
			idw_LstwCommande.SetItem ( 1, "COD_ETAT", "CNV" )
			idw_LstwCommande.SetItem ( 1, "CPT_VALIDE", 0 )
			idw_LstwCommande.SetItem ( 1, "CREE_LE", DateTime ( Today (), Now ()) )
			idw_LstwCommande.SetItem ( 1, "MAJ_LE", DateTime ( Today (), Now ()) )
			idw_LstwCommande.SetItem ( 1, "ID_REF_FOUR", "PAS_DE_COMMANDE" )
			idw_LstwCommande.SetItem ( 1, "ID_ORIAN_MODELE", 0 )			
			idw_LstwCommande.SetItem ( 1, "STATUS_GC", 0 )			
			idw_LstwCommande.SetItem ( 1, "INFO_SPB_FRN", stNul.str )			
			idw_LstwCommande.SetItem ( 1, "ID_MARQ_ART_IFR", "PAS DE COMMANDE D'ACCESSOIRE" )						
			idw_LstwCommande.SetItem ( 1, "INFO_SPB_FRN_CPLT", "" )									
			idw_LstwCommande.SetItem ( 1, "INFO_FRN_SPB_CPLT", "" )												
			
	End IF
End If
// [RECUP_DONNEE_O2M][MANTIS3873]

// [VDOC6381]
If bOk Then
	lVal1 = idw_LstwCommande.find("INFO_SPB_FRN=964",1,  idw_LstwCommande.rowCount()+1 )
	If lVal1 > 0 Then
		sVal1	= idw_LstwCommande.GetItemString ( lVal1, "ID_FOUR" )
		lVal1 = idw_LstwCommande.find("ID_REF_FOUR='PEC_A_RECYCLER' AND ID_FOUR='" + sVal1 + "'",1,  idw_LstwCommande.rowCount()+1 )
		If lVal1 > 0 Then
			sTitreCplt = "Contrôle Prestation"
			stMessage.sVar[1] = "La PEC_A_RECYCLER est interdite sur un fournisseur ayant eu un process 964 <<Pas de diag.Attente RetSBE pr propo>> sur une prestation de type A_DIAGNOSTIQUER"
			bOk = FALSE
		End If 
	End If
End IF
// :[VDOC6381]

//[VDOC9235]
If bOk Then
	lVal1 = idw_LstwCommande.find("ID_REF_FOUR='PEC_A_RECYCLER' AND COD_ETAT = 'CNV'",1,  idw_LstwCommande.rowCount()+1 )
	lVal2 = idw_LstwCommande.find("STATUS_GC IN ( 152, 153, 154, 155, 170 ) AND COD_ETAT <> 'ANN'",1,  idw_LstwCommande.rowCount()+1 )
	
	If lVal1 > 0 And lVal2 > 0 Then
		stMessage.sTitre  	= "Controle de gestion des commandes"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= YESNO!
		stMessage.sCode = "COMD750"		
	
		If F_Message ( stMessage ) = 2 Then
			bOk = False
			stMessage.sCode = "COMD751"			
		End If
	End IF
End If
// :[VDOC9235]

//[VDOC9390]
If bOk Then
	idw_LstwCommande.SetFilter ( "ID_REF_FOUR='A_DIAGNOSTIQUER' AND COD_ETAT <> 'ANN'" )
	idw_LstwCommande.Filter ()
	lVal1 = idw_LstwCommande.RowCount ()
	
	idw_LstwCommande.SetFilter ( "ID_REF_FOUR='PEC_A_RECYCLER' AND COD_ETAT <> 'ANN'" )
	idw_LstwCommande.Filter ()
	lVal2 = idw_LstwCommande.RowCount ()

	idw_LstwCommande.SetFilter ( "ID_REF_FOUR='REFUSE_A_REEXP' AND COD_ETAT <> 'ANN'" )
	idw_LstwCommande.Filter ()
	lVal3 = idw_LstwCommande.RowCount ()
	
	// [ITSM147188][20250228130407143][20250416135954333]
	idw_LstwCommande.SetFilter ( "ID_TYP_ART = 'PRS' AND COD_ETAT <> 'ANN' AND ( POS ( INFO_FRN_SPB_CPLT, 'RETOUR_153=OUI') > 0 OR POS ( INFO_FRN_SPB_CPLT, 'RETOUR_154=OUI') > 0 OR ( POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND ( POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI') > 0 OR POS ( INFO_FRN_SPB_CPLT, 'RETOUR_305=OUI') > 0 )))" )
	idw_LstwCommande.Filter ()
	lVal4 = idw_LstwCommande.RowCount ()

	// [PM330-1]
	idw_LstwCommande.SetFilter ( "ID_TYP_ART = 'PRS' AND COD_ETAT <> 'ANN' AND ( STATUS_GC IN ( 21, 23 ) OR ( STATUS_GC = 169 AND ID_FOUR = 'COR' ))" )
	idw_LstwCommande.Filter ()
	lVal5 = idw_LstwCommande.RowCount ()
	lVal1 += lVal5
	
	
	// [PM280-2]
	idw_LstwCommande.SetFilter ( "ID_REF_FOUR = 'CONTEST_SUR_REMPL' AND COD_ETAT <> 'ANN'" )
	idw_LstwCommande.Filter ()
	lVal5 = idw_LstwCommande.RowCount ()
	lVal1 += lVal5

	// [DT288-1][MODIF_CHRISTINE]
	lVal6 = 0
	idw_LstwCommande.SetFilter ( "STATUS_GC = 310 AND COD_ETAT <> 'ANN'" )
	idw_LstwCommande.Filter ()
	lVal6 = idw_LstwCommande.RowCount ()
	
	If lVal2 > lVal1 Then
		sTitreCplt = "(vDoc9390) Contrôle Prestation"
		stMessage.sVar[1] = "Il ne peut pas y avoir plus de prestations PEC_A_RECYCLER que de prestations A_DIAGNOSTIQUER"
		bOk = FALSE
	End If

	// [DT288-1][MODIF_CHRISTINE]
	If lVal3 > lVal1 And lVal4 <=0 And lVal6 <= 0 Then
		sTitreCplt = "(vDoc9390) Contrôle Prestation"
		stMessage.sVar[1] = "Il ne peut pas y avoir plus de prestations REFUSE_A_REEXP que de prestations A_DIAGNOSTIQUER"
		
		bCASPART = FALSE

		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 235 )
		If lDeb > 0 Then
			If lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "TVSUP32P", ";") = "OUI" Then

				Choose Case This.uf_GestOng_Divers_Trouver( "TYPE_APP" )
					Case "TL7", "TLO", "TPS"
					
						bCASPART = TRUE
						
				End Choose
			End If
		End If
		
		If Not bCASPART Then
			bOk = FALSE
		End If
		
	End If

	idw_LstwCommande.SetFilter ( "" )
	idw_LstwCommande.Filter ()
	
	// On ne mettais à jour le message dans ce if, mais pas le code. 
	// => si message auparavant (ex : VDOC9235), le même apparait en sortie de fonction
	If not bOk Then 
		stmessage.sCode="GENE013"
		stMessage.berreurg=FALSE // [ITSM320948] 
	End if
End If	
//[VDOC9390]

// [2EME_PRESTA_SAV]
If bOk Then	
	lVal1 = idw_LstwCommande.find("ID_TYP_ART = 'PRS' AND COD_ETAT = 'CNV'",1,  idw_LstwCommande.rowCount()+1 )	
	If lVal1 > 0 Then
		sVal1 = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( lVal1, "INFO_SPB_FRN_CPLT" ), "CHG_FRN_2EME_PRS_SAV", ";")
		If sVal1 = "OUI" Then
			lRow = idw_LstInter.Find ("COD_INTER = 'A'" , 1 , lTotInt )
			If lRow > 0 Then
				idw_LstInter.SetItem ( 1, "ADR_MAIL_NAME", stNul.str )
				idw_LstInter.SetItem ( 1, "ADR_MAIL_DOMAIN", stNul.str )				
				idw_LstInter.SetItem ( 1, "ADR_MAIL", stNul.str )				
			End If 
			idw_WSin.SetItem ( 1, "ALT_EDIT" , "N" )
			stMessage.sTitre  	= "2ème Presta SAV particulière"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= Ok!
			stMessage.sCode = "COMD770"
			F_Message ( stMessage )
			stMessage.sCode = ""
		End If
	End If
End If
// [2EME_PRESTA_SAV]

// [ITSM222849] - ctl commande de diag sans PEC coché
If bOk Then
	idw_LstwCommande.SetFilter ( "ID_REF_FOUR='A_DIAGNOSTIQUER' AND COD_ETAT = 'CNV'" )
	idw_LstwCommande.Filter ()
	
	if idw_lstwcommande.RowCount() > 0 Then
	
		For lRow=1 to idw_lstwcommande.RowCount() 
			sVar="ID_GTI=" + String(idw_lstwcommande.GetItemNumber(lRow,"ID_GTI") )
			sVar+=" And ID_DETAIL=" + String(idw_lstwcommande.GetItemNumber(lRow,"ID_DETAIL") )
			sVar+=" And Upper(NOM_ZONE) = 'PEC' AND VAL_CAR='N'"

			if idw_wdivdet.Find(sVar,1,idw_wdivdet.RowCount()) > 0 Then
				
				bOk=FALSE
				
				stMessage.sTitre  	= "PEC non cochée"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= Ok!
				stMessage.sCode = "COMD876"
			End if
		Next
		
	End if

	idw_LstwCommande.SetFilter ( "" )
	idw_LstwCommande.Filter ( )
	idw_LstwCommande.Sort ()
	
End if
// :[ITSM222849]

// [VDOC15472]
If bOk Then
	lRow = idw_wDetail.Find ( "ID_EVT = 1396 AND CPT_VALIDE = 0", 1, idw_wDetail.RowCount ()  )	
	If lRow > 0 Then
		lVal1= idw_LstwCommande.Find ( "ID_GTI = " + String ( idw_wDetail.GetItemNumber ( lRow, "ID_GTI")) + " AND " + &
												 "ID_DETAIL = " + String ( idw_wDetail.GetItemNumber ( lRow, "ID_DETAIL")) + " AND " + &
												 "ID_TYP_ART = 'PST'", &
												1, idw_LstwCommande.rowCount())	
		If lVal1 <= 0 Then
			bOk=FALSE
			stMessage.sTitre  	= "PEC non cochée"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= Ok!
			stMessage.sCode = "COMD882"			
		End If
	End If
End If
// :[VDOC15472]

// [ITSM295258]
If bOk Then
	lVal1 = idw_LstwCommande.Find ( "ID_TYP_ART = 'PST' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.Rowcount() )
	lVal2 = idw_LstwCommande.Find ( "ID_TYP_ART = 'PRS' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.Rowcount() )
	
	If lVal1 > 0 And lVal2 <= 0 Then				
		bOk=FALSE
		
		stMessage.sTitre  	= "Presta réparation absente"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= Ok!
		stMessage.sCode = "COMD912"
	End if
End If
// :[ITSM295258]

// [PM280-2]
If bOk Then 
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_REF_FOUR = 'A_REPARER' AND POS ( INFO_SPB_FRN_CPLT, 'A_REP_GARANTIE=OUI' ) > 0", 1, idw_LstwCommande.rowCount()+1 )
	lVal2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_REF_FOUR = 'CONTEST_SUR_REMPL'", 1, idw_LstwCommande.rowCount()+1 )
	
	If lVal1 > 0 And lVal2 > 0 Then
		stMessage.sVar[1] = "Il est interdit de contester le remplacement et dans le même temps de demander une réparation sur ce remplacement."
		bOk = FALSE
	End If 
	
	lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'CONTEST_SUR_REMPL' AND COD_ETAT IN ( 'RPC', 'RFO' )", 1, idw_LstwCommande.rowCount()+1 )	
	lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'PEC_A_RECYCLER', 'REFUSE_A_REEXP' ) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.rowCount()+1 )	

	If lVal1 > 0 And ( lVal2 <=0 Or lVal2 > lVal1 ) Then
		stMessage.sVar[1] = "La prestation de contestation est fermée et doit donc être suivie d'une prestation PEC_A_RECYCLER ou REFUSE_A_REEXP."
		bOk = FALSE
	End If
End If 	


// [DT288]
// [BUG_IPHONE_DESOX]
// [DT361]
If bOk Then
	lVal1 = idw_LstwCommande.Find ( "POS ( ID_REF_FOUR, 'A_DESOXYDER' ) > 0 AND COD_ETAT = 'CNV' AND ID_FOUR NOT IN ( 'PSM', 'COR', 'CEA' )", 1, idw_LstwCommande.rowCount()+1 )	
	If lVal1 > 0 Then
		stMessage.sVar[1] = "L'action A_DESOXYDER n'est pas autorisée pour ce fournisseur, revoyez votre saisie."
		bOk = FALSE
	End If 
End If

// [MCO602_PNEU] à Supp plus tard
If NOT F_CLE_A_TRUE ( "MCO602_PNEU" ) Then
	// [DT227]
	If bOk Then	
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 299 )	
		If lDeb > 0 Then
			// JFF 07/06/2016 [DT227]
			SQLCA.PS_S_DATE_PIVOT ( "DT227", dtDt1, dtDt2, dtDt3 ) 
	
			// [DT227][V3]			
			lVal2 = 	idw_wDetail.Find ( "ID_EVT = 940 AND MT_PLAF >0", 1, idw_wDetail.RowCount ())
			
			Choose Case lCodEtatSin 
				Case 100, 550, 600
					// [DT227][V3]
					If dtCreeLe >= dtDt1 And lVal2 <= 0 Then
						lVal1 = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.rowCount()+1 )	
						If lVal1 <= 0 Then
							stMessage.sTitre  	= "Leclerc Pneu"
							stMessage.Icon			= Exclamation!
							stMessage.bErreurG	= FALSE
							stMessage.Bouton		= YesNo!
							stMessage.sCode = "WSIN804"
							If F_Message (stMessage) = 2 Then
								bOk = False
								stMessage.sCode = ""
								stMessage.sVar[1] = "==> Créez une prestation de réparation ou de remplacement."
							End If
							
						End If	
					End If
			End Choose		
		End If 
	End If
End If 

// [BUG_C_BAILLY]
lVal1 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1 )	
lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER' ) AND COD_ETAT <> 'ANN' AND STATUS_GC IN ( 153, 154)", 1, idw_LstwCommande.rowCount()+1 )	
If lVal1 > 0 Then
	lVal3 = idw_wDetail.Find ( "ID_GTI = " + String ( idw_LstwCommande.GetItemNumber ( lVal1, "ID_GTI" ) ) + " AND ID_DETAIL = " + String ( idw_LstwCommande.GetItemNumber ( lVal1, "ID_DETAIL" )), 1, idw_wDetail.RowCount () )
	If lVal3 > 0 Then
		lVal4 = idw_wDetail.GetItemNumber ( lVal3, "ID_EVT" ) 
	End If
End If

If lVal1 > 0 And lVal2 > 0 And lVal4 = 1083 Then
	stMessage.sVar[1] = "Le flux A_REPARER_FORCE ou REFUSE_A_REEXP lié à une réparation ne peut être passer sur un évènement Diag/Broker. Passez le sur le détail d'origine de réparation en mode << informer >>."
	bOk = FALSE
End IF

// |BUG_SAL]
if bOk Then
	lVal1= idw_LstwCommande.Find ( "ID_FOUR IN ( 'DST','DTY' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1 )	
	lVal2=idw_wsin.GetItemNumber(1,"ID_ORIAN_BOUTIQUE")
	
	if lVal1 > 0 and isNull(lVal2) Then
		stMessage.sVar[1] = "Veuillez renseigner le code boutique sur l'onglet Sinistre."
		bOk = FALSE
	End if
End if

If Not bOk And stMessage.sCode = "" Then
	stMessage.sTitre  	= "Controle de gestion des commandes" + sTitreCplt
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= Ok!
	stMessage.sCode = "COMD023"		
End If

// [20250730153200137]
If bOk Then
	lVal1 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'CNV' ) AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP' )", 1, idw_LstwCommande.RowCount() )
	lVal2 = idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT' ) AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND ID_REF_FOUR IN ( 'A_REPARER', 'A_DIAGNOSTIQUER' ) and status_gc in ( 153, 154, 169, 305 )", 1, idw_LstwCommande.RowCount() )
	
	If lVal2 > 0 And lVal1 > 0 Then
		idw_LstwCommande.SetItem ( lVal2, "COD_ETAT", "RFO" )
	End If
End If
// [20250730153200137]


If Not bOk Then sPos = "ALT_BLOC" 


idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ( )
idw_LstwCommande.Sort ()


Return sPos

end function

private subroutine uf_tb_telephonie ();//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::uf_Tb_Telephonie		 (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 17/07/2002 09:31:39
//* Libellé			: 
//* Commentaires	: On s'occupe de l'apparition des zones de téléphonie
//*
//* Arguments		: (Aucun)
//*
//* Retourne		: (Rien)
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//* #1	 CAG	 08/11/2002	  La zone id_orian_boutique devient saisissable
//*								  si cod_adh <> 1 et 6 => gestion de la zone
//* #2	 JFF	 11/06/2004   DCMP 040246 : ALT_EDIT visible pour tout le monde
//* #3	 PHG   13/09/2007	  [DCMP070455] : Altedit controlé par option DP/88
//        JFF   23/05/2012   [PM103][1]
//*-----------------------------------------------------------------

String sCol[], sAltCodBout
Long lCodTel
Long lDeb, lFin // #3	[DCMP070455]

/*------------------------------------------------------------------*/
/* Pour la téléphonien, on rend visible la zone ALT_EDIT. Cela      */
/* permet au gestionnaire de choisir de ne pas éditer de courrier.  */
/* En fonction, du type d'arrivée (COURRIER ou TELEPHONE) on coche  */
/* ou non la zone.                                                  */
/*------------------------------------------------------------------*/

// #3	[DCMP070455]
// Du fait de la réorganiastion des département, on offre la possibilité d'avoir
// un paramétrage/produit pour activer l'edition ou pas. ( valeur val_car de 
// L'option DP 88 ). Si pas d'option DP, ancien algorithme de détermination de Alt_edit
// executé.

F_RechDetPro(lDeb, lFin, idw_detpro, idw_wsin.object.id_prod[1], '-DP', 88)
If lDeb > 0 Then
	idw_wSin.object.alt_edit.visible = 1
	idw_wSin.object.alt_edit[1] = trim(idw_detpro.object.val_car[lDeb])
Else
	
	If ibAltTelephonie Then
	/*------------------------------------------------------------------*/
	/* Travail créé par Courrier.                                       */
	/*------------------------------------------------------------------*/
	
		If isCodRecu = "C" Then 
			idw_wSin.Modify ( "ALT_EDIT.visible = 1" )
			idw_wSin.SetItem ( 1, "ALT_EDIT", "O" )
	
	/*------------------------------------------------------------------*/
	/* Travail créé par Téléphone.                                      */
	/*------------------------------------------------------------------*/
		Else
			idw_wSin.Modify ( "ALT_EDIT.visible = 1" )
			idw_wSin.SetItem ( 1, "ALT_EDIT", "N" )
		End If
	Else
	/*------------------------------------------------------------------*/
	/* On n'est pas en téléphonie, la zone est invisible. L'edition     */
	/* est obligatoire.                                                 */
	/*------------------------------------------------------------------*/
	/* #2 : Sur demande de MSE, rendre toujours visible la zone ALT_EDIT*/
	/*------------------------------------------------------------------*/	
		idw_wSin.Modify ( "ALT_EDIT.visible = 1" )
		idw_wSin.SetItem ( 1, "ALT_EDIT", "O" )
	End If
End If // Fin #3

// [PM103][1]
If gbModeReprise_223 Then
	idw_wSin.SetItem ( 1, "ALT_EDIT", "N" )
End If


/*------------------------------------------------------------------*/
/* On s'occupe de rendre les zones saisissables ou non.             */
/*------------------------------------------------------------------*/
sCol [ 1 ] = "NUM_PORT"
sCol [ 2 ] = "NUM_IMEI_PORT"
sCol [ 3 ] = "MARQ_PORT"
sCol [ 4 ] = "MODL_PORT"
sCol [ 5 ] = "DTE_ACH_PORT"

lCodTel = idw_Produit.GetItemNumber ( 1, "COD_TEL" )
/*------------------------------------------------------------------*/
/* # Modification SFR # Le 17/07/2002.                              */
/*------------------------------------------------------------------*/
If ibAltTelephonie Then
	Choose Case lCodTel
/*------------------------------------------------------------------*/
/* Les zones de téléphonie proviennent de la base adhésion.         */
/* La	date d'achat et la date d'ouverture de ligne sont identiques. */
/*------------------------------------------------------------------*/
	Case 1
		idw_wSin.ilDernCol = 61

		idw_wSin.Uf_Proteger ( sCol, "0" )
		idw_wSin.Uf_Proteger ( { "DTE_OUVLIG_PORT" }, "0" )

/*------------------------------------------------------------------*/
/* Les zones de téléhonie ne sont pas issues de la base adhésion.   */
/* La date d'achat et la date d'ouverture de ligne ne sont pas      */
/* identiques.                                                      */
/*------------------------------------------------------------------*/
	Case 2
		idw_wSin.ilDernCol = 62

		sCol [ 6 ] = "DTE_OUVLIG_PORT"		
		idw_wSin.Uf_Proteger ( sCol, "0" )
	End Choose

Else
	sCol [ 6 ] = "DTE_OUVLIG_PORT"
/*------------------------------------------------------------------*/
/* Pas de téléphonie, toutes les zones sont non saisissables.       */
/*------------------------------------------------------------------*/
	idw_wSin.Uf_Proteger ( sCol, "1" )
	idw_wSin.ilDernCol = 46					// Zone ALT_BLOC Car ALT_EDIT est non Autorisée
End If

/*------------------------------------------------------------------*/
/* #1                                                               */
/*------------------------------------------------------------------*/
sAltCodBout	= idw_Produit.GetItemString ( 1, "ALT_COD_BOUTIQUE" )

If	sAltCodBout = 'O' Then
	idw_wSin.Uf_Proteger ( { "ID_ORIAN_BOUTIQUE"}, "0" )
Else
	idw_wSin.Uf_Proteger ( { "ID_ORIAN_BOUTIQUE"}, "1" )
End If

end subroutine

private subroutine uf_activerbmgme (boolean abactiv);//*-----------------------------------------------------------------
//*
//* Fonction      : U_Gs_Sp_Sinistre :: uf_ActiverBmGme ( PRIVATE )
//* Auteur        : Catherine ABDMEZIEM
//* Date          : 27/09/2002 14:35:15
//* Libellé       : Activation de la bitmap des gammes
//* Commentaires  :  
//*
//* Arguments     : ( Val )	Boolean	abActiv	:	Indique si l'on doit activer la bitmap
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

String	sModif

If isTypeTrt = "S" And abActiv Then
	sModif = "BM_GAMME.pointer = 'k:\pb4obj\bmp\DBLCLICK.CUR' " + &
				"BM_GAMME.filename = 'K:\PB4OBJ\BMP\TEL_PORT.BMP' " + &
				"BM_GAMME_T.pointer = 'k:\pb4obj\bmp\DBLCLICK.CUR' "
Else 
	sModif = "BM_GAMME.pointer = '' " + &
				"BM_GAMME.filename = 'K:\PB4OBJ\BMP\TEL_PORD.BMP' " + &
				"BM_GAMME_T.pointer = '' "
End If
idw_wSin.Modify ( sModif )

end subroutine

private subroutine uf_controlersaisie_commune (ref string astext, ref string aspos);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_ControlerSaisie_Commune (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 22/08/2003 15:04:10
//* Libellé       : On contrôle que tous les inters et toutes les commandes
//*				  	  aient une commune et CP Valide et cohérent
//* Commentaires  : 
//*
//* Arguments     : Réf		asPos		String
//*					  Réf		asText	String
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	  08/10/2003  Le fichier INSEE.TXT ne contien que les 25 premiers 
//*								  caractères de la ville.
//* #2	 JFF	  27/01/2004  DCMP 030581 : On prévoit un shunt pour le contrôle des communes.
//* #3	 PHG	  17/06/2006  [DCMP060445] : Unification Sherpa/simpa Controle des communes
//*								  Réécriture de la fonction.
//*-----------------------------------------------------------------

Long	lTotInter, lCptInter, lDeb, lFin
String	sVille, sCP, sCodInter

If asPos <> "" Or Not ibAltCommune Then Return

/*------------------------------------------------------------------*/
/* #2 : OPTION 16 : Si Option, on déconnecte tout le contrôle des   */
/* communes                                                         */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 16 )
If lDeb > 0 Then Return

/*------------------------------------------------------------------*/
/* Controle des Communes/CP des inter.                              */
/*------------------------------------------------------------------*/
lTotInter = idw_LstInter.RowCount ()

For lCptInter = 1 To lTotInter
	sCP	  	 = Upper ( Trim ( idw_LstInter.GetItemString ( lCptInter, "ADR_CP" )	) ) 
	sCodInter = idw_LstInter.GetItemString ( lCptInter, "COD_INTER" )

	/*------------------------------------------------------------------*/
	/* Si ce n'est pas une banque on traite le cas */
	/*------------------------------------------------------------------*/
	If sCodInter <> "B" And  sCodInter <> "F" Then

		If Not F_Libelle ( idw_LstInter.GetItemString ( lCptInter , "ADR_1"), 7 )  Or &
			Not F_Libelle ( idw_LstInter.GetItemString ( lCptInter , "ADR_2"), 7 )  Then
	
			asPos = "ADR_1"
	
			If asPos <> "" Then 
				asText = asText + " - Une adresse valide sur l'interlocuteur " + idw_LstInter.GetItemString ( lCptInter, "NOM" )  + "~n~r"
				Exit
			End If
		End If
		
		sVille  = Upper ( Trim ( idw_LstInter.GetItemString ( lCptInter, "ADR_VILLE" )	 ) )

		if Not stglb.uocommune.uf_verif_cp_ville( sCP, sVille) And asPos = "" then
			if Not stglb.uocommune.uf_checkcp( sCP) then
				/*------------------------------------------------------------------*/
				/* La CP n'existe pas					                                */
				/*------------------------------------------------------------------*/
				stMessage.sTitre		= "Contrôle de saisie d'un interlocuteur (Communes)"
				stMessage.Bouton		= Ok!
				stMessage.Icon			= Information!
				stMessage.bErreurG	= TRUE
				stMessage.sVar[1]		= idw_LstInter.GetItemString ( lCptInter, "NOM" ) 
				stMessage.sCode		= "COMM04"
				f_Message ( stMessage )
				asPos = "ADR_CP"
			Else
				/*------------------------------------------------------------------*/
				/* La commune n'existe pas                                          */
				/*------------------------------------------------------------------*/
				stMessage.sTitre		= "Contrôle de saisie d'un interlocuteur (Communes)"
				stMessage.Bouton		= Ok!
				stMessage.Icon			= Information!
				stMessage.bErreurG	= TRUE
				stMessage.sVar[1]		= idw_LstInter.GetItemString ( lCptInter, "NOM" )	
				stMessage.sCode		= "COMM05"
				f_Message ( stMessage )
				asPos = "ADR_VILLE"
			End If
		End If

	End If	
	
	If asPos <> "" Then 
		asText = asText + " - Un binôme Commune/CodePostal valide sur l'interlocuteur " + stMessage.sVar[1] + "~n~r"
		Exit
	End If

Next


end subroutine

private function boolean uf_gestionboitearchive ();//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::uf_GestionBoiteArchive			(PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 26/08/2003 10:03:22
//* Libellé			: 
//* Commentaires	: On s'occupe de la gestion des boites à archive
//*
//* Arguments		: Aucun
//*
//* Retourne		: Boolean			TRUE 	= Tout se passe bien
//*										 	FALSE	= Il y a un problème
//*
//*-----------------------------------------------------------------
//* MAJ      PAR      Date	  Modification
//* #1		 JFF	08/01/2007 On doit pouvoir consulter dans ts les cas.
//*-----------------------------------------------------------------

Long lDeb, lFin, lIdProd, lCodEtat, lIdCie, lIdProfil, lIdTypArch, lNbrHisto
String sBoiteCourante, sText, sMod
Boolean bRet

bRet = TRUE

/*------------------------------------------------------------------*/
/* DGA. Le 21/08/2003.                                              */
/* Gestion des boites archives.                                     */
/*------------------------------------------------------------------*/
idw_BoiteArchive.Reset ()
idw_BoiteArchive.Visible	= FALSE
idw_BoiteArchive.Enabled	= FALSE

lIdProd		= idw_wSin.GetItemNumber ( 1, "ID_PROD" )
lCodEtat		= idw_wSin.GetItemNumber ( 1, "COD_ETAT" )

SetNull ( sText )

stMessage.sTitre		= "Gestion des Boîtes archives"
stMessage.Icon			= Information!
stMessage.bErreurG	= FALSE
stMessage.bTrace		= FALSE

If			isTypeTrt = "V"	And ( lCodEtat = 200 Or lCodEtat = 500 Or lCodEtat = 600 Or lCodEtat = 900 )	Then
			F_RechDetPro ( lDeb, lFin, idw_DetPro, lIdProd, "-DP", 4 )
			If	lDeb > 0	Then
/*------------------------------------------------------------------*/
/* On va armer toutes les valeurs nécessaires dans la DW            */
/* (PROCEDURE PS_S01_BOITE_ARCHIVE).                                */
/*------------------------------------------------------------------*/
				idw_BoiteArchive.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ), stGLB.sCodOper )
/*------------------------------------------------------------------*/
/* Récupération des données impossible.                             */
/*------------------------------------------------------------------*/
				If	idw_BoiteArchive.RowCount () <> 1	Then 
					bRet = FALSE
					stMessage.sCode		= "BARC005"
				Else
					lIdCie 			= idw_BoiteArchive.GetItemNumber ( 1, "ID_CIE" )
					lIdProfil		= idw_BoiteArchive.GetItemNumber ( 1, "ID_PROFIL" )
					lIdTypArch		= idw_BoiteArchive.GetItemNumber ( 1, "ID_TYP_ARCH" )
					sBoiteCourante	= idw_BoiteArchive.GetItemString ( 1, "ID_BOITE_COURANTE" )

				End If
/*------------------------------------------------------------------*/
/* Impossible de déterminer la compagnie d'assurance.               */
/*------------------------------------------------------------------*/
				If	bRet And lIdCie = -1	Then
					bRet = FALSE
					stMessage.sCode		= "BARC010"
				End If
/*------------------------------------------------------------------*/
/* Le profil n'existe pas pour ce produit/compagnie.                */
/*------------------------------------------------------------------*/
				If	bRet And lIdProfil = -1	Then
					bRet = FALSE
					stMessage.sCode		= "BARC015"
				End If
/*------------------------------------------------------------------*/
/* Il existe plusieurs boites ouvertes en même temps pour un        */
/* gestionnaire donné dans le cas d'une méthode PRIVEE.             */
/*------------------------------------------------------------------*/
				If bRet And lIdTypArch = 1 And sBoiteCourante = "ERREUR 01"	Then
					bRet = FALSE
					stMessage.sCode		= "BARC020"
				End If
/*------------------------------------------------------------------*/
/* Dans le cas d'une méthode PRIVEE, on arme le N° de boite sur la  */
/* DW. Ce N° de boite peut-être NULL. (1ére boite ouverte par le    */
/* gestionnaire)                                                    */
/*------------------------------------------------------------------*/
				If bRet And lIdTypArch = 1	Then
					idw_BoiteArchive.SetItem ( 1, "NO_BOITE", sBoiteCourante )
					sText = "A stocker dans boîte "

					If	Not IsNull ( sBoiteCourante )	Then
						sText = sText + sBoiteCourante						
					End If
				End If
/*------------------------------------------------------------------*/
/* Méthode CENTRALISEE.                                             */
/*------------------------------------------------------------------*/
				If	bRet And lIdTypArch = 2	Then
					sText = "A déposer dans bannette archives"
				End If
			Else
/*------------------------------------------------------------------*/
/* Le dossier est clos mais il n'existe pas de ligne dans DET_PRO.  */
/*------------------------------------------------------------------*/
				sText = "Aucune consigne d~~~'archivage"
			End If
ElseIf	isTypeTrt = "V"	And ( lCodEtat <> 200 And lCodEtat <> 500 And lCodEtat <> 600 And lCodEtat <> 900 )	Then
/*------------------------------------------------------------------*/
/* Le dossier n'est pas CLOS.                                       */
/*------------------------------------------------------------------*/
	sText = "A maintenir en instruction"
End If

/*------------------------------------------------------------------*/
/* On est en consultation de la fenêtre d'instruction. On récupére  */
/* le contenu de la DW pour voir s'il existe des Archives           */
/* précédentes.                                                     */
/*------------------------------------------------------------------*/
If	isTypeTrt = "C"	Then

   //* #1		 JFF	08/01/2007 On doit pouvoir consulter dans ts les cas.
	// F_RechDetPro ( lDeb, lFin, idw_DetPro, lIdProd, "-DP", 4 )
	lDEb = 1 // #1
	If	lDeb > 0	Then
		idw_BoiteArchive.Retrieve ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ), stGLB.sCodOper )
		If	idw_BoiteArchive.RowCount () > 0	Then
			lNbrHisto = idw_BoiteArchive.GetItemNumber ( 1, "NBR_HISTO" )
			sText = "En cours d~~~'instruction."

			If	lNbrHisto > 0	Then	
				sText = sText + " (Rapatrié)"
			End If
		End If
	End If
End If

If	Not IsNull ( sText )	Then
	sMod = "Text_t.Text = '" + sText + "'"
	idw_BoiteArchive.Modify ( sMod )
	idw_BoiteArchive.Visible = TRUE
End If


If	Not bRet	Then F_Message ( stMessage )
		
Return ( bRet )
end function

private subroutine uf_epuration_zonecommune (ref string asville, ref integer aicode);//*-----------------------------------------------------------------
//*
//* Fonction      : uf_gs_sp_sinistre::uf_Epuration_ZoneCommune ( PRIVATE )
//* Auteur        : Fabry JF
//* Date          : 12/09/2003 10:48:04
//* Libellé       : Supprime tout ce qui est gênant dans la chaine de 
//*					  la ville afin de ne garder que la ville.
//* Commentaires  : 
//*
//* Arguments     : String 	asVille 		aRef
//*					  Integer	aiCode		aRef	 1 : Présence d'un CEDEX, BP, etc 
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------
String sVille, sCar, sMot, sMotSubst
String sTbMotCle []   // Mots Clé à ne pas tenir Compte
Integer iTotMotCle, iCpt, iPos
Boolean bCarTrouve

sTbMotCle = { " BP", "CEDEX", "CÉDEX", "CEDÉX", "CÉDÉX" }
sVille = Upper ( asVille )
aiCode = 0

/*------------------------------------------------------------------*/
/* 1 : Suppression des mots clés                                    */
/*------------------------------------------------------------------*/
iTotMotCle = UpperBound ( sTbMotCle )
For iCpt = 1 To iTotMotCle
	iPos = 1
	Do While iPos > 0 
		iPos = Pos ( sVille, sTbMotCle [iCpt], 1 )
		If iPos > 0 Then
			sVille = Replace ( sVille , iPos, Len ( sTbMotCle [iCpt]), "" ) 
			aiCode = 1
		End If
	Loop
Next

/*------------------------------------------------------------------*/
/* 2 : Par la gauche, suppression de tout caractère non compris     */
/* entre 65 et 90 (ASCII).                                          */
/*------------------------------------------------------------------*/
bCarTrouve = TRUE
Do While bCarTrouve 
	sCar = Left ( sVille, 1 )


	If Len ( sCar ) <=0 Then exit

	Choose Case asc ( sCar ) 
		Case 65 To 90
			bCarTrouve = False

		Case Else
			bCarTrouve = TRUE
				sVille = Right ( sVille, Len ( sVille ) - 1 )
	End Choose 
Loop

/*------------------------------------------------------------------*/
/* 3 : Par la Droite, suppression de tout caractère non compris     */
/* entre 65 et 90 (ASCII).                                          */
/*------------------------------------------------------------------*/
bCarTrouve = TRUE
Do While bCarTrouve 
	sCar = Right ( sVille, 1 )

	If Len ( sCar ) <=0 Then exit

	Choose Case asc ( sCar ) 
		Case 65 To 90
			bCarTrouve = False

		Case Else
			bCarTrouve = TRUE
				sVille = Left ( sVille, Len ( sVille ) - 1 )

	End Choose 
Loop


/*------------------------------------------------------------------*/
/* 4 : Si _SAINT_ Ou _SAINTE_ trouvé en début de chaine remplacer   */
/* par ST ou STE                                                    */
/*------------------------------------------------------------------*/
For iCpt = 1 To 4
	Choose Case iCpt
		Case 1
			sMot = " SAINT "
			sMotSubst = " ST "
		Case 2
			sMot = " SAINTE "
			sMotSubst = " STE "
		Case 3
			sMot = "SAINT "
			sMotSubst = "ST "
		Case 4
			sMot = "SAINTE "
			sMotSubst = "STE "
			
	End Choose

	iPos = Pos ( sVille, sMot, 1 )

	Choose Case iCpt
		Case 1, 2
			If iPos > 0 Then
				sVille = Replace ( sVille, iPos, Len ( sMot ), sMotSubst ) 
			End If

		Case 3, 4
			If iPos = 1 Then
				sVille = Replace ( sVille, iPos, Len ( sMot ), sMotSubst ) 
			End If
	End Choose 
Next

/*------------------------------------------------------------------*/
/* 5 : Si la ville est composée, il ne doit y avoir qu'un espace 	  */
/* entre les mots.																  */
/*------------------------------------------------------------------*/
iPos = 1 
Do While iPos > 0 
	iPos = Pos ( sVille, "  ", 1 )
	If Len ( sVille ) <=0 Then exit

	If iPos > 0 Then
		sVille = Replace ( sVille , iPos, 2, " " ) 
	End If
Loop


asVille = sVille


end subroutine

private function string uf_format_numtel (string asvarstr);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Format_NumTel (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 27/10/2003 16:29:55
//* Libellé			: Formatage du Num soit 0 000 000 000 ou 00 00 00 00 00
//* Commentaires	: 
//*
//* Arguments		: String 	asVarStr
//*
//* Retourne		: rien
//*
//*-----------------------------------------------------------------
//* MAJ PAR		Date		Modification
//* #1	FPI	28/09/2009	[DCMP090552] Gestion des numéros de tel étranger
//*-----------------------------------------------------------------

String sVar1
Long	 lTot, lCpt

asVarStr = Trim ( asVarStr ) 

// #1 - [DCMP090552] - Refonte
lTot = Len ( asVarStr ) 
sVar1 = ""
For lCpt = 1 to lTot
	If Mid ( asVarStr, lCpt, 1 ) <> " " Then sVar1 += Mid ( asVarStr, lCpt, 1 )
Next

lTot = Len ( sVar1 )
asVarStr = ""

Choose Case Left ( sVar1, 2 )
	Case "08"
		For lCpt = 1 to lTot

			CHOOSE CASE lCpt
				CASE 2,5,8
					asVarStr += " "
			END CHOOSE

			asVarStr += Mid ( sVar1, lCpt, 1 )
		Next
		
	Case "09"
		For lCpt = 1 to lTot

			CHOOSE CASE lCpt
				CASE 5,8
					asVarStr += " "
			END CHOOSE

			asVarStr += Mid ( sVar1, lCpt, 1 )
		Next
	Case Else
		For lCpt = 1 to lTot

			CHOOSE CASE lCpt
				CASE 3,5,7,9
					asVarStr += " "
			END CHOOSE

			asVarStr += Mid ( sVar1, lCpt, 1 )
		Next
End Choose

Return asVarStr

// #1 Mise en commentaire
/*
If Left ( asVarStr, 2 ) = "08" Then 

	lTot = Len ( asVarStr ) 
	sVar1 = ""
	For lCpt = 1 to lTot
		If Mid ( asVarStr, lCpt, 1 ) <> " " Then sVar1 += Mid ( asVarStr, lCpt, 1 )
	Next
	lTot = Len ( sVar1 )
	asVarStr = ""
	For lCpt = 1 to lTot

		CHOOSE CASE lCpt
			CASE 5,8
				asVarStr += " "
		END CHOOSE

		asVarStr += Mid ( sVar1, lCpt, 1 )
	Next

Else 

	lTot = Len ( asVarStr ) 
	sVar1 = ""
	For lCpt = 1 to lTot
		If Mid ( asVarStr, lCpt, 1 ) <> " " Then sVar1 += Mid ( asVarStr, lCpt, 1 )
	Next
	lTot = Len ( sVar1 )
	asVarStr = ""
	For lCpt = 1 to lTot

		CHOOSE CASE lCpt
			CASE 3,5,7,9
				asVarStr += " "
		END CHOOSE

		asVarStr += Mid ( sVar1, lCpt, 1 )
	Next

End If

Return asVarStr*/


end function

private subroutine uf_controlersaisie_boutique (integer alcas, ref string astext, ref string aspos);//*-----------------------------------------------------------------
//*
//* Fonction      : U_Gs_Sp_Sinistre :: uf_ControlerSaisie_Boutique ( PRIVATE )
//* Auteur        : Catherine ABDMEZIEM
//* Date          : 08/11/2002
//* Libellé       : Controle de saisie du code id_orian_boutique
//* Commentaires  : 
//*
//* Arguments     : ( Val )	Long		alCas		:	1 - ctrl bloquant de validité de saisie
//*																2 - ctrl non bloquant de saisie
//*					  ( Ref )	String	asPos		:	contient le nom de la zone en erreur
//*					  ( Ref )	String	asText	:	contient le texte du message à afficher
//*
//* Retourne      : Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//* #1	 CAG	 25/11/2002   Annexe 21 : si codtel > 0 et alt_cod_boutique = "O"
//* #2	 JFF	 13/11/2003   Option -DP12, Boutique obligatoire.
//* #3	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #4    JFF   06/11/2009   [20091106201707453] On shunt la fonction si Factu
//*       JFF   05/07/2011   [PC292][AUCHAN]
//*       JFF   18/06/2012   [CONFO][NV_PROCESS]
//*       JFF   12/10/2012   [MANTIS5014]
//*-----------------------------------------------------------------

String	sCodAdh, sCodOrianBout, sNouvelleLigne, sAltCodBout, sIdFourDiag 
Long		lIdOrianBout, lCodTel, lDeb, lFin, lProcessDiag, lRow, lRow1
Boolean  bDartyTel, bDartyNomade, bCasto, bCmdeFNAC 
s_Message stMessageSav
boolean bExpansion5

// #4 [20091106201707453]
If this.uf_GetAutorisation2(208) Then Return 

sNouvelleLigne		= "~r~n"
lIdOrianBout = idw_wSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )
lCodTel = idw_Produit.GetItemNumber ( 1, "COD_TEL" )
sAltCodBout = idw_Produit.GetItemString ( 1, "ALT_COD_BOUTIQUE" )

If idw_wSin.GetItemNumber ( 1, "COD_ETAT" ) = 1 Then Return

lProcessDiag = 0
idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV' AND ID_FOUR in ( 'O2M', 'MSS', 'SB1' ) AND ID_REF_FOUR = 'A_DIAGNOSTIQUER'" )
idw_LstwCommande.Filter ( )
If idw_LstwCommande.RowCount () > 0 Then
	lProcessDiag = idw_LstwCommande.GeTItemNumber ( 1, "INFO_SPB_FRN" )
	sIdFourDiag = idw_LstwCommande.GeTItemString ( 1, "ID_FOUR" )
End If 
idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ( )

idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV' AND ID_FOUR = 'FNC'" )
idw_LstwCommande.Filter ( )
bCmdeFNAC = idw_LstwCommande.RowCount () > 0 
idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ( )



F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 43 )
bCasto = lDeb > 0 
If bCasto Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 12 )  // Boutique Obligatoire
	If lDeb > 0 And ( lIdOrianBout = 0 Or IsNull ( lIdOrianBout ) ) Then
			asPos = "ID_ORIAN_BOUTIQUE"
			asText = asText + " - Le code boutique" + sNouvelleLigne			
	End If
	Return
End If


F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 11 )
bDartyTel = lDeb > 0 

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 31 )
bDartyNomade = lDeb > 0 

/*------------------------------------------------------------------*/
/* #1                                                               */
/*------------------------------------------------------------------*/
If lCodTel > 0 And sAltCodBout = "O" Then

	Choose Case alCas

		Case 1
			If lIdOrianBout <> 0 And Not IsNull ( lIdOrianBout ) Then 

				If bDartyTel Or bDartyNomade  Then
					If Len ( String ( lIdOrianBout ) ) > 6 Then
						asPos = "ID_ORIAN_BOUTIQUE"
						asText = asText + " - Un code boutique de 6 chiffres maximum" + sNouvelleLigne
					End If
				ElseIf Len ( String ( lIdOrianBout ) ) > 7 Then
						asPos = "ID_ORIAN_BOUTIQUE"
						asText = asText + " - Un code boutique de 7 chiffres maximum" + sNouvelleLigne
				End If
			End If

		Case 2
			If lIdOrianBout = 0 Or IsNull ( lIdOrianBout ) Then

				stMessage.sTitre		= "Contrôle de saisie du sinistre"
				stMessage.bErreurG	= False

				/*------------------------------------------------------------------*/
				/* #9: Gestion BOUTIQUE obligatoire -DP, 12	                       */
				/* Uniquement s'il y a des commandes pour DARTY.					 	  */
				/*------------------------------------------------------------------*/
				F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 12 )
				If lDeb > 0 And bDartyTel Then
					If idw_LstwCommande.Find ( &
							 "ID_TYP_ART = 'TEL' AND " + &		
							 "COD_ETAT   = 'CNV' AND " + &  
							 "CPT_VALIDE <= 0    AND " + &
							 "ID_FOUR    = 'DTY' " 		, &
							 1, idw_LstwCommande.RowCount () ) > 0 Then

								stMessage.bouton		= OK!
								stMessage.sCode		= "WSIN440"

								asPos = "ID_ORIAN_BOUTIQUE"
								asText = asText + " - Le code boutique" + sNouvelleLigne

					End If
				ElseIf lDeb > 0 Then

								stMessage.bouton		= OK!
								stMessage.sCode		= "WSIN440"

								asPos = "ID_ORIAN_BOUTIQUE"
								asText = asText + " - Le code boutique" + sNouvelleLigne


				// Alerte, mais non obligatoire
				Else

					stMessage.bouton		= YESNO!
					stMessage.sCode		= "WSIN370"

					If F_Message ( stMessage ) = 2 Then 
						asPos = "ID_ORIAN_BOUTIQUE"
						asText = asText + " - Le code boutique" + sNouvelleLigne
					End If
				End If
			End If
	End Choose

End If


// [CONFO][NV_PROCESS]
If lCodTel = 0 And sAltCodBout = "O" And ( lIdOrianBout = 0 Or IsNull ( lIdOrianBout )) Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 12 )
	If lDeb > 0 Then

		// [MANTIS5014]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 207 )
		If lDeb > 0 Then
			lRow = idw_LstGti.Find ( "ID_GTI IN ( 46, 47 )", 1, idw_LstGti.Rowcount() )
			lRow1 = idw_LstGti.Find ( "ID_GTI NOT IN ( 46, 47 )", 1, idw_LstGti.Rowcount() )

			If lRow <= 0 And lRow1 > 0 Then

				stMessage.bouton		= OK!
				stMessage.sCode		= "WSIN440"
		
				asPos = "ID_ORIAN_BOUTIQUE"
				asText = asText + " - Le code boutique" + sNouvelleLigne
			End If
		Else
			stMessage.bouton		= OK!
			stMessage.sCode		= "WSIN440"
	
			asPos = "ID_ORIAN_BOUTIQUE"
			asText = asText + " - Le code boutique" + sNouvelleLigne		
		End If
	End If	
End If
//* #3 [FNAC_PROD_ECH_TECH]

// If ( bFnacEPT or bFnacTV ) And alCas = 2 Then
If alCas = 2 Then

	stMessageSav.bouton = stMessage.bouton
	stMessageSav.sCode  = stMessage.sCode		
	stMessageSav.Icon  = stMessage.Icon
	stMessageSav.bErreurG  = stMessage.bErreurG 

	stMessage.bouton = Ok!
	stMessage.Icon   = Exclamation!
	stMessage.bErreurG = FALSE

	If lProcessDiag = 963 Then lProcessDiag = 1115
	// Pour la mep, mettre 936 dans le cae ci-dessous
	
	Choose Case lProcessDiag 
		Case 945, 950, 960, 906, 911, 1115
		

			stMessage.sVar [1] = sIdFourDiag 

			If asPos <> "" Then
				// code boutique absent

				// [PC292][AUCHAN]
				If lIdOrianBout = 0 Or IsNull ( lIdOrianBout ) Then
					asPos = "ID_ORIAN_BOUTIQUE"
					If Pos ( asText, " - Le code boutique", 1 ) <= 0 then
						asText = asText + " - Le code boutique" + sNouvelleLigne
					End IF
					stMessage.sCode  = "WSIN705"		
					F_Message (stMessage)
				End If
				// [PC292][AUCHAN]				
				stMessage.sCode  = "WSIN640"							

			Else 
				// [PC292][AUCHAN]
				If lIdOrianBout = 0 Or IsNull ( lIdOrianBout ) Then
					asPos = "ID_ORIAN_BOUTIQUE"
					If Pos ( asText, " - Le code boutique", 1 ) <= 0 then
						asText = asText + " - Le code boutique" + sNouvelleLigne
					End IF
					stMessage.sCode  = "WSIN705"		
					F_Message (stMessage)
				End If
				// [PC292][AUCHAN]				

				// Présent
				stMessage.sCode  = "WSIN645"
			End If

			stMessage.bouton = Ok!
			stMessage.Icon   = Exclamation!
			stMessage.bErreurG = FALSE
			F_Message (stMessage)

	End Choose

//	If bCmdeFNAC and Not bFnacTV Then
	If bCmdeFNAC Then
			If asPos <> "" Then
				// code boutique absent
				stMessage.sCode  = "WSIN650"
			Else 
				// Présent
				stMessage.sCode  = "WSIN655"
			End If

			F_Message (stMessage)
	End If

	// restaur SAV
	stMessage.bouton = stMessageSav.bouton 
	stMessage.sCode  = stMessageSav.sCode
	stMessage.Icon   = stMessageSav.Icon
	stMessage.bErreurG = stMessageSav.bErreurG
	
End If

//* :#3 [FNAC_PROD_ECH_TECH]
end subroutine

private function string uf_determiner_casparticulier (ref string asidnatcour, integer aiidinter);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_CasParticulier (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 30/12/2003 10:57:18
//* Libellé       : Gestion des particuliers. DCMP 030483
//* Commentaires  : Pour l'instant gestion des cas MUST&ORANGE
//*
//* Arguments     : String		asIdNatCour			Réf !!  En effet, la nature peut être modifiée
//*					  Integer 	aiIdInter			Val
//*
//* Retourne      : String
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

String sPos 
Boolean	bGestPartORANGE, bGestPartSFRMUST
sPos = "" 
Long	   lDeb, lFin, lIdSin
Integer  iCodePCe, iTotPce, iNbCour

lIdSin = idw_Wsin.GetItemNumber ( 1, "ID_SIN" ) 
iNbCour = 0

/*------------------------------------------------------------------*/
/* Armement des Options.                                            */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 13 )
bGestPartORANGE = lDeb > 0
/*------------------------------------------------------------------*/
/* On modifie la nature du courrier                                 */
/* W : courrier méthode particulière                                */
/* O : ORANGE                                                       */
/*------------------------------------------------------------------*/
If bGestPartORANGE And asIdNatCour <> "APART1" Then asIdNatCour = "WO" + Right ( asIdNatCour, 4 )
 
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 14 )
bGestPartSFRMUST = lDeb > 0
/*------------------------------------------------------------------*/
/* On modifie la nature du courrier                                 */
/* W : courrier méthode particulière                                */
/* S : SFR                                                          */
/*------------------------------------------------------------------*/
If bGestPartSFRMUST And asIdNatCour <> "APART1" Then asIdNatCour = "WS" + Right ( asIdNatCour, 4 )


/*------------------------------------------------------------------*/
/* Gestion particuliere ORANGE ET Demande de pièce à l'assuré       */
/*------------------------------------------------------------------*/
If bGestPartORANGE Then

	/*------------------------------------------------------------------*/
	/* Pour ORANGE, le premier cas particulier comprend le ctrl         */
	/* suivant : Si au moins une pièces est cochée, aucune autre pièce  */
   /* ne peut être cochée.                          						  */
	/*------------------------------------------------------------------*/
	If asIdNatCour = "WO0P01" Then
		iTotPce	= idw_wPiece.RowCount () 
		If iTotPce > 1 Then

			stMessage.sTitre		= "Courrier DemPiece ORANGE"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= Ok!
			stMessage.sCode		= "CACO001"			

			sPos = "REF_CIE"
			Return sPos

		ElseIf iTotPce = 0 Then
			stMessage.sTitre		= "Courrier DemPiece ORANGE"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= Ok!
			stMessage.sCode		= "CACO002"			
			stMessage.sVar[1]		= asIdNatCour 

			sPos = "REF_CIE"
			Return sPos
		End If
	End If

	/*------------------------------------------------------------------*/
	/* Attribution du code courrier ORANGE en fonction du code courier  */
	/* SPB                                                              */
	/*------------------------------------------------------------------*/
	Choose Case asIdNatCour 
		Case "WOE001"		// Courrier de prise en charge
				isTabVarOrange[ aiIdInter + 1, 1 ] = "OSSPB004/V00"

	/*------------------------------------------------------------------*/
	/* Courrier de Refus (à reprendre en CP)                            */
	/* Attention, en placant "APART1" ici, le code OSSPB008 ressortira  */
	/* pour tous les courriersORANGE, mais je ne peux pas faire         */
	/* autrement.                                                       */
	/*------------------------------------------------------------------*/
		Case "WO00R1", "APART1"
				isTabVarOrange[ aiIdInter + 1, 1 ] = "OSSPB008/V00"

		Case "WO0P01"		// Courrier de emande de pièces

			/*------------------------------------------------------------------*/
			/* Il ne doit y avoir qu'une seule pièce                            */
			/*------------------------------------------------------------------*/
		 	If iTotPce <> 1 Then 
				sPos = "REF_CIE"
				Return sPos
			End If

			/*------------------------------------------------------------------*/
			/* Attribution du code courrier ORANGE en fonction de la piece      */
			/* choisie                                                          */
			/*------------------------------------------------------------------*/
			Choose Case idw_wPiece.GetItemNumber ( 1, "ID_PCE" ) 
				Case 241
					isTabVarOrange[ aiIdInter + 1, 1 ] = "OSSPB005/V00"
				Case 242
					isTabVarOrange[ aiIdInter + 1, 1 ] = "OSSPB007/V00"
				Case 243
					isTabVarOrange[ aiIdInter + 1, 1 ] = "OSSPB003/V00"
				Case 244
					isTabVarOrange[ aiIdInter + 1, 1 ] = "OSSPB006/V00"
				Case ELSE
					isTabVarOrange[ aiIdInter + 1, 1 ] = "!! PIECE NON GEREE !!"
			End Choose

		End Choose

		/*------------------------------------------------------------------*/
		/* Récupération du nombre de courrier déjà envoyés à cet            */
		/* interlocuteur.                                                   */
		/*------------------------------------------------------------------*/
		SELECT Max ( id_doc ) 
		INTO   :iNbCour
		FROM	 sysadm.archive
		WHERE  id_sin = :lIdSin
		AND    id_inter = :aiIdInter
		USING SQLCA ;

		/*------------------------------------------------------------------*/
		/* Incrementation du compteur pour ce courrier actuel               */
		/*------------------------------------------------------------------*/
		If IsNull ( iNbCour ) Then iNbCour = 0
		iNbCour ++

		isTabVarOrange[ aiIdInter + 1, 2 ] = String ( iNbCour )

End If 


/*------------------------------------------------------------------*/
/* Gestion particuliere SFR MUST 											  */
/*------------------------------------------------------------------*/
If bGestPartSFRMUST Then

End If


Return sPos
end function

private subroutine uf_determiner_data_inter_numletchq (long alcptinter, decimal adcmtareg, ref string asval);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Data_Inter_NumLetChq (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 05/02/2004 15:34:24
//* Libellé       : Récupération d'un n° de chèque venant de GENVIR.
//* Commentaires  : 
//*
//* Arguments     : Long		alCptInter		Val
//*					  Decimal	adcMtAReg		Val
//*					  String		asVal				Réf
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

String sNumLC
Long   lNumLC, lDeb, lFin

/*------------------------------------------------------------------*/
/* Option 18 : Le compteur des lettres chèques est déconnecté.      */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 18 )
If lDeb > 0 Then 
	asVal = ""
	Return
End If

/*------------------------------------------------------------------*/
/* On ne continu que si le mode de réglement est par Chèque et      */
/* qu'il y a un montant à régler Et que l'édition est souhaitée.    */
/*------------------------------------------------------------------*/
If idw_LstInter.GetItemString ( alCptInter, "COD_MODE_REG" ) <> "C" Or &
	adcMtaReg = 0 Or & 
	idw_wsin.GetItemString ( 1, "ALT_EDIT" ) = "N" 						  Then
	asVal = ""
	Return
End If

/*------------------------------------------------------------------*/
/* Lecture du n° de ch_que actuellement positionné sur la DW        */
/*------------------------------------------------------------------*/
sNumLC = idw_LstInter.GetItemString ( alCptInter, "NUM_LET_CHEQUE" )

/*------------------------------------------------------------------*/
/* Si Ce n° est null, on en récupère un de GENVIR_PRO (commité)     */
/*------------------------------------------------------------------*/
If IsNull ( sNumLC ) Then
	lNumLC = -1

	SQLCA.PS_U01_PARAM_CPT ( Upper ( stGlb.sCodAppli ), Upper ( SQLCA.DataBase ), "NUM_CHEQ", lNumLC ) 

	If lNumLC = -1 Or SQLCA.SQLCode <> 0 Or SQLCA.SQLDBCode <> 0 Then
		F_Commit ( SQLCA, False )
		sNumLC = "-1"

		stMessage.sTitre		= "Commandes"
		stMessage.Icon			= StopSign!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= Ok!
		stMessage.sCode		= "GENE132"

	Else
		F_Commit ( SQLCA, True )
		sNumLC = "S" + String ( lNumLC , "000000" )	
	End If
End IF 

asVal = sNumLC

If asVal = "-1" Then
	SetNull ( sNumLC ) 
	idw_LstInter.SetItem( alCptInter, "NUM_LET_CHEQUE", sNumLC )
Else
	idw_LstInter.SetItem( alCptInter, "NUM_LET_CHEQUE", asVal )
End If

end subroutine

private subroutine uf_terminervalider_inter ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Terminer_Valider_Inter (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 05/02/2004 15:34:24
//* Libellé       : Si le n° de lettre chèque n'a aucune raison d'être écrit
//*					  en base, on le supprime.
//* Commentaires  : 
//*
//* Arguments     : 
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF   08/04/2004	  DCMP 040020 SVE
//*
//*-----------------------------------------------------------------

Long lDeb, lFin, lTotInter, lCpt
Boolean  bOption18
String sNull, sIdNatcour

/*------------------------------------------------------------------*/
/* Option 18 : Le compteur des lettres chèques est déconnecté.      */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 18 )
bOption18 = lDeb > 0 

SetNull ( sNull )
lTotInter = idw_LstInter.RowCount ()

For lCpt = 1 To lTotInter
	If idw_LstInter.GetItemString ( lCpt, "COD_MODE_REG" ) <> "C" Or &
		idw_LstInter.GetItemDecimal ( lCpt, "MT_A_REG" ) = 0	  Or & 
		idw_wsin.GetItemString ( 1, "ALT_EDIT" ) = "N" 			  	  Or &
		bOpTion18 Then
		
			idw_LstInter.SetItem( lCpt, "NUM_LET_CHEQUE", sNull )
	End If

/*------------------------------------------------------------------*/
/* #1 pour la SVE : On update en dernier lieu ici les inter sur la  */
/* presence d'un CP ou non.                                         */
/*------------------------------------------------------------------*/
	If idw_wsin.GetItemString ( 1, "ALT_EDIT" ) = "O" 	And & 
		This.uf_GestionCP ( "PRESENCE", idw_LstInter.GetItemNumber ( lCpt, "ID_I" ), idw_LstInter.GetItemString ( lCpt, "COD_INTER" ) ) And &
		ibSaisieValidation Then

		idw_LstInter.SetItem ( lCpt, "ALT_PART", "O" )
		idw_LstInter.SetItem ( lCpt, "ID_COUR", "APART1" )

		sIdNatCour = idw_LstInter.GetItemString ( lCpt, "ID_NAT_COUR" )
		If IsNull ( sIdNatCour ) Then sIdNatCour = "" 

		If sIdNatCour = "" Then
			idw_LstInter.SetItem ( lCpt, "ID_NAT_COUR", "APART1")
		End If

	End If

Next





end subroutine

public subroutine uf_initialiser_sve (ref s_pass astpasssve, ref n_cst_saisie_validation_sinistre anvsaisievalsin, ref listbox albfichier);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Initialiser_SVE (PUBLIC)
//* Auteur        : Fabry JF
//* Date          : 12/03/2004 10:52:06
//* Libellé       : Initialisation lié à la SVE DCMP 040020
//* Commentaires  : 
//*
//* Arguments     : s_Pass											astPassSve				Réf
//*					  N_Cst_Saisie_Validation_Sinistre		anvSaisieValsin		Réf
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

ibSaisieValidation = astPassSve.bTab [1]

iDddwTypeDoc 		= astPassSVE.dwNorm [1] 
iDwStkWCourBlobSve= astPassSVE.dwNorm [2]
iDwCompo 			= astPassSVE.dwNorm [3]

invSaisieValSin   = anvSaisieValSin
ilbFichier			= albFichier

iDddwTypeDoc.SetTransObject ( SQLCA )
iDddwTypeDoc.Retrieve ( "-ND" )

iDddwTypeDoc.SetFilter ( "ID_CODE <> -1" )
iDddwTypeDoc.Filter ()

/*------------------------------------------------------------------*/
/* On positionne l'objet de transaction sur la DW qui récupére les  */
/* lignes de la table W_COUR_BLOB.                                  */
/*------------------------------------------------------------------*/
	iDwStkWCourBlobSve.SetTransObject ( SQLCA )
/*------------------------------------------------------------------*/
/* DataWindow pour la composition d'un double du courrier.          */
/*------------------------------------------------------------------*/
	iDwCompo.SetTransObject ( SQLCA )




end subroutine

public function string uf_getdatainter (integer alidinter);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_Sinistre::uf_GetDataInter (PUBLIC)
//* Auteur        : Fabry JF
//* Date          : 22/03/2004 17:31:55
//* Libellé       : Fonction servant à récupérer le blob de Data d'un inter donné,
//*					  Afin de "l'emporter" lors de l'ouverture de la fenêtre de
//*					  l'interlocuteur.
//* Commentaires  : 
//*
//* Arguments     : Int		alIdInter		Val
//*
//* Retourne      : String (Data)
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

String sDataTsInter [], sDataInter
s_Pass TabVariable[]  // [PI052]
string aTabCodeVar[]  // [PI052]

This.Uf_Determiner_Data_Sinistre ( sDataTsInter, "CP_UNIQUEMENT", alIdInter, TabVariable[], aTabCodeVar[] )

sDataInter = sDataTsInter [ alIdInter + 1 ]

Return sDataInter 

end function

private function string uf_determiner_courrier (ref integer aidroitinter[]);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Courrier::Uf_Determiner_Courrier (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 15/06/1998 10:30:11
//* Libellé			: 
//* Commentaires	: On va déterminer les codes courriers des différents interlocuteurs
//*
//* Arguments		: Integer		aiDroitInter[]			Réf		// Tableau des droits pour le SVE
//*
//* Retourne		: String				=	"" -> On continue
//*											<>	"" -> Une erreur est rencontrée, on arrête le contrôle de gestion
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    29/12/2003  DCMP 030483, courrier MUST&ORANGE
//* #2	 JFF	  22/03/2004  SVE DCMP 040020
//* #3    JFF	  06/02/2006  [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
//* #4	 PHG    10/12/2007  [O2M] Determination des courrier a envoyer.
//* #5	 FPI	  27/10/2009  [DCMP090629] Factorisation des appels de fonctions de forçage 
//        JFF    09/02/2015  [DT133_CASTO]
//       JFF   19/12/2024 [MIG1_COUR_EMAILING]
//*-----------------------------------------------------------------

String sAltQuest, sAltPart, sAltCourGest, sCodModeReg, sRech, sRechDetail, sIdNatCour, sIdCour, sRechGti
String sCar1, sCar2, sCar3, sCar4, sCar5, sCar6
String sPos, sVal
String sTabVarOrangeNull [7,2] 
String sIdNatCourForcage, sIdNatPresent
String sCodInter 
string sTabPce []
Decimal {2} dcMtaReg
Int	 iIdI
Boolean	bDroitModifCour, bVal

Long lTotTabPce, lCptTabPce, lRow // [DT133_CASTO]
boolean bCasCastoDT133 // [DT133_CASTO]
String sSavTitre // [DT133_CASTO]

Long lTotInter, lCpt, lTotPce, lTotRefus, lLig, lLigDetail, lTotDetail, lTotParaInfo, lTotGti, lLigGti
Long lIdDetail, lIdGti, lLigDeb, lIdIDb
Long lTotCourrier
Long lDeb, lFin 
n_cst_string lnvPFCString

DataWindowChild	dwChild

Boolean bEnvoiCourrier

// [MIG1_COUR_EMAILING]
If F_CLE_A_TRUE ( "MIG1_COUR_EMAILING" ) Then
	IF ibMIG1_CourEmailing Then Return ""
End If 


isTabVarOrange = sTabVarOrangeNull 

lTotInter		= idw_LstInter.RowCount ()
lTotPce			= idw_wPiece.RowCount ()
lTotRefus		= idw_wRefus.RowCount ()
lTotDetail		= idw_wDetail.RowCount ()
lTotGti			= idw_LstGti.RowCount ()
lTotParaInfo	= idw_wParaInfo.RowCount ()
sPos				= ""
bCasCastoDT133 = False

For	lCpt = 1 To lTotInter

		sCar1 = stNul.str
		sCar2 = stNul.str
		sCar3 = stNul.str
		sCar4 = stNul.str
		sCar5 = stNul.str
		sCar6 = stNul.str
		
		iIdI = idw_LstInter.GetItemNumber ( lCpt, "ID_I" )
		sCodInter = idw_LstInter.GetItemString ( lCpt, "COD_INTER" ) // [DT133_CASTO]		

/*------------------------------------------------------------------*/
/* Si on envoie un questionnaire, les zones ID_NAT_COUR et ID_COUR  */
/* sont déjà positionnées.  (Uf_Zn_AltQuest dans                    */
/* U_Gs_Interlocuteur)                                              */
/*------------------------------------------------------------------*/
		sAltQuest = idw_LstInter.GetItemString ( lCpt, "ALT_QUEST" )
		If	sAltQuest = "O" Then 
			/*------------------------------------------------------------------*/
			/* #2 : Ici on arme les droits de modification du courrier.         */
			/*------------------------------------------------------------------*/
			This.uf_Determiner_Courrier_MajDroit ( "QXXXXX", iIdI, aiDroitInter )
	
			Continue
		End If

/*------------------------------------------------------------------*/
/* #2 SVE DCMP04020 : Si presence d'un CP sur disque concernant     */
/* l'inter, écrit lors du précédent Ctrl (Cour Auto passé en CP),   */
/* on l'écrit maintenant.                                           */
/*------------------------------------------------------------------*/
		If This.uf_GestionCP ( "PRESENCE", iIdI, idw_LstInter.GetItemString ( lCpt, "COD_INTER" ) ) Then
			idw_LstInter.SetItem ( lCpt, "ALT_PART", "O" )
		End If

/*------------------------------------------------------------------*/
/* Si on envoie un courrier particulier, ID_NAT_COUR = "APART1".    */
/*------------------------------------------------------------------*/
		sAltPart = idw_LstInter.GetItemString ( lCpt, "ALT_PART" )
		If	sAltPart = "O"	Then

			If Not ibSaisieValidation Then
				idw_LstInter.SetItem ( lCpt, "ID_NAT_COUR", "APART1" )
			End if

			sIdCour = "APART1" // #3
			idw_LstInter.SetItem ( lCpt, "ID_COUR", sIdCour )  //#3
			idw_LstInter.SetItem ( lCpt, "ALT_VALIDE", "O" )

			/*------------------------------------------------------------------*/
			/* #1 : Gestion des cas particulier (Must et Orange pour l'instant) */
			/* Gestion des courriers types et attribution des codes courriers   */
			/* ORANGE.																			  */
			/*------------------------------------------------------------------*/
			sIdNatCour = idw_LstInter.GetItemString ( lCpt, "ID_NAT_COUR" )
			If idw_LstInter.GetItemString ( lCpt, "ID_COUR" ) = "APART1" Then
				sIdNatCour = "APART1"
			End If
			If sPos = "" Then sPos = uf_Determiner_CasParticulier ( sIdNatCour, iIdI )

			/* #5 [DCMP090629]
			
			// #3 Si présence d'une commande WEb on propose
			If sPos = "" Then
				This.uf_Determiner_Courrier_Forcage_WEB ( sPos, lCpt, sIdNatCour, sIdCour )
				If sPos <> "" Then Exit
			End If
			idw_LstInter.SetItem ( lCpt, "ID_NAT_COUR", sIdNatCour )
			idw_LstInter.SetItem ( lCpt, "ID_COUR", sIdCour )
			// /#3

			// #4 [O2M] Si présence d'une commande O2M on propose le courrier
			If sPos = "" Then
				This.uf_Determiner_Courrier_Forcage_O2M ( sPos, lCpt, sIdNatCour, sIdCour )
				If sPos <> "" Then Exit
			End If
			*/
			If sPos = "" Then
				This.uf_Determiner_Courrier_Forcage ( sPos, lCpt, sIdNatCour, sIdCour )
				If sPos <> "" Then Exit
			End If
			// Fin #5 [DCMP090629]
			
			idw_LstInter.SetItem ( lCpt, "ID_NAT_COUR", sIdNatCour )
			idw_LstInter.SetItem ( lCpt, "ID_COUR", sIdCour )
			// /#4


			/*------------------------------------------------------------------*/
			/* #2 : Ici on arme les droits de modification du courrier.         */
			/*------------------------------------------------------------------*/
			This.uf_Determiner_Courrier_MajDroit ( sIdNatCour, iIdI, aiDroitInter )

			Continue
		End If

/*------------------------------------------------------------------*/
/* Si le gestionnaire veut envoyer un courrier prédéterminé         */
/* (ALT_COUR_GEST = 'R'), les zones ID_NAT_COUR et ID_COUR sont     */
/* déjà positionnées. ( Uf_Zn_IdNatCour dans U_Gs_Interlocuteur)    */
/*------------------------------------------------------------------*/
		sAltCourGest = idw_LstInter.GetItemString ( lCpt, "ALT_COURGEST" )
		If	sAltCourGest = "R"	Then 

			sIdCour = idw_LstInter.GetItemString ( lCpt, "ID_COUR" ) // #3
			idw_LstInter.SetItem ( lCpt, "ID_COUR", sIdCour )  //#3
			idw_LstInter.SetItem ( lCpt, "ALT_VALIDE", "O" )
			
			/*------------------------------------------------------------------*/
			/* #1 : Gestion des cas particulier (Must et Orange pour l'instant) */
			/* Gestion des courriers types et attribution des codes courriers   */
			/* ORANGE.																			  */
			/*------------------------------------------------------------------*/
			sIdNatCour = idw_LstInter.GetItemString ( lCpt, "ID_NAT_COUR" )
			If idw_LstInter.GetItemString ( lCpt, "ID_COUR" ) = "APART1" Then
				sIdNatCour = "APART1"
			End If
			If sPos = "" Then sPos = uf_Determiner_CasParticulier ( sIdNatCour, iIdI )

			/* #5 [DCMP090629]
			
			// #3 Si présence d'une commande WEb on propose
			If sPos = "" Then
				This.uf_Determiner_Courrier_Forcage_WEB ( sPos, lCpt, sIdNatCour, sIdCour )
				If sPos <> "" Then Exit
			End If
			idw_LstInter.SetItem ( lCpt, "ID_NAT_COUR", sIdNatCour )
			idw_LstInter.SetItem ( lCpt, "ID_COUR", sIdCour )
			// /#3

			// #4 [O2M], Si présence d'une commande O2M on propose un courrier
			If sPos = "" Then
				This.uf_Determiner_Courrier_Forcage_O2M ( sPos, lCpt, sIdNatCour, sIdCour )
				If sPos <> "" Then Exit
			End If*/
			If sPos = "" Then
				This.uf_Determiner_Courrier_Forcage ( sPos, lCpt, sIdNatCour, sIdCour )
				If sPos <> "" Then Exit
			End If
			// Fin #5 [DCMP090629]
			
			idw_LstInter.SetItem ( lCpt, "ID_NAT_COUR", sIdNatCour )
			idw_LstInter.SetItem ( lCpt, "ID_COUR", sIdCour )
			// #4

			/*------------------------------------------------------------------*/
			/* #2 : Ici on arme les droits de modification du courrier.         */
			/*------------------------------------------------------------------*/
			This.uf_Determiner_Courrier_MajDroit ( sIdNatCour, iIdI, aiDroitInter )

			Continue
		End If

/*------------------------------------------------------------------*/
/* On va calculer la zone ID_NAT_COUR dans les autres cas. Cette    */
/* zone se décompose en 6 caractères.                               */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* 1er Caractère :                                                  */
/*------------------------------------------------------------------*/
	sCar1 = idw_LstInter.GetItemString ( lCpt, "COD_INTER" )

/*------------------------------------------------------------------*/
/* 2éme Caractère :                                                 */
/*------------------------------------------------------------------*/
	sCar2 = "C"

/*------------------------------------------------------------------*/
/* 3éme Caractère :                                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Pour information, la zone COD_MODE_REG est obligatoire si        */
/* MT_A_REG est supérieur à zéro. (Uf_Controler_Saisie dans         */
/* U_Gs_Sinistre)                                                   */
/*------------------------------------------------------------------*/
	sCodModeReg = idw_LstInter.GetItemString ( lCpt, "COD_MODE_REG" )
	dcMtaReg		= idw_LstInter.GetItemNumber ( lCpt, "MT_A_REG" )

	If			sCodModeReg = "C" And dcMtaReg > 0	Then
				sCar3 = "C"
	ElseIf	sCodModeReg = "VA" And dcMtaReg > 0	Then
				sCar3 = "V"
	ElseIf	dcMtaReg = 0	Then
				sCar3 = "0"
	End If
	
/*------------------------------------------------------------------*/
/* 4éme Caractère :                                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Réclame t-on au moins une pièce à l'interlocuteur au niveau de   */
/* la garantie. ?                                                   */
/*------------------------------------------------------------------*/
	sRech		= "ID_I = " + String ( iIdI ) + " And ID_DETAIL = -1"
	lLig = idw_wPiece.Find ( sRech, 1, lTotPce )

	If	lLig = 0	Then
/*------------------------------------------------------------------*/
/* Réclame t-on au moins une pièce à l'interlocuteur au niveau de   */
/* l'un des détails en voulant la faire apparaitre dans le          */
/* courrier. (ALT_COUR='O'). ?                                      */
/*------------------------------------------------------------------*/
		sRech		= "ID_I = " + String ( iIdI ) + " And ID_DETAIL <> -1"
		lLigDeb	= 1

		Do While	lLigDeb <= lTotPce
			lLig = idw_wPiece.Find ( sRech, lLigDeb, lTotPce )

			If	lLig = 0 Then Exit

/*------------------------------------------------------------------*/
/* On vient de trouver une ligne dans wPiece, on vérifie pour le    */
/* détail correspondant si le gestionnaire veut voir le paragraphe  */
/* apparaître.                                                      */
/*------------------------------------------------------------------*/
			lIdGti		= idw_wPiece.GetItemNumber ( lLig, "ID_GTI" )
			lIdDetail	= idw_wPiece.GetItemNumber ( lLig, "ID_DETAIL" )
			sRechDetail	= "ID_GTI = " + String ( lIdGti ) + " And ID_DETAIL = " + String ( lIdDetail ) + " And ALT_COUR = 'O'"
		
			lLigDetail	= idw_wDetail.Find ( sRechDetail, 1, lTotDetail )
/*------------------------------------------------------------------*/
/* On vient de trouver le détail correspondant à la pièce. Le       */
/* gestionnaire veut le faire apparaître sur le courrier.           */
/*------------------------------------------------------------------*/
			If	lLigDetail <> 0 Then Exit
/*------------------------------------------------------------------*/
/* Sinon on continue à boucler sur les pièces.                      */
/*------------------------------------------------------------------*/
			lLigDeb	= lLig + 1
			lLig		= 0
			
		Loop
	End If

	If	lLig > 0 Or idw_LstInter.GetItemString ( lCpt, "ALT_PCE" ) = "O"	Then
		sCar4 = "P"
	Else
		sCar4 = "0"
	End If

/*------------------------------------------------------------------*/
/* 5éme Caractère :                                                 */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Y a t-il un refus de coché pour l'interlocuteur au niveau de la  */
/* garantie ?. Cette garantie doit être en cours de validation.     */
/*------------------------------------------------------------------*/
	sRech		= "ID_I = " + String ( iIdI ) + " And ID_DETAIL = -1"
	lLigDeb	= 1
	lLig		= 0

	Do While	lLigDeb <= lTotRefus
		lLig = idw_wRefus.Find ( sRech, lLigDeb, lTotRefus )

/*------------------------------------------------------------------*/
/* On ne trouve pas de refus pour la garantie.                      */
/*------------------------------------------------------------------*/
		If	lLig = 0 Then Exit

/*------------------------------------------------------------------*/
/* On vient de trouver un refus pour la garantie. On va vérifier    */
/* que cette garantie est en cours de validation.                   */
/*------------------------------------------------------------------*/
		lIdGti		= idw_wRefus.GetItemNumber ( lLig, "ID_GTI" )
		sRechGti		= "ID_GTI = " + String ( lIdGti ) + " And ALT_VALIDE = 'O'"
		
		lLigGti		= idw_LstGti.Find ( sRechGti, 1, lTotGti )

/*------------------------------------------------------------------*/
/* On vient de trouver la garantie.                                 */
/*------------------------------------------------------------------*/
		If	lLigGti <> 0 Then 
			lLig = lLigGti
			Exit
		End If

/*------------------------------------------------------------------*/
/* On continue à boucler sur les refus des garanties.               */
/*------------------------------------------------------------------*/
		lLigDeb	= lLig + 1
		lLig		= 0
	Loop

/*------------------------------------------------------------------*/
/* Y a t-il un refus de coché pour l'interlocuteur au niveau de     */
/* l'un des détails en voulant le faire apparaitre dans le          */
/* courrier (ALT_COUR = 'O'). ?                                     */
/*------------------------------------------------------------------*/
	If	lLig = 0	Then

		sRech		= "ID_I = " + String ( iIdI ) + " And ID_DETAIL <> -1"
		lLigDeb	= 1
		
		Do While	lLigDeb <= lTotRefus
			lLig = idw_wRefus.Find ( sRech, lLigDeb, lTotRefus )

/*------------------------------------------------------------------*/
/* On ne trouve pas de refus pour les détails.                      */
/*------------------------------------------------------------------*/
			If	lLig = 0 Then Exit

/*------------------------------------------------------------------*/
/* On vient de trouver un refus pour un détail. On va vérifier      */
/* que ce détail est en cours de validation et que le  gestionnaire */
/* veut faire apparaitre le paragraphe de refus.                    */
/*------------------------------------------------------------------*/
			lIdGti		= idw_wRefus.GetItemNumber ( lLig, "ID_GTI" )
			lIdDetail	= idw_wRefus.GetItemNumber ( lLig, "ID_DETAIL" )
			sRechDetail	= "ID_GTI = " + String ( lIdGti ) + " And ID_DETAIL = " + String ( lIdDetail ) + " And ALT_COUR = 'O' And ALT_VALIDE = 'O'"
		
			lLigDetail	= idw_wDetail.Find ( sRechDetail, 1, lTotDetail )

/*------------------------------------------------------------------*/
/* On vient de trouver le détail.                                   */
/*------------------------------------------------------------------*/
			If	lLigDetail <> 0 Then Exit

/*------------------------------------------------------------------*/
/* On continue à boucler sur les refus des détails.                 */
/*------------------------------------------------------------------*/

			lLigDeb	= lLig + 1
			lLig		= 0
		Loop
	End If

	If	lLig > 0 Then
		sCar5 = "R"
	Else
		sCar5 = "0"
	End If

/*------------------------------------------------------------------*/
/* 6éme Caractère :                                                 */
/*------------------------------------------------------------------*/
	Choose Case idw_LstInter.GetItemString ( lCpt, "COD_INTER" ) + isCodeIProv

/*------------------------------------------------------------------*/
/* Ecrit = Assuré, Recu = Assuré                                    */
/* Ecrit = Banque, Recu = Banque                                    */
/*------------------------------------------------------------------*/
	Case "AA", "BB"
		If	sAltCourGest = "D"	Then
			sCar6 = "4"
		Else
			sCar6 = "1"
		End If

/*------------------------------------------------------------------*/
/* Ecrit = Assuré, Recu = Banque                                    */
/* Ecrit = Banque, Recu = Assuré                                    */
/*------------------------------------------------------------------*/
	Case "AB", "BA"
		If	sAltCourGest = "D"	Then
			sCar6 = "5"
		Else
			sCar6 = "2"
		End If

/*------------------------------------------------------------------*/
/* Ecrit = Assuré, Recu = Autre                                     */
/* Ecrit = Banque, Recu = Autre                                    */
/*------------------------------------------------------------------*/
	Case "AT", "BT"
		If	sAltCourGest = "D"	Then
			sCar6 = "3"
		Else
			sCar6 = "0"
		End If

/*------------------------------------------------------------------*/
/* Ecrit = Autre,  Recu = Assuré                                    */
/* Ecrit = Autre,  Recu = Banque                                    */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Pas de gestion des doubles dans le cas d'un interlocuteur de     */
/* type AUTRE                                                       */
/*------------------------------------------------------------------*/
	Case "TA", "TB"
		sCar6 = "2"

/*------------------------------------------------------------------*/
/* Ecrit = Autre,  Recu = Autre                                     */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Pas de gestion des doubles dans le cas d'un interlocuteur de     */
/* type AUTRE                                                       */
/*------------------------------------------------------------------*/
	Case "TT"
		sCar6 = "0"

	End Choose

/*------------------------------------------------------------------*/
/* 6éme Caractère : Remplacement dans le cas d'un refus             */
/*------------------------------------------------------------------*/
/* #1 Cette partie n'a jamais servi puisqueune erreur existe depuis */
/* l'origine visible "=2000" au lieu de "=200". Personne ne s'étant */
/* jamais plaind, je récupère la série de chiffre de 6 à B pour un  */
/* autre usage. JFF																  */
/*------------------------------------------------------------------*/
/* DEBUT DU SHUNT
	If	idw_wSin.GetItemNumber ( 1, "COD_ETAT" ) = 2000 And sCar5 = "R"	Then
		Choose Case sCar6
		Case "0"
			sCar6 = "6"

		Case "1"
			sCar6 = "7"

		Case "2"
			sCar6 = "8"

		Case "3"
			sCar6 = "9"

		Case "4"
			sCar6 = "A"

		Case "5"
			sCar6 = "B"
		End Choose

	End If
FIN DU SHUNT */

/*------------------------------------------------------------------*/
/* On va maintenant déterminer si l'on doit envoyer un courrier.    */
/*------------------------------------------------------------------*/
	bEnvoiCourrier	= True

	If ( sCar3 + sCar4 + sCar5 ) = "000"	Then
/*------------------------------------------------------------------*/
/* Y a t-il au moins un paragraphe d'information réclamé pour       */
/* l'interlocuteur. ?                                               */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Y a t-il un post-scriptum de saisi pour l'interlocuteur ?.       */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Y a t-il un double de courrier à envoyer ?                       */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Y a t-il une demande de pièce jointe ?                           */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On teste ALT_COURGEST, au lieu de ID_I_DB ou ID_COURJ, car       */
/* cette zone est testée sur Uf_Controler_Saisie de                 */
/* U_Gs_Sp_Interlocuteur.                                           */
/*------------------------------------------------------------------*/

		bEnvoiCourrier = False

		sRech				= "ID_I = " + String ( iIdI )
		lLig 				= idw_wParaInfo.Find ( sRech, 1, lTotParaInfo )

		If	lLig > 0																					Or	&
			idw_LstInter.GetItemString ( lCpt, "ALT_PS" ) = "O"						Or	&
			idw_LstInter.GetItemString ( lCpt, "ALT_COURGEST" ) = "D"				Or	&
			idw_LstInter.GetItemString ( lCpt, "ALT_COURGEST" ) = "J"	Then
			bEnvoiCourrier = True
		End If
	End If

	If	bEnvoiCourrier	Then
		sIdNatCour = sCar1 + sCar2 + sCar3 + sCar4 + sCar5 + sCar6

/*------------------------------------------------------------------*/
/* #1 : Gestion des cas particulier (Must et Orange pour l'instant) */
/* !! Attention !! au retour de cette fonction, la nature du        */
/* a pu être modifiée en W.....												  */
/*------------------------------------------------------------------*/
		If sPos = "" Then sPos = uf_Determiner_CasParticulier ( sIdNatCour, iIdI )

/*------------------------------------------------------------------*/
/* Dans la fonction Uf_Preparer_Modifier, on arme la table          */
/* courrier (Zne ID_NAT_COUR et ID_COUR) pour le produit            */
/* correspondant, il ne reste donc plus qu'a faire un find.         */
/*------------------------------------------------------------------*/
		idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
		lTotCourrier	= dwChild.RowCount ()
		sRech				= "ID_NAT_COUR = '" + sIdNatCour + "'"
		lLig				= dwChild.Find ( sRech, 1, lTotCourrier )

/*------------------------------------------------------------------*/
/* On verifie si la nature de courrier existe. Si elle n'existe     */
/* pas, par un effet du hasard bien sur, on arrete le traitement    */
/* et on positionne sur REF_CIE.                                    */
/*------------------------------------------------------------------*/
		// [DT133_CASTO]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_wSin.Getitemnumber( 1, "ID_PROD"), "-DP", 43 )
		// Sur Casto, l'inter B est forcément l'inter Casto (Hors inter fournisseur)
		If lDeb > 0 And sCodInter = "B" Then

			sTabPce [1]= "316"
			sTabPce [2]= "314"
			sTabPce [3]= "48"
			sTabPce [4]= "315"
			sTabPce [5]= "385"
			sTabPce [6]= "386"
			sTabPce [7]= "588"
			
			lTotTabPce = Upperbound ( sTabPce )
			For lCptTabPce = 1 To lTotTabPce 
				lRow = idw_wPiece.Find ( "ID_PCE=" + sTabPce [ lCptTabPce ] + "AND ID_I = " + String ( iIdi ), 1, idw_wPiece.Rowcount ())
				If lRow > 0 Then
					sIdNatCour	= stNul.str
					sIdCour		= stNul.str						
					bCasCastoDT133 = TRUE
					
					lRow = idw_WDivSin.Find ( "UPPER ( NOM_ZONE ) = 'PCE_MAIL_CASTO'", 1,  idw_WDivSin.RowCount () )
					If lRow > 0 Then
						This.uf_gestong_divers_majzone( "PCE_MAIL_CASTO", lRow, K_MAJZONE, "O" )
					End If

					sSavTitre = stMessage.sTitre 
					stMessage.sTitre = "Information DT133"
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= Information!
					stMessage.sCode		= "WSIN784"
					F_Message ( stMessage )

					stMessage.sTitre = sSavTitre
					
					Exit
				End IF
			Next
		End If			

		// [DT133_CASTO] And Not bCasCastoDT133 
		If	lLig = 0	And Not bCasCastoDT133 Then

/*------------------------------------------------------------------*/
/* On arme la structure de message maintenant, mais le message va   */
/* être affiché dans le contrôle de gestion.                        */
/*------------------------------------------------------------------*/
			stMessage.bErreurG	= FALSE
			stMessage.Icon			= Information!
			stMessage.sCode		= "WSIN170"
			stMessage.sVar[1] 	= sIdNatCour
			sPos = "REF_CIE"

			Exit
		End If		

		// [DT133_CASTO]
		If Not bCasCastoDT133 Then
			sIdCour			= dwChild.GetItemString ( lLig, "ID_COUR" )
		End If

	Else
		sIdNatCour	= stNul.str
		sIdCour		= stNul.str
	End If

	/* #5 [DCMP090629]
	
	// #3 Si présence d'une commande WEb on propose
	If sPos = "" Then
		This.uf_Determiner_Courrier_Forcage_WEB ( sPos, lCpt, sIdNatCour, sIdCour )
		If sPos <> "" Then Exit
	End If
	// /#3
	idw_LstInter.SetItem ( lCpt, "ID_NAT_COUR", sIdNatCour )
	idw_LstInter.SetItem ( lCpt, "ID_COUR", sIdCour )

	// #4 [O2M] Si présence d'une commande O2M on propose un courrier
	If sPos = "" Then
		This.uf_Determiner_Courrier_Forcage_O2M ( sPos, lCpt, sIdNatCour, sIdCour )
		If sPos <> "" Then Exit
	End If
	// #4*/
	
	If sPos = "" Then
		This.uf_Determiner_Courrier_Forcage ( sPos, lCpt, sIdNatCour, sIdCour )
		If sPos <> "" Then Exit
	End If
	// Fin #5 [DCMP090629]
	
	idw_LstInter.SetItem ( lCpt, "ID_NAT_COUR", sIdNatCour )
	idw_LstInter.SetItem ( lCpt, "ID_COUR", sIdCour )

/*------------------------------------------------------------------*/
/* #2 : Ici on arme les droits de modification du courrier.         */
/*------------------------------------------------------------------*/
	This.uf_Determiner_Courrier_MajDroit ( sIdNatCour, iIdI, aiDroitInter )

/*------------------------------------------------------------------*/
/* On positionne la zone ALT_VALIDE à OUI et cela dans tous les     */
/* cas. Donc on validera toujours l'interlocuteur.                  */
/*------------------------------------------------------------------*/
	idw_LstInter.SetItem ( lCpt, "ALT_VALIDE", "O" )


Next

/*------------------------------------------------------------------*/
/* On va déterminer si on veut envoyer à un interlocuteur le        */
/* double d'un courrier vide.                                       */
/*------------------------------------------------------------------*/
For	lCpt = 1 To lTotInter
		If	idw_LstInter.GetItemString ( lCpt, "ALT_COURGEST" ) = "D"	Then
			lIdIDb = idw_LstInter.GetItemNumber ( lCpt, "ID_I_DB" )
			sRech = "ID_I = " + String ( lIdIDb ) + " And Not IsNull ( ID_NAT_COUR )"

			lLig	= idw_LstInter.Find ( sRech, 1, lTotInter )
			If	lLig = 0	Then
				sRech = "ID_I = " + String ( lIdIDb )
				lLig	= idw_LstInter.Find ( sRech, 1, lTotInter )

				stMessage.bErreurG	= FALSE
				stMessage.Icon			= StopSign!
				stMessage.sCode		= "WSIN190"

				stMessage.sVar[1] 	= idw_LstInter.GetItemString ( lLig, "NOM" )
				stMessage.sVar[2] 	= idw_LstInter.GetItemString ( lCpt, "NOM" )

				sPos = "REF_CIE"
			End If
		End If

Next


Return ( sPos )



end function

private subroutine uf_determiner_courrier_majdroit (string asidnatcour, integer aiidi, ref integer aidroitinter[]);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_MajDroit (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 31/03/2004 16:37:24
//* Libellé       : On met à jour le tableau de des droits de modifications des courriers.
//* Commentaires  : 
//*
//* Arguments     : String			asIdNatCour			Val
//*					  Integer		aiIdi					Val
//*					  Integer		aidroitinter[]		Réf
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1   MADM   31/07/2006	  Projet DNTMAIL1/2 Mails sortant en remplacement des courriers	
//*
//*-----------------------------------------------------------------

Boolean  bDroitModifCour, bVal
String 	sVal

/*------------------------------------------------------------------*/
/* Ici on arme les droits de modification du courrier.              */
/*------------------------------------------------------------------*/
If ibSaisieValidation And asIdNatCour <> "" Then
	
	/*------------------------------------------------------------------------------------------------*/
	/* #1 : Ajout du paramétre aiIdI (ID Inerlocuteur) suite modif  de la fonction uf_GetAutorisation */
	/*------------------------------------------------------------------------------------------------*/
	This.uf_GetAutorisation ( asIdNatCour, sVal, bDroitModifCour, bVal, bVal, aiIdI )
	If bDroitModifCour Then
		aiDroitInter [ aiIdI + 1 ] = 1
	Else
		aiDroitInter [ aiIdI + 1 ] = -1
	End If
End If

end subroutine

private subroutine uf_initialiser_sign_personnalisee ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Initialiser_SigElec (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 05/04/2004 17:03:43
//* Libellé       : Gestion de la signature électronique.
//* Commentaires  : 
//*
//* Arguments     : Aucun
//*
//* Retourne      : Rien 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1   MADM   31/07/2006	  Projet DNTMAIL1/2 Mails sortant en remplacement des courriers	
//*
//*-----------------------------------------------------------------

String sRepSig, sFmtSig, sFic, sBin
Boolean bVal, bDroitSigElec, bAucuneSignature

/*------------------------------------------------------------------*/
/* On utilise cette fonctionnalité qu'en SVE                        */
/*------------------------------------------------------------------*/
If Not ibSaisieValidation Then Return

/*------------------------------------------------------------------*/
/* Le droit 11 (Aucune signature) est-il paramètré ?					  */
/*------------------------------------------------------------------*/
/*----------------------------------------------------------------------------------------------*/
/* #1 : Ajout du paramétre -1 de l'interlocuteur suite modif  de la fonction uf_GetAutorisation */
/*----------------------------------------------------------------------------------------------*/
This.uf_GetAutorisation ( "", sBIN, bVal, bVal, bVal, -1 )
bAucuneSignature = Mid ( sBIN, 11, 1 ) = "1" 

/*------------------------------------------------------------------*/
/* Initialisation du le signature électronique.                     */
/*------------------------------------------------------------------*/
sRepSig	= ProfileString ( stGLB.sFichierIni, "EDITION", "REP_SIGNATURE", "K:\SIGNPERS\" )
sFmtSig	= ProfileString ( stGLB.sFichierIni, "EDITION", "FMT_SIGNATURE", "TIF" )

/*------------------------------------------------------------------*/
/* Bitmap blanc si aucune signature demandée.                       */
/*------------------------------------------------------------------*/
If bAucuneSignature Then
	isFicSig = sRepSig + "BLANC." + sFmtSig
End If

If Not bAucuneSignature Then
	/*------------------------------------------------------------------*/
	/* Immediatement par défaut on alloue une signature SPB             */
	/*------------------------------------------------------------------*/
	isFicSig = sRepSig + "DEFAUT." + sFmtSig

	/*------------------------------------------------------------------*/
	/* y a-t-il alors une signature par défaut pour ce produit ? 		  */
	/*------------------------------------------------------------------*/
	sFic = sRepSig + String ( idw_Wsin.GetItemNumber ( 1, "ID_PROD" )) + "\DEFAUT." + sFmtSig
//Migration PB8-WYNIWYG-03/2006 FM
//	If FileExists ( sFic ) Then
	If f_FileExists ( sFic ) Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
		isFicSig = sFic
	End If

	/*------------------------------------------------------------------*/
	/* Le Gestionnaire a-t-il le droit d'utiliser la signature          */
	/* personnalisée ?                                                  */
	/*------------------------------------------------------------------*/
	/*----------------------------------------------------------------------------------------------*/
	/* #1 : Ajout du paramétre -1 de l'interlocuteur suite modif  de la fonction uf_GetAutorisation */
	/*----------------------------------------------------------------------------------------------*/
	This.uf_GetAutorisation ( "", sBIN, bVal, bVal, bVal, -1 )
	bDroitSigElec = Mid ( sBIN, 8, 1 ) = "1" 

	If bDroitSigElec Then

		sFic = sRepSig + stglb.sCodOper + "." + sFmtSig

		/*------------------------------------------------------------------*/
		/* Si le fichier n'existe pas, on affecte une signature par défaut. */
		/*------------------------------------------------------------------*/
//Migration PB8-WYNIWYG-03/2006 FM
//		If Not FileExists ( sFic ) Then
		If Not f_FileExists ( sFic ) Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
			stMessage.sCode	= "SVE0030"
			stMessage.sTitre	= "Signature Electronique"
			stMessage.Icon		= Information!
			stMessage.sVar[1] = stglb.sCodOper

			f_Message ( stMessage )	

		Else 	
			isFicSig = sFic
		End If

	End If
End If
/*------------------------------------------------------------------*/
/* On remplace "\" par "\\" pour interprétation correcte dans word  */
/*------------------------------------------------------------------*/
isFicSig  = F_Remplace ( isFicSig, "\", "\\" )


end subroutine

public function boolean uf_getautorisation2 (long aliddroit);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GetAutorisation2 (PUBLIC)
//* Auteur        : Fabry JF
//* Date          : 04/06/2004 12:59:19
//* Libellé       : Lecture simple d'une autorisation
//* Commentaires  : 
//*
//* Arguments     : Long	alDroit		Val
//*
//* Retourne      : Boolean  TRUE, on a le droit
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

String sIdProd, sFindOrig, sFindOrig1

sIdProd = String ( idw_wsin.GetItemNumber ( 1, "ID_PROD" ) )

sFindOrig   = "ID_OPER = '" + Upper ( stGlb.sCodOper ) + "' AND " + &
				  "ID_NAT_OPER = " + String ( alIdDroit ) + " AND ID_PROD = " + sIdProd

sFindOrig1   = "ID_OPER = '" + Upper ( stGlb.sCodOper ) + "' AND " + &
				  "ID_NAT_OPER = " + String ( alIdDroit ) + " AND ID_PROD = -1"


Return idw_Autorisation.Find ( sFindOrig   , 1, idw_Autorisation.RowCount() )  > 0 Or &
	    idw_Autorisation.Find ( sFindOrig1  , 1, idw_Autorisation.RowCount() )  > 0


end function

private subroutine uf_gestong_divers ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GestOng_Divers (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 16/06/2004 11:13:57
//* Libellé       : Gestion de l'onglet DIVERS
//* Commentaires  : 
//*
//* Arguments     : 
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*		FPI	08/08/2012	[VDoc8516]
//*-----------------------------------------------------------------

Long lTotParam, lCptParam, lCptDivS, lRowDS, lRowDP, lTotDivS, lNull, lCptVal, lTotVal, lRowChild
String	sNomZoneP, sNomZoneS, sIdTypListe, sNull, sAltLstCodeCar 
Decimal  dcNull
Date		dNull
DateTime dtNull
DataWindowChild	dwChildCodeCar, dwChildCode
Long lDeb, lFin
String sVal
n_cst_string nvString

SetNull ( dNull )
SetNull ( lNull )
SetNull ( sNull )
SetNull ( dcNull )
SetNull ( dtNull ) // [PI056].20190926

/*------------------------------------------------------------------*/
/* Affichage des lignes se trouvant dans la dw de param dw_div_pro. */
/*------------------------------------------------------------------*/
lTotParam = idw_DivPro.RowCount ()
lTotDivS  = idw_wDivSin.RowCount ()

If isTypeTrt = "S" Then
	For lCptParam = 1 To lTotParam

		sNomZoneP = Lower ( idw_DivPro.GetItemString ( lCptParam, "NOM_ZONE" ) )

		lRowDS	 = idw_wDivSin.Find ( "Lower ( NOM_ZONE ) = '" + sNomZoneP + "'", 1, lTotDivS ) 

	/*------------------------------------------------------------------*/
	/* Le row n'est pas trouvé, donc on l'insère                        */
	/*------------------------------------------------------------------*/
		If lRowDS <= 0 Then
			lRowDS = idw_wDivSin.InsertRow (0)

			idw_wDivSin.SetItem ( lRowDS, "ID_SIN", idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )
			idw_wDivSin.SetItem ( lRowDS, "NOM_ZONE", sNomZoneP )
			idw_wDivSin.SetItem ( lRowDS, "LIB_LABEL", idw_DivPro.GetItemString ( lCptParam, "LIB_LABEL" ) )
			idw_wDivSin.SetItem ( lRowDS, "ID_TYP_LISTE", idw_DivPro.GetItemString ( lCptParam, "ID_TYP_LISTE" ) )
			idw_wDivSin.SetItem ( lRowDS, "ALT_LISTE_CODECAR", idw_DivPro.GetItemString ( lCptParam, "ALT_LISTE_CODECAR" ) )
			idw_wDivSin.SetItem ( lRowDS, "ID_TYP_ZONE", idw_DivPro.GetItemString ( lCptParam, "ID_TYP_ZONE" ) )
			idw_wDivSin.SetItem ( lRowDS, "ALT_OBLIG", idw_DivPro.GetItemString ( lCptParam, "ALT_OBLIG" ) )
			idw_wDivSin.SetItem ( lRowDS, "ALT_PROT", "N" )
			idw_wDivSin.SetItem ( lRowDS, "CPT_TRI", idw_DivPro.GetItemNumber ( lCptParam, "CPT_TRI" ) )
			idw_wDivSin.SetItem ( lRowDS, "VAL_DTE", dtNull )	// [PI056].20190926
			idw_wDivSin.SetItem ( lRowDS, "VAL_CAR", sNull )
			idw_wDivSin.SetItem ( lRowDS, "VAL_NBRE", lNull )
			idw_wDivSin.SetItem ( lRowDS, "VAL_MT", dcNull )
			idw_wDivSin.SetItem ( lRowDS, "ALT_SUPP", "O" )
			idw_wDivSin.SetItem ( lRowDS, "CREE_LE", DateTime ( Today (), Now () ) )
			idw_wDivSin.SetItem ( lRowDS, "MAJ_LE", DateTime ( Today (), Now () ) )
			idw_wDivSin.SetItem ( lRowDS, "MAJ_PAR", stGlb.sCodOper )

			Choose Case idw_DivPro.GetItemString ( lCptParam, "ID_TYP_ZONE" )
				Case "P", "S"
					idw_wDivSin.SetItem ( lRowDS, "VAL_MT", 0 )
				Case "N"
					idw_wDivSin.SetItem ( lRowDS, "VAL_NBRE", 0 )
				Case "X"
					idw_wDivSin.SetItem ( lRowDS, "VAL_CAR", "N" )
			End Choose 

			//[CRAO_LOT1] Rationalisation utilisation de fonction de maj de zone onglet divers.
			//This.uf_GestOng_Divers_DefautZone ( sNomZoneP , idw_wSin.GetItemNumber ( 1, "ID_PROD" ), lRowDS )
			// remplacé par :
			This.uf_GestOng_Divers_MajZone ( sNomZoneP , lRowDS, K_DEFAUT, '' )
			
			// [VDoc8516]
			f_rechdetpro (lDeb, lFin, idw_detpro,idw_wsin.getitemnumber(1,"ID_PROD"), "-DP", 216)
			if lDeb > 0 Then
				
				sVal=idw_detpro.GetItemString(lDeb, "VAL_CAR")
				sVal=nvString.of_getkeyvalue( sVal, Upper(sNomZoneP) , ";")
				
				If sVal <> "" Then
					Choose Case idw_DivPro.GetItemString ( lCptParam, "ID_TYP_ZONE" )
					Case "P", "S"
						idw_wDivSin.SetItem ( lRowDS, "VAL_MT", Dec(sVal) )
					Case "N"
						idw_wDivSin.SetItem ( lRowDS, "VAL_NBRE", Long(sVal) )
					Case "X"
						idw_wDivSin.SetItem ( lRowDS, "VAL_CAR", sVal)
					Case  "LC" // [PC925] - Mantis 10605
						If  idw_DivPro.GetItemString ( lCptParam, "ALT_LISTE_CODECAR" )="N" Then
							idw_wDivSin.SetItem ( lRowDS, "VAL_NBRE", Long(sVal) )
						Else
							idw_wDivSin.SetItem ( lRowDS, "VAL_CAR", sVal)
						End if
					End Choose 
				End if
				
			End if

		End If
	Next
End If
/*------------------------------------------------------------------*/
/* Suite à l'insertion dans idw_wDivSin des lignes manquantes, on   */
/* les mets maintenant à jour si besoin.                            */
/*------------------------------------------------------------------*/
lTotDivS  = idw_wDivSin.RowCount ()

idw_wDivSin.GetChild ( "VAL_LST_CAR", dwChildCodeCar )
dwChildCodeCar.Reset ()

idw_wDivSin.GetChild ( "VAL_LST_NBRE", dwChildCode )
dwChildCode.Reset ()


For lCptDivS = 1 To lTotDivS
	sIdTypListe = idw_wDivSin.GetItemString ( lCptDivS, "ID_TYP_LISTE" ) 

/*---------------------------------------------------------------------*/
/* Liste à charger : Cette Technique de chargement permet d'utiliser   */
/* plusieurs liste du même type (liste de code_car par exemple)		  */
/*---------------------------------------------------------------------*/
	If sIdTypListe <> "-1" Then
		sAltLstCodeCar = idw_wDivSin.GetItemString ( lCptDivS, "ALT_LISTE_CODECAR" ) 
		Choose Case sAltLstCodeCar 

			// Retrieve sur Code_Car
			Case "O"

				idddw_CodeCar_wDivSin_Charg_Tempo.Retrieve ( sIdTypListe )

				This.uf_GestOng_Divers_CasPart_Liste ( idw_wDivSin.GetItemString ( lCptDivS, "NOM_ZONE" ), &
															idw_wSin.GetItemNumber ( 1, "ID_PROD" ) )

				lTotVal = idddw_CodeCar_wDivSin_Charg_Tempo.RowCount ()
							
				For lCptVal = 1 To lTotVal
					lRowChild = dwChildCodeCar.InsertRow ( 0 )
					dwChildCodeCar.SetItem ( lRowChild, "ID_CODE", idddw_CodeCar_wDivSin_Charg_Tempo.GetItemString ( lCptVal, "ID_CODE" ) )
					dwChildCodeCar.SetItem ( lRowChild, "LIB_CODE", idddw_CodeCar_wDivSin_Charg_Tempo.GetItemString ( lCptVal, "LIB_CODE" ) )
					dwChildCodeCar.SetItem ( lRowChild, "NOM_ZONE", idw_wDivSin.GetItemString ( lCptDivS, "NOM_ZONE" ) )
					dwChildCodeCar.SetItem ( lRowChild, "ALT_VISIBLE", 2 ) 
				Next

			// Retrieve sur Code
			Case "N"			

				idddw_Code_wDivSin_Charg_Tempo.Retrieve ( sIdTypListe )

				This.uf_GestOng_Divers_CasPart_Liste ( idw_wDivSin.GetItemString ( lCptDivS, "NOM_ZONE" ), &
															idw_wSin.GetItemNumber ( 1, "ID_PROD" ) )

				lTotVal = idddw_Code_wDivSin_Charg_Tempo.RowCount ()

				For lCptVal = 1 To lTotVal
					lRowChild = dwChildCode.InsertRow ( 0 )
					dwChildCode.SetItem ( lRowChild, "ID_CODE", idddw_Code_wDivSin_Charg_Tempo.GetItemNumber ( lCptVal, "ID_CODE" ) )
					dwChildCode.SetItem ( lRowChild, "LIB_CODE", idddw_Code_wDivSin_Charg_Tempo.GetItemString ( lCptVal, "LIB_CODE" ) )
					dwChildCode.SetItem ( lRowChild, "NOM_ZONE", idw_wDivSin.GetItemString ( lCptDivS, "NOM_ZONE" ) )
					dwChildCode.SetItem ( lRowChild, "ALT_VISIBLE", 2 ) 
				Next

		End Choose
	End If
Next

/*------------------------------------------------------------------*/
/* Il est impossible de protéger par 'protect=1' toutes lignes et   */
/* col d'une dw, au moins une zone doit avoir le focus.             */
/*------------------------------------------------------------------*/
If lTotDivS > 0 Then
	lRowDS = idw_wDivSin.InsertRow (0)
	idw_wDivSin.SetItem ( lRowDS, "ID_SIN", idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )
	idw_wDivSin.SetItem ( lRowDS, "NOM_ZONE", "X_TEMPO_X" )
	idw_wDivSin.SetItem ( lRowDS, "LIB_LABEL", "" )
	idw_wDivSin.SetItem ( lRowDS, "ID_TYP_ZONE", "X" )
	idw_wDivSin.SetItem ( lRowDS, "ALT_OBLIG", "N" )
	idw_wDivSin.SetItem ( lRowDS, "ALT_PROT", "N" )
	idw_wDivSin.SetItem ( lRowDS, "CPT_TRI", 10000 )
	idw_wDivSin.SetItem ( lRowDS, "VAL_CAR", "O" )

	idw_wDivSin.SetRow ( lRowDs )
End If


idw_wDivSin.Sort ()

This.uf_GestOng_Divers_CasPart_Finaux ()

/*------------------------------------------------------------------*/
/* Protection des zones dynamique de dw_w_Div_Sin en Validation.    */
/* Attention, on ne protége par le dernier élément déplacé à X=10000*/
/*------------------------------------------------------------------*/
If isTypeTrt <> "S" Then
	lTotDivS = idw_wDivSin.rowcount() - 1
	For lCptDivS = 1 to lTotDivS 
		idw_wDivSin.SetItem ( lCptDivS ,"ALT_PROT", "O" )
	Next
End If

idw_wDivSin.SetRow ( idw_wDivSin.rowcount())


end subroutine

private subroutine uf_terminervalider_wdivsin ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Terminer_Valider_wDivSin (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/06/2004 15:34:24
//* Libellé       : Maj de la Dw avant Update
//* Commentaires  : 
//*
//* Arguments     : 
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*
//*-----------------------------------------------------------------

Long lRow, lCpt, lTotRow

lTotRow = idw_wDivSin.RowCount ()

/*------------------------------------------------------------------*/
/* On supprime la zone 'X_TEMPO_X' ne servant à rien.               */
/*------------------------------------------------------------------*/
lRow = idw_wDivSin.Find ( "NOM_ZONE = 'X_TEMPO_X'", 1, lTotRow  )
If lRow > 0 Then idw_wDivSin.RowsDiscard ( lRow, lRow, Primary! )

lTotRow = idw_wDivSin.RowCount ()

/*------------------------------------------------------------------*/
/* On supprime toutes les zones créées qui n'ont pas été modifiée,  */
/* cela ne sert à rien de les intégrer en base.                     */
/*------------------------------------------------------------------*/
For lCpt = lTotRow To 1 Step -1
	Choose case idw_wDivSin.GetItemString ( lCpt, "ALT_SUPP" )
		Case "O"
			idw_wDivSin.RowsDiscard ( lCpt, lCpt, Primary! )
	End Choose 
Next


end subroutine

private function string uf_controlergestion_ongletdivers (ref string asong);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_ControlerGestion_OngletDivers (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 16/07/2004
//* Libellé			: Gestion du contrôle de saisie/gestion lié à l'onglet DIVERS
//* Commentaires	: 
//*
//* Arguments		: String			asOng					Réf
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    PHG      23/06/2009 [O2M_DIAG_NOMADE] controle pour reprise dossier Cds avant process O2M
//* #2	 FPI	 	23/10/2009	[EXPANSION5.LIBPOLICE] Ajout du -DP 124
//* #3    JFF      06/11/2009 [20091106201707453]
//* #4	FPI	 04/01/2010 [EXPANSION5.LIBPOLICE] Correction option 124 -> 130
//* #5	PHG    08/01/2010 [O2M_DIAG_NOMADE].Lot2
//*-----------------------------------------------------------------

String	sPos, sNouvelleLigne, sText, sCodeZone, sAide, sVal
Boolean	bTjsOblig, bDosAREG, bAltProt  
Long		lCodEtatSin, lIdProd, lCpt, lTotZoneSin, lTotZoneParam, lRow
long      lDeb, lFin // #1 [O2M_DIAG_NOMADE] 
String 	 sIdBoutique, sCodeErr // #2 [EXPANSION5.LIBPOLICE]
n_cst_attrib_key lnvKey[] //#5 [O2M_DIAG_NOMADE].Lot2
boolean bDp25_no_Aut	// #5 [OM2_DIAG_NOMADE].Lot2 	

sPos = ""
sAide = " (Onglet 'divers')"

// #2
sCodeErr=""

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 130  ) // #4 -DP 124 -> 130
If lDeb > 0 Then
	
	sIdBoutique = ""
	
	If idw_wDivSin.RowCount () > 0 Then
		lRow = idw_wDivSin.Find("nom_zone='id_boutique_adh'",1,idw_wdivsin.rowcount( ) )

		if lRow > 0 Then
			sIdBoutique = idw_wdivsin.getItemString(lRow,"VAL_CAR")
		End if
	End if
	
	If sIdBoutique =""  Or IsNull ( sIdBoutique ) Then
		// Boutique adh obligatoire
		sCodeErr = "WSIN682"
	Else
		// Contrôle boutique existante pour ce produit
		lRow = idw_boutique.find("COD_MAG='" + sIdBoutique + "'",1,idw_boutique.RowCount())
		if lRow <= 0 Then
			sCodeErr	= "WSIN683"
		End if
	End if			
	
	If sCodeErr <> "" Then 
		stMessage.sTitre		= "Contrôle de gestion"
		stMessage.bErreurG	= False
		stMessage.bouton = Ok!
		stMessage.Icon   = Exclamation!
		stMessage.sCode = sCodeErr
		F_Message (stMessage)

		sPos = "ALT_BLOC"
      asOng = "04"

		return sPos
	End if
End If	
//* :#2 [EXPANSION5.LIBPOLICE]

/*------------------------------------------------------------------*/
/* Si la dw des gestion renseignée, ne comporte aucune zone, on     */
/* ressort.                                                         */
/*------------------------------------------------------------------*/
If idw_wDivSin.RowCount () <= 0 Then Return ""

sNouvelleLigne		= "~r~n"
sText					= sNouvelleLigne
lIdProd 				= idw_Wsin.GetItemNumber ( 1, "ID_PROD" )

lTotZoneSin = idw_wDivSin.RowCount ()
lTotZoneParam = idw_DivPro.RowCount ()

/*------------------------------------------------------------------*/
/* Le dossier est-il à régler ?                                     */
/*------------------------------------------------------------------*/
bDosAREG = idw_wSin.GetItemNumber ( 1, "COD_ETAT" ) = 500

/*------------------------------------------------------------------*/
/* Pour chaque zone de l'onglet Divers affichée sur le dossier.     */
/*------------------------------------------------------------------*/
For lCpt = 1 To lTotZoneSin

/*------------------------------------------------------------------*/
/* id_code lib_code                                                 */
/* ------- -----------------------------------                      */
/* -1      Unité div_pro div_sin                                    */
/* C       Chaine                                                   */
/* D       Date                                                     */
/* LC      Liste de valeur CAR                                      */
/* LN      Liste de valeur NUM                                      */
/* N       Nombre                                                   */
/* P       Taux                                                     */
/* S       Montant                                                  */
/* X       Alt                                                      */
/*------------------------------------------------------------------*/
/* La donnée est-elle renseignée												  */
/*------------------------------------------------------------------*/
	Choose Case Upper ( idw_wDivSin.GetItemString ( lCpt, "ID_TYP_ZONE" ) )
		Case "C", "LC", "X"
			sVal = Trim ( idw_wDivSin.GetItemString ( lCpt, "VAL_CAR" ) )
		Case "D"
			sVal = Trim ( String ( idw_wDivSin.GetItemDateTime ( lCpt, "VAL_DTE" ))) // [PI056].20190926
		Case "N", "LN"
			sVal = Trim ( String ( idw_wDivSin.GetItemNumber ( lCpt, "VAL_NBRE" )))
			If Long ( sVal ) = 0 Then sVal = ""
		Case "P", "S"
			sVal = Trim ( String ( idw_wDivSin.GetItemDecimal ( lCpt, "VAL_MT" )))
			If Dec ( sVal ) = 0 Then sVal = ""
	End Choose

/*------------------------------------------------------------------*/
/* Si la donnée est renseignée, on passe au suivant.	              */
/*------------------------------------------------------------------*/
	If IsNull ( sVal ) Then sVal = ""
	If sVal <> "" Then Continue

	sCodeZone = Lower ( idw_wDivSin.GetItemString ( lCpt, "NOM_ZONE" ) )
	bAltProt  = idw_wDivSin.GetItemString ( lCpt, "ALT_PROT" ) = "O"

/*------------------------------------------------------------------*/
/* La zone trouvée sur le dossier a-t-elle (encore) un paramètrage  */
/* actif ?                                                          */
/*------------------------------------------------------------------*/
	lRow = idw_DivPro.Find ( "ID_PROD = " + String ( lIdProd ) + " AND NOM_ZONE = '" + sCodeZone + "'", 1, lTotZoneParam )

/*------------------------------------------------------------------*/
/* Si Oui, on récupére le param.                                    */
/*------------------------------------------------------------------*/
	If lRow > 0 Then
		bTjsOblig = idw_DivPro.GetItemString ( lRow, "ALT_OBLIG" ) = "O"
/*------------------------------------------------------------------*/
/* Sinon on le fixe par défaut.                                     */
/*------------------------------------------------------------------*/
	ELse
		bTjsOblig = FALSE
	End If 

/*------------------------------------------------------------------*/
/* !! AJOUTER les nlles zn à contrôler, ICI !!							  */
/*------------------------------------------------------------------*/
/* En fonction de la zone trouvée sur l'onglet Divers, on           */
/* déclenche un action.                                             */
/*------------------------------------------------------------------*/
	Choose Case sCodeZone 

		/*------------------------------------------------------------------*/
		/* Zone : Type de prestation                                        */
		/* Obligatoire si le dossier est à régler									  */
		/*------------------------------------------------------------------*/
		Case "type_prs"

			If ( bDosAREG Or bTjsOblig ) And Not bAltProt Then
				If sPos = "" Then sPos = "ALT_BLOC"
				sText += "- Le type de prestation" + sAide + sNouvelleLigne
			End If 

		/*------------------------------------------------------------------*/
		/* Zone : Type de vente (DCMP 040013, produit 18100 E-CARTE BLEU    */
		/* Obligatoire dans tous les cas.											  */
		/*------------------------------------------------------------------*/
		Case "type_vente"

			If bTjsOblig And Not bAltProt Then
				If sPos = "" Then sPos = "ALT_BLOC"
				sText += "- Le type de vente" + sAide + sNouvelleLigne
			End If 

		/*------------------------------------------------------------------*/
		/* Zone : Type de d'appareil (DCMP 040295, ts produit DNT)		     */
		/* Obligatoire dans tous les cas.											  */
		/*------------------------------------------------------------------*/
		Case "type_app"

			If bTjsOblig And Not bAltProt Then
				If sPos = "" Then sPos = "ALT_BLOC"
				sText += "- Le type d'appareil " + sAide + sNouvelleLigne
			End If 

		/*------------------------------------------------------------------*/
		/* Zone : Codic DARTY 															  */
		/* Obligatoire dans tous les cas.											  */
		/*------------------------------------------------------------------*/
		Case "codic"

			If bTjsOblig Then
				If sPos = "" Then sPos = "ALT_BLOC"
				sText += "- Le Codic DARTY" + sAide + sNouvelleLigne
			End If 

		/*------------------------------------------------------------------*/
		/* Zone : Date ticket (casto)													  */
		/*------------------------------------------------------------------*/
		Case "dte_ticket"

			If bTjsOblig Then
				If sPos = "" Then sPos = "ALT_BLOC"
				sText += "- La date du ticket de caisse" + sAide + sNouvelleLigne
			End If 

		/*------------------------------------------------------------------*/
		/* Zone : num_mag (casto)													     */
		/*------------------------------------------------------------------*/
		Case "num_mag"

			If bTjsOblig Then
				If sPos = "" Then sPos = "ALT_BLOC"
				sText += "- Le numéro du magasin" + sAide + sNouvelleLigne
			End If 

		/*------------------------------------------------------------------*/
		/* Zone : num_caisse (casto)												     */
		/*------------------------------------------------------------------*/
		Case "num_caisse"

			If bTjsOblig Then
				If sPos = "" Then sPos = "ALT_BLOC"
				sText += "- Le numéro de caisse" + sAide + sNouvelleLigne
			End If 

		/*------------------------------------------------------------------*/
		/* Zone : num_hotesse (casto)												     */
		/*------------------------------------------------------------------*/
		Case "num_hotesse"

			If bTjsOblig Then
				If sPos = "" Then sPos = "ALT_BLOC"
				sText += "- Le numéro d'hotesse" + sAide + sNouvelleLigne
			End If 

		/*------------------------------------------------------------------*/
		/* Zone : num_hotesse (casto)												     */
		/*------------------------------------------------------------------*/
		Case "num_ticket"

			If bTjsOblig Then
				If sPos = "" Then sPos = "ALT_BLOC"
				sText += "- Le numéro du ticket" + sAide + sNouvelleLigne
			End If
		
	End Choose

Next

If sPos <> "" Then 
	stMessage.bErreurG	= TRUE
	stMessage.sCode		= "GENE001"
	stMessage.sTitre		= "Contrôle de gestion"
	stMessage.Icon			= Information!
	stMessage.Bouton		= Ok!
	stMessage.sVar [1]   = sText
	
	asOng = "04"
End If

// -- Partie Autre Controle de Gestion, après le controle des zone de div sin obligatoire
// -- N'est executée que si sPos = "" ( pas de champs obligatoire à saisir )
// #3 [20091106201707453] On shunt le contrôle si Factu
if sPos = "" And Not this.uf_GetAutorisation2(208) Then 
	// #1 [O2M_DIAG_NOMADE] 
	// #5 [OM2_DIAG_NOMADE].Lot2 	
	// F_rechdetpro( lDeb, lFin, idw_DetPro, lIdProd, "-DP", 37)
	//remplacé par
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 25 )
	if lDeb > 0 Then
		// Si Option 25 et Type Appareil  'Autre' non présent en paramétrage det_pro
		bDp25_no_Aut = idw_detpro.Find ( "ID_PROD="+string(idw_WSin.GetItemNumber( 1, "ID_PROD" ))+&
								" AND ID_CODE_DP=25" + &
								" AND UPPER(ID_CODE_CAR)= 'AUT'", lDeb, lFin ) = 0
	End If
	// :#5 [OM2_DIAG_NOMADE].Lot2 	
	
	//if lDeb > 0 and &
	if bDp25_no_Aut and 	/* #5 [OM2_DIAG_NOMADE].Lot2 */ 	& 
		idw_wDivSin.Find ( "UPPER(NOM_ZONE) = 'TYPE_APP' AND UPPER(VAL_LST_CAR) = 'AUT'", 1, lTotZoneSin )>0 Then
		stMessage.bErreurG   = FALSE
		stMessage.sCode      = "WSIN680" // #1 [O2M_DIAG_NOMADE] : Message : Vous devez régulariser ce dossier en choisissant un type d'appareil précis.
													//                                    ATTENTION : Choisissez bien, car une fois validé, aucune modification ultérieure ne sera possible.
		stMessage.sTitre      = "Régularisation de dossier C-Discount"
		stMessage.Icon         = Information!
		stMessage.Bouton      = Ok!
		
		sPos = "ALT_BLOC"
		asOng = "04"
	End If
	// :#1 [O2M_DIAG_NOMADE] 
End If

Return sPos
end function

private subroutine uf_terminervalider_wcourrier ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_TerminerValider_WCourrier (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 13/08/2004 
//* Libellé       : On épure lé docu à joindre, on ne garde que la compo du doc
//*					  principal.
//* Commentaires  : 
//*
//* Arguments     : 
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*
//*-----------------------------------------------------------------

idw_wCourrier.SetFilter ( "ID_CPT <> 0" ) 
idw_wCourrier.Filter (  ) 
idw_wCourrier.RowsDiscard ( 1, idw_wCourrier.RowCount(), Primary! )
idw_wCourrier.SetFilter ( "" ) 
idw_wCourrier.Filter (  ) 


end subroutine

public subroutine uf_gestong_divers_dddw (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GestOng_Divers_DDDW (PUBLIC)
//* Auteur        : Fabry JF
//* Date          : 16/06/2004 11:13:57
//* Libellé       : Gestion des listes DDDW de l'onglet Divers
//* Commentaires  : Traitement particuliers afin de pouvoir gèrer plusieurs
//*					  liste "code_car" et plusieurs list "code"
//*
//* Arguments		: String		asData		Val
//*					  String		asNomCol		Val
//*					  Long		alRow			Val
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....

//*
//*-----------------------------------------------------------------
long	ll_ret
String sNomZone
DataWindowChild dwChild
Long  lTotVal, lCptVal

If alRow <= 0 Then Return

sNomZone = Upper ( idw_wDivSin.GetItemString ( alRow, "NOM_ZONE" ) )

Choose Case asNomCol

	Case "VAL_LST_CAR", "VAL_LST_NBRE"

		If asNomCol = "VAL_LST_CAR" Then
			ll_ret = idw_wDivSin.GetChild ( "VAL_LST_CAR", dwChild )
		Else
			ll_ret = idw_wDivSin.GetChild ( "VAL_LST_NBRE", dwChild )
		End if 

		lTotVal = dwChild.RowCount ()

		For lCptVal = 1 To lTotVal
			If Upper ( dwChild.GetItemString ( lCptVal, "NOM_ZONE" )) = sNomZone Then
				ll_ret = dwChild.SetItem ( lCptVal, "ALT_VISIBLE", 1 )
			Else
				ll_ret = dwChild.SetItem ( lCptVal, "ALT_VISIBLE", 2 )
			End IF 
		Next		

		ll_ret = dwChild.Sort ()

End Choose



end subroutine

private subroutine uf_gestong_divers_defautzone (string asnomzone, integer aiidprod, long alrow);//*-----------------------------------------------------------------

//* !!!!!!!!! OBSOLETE !!!!!!!!!!!!!
//* En attente de suppression
//* remplacée par uf_gestong_divers_majzone

//*
//* Fonction      : u_gs_sp_sinistre::uf_GestOng_Divers_DefautZone (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 29/09/2004 11:13:57
//* Libellé       : Placement d'une valeur par défaut dans une zone de l'onglet Divers
//* Commentaires  : 
//*
//* Arguments		: String			asNomZone		Val
//*					  String			aiIdProd			Val
//*					  Long			alRow				Val
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    22/06/2006  DCMP 060480
//*       JFF    14/11/2012  [VDOC9376]
//*-----------------------------------------------------------------

Boolean	bDefautZone
Long		lDeb, lFin, lCpt
String	sIdCode

asNomZone = Upper ( asNomZone )
bDefautZone = False

Choose Case asNomZone	

	Case "TYPE_APP"

		Choose Case aiIdProd

			// Traitement particulier pour un ou plusieur produit, coder ici
			Case 0
				bDefautZone = True

			Case Else
				bDefautZone = True

				F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 25 )
				If lDeb <= 0 Then Return

				For lCpt = lDeb To lFin
					If Upper ( Trim ( idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ) ) ) = "DEFAUT" Then
						sIdCode = idw_DetPro.GetItemString ( lCpt, "ID_CODE_CAR" ) 
						idw_wDivSin.SetItem ( alRow, "VAL_CAR", sIdCode )
						iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_TypeApp ( sIdCode, "VAL_LST_CAR", alRow, TRUE )  // [20241112110249883][DIVOBJ][JFF]
						Exit
					End If 
				Next

		End Choose 

   // #1
	Case "CHOIX_PACK"

		Choose Case aiIdProd

			// Traitement particulier pour un ou plusieur produit, coder ici
			Case 0
				bDefautZone = True

			Case Else
				bDefautZone = True

				F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 56 )
				If lDeb <= 0 Then Return

				For lCpt = lDeb To lFin
					If Upper ( Trim ( idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ) ) ) = "DEFAUT" Then
						sIdCode = idw_DetPro.GetItemString ( lCpt, "ID_CODE_CAR" ) 
						idw_wDivSin.SetItem ( alRow, "VAL_CAR", sIdCode )
						iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_TypeApp ( sIdCode, "VAL_LST_CAR", alRow, TRUE ) // [20241112110249883][DIVOBJ][JFF]
						Exit
					End If 
				Next

		End Choose 
   // FIN #1

	// [VDOC9376]
	Case "TYPAPP_REC_NEU"

		Choose Case aiIdProd

			// Traitement particulier pour un ou plusieur produit, coder ici
			Case 0
				bDefautZone = True

			Case Else
				bDefautZone = True

				F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 226 )
				If lDeb <= 0 Then Return

				For lCpt = lDeb To lFin
					If Upper ( Trim ( idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ) ) ) = "DEFAUT" Then
						sIdCode = idw_DetPro.GetItemString ( lCpt, "ID_CODE_CAR" ) 
						idw_wDivSin.SetItem ( alRow, "VAL_CAR", sIdCode )
						iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_TypeApp ( sIdCode, "VAL_LST_CAR", alRow, TRUE )  // [20241112110249883][DIVOBJ][JFF]
						Exit
					End If 
				Next

		End Choose 

End Choose

If	bDefautZone Then
	idw_wDivSin.SetItem ( alRow, "MAJ_LE", DateTime ( Today (), Now () ) )
	idw_wDivSin.SetItem ( alRow, "MAJ_PAR", stGlb.sCodOper )
	idw_wDivSin.SetItem ( alRow, "ALT_SUPP", "N" )
End If

end subroutine

private subroutine uf_gestong_divers_caspart_liste (string asnomzone, integer aiidprod);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GestOng_Divers_CasPart_Liste (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 29/09/2004 11:13:57
//* Libellé       : Gestion des cas particuliers lors du chargement des listes l'onglet divers
//* Commentaires  : 
//*
//* Arguments		: String			asNomZone		Val
//*					  String			aiIdProd			Val
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

Long lDeb, lFin, lTot1, lTot2, lCpt1, lCpt2
Boolean bTrouve
String	sIdCode

asNomZone = Upper ( asNomZone )


Choose Case asNomZone	

	Case "TYPE_APP"

		/*------------------------------------------------------------------*/
		/* Personnalisation de la liste des types d'appareil gérés pour ce  */
		/* produit.                                                         */
		/*------------------------------------------------------------------*/
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 25 )

		Choose Case aiIdProd

			// Traitement particulier pour un ou plusieur produit, coder ici
			Case 0

			Case Else

				/*------------------------------------------------------------------*/
				/* Si aucun param dans Det_Pro, je reset la dw, le DNT devra        */
				/* m'appeler car le dossier plantera à l'ouverture.                 */
				/*------------------------------------------------------------------*/
				If lDeb <=0 Then 
					idddw_CodeCar_wDivSin_Charg_Tempo.Reset ()
					Return
				End If

				lTot1 = idddw_CodeCar_wDivSin_Charg_Tempo.RowCount ()
				For lCpt1 = lTot1 To 1 Step -1
					sIdCode = idddw_CodeCar_wDivSin_Charg_Tempo.GetItemString ( lCpt1, "ID_CODE" )
					bTrouve = FALSE
					For lCpt2 = lDeb To lFin
						If sIdCode = idw_DetPro.GetItemString ( lCpt2, "ID_CODE_CAR" ) Then
							bTrouve = TRUE
							Exit
						End If 
					Next
					If Not bTrouve Then
						idddw_CodeCar_wDivSin_Charg_Tempo.RowsDiscard ( lCpt1, lCpt1, Primary! )
					End If
				Next

		End Choose 

End Choose



end subroutine

private subroutine uf_gestong_divers_caspart_finaux ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GestOng_Divers_CasPart_Finaux (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 29/09/2004 11:13:57
//* Libellé       : Gestion des cas particulier à la fin du traitement de l'onglet Divers.
//* Commentaires  : 
//*
//* Arguments		: 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 PHG	 28/12/2006	  [CRAO_LOT1]	Gestion Cr Activité IMEI
//* #2 	 JFF	 06/02/2006   [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
//* #3    JFF   29/01/2008   [DCMP080075]  [SURCOUF_ECH_EXPRESS]
//* #4    JFF   27/08/2009   [GEST_VAL_ACH_ADH]
//* #5    JFF   25/11/2009   [MSS_DIAG]
//* #6    FPI   06/01/2010   [EXP5.ID_BOUTIQUE_ADH] protection de la zone "id_boutique_adh"
//*  	    JFF	 13/04/2010   [WEBSIM2].[FRANCE]
//*       JFF   17/06/2010   [DCMP100430]
//*       JFF   19/10/2010   [PC202].[DOM_COM]
//*       JFF   19/10/2010   [PM50][PM83]
//*		 FPI	 03/02/2011	  [VDoc3009]	
//*       JFF   24/10/2011   [PC581].[ECO_AVANTAGE]
//*       JFF   02/04/2011   [PC694][SFR2012]
//			FPI	24/08/2012	[PC767][PC874]
//			FPI	20/11/2012	[VDoc8992] Ajout de l'autorisation 20
//       JFF   23/05/2012  [VDOC8806]
//			FPI	29/03/2013	[ITSM151511] il ne faut pouvoir forcer un CRAO que s’il a au moins été généré une fois
//       JFF  02/04/2013    [PC929_CDISCOUNT]
//       JFF  08/04/2013    [PC920_PRIXTEL]
// 		FPI	22/04/2013	[PC472-1]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//       JFF   24/05/2013  [PC512-5_ORANGE_V2_BIS]
//       JFF   17/06/2013 [PC946_ORANGE_OPPRO]
//		   FPI	13/08/2013	[DT058]
//       JFF   18/08/2013 [VDOC12141]
//			FPI	23/10/2013	[PC932].Mantis9145
//       JFF   12/12/2013 [PC947&977]
//       JFF   07/05/2013 [DT081_EVOL_PRET_BRIS]
//* 	 	JFF   02/05/2014 [VDOC13888]
//       JFF   02/06/2014 [PC929_CDISCOUNT][PC929-2-V3]
//       JFF   17/06/2014 [PM259-1]
//		FPI	07/07/2014	[PC13442]
//		FPI	29/09/2014	[PC987]
//		FPI	06/10/2014	[PC13174]
//		FPI	07/10/2014	[OV3.FPI] Temporaire pour le prêt d'appareil endommagé au client
//		FPI	08/10/2014	[FORCER_PAIEMENT_PAYBOX]
//		FPI	15/12/2014	[DT119]
//		FPI	26/01/2015	[DT129]
//		JFF	19/03/2015	[DT129][MANTIS14751]
//		FPI 	05/06/2015 [VDOC17839]
//    JFF   26/10/2015 [PC786-2_V3]
//    JFF   14/06/2016 [PC161703]
//    JFF   14/06/2016 [DT129-1]
//    JFF   28/06/2016 [PC151549]
//    JFF   09/08/2016 [PC13442-3][DT251]
//    JFF   07/11/2016 [PC151259]
//    JFF   04/05/2017 [DT288-1_LOT2]
//    JFF   29/05/2017 [PC151259-2]
//    JFF   01/06/2017 [ITSM466562]
//    JFF   06/11/2017 [PC171933-V6]
//    JFF   16/10/2018 [PC171999]
//    JFF   18/01/2018 [PC151379]
//    JFF   10/03/2020 [DT458]
//    JFF   28/06/2022 [RS3074_CASTO]
//    JFF   26/09/2023 [RS5928_FRCH_CHQ]
//    JFF   22/11/2023 [RS6175_GC_SCRP_SIM2]
//    JFF   18/11/2024 [KSV649_ORREUCARA]
//    JFF   03/03/2025 [PMO268_MIG48]
//    JFF   18/03/2025 [PAN_125]
//*-----------------------------------------------------------------

Long lTot, lCpt
String sNomZone, sData, sVal, sClasseCtgSfr, sVal1
long lIdPRod, lRow
Long lDeb, lFin, lDeb1, lFin1
Long lVal1
n_cst_string lnvPFCString
DateTime dtVal, dtCreeLeDos 

lIdProd = idw_Wsin.GetITemNumber ( 1, "ID_PROD" )
lTot = idw_WdivSin.RowCount ()

For lCpt = 1 To lTot

	sNomZone = Upper ( idw_WDivSin.GetItemString ( lCpt, "NOM_ZONE" ) )

	Choose Case sNomZone	

/*------------------------------------------------------------------*/
/* Type de l'appareil                                               */
/*------------------------------------------------------------------*/
		Case "TYPE_APP"

			Choose Case lIdProd

				// Traitement particulier pour un ou plusieur produit, coder ici
				Case 0

				Case Else

					sData = Upper ( This.uf_GestOng_Divers_Trouver ( "TYPE_APP" ) )
			
					iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_TypeApp ( sData, "VAL_LST_CAR", lCpt, TRUE ) // [20241112110249883][DIVOBJ][JFF]

			End Choose 

/*------------------------------------------------------------------*/
/* CODIC DARTY, toujours protéger, jamais saisissable (vu avec DGA) */
/*------------------------------------------------------------------*/
		Case "CODIC"

			// Protection contre saisie
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )	

			sData = Trim ( This.uf_GestOng_Divers_Trouver ( "CODIC" ) )
			If IsNull ( sData ) Then sData = "" 
			If Long ( sData ) = 0 Then sData = ""

			// [VDOC17839]
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "N" )	
			sData=Left(sData,7)
			uf_gestong_divers_majzone( "CODIC", lCpt, K_MAJZONE, sData)
			// :[VDOC17839]
			
/*------------------------------------------------------------------*/
/* Si Pas de CODIC, on ne gère pas le dossier, Problème.			     */
/*------------------------------------------------------------------*/
			If sData = "" And isTypeTrt = "S" Then
				stMessage.sTitre		= "CODIC Absent !"
				stMessage.Icon			= Exclamation!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= OK!
				stMessage.sCode		= "WDSI001"
				//iPbControler.Enabled = FALSE
				
				// [VDOC13888]
				If Not This.uf_GetAutorisation2 ( 208 ) Then 				
					F_Message ( stMessage )
				End If
	
			Else
				This.Uf_Zn_Trt_DivSin_Codic ( sData, "VAL_NBRE", lCpt, TRUE )
			End If

/*------------------------------------------------------------------*/
/* N° Magasin Casto, renseigné via le code boutique.					  */
/*------------------------------------------------------------------*/
		Case "NUM_MAG"

			// Protection contre saisie
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )	

/*------------------------------------------------------------------*/
/* #1 [CRAO_LOT1] Protection des zone Virtuelle CRAO,               */
/* sauf cra_ctrl_imei, qui est protégé si cra_suivi_imei = 2        */
/*------------------------------------------------------------------*/

		// #4 [GEST_VAL_ACH_ADH]
		//[PC581].[ECO_AVANTAGE]
		// [PC694][SFR2012]
		case "CRA_DAT_GEN", &
			  "MT_VAL_ACHAT_ADH", &
			  "ECO_AVANTAGE"
			  
			// Protection contre saisie
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )

		// [KSV649_ORREUCARA]
		Case "CRA_CPT_DMDE"

			// Protection contre saisie
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )

			sData = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_CPT_DMDE" ) )
			If sData="" or IsNull ( sData ) Then sData="0"
			This.uf_gestong_divers_majzone( "CRA_CPT_DMDE", lCpt, K_MAJZONE, sData )
			

			//	[PC767][PC874]
		Case  "CRA_LAST_DTE", &
		  	   "CRA_SUIVI_IMEI"
			  
			// Protection contre saisie par défaut
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )

			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",217)
			If lDeb <=0 Then 	F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",218)

			// [PC161703]
			// [DT129-1]
			If lDeb <=0 Then 
				F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",231) // [PC472-1]
				If lDeb > 0 Then
					If lnvPFCString.of_getkeyvalue(idw_DetPro.GetItemString(lDeb,"VAL_CAR" ), "VARIANTE", ";") = "PC161703/DT129-1" Then
						lDeb = 0 
					End If
				End If
			End If
			
			// [DT129]
			If lDeb <=0 Then
				F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",268) // [DT129]
			
				If lDeb > 0 Then
					If lnvPFCString.of_getkeyvalue(idw_DetPro.GetItemString(lDeb,"VAL_CAR" ), "CONTESTATION_UNIQT", ";") = "OUI" Then
						// Si la case contestation n'est pas cochée et que le produit n'envoie de mail de ctl qu'en cas de contestation,
						// on protège
						sData = Trim ( This.uf_GestOng_Divers_Trouver ( "CONTESTATION" ) )
						If sData="" Then sData="N"
						If sData="N" Then lDeb=0
					End if
				End if
				
			End if
			// :[DT129]
			
			// [ITSM151511]
			sData = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_CPT_DMDE" ) )
			If sData="" Then sData="0"
			
			// On déprotège si on a l'option 217, 218 ou l'autorisation 20
			If long(sData) > 0 Then 
				If lDeb > 0 or uf_getautorisation2( 20 ) Then idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "N" )
			End if
	
			// [PC874_2_V1]
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",218)				
			If lDeb > 0 Then
				dtVal = DateTime ( lnvPFCString.of_getkeyvalue(idw_DetPro.GetItemString(lDeb,"VAL_CAR" ), "DTE_PIVOT_PC874_2", ";") )
				dtCreeLeDos = idw_WSin.GetItemDateTime ( 1, "CREE_LE")
				
				If dtCreeLeDos >= dtVal Then
					// Protection contre saisie par défaut
					idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
				End If 
			End If 
			
			// [KSV649_ORREUCARA]
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",387)
			If lDeb <= 0 Then
				F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",388)
			End IF 
			If lDeb > 0 Then
				sData = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_SUIVI_IMEI" ) )
				If sData="" Or IsNull ( sData ) Then sData="5"
				
				If sData = "20" Then
					idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "N" ) 
				Else
					idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" ) 
				End if 

				This.uf_gestong_divers_majzone( "CRA_SUIVI_IMEI", lCpt, K_MAJZONE, sData )				
			End iF 

			// [PMO268_MIG48]
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",394)
			If lDeb > 0 Then
				sData = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_SUIVI_IMEI" ) )
				If sData="" Or IsNull ( sData ) Then sData="5"
				
				Choose Case sData 
					Case "5", "20" 
						idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "N" ) 
					Case Else
						idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" ) 
				End Choose 

				This.uf_gestong_divers_majzone( "CRA_SUIVI_IMEI", lCpt, K_MAJZONE, sData )				
			End iF 


			
		Case "CLASSE_CTG_SFR"			

			// Protection contre saisie
			// [DEBUG]
//			 If stGlb.sCodOper = "JFF" Then 
//					idw_wDivSin.SetItem ( lCpt,"VAL_CAR", "4" )
//			 		idw_wSin.SetItem ( 1, "COD_OPT", 4 )
//			 End If
//			 [DEBUG]
			
			sClasseCtgSfr = idw_wDivSin.GetItemString ( lCpt, "VAL_CAR" )
			If IsNull ( sClasseCtgSfr ) Or Len ( Trim ( sClasseCtgSfr )) <=0 Then
				sClasseCtgSfr = String ( idw_wSin.GetItemNumber ( 1, "COD_OPT" ))
				This.uf_gestong_divers_majzone( "CLASSE_CTG_SFR", lCpt, K_MAJZONE, sClasseCtgSfr )				
			End If
			
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
			
			sClasseCtgSfr = idw_wDivSin.GetItemString ( lCpt, "VAL_CAR" )
			sClasseCtgSfr = "CM" + Trim ( sClasseCtgSfr )
			If Not IsNull ( sClasseCtgSfr ) And Len ( Trim ( sClasseCtgSfr )) > 0 Then
				lRow = idw_WDivSin.Find ( "NOM_ZONE = 'choix_pack'", 1,  idw_WDivSin.RowCount () )
				If lRow > 0 Then
					This.uf_gestong_divers_majzone( "CHOIX_PACK", lRow, K_MAJZONE, sClasseCtgSfr )
				End If
			End If		
	
			
		case "CRA_CTRL_IMEI"
			// Protection contre saisie si cra_suvi_imei = 2 ( controle Ok )
			sData = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_SUIVI_IMEI" ) )
			if sData = "2" then
				idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )	
			End If

			// [PC946_ORANGE_OPPRO]
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",239)
			If lDeb > 0 Then
				sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "VARIANTE", ";")
			Else 
				sVal = ""
			End If
										
			// [DT129][MANTIS14751]
			// [ITSM466562]
			If isTypeTrt = "S" Then
				F_RechdetPro (lDeb1, lFin1, idw_DetPro, lIdProd,"-DP",271)
				
				If ( lDeb > 0 And sVal = "ORANGE_OPEN_PRO" ) Or ( lDeb1 > 0 ) Then
					sData = Trim ( This.uf_GestOng_Divers_Trouver ( "CRA_CPT_DMDE" ) )
					If IsNull ( sData ) Or Long ( sData ) = 0 Then 
						lRow = idw_WDivSin.Find ( "Upper ( NOM_ZONE ) = 'CRA_CTRL_IMEI'", 1,  idw_WDivSin.RowCount () )
						If lRow > 0 Then
							This.uf_gestong_divers_majzone( "CRA_CTRL_IMEI", lRow, K_MAJZONE, "O" )					
						End If
					End IF
				End If
			End If
			
			// [PC874_2_V1]
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",218)				
			If lDeb > 0 Then
				dtVal = DateTime ( lnvPFCString.of_getkeyvalue(idw_DetPro.GetItemString(lDeb,"VAL_CAR" ), "DTE_PIVOT_PC874_2", ";") )
				dtCreeLeDos = idw_WSin.GetItemDateTime ( 1, "CREE_LE")
				
				If dtCreeLeDos >= dtVal Then
					// Protection contre saisie par défaut
					idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
				End If 
			End If 

			
		// #2, #3
		// [WEBSIM2] Ajout MDP_NET_BOUTIQUE 
		// [PC938_ORANGE_V3]
		// [PC512-5_ORANGE_V2_BIS]
		// [PC932].Mantis9145
		// [DT081_EVOL_PRET_BRIS]
		// [PC929_CDISCOUNT][PC929-2-V3]
		// [PM259-1] code parental
		//	[PC987]	ASS_PRO_TVA
		// [PC151549] OPT_ACCESSOIRE
		// [PC151259] ID_ARCH_SCRIPT, UNIQUEKEY
		// [PC151259] FRN_REPA_ADH, FRN_REMPL_ADH
		// [DT288-1_LOT2]
		// [PC151259-2]
		// [DT458]
		Case "MDP_NET", &
			  "PROVENANCE", &
			  "SKU_IDENT_APPAREIL", &
			  "TRANCHE_TARIF", &
			  "NUM_PANIER", &
			  "MDP_NET_BOUTIQUE", &
			  "CONF_REFUS_PEC", &
			  "SHT_RPLPRETVOL", &
			  "NUM_TRANS_PAYBOX_1", &
			  "NUM_TRANS_PAYBOX_2", &
			  "DTE_DEBIT_CAUTION_PAYBOX" ,&
			  "MT_DEBIT_CAUTION_PAYBOX", &
			  "CPT_REL_PCE", &
			  "DTE_DER_REL", &
			  "CPT_REL_REST_PRET", &
			  "DTE_DER_REL_REST_PRET", &
			  "DTE_RECREDIT_CAUTION_PAYBOX", &
			  "DTE_RECREBIT_CAUTION_PAYBOX", &
			  "LIB_POLICE", &
			  "ORANGE_V2_BIS",&
			  "PCE_PV_RECU" , &
			  "PROCESS_PRS", &
			  "CTRL_IMEI_SUCCES", &
			  "COD_BOUTIQUE_ADH", &
			  "CONS_APPPRETVOL", &
			  "DTE_COUR_REST_PRET_HV", &
			  "DTE_1REL_COUR_REST_PRET_HV", &
			  "DTE_2REL_COUR_REST_PRET_HV",&
			  "TV_SUPEG_32P", &
			  "ETAT_MOBILE_SHERPA_SCRIPT", &
			  "DECL_LIQUIDE_SHERPA_SCRIPT", &
			  "CODE_VERROU_SHERPA_SCRIPT", &
			  "CODE_PARENTAL", &
			  "FIN_SCRIPT", &
			  "REFUS_SCRIPT", &
			  "TYPE_LIVRAISON_ATLAS", &
			  "CODE_LIVRAISON_ATLAS", &
			  "TYP_APP_PRET_ATLAS", &
			  "INFO_IPHONE_ATLAS", &
			  "MANQUE_INFO_ATLAS", &
			  "ASS_PRO_TVA", &
			  "RESIL_AUTO_ADH", &
			  "ETAT_VU_ASSURE", &
			  "DTE_NAIS_ADH", &
			  "MT_VAL_ACHAT_REMISE", &
			  "CPT_TENT_DEBIT", &
			  "DTE_REL_MAIL_APP_NON_RCP_EN_CTR", &
			  "DTE_REL2_MAIL_APP_NON_RCP_EN_CTR", &			  
			  "DTE_REL3_MAIL_APP_NON_RCP_EN_CTR", &			  			  
			  "DTE_REL4_MAIL_APP_NON_RCP_EN_CTR", &			  			  
			  "CLIENT_VIP", &
			  "DTE_PCE_FACT_ACHAT_DEM", &
			  "PCE_FACT_ACHAT_ADEM", &
			  "DTE_CMPLT_ADH_PAYE_ASS_PAYBOX", &
			  "CARTON_ADAPT_APP", &
			  "CODE_PSM_CENTRA_ATLAS", &
			  "DTE_COUR_PEC_ENVKSL_PM234_7", &
			  "ID_ARCH_SCRIPT", &
			  "FRN_REPA_ADH",& 
			  "FRN_REMPL_ADH", &
			  "VOL_ATLAS_PERDUS_SSUITE", & 
			  "VOL_ATLAS_PERDUS_ENCOURS",&
			  "DOS_ATLAS_PERDUS_SSUITE",&
			  "ERR_TRV_ABSENT_DECLA", &
			  "NUM_BON_VENTE" , &
			  "CODE_EAN", &
			  "ID_SEQ_PCE_MAIL_CASTO", &
			  "DTE_MAIL_CASTO_ORIG", &
			  "DTE_MAIL_CASTO_1REL", &
			  "DTE_MAIL_CASTO_2REL", &
			  "UNIQUEKEY", &
			  "DTE_REL1_MAIL_DDEPCE_DT262", &
			  "DTE_REL2_MAIL_DDEPCE_DT262", &
			  "DTE_REL3_MAIL_DDEPCE_DT262", &			  
			  "DTE_REL4_MAIL_DDEPCE_DT262", &			  
			  "DTE_REL5_MAIL_DDEPCE_DT262", &			  			  
			  "GEOLOC_ATLAS", &
			  "GEOLOC_SIMPA2", &
			  "PRODUCTID_ADV", &
			  "ADR_MAIL_REPA_ADH", &
			  "PM378_MAJ_RIB", &
			  "DECLA_ATLAS_GT", &
			  "DTE_DEB_GTI", &
			  "DTE_EFF_ARTICLE",&
			  "MODE_PAYBOX", &
			  "MT_FRANCHISE_PAYBOX", &
			  "DTE_FRANCHISE_PAYE_ASS_PAYBOX", &
			  "TYPE_LIVRAISON_EXTR_ATM", &
			  "CODE_LIVRAISON_EXTR_ATM", &
			  "CODE_PSM_CENTRA_EXTR_ATM", &
			  "MT_VAL_ACHAT_EXTR_ATM", &
			  "MANQUE_INFO_EXTR_ATM",&
			  "DECLA_EXTR_AXA", &
			  "MT_VAL_ACHAT_EXTR_AXA", &
			  "DECLA_EXTR_ATM", &
			  "PRBL_ASSUREUR_CAMCA", &
			  "REVENTE_A_TRAITER_1", &
			  "PM506_APIREST_LAB_APPELEE_LE", &
			  "PM506_ETAT_APPEL_APIREST_LAB", &
			  "PM506_PERSON_A_RISQUE", &
			  "IMEI_CTRL_1", &
			  "IMEI_CTRL_2", &
			  "DTE_IMEI_CTRL_1", &
			  "DTE_IMEI_CTRL_2", &
			  "MT_FRANCHISE_PAYBOX",&
			  "DT432_ID_SIN_EMETTEUR",&
			  "DT432_ID_SEQ_BATCH", &
			  "RS1921_AMTRUST",&
			  "CTRL_IMEI_MANUEL", &
			  "SKU_GARANTIE_SAGA2", &
			  "ADH_DEJA_INDEM", &
			  "DTE_ACH_ADH_ELT_1", &
			  "DTE_ACH_ADH_ELT_2", &
			  "DTE_ACH_ADH_ELT_3", &
			  "ELEMENT_ADH_1", &
			  "ELEMENT_ADH_2", &			  
			  "ELEMENT_ADH_3", &			  
			  "MT_VAL_ACHAT_ADH_ELT_1", &
			  "MT_VAL_ACHAT_ADH_ELT_2", &
			  "MT_VAL_ACHAT_ADH_ELT_3" &			  
			  
  			  idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )

			If sNomZone = "ETAT_VU_ASSURE" Then
				sData = Upper ( This.uf_GestOng_Divers_Trouver ( "ETAT_VU_ASSURE" ) )
				
				If sData = "100" Then 
					idw_wDivSin.SetItem ( lCpt, "VAL_NBRE", 101 )	
					idw_wDivSin.SetItem ( lCpt, "ALT_SUPP", "O" )
				End If
			End If

			/* Debug JF à laisser 
			If stGlb.sCodOper = "JFF" And sNomZone = "DTE_EFF_ARTICLE" Then
				This.uf_gestong_divers_majzone ( "DTE_EFF_ARTICLE", lCpt, K_MAJZONE, "10/02/2018" ) 
			End If
		   */
			
			/* Debug JF à laisser 
			If stGlb.sCodOper = "JFF" And sNomZone = "DECLA_ATLAS_GT" Then
				This.uf_gestong_divers_majzone ( "DECLA_ATLAS_GT", lCpt, K_MAJZONE, "JFF" ) 
			End If
			*/
			
			/* Debug JF à laisser 		
			If stGlb.sCodOper = "JFF" And sNomZone = "ADR_MAIL_REPA_ADH" Then
				This.uf_gestong_divers_majzone ( "ADR_MAIL_REPA_ADH", lCpt, K_MAJZONE, "eko@adv.fr" ) 
			End If
			*/ 	


			/* Debug JF à laisser 
			If stGlb.sCodOper = "JFF" And sNomZone = "CODE_VERROU_SHERPA_SCRIPT" Then
				This.uf_gestong_divers_majzone ( "CODE_VERROU_SHERPA_SCRIPT", lCpt, K_MAJZONE, "1548" ) 
			End If
			*/

			/* Debug JF à laisser
			If stGlb.sCodOper = "JFF" And sNomZone = "FRN_REPA_ADH" Then
				This.uf_gestong_divers_majzone ( "FRN_REPA_ADH", lCpt, K_MAJZONE, "O2M" ) // "NET
			End If
			*/
			
			/* Debug JF à laisser  
			If stGlb.sCodOper = "JFF" And sNomZone = "FRN_REMPL_ADH" Then
				This.uf_gestong_divers_majzone ( "FRN_REMPL_ADH", lCpt, K_MAJZONE, "BK2" )
			End If
			*/

			/* Debug JF à laisser 
			If stGlb.sCodOper = "JFF" And sNomZone = "CLIENT_VIP" Then
				This.uf_gestong_divers_majzone ( "CLIENT_VIP", lCpt, K_MAJZONE, "VIPPAR" )
			End If
			*/
			
			/* Debug JF à laisser
			If stGlb.sCodOper = "JFF" And sNomZone = "TRANCHE_TARIF" Then
				This.uf_gestong_divers_majzone( "CHOIX_PACK", lCpt, K_MAJZONE, "3" )
			End If
			*/

			/* Debug JF à laisser
			If stGlb.sCodOper = "JFF" And sNomZone = "PROCESS_PRS" Then
				This.uf_gestong_divers_majzone( "PROCESS_PRS", lCpt, K_MAJZONE, 3110 )
			End If
			 */

			/* Debug JF à laisser  
			If stGlb.sCodOper = "JFF" And sNomZone = "TV_SUPEG_32P" Then
				This.uf_gestong_divers_majzone( "TV_SUPEG_32P", lCpt, K_MAJZONE, "O")
			End If
			*/

			/* Debug JF à laisser 
			If stGlb.sCodOper = "JFF" And sNomZone = "CODE_PARENTAL" Then
				This.uf_gestong_divers_majzone( "CODE_PARENTAL", lCpt, K_MAJZONE, "8783" )
			End If
			*/

		
		Case "NUM_CAISSE", &
			  "NUM_HOTESSE"
			
			// [RS3074_CASTO]
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
			
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 43 ) // CASTO
			If lDeb > 0 Then 
				sVal = This.uf_GestOng_Divers_Trouver ( "NUM_CAISSE" )
				sVal1 = This.uf_GestOng_Divers_Trouver ( "NUM_HOTESSE" )		
				
				If IsNull ( sVal ) Then sVal = ""
				If IsNull ( sVal1 ) Then sVal1 = ""		
				If sVal = "0" Then sVal = ""
				If sVal1 = "0" Then sVal1 = ""
				
				If sVal = "" Then 
					lRow = idw_WDivSin.Find ( "NOM_ZONE = 'num_caisse'", 1,  idw_WDivSin.RowCount () ) 
					If lRow > 0 Then
						This.uf_gestong_divers_majzone( "NUM_CAISSE", lRow, K_MAJZONE, 1 )				
					End If 
				End If 
				
				If sVal1 = "" Then 
					lRow = idw_WDivSin.Find ( "NOM_ZONE = 'num_hotesse'", 1,  idw_WDivSin.RowCount () ) 
					If lRow > 0 Then
						This.uf_gestong_divers_majzone( "NUM_HOTESSE", lRow, K_MAJZONE, 1 )				
					End If 
				End If 
			End If 
				

		// [VDoc3009]
		Case "BTQ_PSM"
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "N" )
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",140)
			If lDeb > 0 Then
				sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "VARIANTE", ";")			
				
				If sVal = "PC801" Then
					idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
				End if
			ENd If

			/* Debug JF à laisser
			If sNomZone = "BTQ_PSM" Then
				This.uf_gestong_divers_majzone( "BTQ_PSM", lCpt, K_MAJZONE, 52 )
			End If
			*/
			
			
		// #5 [MSS_DIAG]			
		Case "NUM_FACT"
			 idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
			 sData = Trim ( This.uf_GestOng_Divers_Trouver ( "NUM_FACT" ) )

// [DCMP100430]
//			 If ( IsNull ( sData ) Or Len ( sData ) = 0 ) And stGlb.sTypOper >= "5" Then
			 If ( IsNull ( sData ) Or Len ( sData ) = 0 ) Then
				 idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "N" )
			 End IF

		// #6 
		// [PC202].[DOM_COM]
		Case "ID_BOUTIQUE_ADH", "ID_CLI_BQ"
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )

			/* Debug JF à laisserchoix_pack                         
			If sNomZone = "ID_BOUTIQUE_ADH" Then
				This.uf_gestong_divers_majzone( "ID_BOUTIQUE_ADH", lCpt, K_MAJZONE, "3074" )
			End If
			*/


		// [VDoc3009] [RS6175_GC_SCRP_SIM2]
		Case "DUREE_GTI_ORIGINE", "DUREE_GTI_ORIG"
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",162)
			If lDeb > 0 Then
				idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
			Else
				idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "N" )
			End if

		// [VDOC8806]
		Case "APP_SIN"
			
			lVal1 = idw_wDivSin.Find ( "UPPER ( NOM_ZONE ) IN ( 'ALIM_SIN', 'AUT_ACC_SIN', 'BATT_SIN' )", 1, idw_wDivSin.RowCount() )
			lRow = idw_WDivSin.Find ( "UPPER ( NOM_ZONE ) = 'APP_SIN'", 1,  idw_WDivSin.RowCount () )
			If lRow > 0 And lVal1 <= 0 And This.uf_GestOng_Divers_Trouver ( "APP_SIN" ) <> "O" Then
				This.uf_gestong_divers_majzone( "APP_SIN", lRow, K_MAJZONE, "O" )
			End If

		// [PC929_CDISCOUNT]
		Case "DTE_DEB_GTI", "DTE_LIVRAISON"
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
			
		// [PC938_ORANGE_V3]
		Case "ETAT_CAUTION_PAYBOX"
			
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
			sData = Upper ( This.uf_GestOng_Divers_Trouver ( "ETAT_CAUTION_PAYBOX" ) )
			
			If IsNull (sData ) Or Len ( Trim ( sData ) ) <= 0 Then
				lVal1 = idw_wDivSin.Find ( "UPPER ( NOM_ZONE ) = 'ETAT_CAUTION_PAYBOX'", 1, idw_wDivSin.RowCount() )
				If lVal1 > 0 Then
					This.uf_gestong_divers_majzone( "ETAT_CAUTION_PAYBOX", lVal1, K_MAJZONE, "AUCDEB" )
				End If
			End If
		
		// [DT058]
		Case "SANCTION_ECO"
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )

		Case "ACCORD_CHUBB"
			sData = Upper ( This.uf_GestOng_Divers_Trouver ( "ACCORD_CHUBB" ) )
			Choose Case sData
				Case "0","1"
					// En cours ou non-renseigné - Zone active
				Case Else
					idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
			End Choose

		// [PC925]
		Case "CHOIX_PACK"
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP",256)
			if lDeb > 0 Then idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
		
		// [PC13442]
		Case "ECH_EXPRESS_48H"
			
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "N" )

			// [PC13442-3][DT251]
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP", 302 )				
			If lDeb <= 0 Then
				idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )				
				idw_wDivSin.SetItem ( lCpt,"VAL_CAR", "N" )	
			Else
				Choose case idw_wsin.GetItemNumber(1,"COD_OPT") 
					Case 0 
						// L'option ne redescend pas, on laisse ouvert
					Case 1, 2, 3, 4 
						// Formules sans option Echange Express
						idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
				End Choose
			End If
			
			if idw_wDetail.Find ( "COD_ETAT = 600 OR COD_ETAT = 500", 1, idw_wDetail.RowCount () ) + &
					idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' ", 1, idw_LstwCommande.RowCount () ) > 0 Then 
					idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
			End if
			
		// [PC13174]
		Case "INTERV_SERRURIER", "INT_SER_SUP_150"
			
			idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "N" )
			
			if idw_wDetail.Find ( "ID_EVT=1419 AND (COD_ETAT = 600 OR COD_ETAT = 500)", 1, idw_wDetail.RowCount () ) > 0 Then 
					idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )
			End if
		
		// [OV3.FPI]
		Case "PRET_APP_ENDOMMAGE"
			idw_wDivSin.SetItem ( lCpt, "ALT_PROT", "O" )		

			lRow=idw_LstwCommande.Find("ID_TYP_ART='PST' AND COD_ETAT<>'ANN'",  & 
					1, idw_LstwCommande.RowCount())
			
			If lRow > 0 Then
				If lnvPFCString.of_getkeyvalue( idw_LstwCommande.GetItemString(lRow,"INFO_FRN_SPB_CPLT"), "ETAT_APP_PRET", ";") = "ENDOMMAGE" Then
					idw_wDivSin.SetItem ( lCpt, "ALT_PROT", "N" )		
				End if					
			End if
		// :[OV3.FPI]
		
		// [FORCER_PAIEMENT_PAYBOX] 
		Case "FRANCHISE_PAYBOX_CB_FORCEE"
			idw_wDivSin.SetItem ( lCpt, "ALT_PROT", "O" )		
	
			If uf_getautorisation2( 29) Then
				sData = Upper ( This.uf_GestOng_Divers_Trouver ( "FRANCHISE_PAYBOX" ) )
				if sData="N" Then idw_wDivSin.SetItem ( lCpt, "ALT_PROT", "N" )	
			End if
		// :[FORCER_PAIEMENT_PAYBOX]
		
		// [DT129]
		Case "CONTESTATION"
			if idw_wDivSin.GetItemNumber(lCpt,"CPT_VALIDE") > 0 Then
				idw_wDivSin.SetItem ( lCpt, "ALT_PROT", "O" )	
			End if
		// :[DT129]
		
		// [PC171999]
		Case "PERSONNE_SIN"
		
			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP", 330 )				
			If lDeb > 0 Then
				sVal = idw_DetPro.GetItemString ( lDeb, "VAL_CAR" )
				sVal = lnvPFCString.of_getkeyvalue( sVal, "DEFAUT", ";") 
				If IsNull ( sVal ) Then sVal = ""

				sVal1 = This.uf_GestOng_Divers_Trouver ( "PERSONNE_SIN" )
				If IsNull ( sVal1 ) Then sVal1 = ""				
				
				If sVal <> "" And sVal1 = "" Then 
					
					lRow = idw_WDivSin.Find ( "NOM_ZONE = 'personne_sin'", 1,  idw_WDivSin.RowCount () )					
					If lRow > 0 Then
						This.uf_gestong_divers_majzone( "PERSONNE_SIN", lRow, K_MAJZONE, sVal )
					End If
				End If 
			End If 

		// [RS5928_FRCH_CHQ]
		Case "MODE_PAIEMENT"

			F_RechdetPro (lDeb, lFin, idw_DetPro, lIdProd,"-DP", 298)
			If lDeb > 0 Then
				
				sVal = This.uf_GestOng_Divers_Trouver ( "DTE_CMPLT_ADH_PAYE_ASS_PAYBOX" )
				sVal1 = This.uf_GestOng_Divers_Trouver ( "MODE_PAIEMENT" )
				
				If IsNull ( sVal ) Then sVal = ""
				If IsNull ( sVal1 ) Then sVal1 = ""

				If sVal <> "" and sVal1 = "" Then
					lRow = idw_WDivSin.Find ( "NOM_ZONE = 'mode_paiement'", 1,  idw_WDivSin.RowCount () )					
					If lRow > 0 Then
						This.uf_gestong_divers_majzone( "MODE_PAIEMENT", lRow, K_MAJZONE, "CB" )
					End If
				End If 

				If sVal <> "" Then
					idw_wDivSin.SetItem ( lCpt,"ALT_PROT", "O" )					
				End If 
				
			End If 
	
	End Choose


Next


end subroutine

public function string uf_determiner_referentiel (string astypeapp);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Referentiel (PUBLIC)
//* Auteur        : Fabry JF
//* Date          : 30/12/2004 15:29:11
//* Libellé       : En fonction du type d'appareil, et de la table detpro opt28,
//* 					  On determine le referentiel à utiliser
//* Commentaires  : 
//*
//* Arguments     : String		asTypeapp			Val
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	   20/10/2008 [FNAC_PROD_ECH_TECH].[20090127140540720]
//        JFF     17/01/2020 [EPURE_MODL_MB]
//*-----------------------------------------------------------------

Long lDeb, lFin, lCpt, lRow
String sCodeRef, sVal

isReferentielApp = ""

/*------------------------------------------------------------------*/
/* Option 28 : Referentiel associé au type d'objet pouvant être     */
/* déclaré sur le produit (Option 25 )                              */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 28 )

If lDeb <= 0 Or lFin <= 0 Then 
	iUoGsSpSinistre2.uf_Set_ValInstance ( "isReferentielApp", isReferentielApp ) // [20250416172303990]
	Return ""
End If 

For lCpt = lDeb To lFin

/*------------------------------------------------------------------*/
/* Ex : code Ref DTYCAM --> découpage pour obtenir CAM -> Si CAM =  */
/* CAM => Alors Recherche dans table CODE -RF le référentiel à      */
/* utiliser                                                         */
/*------------------------------------------------------------------*/
	// Ex DTYCAM
	sCodeRef = Trim ( Upper (  idw_DetPro.GetItemString ( lCpt, "ID_CODE_CAR" ) ) )

	If Right ( sCodeRef, 3 ) = Upper ( Trim ( asTypeApp ) ) Then
		lRow = idw_CodeRF.Find ( "ID_CODE = '" + sCodeRef + "'", 1, idw_CodeRF.RowCount () ) 

/*------------------------------------------------------------------*/
/* Je ne teste pas lRow > 0, il doit forcément exister, je préfère  */
/* laisser planter dans le cs contraire.                            */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le libellé associé au code référentiel représente le nom de la   */
/* table en base à utiler.														  */
/*------------------------------------------------------------------*/
		isReferentielApp = Upper ( Trim ( idw_CodeRF.GetItemString ( lRow, "LIB_CODE" ) ) )
		Exit
	End If

Next

//* #1 [FNAC_PROD_ECH_TECH].[20090127140540720]
If isReferentielApp = "" Then
		// Si pas de référentiel trouvé alors on arme un référentiel par défaut.
		lRow = idw_CodeRF.Find ( "ID_CODE = 'SPBAUT'", 1, idw_CodeRF.RowCount () ) 
		isReferentielApp = Upper ( Trim ( idw_CodeRF.GetItemString ( lRow, "LIB_CODE" ) ) )
End If
//* :#1 [FNAC_PROD_ECH_TECH].[20090127140540720]

// EPURE_MODL_MB
If isReferentielApp = "REF_SIMPA2_CODE_MB" Then
	sVal = idw_Wsin.GetItemString ( 1, "MODL_PORT" ) 
	sVal = F_EPURE_CHAINE ( sVal, "EXCL_SLASHX2" )
	idw_Wsin.SetItem ( 1, "MODL_PORT", sVal ) 
End If 

iUoGsSpSinistre2.uf_Set_ValInstance ( "isReferentielApp", isReferentielApp )

Return isReferentielApp 

end function

private subroutine uf_initialiserfenetre (ref s_pass astpassdga);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_InitialiserFenetre (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 07/01/1998 10:49:34
//* Libellé			: 
//* Commentaires	: Initialisation de la fenêtre de sinistre
//*
//* Arguments		: s_Pass						astPassDga		(Réf)
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   

//* 
//* #1	 CAG	 17/07/2002	  Modification SFR #
//*								  si cod_adh <> 1 et 6 => gestion de la zone
//* #3	 CAG	 06/02/2003	  Suite DCMP 030027 : Ajout du chgt de la table DET_PRO
//* #4	 CAG   05/03/2003	  DCMP 030135 : Ajout d'une table des boutiques
//* #5	 CAG   10/06/2003	  Modification de la marque portable en dddw
//* #6    JFF   26/08/2003   DCMP 030362 Gestion des communes O/N
//* #7 	 JCA   22/08/2006   Suppression chargement DetPro déporté sur uf_preparermodifier
//* #8 	 JCA   24/05/2006   DntMail - chargement de la dddw des noms de domaine
//* #9	 DGA   19/09/2006   Gestion d'un répertoire temporaire DCMP-060643
//* #10	 PHG	 10/11/2006	  Gestion Multi référentiel
//        JFF   10/08/2017   [MOTIF_SSUITE_90]
//*-----------------------------------------------------------------

DataWindowChild		dwChild, dwChild1

String sCol[]
String sRep, sFiltre, sFic

/*------------------------------------------------------------------*/
/* On initialise l'objet de transaction de dw_wSIn.                 */
/*------------------------------------------------------------------*/
idw_wSin.Uf_SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* On récupére les DDDW qui ne changent jamais.                     */
/* Colonnes COD_I_DECL, COD_CIV, COD_DEC_MAC, COD_DEC_OPE,          */
/* COD_ETAT, COD_MOT_SSUI, ID_TYPE_CARTE.                           */
/*------------------------------------------------------------------*/

idw_wSin.GetChild ( "COD_I_DECL", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-IN" )

idw_wSin.GetChild ( "COD_CIV", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-CI", "-CL" )

idw_wSin.GetChild ( "COD_DEC_MAC", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-ET" )

idw_wSin.GetChild ( "COD_DEC_OPE", dwChild1 )
dwChild.ShareData ( dwChild1 )

idw_wSin.GetChild ( "COD_ETAT", dwChild1 )
dwChild.ShareData ( dwChild1 )

idw_wSin.GetChild ( "COD_MOT_SSUI", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-SS" )


/*------------------------------------------------------------------*/
/* #10 [DCMP060405] PHG 10/11/2006                                  */
/* Gestion Multi Référentiel - regroupement par famille de code.    */
/* On gère les marques par famille de code                          */
/* - Déport du chargement des marque dans la dddw                   */
/*   dans uf_preparer_modifier                                      */
/*------------------------------------------------------------------*/
//idw_wSin.GetChild ( "MARQ_PORT", dwChild )
//dwChild.SetTransObject ( This.itrTrans )
//dwChild.Retrieve ( "-MB" )
//dwChild.SetSort ( "LIB_CODE A" )
//dwChild.Sort ()

idw_wSin.GetChild ( "ID_TYPE_CARTE", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-TC" )

/*------------------------------------------------------------------*/
/* On s'occupe de récupérer les différents types de frais pour      */
/* populiser une DDDW dans la table W_FRAIS.                        */
/*------------------------------------------------------------------*/
idw_wFrais.GetChild ( "ID_TYP_FRAIS", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "+NF" )

/*------------------------------------------------------------------*/
/* #8 - Récupération des différents noms de domaines pour   		  */
/* rapatrier la DDDW dans d_sp_sin_lst_inter.                       */
/*------------------------------------------------------------------*/
idw_LstInter.GetChild ( "ADR_MAIL_DOMAIN", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-FI" )

/*------------------------------------------------------------------*/
/* On initialise les autres DDDW à vide. Le retrieve sera effectué  */
/* sur la modification.                                             */
/*------------------------------------------------------------------*/
idw_wSin.GetChild ( "ID_NATSIN", dwChild )
dwChild.InsertRow ( 0 )

idw_wSin.GetChild ( "ID_TERRIT", dwChild )
dwChild.InsertRow ( 0 )

idw_wSin.GetChild ( "ID_DETSIN", dwChild )
dwChild.InsertRow ( 0 )

/*------------------------------------------------------------------*/
/* On s'occupe des colonnes qui peuvent changer de couleur, en      */
/* fonction de la saisie.                                           */
/*------------------------------------------------------------------*/
sCol [  1 ] = "REF_CIE"
sCol [  2 ] = "DTE_SURV_DATE"
sCol [  3 ] = "HEU_SURV"
sCol [  4 ] = "ID_NATSIN"
sCol [  5 ] = "ID_TERRIT"
sCol [  6 ] = "ID_DETSIN"
sCol [  7 ] = "ADR_1"
sCol [  8 ] = "ADR_2"
sCol [  9 ] = "ADR_CP"
sCol [ 10 ] = "ADR_VILLE"
sCol [ 11 ] = "NUM_FAX"
sCol [ 12 ] = "NUM_TELB"
sCol [ 13 ] = "NUM_TELD"
sCol [ 14 ] = "COD_MOT_SSUI"
/*------------------------------------------------------------------*/
/* # 1											                             */
/*------------------------------------------------------------------*/
sCol [ 15 ] = "NUM_PORT"
sCol [ 16 ] = "NUM_IMEI_PORT"
sCol [ 17 ] = "MARQ_PORT"
sCol [ 18 ] = "MODL_PORT"
sCol [ 19 ] = "DTE_ACH_PORT"
sCol [ 20 ] = "DTE_OUVLIG_PORT"
/*------------------------------------------------------------------*/
/* # 2											                             */
/*------------------------------------------------------------------*/
sCol [ 21 ] = "ID_ORIAN_BOUTIQUE"
sCol [ 22 ] = "DTE_RESIL"

idw_wSin.Uf_InitialiserCouleur ( sCol )
idw_DosSuiviPar.Uf_InitialiserCouleur ( { "DOS_SUIVI_PAR" } )

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On s'occupe maintenant des interlocuteurs.                       */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On récupére les DDDW qui ne changent jamais.                     */
/* Colonnes COD_INTER, COD_CIV, COD_MOD_REG, ID_NAT_COUR.           */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Pour le code interlocuteur, on peut faire un ShareData.          */
/*------------------------------------------------------------------*/
idw_wSin.GetChild ( "COD_I_DECL", dwChild )
idw_LstInter.GetChild ( "COD_INTER", dwChild1 )
dwChild.ShareData ( dwChild1 )

/*------------------------------------------------------------------*/
/* Pour la civilité, on peut faire un ShareData                     */
/*------------------------------------------------------------------*/
idw_wSin.GetChild ( "COD_CIV", dwChild )
idw_LstInter.GetChild ( "COD_CIV", dwChild1 )
dwChild.ShareData ( dwChild1 )

/*------------------------------------------------------------------*/
/* Pour COD_MOD_REG, on populise avec la table CODE_CAR (-MR).      */
/*------------------------------------------------------------------*/
idw_LstInter.GetChild ( "COD_MODE_REG", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-MR" )

/*------------------------------------------------------------------*/
/* Pour ID_NAT_COUR, on initialise la DDDW à vide. Le retrieve sera */
/* effectué sur la modification. En effet cette zone est            */
/* dépendante du code produit.                                      */
/*------------------------------------------------------------------*/
idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
dwChild.InsertRow ( 0 )

/*------------------------------------------------------------------*/
/* On n'oublie pas de positionner la chaîne de Tri, sinon elle est  */
/* initialisée par défaut à #1 A.(Méthode ancêtre).                 */
/*------------------------------------------------------------------*/
idw_LstInter.isTri = "ID_I A"

/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* On s'occupe maintenant des garanties.                            */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
idw_LstGti.isTri = "ID_GTI A"
idw_LstGti.Uf_Activer_Selection ( True )

/*------------------------------------------------------------------*/
/* Si on est en Consultation/Validation, on va initialiser les      */
/* zones en protect une seule fois.                                 */
/*------------------------------------------------------------------*/
If	isTypeTrt = "C" Or isTypeTrt = "V" Then
	Uf_Tb_Validation ()
End If

/*------------------------------------------------------------------*/
/* Le nom du fichier de trace pour la modifications des adresses.   */
/*------------------------------------------------------------------*/
sRep = ProfileString ( stGLB.sFichierIni, "TRACE", "REP_TRACE_ADR", "" )
isFicTraceAdr = sRep + String ( Today (), "ddmmyyyy" ) + "." + Left ( stGLB.sCodAppli, 3 )

/*------------------------------------------------------------------*/
/* On initialise le UserObjet pour la gestion des variables.        */
/*------------------------------------------------------------------*/
iuoLibelle.Uf_Initialisation ( itrTrans )
ilTotVar = iuoLibelle.Uf_Retrieve ( "-VA" )

/*------------------------------------------------------------------*/
/* On récupére la liste des Polices/Compagnies pour la gestion des  */
/* variables.                                                       */
/*------------------------------------------------------------------*/
idw_Police.Retrieve ()

/*------------------------------------------------------------------*/
/* On récupére la liste des libellé pour la gestion des contacts.   */
/*------------------------------------------------------------------*/
idw_LstContact.Uf_Activer_Selection ( True )

idw_LstContact.GetChild ( "ID_CANAL", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-CR" )

idw_LstContact.GetChild ( "ID_TYP_MSG", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( )

idw_LstContact.GetChild ( "ID_NAT_MSG", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( )

/*------------------------------------------------------------------*/
/* Chargement des codes pour les commandes.                         */
/*------------------------------------------------------------------*/
idw_LstwCommande.GetChild ( "ID_TYP_ART", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-AR" )
idw_CmdTypArt.GetChild ( "ID_CODE_ART", dwChild1 )
dwChild.ShareData ( dwChild1 )

idw_LstwCommande.GetChild ( "COD_ETAT", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-EC" )

idw_LstwCommande.GetChild ( "ID_FOUR", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-FR" )
idw_CmdTypFrn.GetChild ( "ID_CODE_FRN", dwChild1 )
dwChild.ShareData ( dwChild1 )

/*------------------------------------------------------------------*/
/* # Modification SFR # Le 17/07/2002.                              */
/*------------------------------------------------------------------*/
idw_LstwCommande.GetChild ( "ID_BSP", dwChild )
dwChild.SetTransObject ( This.itrTrans )
dwChild.Retrieve ( "-BR" )

/*------------------------------------------------------------------*/
/* # Modification SFR # Le 03/09/2002.                              */
/*------------------------------------------------------------------*/
idw_wSin.GetChild ( "COD_CIV", dwChild )
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild1 )
dwChild.ShareData(dwChild1)

/*----------------------------------------------------------------------------*/
/* Chargement des corbeilles accessible par le user courant.                  */
/*----------------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #9. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//sFic = isRepWin + "\TEMP\CORB" + stGlb.sCodAppli + ".TXT"
sFic = stGLB.sRepTempo + "CORB" + stGlb.sCodAppli + ".TXT"
//Migration PB8-WYNIWYG-03/2006 FM
//If FileExists ( sFic ) Then 
If f_FileExists ( sFic ) Then 
//Fin Migration PB8-WYNIWYG-03/2006 FM
	idw_Corbeille.Reset ()
	idw_Corbeille.ImportFile ( sFic ) 
End If

/*----------------------------------------------------------------------------*/
/* Populisation de la DDDW des utilisateurs.                                  */
/*----------------------------------------------------------------------------*/
idw_DosSuiviPar.GetChild ( "DOS_SUIVI_PAR", dwChild )
/*------------------------------------------------------------------*/  
/* #9. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//sFic = isRepWin + "\TEMP\OPER" + stGlb.sCodAppli + ".TXT"
sFic = stGLB.sRepTempo + "OPER" + stGlb.sCodAppli + ".TXT"

//Migration PB8-WYNIWYG-03/2006 FM
//If FileExists ( sFic ) Then
If f_FileExists ( sFic ) Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
	dwChild.Reset ()
	dwChild.ImportFile ( sFic )
End If
idw_DosSuiviPar.Modify ( "dos_suivi_par_t.text = 'Dossier suivi par'" )

/*------------------------------------------------------------------*/
/* # Modification SFR # Le 27/09/2002.                              */
/*------------------------------------------------------------------*/
This.uf_ActiverBmGme ( FALSE )

/*------------------------------------------------------------------*/
/* #4                                                               */
/*------------------------------------------------------------------*/
idw_wSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
idw_Boutique.ShareData ( dwChild )

/*------------------------------------------------------------------*/
/* DCMP 030362 Gestion des communes O/N                             */
/*------------------------------------------------------------------*/
ibAltCommune = astPassDga.bTab [1] 

/*------------------------------------------------------------------*/
/* Partage pour les dddw Référentiel IFR.                           */
/*------------------------------------------------------------------*/
idw_wSin.GetChild ( "MARQ_PORT2", dwChild )
idddw_IfrMarque.ShareData ( dwChild )

idw_wSin.GetChild ( "MODL_PORT2", dwChild )
idddw_IfrModele.ShareData ( dwChild )

/*------------------------------------------------------------------*/
/* Partage pour les dddw Référentiel DARTY.                         */
/*------------------------------------------------------------------*/
idw_wSin.GetChild ( "MARQ_PORT3", dwChild )
idddw_DtyMarque.ShareData ( dwChild )

idw_wSin.GetChild ( "MODL_PORT3", dwChild )
idddw_DtyModele.ShareData ( dwChild )



end subroutine

public function string uf_gestong_divers_trouver (string asnomzone);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GestOng_Divers_Trouver (PUBLIC)
//* Auteur        : Fabry JF
//* Date          : 29/09/2004 11:13:57
//* Libellé       : Trouver une valeur sur une zone de l'oglet divers
//* Commentaires  : 
//*
//* Arguments		: String			asNomZone		Val
//*
//* Retour			: String
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//* #1	 PHG	 29/12/2006   [CRAO_LOT1] GEStion Cra IMEI
//* #2    JFF	 06/02/2006   [SITE_CMDE] 
//* #3	 JFF	 29/08/2007	  [DCMP070587] - Charte souplesse SFR
//* #4	 PHG	 29/02/2008	  [DCMP080111] Création des Variables ZVAR35 à 39
//* 								  Refonte Fonction => Forme Générique
//*-----------------------------------------------------------------

Long lTot, lFound
String sNomZone, sData, sIdTypZone

sData = ""

lTot = idw_WdivSin.RowCount ()

lFound = idw_WDivSin.Find("UPPER(NOM_ZONE) = '" + Upper ( asNomZone ) + "'", 1, lTot )

if lfound > 0 Then
	sIdTypZone = idw_WDivSin.object.id_typ_zone[lFound]
	Choose Case sIdTypZone
		Case 'C', 'X', 'LC'
			sData = Upper ( idw_WDivSin.GetItemString ( lFound, "VAL_CAR" ) )
		Case 'D'
			sData = String ( idw_WDivSin.GetItemDateTime ( lFound, "VAL_DTE" ), "dd/mm/yyyy"  )	// [PI056].20190926
		Case 'N', 'LN'
			sData = String ( idw_WDivSin.GetItemNumber ( lFound, "VAL_NBRE" ) ) 
		Case 'S'
			sData = String ( idw_WDivSin.GetItemdecimal ( lFound, "VAL_MT" ), "#,##0.00" ) 
		Case 'P'
			sData = String ( idw_WDivSin.GetItemdecimal ( lFound, "VAL_MT" ), "##0.00" ) 
	End Choose

End If

Return sData


end function

private function boolean uf_validation_finale_darty_mail_tel ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Darty_Mail_Tel  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/11/2003 16:43:53
//* Libellé       : Gestion Particulière pour DARTY TELEPHONIE.
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*
//*-----------------------------------------------------------------

Boolean bRet
String  sCasGestionDarty

sCasGestionDarty = This.uf_GestOng_Divers_Trouver ( "ZN_TMP_CAS_GESTION" )
bRet = False

// #2
If sCasGestionDarty = "" Then
	
	// #3
	If this.uf_GetAutorisation2(208) Then Return TRUE

	stMessage.sTitre		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YesNo!
	stMessage.sVar[1]		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
	stMessage.sVar[2]		= "DARTY ASSURANCE"
	stMessage.sCode		= "COMD301"

	If F_Message ( stMessage ) = 2 Then
		Return FALSE
	Else 
		Return TRUE
	End If

End  If 

Choose Case sCasGestionDarty

	Case "MAIL_AVEC_PROPO"
		bRet = This.uf_Validation_Finale_Darty_Mail_Tel19 ()

	Case "MAIL_SANS_PROPO"
		bRet = This.uf_Validation_Finale_Darty_Mail_Tel29 ()
		
End Choose

Return bRet

end function

private function boolean uf_validation_finale_darty_mail_nomade ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Darty_Mail_Nomade  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/11/2003 16:43:53
//* Libellé       : Gestion Particulière pour DARTY NOMADE
//* Commentaires  : Aiguillage pour construction du mail adapté pour DARTY Nomade
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1   JFF    01/10/2007   [DCMP070689] complèment Darty Swap&DartyMP
//* #2   JFF    28/01/2008   [DCMP080028]
//* #3   JFF    22/04/2008   [DCMP080286] Ajout Shunt pour le rôle Factu 208
//* #4   JFF    10/08/2009   [O2M_DIAG_NOMADE].[JFF].[20090810171940623]
//*      JFF    16/02/2012   [ITSM105388]
//*      JFF    16/02/2012   [ITSM126869]
//*-----------------------------------------------------------------

Boolean bRet
String  sCasGestionDarty, sFiltre, sFiltreOrig, sTypApp
Long lTotCmd

sCasGestionDarty = This.uf_GestOng_Divers_Trouver ( "ZN_TMP_CAS_GESTION" )
bRet = FALSE

// #2
// [ITSM126869]
/* Supprimer par l'ITSM 126869
	If sCasGestionDarty = "" Then
		
		// #3
		If this.uf_GetAutorisation2(208) Then Return TRUE
	
		stMessage.sTitre		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= YesNo!
		stMessage.sVar[1]		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
		stMessage.sVar[2]		= "DARTY ASSURANCE ou DARTY SAV TREMBLAY"
		stMessage.sCode		= "COMD301"
	
		If F_Message ( stMessage ) = 2 Then
			Return FALSE
		Else 
			Return TRUE
		End If
	
	End  If 
*/	


sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'DST' " 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then 
	bRet = This.uf_Validation_Finale_Darty_Mail_Nomade19 ()
End If

If lTotCmd <= 0 Then
	sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
	 "COD_ETAT   = 'CNV' AND " + &  
	 "CPT_VALIDE <= 0    AND " + &
	 "ID_FOUR    = 'DTY' "
	
	idw_LstwCommande.SetFilter ( sFiltre )
	idw_LstwCommande.Filter ()
	lTotCmd = idw_LstwCommande.RowCount () 
	
	If lTotCmd > 0 Then 
		bRet = This.uf_Validation_Finale_Darty_Mail_Nomade29 ()
	End If
End If

If lTotCmd <= 0 Then
	sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
	 "COD_ETAT   = 'CNV' AND " + &  
	 "CPT_VALIDE <= 0    AND " + &
	 "ID_FOUR    = 'DTY' " 
	
	idw_LstwCommande.SetFilter ( sFiltre )
	idw_LstwCommande.Filter ()
	lTotCmd = idw_LstwCommande.RowCount () 
	
	If lTotCmd > 0 Then 
		bRet = This.uf_Validation_Finale_Darty_Mail_Nomade39 ()
	End if
End If	

If lTotCmd <= 0 Then
	sFiltre = "ID_TYP_ART = '" + sTypApp + "' AND " + &		
		 "COD_ETAT   = 'CNV' AND " + &  
		 "CPT_VALIDE <= 0    AND " + &
		 "ID_FOUR    = 'DTY' AND " + &
		 "ISNUMBER ( PROBLEME )"
	
	idw_LstwCommande.SetFilter ( sFiltre )
	idw_LstwCommande.Filter ()
	lTotCmd = idw_LstwCommande.RowCount () 
	
	If lTotCmd > 0 Then 
		bRet = This.uf_Validation_Finale_Darty_Mail_Nomade49 ()
	End If
End If	

If lTotCmd <= 0 Then
	bRet = True
End If

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()
idw_LstwCommande.Sort ()


/* ancien code
	Choose Case sCasGestionDarty
	
		Case "11/NPCP/>300/PRS_DST"
			bRet = This.uf_Validation_Finale_Darty_Mail_Nomade1 ()
	
		Case "11/NPCP/<=300/CMD_DTY", "11/NPCP/>300/PRS_DST_ANN/CMD_DTY", "10/NPCP/CMD_DTY"
			bRet = This.uf_Validation_Finale_Darty_Mail_Nomade2 ()
	
		Case "11/PCP/PRS_DTY"
			bRet = This.uf_Validation_Finale_Darty_Mail_Nomade3 ()
	
		Case "10/PCP/CMD_DTY", "11/PCP/CMD_DTY", "11/NPCP/PROPO/<=300/CMD_DTY", & 
				"11/NPCP/PROPO/>300/DST_ANN/CMD_DTY", "10/NPCP/PROPO/CMD_DTY"  // #1 #2
			bRet = This.uf_Validation_Finale_Darty_Mail_Nomade4 ()
	
	
		// #4 [O2M_DIAG_NOMADE].[JFF].[20090810171940623][ITSM105388]
		Case "11/NPCP/DIAG_O2M", "11/PCP/DIAG_O2M", "11/NPCP/REPAR/IPAD/O2M", &
				"11/NPCP/>300/PRS_DST_EC", "11/NPCP/>300/PRS_O2M_EC"
			// Aucun mail dans ce cas
			bRet = True
	
	End Choose
*/

Return bRet

end function

private function boolean uf_terminervalider_wdivsin_caspart ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_TerminerValider_wDivSin_CasPart (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/06/2004 15:34:24
//* Libellé       : Gestion des cas particulier pour Maj wDivSin
//* Commentaires  : 
//*
//* Arguments     : 
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    27/01/2010  [DCMP090283]
//        JFF    23/05/2012  [PM103][1]
//*-----------------------------------------------------------------

Boolean bMemoriser, bRet
Long lDeb, lFin
String sSql

bRet = True
// #1 [DCMP090283]
// bMemoriser = FALSE
bMemoriser = TRUE

// #1 [DCMP090283]
/*
// Darty Nomade
If Not bMemoriser Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 31 )
	bMemoriser = lDeb > 0 
End If 

// Media Saturn
If Not bMemoriser Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 71 )
	bMemoriser = lDeb > 0 
End If 
*/
// :#1 [DCMP090283]

Choose Case TRUE
	Case bMemoriser 

		/*------------------------------------------------------------------*/
		/* Mémorisation dans W_div_sin de façon temporaire du cas de        */
		/* gestion DARTY NOMADE difficile à déterminer. Cela évitera lors   */
		/* e la validation finale de recalculer ce cas de gestion.          */
		/*------------------------------------------------------------------*/
		If gsCasGestion <> "" Then
			sSql = "EXEC sysadm.PS_I02_W_DIV_SIN " + String (idw_Wsin.GetItemNumber ( 1, "ID_SIN" ) ) + ", '" + gsCasGestion + &
					 "', '" + stGlb.sCodOper + "'" 

			F_EXECUTE (  sSql , SQLCA )
			bRet = SQLCA.SqlDbCode = 0 And SQLCA.SqlCode = 0
		End If

		// [PM103][1]
		If gbModeReprise_223 Then
			sSql = "EXEC sysadm.PS_I_W_DIV_SIN_PM103 " + String (idw_Wsin.GetItemNumber ( 1, "ID_SIN" ) ) + ", '" + stGlb.sCodOper + "'" 
			F_EXECUTE (  sSql , SQLCA )
			bRet = SQLCA.SqlDbCode = 0 And SQLCA.SqlCode = 0
		End If
		// [PM103][1]
		


End Choose

Return bRet
end function

private subroutine uf_tb_dteresil ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Tb_DteResil (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 14/09/2005
//* Libellé			: 
//* Commentaires	: Gestion Protection Dte_Resil
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

String sCol[ 1 ]
Long lDeb, lFin
Boolean bOption40

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 40 )
bOption40 = lDeb > 0 

sCol[ 1 ] = "DTE_RESIL"

/*------------------------------------------------------------------*/
/* Si le montant réglé est supérieur strictement à zéro, les zones  */
/* ne sont pas saisissables.                                        */
/*------------------------------------------------------------------*/

If	idw_wSin.GetItemNumber ( 1, "MT_REG" ) > 0 Or Not bOption40 Then
	idw_wSin.Uf_Proteger ( sCol, "1" )

	idw_wSin.ilPremCol	= 37						// Zne REF_CIE
	idw_wSin.isNomCol		= "REF_CIE"

	idw_wSin.ilDernCol	= 47						// Zne ALT_BLOC

Else
	idw_wSin.Uf_Proteger ( sCol, "0" )

	idw_wSin.ilPremCol	= 56						// Zne DTE_SURV_DATE
	idw_wSin.isNomCol		= "DTE_SURV_DATE"

	If	idw_wSin.GetItemString ( 1, "ALT_SSUI" ) = "O"	Then
		idw_wSin.ilDernCol	= 44						// Zne COD_MOT_SSUI
	Else
		idw_wSin.ilDernCol	= 43						// Zne ALT_SSUI
	End If

End If


end subroutine

private subroutine uf_gestion_dtefingti_orangev2 (date addteresil, string ascas);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Gestion_DteFinGti_OrangeV2 (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 13/09/2005 17:40:17
//* Libellé       : Calcul date de fin de garantie spécial pour ORANGE V2 sur option -DP/39
//* Commentaires  : DCMP 050395
//*
//* Arguments     : Date		adDteResil		Date
//*					  String		asCas				Val	"SAISIE"/"BASE"
//*
//* Retourne      : Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

Boolean	bOrangeV2
Date	   dDteFinGti, dDteAdh, dDteCalc, dDteNull
DateTime dtDteSurv, dtDteCalc 
Long 		lDeb, lFin 
String 	sDteFinGti, sDteCalc, sJourAdh 

SetNull ( dDteNull )

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 39 )
bOrangeV2 = lDeb > 0 

If Not bOrangeV2 Then Return

/*------------------------------------------------------------------*/
/* Algorithme définit par S. Thévenard et C. Chauvin.               */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Lecture Date Résiliation                                         */
/* Si absent, on garde l'éventuelle date de fin gti présente.		  */
/*------------------------------------------------------------------*/
If String ( adDteResil ) = "01/01/1900" Then adDteResil = stNul.Dat

If IsNull (adDteResil) And asCas = "BASE" Then
	adDteResil = idw_Wsin.GetItemDate ( 1, "DTE_RESIL" ) 
End If

If IsNull ( adDteResil ) Then 
	// [EVOL_REFUS_603_PNP] 
	dtDteSurv = idw_Wsin.GetItemDateTime ( 1, "DTE_SURV" ) 
	dDteCalc = Date ( dtDteSurv )
	dDteCalc = F_Plus_Date ( dDteCalc, 1, "J" )
	dtDteCalc = DateTime ( dDteCalc )
	idw_Wsin.SetItem ( 1, "DTE_FIN_GTI", dtDteCalc )
	Return
End If

/*------------------------------------------------------------------*/
/* Lecture Date Adh.																  */
/* Si absent, on garde l'éventuelle date de fin gti présente.		  */
/*------------------------------------------------------------------*/
dDteAdh = idw_Wsin.GetItemDate ( 1, "DTE_ADH" ) 
If IsNull ( dDteAdh ) Then Return

/*------------------------------------------------------------------*/
/* découpage du jour d'adhésion.                                    */
/*------------------------------------------------------------------*/
sJourAdh = Left ( String ( dDteAdh ), 2 ) 

/*------------------------------------------------------------------*/
/* Date de calcul : DTE_RESIL + 1 mois                              */
/*------------------------------------------------------------------*/
dDteCalc = F_Plus_Date ( adDteResil, 1, "M" )
sDteCalc = String ( dDteCalc ) 

/*------------------------------------------------------------------*/
/* DTE_FIN_GTI = Jour de l'adhésion + ( Mois Résil/Année Résil ) +  */
/* 1 Mois                                                           */
/*------------------------------------------------------------------*/
sDteFinGti = sJourAdh + Right ( sDteCalc , 8 )

/*------------------------------------------------------------------*/
/* Par ce principe on peut tomber sur des 31/02/..., donc tant que  */
/* la date n'est pas valide, on réduti d'un jour.                   */
/*------------------------------------------------------------------*/
Do While Not IsDate ( sDteFinGti )
	sJourAdh = ( String ( Long ( sJourAdh ) - 1, "00" ) )
	sDteFinGti = sJourAdh + Right ( sDteCalc , 8 )
Loop

dDteFinGti = Date ( sDteFinGti )

If Not IsNull ( dDteFinGti ) Then
	idw_Wsin.SetItem ( 1, "DTE_FIN_GTI", DateTime(dDteFinGti)  ) // [PI056]
	idw_Wsin.SetItem ( 1, "DTE_FIN_GTI_PREC", DateTime(dDteFinGti)  ) // [PI056]
End If


end subroutine

private subroutine uf_gestion_dtefingti (date addteresil, string ascas);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Gestion_DteFinGti (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 10/01/2005 17:40:17
//* Libellé       : Gestion particulière de la date de fin de garantie
//* Commentaires  : DCMP L. Fouquier DCMP 050018 : Calcul automatique d'une date de fin de GTI
//*					  pour les produits 1 an ou 2 an définit dans DET_PRO comme tel.
//*
//* Arguments     : Date		adDteResil			Val
//						  String		asCas					Val	"SAISIE"/"BASE"
//*
//* Retourne      : Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #2	 JFF	20/10/2008	  [FNAC_PROD_ECH_TECH]
//*       JFF  21/06/2011    [PC545].[POINT][9]
//*       FPI  19/10/2011    [VDoc5713] Ajout de l'écrasement de la date de gti
//*-----------------------------------------------------------------

Boolean	bOption_29, bOrangeV2
Date	   dDteAdh, dDteFinGti
Long lDeb, lFin
n_cst_string lnvPFCString
String sDuree, sUnite, sDureeMinMaj, sUniteMinMaj, sEcraser
Boolean bEcraser

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 29 )

//* #1 [FNAC_PROD_ECH_TECH]
bOption_29 = lDeb > 0 
If bOption_29 Then
	sDuree = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DUREE", ";")
	sUnite = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "UNITE", ";")

	// [PC545].[POINT][9]
	sDureeMinMaj = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DUREE_MINMAJ", ";")
	sUniteMinMaj = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "UNITE_MINMAJ", ";")
	// :[PC545].[POINT][9]
	
	//  [VDoc5713] 
	sEcraser = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "RECALCUL_DTE_FIN_GTI", ";")
	bEcraser=( sEcraser="OUI")
End If

// F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 30 )
// bOption_2ANs = lDeb > 0
//* :#1 [FNAC_PROD_ECH_TECH]

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 39 )
bOrangeV2 = lDeb > 0 

If bOrangeV2 Then
	This.uf_Gestion_DteFinGti_OrangeV2 (adDteResil, asCas )

ElseIf bOption_29  Then
	//* #1 [FNAC_PROD_ECH_TECH]
	// [PC545].[POINT][9]
	This.uf_Gestion_DteFinGti_DP29 ( sDuree, sUnite, sDureeMinMaj, sUniteMinMaj,bEcraser )
End If


end subroutine

private function integer uf_zn_dteresil ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_DteResil (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 14/09/2005
//* Libellé			: Modification de la zone DTE_RESIL
//* Commentaires	: 	
//*
//* Arguments		: Aucun
//*
//* Retourne		: Integer	iAction
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer				iAction
Date 					dDteAdh, dDteResil

iAction = 0
idw_wSin.iiErreur = 1

dDteResil = Date ( idw_wSin.GetText () )
dDteAdh	 = idw_Wsin.GetItemDate ( 1, "DTE_ADH" )

If IsNull ( dDteAdh ) And iAction = 0 Then
	iAction = 1
	idw_wSin.iiErreur = 1
	// Si pas de dteadh alors pas de saisi de dte résil
End If 

If dDteAdh > dDteResil And iAction = 0 Then
	iAction = 1
	idw_wSin.iiErreur = 2
	// Dte_Resil doit être inf ou eg à dteadh
End If 

If dDteResil > Today () And iAction = 0 Then
	iAction = 1
	idw_wSin.iiErreur = 3
	// Dte_Resil doit être Sup ou eg à dteadh
End If 

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wSin.SetActionCode ( iAction )
//Fin Migration PB8-WYNIWYG-03/2006 OR
Return (iAction)

end function

private function string uf_determiner_etat (integer aitype, string ascas, ref long alcodetat);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Determiner_Etat (PRIVATE)
//* Auteur			: DBI
//* Date				: 18/08/1998 09:27:01
//* Libellé			: 
//* Commentaires	: Détermination du Code Etat du sinistre
//*
//* Arguments		: Integer		aiType			(Val)
//*					  String			asCas				(Val) ECRIRE/CALCULER
//*					  Integer		alCodEtat		(Ref) Code état Calculer
//*
//* Retourne		: String
//*
//*-----------------------------------------------------------------

String sRet, sRech, sAltVAlide

Long lVal
Long lCodDecMac, lCodDecOpe, lCodEtat
Long lTotGti, lTotDetail, lCptDetail, lCptGti
Long lLigGti, lLigDet, lCodMotSsuiSin
Boolean bEcrire 

bEcrire = Upper ( asCas ) = "ECRIRE"

lVal = 0
sRet = ""

Choose Case aiType
Case 1					//	Détermination du Code Etat Machine (COD_DEC_MAC)

	If			idw_wSin.GetItemString ( 1, "ALT_BLOC" ) = "O"	Or Uf_Determiner_Etat_Garantie ( 1 ) Then
				lVal = 1
	ElseIf	Uf_Determiner_Etat_Garantie ( 0 ) Then				// y a t il des garanties "non contrôlé"
/*------------------------------------------------------------------*/
/* Si au moins 1 garantie non contrôlé et que le sinistre n'est pas */
/* bloqué,  on provoque un message d'erreur                         */
/*------------------------------------------------------------------*/
				lVal = 0
	ElseIf	idw_wSin.GetItemString ( 1, "ALT_SSUI" ) = "O" Or Uf_Determiner_Etat_Garantie ( 2 )	Then
					lVal = 900
	Else

/*------------------------------------------------------------------*/
/* Si au moins une des garantie est refusée ET                      */
/* qu'il n'y a aucune garantie REGLE, A REGLER ou EN COURS DE REG	ET*/
/* qu'il n'y a aucune garantie en demande de piéce ou en attente    */
/* alors on refuse le sinistre                                      */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 3 ) 	And &
					Uf_Determiner_Etat_Garantie ( 4 ) 	And &
					Uf_Determiner_Etat_Garantie ( 5 ) 	Then

						lVal = 200
				End If

/*------------------------------------------------------------------*/
/* Si au moins une garantie en demande de piéce ou en attente       */
/* qu'il n'y a aucune garantie REGLE, A REGLER ou EN COURS DE REG	ET*/
/* alors le sinistre est en cours d'instruction                     */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 6 ) 	And &
					Uf_Determiner_Etat_Garantie ( 4 ) 	Then

						lVal = 100
				End If
/*------------------------------------------------------------------*/
/* Si au moins une garantie en demande de piéce ou en attente       */
/* qu'il y a au moins une garantie REGLE, A REGLER ou EN COURS REG  */
/* alors le sinistre est en cours de règlement                      */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 6 ) 	And &
					Uf_Determiner_Etat_Garantie ( 7 ) 	Then

						lVal = 550
				End If

/*------------------------------------------------------------------*/
/* Si il y a au moins une garantie EN COURS DE REGLEMENT            */
/* alors le sinistre est en cours de règlement                      */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 8 ) 	Then

						lVal = 550
				End If


/*------------------------------------------------------------------*/
/* Si il y a au moins une garantie A REGLER                         */
/* alors le sinistre est a regler                                   */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 9 ) 	Then

						lVal = 500
				End If

/*------------------------------------------------------------------*/
/* Si il y a au moins une garantie REGLE                            */
/* alors le sinistre est REGLE                                      */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 10 ) 	Then

						lVal = 600
				End If

	End If	
	If bEcrire Then 
		idw_wSin.SetItem ( 1, "COD_DEC_MAC", lVal )
	Else
		ilCodEtatMac = lVal 
		alCodEtat = lVal
	End If

Case 2					//	Détermination du Code Etat Opérateur (COD_DEC_OPE)

	If			idw_wSin.GetItemString ( 1, "ALT_BLOC" ) = "O"	Or Uf_Determiner_Etat_Garantie ( 1 ) Then
				lVal = 1
	ElseIf	Uf_Determiner_Etat_Garantie ( 0 ) Then				// y a t il des garanties "non contrôlé"
/*------------------------------------------------------------------*/
/* Si au moins 1 garantie non contrôlé et que le sinistre n'est pas */
/* bloqué,  on provoque un message d'erreur                         */
/*------------------------------------------------------------------*/
				lVal = 0
	ElseIf	idw_wSin.GetItemString ( 1, "ALT_SSUI" ) = "O" Or Uf_Determiner_Etat_Garantie ( 2 )	Then
					lVal = 900
	Else

/*------------------------------------------------------------------*/
/* Si au moins une des garantie est refusée ET                      */
/* qu'il n'y a aucune garantie REGLE, A REGLER ou EN COURS DE REG	ET*/
/* qu'il n'y a aucune garantie en demande de piéce ou en attente    */
/* alors on refuse le sinistre                                      */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 3 ) 	And &
					Uf_Determiner_Etat_Garantie ( 4 ) 	And &
					Uf_Determiner_Etat_Garantie ( 5 ) 	Then

						lVal = 200
				End If

/*------------------------------------------------------------------*/
/* Si au moins une garantie en demande de piéce ou en attente       */
/* qu'il n'y a aucune garantie REGLE, A REGLER ou EN COURS DE REG	ET*/
/* alors le sinistre est en cours d'instruction                     */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 6 ) 	And &
					Uf_Determiner_Etat_Garantie ( 4 ) 	Then

						lVal = 100
				End If
/*------------------------------------------------------------------*/
/* Si au moins une garantie en demande de piéce ou en attente       */
/* qu'il y a au moins une garantie REGLE, A REGLER ou EN COURS REG  */
/* alors le sinistre est en cours de règlement                      */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 6 ) 	And &
					Uf_Determiner_Etat_Garantie ( 7 ) 	Then

						lVal = 550
				End If

/*------------------------------------------------------------------*/
/* Si il y a au moins une garantie EN COURS DE REGLEMENT            */
/* alors le sinistre est en cours de règlement                      */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 8 ) 	Then

						lVal = 550
				End If


/*------------------------------------------------------------------*/
/* Si il y a au moins une garantie A REGLER                         */
/* alors le sinistre est a regler                                   */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 9 ) 	Then

						lVal = 500
				End If

/*------------------------------------------------------------------*/
/* Si il y a au moins une garantie REGLE                            */
/* alors le sinistre est REGLE                                      */
/*------------------------------------------------------------------*/

				If	lVal = 0										And &
					Uf_Determiner_Etat_Garantie ( 10 ) 	Then

						lVal = 600
				End If

	End If	

	If bEcrire Then 
		idw_wSin.SetItem ( 1, "COD_DEC_OPE", lVal )
	Else 
		ilCodEtatOpe = lVal
		alCodEtat = lVal
	End If

Case 3					//	Détermination du Code Etat (COD_ETAT)

	If bEcrire Then 
		lCodDecOpe	= idw_wSin.GetItemNumber ( 1, "COD_DEC_OPE" )
		lCodDecMac	= idw_wSin.GetItemNumber ( 1, "COD_DEC_MAC" )
	Else 
		lCodDecOpe	= ilCodEtatMac 
		lCodDecMac	= ilCodEtatOpe 
	End If

	lCodEtat		= 0

/*------------------------------------------------------------------*/
/* Si l'un des états est à 0, il manque des informations, on        */
/* positionne le COD_ETAT à Non controlé.                           */
/*------------------------------------------------------------------*/
	If			lCodDecOpe = 0 Or lCodDecMac = 0	Then
				stMessage.sTitre		= "Contrôle sur le sinistre"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= False
				stMessage.sCode		= "WSIN250"
		
				sRet = "ALT_BLOC"
	Else
			If	lCodDecOpe <> lCodDecMac	Then
				If	Long ( stGLB.sTypOper ) >= idw_Produit.GetItemNumber ( 1, "COD_NIV_OPE" )	Then
					lCodEtat = lCodDecOpe
				Else
					lCodEtat = lCodDecMac
				End If
			Else
				lCodEtat = lCodDecOpe
			End If
	End If

/*------------------------------------------------------------------*/
/* Le 10/12/1998:                                                   */
/* Si le COD ETAT est égal à 900 (SANS SUITE), et que ALT_SSUI est  */
/* égal à OUI (Important, car le sinistre peut être SANS SUITE si   */
/* toutes les garanties sont SANS SUITE et ALT_SSUI peut avoir une  */
/* valeur à NON), on va vérifier s'il existe des garanties A        */
/* VALIDER et si toutes ces garanties sont SANS SUITE. Si ce n'est  */
/* pas le cas, on affiche un message d'avertissement pour           */
/* l'utilisateur. Il doit d'abord passer toutes les garanties SANS  */
/* SUITE.                                                           */
/*------------------------------------------------------------------*/
	If	lCodEtat = 900	And idw_wSin.GetItemString ( 1, "ALT_SSUI" ) = "O" Then
		lTotGti		= idw_LstGti.RowCount ()
		lTotDetail	= idw_wDetail.RowCount ()

		sRech = "COD_ETAT <> 900"
		lLigDet = idw_wDetail.Find ( sRech, 1, lTotDetail )
		lLigGti = idw_LstGti.Find ( sRech, 1, lTotGti )

		If	lLigDet > 0 Or lLigGti > 0 Then
			stMessage.sTitre		= "Contrôle sur le sinistre"
			stMessage.Icon			= Information!
			stMessage.Bouton		= Ok!
			stMessage.bErreurG	= False
			stMessage.sCode		= "WSIN290"

/*------------------------------------------------------------------*/
/* Le message d'erreur sera affiché dans la fonction                */
/* Uf_ControlerGestion (). Il suffit juste d'armer la structure de  */
/* message.                                                         */
/*------------------------------------------------------------------*/
			lCodEtat = 0
			sRet = "ALT_BLOC"
		Else
/*------------------------------------------------------------------*/
/* Toutes les garanties et tous les détails sont SANS SUITE. On     */
/* arme le motif du SANS SUITE du sinistre sur les garanties et     */
/* les détails A VALIDER.                                           */
/*------------------------------------------------------------------*/
			lCodMotSsuiSin	= idw_wSin.GetItemNumber ( 1, "COD_MOT_SSUI" )

			stMessage.sTitre		= "Contrôle sur le sinistre"
			stMessage.Icon			= Information!
			stMessage.Bouton		= Ok!
			stMessage.bErreurG	= False
			stMessage.sCode		= "WSIN300"

			F_Message ( stMessage )

			For	lCptDetail = 1 To lTotDetail
					sAltValide = idw_wDetail.GetItemString ( lCptDetail, "ALT_VALIDE" )
					If	sAltValide = "O"	Then
						idw_wDetail.SetItem ( lCptDetail, "ALT_SSUI", "O" )
						idw_wDetail.SetItem ( lCptDetail, "COD_MOT_SSUI", lCodMotSsuiSin )
						idw_wDetail.SetItem ( lCptDetail, "MT_PREJ", 0.00 )
						idw_wDetail.SetItem ( lCptDetail, "ID_I_REG", stNul.dcm )
					End If
			Next

			For	lCptGti = 1 To lTotGti
					sAltValide = idw_LstGti.GetItemString ( lCptGti, "ALT_VALIDE" )
					If	sAltValide = "O"	Then
						idw_LstGti.SetItem ( lCptGti, "ALT_SSUI", "O" )
						idw_LstGti.SetItem ( lCptGti, "COD_MOT_SSUI", lCodMotSsuiSin )
					End If
			Next
		End If
	End If

	If bEcrire Then 
		idw_wSin.SetItem ( 1, "COD_ETAT", lCodEtat )
	Else
		ilCodEtat = lCodEtat 
		alCodEtat = lCodEtat 
	End If 
End Choose

If Not bEcrire Then sRet = ""
			
Return ( sRet )
end function

private function long uf_zn_dtesurv ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_DteSurv (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 08/01/1998 17:14:39
//* Libellé			: 
//* Commentaires	: Contrôle de DTE_SURV
//*
//* Arguments		: Aucun
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//* #1   JFF   16/04/2008  [DCMP070914] Numération AIG
//*
//*-----------------------------------------------------------------
//*		FPI	18/01/2011	[PC582-583] Révision corrigé selon DP 158
//*      JFF   08/02/2011  [PC301][VETUSTE]
//* 		FPI	20/05/2014	[PM261-1]
//*      JFF   24/06/2019 [PC192235]
//*      JFF   07/06/2021 [RS-496] Blocage modif dte_surv, si présence pré-script avec notion de dte_surv exploitée.
//       JFF   18/11/2024 [KSV649_ORREUCARA]
//*-----------------------------------------------------------------

Date dDteSurv, dDteAdh, dDteDecl, dDteOpt, dDteEffet 
DateTime	dtSurv, dtAdh, dtDteOppo, dtDtePivot

Long dcIdProd, dcIdRev, lTotGti, lIdGti, lCpt
Long lIdSin, lOkAig // #1

Integer iAction

String sIdRev, sHeuSurv
String sMsg // #1

Time tTime
// 	[PC582-583] 
Long lDeb, lFin, iIdScriptDeb
String sValCar, sEffet, sDteEffet, sIdCanal, sHeure
n_cst_string nvString
Date dDtePivot
Boolean bErrDp158

String sVal
n_cst_string lnvPFCString
Boolean bSC2FoyerNomade

dDteDecl	= idw_wSin.GetItemDate ( 1, "DTE_DECL" )
dDteSurv	= Date ( idw_wSin.GetText () )
dDteAdh	= idw_wSin.GetItemDate ( 1, "DTE_ADH" )
lIdSin = idw_wSin.GetItemNumber ( 1, "ID_SIN" ) // #1

sMsg = Fill ( " ", 35 ) // #1

//* JFF 07/06/2021 [RS-496] Blocage modif dte_surv, si présence pré-script avec notion de dte_surv exploitée.
dcIdProd	= idw_wSin.GetItemNumber ( 1, "ID_PROD" )
sIdCanal = idw_wSin.GetItemString ( 1, "COD_DECL" )
SQLCA.PS_S_PRESENCE_PRE_SCRIPT (	dcIdProd, sIdCanal, iIdScriptDeb ) 
If iIdScriptDeb > 0 Then
	idw_wSin.iiErreur = 7
	iAction = 1
	Return iAction 
End If 

/*------------------------------------------------------------------*/
/* La date de survenance doît être supérieure au 01 Janvier 1994    */
/* selon St Denis !!.                                               */
/*------------------------------------------------------------------*/
If			dDteSurv <= Date ( "01/01/1994" ) Then
			idw_wSin.iiErreur = 1
/*------------------------------------------------------------------*/
/* La date de survenance doît être inférieure ou égale à la date    */
/* de déclaration.                                                  */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Ce test est important pour la gestion du refus 621 sur la        */
/* garantie. La zone DTE_DECL est non modifiable sur la dw de       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
ElseIf	dDteSurv > dDteDecl	Then
			idw_wSin.iiErreur = 2
End If

/*------------------------------------------------------------------*/
/* Il faut maintenant vérifier la cohérence de la date de           */
/* survenance avec la date d'opposition de la garantie UF, si elle  */
/* existe. Le test de cohérence entre la date d'opposition et la    */
/* date de survenance est réalisé sur l'événement ItemChanged de    */
/* la DW GARANTIE. Le simple fait de faire un CTL-VAL sur la        */
/* garantie ne peux donc relance le test.                           */
/*------------------------------------------------------------------*/
If idw_wSin.iiErreur = 0 And Not IsNull ( dDteSurv ) Then
/*------------------------------------------------------------------*/
/* On récupére d'abord un DateTime pour la date de SURVENANCE.      */
/*------------------------------------------------------------------*/
	sHeuSurv	= idw_wSin.GetItemString ( 1, "HEU_SURV" )

	If IsNull ( sHeuSurv ) Or sHeuSurv = "" Then
		tTime = 00:00:00
	Else
		tTime = Time ( Left ( sHeuSurv, 2 ) + ":" + Right ( sHeuSurv, 2 ) )
	End If

	dtSurv = DateTime ( dDteSurv, tTime )

	lTotGti = idw_LstGti.RowCount ()
	For	lCpt = 1 To lTotGti
			lIdGti = idw_LstGti.GetItemNumber ( lCpt, "ID_GTI" )
/*------------------------------------------------------------------*/
/* Le 27/05/1999.                                                   */
/* Modif DGA. Gestion des UF Téléphone Mobile.                      */
/*------------------------------------------------------------------*/
			If	lIdGti = 7 Or lIdGti = 8 Then
				dtDteOppo = idw_LstGti.GetItemDateTime ( lCpt, "DTE_OPPO" )
				If	dtDteOppo < dtSurv	Then
					idw_wSin.iiErreur = 4
					Exit
				End If
			End If			
	Next

End If

// [PC301][VETUSTE]
F_RechDetPro(lDeb, lFin, idw_detpro, idw_wsin.GetItemNumber(1,"ID_PROD"),"-DP", 152)
If lDeb > 0 Then
	If idw_wDetail.Find ( "MT_VAL_PUBLIQUE > 0", 1, idw_wDetail.Rowcount() ) > 0 Then
		idw_wSin.iiErreur= 6
		iAction = 1
	End If
End If
// :[PC301][VETUSTE]

// [PC192235]
F_RechDetPro(lDeb, lFin, idw_detpro, idw_wsin.GetItemNumber(1,"ID_PROD"),"-DP", 341)
sVal= Upper ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "VARIANTE", ";"))
bSC2FoyerNomade = sVal = "FOYER_NOMADE"

If bSC2FoyerNomade And idw_wDivDet.Find ( "NOM_ZONE = 'vetuste'", 1, idw_wDivDet.Rowcount() ) > 0 Then
	idw_wSin.iiErreur= 6
	iAction = 1
End If 

// [KSV649_ORREUCARA]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 387)
If lDeb <= 0 Then 
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 388)
End If 
If lDeb > 0 Then
	Choose Case This.uf_GestOng_Divers_Trouver ( "CRA_SUIVI_IMEI" )
		Case "20", "2", "100"
			idw_wSin.iiErreur= 8
			iAction = 1			
	End Choose 
End IF 
// /[KSV649_ORREUCARA]


// #1 [DCMP070914]
If	idw_wSin.iiErreur = 0 Then
	
	lOkAig = SQLCA.PS_V01_REF_ASSUREUR ( lIdSin, dtSurv, sMsg )
	
	If lOkAig = 0 Then
		idw_wSin.iiErreur= 5
		StMessage.sVar[1] = sMsg
	End If
End If
// :#1 [DCMP070914]

If	idw_wSin.iiErreur > 0 Then
	iAction = 1
Else
	iAction = 0	
/*------------------------------------------------------------------*/
/* On va déclencher la recherche d'une révision. Si la date de      */
/* survenance est vide ce n'est pas la peine.                       */
/*------------------------------------------------------------------*/
	If	Not IsNull ( dDteSurv ) Then

/*------------------------------------------------------------------*/
/* Le 05/01/1999                                                    */
/* Il y a un problème de calcul de révision sur les produits avec   */
/* changement d'option. (Ex:SECURILION)                             */
/* Si DTE_OPT <> DTE_ADH, on compare les zones DTE_OPT et           */
/* DTE_SURV. Si DTE_OPT <= DTE_SURV, on prend la zone DTE_OPT       */
/* comme pivot, sinon on prend DTE_ADH.                             */
/*------------------------------------------------------------------*/
		dDteOpt		= idw_wSin.GetItemDate ( 1, "DTE_OPT" )

		dtSurv		= DateTime ( dDteSurv )
		dtAdh			= DateTime ( dDteADh )
		dtDtePivot	= dtAdh

		If	dDteOpt <> dDteAdh	Then
			If	dDteOpt <= dDteSurv Then
				dtDtePivot 	= DateTime ( dDteOpt )
			End If
		End If

		dcIdProd	= idw_wSin.GetItemNumber ( 1, "ID_PROD" )
		sIdRev	= "    "

		itrTrans.PS_X_CALC_REVISION ( dcIdProd, dtSurv, dtDtePivot, sIdRev )
		dcIdRev 	= Dec ( sIdRev )
/*------------------------------------------------------------------*/
/* On vérifie si la procédure ne renvoie pas une erreur.            */
/*------------------------------------------------------------------*/
		If	Not	F_Procedure ( stMessage, itrTrans, "PS_X_CALC_REVISION" )	Then
			idw_wSin.iiErreur = 3
			iAction = 1
		Else
			// [PC582-583]
			bErrDp158 = FALSE
	
			f_rechdetpro(lDeb, lFin, idw_detpro, idw_wsin.GetItemNumber(1,"ID_PROD"),"-DP", 158)
			If lDeb > 0 Then
				sValCar=idw_detpro.GetItemString(lDeb, "VAL_CAR")
				sEffet=nvString.of_getkeyvalue(sValCar,"EFFET",";")
				sDteEffet=nvString.of_getkeyvalue(sValCar,"DTE_EFFET",";")
		
				dDteEffet = Date ( sDteEffet )
				If Len(sDteEffet) > 0 and sEffet = "DTE_SURV" Then
					If dDteSurv > dDteEffet Then bErrDp158=TRUE
				End if	
			End if
			
			If bErrDp158 Then
				dcIdRev = -1
				stMessage.sVar[1]=nvString. of_getkeyvalue ( sValcar, "CPLT_MESSAGE", ";")
				stMessage.sCode = "WSIN107"
			End if
			// :[PC582-583]
			
/*------------------------------------------------------------------*/
/* Si dcidRev = -2, il manque la date d'adhésion et celle-ci est    */
/* obligatoire pour déterminer la révision.                         */
/*------------------------------------------------------------------*/
			Choose Case	dcIdRev
			Case -2
				idw_wSin.iiErreur = 2
				iAction = 1
			Case Else
/*------------------------------------------------------------------*/
/* Si dcIdRev = -1, on affiche un message d'avertissement, mais on  */
/* ne bloque pas pas la saisie.                                     */
/*------------------------------------------------------------------*/
				If	dcIdRev = -1 Then
					stMessage.sTitre		= "Contrôle sur la révision"
					stMessage.Icon			= Information!
					stMessage.bErreurG	= False
					If not bErrDp158 Then stMessage.sCode		= "WSIN105" // [PC582-583] Ajout du if

					f_Message ( stMessage )
				End If
/*------------------------------------------------------------------*/
/* Si la révision change, on recharge les tables.                   */
/*------------------------------------------------------------------*/
				// [LECT_PRODREV]
//				If	dcIdRev <> ilDernierIdRev Then 
				If True Then
					idw_wSin.SetItem ( 1, "ID_REV", dcIdRev )

					Uf_ChargerRevision ()
					ilDernierIdRev = dcIdRev
				End If
			End Choose
		End If
	End If
End If

If	iAction <> 1 Then
/*------------------------------------------------------------------*/
/* Le 25/11/1998:                                                   */
/* S'il n'y a aucune garantie de saisie, on peut positionner la     */
/* valeur d'instance sur DTE_SURV.                                  */
/*------------------------------------------------------------------*/
	If	lTotGti = 0 Then idtDteSurv = dtSurv

End If

// [PM261-1]
If	iAction <> 1 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 260 )
	If lDeb > 0 Then
		dDteAdh = idw_Wsin.GetItemDate ( 1, "DTE_ADH" )
		If DaysAfter(dDteAdh,dDteSurv) <= 30 Then
			stMessage.sTitre		= "Saisie de sinistre"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sCode		= "WSIN771"
			F_Message ( stMessage )
		End If 
	End if
End if
// :[PM261-1]

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

private function long uf_zn_heusurv ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_HeuSurv (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 08/01/1998 17:14:39
//* Libellé			: 
//* Commentaires	: Controle de HEU_SURV
//*
//* Arguments		: Aucun
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------

String sVal
Integer iAction
Date dDteSurv

DateTime dtDteOppo, dtDteSurv

Time tTime

Long lTotGti, lCpt, lIdGti

sVal		= Trim ( idw_wSin.GetText () )
iAction	= 2

If	sVal = "" Then
	sVal = stNul.str
Else
	If	Len ( sVal ) <> 4 Then
		idw_wSin.iiErreur		= 1
		idw_wSin.iiReset		= 0
		iAction					= 1
	Else
		If	Not IsTime ( Left ( sVal, 2 ) + ":" + Right ( sVal, 2 ) )	Then
			idw_wSin.iiErreur = 2
			idw_wSin.iiReset	= 0
			iAction				= 1
		End If
	End If
End If

/*------------------------------------------------------------------*/
/* Il faut maintenant vérifier la cohérence de la date de           */
/* survenance avec la date d'opposition de la garantie UF, si elle  */
/* existe. Le test de cohérence entre la date d'opposition et la    */
/* date de survenance est réalisé sur l'événement ItemChanged de    */
/* la DW GARANTIE. Le simple fait de faire un CTL-VAL sur la        */
/* garantie ne peux donc relance le test.                           */
/*------------------------------------------------------------------*/
dDteSurv = idw_wSin.GetItemDate ( 1, "DTE_SURV_DATE" )
If idw_wSin.iiErreur = 0 And Not IsNull ( dDteSurv ) Then
/*------------------------------------------------------------------*/
/* On récupére d'abord un DateTime pour la date de SURVENANCE.      */
/*------------------------------------------------------------------*/
	If IsNull ( sVal ) Or sVal = "" Then
		tTime = 00:00:00
	Else
		tTime = Time ( Left ( sVal, 2 ) + ":" + Right ( sVal, 2 ) )
	End If

	dtDteSurv = DateTime ( dDteSurv, tTime )

	lTotGti = idw_LstGti.RowCount ()
	For	lCpt = 1 To lTotGti
			lIdGti = idw_LstGti.GetItemNumber ( lCpt, "ID_GTI" )
/*------------------------------------------------------------------*/
/* Le 27/05/1999.                                                   */
/* Modif DGA. Gestion des UF Téléphone Mobile.                      */
/*------------------------------------------------------------------*/
			If	lIdGti = 7 Or lIdGti = 8 Then
				dtDteOppo = idw_LstGti.GetItemDateTime ( lCpt, "DTE_OPPO" )
				If	dtDteOppo < dtDteSurv	Then
					idw_wSin.iiErreur = 3
					iAction 				= 1
					idw_wSin.iiReset	= 0
					Exit

				End If
			End If			
	Next
End If

If	iAction <> 1 Then
	idw_wSin.SetItem ( 1, "HEU_SURV", sVal )

/*------------------------------------------------------------------*/
/* Le 25/11/1998:                                                   */
/* S'il n'y a aucune garantie de saisie, on peut positionner la     */
/* valeur d'instance sur DTE_SURV.                                  */
/*------------------------------------------------------------------*/
	If	lTotGti = 0 Then idtDteSurv = dtDteSurv

End If

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

private function long uf_zn_boutique ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_Boutique (PRIVATE)
//* Auteur			: Catherine Abdmeziem
//* Date				: 05/03/2003
//* Libellé			: DCMP 030135 : Ctrl que la zone boutique existe
//* Commentaires	: 				    si gestion de boutiques manuelle
//*
//* Arguments		: Aucun
//*
//Migration PB8-WYNIWYG-03/2006 OR
//
//* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------
//*	MAJ	PAR	Date			Modification
//* #..	...		../../....	
//*	#1		PHG	05/01/2010	[O2M_DIAG_NOMADE].lot2
//*   #2    JFF   15/01/2010  [O2M_DIAG_NOMADE].Lot2.JFF
//* 		   JFF   04/11/2010  [PC301].[LOT2]
//* 		   JFF   27/03/2014  [DT076]
//          JFF   05/08/2024  [MCO602_PNEU]
//          JFF   20/06/2025  [MIG147_KRYS]
//*-----------------------------------------------------------------

String	sFind, sGetText, sIdEntrepot 
Integer	iAction
Long lDeb, lFin, lRow, lRow2
DataWindowChild dwChild

sFind = ""
iAction = 0
sGetText = idw_wSin.GetText ()

If idw_Produit.GetItemString ( 1, "ALT_COD_BOUTIQUE" ) = "O" Then
	If Not IsNull ( sGetText ) and sGetText <> "" Then 
		sFind = "ID_BOUTIQUE = " + sGetText
		If idw_Boutique.Find ( sFind, 1, idw_Boutique.RowCount () ) <= 0 Then
			idw_wSin.iiErreur = 1
			iAction = 1
		End If
	End If
End If

// Casto
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 43 )
If iAction = 0 And lDeb > 0 Then
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'num_mag'", 1,  idw_WDivSin.RowCount () ) 
	If lRow > 0 Then 
		idw_WDivSin.SetItem ( lRow, "VAL_NBRE", Long ( sGetText ) ) 
		idw_wDivSin.SetItem ( lRow, "MAJ_LE", DateTime ( Today (), Now () ) )
		idw_wDivSin.SetItem ( lRow, "MAJ_PAR", stGlb.sCodOper )
		idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "N" )
	End If
End If

// [O2M_DIAG_NOMADE].lot2 : Ajouter interdiction modif boutique si prestation de type « A_RECUP_A_RECYLER » de process (435), dont le code état est (CNV, ECT)
// #2 [O2M_DIAG_NOMADE].Lot2.JFF
// lRow = idw_LstwCommande.Find("ID_REF_FOUR = 'A_RECUP_A_RECYCLER' AND INFO_SPB_FRN = 435 AND COD_ETAT IN ('CNV, 'ECT')", 1, idw_LstwCommande.RowCount()+1)
lRow = idw_LstwCommande.Find("ID_REF_FOUR = 'A_RECUP_A_RECYCLER' AND INFO_SPB_FRN = 435", 1, idw_LstwCommande.RowCount()+1)
if lRow>0 Then
	
	// #2 [O2M_DIAG_NOMADE].Lot2.JFF Gestion du message
	//	idw_wSin.iiErreur = 2 //  : iiErreur a 2 est interprété dans w_tm_sp_sinistre.dw_1::itemerror pour ID_BOUTIQUE
	//	iAction = 1
	If Not IsNull ( sGetText ) Or Trim ( sGetText ) <> "" Then 
		idw_wSin.SetItem ( 1, idw_wSin.GeTItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), "ID_ORIAN_BOUTIQUE" )
		iAction = 2

		stMessage.sTitre		= "Modification interdite"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN691"
		f_Message ( stMessage )
	
	End If
End If

// [PC301].[LOT2]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 152 )
If lDeb > 0 Then
	idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
	lRow = dwChild.Find ( "ID_BOUTIQUE = " + Trim ( sGetText ), 1, dwChild.RowCount () )
	lRow2 = idw_WDivSin.Find ( "NOM_ZONE = 'choix_pack'", 1,  idw_WDivSin.RowCount () ) 
	
	If lRow > 0 and lRow2 > 0 Then
		sIdEntrepot = dwChild.GetItemString ( lRow, "ADR_MAIL" )
		This.uf_gestong_divers_majzone( "CHOIX_PACK", lRow2, K_MAJZONE, sIdEntrepot )				
	End If
End If
// [PC301].[LOT2]

// [DT076]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 252 )
If lDeb > 0 Then
	idw_wSin.iiErreur = 2
	iAction = 1
End If

// [MCO602_PNEU] on ne touche plus à la boutique si présence d'un règlement
If F_CLE_A_TRUE ( "MCO602_PNEU" ) Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 299 )
	If lDeb > 0 Then
		If idw_lstinter.Find("COD_INTER='A' And MT_REG > 0",1,idw_lstinter.RowCount()) > 0 Then 
			idw_wSin.iiErreur = 3
			iAction = 1
		End If 
	End If
End If


// [MIG147_KRYS]
If F_CLE_A_TRUE ( "MIG147_KRYS" ) Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 399 )
	If lDeb > 0 Then
		idw_wSin.iiErreur = 4
		iAction = 1
	End If
End If


//Migration PB8-WYNIWYG-03/2006 OR
//idw_wSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

private function long uf_zn_numimeiport ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_NumImeiPort (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 10/06/2003
//* Libellé			: Modification de la zone NUM_IMEI_PORT
//* Commentaires	: 	
//*
//* Arguments		: Aucun
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #1	 PHG	 02/01/2007	  [CRAO_LOT1] Gestion Cr. Activité IMEI
//*       JFF   19/09/2011   [PM82][LOT1]
//        JFF   24/08/2012   [ITSM127916]
//        JFF   02/10/2014   [VDOC15485]
//        JFF   07/03/2015   [ITSM367948]
//        JFF   07/03/2024   [HP252_276_HUB_PRESTA]
//        JFF   18/11/2024 [KSV649_ORREUCARA]
//*-----------------------------------------------------------------

Int iAction 
Long	lLen, lCpt, lRow, lVal1, lVal2, lVal3, lVal4, lVal6, lVal7
Boolean bQueDesZeros
String sData, sImeiCorrige, sNumPort
Boolean bOption75, bOkToMsg // #1 [CRAO_LOT1]
long lDeb, lFin, lRow2 

iAction = 0
sData   = Trim ( idw_wSin.GetText () )
lLen 		= Len ( sData )
bQueDesZeros = True
lRow	  = 1

/*------------------------------------------------------------------*/
/* #1 [CRAO_LOT1] Mémorisation de l'activatino de l'option          */
/*       det_pro 75 : "Gestion CR Activite IMEI"                    */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 75 )
bOption75 = lDeb > 0

/*------------------------------------------------------------------*/
/* Pour Modifier la marque, il faut qu'aucun détail soit 'à         */
/* régler' ou 'réglé' ET qu'aucune Prestation non annulée n'existe. */
/*------------------------------------------------------------------*/
// [PM82][LOT1] // [ITSM127916]
// [PM82][LOT1]
// [ITSM115501]

// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () ) 
	
	lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	// [PM82-5] // [HP252_276_HUB_PRESTA]
	lVal3 = idw_LstwCommande.Find ( "(( ID_TYP_ART= 'PRS' AND ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER')) Or ( ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 )) AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN')", 1, idw_LstwCommande.RowCount () ) 
//	lVal6 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER') AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT IN ( 'RFO', 'RPC')", 1, idw_LstwCommande.RowCount () ) 
	lVal6 =0 
	
	// [ITSM367948]
	lVal4 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DESOXYDER_FORCE', 'PEC_A_RECYCLER' ) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
			
	If ( lVal4 > lVal3 And lVal3 > 0 ) Or ( lVal4 > lVal6 And lVal6 > 0 ) Then lVal4 = 0 
	If lVal6 > 0 And lVal3 <= 0 Then lVal3 = lVal6
Else
	lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () ) 
	
	lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	// [PM82-5]
	lVal3 = idw_LstwCommande.Find ( "ID_TYP_ART= 'PRS' AND ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER') AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN')", 1, idw_LstwCommande.RowCount () ) 
	lVal6 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER') AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT IN ( 'RFO', 'RPC')", 1, idw_LstwCommande.RowCount () ) 
	
	// [ITSM367948]
	lVal4 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DESOXYDER_FORCE', 'PEC_A_RECYCLER' ) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
			
	If ( lVal4 > lVal3 And lVal3 > 0 ) Or ( lVal4 > lVal6 And lVal6 > 0 ) Then lVal4 = 0 
	If lVal6 > 0 And lVal3 <= 0 Then lVal3 = lVal6
End If 


If (( lVal1 > 0 Or lVal2 > 0 ) And Not ( lVal3 > 0 And lVal4 <= 0 )) Then
	lRow = -1
	idw_wSin.iiErreur = 2
End If 

// [DT288-1_LOT2]
If lRow > 0 Then
	lRow2 = idw_wdivsin.Find("UPPER (NOM_ZONE) = 'GEOLOC_SIMPA2'", 1, idw_wdivsin.RowCount())
	If lRow2 > 0 Then 
		This.uf_gestong_divers_majzone( "GEOLOC_SIMPA2", lRow2, K_MAJZONE, "N" )
	End If		
End If

If This.uf_GestOng_Divers_Trouver( "TYPE_APP" ) = "TEL" Then
	// #1 [CRAO_LOT1] Deconnection du controle IMEI obligatoire si Option Det_pro 75 Activée.
	bOkToMsg  = ( Not bOption75 or (bOption75 and Not ( isnull(sData) or lLen=0 ) ) )
	If Not F_IMEI ( sData, sImeiCorrige ) and bOkToMsg Then 
		lRow = -1
		idw_wSin.iiErreur = 3
		iAction = 1
	End If

	// #1 [CRAO_LOT1] Mise a jour de champs automatique de l'onglet Divers ( case a cocher )
	// sur modification du numero d'IMEI ou du n° de ligne. ( Si les deux sont saisis )
	//	if bOption75 and Not ( isnull(sData) or lLen=0 ) and lRow > 0 then uf_zn_numimei_numport()
	sNumPort = trim(idw_WSin.GetItemString ( 1, "NUM_PORT" ))
	if bOption75 and Not ( isnull(sData) or lLen=0 ) &
		and Not ( isnull(sNumPort) or len(sNumPort)=0 ) and lRow > 0 then uf_zn_numimei_numport()
End If

// [KSV649_ORREUCARA]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 387)
If lDeb <= 0 Then 
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 388)
End If 
If lDeb > 0 Then
	Choose Case This.uf_GestOng_Divers_Trouver ( "CRA_SUIVI_IMEI" )
		Case "20", "2", "100"
			idw_wSin.iiErreur= 4
			iAction = 1			
	End Choose 
End IF 
// /[KSV649_ORREUCARA]


If lRow <= 0 Then
	iAction = 1
End If

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

private function long uf_zn_trt_divsin_vallst (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_ValLst (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 16/08/2004
//* Libellé			: Contrôle de cohérence sur les valeurs de liste choisies et 
//*					  le nom de la zone d'affectation (uniquement dans l'onglet divers)
//* Commentaires	: 	
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #1    JFF    05/04/2006  iiErreur = 0 àld 1
//*-----------------------------------------------------------------

String				sFind, sNomZone
Long					lRow
DataWindowChild	dwChild
Integer				iAction

sFind = ""
iAction = 0

sNomZone = Upper ( idw_wDivSin.GetItemString ( alRow, "NOM_ZONE" ) )

If asNomCol = "VAL_LST_CAR" Then
	idw_wDivSin.GetChild ( "VAL_LST_CAR", dwChild )
Else
	idw_wDivSin.GetChild ( "VAL_LST_NBRE", dwChild )
End If 

If Not IsNull ( asData ) and asData <> "" Then

	If asNomCol = "VAL_LST_CAR" Then
		sFind = "ID_CODE = '" + asData + "' AND ALT_VISIBLE = 1 AND UPPER ( NOM_ZONE ) = '" + sNomZone + "'"
	Else
		sFind = "ID_CODE = " + asData + " AND ALT_VISIBLE = 1 AND UPPER ( NOM_ZONE ) = '" + sNomZone + "'"
	End If 

	lRow = dwChild.Find ( sFind, 1, dwChild.RowCount () )

	If lRow <= 0 Then
		idw_wDivSin.iiErreur = 0 // #1
		iAction = 1
	End If
End If

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wDivSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

private function long uf_zn_trt_divsin_codic (string asdata, string asnomcol, long alrow, boolean abforcer);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_Codic (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/12/2004
//* Libellé			: Contrôle de la zone CODIC
//* Commentaires	: 	En fonction du CODIC Darty, recherche TypeAPP, Marque et Modele de l'appareil
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*					  Boolean		abForcer			Val
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 		 FPI		05/06/2015	[VDOC17839]
//        JFF     15/10/2015  [ITSM333008]
//*-----------------------------------------------------------------

String sTypeApp, sMarque, sModele
DataWindowChild dwChild
Long lCodic, lRow, lRow1
Long lVal1, lVal2
Integer iAction

iAction = 0
lCodic = Long ( asData ) 

/*------------------------------------------------------------------*/
/* Pour Modifier lle Type d'app., il faut qu'aucun détail soit 'à   */
/* régler' ou 'réglé' ET qu'aucune Prestation non annulée n'existe. */
/*------------------------------------------------------------------*/
lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
		  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () ) 

lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )

If (lVal1 > 0 Or lVal2 > 0) And Not abForcer Then
	idw_wDivSin.iiErreur = 1
	iAction = 1
End If

// [VDOC17839]
If lCodic=0 Then 
	idw_wdivsin.SetItem(alRow, "VAL_NBRE",stnul.lng)
	ibCodicdartyvalide=FALSE
	Return 2
End if

If Len(asData) <> 7  and Len(asData) > 0 Then
	stMessage.sTitre		= "Saisie CODIC"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "V017839"
	iPbControler.Enabled = FALSE
	iAction = 1
End if
// :[VDOC17839]

/*------------------------------------------------------------------*/
/* Recherche dans le fichier des CODIC                              */
/*------------------------------------------------------------------*/
If iAction = 0 Then
	lRow = idwStkCodicDarty.Find ( "CODIC = " + String ( lCodic ), 1, idwStkCodicDarty.RowCount () )
	If lRow <= 0 Then
		// ITSM333008
		lRow1 = idw_WDivSin.Find ( "NOM_ZONE = 'codic'", 1,  idw_WDivSin.RowCount () )
		If lRow1 > 0 Then
			This.uf_gestong_divers_majzone( "CODIC", lRow1, K_MAJZONE, stNul.lng )
		End If

		iAction = 1
		stMessage.sTitre		= "CODIC non trouvé !"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sVar [1]   = String ( lCodic )
		stMessage.sCode		= "WDSI005"
		If isTypeTrt = "S" Then F_Message ( stMessage )
			
	End If 
End If


If iAction = 0 Then
	sTypeApp = idwStkCodicDarty.GetItemString ( lRow, "TYPE_APP" )
	sMarque  = idwStkCodicDarty.GetItemString ( lRow, "MARQUE" )
	sModele  = idwStkCodicDarty.GetItemString ( lRow, "MODELE" )

	/*------------------------------------------------------------------*/
	/* Quel référentiel utiliser ? Armement de isReferentielApp         */
	/*------------------------------------------------------------------*/
	If This.uf_Determiner_Referentiel ( sTypeApp ) = "" Then
		stMessage.sTitre		= "Problème de paramètrage DET_PRO"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sVar [1]   = String ( lCodic )
		stMessage.sVar [2]   = sTypeApp
		stMessage.sCode		= "WDSI003"
		If isTypeTrt = "S" Then F_Message ( stMessage )
		iPbControler.Enabled = FALSE	
		iAction = 1
	End If
End If

/*------------------------------------------------------------------*/
/* On force le type d'appareil, la marque et le modèle en fonction  */
/* du CODIC détecté.                                                */
/*------------------------------------------------------------------*/
If iAction = 0 Then
	ibCodicDartyValide = TRUE
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'type_app'", 1,  idw_WDivSin.RowCount () )
	idw_WDivSin.SetItem ( lRow, "VAL_CAR", sTypeApp )

	idw_WSin.SetItem ( 1, "MARQ_PORT", sMarque )
	idw_WSin.SetItem ( 1, "MODL_PORT", sModele )

	iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_TypeApp ( sTypeApp, "VAL_LST_CAR", lRow, TRUE )  // [20241112110249883][DIVOBJ][JFF]

	idw_wDivSin.SetItem ( lRow, "MAJ_LE", DateTime ( Today (), Now () ) )
	idw_wDivSin.SetItem ( lRow, "MAJ_PAR", stGlb.sCodOper )
	idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "N" )
End If

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wDivSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

private function long uf_zn_trt_divsin_valdte (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_ValDte (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 29/04/2005
//* Libellé			: Contrôle sur le type date
//* Commentaires	: 	
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer				iAction

iAction = 0

If Not IsDate ( Left(asData,10) ) Then // [PI056].20190926
	idw_wDivSin.iiErreur = 1
	iAction = 1
Else
	iAction = 0
End If

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wDivSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

private function long uf_zn_trt_divsin_provisionfrais (string asdata, string asnomcol, long alrow, boolean abforcer);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_ProvisionFrais (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 21/07/2005
//* Libellé			: Contrôle de la zone PROVISION_FRAIS (C-discount)
//* Commentaires	: 
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*					  Boolean		abForcer			Val
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    29/11/2010  [PC474]
//*-----------------------------------------------------------------

String sTypeApp, sIdMarq 
DataWindowChild dwChild
Integer iAction
Long lRow, lDeb, lFin

sTypeApp = Upper ( asData )
iAction = 0

// [PC474]
// Traitement C-Discount
//F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 37 )
//If lDeb > 0 Then
//	stMessage.sTitre		= "Provision Frais"
//	stMessage.Icon			= Information!
//	stMessage.bErreurG	= FALSE
//	stMessage.Bouton		= OK!
//	stMessage.sCode		= "WDSI004"
//
//	F_Message ( stMessage )
//End If

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wDivSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

public function long uf_zn_trt (ref s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_Trt (PUBLIC)
//* Auteur			: Erick John Stark
//* Date				: 06/01/1998 09:27:01
//* Libellé			: 
//* Commentaires	: Traitement sur les zones de dw_wSin. (On vient de ItemChanged)
//*
//* Arguments		: s_Pass			astPass			(Réf) Structure de passage
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #1	 CAG   05/03/2003	  DCMP 030135 : Ajout d'une table des boutiques
//* #2	 CAG   10/06/2003	  Modification de la marque portable en dddw
//* #3	 PHG	 03/01/2007	  [CRAO_LOT1] Gestion Cr; Activite IMEI	
//* #4	 PHG	 25/04/2007   [DCMP070275] Ajout de nvx motis sans suite pour la facturation
//			 FPI	 23/01/2012	  [PC494] Message d'information sur la saisie de natsin
//*       JFF   15/05/2012	  [ITSM115501]
//        JFF   23/05/2012   [PM103][1]
//        JFF   12/05/2016   [MOTEUR_RECH_IFR]
//*-----------------------------------------------------------------
//Migration PB8-WYNIWYG-03/2006 FM
//création d'une variable pour récupérer les valeures de retour
long	ll_ret = 0
//Fin Migration PB8-WYNIWYG-03/2006 FM

Integer iAction

iAction = 0

Choose Case idw_wSin.isNomCol
Case	"DTE_SURV_DATE"
	ll_ret = Uf_Zn_DteSurv ()
	astPass.sTab [ 1 ] = Uf_Titre ( 1 )

Case "HEU_SURV"
	ll_ret = Uf_Zn_HeuSurv ()

Case "ALT_BLOC"
	Uf_Zn_AltBloc ()

Case "ALT_SSUI"
	Uf_Zn_AltSsui ()

// [PM103][1]
Case "ALT_EDIT"
	ll_ret = Uf_Zn_AltEdit ()

//#4 [DCMP070275] on test la valeurs sasisie de motif sans suite
Case "COD_MOT_SSUI"
	ll_ret = Uf_Zn_CodMotSsui()

/*------------------------------------------------------------------*/
/* #1                                                               */
/*------------------------------------------------------------------*/
Case "ID_ORIAN_BOUTIQUE"
	ll_ret = Uf_Zn_Boutique ()

/*------------------------------------------------------------------*/
/* #5 : CAG 10/06/2003                                              */
/*------------------------------------------------------------------*/
Case "MARQ_PORT", "MARQ_PORT2", "MARQ_PORT3"
	// [MOTEUR_RECH_IFR]
	ll_ret = Uf_Zn_MarqPort ( "NORMAL" )

Case "MODL_PORT", "MODL_PORT2", "MODL_PORT3"
	ll_ret = Uf_Zn_ModlPort ()

Case "NUM_IMEI_PORT"
	ll_ret = Uf_Zn_NumImeiPort ()

/*------------------------------------------------------------------*/
/* #3 : [CRAO_LOT1] On déclenche les mise a jour d'onglet divers    */
/* si num_imei_port modifié ( géré ci dessus ) ou si num_port       */
/* modifié ( géré ci-dessous )                                      */
/*------------------------------------------------------------------*/

Case "NUM_PORT"
	ll_ret = Uf_Zn_NumPort ()

/*------------------------------------------------------------------*/
/* Pour les zones ID_NATSIN, ID_TERRIT, ID_DETSIN il faut réarmer   */
/* les valeurs des variables d'instances dans le cas ou on le       */
/* gestionnaire n'a pas encore saisi de garanties.                  */
/*------------------------------------------------------------------*/
Case "ID_NATSIN"
	If idw_LstGti.RowCount () = 0 Then	ilIdNatSin	= Long ( idw_wSin.GetText () )
	ll_ret=uf_zn_natsin() // [PC494]
	
Case "ID_TERRIT"
	If idw_LstGti.RowCount () = 0 Then	ilIdTerrit	= Long ( idw_wSin.GetText () )
	ll_ret=uf_zn_id_territ (TRUE) // [ITSM115501]
	
Case "ID_DETSIN"
	If idw_LstGti.RowCount () = 0 Then	ilIdDetSin	= Long ( idw_wSin.GetText () )
	ll_ret=uf_zn_id_detsin () // [ITSM115501]

Case "DTE_RESIL"
	If idw_LstGti.RowCount () = 0 Then	idDteResil   = Date ( idw_wSin.GetText () )
	If idw_wSin.GetText() <> "" Then iAction = Uf_Zn_DteResil ()
	If iAction = 0 Then This.uf_Gestion_DteFinGti ( Date ( idw_wSin.GetText () ), "SAISIE" )		

End Choose
//Migration PB8-WYNIWYG-03/2006 FM
return ll_ret
//Fin Migration PB8-WYNIWYG-03/2006 FM

end function

public function long uf_zn_trt_divsin (string asdata, string asnomcol, long alrow, string asnomzone);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_Trt_DivSin (PUBLIC)
//* Auteur			: Fabry JF
//* Date				: 17/06/2004 
//* Libellé			: 
//* Commentaires	: Traitement sur les zones de dw_w_div_sin. (On vient de ItemChanged)
//*
//* Arguments		: String		asData		Val
//*					  String		asNomCol		Val
//*					  Long		alRow			Val
//*					  String		asNomZone	Val
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #1    JFF    05/04/2006  Echappement si retour ActionCode égale à 1
//* #2    JFF    20/06/2006  DCMP060480
//* #3	 PHG	  28/12/2006  [CRAO_LOT1] Gestion Cr. Activité IMEI
//* #4    JFF	  06/02/2006  [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
//* #5	 PHG	  27/05/2007  [DCMP070284] Gestion PGC
//* #6    JFF    04/06/2007  [DCMP070163-070164-070248-070318] Gestion Prise en charge
//* #7 	 JFF	  29/08/2007  [DCMP070587] - Charte souplesse SFR
//* #8 	 JFF	  20/10/2008  [FNAC_PROD_ECH_TECH]
//* #9    JFF    25/11/2009  [MSS_DIAG]
//* #10   JFF    02/03/2010  [MSS_LOT2]
//*  	    JFF	  13/04/2010  [WEBSIM2].[FRANCE]
//			 FPI	  19/07/2012  [PC801]
//        JFF    06/08/2012  [BLCODE]
//        JFF    14/11/2012  [VDOC9376]
//        JFF    16/01/2013  [PC801_V10]
//		FPI	18/04/2013	[PC918] V4
//       JFF   17/06/2013 [PC946_ORANGE_OPPRO]
//		FPI	13/08/2013	[DT058]
//       JFF   12/12/2013 [PC947&977]
//       JFF   28/05/2014 [PC786-1_AUCHAN_GEM]
//		FPI	01/07/2014	[DT031-2]
// 		FPI	07/07/2014 [PC13442]
//       JFF   30/07/2014 [PM234-4_V1]
//		FPI	07/10/2014	[OV3.FPI] Temporaire pour le prêt d'appareil endommagé au client
//       JFF   31/03/2015 [DT081-4]
//    JFF   12/05/2015 [ITSM292811][ADVISE]
//		FPI	05/06/2015	[VDOC17839]
// 		 JFF	  01/06/2016  [VDOC20980]
//       JFF   07/06/2016 [DT227]
//       JFF   02/11/2016 [DT276]
//       JFF   12/12/2016 [DT269]
//       JFF   31/10/2017 [DT330]
//       JFF   27/11/2017 [PM426-2]
//       JFF   22/02/2018 [VDOC25738]
//       JFF   28/02/2019 [VDOC27557]
//       JFF   26/08/2021 [RS962_DYSFONC_EXTRA]
//       JFF   22/11/2023 [RS6175_GC_SCRP_SIM2]
//       JFF   05/08/2024 [MCO602_PNEU]
//       JFF   18/03/2025 [PAN_125]
//*-----------------------------------------------------------------

//Migration PB8-WYNIWYG-03/2006 FM
long	ll_ret = 0
//Fin Migration PB8-WYNIWYG-03/2006 FM

DateTime dtMajLe // #6

Choose Case asNomCol

	/*------------------------------------------------------------------*/
	/* Traitement de colonne	                                         */
	/*------------------------------------------------------------------*/
	Case	"VAL_LST_NBRE", "VAL_LST_CAR"
		ll_ret = This.Uf_Zn_Trt_DivSin_Vallst ( Upper ( asData ), Upper( asNomCol ), alRow )

		If ll_ret = 0 Then   // #1
		
			/*------------------------------------------------------------------*/
			/* Traitement de zone  		                                         */
			/*------------------------------------------------------------------*/
			Choose Case Upper ( asNomZone ) 

				Case "TYPE_APP"
					ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_TypeApp ( Upper ( asData ), Upper( asNomCol ), alRow, FALSE )  // [20241112110249883][DIVOBJ][JFF]

				// [VDOC25738] 
				Case "TYPAPP_AREC_ANEU"
					ll_ret = This.Uf_Zn_Trt_DivSin_TypAppARecANeu ( Upper ( asData ), Upper( asNomCol ), alRow, FALSE )					

				Case "CHOIX_PACK" // #2
					ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_ChoixPack ( Upper ( asData ), Upper( asNomCol ), alRow, FALSE )

				Case "TYPAPP_REC_NEU" // [VDOC9376]
					ll_ret = This.Uf_Zn_Trt_DivSin_TypAppRecNeu ( Upper ( asData ), Upper( asNomCol ), alRow, FALSE )

				Case "DEC_ASSUREUR" // #7
					ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_DecAssureur ( Upper ( asData ), Upper( asNomCol ), alRow )

				Case "MODE_REMPL" 	//* #8 [FNAC_PROD_ECH_TECH]
					ll_ret = This.Uf_Zn_Trt_DivSin_ModeRemplacement ( Upper ( asData ), Upper( asNomCol ), alRow )

				Case "MODE_PAIEMENT" // [PC801_V10]
					ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_ModePaiementPayBox ( Upper ( asData ), Upper( asNomCol ), alRow )
				
				// [PC946_ORANGE_OPPRO]
				Case "CRA_SUIVI_IMEI"
					ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_cra_suivi_imei ( Upper ( asData ), Upper( asNomCol ), alRow )
					
				// [DT058]
				Case "ACCORD_CHUBB"
					ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_Accord_Chubb ( Upper ( asData ), Upper( asNomCol ), alRow )

				// [DT227]
				Case "LIEU_REPAR"
					// [DT227]
					ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_Lieu_Repar	( Upper ( asData ), Upper( asNomCol ), alRow )

				// [DT269]
/*				
				Case "TAILLE_ECRAN"
					// [DT269]
					If F_CLE_A_TRUE ( "DT269" ) Then
						ll_ret = This.Uf_Zn_Trt_DivSin_taille_ecran	( Upper ( asData ), Upper( asNomCol ), alRow )
					End If
*/

				// [DT269]
				Case "PERSONNE_SIN"
					// [PC171999]
					ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_Personne_Sin ( Upper ( asData ), Upper( asNomCol ), alRow )

				// [MCO602_PNEU]
				Case "TYP_PRESTA"
					// [DT227]
					ll_ret = This.Uf_Zn_Trt_DivSin_Typ_Presta	( Upper ( asData ), Upper( asNomCol ), alRow )


			End Choose 
		End If // #1

	Case	"VAL_ALT"

		/*------------------------------------------------------------------*/
		/* Traitement de zone  		                                         */
		/*------------------------------------------------------------------*/
		Choose Case Upper ( asNomZone ) 

			Case "CRA_CTRL_IMEI" // #3 [CRAO_LOT1]: Gestion de la Case à cocher "Demande de Controle IMEI"
				ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_Cra_Ctrl_Imei ( Upper ( asData ), Upper( asNomCol ), alRow )


			Case "RGN_MDP_NET" // #4 Regénération du mdp
				ll_ret = This.Uf_Zn_Trt_DivSin_Rgn_Mdp_Net ( Upper ( asData ), Upper( asNomCol ), alRow )

			//* #8 [FNAC_PROD_ECH_TECH]
			//* #9 [MSS_LOT2]
			Case "APP_SIN", "BATT_SIN", "ALIM_SIN", "AUT_ACC_SIN"  
				ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_Accessoire ( Upper ( asData ), Upper( asNomCol ), alRow )
			//* :#8 [FNAC_PROD_ECH_TECH]

			// [WEBSIM2].[FRANCE]
			Case "RGN_MDP_NET_BTQ" // #4 Regénération du mdp
				ll_ret = This.Uf_Zn_Trt_DivSin_Rgn_Mdp_Net_Btq ( Upper ( asData ), Upper( asNomCol ), alRow )

			// [RECUP_DONNEE_O2M]
			Case "RECUP_DONNEES", "RECUP_MATERIEL"
				ll_ret = This.Uf_Zn_Trt_DivSin_RecupO2M ( Upper ( asData ), Upper( asNomCol ), alRow )

			Case "FRANCHISE_PAYBOX" // [PC801]
				ll_ret = This.uf_zn_trt_divsin_franchise_paybox( Upper ( asData ), Upper( asNomCol ), alRow )
				
			// [BLCODE]
			Case "DIMENSION_SUP_150CM"
				ll_ret = This.Uf_Zn_Trt_DivSin_dim_sup_150cm( Upper ( asData ), Upper( asNomCol ), alRow )
				
			// [BLCODE]
			Case "POIDS_SUP_30KG"
				ll_ret = This.uf_zn_trt_divsin_poids_sup_30kg( Upper ( asData ), Upper( asNomCol ), alRow )
				
			Case "GTI_NON_ACTIVEE_SITE" // [PC918]
				ll_ret = This.Uf_Zn_Trt_DivSin_Gti_non_activee ( Upper ( asData ), Upper( asNomCol ), alRow )
	
			Case "COQUE_NON_ADAPTE"
				ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_CoqNonAdpate	( Upper ( asData ), Upper( asNomCol ), alRow )

			// [VDOC20980]
			// [PC947&977]
			Case "COQUE_NE_PROTEGE"
				ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_CoqNeProtgPas ( Upper ( asData ), Upper( asNomCol ), alRow )

			// [PC786-1_AUCHAN_GEM]
			Case "TELEDIAG_OK"
				ll_ret = This.Uf_Zn_Trt_DivSin_telediag_ok ( Upper ( asData ), Upper( asNomCol ), alRow )
			
			// [PC13442]
			Case "ECH_EXPRESS_48H"
				ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_Ech_express_48h ( Upper ( asData ), Upper( asNomCol ), alRow )

			// [PM234-4_V1]
			Case "DCNX_DECLA_ATLAS"
				ll_ret = This.Uf_Zn_Trt_DivSin_DcnxDeclaAtlas ( Upper ( asData ), Upper( asNomCol ), alRow )
				
			// [DT081-1_CREDIMM]
			Case "RECREDIT_IMM"				
				ll_ret = This.Uf_Zn_Trt_DivSin_Recredit_Imm ( Upper ( asData ), Upper( asNomCol ), alRow )
			
			// [PC13174]
			Case "INTERV_SERRURIER", "INT_SER_SUP_150"				
				ll_ret = This.uf_zn_trt_divsin_interv_serrurier( Upper ( asData ), Upper( asNomCol ), alRow )
			
			// [OV3.FPI]
			Case "PRET_APP_ENDOMMAGE"
				ll_ret = This.uf_zn_trt_divsin_pret_app_endommage ( Upper ( asData ), Upper( asNomCol ), alRow )
			// :[OV3.FPI]
			
			// [FORCER_PAIEMENT_PAYBOX]
			Case "FRANCHISE_PAYBOX_CB_FORCEE"
				ll_ret = This.uf_zn_trt_divsin_paybox_cb_forcee( Upper ( asData ), Upper( asNomCol ), alRow )
			// :[FORCER_PAIEMENT_PAYBOX]

			// [DT276]
			Case "APP_DEGEOLOC"
				ll_ret = This.Uf_Zn_Trt_DivSin_degolocalisation ( Upper ( asData ), Upper( asNomCol ), alRow )

			// [DT330]
			Case "PCE_ILLISIBLE_CASTO"
				ll_ret = This.Uf_Zn_Trt_DivSin_PceIllisibleCasto ( Upper ( asData ), Upper( asNomCol ), alRow )

			// [PM426-2]
			Case "FORCER_REFUS_1676"
				ll_ret = This.Uf_Zn_Trt_DivSin_forcer_refus_1676 ( Upper ( asData ), Upper( asNomCol ), alRow )

			// [VDOC27557]
			Case "DOSSIER_BLOQUE_DR"
				ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_BloqueDRetude ( Upper ( asData ), Upper( asNomCol ), alRow )

			// [RS962_DYSFONC_EXTRA]
			Case "DYSFONC_EXTRANET_FRANCHISE"
				ll_ret = This.Uf_Zn_Trt_DivSin_dysfonc_extranet_franch ( Upper ( asData ), Upper( asNomCol ), alRow )


		End Choose 



	Case	"VAL_DTE"
		ll_ret = This.Uf_Zn_Trt_DivSin_ValDte ( Upper ( asData ), Upper( asNomCol ), alRow )

		If ll_ret = 0 Then   // #1

			/*------------------------------------------------------------------*/
			/* Traitement de zone  		                                         */
			/*------------------------------------------------------------------*/
			Choose Case Upper ( asNomZone ) 
	
				Case "DTE_TICKET"
					ll_ret = This.Uf_Zn_Trt_DivSin_DteTicket ( Upper ( asData ), Upper( asNomCol ), alRow )
	
				Case "CRA_LAST_DTE"
					ll_ret = This.uf_zn_trt_divsin_cra_last_dte( Upper ( asData ), Upper( asNomCol ), alRow )
					
				Case "DTE_RESTIT_APP_PRET"
					// [DT081-4]
					ll_ret = This.Uf_Zn_Trt_DivSin_dte_restit_app_pret ( Upper ( asData ), Upper( asNomCol ), alRow )
					
			End Choose 
		End If // #1


	Case	"VAL_MT"

		/*------------------------------------------------------------------*/
		/* Traitement de zone  		                                         */
		/*------------------------------------------------------------------*/
		Choose Case Upper ( asNomZone ) 

			Case "PROVISION_FRAIS"
				ll_ret = This.Uf_Zn_Trt_DivSin_ProvisionFrais ( Upper ( asData ), Upper( asNomCol ), alRow, FALSE )

		End Choose
	
	Case	"VAL_NBRE" // #5 [DCMP070284] On controle la duréede garantie d'origine
						  // qui ne peut etre modifiée que sous certaine condition ( voir
						  // fct ci-dessous

		/*------------------------------------------------------------------*/
		/* Traitement de zone  		                                         */
		/*------------------------------------------------------------------*/
		Choose Case Upper ( asNomZone ) 

			// [RS6175_GC_SCRP_SIM2]
			Case "DUREE_GTI_ORIGINE", "DUREE_GTI_ORIG"
				ll_ret = This.Uf_Zn_Trt_DivSin_Duree_Gti_Origine ( Upper ( asData ), Upper( asNomCol ), alRow )

			Case "CODIC" 
				// [VDOC17839]
				ll_ret = this.uf_zn_trt_divsin_codic( upper(asData), Upper( asNomCol ), alRow , FALSE)
				// :[VDOC17839]
		End Choose

	Case	"VAL_CAR" 

		/*------------------------------------------------------------------*/
		/* Traitement de zone  		                                         */
		/*------------------------------------------------------------------*/
		Choose Case Upper ( asNomZone ) 

			//* [MSS_DIAG]
			Case "NUM_FACT" 	
				ll_ret = This.Uf_Zn_Trt_DivSin_Num_Fact ( Upper ( asData ), Upper( asNomCol ), alRow )

			// [ITSM292811][ADVISE]
			Case "COD_BOUTIQUE_ADH"
				// [292811][ADVISE]
				ll_ret = iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_CodeBoutiqueAdh ( Upper ( asData ), Upper( asNomCol ), alRow )

		End Choose

End Choose

If ll_Ret = 0 Then

	// #6
	dtMajLe = DateTime ( Today (), Now () )
	
	idw_wDivSin.SetItem ( alRow, "MAJ_LE", dtMajLe )
	idw_wDivSin.SetItem ( alRow, "MAJ_PAR", stGlb.sCodOper )
	idw_wDivSin.SetItem ( alRow, "ALT_SUPP", "N" )
	
	// #1 Plus logique de mettre aussi à jour w_sin
	idw_wSin.SetItem ( 1, "MAJ_LE", dtMajLe  )
	idw_wSin.SetItem ( 1, "MAJ_PAR", stGlb.sCodOper )		

End If



//Migration PB8-WYNIWYG-03/2006 FM
return ll_ret
//Fin Migration PB8-WYNIWYG-03/2006 FM

end function

public function long uf_paraexist (string astextcompo, string aspara[]);//////////////////////////////////////////////////////////////////////////////
//
// Function:		uf_paraexist
//
// Access:			Private
//
// Arguments:
// astextcompo:		Texte de Composition à tester
// aspara[]:			Tableau des code paragraphe à tester
//
// Returns:			long
//						Nombre de paragraphe trouvé, -1 si erreur
//
// Description:	Permet de tester si un ou plusieurs paragraphe existe
//						dans le texte de composition
//
//////////////////////////////////////////////////////////////////////////////
//
// Revision History
//	
//	[DCMP050251] PHG 19/04/2006 Version Initiale
// Version
//
//////////////////////////////////////////////////////////////////////////////
//
// 2006 SPB
//
//////////////////////////////////////////////////////////////////////////////

long iPos, iIndex

For iIndex = 1 to UpperBound(asPara)
	if Pos(asTextCompo, asPara[iIndex])>0 then iPos++
Next

return iPos

end function

private function long uf_decompo_adr_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : uf_gs_sp_sinistre::uf_decompo_adr_mail ( PUBLIC )
//* Auteur        : JCA
//* Date          : 29/05/2006
//* Commentaires  : Decompose le champ en base adr_mail en adr_mail_name et adr_mail_domain
//* Arguments     : Aucun
//* Retourne      : long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//			 FPI	28/07/2011	[VDoc4913] Correction
//			 JFF  23/05/2017  F_EPURE_CHAINE
//       JFF   26/12/2018 [PM421-2]
//*-----------------------------------------------------------------

long iRet, lCpt, lTot
boolean bArobase
string sAdrMail
string sAdrMailDecompo[]

//iRet=0 Ok, iRet=-1 Nok
iRet=0

// [PM421-2]
lTot = idw_Lstinter.RowCount ()

For lCpt = 1 To lTot

	sAdrMail = idw_Lstinter.GetItemString(lCpt, "ADR_MAIL")
	
	sAdrMail = F_EPURE_CHAINE ( sAdrMail, "" ) 
	
	bArobase = match(sAdrMail, "@")
	
	if bArobase then
		if not (isnull(sAdrMail) or sAdrMail="@") then
			f_decomposerchaine(sAdrMail, "@", sAdrMailDecompo[])
		
			idw_Lstinter.SetItem(lCpt, "ADR_MAIL_NAME", sAdrMailDecompo[1])
			
			If UpperBound(sAdrMailDecompo) > 1 Then		//	[VDoc4913]
				idw_Lstinter.SetItem(lCpt, "ADR_MAIL_DOMAIN", sAdrMailDecompo[2])
			End if
		else
			idw_Lstinter.SetItem(lCpt, "ALT_SUIVI_MAIL", "N")
		end if
	
	else
		idw_Lstinter.SetItem(lCpt, "ALT_SUIVI_MAIL", "N")
	end if
Next 

return iRet
end function

private function long uf_zn_trt_divsin_dteticket (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_DteTicket (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 14/10/2005
//* Libellé			: Contrôle de la date du ticket (casto)
//* Commentaires	: 	
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer				iAction
Date					dDteSurv, dDteDecl, dDteTicket
iAction = 0


dDteSurv = idw_wSin.GetItemDate ( 1, "DTE_SURV_DATE") 
dDteDecl = idw_wSin.GetItemDate ( 1, "DTE_DECL" ) 
dDteTicket = Date ( asData )

If iAction = 0 And dDteTicket > dDteSurv Then
	idw_wDivSin.iiErreur = 1 
	iAction = 1
End If

If iAction = 0 And dDteTicket > dDteDecl Then
	idw_wDivSin.iiErreur = 2
	iAction = 1
End If

If iAction = 0 And dDteTicket > Today () Then
	idw_wDivSin.iiErreur = 3
	iAction = 1
End If

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wDivSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

public subroutine uf_getautorisation (string asidnatcour, ref string asbin, ref boolean abmodifcour, ref boolean abvalauto, ref boolean abvalidation, integer aiidi);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GetAutorisation (PUBLIC)
//* Auteur        : Fabry JF
//* Date          : 02/03/2004 10:01:09
//* Libellé       : Lecture des droits d'autorisation/refus, pour ce gestionnaire et 
//*					  ce produit (ou tout produit), permettant de modifier le contenu des courriers.
//*					  Le BIN de retour indique également si le gestionnaire est en validation
//*					  autonome ou pas.
//* Commentaires  :  ! MAINTENANCE A FAIRE AUSSI L'OBJET DES RELANCES !
//*
//* Arguments     : 	String		asIdNatCour		val	Nature du courrier composé et à analyser
//*						String		asBIN				réf	Bin de retour (voir ci-dessous décodage)
//*						Boolean		abModifCour		réf	TRUE : Le courrier composé peut être modifié	et donc sauvegardé.
//*						Boolean		abValAuto		réf	TRUE : Le gestionnaire est en mode Validation autonome
//*						Boolean		abValidation	réf	TRUE : Le gestionnaire a le droit de Valider (phase validation)
//*						Integer     aiIdi				Val   Code Interlocuteur
//*
//*						Décodage du BIN de 17 chiffres à découper sous la forme
//*					   1er    0/1     à 1 --> Autoriser modif Cr. Questionnaire 
//*					   2ème   0/1     à 1 --> Autoriser modif Cr. Dem. Pièce
//*					   3ème   0/1     à 1 --> Autoriser modif Cr. Prise en charge
//*					   4ème   0/1     à 1 --> Autoriser modif Cr. Refus
//*					   5ème   0/1     à 1 --> Autoriser modif Cr. Réglement
//*                  6ème   0/1     à 1 --> Autoriser Validation autonome
//*					   7ème	 0/1		à 1 --> Autoriser Phase Validation
//*					   8ème	 0/1		à 1 --> Autoriser Signature électronique
//*					   9ème	 0/1		à 1 --> Autoriser Gestionnaire DSC
//*					   10ème	 0/1		à 1 --> Autoriser Nom&Prénom gestionnaire sur Courrier
//*					   11ème	 0/1		à 1 --> Autoriser Aucune signature
//*						12ème  0/1     à 1 --> Autoriser envoi mail
//*                  13ème  0/1     à 1 --> Autoriser modif mail
//*						14ème  0/1     à 1 --> Autoriser modif mail Réglement
//*						15ème  0/1     à 1 --> Autoriser modif mail Refus
//*						16ème  0/1     à 1 --> Autoriser envoi mail Cr. Particulier	
//*						17ème  0/1     à 1 --> Autoriser Validation avec réglement // #2
//*						18ème  0/1     à 1 --> Autoriser Forçage PEC mt àla baisse
//*
//*					  ex BIN : 0110101
//*
//* Retourne      : RIEN
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1   MADM   31/07/2006	  Projet DNTMAIL1/2 Mails sortant en remplacement des courriers
//* #2	JCA	 07/03/2007	  DCMP 070161 - Amelioration process DNT - Autorisation de validation avec réglement
//*      JFF    18/07/2010   [PM159]
//*-----------------------------------------------------------------

String sFiltre, sTabDroit[], sFindOrig, sIdProd, sFindTrt, sAltSuiviMail
Long   lTotTab, lTotAuto, lCpt, lRow
Boolean bFin

/*------------------------------------------------------------------*/
/* Définiton des droits.                                            */
/*------------------------------------------------------------------*/
sTabDroit [1] = "1"		// Autoriser modif Cr. Questionnaire 
sTabDroit [2] = "2"		// Autoriser modif Cr. Dem. Pièce
sTabDroit [3] = "3"		// Autoriser modif Cr. Prise en charge
sTabDroit [4] = "4"		// Autoriser modif Cr. Refus
sTabDroit [5] = "5"		// Autoriser modif Cr. Réglement
sTabDroit [6] = "6"		// Autoriser Validation autonome
sTabDroit [7] = "7"		// Autoriser à Valider (phase validation)
sTabDroit [8] = "8"		// Autoriser à utiliser la signature électronique.
sTabDroit [9] = "9"		// Autoriser Gestionnaire DSC
sTabDroit [10] = "10"		// Autoriser Gestionnaire DSC
sTabDroit [11] = "11"		// Autoriser Aucune signature

/*------------------------------------------------------------------*/
/* #1 31/07/2006 MADM Définiton des nouveaux  droits.               */
/*------------------------------------------------------------------*/
sTabDroit [12] = "12"		// Autoriser envoi mail
sTabDroit [13] = "13"		// Autoriser modif mail
sTabDroit [14] = "14"		// Autoriser modif mail Réglement
sTabDroit [15] = "15"		// Autoriser modif mail Refus
sTabDroit [16] = "16"		// Autoriser envoi mail Cr. Particulier	

//* #2
sTabDroit [17] = "17"		// Autoriser Validation avec réglement
sTabDroit [18] = "18" 		// Autoriser Forçage PEC mt àla baisse [VDOC4684]

asBIN   		= ""
abModifCour = FALSE
sIdProd = String ( idw_wsin.GetItemNumber ( 1, "ID_PROD" ) )
asIdNatCour = Upper ( asIdNatCour )

sFindOrig   = "ID_OPER = '" + Upper ( stGlb.sCodOper ) + "' AND " + &
				  "ID_NAT_OPER = "

lTotTab = UpperBound ( sTabDroit )
lTotAuto = idw_Autorisation.RowCount ()

/*------------------------------------------------------------------*/
/* A-t-on le droit de modifier les questionnaires ?                 */
/*------------------------------------------------------------------*/
For lCpt = 1 To lTotTab

	/*------------------------------------------------------------------*/
	/* Recherche d'abord si un droit d'autorisation particulier existe  */
	/* pour le produit.                                                 */
	/*------------------------------------------------------------------*/
	sFindTrt = sFindOrig + sTabDroit [ lCpt ] + " AND ID_PROD = " + sIdProd
	lRow = idw_Autorisation.Find ( sFindTrt, 1, lTotAuto )

	/*------------------------------------------------------------------*/
	/* On affecte le droit d'autorisation au bin.                       */
	/*------------------------------------------------------------------*/
	If lRow > 0 Then 
		asBIN += "1"
		Continue
	End If

	/*------------------------------------------------------------------*/
	/* Recherche si un droit de refus particulier existe pour le produit*/
	/*------------------------------------------------------------------*/
	sFindTrt = sFindOrig + String ( Integer ( sTabDroit [ lCpt ] ) + 100 ) + " AND ID_PROD = " + sIdProd
	lRow = idw_Autorisation.Find ( sFindTrt, 1, lTotAuto )
	/*------------------------------------------------------------------*/
	/* On affecte le droit de refus au bin.                             */
	/*------------------------------------------------------------------*/
	If lRow > 0 Then 
		asBIN += "0"
		Continue
	End If

	/*------------------------------------------------------------------*/
	/* S'il n'y a aucun droit particulier pour ce produit, y a-t-il     */
	/* alors un droit par défaut.                                       */
	/*------------------------------------------------------------------*/
	sFindTrt = sFindOrig + sTabDroit [ lCpt ] + " AND ID_PROD = -1"
	lRow = idw_Autorisation.Find ( sFindTrt, 1, lTotAuto ) 

	/*------------------------------------------------------------------*/
	/* On affecte le droit d'autorisation au bin.                       */
	/*------------------------------------------------------------------*/
	If lRow > 0 Then 
		asBIN += "1"
		Continue
	End If

	sFindTrt = sFindOrig + String ( Integer ( sTabDroit [ lCpt ] ) + 100 ) + " AND ID_PROD = -1"
	lRow = idw_Autorisation.Find ( sFindTrt, 1, lTotAuto ) 

	/*------------------------------------------------------------------*/
	/* On affecte le droit de refus au bin.                             */
	/*------------------------------------------------------------------*/
	If lRow > 0 Then 
		asBIN += "0"
		Continue
	End If
	
	/*------------------------------------------------------------------*/
	/* Sinon si aucun droit n'est affecté, c'est par défaut un refus de */
	/* modifier.                                                        */
	/*------------------------------------------------------------------*/
	asBIN += "0"

Next	

/*------------------------------------------------------------------*/
/* Correction du BIN pour le cas de certaines incohérence.          */
/*------------------------------------------------------------------*/
/* Impossible d'avoir 8 et 11 en même temps et pourtant le          */
/* paramètrage permet de le faire.                                  */
/*------------------------------------------------------------------*/
If Mid ( asBIN, 8, 1 ) = "1" And Mid ( asBIN, 11, 1 ) = "1" Then
	sFindTrt = sFindOrig + sTabDroit [ 8 ] + " AND ID_PROD = " + sIdProd
	lRow = idw_Autorisation.Find ( sFindTrt, 1, lTotAuto )

	/*------------------------------------------------------------------*/
	/* 8 est plus fort dans ce cas puiqu'associé au produit, on annule  */
	/* donc 11.																			  */
	/*------------------------------------------------------------------*/
	If lRow > 0 Then
		asBIN = Replace ( asBIN, 11, 1, "0" )
	Else
		asBIN = Replace ( asBIN, 8, 1, "0" )
	End If
End If

/*------------------------------------------------------------------*/
/* Armement Boolean de validation                                   */
/*------------------------------------------------------------------*/
abValAuto = Mid ( asBIN, 6, 1 ) = "1"
abValidation = Mid ( asBIN, 7, 1 ) = "1"

/*------------------------------------------------------------------*/
/* A-t-on un code courrier à analyser ?                             */
/*------------------------------------------------------------------*/
If asIdNatCour <> "" Then

	bFin = False

	/*------------------------------------------------------------------*/
	/* #1 MADM 02/08/2006 : gestion des droits 13 Autoriser Modif Mail  */
	/* en fonction du canal de l'interlocuteur                          */
	/*------------------------------------------------------------------*/
	lRow = idw_LstInter.Find ( "ID_I = " + String ( aiIdi ), 1, idw_LstInter.Rowcount () )

	/*------------------------------------------------------------------*/
	/* #1 On détermine le canal (Mail ou courrier) de l'interlocuteur   */
	/*------------------------------------------------------------------*/
	sAltSuiviMail = idw_LstInter.GetItemString ( lRow , "ALT_SUIVI_MAIL")
	//[DNTMAIL1-2_MEP_DEF] Forçage à supprimer lors de la MEP finale.
	// [PM159]
	sAltSuiviMail = "O" // [PM159]		

	/*--------------------------------------------------------------------------------------------*/
	/* #1 Si le canal est égal à Mail et que le droit 13 est égal à 1 alors abModifCour est vraie */
	/*--------------------------------------------------------------------------------------------*/ 
//	 abModifCour = sAltSuiviMail <> "O" Or ( sAltSuiviMail =  "O" And Mid ( asBIN, 13, 1 ) = "1" And Mid ( asBIN, 16, 1 ) = "1")
//  Correctif [PM159] suite souci 
	 abModifCour = TRUE
	/*------------------------------------------------------------------*/
	/* Est-ce CP, une relance, une info ? si oui c'est Ok				     */
	/*------------------------------------------------------------------*/
	If abModifCour And Not bFin Then
		Choose Case Left ( asIdNatCour, 2 ) 
			Case "AP", "AL", "BL"
				bFin = TRUE
		End Choose 	
	End If

	If abModifCour And Not bFin Then	
		Choose Case Left ( asIdNatCour, 1 ) 
			Case "Z"
				bFin = TRUE
		End Choose 	
	End If
	
	/*------------------------------------------------------------------*/
	/* Est-ce un questionnaire ?	                                      */
	/*------------------------------------------------------------------*/
	If abModifCour And Not bFin Then 
		If Left ( asIdNatCour, 1 ) = "Q" Then
			abModifCour = Mid ( asBIN, 1, 1 ) = "1" 
			bFin = TRUE
		End If
	End If

	/*------------------------------------------------------------------*/
	/* Sinon autre courrier automatique.                                */
	/*------------------------------------------------------------------*/
	If Not bFin And abModifCour Then 

		/*------------------------------------------------------------------*/
		/* Droit à modifier les courriers de réglement                      */
		/*------------------------------------------------------------------*/
		If abModifCour Then
			Choose Case Mid ( asIdNatCour, 3, 1 )
				Case "C", "V"   // Chéque et virement
				
				/*------------------------------------------------------------------*/
				/* #1 Si le canal est différent de Mail alors abModifCour est vraie */
				/*------------------------------------------------------------------*/ 
				 If sAltSuiviMail <> "O" Then
					abModifCour = Mid ( asBIN, 5, 1 ) = "1" 
				 Else
				/*--------------------------------------------------------------------------------------------*/
				/* #1 Si le canal est égal à Mail et que le droit 14 est égal à 1 alors abModifCour est vraie */
				/*--------------------------------------------------------------------------------------------*/
//					abModifCour = Mid ( asBIN, 5, 1 ) = "1" And Mid ( asBIN, 14, 1 ) = "1"
					abModifCour = Mid ( asBIN, 5, 1 ) = "1"
	
				 End If	
				
			/*------------------------------------------------------------------*/
			/* Droit à modifier les courriers de prise en charge                */
			/*------------------------------------------------------------------*/
				Case "E"
					abModifCour = Mid ( asBIN, 3, 1 ) = "1" 
	
			End Choose
		End If
		
		/*------------------------------------------------------------------*/
		/* Droit à modifier les courriers de demande de pièce.				  */
		/*------------------------------------------------------------------*/
		If abModifCour Then
			If Mid ( asIdNatCour, 4, 1 ) = "P" Then
				abModifCour = Mid ( asBIN, 2, 1 ) = "1" 
			End If
		End If
		
		/*------------------------------------------------------------------*/
		/* Droit à modifier les courriers de refus.								  */
		/*------------------------------------------------------------------*/
		If abModifCour Then
			If Mid ( asIdNatCour, 5, 1 ) = "R" Then
				If sAltSuiviMail <> "O" Then
					abModifCour = Mid ( asBIN, 4, 1 ) = "1" 
				Else 
//					abModifCour = Mid ( asBIN, 4, 1 ) = "1" And Mid ( asBIN, 15, 1 ) = "1"
					abModifCour = Mid ( asBIN, 4, 1 ) = "1"
				End If
			End If
		End If
		
	End If
End If



end subroutine

private function boolean uf_validation_finale_trt_particuliers ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Trt_Particuliers (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 09/10/2005 16:43:53
//* Libellé       : Gestion Particulière (Mail vers boutiques et autres)
//* Commentaires  : !! Penser à visiter uf_Determiner_Data_sinistre_PlafPec !!
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    29/01/2007  Média Saturn téléphonie [DCMP060794]
//* #2	 PHG	  11/12/2007  [O2M] Bascule automatique du Code Etat sur 'RFO'
//*										  si Action in ( PEC_A_RECYCLER, GOM_A_RECYCLER )
//* #3    JFF    23/06/2008  [DCMP080287].FAX_MAIL
//* #4	 JFF	  25/11/2008  [FNAC_PROD_ECH_TECH]
//* #5 	 JFF	  06/06/2009  [RUEDUCOMMERCE]
//* #6    JFF    10/06/2009  [MOBISQUARE]
//* #7    JFF    03/08/2009  [CAMARA].[PRESTA_WEB_BOUTIQUE].[TEMPO] A supprimer lorsque le site WEB sera lié à SIMPA2
//* #8    JFF    03/08/2009  [CAMARA].[PRESTA_WEB_BOUTIQUE]
//* #9    JFF    03/08/2009  [SCCCG13]
//* #10   JFF    27/10/2009  [FNAC_PROD_ECH_TECH].[BGE].[20091027112156767]
//* #11   JFF    28/12/2009  [20091228155332733] ajout SBE TV
//* #12   JFF    25/11/2009  [MSS_DIAG]
//* #13	 FPI	  02/04/2010  [PC106] SCC CG 60
//* --    JFF    09/04/2010  [EXP5].[MAIL_BOUTIQUE]
//* --    JFF    28/07/2010  [PC321]
//* --    JFF    15/09/2010  [PC301].[CARREFOUR]
//        JFF    13/10/2010  [PC106_ECONOCOM]
//* 		FPI	03/11/2010	[PC171] - DCMP100452
//		FPI	08/06/2011	[PC321.V9]	Mail vers le SAV
// 		 JFF	  20/01/2011  [GROSBILL].[PC398-403-479]
//*			FPI	31/12/2010	[PC473]
// 			FPI	05/04/2011	[PC434]
//*			FPI	18/05/2011	[PC502]
// 			FPI	06/04/2011	[PC469]
//			JFF  02/09/2011  [PC10][DIAG_NOMADE]
//			FPI	13/09/2011	[PC19] LDE
//*       JFF   19/09/2011   [PM82][LOT1]
//			FPI	20/01/2012	[VDoc6734] Msg d'info en cas de remboursement ou remplacement
//       JFF   24/01/2012  [CONFO][CUISINE]
//			FPI	20/02/2012	[PC413-1Lot1]
//        JFF   01/03/2012  [CONFO][MEUBLE][PC542]
//      JFF   23/05/2012 [PM103][1]
//       JFF  07/06/2012 [MANTIS3405][PM200][MANTIS3406]
//		FPI	27/06/2012	[PC10-2] Converlance
//		FPI	17/07/2012	[PC801] Modif dp 206
//        JFF    06/08/2012  [BLCODE]
//        JFF    17/08/2012  [20120817165750597] Fermeture presta CARMA sur CARREFOUR CASSE VOL.
//		FPI		21/08/2012	[PC767]
//			JFF	03/09/2012	[PC853]
//		FPI		20/09/2012	[Corr_MDS] Correction d'envoie de mail pour MDS
//    JFF      11/10/2012  [MANTIS5071_PC543]
//		FPI	12/10/2012	[PC846/864]
//		FPI	23/10/2012	[PC884]
//		FPI	23/11/2012	[PC874]
//		FPI	03/12/2012	[PC853_1]
//		FPI	07/01/2013	[PC889]
//		FPI	14/02/2013	[PC467-2]
//    JFF   02/04/2013  [PC929_CDISCOUNT]
//		FPI	04/04/2013	[DP151_SBETV] Déplacement de code pour presta virtuelle SB1
//    JFF   08/04/2013  [PC920_PRIXTEL]
//		FPI	22/04/2013	[PC472-1]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//       JFF   07/10/2013 [DT044-1_V5]
//       JFF   30/12/2013 [PC13348&13408]
//		FPI	10/02/2014	[PC925]
//       JFF   19/03/2014 [DT076_ADVISE]
//       JFF   22/05/2014 [PC14495]
//       JFF   18/03/2014 [DT076_ADVISE_V3]
//       JFF   02/10/2014 [VDOC15485]
//		FPI	07/10/2014	[OV3.FPI] Temporaire pour le prêt d'appareil endommagé au client
//       JFF   10/11/2014 [PC801-5]
//       JFF   12/12/2014 [PC13321]
//       JFF   12/01/2015 [DT125_LECLERC] suppr Push
//		FPI	26/01/2015	[DT129]
//       JFF   09/02/2015 [DT133_CASTO]
//       JFF   09/04/2015 [DT141]
//		FPI	26/05/2015	[PC786-2]
// 		FPI	02/07/2015	[PC14613]
//		FPI	08/09/2015  [PC13442-2]
//    JFF   01/10/2015  [ITSM328203]
//    JFF   06/01/2016 [PC13313]
//       JFF   23/02/2016 [PM330-1]
//		FPI	08/04/2016	[DT176]
//       JFF   07/06/2016 [DT227]
//       JFF   14/06/2016 [PC161703]
//       JFF   28/06/2016 [PC151549]
//    JFF   07/06/2016 [DT227][V3]
//       JFF   07/11/2016 [PC151259]
//       JFF   05/10/2017 [PC171918]
//       JFF   01/06/2018 [PC151425-1]
//       JFF   26/11/2018 [PC874_2_V1]
//       JFF   28/02/2019 [VDOC27557]
//       JFF   04/03/2019 [DT401]
//       JFF   26/11/2019 [PC192290]
//       JFF   22/04/2020 [DT472]
//       JFF   21/04/2021 [PC202553] SELECTRA
//       JFF   28/09/2021 [20210928162035633] gestion d'un caractère de fin de chaine(@) pour ne pas perdre les espace de fin de chaine
//       JFF   30/05/2023 [PMO89_RS4822]
//       JFF   03/11/2023 [RS6114_MAIL_CMA]
//       JFF   07/03/2024 [HP252_276_HUB_PRESTA]
//       JFF   05/08/2024 [MCO602_PNEU]
//       JFF   05/08/2024 [MCO602_PNEU][MCO1050]
//       JFF   19/12/2024 [MIG1_COUR_EMAILING]
//       JFF   14/03/2025 [PMO268_MIG56]
//       JFF   31/03/2025 [MIG82_JOURN_EVT]
//       JFF   15/05/2025 [MCO1570_FERM_PRS_CMA]
//*-----------------------------------------------------------------

Date dtPivotFranchisePBox
String sSql, sCasPart, sCasGestionMDS, SFiltreOrig, sIdFour, sNumCarte, sVal, sValOrig, sValTemp, sVal1, sVal2, sVal3, sMess, sValCtrle 
String sTypMail, sMtAReg
Boolean bRet, bMsg, bFermePrestaCMA, bResil
Long lDeb, lFin, lRow, lVal, lIdSeq, lTot, lCpt, lTotRefus, lCptRefus, lIdNatSin, lIdGti, lIdMotif, lIdSin, lTotInter
Decimal {2} dcMtAReg
dwItemStatus	Status
n_cst_string lnvPFCString
DateTime dtCreeLeDos, dtVal, dtPivotCourHTMLviaWSSaga2, dtDtePivotDT401, dtDteSurv, dtDtePivotDp386 
String sZnDS_pceSherpaRacine, sZnDS_pceSherpa, sLibMemoire, sFiltre, sCodInter, sNomInter, sCodRefus
Int iZnDS_pceSherpa, iCodResilAdh, iCleNum
Boolean bEnvMailChapeauDemat
Long lIndentityHubPresta, lRowCountHubPresta, lErrorHubPresta, lTotRow
Integer iIdInter, iIdSeqCmde 

dtCreeLeDos = idw_WSin.GetItemDateTime ( 1, "CREE_LE")
dtDteSurv = idw_WSin.GetItemDateTime ( 1, "DTE_SURV")
sValCtrle = "N"
lIdSin = idw_wsin.GetItemNumber  ( 1, "ID_SIN" )

sCasPart = ""
bRet=TRUE // [PC846/864]


/*------------------------------------------------------------------*/
/* En effet DARTY n'enverra jamais aucun retour, et ces commandes   */
/* sont en fait des choix envoyés par mail. Le fait de placer dès   */
/* maintenant RPC n'est pas gênant, au contraire.                   */
/*------------------------------------------------------------------*/

// #2 les cas ci-dessous sont exclusifs !!!!!!

// Darty Téléphonie
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 11 )
If lDeb > 0 Then sCasPart = "Darty_Tel"

// Darty Nomade
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 31 )
	If lDeb > 0 Then sCasPart = "Darty_Nomade"
End If

// c-Discount
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 37 )
	If lDeb > 0 Then sCasPart = "C_Discount"
End If

// MBS
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 46 )
	If lDeb > 0 Then sCasPart = "Mobistore"
End If

// Media Saturn nomade
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 71 )
	If lDeb > 0 Then sCasPart = "Media_Saturn_Nomade"
End If

// Mondovelo [DCMP060694]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 72 )
	If lDeb > 0 Then sCasPart = "Mondovelo"
End If

// Media Saturn Téléphonie [DCMP060794] #1
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 74 )
	If lDeb > 0 Then sCasPart = "Media_Saturn_Tel"
End If

//* #3 [DCMP080287].FAX_MAIL
// Surcouf Ech Express
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 101 )
	If lDeb > 0 Then sCasPart = "Surcouf_Echange_Express"
End If

//* #4 [FNAC_PROD_ECH_TECH]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 105)
	If lDeb > 0 Then sCasPart = "Fnac_Ept"

	// #10 [FNAC_PROD_ECH_TECH].[BGE].[20091027112156767] On écrase si monaco.
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 125)
	If lDeb > 0 Then sCasPart = "Fnac_Ept_Monaco"
End If

//* #5 [RUEDUCOMMERCE]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 114)
	If lDeb > 0 Then sCasPart = "RueDuCommerce"
End If

//* #6 [MOBISQUARE]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 116)
	If lDeb > 0 Then sCasPart = "Mobisquare"
End If

//* #7 [CAMARA].[PRESTA_WEB_BOUTIQUE].[TEMPO]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 118)
	If lDeb > 0 Then sCasPart = "Camara"
End If

//* #9 [SCCCG13]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 121)
	If lDeb > 0 Then 
		sCasPart = "Scccg13/Eco/Toshiba"
//		sIdFour = Trim(idw_DetPro.GetItemString(lDeb, "VAL_CAR")) // #13 - [PC106]
//    Ne sert plus
	End If
End If

// [EXP5].[MAIL_BOUTIQUE]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 130)
	If lDeb > 0 Then sCasPart = "Expansion5"
End If

// [PC321]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 141)
	If lDeb > 0 Then sCasPart = "Carrefour"
End If

// [PC301].[CARREFOUR]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 152)
	If lDeb > 0 Then sCasPart = "Carma (Carrefour)"
End If

// [GROSBILL].[PC398-403-479]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 159)
	If lDeb > 0 Then sCasPart = "Gros Bill"
End If

// [PC502]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 172)
	If lDeb > 0 Then sCasPart = "DIMITECH"
End If

// [PC19]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 185)
	If lDeb > 0 Then sCasPart = "LDE"
End If

// [CONFO][CUISINE]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 207)
	If lDeb > 0 Then sCasPart = "CONFORAMA"
End If

// [PC14495]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 261)
	If lDeb > 0 Then sCasPart = "CONFORAMA_TEL"
End If

// [PC853]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 219)
	If lDeb > 0 Then sCasPart = "MCPROTECT"
End If

//[PC846/864]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 224)
	If lDeb > 0 Then sCasPart = "Carrefour SAV Diag"
End If

// [PC920_PRIXTEL]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 236)
	If lDeb > 0 Then sCasPart = "PRIXTEL"
End If

// [PC472-1]
If lDeb <=0 Then
	// [PC161703]
	// [DT129-1]
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 231)
	If lDeb > 0 Then 
		If lnvPFCString.of_getkeyvalue(idw_DetPro.GetItemString(lDeb,"VAL_CAR" ), "VARIANTE", ";") = "PC161703/DT129-1" Then
			lDeb = 0 
		Else 
			sCasPart = "OOP"				
		End If
	End If		
End If

// [DT076_ADVISE]
// [PC151259]
If lDeb <=0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 252)
	If lDeb > 0 Then 
		sCasPart = "ADVISE"			
		
		sVal = lnvPFCString.of_getkeyvalue ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "VARIANTE", ";")
		If sVal = "FULL_SERENITY_ADV_5" Then
			sCasPart = "ADVISE_5"
		End If

		// [PC171918]
		If sVal = "ADVISE_6" Then
			sVal = lnvPFCString.of_getkeyvalue ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "FAMILLE", ";")
			If sVal = "GEM" Then
				sCasPart = "ADVISE_6"
			Else
				sCasPart = "ADVISE_5"
			End If
		End If
		
	End If
End If

// [PC13321]
If lDeb <=0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 266)
	If lDeb > 0 Then sCasPart = "ELECTRO_DEPOT"
End If

// [DT129]
If lDeb <=0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 268)
	If lDeb > 0 Then 
		sCasPart = "CTL_IMEI_MAIL"
	End if
End If

// [DT133_CASTO]
If lDeb <=0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 43)
	If lDeb > 0 Then 
		sCasPart = "CASTORAMA"
	End if
End If

// [PC13313]
// [DT361]
If lDeb <=0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 294)
	If lDeb > 0 Then 
		sCasPart = "SAMSUNG"  // Nom du produit
	End if
End If

// [DT227]
If lDeb <=0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 299)
	If lDeb > 0 Then 
		sCasPart = "LECLERC_PNEU"  // Nom du produit
	End if
End If	

// [PC151425-1]
/*
If F_CLE_A_TRUE ( "PC151425-1" ) Then
	If lDeb <=0 Then
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 291)
		If lDeb > 0 Then 
			dtPivotFranchisePBox = Date ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DTE_EFFET_FRANCHISE_PBOX", ";"))
			If Date ( idw_Wsin.GetItemDateTime ( 1, "CREE_LE" )) >= dtPivotFranchisePBox Then 
				sCasPart = "FIRSTASSUR_REMB_FRANCHISE_PAYBOX"  // Nom du produit
			End If
		End if
	End If	
End If	
*/

// [PC202553] Ajout SELECTRA
If lDeb <=0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 348)
	If lDeb > 0 Then 
		sCasPart = "SELECTRA"  // Nom du produit
	End if
End If

//// Doit rester en dernier ici  /////

// [DT176]
bFermePrestaCMA=TRUE
bEnvMailChapeauDemat=FALSE  // [RS6114_MAIL_CMA]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 297)
If lDeb > 0 Then 
	bFermePrestaCMA=FALSE
	bEnvMailChapeauDemat = TRUE  // [RS6114_MAIL_CMA]
End If 
// :[DT176]

// [MCO1570_FERM_PRS_CMA] Carma ne répond plus, donc on ferme dans tous les cas
If F_CLE_A_TRUE ( "MCO1570_FERM_PRS_CMA" ) Then
	bFermePrestaCMA=TRUE
End If

/////////////////////////////////////////////////////////////////////////////////////////////

sCasPart = Upper ( sCasPart )

sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

Choose Case True
	Case sCasPart = "DARTY_TEL"
		sSql = "Exec sysadm.PS_U03_COMMANDE_VAL " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		/*------------------------------------------------------------------*/
		/* Si l'update est passé, on écrit le mail sur WIN.                 */
		/*------------------------------------------------------------------*/
		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_Darty_Mail_Tel ()
			End If
		End If
		// :[PM103][1]		

	Case sCasPart = "DARTY_NOMADE"

		sSql = "Exec sysadm.PS_U04_COMMANDE_VAL " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		/*------------------------------------------------------------------*/
		/* Si l'update est passé, on écrit le mail sur WIN.                 */
		/*------------------------------------------------------------------*/
		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_Darty_Mail_Nomade ()
			End If
		End If
		// :[PM103][1]


	Case sCasPart = "C_DISCOUNT"

		sSql = "Exec sysadm.PS_U05_COMMANDE_VAL " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = uf_validation_finale_cds_mail_pec( ) // [PC413-1Lot1]
			End IF
		End If
		// :[PM103][1]
		
		
	Case sCasPart = "MOBISTORE"

		sSql = "Exec sysadm.PS_U06_COMMANDE_VAL " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		// [PC10][DIAG_NOMADE]
		// [PM103][1]
		
		// [PC151549] // [PMO268_MIG56] 
		If F_CLE_A_TRUE ( "RS6448_MBZ3_MAILPEC" ) Then
			If bRet Then
				If Not gbModeReprise_223 Then
					If bRet Then
						bRet = This.uf_Validation_Finale_MBS_Mail ()
					End If
				End If
			End If
		Else 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 302 )
			If lDeb <= 0 and bRet Then
				If Not gbModeReprise_223 Then
					If bRet Then
						bRet = This.uf_Validation_Finale_MBS_Mail ()
					End If
				End If
			End If
		End IF 
		// :[PM103][1]
		

	Case sCasPart = "MEDIA_SATURN_NOMADE"

		sCasGestionMDS = This.uf_GestOng_Divers_Trouver ( "ZN_TMP_CAS_GESTION" )
		If IsNull ( sCasGestionMDS ) Then sCasGestionMDS = "-1"

		sSql = "Exec sysadm.PS_U07_COMMANDE_VAL_V01 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + ". "

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		If bRet Then
			// [PM103][1]
			If Not gbModeReprise_223 Then
				If bRet Then
					bRet = This.uf_Validation_Finale_MDS_Mail_Nomade ( sCasGestionMDS )
				End If
			End IF 
			// :[PM103][1]
		End If

	// [DCMP060694]
	Case sCasPart = "MONDOVELO"

		sSql = "Exec sysadm.PS_U08_COMMANDE_VAL " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_MVL_Mail_Cycle ()
			End If
		End If
		// :[PM103][1]		


// Media Saturn Téléphonie [DCMP060794] #1   
	Case sCasPart = "MEDIA_SATURN_TEL"

		sSql = "Exec sysadm.PS_U09_COMMANDE_VAL " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_MDS_Mail_Tel_pm191 ()
			End If
		End If
		// :[PM103][1]
			

	// [DCMP080287].FAX_MAIL
	Case sCasPart = "SURCOUF_ECHANGE_EXPRESS"

		sSql = "Exec sysadm.PS_U10_COMMANDE_VAL_SCF_ECH_EXPRESS " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_SCF_Mail_Ech_Expr ()
			End If
		End If
		// :[PM103][1]
		
	// :[DCMP080287].FAX_MAIL

	//* #4 [FNAC_PROD_ECH_TECH]

// #10 [FNAC_PROD_ECH_TECH].[BGE].[20091027112156767] 
	Case sCasPart = "FNAC_EPT"
		sSql = "Exec sysadm.PS_U11_COMMANDE_VAL_FNAC_EPT_V01 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 2"

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	//* :#4 [FNAC_PROD_ECH_TECH]

// #10 [FNAC_PROD_ECH_TECH].[BGE].[20091027112156767] On met sur 2 suite info V. Si Ali, on gère Monaco comme la France.
	Case sCasPart = "FNAC_EPT_MONACO"
		sSql = "Exec sysadm.PS_U11_COMMANDE_VAL_FNAC_EPT_V01 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 2"

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	//* :#4 [FNAC_PROD_ECH_TECH]

	//* #5 [RUEDUCOMMERCE]
	Case sCasPart = "RUEDUCOMMERCE"

		sSql = "Exec sysadm.PS_U12_COMMANDE_VAL_RUEDUCOMMERCE " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

	//* #6 [MOBISQUARE]
	Case sCasPart = "MOBISQUARE"

		sSql = "Exec sysadm.PS_U13_COMMANDE_VAL_MOBISQUARE " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_MCY_Mail_TelNomade ()
			End If
		End If
		// :[PM103][1]
		

	// #7 [CAMARA].[PRESTA_WEB_BOUTIQUE].[TEMPO]
	Case sCasPart = "CAMARA"

		sSql = "Exec sysadm.PS_U14_COMMANDE_VAL_CAMARA " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

	//* #9 [SCCCG13]
	Case sCasPart = "SCCCG13/ECO/TOSHIBA"

		// #13 - [PC106] SCC CG 60
		//sSql = "Exec sysadm.PS_U16_COMMANDE_VAL_SCCCG13 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) )
		sSql ="Exec sysadm.PS_U17_COMMANDE_VAL_SCCCG_V01 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
		
		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		// [PC106_ECONOCOM]
		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_ECO_Mail_RemplPC ()
			End IF
		End If
		// :[PM103][1]

		// [PC469]
		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_ECO_Mail_RemplPC2 ()
			End If
		End If
		// :[PM103][1]		

		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = uf_Validation_Finale_ECO_Mail_DemEnlevt()
			End if
		End If
		// :[PM103][1]
		
		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = uf_Validation_Finale_ECO_Mail_Refus()
			End if
		End If
		// :[PM103][1]			
		
		// [PC467-2]
		If (Not gbModeReprise_223) and bRet Then
			bRet=uf_Validation_Finale_ECO_Mail_Samsung()
			if bRet Then
				// [DT361]
				sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'CEA',999999"

				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
			End if
		End if
		// :[PC467-2]
		
	// [EXP5].[MAIL_BOUTIQUE]
	Case sCasPart = "EXPANSION5"

		sSql = "Exec sysadm.PS_U18_COMMANDE_MAIL_EXPANSION " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
		
		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_EX5_Mail_Pec ()
			End If
		End If
		// :[PM103][1]		

	// [PC321]
	Case sCasPart = "CARREFOUR"

		sSql ="Exec sysadm.PS_U18_COMMANDE_VAL_CARREFOUR " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
		
		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		// [20120817165750597]
		If bRet And bFermePrestaCMA Then // [DT176]
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'CMA',0"
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End If
		
		// [PC321.V9]
		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_Validation_Finale_Sav_Carrefour_Mail ()
			End If
		End IF
		// :[PM103][1]

// [PC301].[CARREFOUR]
	Case sCasPart = "CARMA (CARREFOUR)"
		
		If bFermePrestaCMA Then // [DT176]
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'CMA',0"

			F_Execute ( sSql, SQLCA )

			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End if
		
//  [GROSBILL].[PC398-403-479]
	Case sCasPart = "GROS BILL"

		bRet = uf_Validation_Finale_GrosBill_MailAxaPRS ()

		If bRet Then
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'GRB',0"
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End If 

		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = uf_Validation_Finale_GrosBill_MailGrbCmd ()
			End If
		End If
		// :[PM103][1]

	// [PC502]
	Case sCasPart = "DIMITECH"
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'DIM',0"

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

	// [CONFO][CUISINE]
	Case sCasPart = "CONFORAMA" Or sCasPart = "CONFORAMA_TEL"
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'CFM',0"
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		If bRet Then
			sSql = "Delete From sysadm.w_a_virer Where id_sin = " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + ". And cod_mode_reg = 'BX'"
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End If

		// [PC14495]
		If Not gbModeReprise_223 And sCasPart = "CONFORAMA" Then
			If bRet Then
				bRet = uf_Validation_Finale_Confo_Mail_Refus ()
			End If
		End If

		// [MANTIS5071_PC543]
		If bRet Then
			
			lRow = idw_LstwCommande.Find ( "ID_FOUR = 'CFM' AND ID_TYP_ART = 'CAF' AND NOT ISNULL ( ID_CMD_FRN ) AND LEN ( TRIM ( ID_CMD_FRN )) > 0", 1, idw_LstwCommande.Rowcount ())

			If lRow > 0 Then
				sNumCarte = idw_LstwCommande.GetItemString ( lRow, "ID_CMD_FRN" )
				sSql = "Exec sysadm.PS_I_NUM_CARTE_CADEAU_CONFO " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., '" + sNumCarte + "', '" + stGlb.sCodOper + "'"
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
			End If
		End If

	// [PC19]
	Case sCasPart = "LDE"
		// [PM103][1]
		If Not gbModeReprise_223 Then
			bRet = This.uf_Validation_Finale_LDE_Mail()
		End If
		// [PM103][1]


	//* #6 [PC853]
	Case sCasPart = "MCPROTECT"
		
		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = This.uf_validation_finale_mcprotect_mail_tn ()
			End If
		End If
		// :[PM103][1]
		
	// [PC846/864]
	Case  sCasPart = "CARREFOUR SAV DIAG"
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = uf_Validation_Finale_sav_carrefour_mail2( )
			End If
		End If

		If bRet And bFermePrestaCMA Then // [DT176]
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'CMA',0"
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End If

	// [PC920_PRIXTEL]
	Case  sCasPart = "PRIXTEL"
		
		// IMEI
		if bRet and uf_gestong_divers_trouver( "CRA_CTRL_IMEI") = "O" and Not gbModeReprise_223 Then
			sSql = "Exec sysadm.PS_S17_MAILPUSH_ORE_CTL_IMEI " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + ".,236"
	
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End if

	// [PC472-1]
	Case  sCasPart = "OOP"
		
		// IMEI
		if bRet and uf_gestong_divers_trouver( "CRA_CTRL_IMEI") = "O" and Not gbModeReprise_223 Then
			sSql = "Exec sysadm.PS_S20_MAILPUSH_OOP_CTL_IMEI " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
	
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End if

	// [DT076_ADVISE]
	Case  sCasPart = "ADVISE"

		If bRet and Not gbModeReprise_223  Then
			bRet = This.uf_validation_finale_advise_mail ()
		End if

		// [DT076_ADVISE_V3]
		// [DT401]
		If bRet Then
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 252 ) // Il existe forcément
		
			sVal = lnvPFCString.of_getkeyvalue ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DTE_PIVOT_DT401", ";")
			If IsNull ( sVal ) Then sVal = ""
			
			If bRet and Not gbModeReprise_223 Then 
				If sVal <> "" Then
					dtDtePivotDT401 = DateTime ( sVal )
					If dtCreeLeDos >= dtDtePivotDT401 Then 
						bRet = This.uf_Validation_Finale_AdviseRepa_Mail ( sCasPart ) 
					Else
						bRet = This.uf_validation_finale_advise_mail_2 ()
					End If
				Else
					bRet = This.uf_validation_finale_advise_mail_2 ()
				End IF 
			End If 			
		End IF 		
		// [DT363]
		If bRet and Not gbModeReprise_223  Then
			bRet = This.uf_validation_finale_advise_AAS_mail ()
		End if

	// [PC151259]
	Case  sCasPart = "ADVISE_5"	
		
		// [DT401]
		If bRet and Not gbModeReprise_223  Then
			bRet = This.uf_Validation_Finale_AdviseRepa_Mail ( sCasPart ) 
		End If

		// [DT363]
		If bRet and Not gbModeReprise_223  Then
			bRet = This.uf_validation_finale_advise_AAS_mail ()
		End if


	// [PC171918]
	Case  sCasPart = "ADVISE_6"	

		// [DT401]
		If bRet and Not gbModeReprise_223  Then
			bRet = This.uf_Validation_Finale_AdviseRepa_Mail ( sCasPart ) 
		End If
		
		// [DT363]
		If bRet and Not gbModeReprise_223  Then
			bRet = This.uf_validation_finale_advise_AAS_mail ()
		End if


	// [PC13321]
	Case  sCasPart = "ELECTRO_DEPOT"
		
		// IMEI
		if bRet and Not gbModeReprise_223 Then
			
			lDeb = idw_LstwCommande.Find("ID_FOUR = 'ELD' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)	
	
			If lDeb > 0 Then
				lVal = idw_LstwCommande.GetItemNumber ( lDeb, "ID_SEQ" ) 			
				sSql = "Exec sysadm.PS_U_COMMANDE_ELD_NUM_CC " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + ".," + String ( lVal )
		
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
			End If
		End if

	// [DT129]
	Case  sCasPart = "CTL_IMEI_MAIL"
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet=uf_validation_finale_mail_ctl_imei()
			End If
		End If

	// [DT133_CASTO]
	Case  sCasPart = "CASTORAMA"

		If Not gbModeReprise_223 Then
			If bRet Then
				If This.uf_GestOng_Divers_Trouver ("PCE_MAIL_CASTO") = "O" Then
					sSql = "Exec sysadm.PS_I_MAIL_CASTO_DT133 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
			
					F_Execute ( sSql, SQLCA )
					bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
				End If
			End If
		End If

	// [PC13313]
	Case sCasPart = "SAMSUNG"

		// [DT361]
		If Not gbModeReprise_223 Then
			If bRet Then
				bRet = uf_validation_finale_Samsung_InfoPec ()
			End if
		End If

	// [DT227]
	Case sCasPart = "LECLERC_PNEU"
		
		If bRet Then // [DT176]
		
			// [MCO602_PNEU]
			If NOT F_CLE_A_TRUE ( "MCO602_PNEU" ) Then
				sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'AUT',0"
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
				
				sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'CAL',0"
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
				
				sSql = "Exec sysadm.PS_U_PRESTA_LECLERC_PNEU " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., '" + stGlb.sCodOper + "'"
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
			End If	

			// [MCO602_PNEU]
			If F_CLE_A_TRUE ( "MCO602_PNEU" ) Then
				sSql = "Exec sysadm.PS_I_PRESTA_LECLERC_PNEU_MCO602 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "." 
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
			End If				
			
		End if

	// [PC151425-1] [PC202553] SELECTRA
	Case sCasPart = "FIRSTASSUR_REMB_FRANCHISE_PAYBOX" Or sCasPart = "SELECTRA"
		If Not gbModeReprise_223 Then
			If bRet Then

				sSql = "Exec sysadm.PS_I_REMB_FRANCHISE_PAYBOX " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

			End If
		End If	

		
	Case Else

		Bret = TRUE

End Choose 


// Traitement non exclusifs !!!!
// #2 le cas O2M n'est pas exclusif, on peut avoir l'un des cas ci-dessus + le cas O2M !!

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

If Not bRet then Return bRet

// [PM103][1]
If bRet Then 
	idw_LstwCommande.SetFilter ( "POS ( INFO_SPB_FRN_CPLT, 'PRESTA_REPRISE_BASE_MANUELLE=OUI' ) >0 AND COD_ETAT = 'CNV'" )
	idw_LstwCommande.Filter ()
	
	If idw_LstwCommande.RowCount () > 0 Then
		sSql = "Exec sysadm.PS_U_FORCAGE_ID_LOT_CMD_PM103 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 850000"
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0			
	End If
	
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()
	
End If
// #2 [O2M] Bascule auto du cod_etat en RFO pour PEC_A_RECYCLER / GOM_A_RECYCLER

If bRet Then
	

	// [BLCODE]
	// [DT141] Ajout SBE
	lDeb = idw_LstwCommande.Find("ID_FOUR IN ('O2M', 'SB1', 'MS1', 'BLC', 'MTT', 'SBE' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)	
	
//	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 95 )
	If lDeb > 0 Then 
		sSql = "Exec sysadm.PS_U12_COMMANDE_O2M " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) )+ "."
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	Else
		bRet = TRUE			
	End If
End If

// :#2

// [PM82][LOT1]
If bRet Then	
	
	lDeb = idw_LstwCommande.Find ( "ID_REF_FOUR = 'REFUSE_A_REEXP' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		sSql = "Exec sysadm.PS_U_COMMANDE_PM82_LOT1_CLOTURE_PRS " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) )+ "."
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	Else
		bRet = TRUE			
	End If
End If

If bRet Then	

	// [MANTIS3405][PM200][MANTIS3406]
	lDeb = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_REPARER_FORCE', 'A_DESOXYDER_FORCE', 'A_DIAG_FORCE' ) AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		sSql = "Exec sysadm.PS_U_COMMANDE_PM82_LOT1_CLOTURE_A_REPARER_FORCE " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) )+ "."
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	Else
		bRet = TRUE			
	End If
End If
// [PM82][LOT1]

// [VDOC9304_PM82_LOT1]
// [VDOC15485]

//* #4 [FNAC_PROD_ECH_TECH].[SMS]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 104 )
If lDeb > 0 and bRet Then
	// [PM103][1]
	If Not gbModeReprise_223 Then
		bRet = This.uf_Validation_Finale_Envoi_SMS ()
	End If
	// :[PM103][1]
	
	// #8 [CAMARA].[PRESTA_WEB_BOUTIQUE]
	If bRet Then
		sSql = "Exec sysadm.PS_U15_COMMANDE_VAL_SMS " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End IF
	
End If
//* :#4 [FNAC_PROD_ECH_TECH].[SMS]

// [PC473]
// [PM103][1]
If Not gbModeReprise_223 Then
	If bRet Then	
		bRet = uf_validation_finale_rdc_mail_bonachat( )
	End IF
End If 
// :[PM103][1]
// :[PC473]

// [VDOC22801]
If bRet and sCasPart <> "RUEDUCOMMERCE" Then
	lDeb = idw_LstwCommande.Find("ID_FOUR='RDC' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then
		sSql = "Exec sysadm.PS_U12_COMMANDE_VAL_RUEDUCOMMERCE " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End if
End if
// :[VDOC22801]

// [PC10-2]
If bRet Then
	lDeb = idw_LstwCommande.Find("ID_FOUR='CVC' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		If idw_LstwCommande.GetItemString(lDeb, "ID_TYP_ART") <> "AEF" Then
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'CVC',0"
	
			F_Execute ( sSql, SQLCA )

			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End if
		
		if bRet Then bRet=uf_validation_finale_converlance_mail( )
	End If
End If

// :[PC10-2]

// [PC13442-2]
If bRet Then
	lDeb = idw_LstwCommande.Find("ID_FOUR='ATC' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		If idw_LstwCommande.GetItemString(lDeb, "ID_TYP_ART") <> "AEF" Then
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'ATC',0"
	
			F_Execute ( sSql, SQLCA )

			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End if
		
		if bRet Then bRet=uf_validation_finale_atech_mail( )
	End If
End If
// : [PC13442-2]

// [PC767]
If bRet Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 217 )
	If lDeb > 0 Then
		// Commande
		
		lDeb = idw_LstwCommande.Find("ID_FOUR='ORE' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
		If lDeb > 0 Then 
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'ORE',0"
	
			F_Execute ( sSql, SQLCA )

			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		
			// if bRet Then bRet=uf_validation_finale_ore_mail( ) // FPI - le 23/11/2012
		End if
		
		// IMEI
		if bRet and uf_gestong_divers_trouver( "CRA_CTRL_IMEI") = "O" Then
			sSql = "Exec sysadm.PS_S17_MAILPUSH_ORE_CTL_IMEI " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + ".,217"
	
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End if
	End If
End If

// :[PC767]

// [PC874]
If bRet Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 218 )
	If lDeb > 0 Then
		// Commande

		// [PC874_2_V1]
		dtVal = DateTime ( lnvPFCString.of_getkeyvalue(idw_DetPro.GetItemString(lDeb,"VAL_CAR" ), "DTE_PIVOT_PC874_2", ";") )

		If dtCreeLeDos >= dtVal Then
			lDeb = idw_LstwCommande.Find("ID_FOUR='OMT' AND COD_ETAT = 'CNV' AND ID_TYP_ART NOT IN ( 'PRS', 'EDI' )", 1, idw_LstwCommande.rowCount()+1)
		Else
			lDeb = idw_LstwCommande.Find("ID_FOUR='OMT' AND COD_ETAT = 'CNV' AND ID_TYP_ART <> 'PRS'", 1, idw_LstwCommande.rowCount()+1)
		End If 

		If lDeb > 0 Then 
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'OMT',0"
	
			F_Execute ( sSql, SQLCA )

			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		
		End if
		
		if bRet Then bRet=uf_validation_finale_omt_mail( )
		
		// IMEI
		if bRet and uf_gestong_divers_trouver( "CRA_CTRL_IMEI") = "O" And dtCreeLeDos < dtVal Then
			sSql = "Exec sysadm.PS_S17_MAILPUSH_ORE_CTL_IMEI " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + ".,218"
	
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End if
			
	End If
End If

// :[PC874]

// [PC434]
if bRet Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 165 )
	If lDeb > 0 Then
		// [PM103][1]
		If Not gbModeReprise_223 Then
			If bRet Then	
				bRet=uf_validation_finale_mail_pec_assure( )
			End If
		End If
		// [PM103][1]
		
	End if
End if

// [PC889]
If bRet Then
	lDeb = idw_LstwCommande.Find("ID_FOUR='OOP' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'OOP',0"
	
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		
		if bRet Then bRet=uf_validation_finale_oop_mail( )
	End If
End If
// :[PC889]



// [VDoc6734]
if bRet Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 206 )
	If lDeb > 0 Then
		bRet=uf_validation_finale_msg_dp206( idw_detpro.getitemstring( lDeb, "VAL_CAR") )  // [PC801]
	end if
End if

// [DP151_SBETV]
If bRet Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 151 )
	If lDeb > 0 Then
		// [ITSM328203]
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + ", 'SB1', 999999"
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End if	
End if
// :[DP151_SBETV]

// [PC874]

// Marque_3



// [PC929_CDISCOUNT]
If bRet Then
	// Commande
	lDeb = idw_LstwCommande.Find ( "ID_FOUR = 'VPP' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'VPP',0"

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	
	End if
End If		



// [PC938_ORANGE_V3]
If bRet Then
	// Commande
	lDeb = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND COD_ETAT = 'CNV' AND ID_TYP_ART = 'RST' AND ( POS ( INFO_SPB_FRN_CPLT, 'RST_INFO_SIMPLE=OUI') > 0 )", 1, idw_LstwCommande.rowCount()+1)

	If lDeb > 0 And sVal <> "O" Then 
		sSql = "Exec sysadm.PS_U_COMMANDE_VIRTUELLE_RST " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'O2M',0"

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	
	End if
	
	lDeb = idw_LstwCommande.Find ( "( (ID_FOUR = 'O2M' AND ID_TYP_ART = 'PST') OR (ID_FOUR = 'PSM' AND ID_TYP_ART = 'PRS')) AND COD_ETAT = 'CNV'  AND ( POS ( INFO_SPB_FRN_CPLT, 'SECONDE_VISITE=NON') > 0 )", 1, idw_LstwCommande.rowCount()+1)

	If lDeb > 0 And sVal <> "O" Then 
		// Fermeture PSM
		sSql = "Exec sysadm.PS_U_COMMANDE_VIRTUELLE_FERM " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'PSM',0"
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

		sSql = "Exec sysadm.PS_U_COMMANDE_VIRTUELLE_FERM " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'O2M',0"
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		
	
	End if
End If		


// [DT044-1_V5]
If bRet Then
	lDeb = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PAS_DE_RGLT_FOURN' AND VAL_CAR = 'O'", 1, idw_wDivDet.rowCount())
	dcMtAReg = idw_wsin.GetItemDecimal ( 1, "MT_A_REG" )

	If lDeb > 0 and dcMtAReg > 0 Then 
		sSql = "Exec sysadm.PS_SUPP_REGL_W_A_VIRER " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	
	End if
End If		

// [PC13348&13408]
If bRet Then
	lDeb = idw_LstwCommande.Find("ID_FOUR='MTT' AND COD_ETAT = 'CNV' AND ID_TYP_ART NOT IN ( 'EDI', 'PRS' )", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'MTT',0"
	
		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End If
End If


// [PC925]
If bRet Then
	lDeb = idw_LstwCommande.Find("ID_FOUR='SRR' AND COD_ETAT = 'CNV' AND ID_TYP_ART = 'PRS'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		bRet=uf_validation_finale_mail_srr( )
	End If
End If

// Marque_2

// [PC786-2]
lDeb = idw_LstwCommande.Find("ID_FOUR='SOG' AND COD_ETAT = 'CNV' AND ID_TYP_ART = 'PRS'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		bRet=uf_validation_finale_mail_sogedep( )
	End If
// :[PC786-2]

// [OV3.FPI]
If bRet Then
	If idw_wdivsin.Find("Upper(NOM_ZONE)='PRET_APP_ENDOMMAGE' and VAL_CAR='O'",1,idw_wdivsin.RowCount()) > 0 Then
		lRow=idw_lstwcommande.Find("ID_TYP_ART='PST' and COD_ETAT <> 'ANN' And INFO_FRN_SPB_CPLT not like '%ETAT_APP_PRET=CONFORME%'",1,idw_lstwcommande.RowCount())
		If lRow > 0 Then
			sSql="Exec sysadm.PS_U22_COMMANDE_ETAT_APP_PRET " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., "+ &
				String(idw_lstwcommande.GetItemNumber(lRow,"ID_SEQ")) + ",'" + stGlb.sCodOper + "'"
			F_Execute ( sSql, SQLCA )
	
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End if
	End if
End if		
// :[OV3.FPI]

// [PC801-5]
If bRet Then

	// [DT472]
	lTotRefus = idw_wRefus.RowCount ()
	lIdNatSin = idw_wSin.GetItemNumber ( 1, "ID_NATSIN" )
	sValCtrle = Trim ( uf_GestOng_Divers_Trouver("RESIL_AUTO_ADH") )
	
	If IsNull ( sValCtrle ) Then sValCtrle = "N"

	// Cas spécial unique du 1749 où ce n'est pas un "REFUSE" qui déclenche la resil.
	// On sait qu'à la prochaine décla le 1749 se déclenchera donc on résilie à la fin de l'instruction
	// de ce dossier, cas détecté et coché à partir de la garantie.	
	If sValCtrle = "O" Then 
		lTotRefus = 1
		lIdMotif = 1749

		If idw_LstGti.RowCount () > 0 Then
			lIdGti = idw_LstGti.GetItemNumber ( 1, "ID_GTI" )
		End If 
		
	End If 

	For lCptRefus = 1 To lTotRefus 
		
		If sValCtrle <> "O" Then
			lIdGti = idw_wRefus.GetItemNumber ( lCptRefus, "ID_GTI" )
			lIdMotif = idw_wRefus.GetItemNumber ( lCptRefus, "ID_MOTIF" )
		End If 
		
		bResil = Uf_Decoder_DP347 ( lIdGti, lIdNatSin, lIdMotif, sLibMemoire, TRUE, iCodResilAdh ) 

		If bResil Then
			sSql  = "Exec sysadm.PS_I_RESIL_ADH_V01 " 
			sSql += String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., "
			sSql += "'" + sLibMemoire + "', "
			sSql += "'" + stGlb.sCodOper + "', "
			sSql += "'" + String ( dtDteSurv, "dd/mm/yyyy" ) + "', " 
			sSql += String ( lIdGti ) + ", " 
			sSql += String ( lIdNatSin )+ ", " 
			sSql += String ( iCodResilAdh )
			
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
			
			If bRet Then
				If sValCtrle <> "O" Then					
					sMess = "Résiliation automatique de l''adhésion suite au contexte suivant, réuni et validé : Refus coché : " + String ( lIdMotif) 
					sMess += ", garantie : " + string ( lIdGti ) 
					sMess += ", nature de sinistre : " + string ( lIdNatSin) 
					sMess += ", motif : " + sLibMemoire
				Else 
					sMess = "Résiliation automatique de l''adhésion suite au contexte suivant, réuni et validé : Nombre maximum de déclaration atteint" 
					sMess += ", garantie : " + string ( lIdGti ) 
					sMess += ", nature de sinistre : " + string ( lIdNatSin) 
				End If 
				
				sSql = "Exec sysadm.PS_I_CONTACT_CLIENT " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + ", '" + sMess + "', 300, '" + stGlb.sCodOper + "'"
				F_execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0	
			End If 
			
			Exit
			
		End If			
					
	Next 
	
End If	
// [PC801-5]

// [PC13174]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 264 )	
If bRet and lDeb > 0 Then
	lDeb = idw_LstwCommande.Find("ID_FOUR='AXA' AND COD_ETAT = 'CNV' AND ID_TYP_ART = 'PRS'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'AXA',0"

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End If
End If
// :[PC13174]

// [PC14613]
If bRet Then
	lDeb = idw_LstwCommande.Find("ID_FOUR in ('QDR','IBE') AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
			sIdFour = idw_LstwCommande.GetItemString(lDeb, "ID_FOUR")
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., '" + sIdFour + "',0"
	
			F_Execute ( sSql, SQLCA )

			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End If
		
		if bRet Then
			bRet=uf_Validation_Finale_QDR_IBE_mail()
		End if
End If
// :[PC14613]

// [DT288-3_LOT1_2EME_VS]
If bRet Then
	lDeb = idw_LstwCommande.Find("ID_REF_FOUR = 'INFORMATION' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		sIdFour = idw_LstwCommande.GetItemString(lDeb, "ID_FOUR")
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., '" + sIdFour + "',0"

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End If
End If
// :[DT288-3_LOT1_2EME_VS]


// [PM330-1]
If Not gbModeReprise_223 Then
	If bRet Then
		sSql = "Exec sysadm.PS_I_PEC_A_RECYCLER_PM330 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End If
End If

If Not gbModeReprise_223 Then
	If bRet Then
		sSql = "Exec sysadm.PS_I_REFUSE_A_REEXP_PM330 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End If
End If


// [PM445-1]
If bRet Then
	lDeb = idw_LstwCommande.Find ( "ID_REF_FOUR = 'NE_PAS_REMPLACER' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		lIdSeq = idw_LstwCommande.GetItemNumber ( lDeb, "ID_SEQ" ) 
		sVal = "Fermeture automatique suite action SPB."
		sSql = "Exec sysadm.PS_U_FERMETURE_PRESTA " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., " + String ( lIdSeq ) + ", '" + sVal + "'"

		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		
		If bRet Then 
			lDeb = idw_LstwCommande.Find ( &
					"ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER', 'A_DIAGNOSTIQUER' ) AND " + &
					"ISNULL ( DTE_RCP_FRN ) AND LEN ( ID_BON_TRANSP ) > 0 AND " + &
					"POS ( INFO_FRN_SPB_CPLT, 'PRBLE_LIVRAISON' ) > 0 AND " + &
					"POS ( INFO_FRN_SPB_CPLT, 'PERTE_ALLER' ) > 0 AND " + &
					"COD_ETAT IN ( 'ECT', 'ECL' )", &
					1, idw_LstwCommande.RoWCount () )				

			If lDeb > 0 Then 
				lIdSeq = idw_LstwCommande.GetItemNumber ( lDeb, "ID_SEQ" ) 
				sVal = "Fermeture automatique suite action SPB."
				
				sSql = "Exec sysadm.PS_U_FERMETURE_PRESTA " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., " + String ( lIdSeq ) + ", '" + sVal + "'"
		
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
				
			End IF 				
		End IF 
		
		
	End If
	lDeb = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_REMPLACER' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		sIdFour = idw_LstwCommande.GetItemString(lDeb, "ID_FOUR")
		lIdSeq = idw_LstwCommande.GetItemNumber ( lDeb, "ID_SEQ" ) 
		sSql = "Exec sysadm.PS_U_FERMETURE_PRESTA " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., " + String ( lIdSeq ) + ", ''"

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End If
End If

// [VDOC27557]
If bRet Then
	sSql = "Exec sysadm.PS_D_DIV_SIN_FINALE " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'dossier_bloque_dr'"

	F_Execute ( sSql, SQLCA )

	bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
End If 

// [PC192290]
If bRet Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 345 )
	If lDeb > 0 Then

		sZnDS_pceSherpaRacine = "sznds_pcesherpa_"
		iZnDS_pceSherpa = 1 
		sVal = ""

		Do While TRUE
			sZnDS_pceSherpa = Upper ( sZnDS_pceSherpaRacine + String ( iZnDS_pceSherpa ) )
			lRow = idw_wdivsin.Find( "Upper(NOM_ZONE)='" + Upper ( sZnDS_pceSherpa) + "'",1,idw_wdivsin.RowCount()) 
			
			If lRow <= 0 Then Exit
			
			sVal += This.uf_GestOng_Divers_Trouver ( sZnDS_pceSherpa )
			iZnDS_pceSherpa += 1
			
		Loop 

/*
		sVal1 = Left ( sVal, 255 )
		sVal2 = Mid  ( sVal, 256, 255 )		
		sVal3 = Mid  ( sVal, 511, 255 )				
*/
		// [20210928162035633]
		sVal1 = Left ( sVal, 254 ) + "@"
		sVal2 = Mid  ( sVal, 255, 254 ) + "@"
		sVal3 = Mid  ( sVal, 509, 254 ) + "@"

		sSql = "Exec sysadm.PS_U_MAJ_ETAT_PCE_SHERPA " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., '" + sVal1 + "', '" + sVal2 + "', '" + sVal3 + "'"
	
		F_Execute ( sSql, SQLCA )
	
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End IF 
End If 	

// [PC192290]
If bRet Then
	sVal = This.uf_GestOng_Divers_Trouver ( "REVENTE_A_TRAITER_1" )
	If sVal = "O" Then
		sSql = "Exec sysadm.PS_I_REGLEMENT_RM_SPEC_DT458 " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
	
		F_Execute ( sSql, SQLCA )
	
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End If 
End If 

// [FERM_PREST_CAR]
If bRet Then
	lDeb = idw_LstwCommande.Find("ID_FOUR='CAR' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 Then 
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'CAR',0"
	
		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End If
End If

// [PMO89_RS4822]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 365 )
If bRet and lDeb > 0 Then
	sSql = "Exec sysadm.PS_I_PMO89_RS4822_PRESTA_CTRLE_INTER_ASSUREUR  " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

	F_Execute ( sSql, SQLCA )

	bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
End If


// [RS6114_MAIL_CMA]
If bRet And bEnvMailChapeauDemat Then

	sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
				 "ID_FOUR    = 'CMA' AND " + &  
				 "POS ( INFO_SPB_FRN_CPLT, 'MAIL_CHAP_ENVOYE=OUI' ) <= 0 AND " + &
				 "POS ( INFO_SPB_FRN_CPLT, 'TYPE_ENVOI=DEMATERIALISE' ) > 0 AND " + &			 
				 "COD_ETAT IN ( 'CNV', 'ECT')"
				 
	idw_LstwCommande.SetFilter ( sFiltre )
	idw_LstwCommande.Filter ()
	
	If idw_LstwCommande.RowCount () > 0 Then
		lIdSeq = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" ) 
		sVal= String ( idw_LstwCommande.GetItemdecimal( 1, "MT_TTC_CMDE"),"0.00")
		sSql = "Exec sysadm.PS_I_MAIL_CAF_CMA_DEMAT_CHAPEAU " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., '" + sVal + "'"
		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0			

		If bRet then 
			// Ecriture sur la presta de l'envoi à OUI
			sSql = "Exec sysadm.PS_U_COMMANDE_DT339_MAJ_PRESTA " + & 
							String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "." + "," + &
							String ( lIdSeq ) + "." + "," + &
							"'OUI'"
							
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0						
		End If 			
	End If
	
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()

End IF 

// [MCO602_PNEU]
If F_CLE_A_TRUE ( "MCO602_PNEU" ) Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 380)
	If bRet And lDeb > 0 Then
		
		// SAGA2
		If SQLCA.PS_S_PRODUIT_ADH_SAGA2 ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) ) > 0 Then
		
			sSql = "Exec sysadm.PS_I_RESIL_ADH_SAGA2 " + &
					 String ( lIdSin ) + "., " + &
					 "'" + stGlb.sCodOper + "', " + &
					 "null"
					 
			F_Execute ( sSql, SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0	
			
		// FFM
		Else 
			// Coder ici le cas FFM si besoin un jour.
		End If 	
		
	End If 
	
	// [MCO602_PNEU][MCO1050] Envoi mail récap sur validation
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 386)
	If bRet And lDeb > 0 Then
		
		sVal = F_CLE_VAL ( "DTE_PIVOT", idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), ";" )
		sVal1 = This.uf_GestOng_Divers_Trouver ( "MAIL_RECAP_ENVOYE" )
	
		If Not IsNull ( sVal ) and Trim ( sVal ) <> "" And sVal1 <> "O" Then
			dtDtePivotDp386 = DateTime ( sVal ) 
			If dtCreeLeDos >= dtDtePivotDp386 Then 					
			
				lVal = SQLCA.PS_S_VERIF_ENVOI_MAIL_RECAP_DECLA ( lIdSin )
				
				If lVal > 0 Then
					sSql = "Exec sysadm.Atlas_Envoi_Mail_Recap_Decla " + &
					String ( lIdSin ) + "., " + &
					"null"
				 
					F_Execute ( sSql, SQLCA )
					bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0						
				End If 
				
			End IF 							
		End IF 			
	End IF 	

	// [MCO602_PNEU][FERM_PREST_LBE]
	If bRet Then
		lDeb = idw_LstwCommande.Find("ID_FOUR='LBE' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
		If lDeb > 0 Then 
			sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'LBE',0"
		
			F_Execute ( sSql, SQLCA )
	
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
		End If
	End If	
	
End If


// [MIG1_COUR_EMAILING]
If F_CLE_A_TRUE ( "MIG1_COUR_EMAILING" ) Then
	If bRet Then
		If ibMIG1_CourEmailing Then
			lTotInter = idw_LstInter.RowCount ()
			
			For lCpt = 1 to lTotInter 
				
				sTypMail = Trim ( idw_LstInter.GetItemString ( lCpt, "ID_COUR" ) )
				
				If IsNull ( sTypMail ) Or sTypMail = "" Then Continue
				
				// EXIT car soit tout est Emailing ou aucun inter
				// [20250408214307247]
				If SQLCA.PS_MIG1_S_VERIF_SI_COURRIER_EMAILING ( sTypMail ) <= 0 Then Exit
					
				
				iIdInter = idw_LstInter.GetItemNumber ( lCpt, "ID_I" ) 
				sCodInter = idw_LstInter.GetItemString ( lCpt, "COD_INTER" ) 
				sNomInter = idw_LstInter.GetItemString ( lCpt, "NOM" ) 
				sNomInter = F_REMPLACE ( sNomInter, "'", "''" ) 

				sMtAReg = ""
				sMtAReg = String ( idw_LstInter.GetItemDecimal ( lCpt, "MT_A_REG" ), "##0.00" )
				If IsNull ( sMtAReg ) Or dec ( sMtAReg ) = 0 Then sMtAReg = ""
				
				sCodRefus = ""
				lRow = idw_wRefus.Find ( " (ALT_OPE = 'O' OR ALT_MAC = 'O') AND ID_I = " + String ( iIdInter ), 1, idw_wRefus.RowCount() ) 
				If lRow > 0 Then
					sCodRefus = String ( idw_wRefus.GetItemNumber ( lRow, "ID_MOTIF") )
				End If 
				
				iIdSeqCmde = -1
				lRow = idw_LstwCommande.Find("COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount())
				If lRow > 0 Then 
					iIdSeqCmde = idw_LstwCommande.GetItemNumber ( lRow, "ID_SEQ" )
				End IF 
				
				sSql = "sysadm.PS_MIG1_I_EMAILING_KSL_ARCHIVE_MAILPUSH " +&
						 String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., " + &
						 String ( iIdSeqCmde ) + ", " + &
						 String ( iIdInter ) + ", " + &
						 "'" + sCodInter + "', " + &
						 "'" + sNomInter + "', " + &
						 "'" + sTypMail + "', " + &
						 "'" + stGlb.sCodOper + "', " + &
						 "'" + sCodRefus + "', " + &
						 "'" + sMtAReg + "', " + &
						 "''"
						 
				F_Execute ( sSql, SQLCA )
		
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
						 
				
			Next
			
		End IF 
	End IF 

End If


// [HP252_276_HUB_PRESTA]
// /!\ A laisser en dernier /!\
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	If bRet Then
		lDeb = idw_LstwCommande.Find("POS (INFO_SPB_FRN_CPLT, 'ID_HUB_PRESTA') > 0 AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.rowCount()+1)
		If ldeb > 0 Then
			lIdSeq = idw_LstwCommande.GetItemNumber ( lDeb, "ID_SEQ" ) 
			
			If lnvPFCString.of_getkeyvalue ( idw_LstwCommande.GetItemString ( lDeb,"INFO_SPB_FRN_CPLT" ), "HP_ID_HUB_PRESTA", ";") = "" Then
				lDeb = 0
			End If 
		End If 
		
		If lDeb > 0 Then

			istAttenteDiverse.text = " ~n~rValidation de la prestation dans le HUB PRESTATAIRE~n~r~n~rVeuillez patienter...."
			istAttenteDiverse.X			=  941
			istAttenteDiverse.Y			=  390
			istAttenteDiverse.Height	=  300
			istAttenteDiverse.Width		= 1585
			istAttenteDiverse.BringToTop = True
			istAttenteDiverse.Show()

			
			iCleNum = F_CLE_NUMERIQUE ( "HP252_276_HUB_PRESTA" )			

//			dsHubDonneesPrestaSimpa2 = Create dataStore
//			dsHubDonneesPrestaSimpa2.DataObject = "d_stk_hub_presta_donnees_simpa2"				
//			dsHubDonneesPrestaSimpa2.SetTransObject ( this.itrTrans )

			lRow = idsHubDonneesPrestaSimpa2.Retrieve ( iCleNum, lIdSin, lIdSeq )
			bRet = lRow > 0 
		End If  
	
		
		If lDeb > 0 And bRet Then 
			lTotRow = idsHubDonneesPrestaSimpa2.RowCount () 
			For lCpt = 1 To lTotRow 
				idsHubDonneesPrestaSimpa2.SetItem ( lCpt, "dtValideLe", DateTime ( Today(), Now() ) )
				idsHubDonneesPrestaSimpa2.SetItem ( lCpt, "sValidePar", stGlb.sCodOper )
				idsHubDonneesPrestaSimpa2.SetItem ( lCpt, "dtCmdGenLe", DateTime ( Today(), Now() ) )
			Next
			
			sSql = This.uf_validation_finale_sql_hubprestataire ( idsHubDonneesPrestaSimpa2 )
			bRet = This.uf_GestionTransSqlHubPresta	( "CONNEXION_HUB" )		
			
			If bRet Then
				lErrorHubPresta = F_Execute_Hub_Prestataire ( sSql, itrHubPrestataire, lIndentityHubPresta, lRowCountHubPresta )
				bRet = lErrorHubPresta = 0 And itrHubPrestataire.SqlCode = 0 And itrHubPrestataire.SqlDBCode = 0
			End If
			
			If bRet Then
				sSql = "Exec sysadm.PS_HP276_U_S2_MAJ_GEN_PRESTA " + String ( lIdSin ) + "., " + String ( lIdSeq ) + ", " + String ( lIndentityHubPresta )
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0			
			End If 
		End If
	

		// Fermeture auto de certaines prestations liées au Hub
		If lDeb > 0 And bRet Then 
			lDeb = idw_LstwCommande.Find("POS (INFO_SPB_FRN_CPLT, 'ID_HUB_PRESTA') > 0 AND COD_ETAT = 'CNV' AND ID_REF_FOUR = 'CODE_VERROU'", 1, idw_LstwCommande.rowCount()+1)
			If lDeb > 0 Then
				lIdSeq = idw_LstwCommande.GetItemNumber ( lDeb, "ID_SEQ" ) 
				sVal = "Fermeture automatique suite action SPB."
						
				sSql = "Exec sysadm.PS_U_FERMETURE_PRESTA " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., " + String ( lIdSeq ) + ", '" + sVal + "'"
		
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
			End If 
			
			lDeb = idw_LstwCommande.Find("POS (INFO_SPB_FRN_CPLT, 'ID_HUB_PRESTA') > 0 AND COD_ETAT = 'CNV' AND ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'PEC_A_RECYCLER') ", 1, idw_LstwCommande.rowCount()+1)
			If lDeb > 0 Then
				lIdSeq = idw_LstwCommande.GetItemNumber ( lDeb, "ID_SEQ" ) 
				sVal = "Fermeture automatique suite action SPB."
						
				sSql = "Exec sysadm.PS_U_FERMETURE_PRESTA " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., " + String ( lIdSeq ) + ", '" + sVal + "'"
		
				F_Execute ( sSql, SQLCA )
				bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
			End If 
			
			
		End If 
		
		
	End IF 
End If

// [MIG82_JOURN_EVT]
If F_CLE_A_TRUE ( "MIG82_JOURN_EVT" ) Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 397)
	If bRet And lDeb > 0 Then
		sSql = "Exec sysadm.PS_I_CAS_JOURNAL_EVT_SIN_SUR_VALIDATION " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., '" + stGlb.sCodOper + "'"

		F_Execute ( sSql, SQLCA )
		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End IF 
End If

// [MCO1570_FERM_PRS_CMA] Carma ne répond plus, donc on ferme dans tous les cas
If F_CLE_A_TRUE ( "MCO1570_FERM_PRS_CMA" ) Then
	lDeb = idw_LstwCommande.Find("ID_FOUR = 'CMA' AND COD_ETAT IN ( 'CNV', 'ECT')", 1, idw_LstwCommande.rowCount()+1)
	If lDeb > 0 And bFermePrestaCMA Then // [DT176]
		sSql = "Exec sysadm.PS_U19_COMMANDE_VIRTUELLE_STD " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "., 'CMA',0"

		F_Execute ( sSql, SQLCA )

		bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0
	End if
End If 


idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

Return bRet

end function

private function boolean uf_validation_finale_mds_mail_nomade (string ascasgestionmds);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MDS_Mail_Nomade  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/11/2003 16:43:53
//* Libellé       : Gestion Particulière pour MEDIA SATURN
//* Commentaires  : Aiguillage pour construction du mail adapté.
//*
//* Arguments     : String		asCasGestionMDS 	Val
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			FPI	20/09/2012	[CORR_MDS] Suppression du cas de gestion
//*-----------------------------------------------------------------

Boolean bRet, bCAF, bAEF
String sFiltre, sFiltreOrig
Long lNbrMail, lTotCmd

bRet=TRUE

// [CORR_MDS]
lNbrMail = 0

sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

sFiltre = "ID_TYP_ART IN ('CAF') AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MDS'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bCAF = True
	lNbrMail ++
End If

sFiltre = "ID_TYP_ART = 'AEF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MDS'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bAEF = True
	lNbrMail ++
End If

// Réinit du filtre
idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

If lNbrMail > 1 Then
	bRet = False
	
	stMessage.sTitre		= "Incohérence (plusieurs mails)"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= Ok!
	stMessage.sCode		= "WSIN731"
	stMessage.sVar[1]		= "Boulanger"

	F_Message ( stMessage ) 
	
	Return bRet 
	
End IF

Choose Case TRUE
	Case bCAF
		bRet = This.uf_validation_finale_mds_mail_nomade1_19( )
	Case bAEF
		bRet = This.uf_validation_finale_mds_mail_nomade2_19( )
End Choose

Return bRet


end function

private function boolean uf_validation_finale_mvl_mail_cycle ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MVL_Mail_Cycle  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 09/10/2006 16:43:53
//* Libellé       : Gestion Particulière pour MONDOVELO.
//* Commentaires  : [DCMP060694]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString

Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
sVal = ""

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 72 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sTypMail = "PEC_MVL1"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ) )

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MVL' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*  #1 Retrait
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sVar[1]    = "MONDOVELO"
	stMessage.sVar[2]    = 	stMessage.sVar[1]
	stMessage.sCode		= "COMD311"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If
*/

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "MONDOVELO"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

/*------------------------------------------------------------------*/
/* Le mail sera construit dans une DW qui sera directement (d'un    */
/* coup écrite sur disque). Je préfère cette option plutôt que      */
/* d'écrire un fichier texte progressivement sur disque avec des    */
/* FileWrite. Je trouve la solution de la DW plus sûr.              */
/*------------------------------------------------------------------*/

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
End If	

If IsNull ( sMailDest ) Then sMailDest = ""
If IsNull ( sTelDest ) Then sTelDest = ""
If IsNull ( sNomMagasin ) Then sNomMagasin = ""

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
sMailObjet = "DASSPB_MONDOVELO_ASSURANCE_N°" + sIdSin + " (CYCLE/REMPLACEMENT)"

/*------------------------------------------------------------------*/
/* 1.2 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody += "ADRESSE_FACTURATION : SPB MONDOVELO 76095 LE HAVRE CEDEX"

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += "REFERENCE_SIN_SPB : " + sIdSin + "-" + F_GetItem3 ( idw_LstwCommande, 1, "ID_SEQ" ) 

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_SPB_A_CONTACTER : " 
sMailBody += sSaut
sMailBody += "N°_TELEPHONE_SPB : " + String ( F_GetItem3 ( idw_Produit, 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) 
sMailBody += sSaut
sMailBody += "E-MAIL_EMETTEUR : mondovelo@spb.fr" 
sMailBody += sSaut
sMailBody += "(M1)" 


/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_MONDOVELO_A_CONTACTER : " 
sMailBody += sSaut
sMailBody += "NUM_TEL : " + sTelDest 
sMailBody += sSaut
sMailBody += "E-MAIL : " + sMailDest 


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody += sSaut 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "NOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) 
sMailBody += sSaut
sMailBody += "PRENOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_1 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_2 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_3 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
sMailBody += sSaut
sMailBody += "CODE POSTAL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += "TEL_ASSURE : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
dVal = Date ( Left ( F_GetItem3 ( idw_wSin, 1, "DTE_SURV" ), 10 ) )
sMailBody += "DATE_SURVENANCE_SINISTRE : " + String ( dVal , "dd/mm/yyyy" ) 
sMailBody += sSaut
dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "DATE_ACHAT_CYCLE_SINISTRE : " + String ( dVal, "dd/mm/yyyy" ) 
sMailBody += sSaut

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "-- LES MONTANTS SONT EXPRIMES EN EUROS --" 
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à Traiter														  */
/*------------------------------------------------------------------*/
sMailBody += sSaut 

sMailBody += sSaut
sMailBody += "CYCLE_A_REMPLACER : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) 
sMailBody += sSaut
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

//sMailBody += sSaut
//sMailBody += sSaut
sMailBody += "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
sMailBody += sSaut
sMailBody += "CYCLE_A_REMETTRE_AU_CLIENT : " 
sMailBody += sSaut


/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
//sMailBody += sSaut
//sMailBody += sSaut
// sMailBody += "CLIENT_PASSE_AU_MAGASIN : " 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
//
/*
sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = "AUCUNE DATE PRECISEE PAR L'ASSURE"
sMailBody += "APPAREIL_DEPOSE_LE : " + sVal 
sMailBody += sSaut
*/

sMailBody += "CODE_DU_MAGASIN : " + Upper ( String ( F_GetItem3 ( idw_WSin, 1, "ID_ORIAN_BOUTIQUE" ) ) ) 
sMailBody += sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody += sSaut
sMailBody += "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) 
sMailBody += sSaut

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function long uf_zn_numimei_numport ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_NumImeiPort (PRIVATE)
//* Auteur			: PHG
//* Date				: 02/01/2006
//* Libellé			: Controle et Action Commune à la saisie sur numimei_port et num_port
//* Commentaires	: [CRAO_LOT1]
//*
//* Arguments		: Aucun
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     	Modification
//* #..   ...   ../../....
//* #1	 PHG   09/02/2007		[CRAO_LOT2.002] le Suivi IMEI doit etre remis à null
//* #2	 PHG   20/02/2007		[CRAO_LOT2.004] la DDU doit etre remis à null
//*       JFF   30/06/2010    [PM50_CRAO]
//*-----------------------------------------------------------------

Int iAction 
Long	lLen, lCpt, lRow
String sData, sCraSuiviImei
Boolean bOption75, bOkToMsg // #1 [CRAO_LOT1]
long lDeb, lFin	// #1 [CRAO_LOT1]
datetime dteNull
integer iNull

iAction = 0
lRow	  = 1
SetNull(dteNull)
SetNull(iNull)

/*------------------------------------------------------------------*/
/* #1 [CRAO_LOT1] Mémorisation de l'activatino de l'option          */
/*       det_pro 75 : "Gestion CR Activite IMEI"                    */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 75 )
bOption75 = lDeb > 0

If bOption75 then // Si on a modifié num_port ou num_imei_port et Option 75 active
						// - On réinitialise le controle IMEI en cours : On remet à 0 le nombre de demande
						// - On remet la date de dernière generation de fichier a NULL
	sCraSuiviImei = uf_gestong_divers_trouver( "CRA_SUIVI_IMEI")
	if sCraSuiviImei <> '2' or isnull(sCraSuiviImei) then // le tout seulement si :
																			// Suivi IMEI <> Controle OK.
																			// et num_imei_port et 
																			//	et num_port non null ( ctrl fait dans event appelant)
		// [CRAO_LOT1.002] Suite retour MOA, si Modif IMEI/num_port
		// On initialise le dossier en "A controler" ( CRA_SUIVI_IMEI à Null )
		lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_SUIVI_IMEI'", 1 , idw_wdivsin.Rowcount()+1 )
		uf_gestong_divers_majzone( "CRA_SUIVI_IMEI", lRow, K_MAJZONE, iNull )
		// Fin [CRAO_LOT1.002]
																			
		lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_CTRL_IMEI'", 1 , idw_wdivsin.Rowcount()+1 )
		uf_gestong_divers_majzone( "CRA_CTRL_IMEI", lRow, K_MAJZONE, 'O')
		idw_Wsin.SetItem ( 1, "ALT_EDIT", "N" ) // [PM50_CRAO]
	
		lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_CPT_DMDE'", 1 , idw_wdivsin.Rowcount()+1 )
		uf_gestong_divers_majzone( "CRA_CPT_DMDE", lRow, K_MAJZONE, 0)

		lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_DAT_GEN'", 1 , idw_wdivsin.Rowcount()+1 )
		uf_gestong_divers_majzone( "CRA_DAT_GEN", lRow, K_MAJZONE, dteNull)

		// [CRAO_LOT1.004] Ano 004, Suite retour MOA, si Modif IMEI/num_port
		// On remet la dernière date d'utilisation à null 
		lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_LAST_DTE'", 1 , idw_wdivsin.Rowcount()+1 )
		uf_gestong_divers_majzone( "CRA_LAST_DTE", lRow, K_MAJZONE, dteNull)
		// Fin [CRAO_LOT1.004]
		
// 	Avant utilisation uf_gestong_divers_majzone bug car Itemchanged non déclenché.
//
//	   lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_CTRL_IMEI'", 1 , idw_wdivsin.Rowcount()+1 )
//		idw_wdivsin.object.val_car[lRow] = 'O'
//
//		lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_CPT_DMDE'", 1 , idw_wdivsin.Rowcount()+1 )
//		idw_wdivsin.object.val_num[lRow] = 0 
//		lRow = idw_wdivsin.Find("upper(nom_zone)='CRA_DAT_GEN'", 1 , idw_wdivsin.Rowcount()+1 )
//		idw_wdivsin.object.val_dte[lRow] = dteNull
//

	End If
End If

Return iAction

end function

private function long uf_zn_numport ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_NumPort (PRIVATE)
//* Auteur			: PHG
//* Date				: 03/01/2007
//* Libellé			: Modification de la zone NUM_PORT
//* Commentaires	: [CRAO_LOT1]
//*
//* Arguments		: Aucun
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	       Modification
//* #1    JFF	    19/02/2006  [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
//*-----------------------------------------------------------------

Int iAction 
Long	lLen, lRow
String sData, sNumImeiPort, sVal, sDtePivot
Boolean bOption75
long lDeb, lFin
date dCreeLe

iAction = 0
sData   = Trim ( idw_wSin.GetText () )
lLen 	  = Len ( sData )
lRow	  = 1

sDtePivot = "21/02/2007"
dCreeLe	 = Date (idw_wsin.GetItemDateTime (1, "CREE_LE" ) ) 

// #1
If dCreeLe >= Date ( sDtePivot ) Then
	sVal = F_Format_Num_Tel ( sData, FALSE )
	If	Not IsNull ( sVal ) And sVal <> "" Then
		//[NUM_TEL_07]
		If Not IsNumber ( sVal ) Or ( Left ( sVal, 2 ) <> "06"  And Left ( sVal, 2 ) <> "07" )  Or Len ( sVal ) <> 10 Then
			iAction = 1
			idw_WSin.iiErreur = 1
		End If				
	End If	
	
	If iAction <> 1 Then // #1
		sVal = F_Format_Num_Tel ( sData, TRUE )
		If sVal = "-1" Then 
			iAction = 1
			idw_WSin.iiErreur = 1
		Else
			iAction = 2
			idw_WSin.SetItem ( 1, "NUM_PORT", sVal )
		End If
	End If
End If

/*------------------------------------------------------------------*/
/* Mémorisation de l'activatino de l'option                         */
/* det_pro 75 : "Gestion CR Activite IMEI"                          */
/*------------------------------------------------------------------*/
If iAction <> 1 Then // #1
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 75 )
	bOption75 = lDeb > 0
	
	If This.uf_GestOng_Divers_Trouver( "TYPE_APP" ) = "TEL" Then
		// Mise a jour de champs automatique de l'onglet Divers ( case a cocher )
		// sur modification du numero d'IMEI ou du n° de ligne. ( Si les deux sont saisis )
		sNumImeiPort = trim(idw_WSin.GetItemString ( 1, "NUM_IMEI_PORT" ))
		if bOption75 and Not ( isnull(sData) or lLen=0 ) &
			and Not ( isnull(sNumImeiPort) or len(sNumImeiPort)=0 ) Then uf_zn_numimei_numport()
	End If
End If	




//Migration PB8-WYNIWYG-03/2006 OR
//idw_wSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

public subroutine uf_gestong_divers_setfocus (string asnomzone);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GestOng_Divers_SetFocus (PUBLIC)
//* Auteur        : Fabry JF
//* Date          : 29/09/2004 11:13:57
//* Libellé       : Replace le Focus une zone de l'onglet divers
//* Commentaires  : 
//*
//* Arguments		: String			asNomZone		Val
//*
//* Retour			: String
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

Long lRow

asNomZone = Upper ( asNomZone )

lRow = idw_WdivSin.Find ( "UPPER ( NOM_ZONE ) = '" + asNomZone + "' AND ALT_PROT = 'N'", 1, idw_WdivSin.RowCount () )

If lRow > 0 Then
	iUoOng.Uf_ChangerOnglet ( "04" )
	idw_WdivSin.ScrollToRow ( lRow )
	idw_WdivSin.SetRow ( lRow )
	idw_WdivSin.SetFocus ()
End If

end subroutine

private function string uf_gestion_mdp_extranet_cmde (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Gestion_Mdp_Extranet_Cmde (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 12/02/2007 11:13:57
//* Libellé       : Gestion du mdp lié à l'extranet des commandes.
//* Commentaires  : [SITE_CMDE]
//*
//* Arguments     : String		asCas			Val
//*
//* Retourne      : String 
//*
//*-----------------------------------------------------------------
//* PAR      Date	     Modification
//* JFF    11/03/2013  [ITSM148355]
//*
//*-----------------------------------------------------------------

String sVal, sRetour, sRech
Long lRowCNV, lRowCWE, lRow
Boolean bAltEdit 

bAltEdit = idw_Wsin.GetItemString ( 1, "ALT_EDIT" ) = "O"
asCas = Upper ( asCas )
sRetour = "0"

Choose Case asCas

	// Génére un nouveau mdp et l'écrit sur la Dw
	Case "GENERER"
		sRetour = Upper ( F_Generer_Mdp ( K_NB_MX_CAR_MDP_NET ) )
		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'mdp_net'", 1,  idw_WDivSin.RowCount () ) 
		If lRow > 0 Then
			uf_gestong_divers_majzone( "MDP_NET", lRow, K_MAJZONE, sRetour )
			sRetour = "1"
		End If 

	// Retourne le mdp existant
	Case "RETOURNER"
		sRetour = This.uf_GestOng_Divers_Trouver( "MDP_NET" )

	// Test la présence, retourne "1" si présent, "0" si absent
	Case "PRESENCE_MDP"		
		sVal = This.uf_GestOng_Divers_Trouver( "MDP_NET" )
		If Not IsNull ( sVal ) And Not Trim ( sVal ) = "" Then sRetour = "1"

	Case "PRESENCE_CMDE_WEB" 
		sRech = "( COD_ETAT IN ( 'CNV', 'CWE') AND ID_FOUR = 'WBA' ) "
		lRow = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())
		If lRow > 0 Then
			sRetour = "1"
		Else
			sRetour = "0"			
		End If
		
	Case "PRESENCE_CMDE_WEB_CNV_SEULE" 
		sRech = "( COD_ETAT IN ( 'CNV' ) AND ID_FOUR = 'WBA' ) "
		lRow = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())
		If lRow > 0 Then
			sRetour = "1"
		Else
			sRetour = "0"			
		End If		

	// annuler un mdp, on réécrit null dans la DW
	Case "ANNULER"
		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'mdp_net'", 1,  idw_WDivSin.RowCount () ) 
		If lRow > 0 Then
			uf_gestong_divers_majzone( "MDP_NET", lRow, K_MAJZONE, stNul.str )
			sRetour = "1"
		End If 

	// On remet à N la case à cocher demandant la REgénération
	Case "INIT_REGEN"
		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'rgn_mdp_net'", 1,  idw_WDivSin.RowCount () ) 
		If lRow > 0 Then
			uf_gestong_divers_majzone( "RGN_MDP_NET", lRow, K_MAJZONE, "N" )
			sRetour = "1"
		End If 
		
	// Demande de regénération ?
	Case "PRESENCE_DEM_REGEN"		
		sVal = This.uf_GestOng_Divers_Trouver( "RGN_MDP_NET" )
		If Trim ( sVal ) = "O" Then sRetour = "1"

	// Sommes dans un cas où une dem de regén est nécessaire ?
	Case "CAS_DEM_REGEN" 
		sRech = "( COD_ETAT = 'CNV' AND ID_FOUR = 'WBA' ) "
		lRowCNV = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		sRech = "( COD_ETAT = 'CWE' AND ID_FOUR = 'WBA' ) "
		lRowCWE = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		If ( lRowCWE > 0 And This.uf_Gestion_Mdp_Extranet_Cmde ( "PRESENCE_MDP" ) = "1" ) Then 
			sRetour = "1"			
		Else 
			sRetour = "0"			
		End If

		// Pour être CEB
		If lRowCNV <= 0 And lRowCWE <= 0 Then
			sRetour = "0"
		End If

	// Si nous sommes dans un cas de cmde Web, le mdp est-il bien présent avant quitter le dossier ?
	Case "CONTROLE" 
		sRech = "( COD_ETAT = 'CNV' AND ID_FOUR = 'WBA' ) "
		lRowCNV = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		sRech = "( COD_ETAT = 'CWE' AND ID_FOUR = 'WBA' ) "
		lRowCWE = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		If ( lRowCNV > 0 Or lRowCWE > 0 ) And This.uf_Gestion_Mdp_Extranet_Cmde ( "PRESENCE_MDP" ) <> "1" Then 
			sRetour = "0"
		Else
			sRetour = "1"
		End If

	// Traitement Général
	Case "TRAITEMENT" 
	
		sRech = "( COD_ETAT = 'CNV' AND ID_FOUR = 'WBA' ) "
		lRowCNV = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		sRech = "( COD_ETAT = 'CWE' AND ID_FOUR = 'WBA' ) "
		lRowCWE = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'mdp_net'", 1,  idw_WDivSin.RowCount () )
		If lRow > 0 Then
			lRow = idw_WDivSin.Find ( "NOM_ZONE = 'rgn_mdp_net'", 1,  idw_WDivSin.RowCount () )
		End If

		// Problème de param, les zones n'existent pas et elle sont nécessaire pour écire le mdp
		If lRow <=0 And ( lRowCNV > 0 Or lRowCWE > 0 ) Then
			sRetour = "0"
			stMessage.sTitre		= "Problème de paramètrage"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "WSIN497"	
			If bAltEdit Then F_Message ( stMessage )
		Else
			sRetour = "1"
		End If 

		If sRetour = "1" Then
			// [ITSM148355]
			If ( lRowCNV > 0 ) Or &
  			   ( lRowCWE > 0 And This.uf_Gestion_Mdp_Extranet_Cmde ( "PRESENCE_DEM_REGEN" ) = "1")  Then

				If This.uf_GestionCP ( "PRESENCE", 0, "A" ) Then
						stMessage.bErreurG	= FALSE
						stMessage.Icon			= Information!
						stMessage.sCode		= "WSIN501"
						stMessage.Bouton		= Ok!
						If bAltEdit Then F_Message ( stMessage )

						sRetour = "0"
				Else
					This.uf_Gestion_Mdp_Extranet_Cmde ( "GENERER" )
					This.uf_Gestion_Mdp_Extranet_Cmde ( "INIT_REGEN" )
					sRetour = "1"
				End If	
			End If				
		End If
		
		If sRetour = "1" And lRowCNV <= 0 And lRowCWE <= 0 Then
			This.uf_Gestion_Mdp_Extranet_Cmde ( "ANNULER" )
			This.uf_Gestion_Mdp_Extranet_Cmde ( "INIT_REGEN" )
			sRetour = "1"
		End If
		
		
End Choose 		

Return sRetour
end function

private function long uf_zn_trt_divsin_rgn_mdp_net (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_Rgn_Mdp_Net (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 28/12/2006
//* Libellé			: Contrôle de la zone RGN_MDP_NET ( [SITE_CMDE] )
//* Commentaires	: 
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin

asData = Upper ( asData )
iAction = 0

If asData = "O" Then
	If This.uf_Gestion_Mdp_Extranet_Cmde ( "CAS_DEM_REGEN" )	= "0" Then
		idw_wDivSin.iiErreur = 1
		iAction = 1
	End If
End If 

Return iAction

end function

private subroutine uf_determiner_courrier_forcage_web (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_Web (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 26/02/2007 16:37:24
//* Libellé       : On met à jour le tableau de des droits de modifications des courriers.
//* Commentaires  : 
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    29/02/2012  [VDOC6519]
//*-----------------------------------------------------------------

n_cst_string lnvPFCString
DataWindowChild	dwChild
String sIdNatPresent, sIdNatCourForcage, sRech
Long   lDeb, lFin, lTotCourrier, lLig

// Cas d'une PEC WEB
If asPos = "" And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" Then
	If This.uf_Gestion_Mdp_Extranet_Cmde ( "PRESENCE_CMDE_WEB_CNV_SEULE" ) = "1" Then

		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 80 )
		If lDeb > 0 Then
			sIdNatPresent = asIdNatCour

			// [VDOC6519]
			sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR", ";")			
			If Trim ( sIdNatCourForcage ) = "" Or IsNull ( sIdNatCourForcage ) Then
				sIdNatCourForcage = "WDE010"
			End If
			// [VDOC6519]			

			If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

			If sIdNatPresent <> sIdNatCourForcage Then

				If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= question!
					stMessage.sCode		= "WSIN499"
					stMessage.Bouton		= YesNO!
					stMessage.sVar[1] 	= sIdNatCourForcage
					
				Else
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= question!
					stMessage.sCode		= "WSIN500"
					stMessage.Bouton		= YesNO!
					stMessage.sVar[1] 	= asIdNatCour
					stMessage.sVar[2] 	= sIdNatCourForcage
				End If 
				
				If F_Message ( stMessage ) = 1 Then

					stMessage.Icon			= Information!
					stMessage.Bouton		= Ok!							

					idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
					lTotCourrier	= dwChild.RowCount ()
					sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
					lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
			
			/*------------------------------------------------------------------*/
			/* On verifie si la nature de courrier existe. Si elle n'existe     */
			/* pas, par un effet du hasard bien sur, on arrete le traitement    */
			/* et on positionne sur REF_CIE.                                    */
			/*------------------------------------------------------------------*/
					If	lLig = 0	Then
			
			/*------------------------------------------------------------------*/
			/* On arme la structure de message maintenant, mais le message va   */
			/* être affiché dans le contrôle de gestion.                        */
			/*------------------------------------------------------------------*/
						stMessage.bErreurG	= FALSE
						stMessage.Icon			= Information!
						stMessage.sCode		= "WSIN170"
						stMessage.sVar[1] 	= sIdNatCourForcage
						asPos = "REF_CIE"
					Else
						If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
							asIdNatCour = sIdNatCourForcage
							asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
							
							idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
							idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
							idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
						Else 
							// Le message est armé dans uf_GestionCP
							asPos = "REF_CIE"

						End If
					End If		
				End If
			End If
		End if 
	End If
End If


// Cas d'une Regénération de mdp
If asPos = "" And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" Then
	If This.uf_Gestion_Mdp_Extranet_Cmde ( "PRESENCE_DEM_REGEN" ) = "1" Then

		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 80 )
		If lDeb > 0 Then
			sIdNatPresent = asIdNatCour
			sIdNatCourForcage = "WT0012"

			If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

			If sIdNatPresent <> sIdNatCourForcage Then

				If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= question!
					stMessage.sCode		= "WSIN540"
					stMessage.Bouton		= YesNO!
					stMessage.sVar[1] 	= sIdNatCourForcage
					
				Else
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= question!
					stMessage.sCode		= "WSIN550"
					stMessage.Bouton		= YesNO!
					stMessage.sVar[1] 	= asIdNatCour
					stMessage.sVar[2] 	= sIdNatCourForcage
				End If 
				
				If F_Message ( stMessage ) = 1 Then

					stMessage.Icon			= Information!
					stMessage.Bouton		= Ok!							

					idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
					lTotCourrier	= dwChild.RowCount ()
					sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
					lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
			
			/*------------------------------------------------------------------*/
			/* On verifie si la nature de courrier existe. Si elle n'existe     */
			/* pas, par un effet du hasard bien sur, on arrete le traitement    */
			/* et on positionne sur REF_CIE.                                    */
			/*------------------------------------------------------------------*/
					If	lLig = 0	Then
			
			/*------------------------------------------------------------------*/
			/* On arme la structure de message maintenant, mais le message va   */
			/* être affiché dans le contrôle de gestion.                        */
			/*------------------------------------------------------------------*/
						stMessage.bErreurG	= FALSE
						stMessage.Icon			= Information!
						stMessage.sCode		= "WSIN170"
						stMessage.sVar[1] 	= sIdNatCourForcage
						asPos = "REF_CIE"
					Else
						If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
							asIdNatCour = sIdNatCourForcage
							asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
							
							idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
							idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
							idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
						Else 
							// Le message est armé dans uf_GestionCP
							asPos = "REF_CIE"

						End If
					End If		
				End If
			End If
		End if 
	End If
End If



end subroutine

private function boolean uf_gestioncp (string ascas, integer aiidinter, string ascodinter);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GestionCP (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 22/03/2004 11:20:04
//* Libellé       : Utilisé pour la méthode SVE (DCMP 040020)
//* Commentaires  : y a-t-il une CP présent sur le disque pour l'inter
//*
//* Arguments     : String asCas 			Val   // #2  "DELETE"/"PRESENCE"
//*					  Int		aiIdInter		Val
//*					  String asCodInter		Val
//*
//* Retourne      : si "Presence", TRUE = Présent
//*	   			  si "Delete", TRUE = Ok supprimé
//*
//*-----------------------------------------------------------------
//* MAJ	PAR      Date	     Modification
//* #1 	DGA   	19/09/2006 Gestion d'un répertoire temporaire DCMP-060643
//* #2   JFF      27/02/2007 [SITE_CMDE]
//*
//*-----------------------------------------------------------------

Long lCpt, lTotInter, lTotFichier, lIdInter, lTotwCour, lLig, lLigInter
String sRepTmp, sNomFic
Date dDateFic
Time tHeureFic
Boolean bAuMoinsUnCp

/*------------------------------------------------------------------*/
/* On vérifie s'il existe au moins un CP sur le disque.             */
/*------------------------------------------------------------------*/
/* On récupére tous les fichiers du type                            */
/* C:\WINNT\TEMP\XXXX*.*.                                           */
/*------------------------------------------------------------------*/
/* XXXX = Code de l'application sur 4 caractères obligatoires.      */
/* 99   = ID_INTER sur deux positions obligatoires (Ex:02,12).      */
/* 9    = COD_INTER.                                                */
/* ex : SIM200_A.DOC																  */
/*------------------------------------------------------------------*/
bAuMoinsUnCp	= FALSE
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//sRepTmp			= stGLB.sWinDir + "\TEMP\"
sRepTmp			= stGLB.sRepTempo
sNomFic			= sRepTmp + stGLB.sCodAppli + String ( aiIdInter, "00") + "_" + Upper ( asCodInter ) + ".DOC"

Choose case Upper ( asCas )  // #2
	Case "PRESENCE"

		//Migration PB8-WYNIWYG-03/2006 FM
		//If	FileExists ( sNomFic ) Then
		If	f_FileExists ( sNomFic ) Then
		//Fin Migration PB8-WYNIWYG-03/2006 FM
		
			stGlb.uoWin.uf_GetLastWriteDateTime ( sNomFic, dDateFic, tHeureFic )
			bAuMoinsUnCp =	dDateFic <> 2000-01-01 Or Left ( String ( tHeureFic ), 5 ) <> "23:59"
		End If			
		
	CASE "DELETE"
		
		bAuMoinsUnCp = Not f_FileExists ( sNomFic )
		
		If	Not bAuMoinsUnCp Then
		//Fin Migration PB8-WYNIWYG-03/2006 FM
		
			stGlb.uoWin.uf_GetLastWriteDateTime ( sNomFic, dDateFic, tHeureFic )
			If dDateFic <> 2000-01-01 Or Left ( String ( tHeureFic ), 5 ) <> "23:59" Then
				bAuMoinsUnCp = FileDelete ( sNomFic ) 

				If Not bAuMoinsUnCp Then
					stMessage.sTitre		= "Suppression Physique du CP"
					stMessage.sVar[1]		= sNomFic
					stMessage.Icon			= StopSign!
					stMessage.bErreurG	= TRUE
					stMessage.sCode		= "SVAL20"
				End If
			Else
				bAuMoinsUnCp = TRUE
			End If 
		End If			

End Choose 

Return bAuMoinsUnCp


end function

private function long uf_zn_codmotssui ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_CodMotSsui (PRIVATE)
//* Auteur			: PHG
//* Date				: 26/04/2007
//* Libellé			: Controle de COD_MOT_SSUI ( Motif de classement sans suite )
//* Commentaires	: [DCMP070275] Creation uf_zn_codmotssui
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//       JFF   08/07/2013 [PC509-2]
//       JFF   10/08/2017 [MOTIF_SSUITE_90]
//*-----------------------------------------------------------------

long lAction = 0
string sData
sData = idw_wsin.GetText()
if len(sData) > 0 then
	if Not this.uf_GetAutorisation2(208) and 	&
			( 												&
				long(sData) = 3 or 					&
				long(sData) = 4 						&
			) 	then
			
		lACtion = 1
		idw_wsin.iiErreur = 1
		
	End If
End If

// [PC509-2]
if lACtion = 0 And len(sData) > 0 then	
	If long(sData) = 11 Then
		lAction = 1
		idw_wsin.iiErreur = 1
	End If
End If

// [MOTIF_SSUITE_90]
if lACtion = 0 And len(sData) > 0 then	
	If long(sData) = 90 Then
		lAction = 1
		idw_wsin.iiErreur = 1
	End If
End If

Return lAction



end function

private function long uf_zn_trt_divsin_duree_gti_origine (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_Duree_Gti_Origine (PRIVATE)
//* Auteur			: PHG
//* Date				: 24/05/2007
//* Libellé			: Contrôle de la zone Duree_Gti_Origine ( [DCMP070284] )
//* Commentaires	: 
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*					  Boolean		abForcer			Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    09/10/2007  Ajout du code 1
//*       JFF   21/12/2010   [PC301][VESTUSTE]
//*-----------------------------------------------------------------

String sEvalResult
Integer iAction

Long lRc, lDeb, lFin, lCpt, lCpt2, lIdGtiDetPro, lIdEvtDetPro, lIdGtiDetail, lIdEvtDetail
Long lRowPec 

iAction = 0

/*------------------------------------------------------------------*/
/* Pour Modifier la durée de la GC d'origine, il faut que :			  */
/* - L'option 85 soit présente sur le produit.							  */
/* - Tout les détails liés au paramètrage PGC soient 'En cours' ou  */
/* ou Bloqué ( cod_etat in( 0,100) 											  */
/*   ou qu'il n'y ait pas de détail.                                */
/*------------------------------------------------------------------*/
// Par JFF le 06/06/2007
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", K_DP85_GESTIONPGC )
If lDeb <= 0 Then Return iAction

// [PC301][VESTUSTE]
lRowPec = idw_wDivDet.Find ( "NOM_ZONE = 'calcul_vetuste' AND VAL_LST_CAR = 'O'", 1, idw_wDivDet.RowCount () )

If lRowPec > 0 Then
	idw_wDivSin.iiErreur = 2
	iAction = 1					
	Return iAction 
End IF
// [PC301][VESTUSTE]

lRc = idw_wdetail.RowCount()

For lCpt = lDeb To lFin
	lIdGtiDetPro = idw_DetPro.GetItemNumber ( lCpt, "ID_CODE_NUM" )
	lIdEvtDetPro = idw_DetPro.GetItemNumber ( lCpt, "VAL_NUM" )
	
	For lCpt2 = 1 To lRc

		lIdGtiDetail = idw_wdetail.GetItemNumber ( lCpt2, "ID_GTI" )
		lIdEvtDetail = idw_wdetail.GetItemNumber ( lCpt2, "ID_EVT" )
		
		If lIdGtiDetPro = lIdGtiDetail And lIdEvtDetPro = lIdEvtDetail Then
			Choose Case idw_wdetail.GetItemNumber ( lCpt2, "COD_ETAT" )			
				Case 0, 100, 1  // #1
					// Autorisé
				Case Else 
					idw_wDivSin.iiErreur = 1
					iAction = 1					
			End Choose
		End If
		If iAction = 1 Then Exit
	Next
	If iAction = 1 Then Exit	
Next

Return iAction

end function

public function boolean uf_controlergestion_ctrlreglfactu ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_CtrlReglFactu
//* Auteur			: JCA
//* Date				: 24/07/2007
//* Libellé			: 
//* Commentaires	: DCMP 070500
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 
//*-----------------------------------------------------------------

boolean bLock
string sFilter, sOriFilter, sMajPar, sMajParBis
integer iLine, iLineBis, iCountDetail, iDroitFacturation
long lIdprod, lFacturation, lNonFacturation

//Initialisation des variables
iDroitFacturation = 208
lIdprod = idw_wsin.getitemnumber( 1, "ID_PROD")
sFilter = "COD_ETAT = 500"

//Sauvegarde du filtre d'origine
sOriFilter = idw_wDetail.Describe ( "datawindow.table.filter" )
If sOriFilter = "?" Then sOriFilter = ""

//Mise en place du nouveau filtre
idw_wDetail.SetFilter (sFilter)
idw_wDetail.Filter ()

iCountDetail = idw_wDetail.rowcount()

if iCountDetail > 1 then
	for iLine = 1 to iCountDetail
		sMajPar = idw_wDetail.getitemstring(iLine, "MAJ_PAR")
		SQLCA.PS_S01_AUTORISATION (iDroitFacturation, sMajPar, lIdprod, lFacturation)
		
		//on verifie dans le cas de detail à régler par la facturation,
		//qu'il n'existe pas d'autres détails à régler par la gestion
		if lFacturation > 0 then
			for iLineBis = 1 to iCountDetail
				sMajParBis = idw_wDetail.getitemstring(iLineBis, "MAJ_PAR")
				SQLCA.PS_S01_AUTORISATION (iDroitFacturation, sMajParBis, lIdprod, lNonFacturation)

				if lNonFacturation = 0 then
					bLock = true
					exit
				end if
				
			next
		end if

		if bLock then
			exit
		end if
		
	next
end if

idw_wDetail.SetFilter (sOriFilter)
idw_wDetail.Filter ()
idw_wDetail.Sort ()

return bLock
end function

private function boolean uf_controlergestion_accordassureur (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_AccordAssureur (PRIVATE)
//* Auteur			: JFF
//* Date				: 29/08/2007
//* Libellé			: 
//* Commentaires	: DCMP 070587
//*
//* Arguments		: Val		String		asCas "ALERTE"/"CONTROLE"
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    07/09/2007  [DCMP070623] Gestion d'un cas d'exclusion.
//*-----------------------------------------------------------------

Long lDeb, lFin, lIdNatSin, lCodEtat, lTot, lRow, lCpt, lDecAssureur 
Boolean bLock, bAMUPEC, bAMUForcageRegl, bAMUForcagePEC, bMtReg, bAMUCmdeValidee, bAMUPECValidee
String sOriFilter, sFilter

bLock = False
bAMUPECValidee = False

// Somme-nous sur un produit avec gestion de charte de souplesse SFR
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 87 )
If lDeb <= 0 Then Return False

// Lecture nature saisie sur le sin
lIdNatSin = idw_wsin.GetItemNumber( 1, "ID_NATSIN")

// Cette nature fait-elle l'objet d'un contrôle de souplesse (accord assureur) ?
lDeb = idw_DetPro.Find ( "ID_CODE_NUM = " + String ( lIdNatSin ), lDeb, lFin )
If lDeb <= 0 Then Return False
	
// Lecture code état
lCodEtat = idw_wsin.GetItemNumber( 1, "COD_ETAT")

// Lecture décision Assureur
lDecAssureur = Long ( uf_GestOng_Divers_Trouver ( "DEC_ASSUREUR" ) )

// Lecture des zones déterminant un cas d'exclusion (gestion de l'existant)
bMtReg = idw_wsin.GetItemDecimal( 1, "MT_REG") > 0 
bAMUCmdeValidee = idw_LstwCommande.Find ( "CPT_VALIDE > 0 AND COD_ETAT <> 'CNV'", 1, idw_LstwCommande.RowCount () ) > 0

// Recherche si présence d'au moins une PEC Validée
sFilter = "UPPER ( NOM_ZONE ) = 'PEC' AND VAL_LST_CAR = 'O' AND CPT_VALIDE > 0"
idw_wDivDet.SetFilter (sFilter)
idw_wDivDet.Filter ()

lTot = idw_wDivDet.RowCount ( )
bAMUPEC = FALSE
For lCpt = 1 To lTot

	lRow = idw_wdetail.Find ( "ID_GTI = " + String ( idw_wDivDet.GetItemNumber ( lCpt, "ID_GTI" )) + " AND " + &
							 "ID_DETAIL = " + String ( idw_wDivDet.GetItemNumber ( lCpt, "ID_DETAIL" )), 1, idw_wdetail.Rowcount () )

	Choose Case idw_wdetail.GetItemNumber ( lRow, "COD_ETAT" )
		Case 100, 1, 500, 600
			bAMUPECValidee  = TRUE  // C'est une vrai pec validé
	End Choose

	If bAMUPECValidee Then Exit
Next


//Sauvegarde du filtre d'origine sur les détail
sOriFilter = idw_wDivDet.Describe ( "datawindow.table.filter" )
If sOriFilter = "?" Then sOriFilter = ""

// Recherche si présence d'au moins une PEC
sFilter = "UPPER ( NOM_ZONE ) = 'PEC' AND VAL_LST_CAR = 'O'"
idw_wDivDet.SetFilter (sFilter)
idw_wDivDet.Filter ()

lTot = idw_wDivDet.RowCount ( )
bAMUPEC = FALSE
For lCpt = 1 To lTot

	lRow = idw_wdetail.Find ( "ID_GTI = " + String ( idw_wDivDet.GetItemNumber ( lCpt, "ID_GTI" )) + " AND " + &
							 "ID_DETAIL = " + String ( idw_wDivDet.GetItemNumber ( lCpt, "ID_DETAIL" )), 1, idw_wdetail.Rowcount () )

	Choose Case idw_wdetail.GetItemNumber ( lRow, "COD_ETAT" )
		Case 100, 1, 500
			bAMUPEC  = 	TRUE  // C'est une vrai pec
	End Choose

	If bAMUPEC Then Exit
Next

// Recherche si présence d'au moins un forcçage de PEC
sFilter = "UPPER ( NOM_ZONE ) = 'ALT_PEC' AND VAL_LST_CAR = 'O'"
idw_wDivDet.SetFilter (sFilter)
idw_wDivDet.Filter ()

lTot = idw_wDivDet.RowCount ( )
bAMUForcagePEC = FALSE
For lCpt = 1 To lTot

	lRow = idw_wdetail.Find ( "ID_GTI = " + String ( idw_wDivDet.GetItemNumber ( lCpt, "ID_GTI" )) + " AND " + &
							 "ID_DETAIL = " + String ( idw_wDivDet.GetItemNumber ( lCpt, "ID_DETAIL" )), 1, idw_wdetail.Rowcount () )

	Choose Case idw_wdetail.GetItemNumber ( lRow, "COD_ETAT" )
		Case 100, 1, 500
			bAMUForcagePEC = TRUE  // C'est une forçage de pec
	End Choose



	If bAMUForcagePEC Then Exit
Next

idw_wDivDet.SetFilter (sOriFilter)
idw_wDivDet.Filter ()
idw_wDivDet.Sort ()

// Gestion cas d'exclusion 
If bAMUPECValidee Or bMtReg Or bAMUCmdeValidee Then
	// Cas d'exclusion, gestion des dossiers existant.
	Return FALSE
End If

// Cas de la simple alerte au départ.
If Upper ( asCas ) = "ALERTE" Then
	If Long ( uf_GestOng_Divers_Trouver ( "DEC_ASSUREUR" ) ) = 1 Then
		stMessage.sTitre		= "Accord assureur"
		stMessage.Icon			= Information!
		stMessage.sCode		= "WSIN603"		
		stMessage.bErreurG	= False
		f_Message ( stMessage )
	End If
	Return False
End If


// Au moins un forçage de réglement
bAMUForcageRegl = idw_wdetail.Find ( "ALT_REG = 'O' AND COD_ETAT IN ( 500, 600 )", 1, idw_wdetail.RowCount () ) > 0

// Contrôle proprement dit

// Si ( dossier à Régler Ou Au moins une PEC ) ET l'assureur n'a pas donné son accord ET il n'y a pas de forçage de réglement Ni de PEC ALORS Blocage
If Not bLock And ( lCodEtat = 500 Or bAMUPEC ) And lDecAssureur <> 2 And Not bAMUForcageRegl And Not bAMUForcagePEC Then
	bLock = True
	stMessage.Icon			= Information!
	stMessage.bErreurG	= false
	stMessage.sCode		= "WSIN601"
	
End If 

// Si ( dossier à Régler Ou Au moins une PEC ) ET l'assureur n'a pas donné son accord ALORS Blocage
If Not bLock And ( lCodEtat = 200 ) And lDecAssureur <> 3 Then
	bLock = True
	stMessage.Icon			= Information!
	stMessage.bErreurG	= false
	stMessage.sCode		= "WSIN602"
End If 

Return bLock


end function

private subroutine uf_determiner_courrier_forcage_o2m (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_O2M (PRIVATE)
//* Auteur        : PHG
//* Date          : 10/12/2007
//* Libellé       : On met à jour le tableau de des droits de modifications des courriers.
//* Commentaires  : 
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			 JFF     17/06/2014 [DT87][MANTIS11451]
//        JFF     30/06/2015 [DT156]
//        JFF     15/09/2016 [DT156]
// 		 JFF		15/09/2016 [PC151549][MANTIS21781]
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech
Long   				lDeb, lFin, lTotCourrier, lLig, lDeb2
n_cst_attrib_key	lnv_Key[]
string				sTypApp

// [PC938_ORANGE_V3][MANTIS7779]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
If lDeb > 0 Then
	Return	
End If

// [PC151549][MANTIS21781]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 302 )
If lDeb > 0 Then
	If This.uf_GestOng_Divers_Trouver ( "ech_express_48h" ) <> "O" Then
		Return
	End If
End If 

// 
// [DT156]
lDeb2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR = 'O2M' AND ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND INFO_SPB_FRN NOT IN ( 985 )", 1, idw_LstwCommande.rowCount()+1 )

If asPos = "" &
	And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" &
	and lDeb2 > 0 &
	Then
	
	sTypApp = uf_GestOng_Divers_Trouver("TYPE_APP")
	lnv_Key[1].iskeyname	 ="TYP_APP"
	lnv_Key[1].iakeyvalue =sTypApp
	lnv_Key[2].iskeyname	 ="ID_COUR"
	lnv_Key[3].iskeyname	 ="ACTION"
	lnv_Key[3].iakeyvalue ="A_DIAGNOSTIQUER"
		
	F_RechDetPro_withkey( lDeb, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 95, lnv_Key )
	If lDeb > 0 Then
		sIdNatPresent = asIdNatCour
		
		sIdNatCourForcage = lnv_Key[2].iakeyvalue
		
		If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

		If sIdNatPresent <> sIdNatCourForcage Then

			If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= sIdNatCourForcage
				
			Else
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= asIdNatCour
				stMessage.sVar[2] 	= sIdNatCourForcage
			End If 
			
			If F_Message ( stMessage ) = 1 Then

				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!							

				idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
				lTotCourrier	= dwChild.RowCount ()
				sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
				lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
		
		/*------------------------------------------------------------------*/
		/* On verifie si la nature de courrier existe. Si elle n'existe     */
		/* pas, par un effet du hasard bien sur, on arrete le traitement    */
		/* et on positionne sur REF_CIE.                                    */
		/*------------------------------------------------------------------*/
				If	lLig = 0	Then
		
		/*------------------------------------------------------------------*/
		/* On arme la structure de message maintenant, mais le message va   */
		/* être affiché dans le contrôle de gestion.                        */
		/*------------------------------------------------------------------*/
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= Information!
					stMessage.sCode		= "WSIN170"
					stMessage.sVar[1] 	= sIdNatCourForcage
					asPos = "REF_CIE"
				Else
					If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
						asIdNatCour = sIdNatCourForcage
						asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
						
						idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
						idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
						idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
					Else 
						// Le message est armé dans uf_GestionCP
						asPos = "REF_CIE"

					End If
				End If		
			End If
		End If
	End if 
End If


end subroutine

public function datetime uf_lire_date_achat ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_lire_date_achat
//* Auteur			: 
//* Date				: 03/03/2008 16:21:16
//* Libellé			: 
//* Commentaires	: 
//*
//* Arguments		: 
//*
//* Retourne		: datetime	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

long 		lIdProd, lDeb, lFin, lRc, lCpt, lFoundDate
datetime dtDteAchat
string 	sDesc
datetime dtErrorDateTime

dtErrorDateTime = datetime (1900-01-01, 00:00:00)

// Sécurité juste au cas ou, normalement cas impossible
if idw_wsin.rowcount( ) = 0 then return dtErrorDateTime

lIdProd = idw_wsin.Object.id_prod[1] 

f_rechdetpro( lDeb, lFin, idw_DetPro, lIdProd, '-DP', 42)

If lDeb = 0 then // Pas d'option 42 : Lecture sur le sinistre de la date d'achat
	dtDteAchat = datetime(idw_wSin.object.dte_ach_port[1])
Else // Option 42 : Si toute date achat au niveau détail sont identique : on retourne cette date
	  // sinon : 01/01/1900
	lRc = idw_wdetail.RowCount()
	if lRc > 0 Then
		dtDteAchat = idw_wdetail.object.dte_det[1]
		For lCpt = 1 to lRc
			if ( Not isNull(idw_wdetail.object.dte_det[lCpt]) ) and &
				dtDteAchat = idw_wdetail.object.dte_det[lCpt] Then lFoundDate++
		Next
		if lRc <> lFoundDate Then dtDteAchat = dtErrorDateTime
	Else
		dtDteAchat = dtErrorDateTime	
	End If
End If

return dtDteAchat
end function

private function boolean uf_validation_finale_horaire ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Horaire (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/03/2008
//* Libellé       : Interdiction de valider sur certains créneaux horaires
//* Commentaires  : Déve suite travail de nuit pour ne pas gêner le trt mensuel.
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 			FPI	15/09/2014	[OPTIM_SQL]
//*-----------------------------------------------------------------

Boolean bRet
String sChaineValidation, Sval, sHMinValidation, sHMaxValidation, sDteMin, sDteMax
Long lJourMin, lJourMax, lMoisActuel, lJourActuel, lAnneeActuel, lSortie
Time thMin, thMax, tToday
DateTime dtToday, dtMinInterValidation, dtMaxInterValidation 
Date dToday, dDteMin, dDteMax

bRet = TRUE

sChaineValidation = ProfileString ( stGlb.sFichierIni, "APPLICATION", "INTERDIRE_VALIDATION", "" )

Do While  sChaineValidation <> "" And bRet And Mod ( Len (sChaineValidation),19 ) = 0

	sVal = Left ( sChaineValidation, 19 ) // [23/00:45-02/03:00]
	sChaineValidation = Mid ( sChaineValidation, 20, Len ( sChaineValidation ) )

	lJourMin = Long ( Mid ( sVal, 2, 2 ) ) // [23/00:45-02/03:00] => 23
	lJourMAx = Long ( Mid ( sVal, 11, 2 ) ) // [23/00:45-02/03:00] => 02

	sHMinValidation = Mid ( sVal, 5, 5 ) // 00:45
	sHMaxValidation = Mid ( sVal, 14, 5 ) // 03:00
	
	tHmin = Time ( sHMinValidation )
	tHmax = Time ( sHMaxValidation )

	// [OPTIM_SQL]
	dtToday=Datetime( Today(), Now() )
	// :[OPTIM_SQL]
	
	dToday = Date ( dtToday )
	tToday = Time ( dtToday )

	lMoisActuel = Month ( dToday )
	lJourActuel = Day ( dToday )
	lAnneeActuel = Year ( dToday )
	
	If lJourMin > lJourMAx Then

		If lJourActuel > lJourMin Then
		
			sDteMin = String ( lJourMin ) + "/" + String ( lMoisActuel ) + "/" + String ( lAnneeActuel ) 
			lSortie = 0
			Do Until IsDate ( sDteMin ) And lSortie <= 5
				lJourMin --				
				sDteMin = String ( lJourMin ) + "/" + String ( lMoisActuel ) + "/" + String ( lAnneeActuel ) 				
				lSortie ++
			Loop
			dDteMin = Date ( sDteMin ) 
			dtMinInterValidation = Datetime ( dDteMin, tHmin )  

			sDteMax = String ( lJourMAx ) + "/" 
			If lMoisActuel + 1 > 12 Then 
				sDteMax += "01/" + String ( lAnneeActuel + 1 ) 
			Else 
				sDteMax += String ( lMoisActuel + 1 ) + "/" + String ( lAnneeActuel ) 
			End IF
			
			lSortie = 0
			Do Until IsDate ( sDteMin ) And lSortie <= 5
				lJourMAx --				
				sDteMax = String ( lJourMAx ) + "/" 
				If lMoisActuel + 1 > 12 Then 
					sDteMax += "01/" + String ( lAnneeActuel + 1 ) 
				Else 
					sDteMax += String ( lMoisActuel + 1 ) + "/" + String ( lAnneeActuel ) 
				End IF
				lSortie ++				
			Loop
			dDteMax = Date ( sDteMax ) 
			dtMaxInterValidation = Datetime ( dDteMax, tHmax )  
			
		Else
			sDteMin = String ( lJourMin ) + "/" 
			If lMoisActuel - 1 = 0 Then 
				sDteMin += "12/" + String ( lAnneeActuel - 1 ) 
			Else 
				sDteMin += String ( lMoisActuel - 1 ) + "/" + String ( lAnneeActuel ) 
			End IF
			
			lSortie = 0
			Do Until IsDate ( sDteMin ) And lSortie <= 5
				lJourMin --				
				sDteMin = String ( lJourMin ) + "/" 
				If lMoisActuel - 1 = 0 Then 
					sDteMin += "12/" + String ( lAnneeActuel - 1 ) 
				Else 
					sDteMin += String ( lMoisActuel - 1 ) + "/" + String ( lAnneeActuel ) 
				End IF
				lSortie ++				
			Loop
			dDteMin = Date ( sDteMin ) 
			dtMinInterValidation = Datetime ( dDteMin, tHmin )  

			sDteMax = String ( lJourMax ) + "/" + String ( lMoisActuel ) + "/" + String ( lAnneeActuel ) 
			lSortie = 0
			Do Until IsDate ( sDteMax ) And lSortie <= 5
				lJourMax --				
				sDteMax = String ( lJourMax ) + "/" + String ( lMoisActuel ) + "/" + String ( lAnneeActuel ) 				
				lSortie ++
			Loop
			dDteMax = Date ( sDteMax ) 
			dtMaxInterValidation = Datetime ( dDteMax, tHmax )  

		End If 
		
	Else 
		sDteMin = String ( lJourMin ) + "/" + String ( lMoisActuel ) + "/" + String ( lAnneeActuel ) 
		lSortie = 0
		Do Until IsDate ( sDteMin ) And lSortie <= 5
			lJourMin --				
			sDteMin = String ( lJourMin ) + "/" + String ( lMoisActuel ) + "/" + String ( lAnneeActuel ) 				
			lSortie ++
		Loop
		dDteMin = Date ( sDteMin ) 
		dtMinInterValidation = Datetime ( dDteMin, tHmin )  

		sDteMax = String ( lJourMAx ) + "/" + String ( lMoisActuel ) + "/" + String ( lAnneeActuel ) 
		lSortie = 0
		Do Until IsDate ( sDteMax ) And lSortie <= 5
			lJourMAx --				
			sDteMax = String ( lJourMAx ) + "/" + String ( lMoisActuel ) + "/" + String ( lAnneeActuel ) 				
			lSortie ++				
		Loop
		dDteMax = Date ( sDteMax ) 
		dtMaxInterValidation = Datetime ( dDteMax, tHmax )  
		
	End If 
	
	bRet = dtToday < dtMinInterValidation Or dtToday > dtMaxInterValidation 

Loop 

If Not bRet Then 
	stMessage.sTitre		= "Validation Finale d'un dossier"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= TRUE
	stMessage.sCode		= "APPLI11"
	stMessage.sVar[1]		= String ( dtMinInterValidation )
	stMessage.sVar[2]		= String ( dtMaxInterValidation )
	stMessage.sVar[3]		= String ( dtToday )

	F_Message ( stMessage )
End If
	
Return bRet

end function

public subroutine uf_correction_bug_w_para_plafond ();//*-----------------------------------------------------------------
//*
//* Fonction		: uf_correction_bug_w_para_plafond (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 21/05/2008
//* Libellé			: 
//* Commentaires	: Correction bug sur écriture de dw_w_para_plafond
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

Long lTotRow, lCpt, lIdGtiSav, lIdDetailSav, lIdGti, lIdDetail
String sSortOrig, sIdTypPlafSav, sIdTypPlaf

sSortOrig = idw_wParaPlafond.Describe ("DataWindow.Table.Sort") 
If sSortOrig = "?" Then sSortOrig = ""

// Tri sur la clé impératif.
idw_wParaPlafond.SetSort ( "ID_GTI A, ID_DETAIL A, ID_TYP_PLAF A" )
idw_wParaPlafond.Sort ( )

lTotRow = idw_wParaPlafond.RowCount ()
lIdGtiSav = -1
lIdDetailSav = -1
sIdTypPlafSav = ""

For lCpt = lTotRow To 1 Step -1 
	
	lIdGti = idw_wParaPlafond.GetItemNumber ( lCpt, "ID_GTI" )
	lIdDetail = idw_wParaPlafond.GetItemNumber ( lCpt, "ID_DETAIL" )
	sIdTypPlaf = idw_wParaPlafond.GetItemString ( lCpt, "ID_TYP_PLAF" )

	If lIdGti = lIdGtiSav And lIdDetail = lIdDetailSav And sIdTypPlaf = sIdTypPlafSav Then
		Choose Case idw_wParaPlafond.GetItemStatus ( lCpt, 0, Primary! )
			Case New!, NewModified!
				idw_wParaPlafond.RowsDiscard ( lCpt, lCpt, Primary!)
			Case Else	
				idw_wParaPlafond.DeleteRow ( lCpt )
		End Choose
	End If
	
	lIdGtiSav = lIdGti
	lIdDetailSav = lIdDetail
	sIdTypPlafSav = sIdTypPlaf
	
Next

idw_wParaPlafond.SetSort ( sSortOrig ) 
idw_wParaPlafond.Sort () 


end subroutine

public function string uf_controler_param_aig ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_controler_param_aig (PRIVATE)
//* Auteur			: PHG
//* Date				: 19/06/2008
//* Libellé			: [DCMP070914].001 Verification du parametrage des 
//*					  Garantie dependant de AIG
//* Commentaires	: 
//*
//* Arguments		: Value	Long		alRow
//*
//* Retourne		: string	 ""  Ok
//*								 "ALT_BLOC" Garantie Sans Préfixe
//*
//*-----------------------------------------------------------------
//* MAJ      PAR      Date	  Modification
//* 
//*-----------------------------------------------------------------

string	sPos	
Integer	iIdGti, iIdRev, iTotGti, iCpt
long		lIdProd
string	sRet,sLibGti

n_cst_protocole_aig_param_gti lnvProtocoleAig

sPos = ""

iTotGti = idw_lstgti.RowCount()
lIdProd= iDw_wSin.object.id_prod[1]
iIdRev = iDw_wSin.object.id_rev[1]

For iCpt = 1 to iTotGti
	iIdGti = iDw_LstGti.object.id_gti[iCpt]
	sLibGti= iDw_LstGti &
		.Describe("Evaluate('LookUpDisplay(id_gti)', "+string(iIdGti) + " )")

	lnvProtocoleAig = create n_cst_protocole_aig_param_gti
	sRet = lnvProtocoleAig.uf_verif_param_aig( string(lidprod), &
															 string(iidrev ), &
															 string(iidgti ), &
															 SQLCA)
															 
	if sRet <> lnvProtocoleAig.K_OK and Not isnull(sRet) Then
		stmessage.stitre = "Protocole AIG : Gestion des Sinistres"
		stmessage.icon   = Exclamation!
		stmessage.berreurg = TRUE
		stMessage.scode	 = sRet
		stMessage.sVar[1]	 = sLibGti
//		F_message(stMessage)
		sPos = "ALT_BLOC"
		Exit
	End If
Next
Return sPos
end function

private function boolean uf_validation_finale_scf_mail_ech_expr ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_SCF_Mail_Ech_Expr (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 09/10/2006 16:43:53
//* Libellé       : Gestion Particulière pour SURCOUF ECHANGE EXPRESS.
//* Commentaires  : [DCMP080287].FAX_MAIL
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 PHG		16/01/2008 [DCMP090021] Ajout informations légales
//*									dans le mail.
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sFaxDest
String  sNumPanier, sSKU, sNumSerie, sVilleDest, sMailDestCc
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin, lCptFaxEtMail
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
sVal = ""

// Pour récupérer le nom de la boite mail !!
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 101 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sTypMail = "PEC_SCF1"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'AEF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'SCF' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*  #1 Retrait
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sVar[1]    = "MONDOVELO"
	stMessage.sVar[2]    = 	stMessage.sVar[1]
	stMessage.sCode		= "COMD311"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If
*/

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "SURCOUF"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

/*------------------------------------------------------------------*/
/* Le mail sera construit dans une DW qui sera directement (d'un    */
/* coup écrite sur disque). Je préfère cette option plutôt que      */
/* d'écrire un fichier texte progressivement sur disque avec des    */
/* FileWrite. Je trouve la solution de la DW plus sûr.              */
/*------------------------------------------------------------------*/

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sMailDestCc = ""
	sTelDest = ""
	sFaxDest = ""
	sVilleDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sMailDestcc = dwChild.GetItemString ( lRow2, "ADR_MAIL_CC" )	
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	sFaxDest = dwChild.GetItemString ( lRow2, "ADR_FAX" )
	sVilleDest = dwChild.GetItemString ( lRow2, "ADR_VILLE" )
End If	

If IsNull ( sMailDest ) Then sMailDest = ""
If IsNull ( sMailDestCc ) Then sMailDestCc = ""
If IsNull ( sTelDest ) Then sTelDest = ""
If IsNull ( sNomMagasin ) Then sNomMagasin = ""
If IsNull ( sFaxDest ) Then sFaxDest = ""
If IsNull ( sVilleDest ) Then sVilleDest = ""

sTelDest = F_Remplace ( sTelDest, " ", "" )
sTelDest = F_Remplace ( sTelDest, ".", "" )

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
sMailObjet = "FINAREF_SPB_SURCOUF_ECH_EXPRESS_ASSURANCE_N°" + sIdSin + " (A_EXPERTISER)"

/*------------------------------------------------------------------*/
/* 1.2 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody += "ADRESSE_FACTURATION : SPB SURCOUF ECHANGE EXPRESS 76095 LE HAVRE CEDEX"

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += "REFERENCE_SIN_SPB : " + sIdSin + "-" + F_GetItem3 ( idw_LstwCommande, 1, "ID_SEQ" ) 

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_SPB_A_CONTACTER : " 
sMailBody += sSaut
sMailBody += "N°_TELEPHONE_SPB : " + String ( F_GetItem3 ( idw_Produit, 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) 
sMailBody += sSaut
sMailBody += "E-MAIL_EMETTEUR : surcoufechangeexpress@spb.fr" 
sMailBody += sSaut
sMailBody += "(M1)" 


/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_SURCOUF_ECHANGE_EXPRESS_CONTACTER : " 
sMailBody += sSaut
sMailBody += "NUM_TEL : " + sTelDest 
sMailBody += sSaut
sMailBody += "NUM_FAX : " + sFaxDest
sMailBody += sSaut
sMailBody += "E-MAIL : " + sMailDest 
sMailBody += sSaut
sMailBody += "E-MAIL cc : " + sMailDestcc


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody += sSaut 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "NOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) 
sMailBody += sSaut
sMailBody += "PRENOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_1 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_2 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_3 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
sMailBody += sSaut
sMailBody += "CODE POSTAL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += "TEL_ASSURE : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
dVal = Date ( Left ( F_GetItem3 ( idw_wSin, 1, "DTE_SURV" ), 10 ) )
sMailBody += "DATE_SURVENANCE_SINISTRE : " + String ( dVal , "dd/mm/yyyy" ) 
sMailBody += sSaut
dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( dVal, "dd/mm/yyyy" ) 
sMailBody += sSaut

sMailBody += sSaut
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 5.1 : Données particulières 												  */
/*------------------------------------------------------------------*/
sNumPanier = Trim ( This.uf_GestOng_Divers_Trouver ( "NUM_PANIER" ) )
If IsNull ( sNumPanier ) Then sNumPanier = ""
sSKU = Trim ( This.uf_GestOng_Divers_Trouver ( "SKU_IDENT_APPAREIL" ) )
If IsNull ( sSKU ) Then sSKU = ""
sNumSerie = Upper( F_GetItem3 ( idw_wSin, 1, "NUM_IMEI_PORT" ) )

sMailBody += "NUMERO_DE_PANIER : " + sNumPanier
sMailBody += sSaut
sMailBody += "SKU_APPAREIL : " + sSKU
sMailBody += sSaut
sMailBody += "NUMERO_DE_SERIE : " + sNumSerie
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

sMailBody += sSaut
sMailBody += "-- LES MONTANTS SONT EXPRIMES EN EUROS --" 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) 
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 7 : Appareil à Traiter														  */
/*------------------------------------------------------------------*/
sMailBody += sSaut 
sMailBody += "APPAREIL_A_EXPERTISER: " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) 

sMailBody += sSaut
sMailBody += sSaut
sMailBody += sSaut

sMailBody += "DESCRIPTION_DU_DOMMAGE : " 
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "PROBLEME" )) 



/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
//sMailBody += sSaut
//sMailBody += sSaut
// sMailBody += "CLIENT_PASSE_AU_MAGASIN : " 
sMailBody += sSaut
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
//
/*
sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = "AUCUNE DATE PRECISEE PAR L'ASSURE"
sMailBody += "APPAREIL_DEPOSE_LE : " + sVal 
sMailBody += sSaut
*/

sMailBody += "CODE_DU_MAGASIN : " + Upper ( String ( F_GetItem3 ( idw_WSin, 1, "ID_ORIAN_BOUTIQUE" ) ) ) 
sMailBody += sSaut

sNomMagasin = sVilleDest
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody += sSaut
sMailBody += "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += sSaut

sMailBody += "====================================================================================" 
sMailBody += sSaut
sMailBody += "===== ZONE RESERVEE A SURCOUF ECHANGE EXPRESS POUR LE RESULTAT DE L'EXPERTISE ======" 
sMailBody += sSaut
sMailBody += "============== MARQUER D'UN 'X' L'ETAT DE PRESTATION CORRESPONDANT =================" 
sMailBody += sSaut
sMailBody += "====================================================================================" 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "DATE_EXPERTISE :   _ _ / _ _ / _ _ _ _" 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "ETAT_PRESTATION_1 :  |_| SUITE EXPERTISE, REMPLACEMENT ACCEPTE" 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "ETAT_PRESTATION_2 :  |_| SUITE EXPERTISE, REMPLACEMENT REFUSE" 

// #1 [DCMP090021] Ajout Information Légale
sMailBody += sSaut 
sMailBody += sSaut // Saut de deux lignes
sMailBody += sSaut
sMailBody += "====================================================================================" 
sMailBody += sSaut 
sMailBody += "SPB - Siège Social - Gestion et Administration : 71 Quai Colbert - 76600 Le Havre"
sMailBody += sSaut 
sMailBody += "Tel : 02 32 74 20 20 - Fax 02 35 42 09 10"
sMailBody += sSaut 
sMailBody += sSaut // saut d'une ligne
sMailBody += "S.A. de courtage d’assurances au capital de 1 000 000 € SIREN 305 109 779"
sMailBody += sSaut
sMailBody += "Code APE 672 Z"
sMailBody += sSaut
sMailBody += sSaut // saut d'une ligne
sMailBody += "N° d'immatriculation au registre unique des intermédiaires en assurances (ORIAS) :"
sMailBody += sSaut
sMailBody += "07 002 642 - consultable sur www.orias.fr"
sMailBody += sSaut
sMailBody += "====================================================================================" 
sMailBody += sSaut
// Fin #1 [DCMP090021]

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

If Not IsNull ( sMailDestCc ) And Len ( Trim ( sMailDestCc ) ) > 0 Then 
	If Not IsNull ( sMailDest ) And Len ( Trim ( sMailDest ) ) > 0 Then 
		sMailDest += "," 
	End If
	
	sMailDest += sMailDestCc 
End If

For lCptFaxEtMail = 1 To 2

	Choose Case lCptFaxEtMail

		// Cas du mail
		Case 1
			// Si le mail n'est pas correctement renseigné, on passe.
			If Not ( Not IsNull ( sMailDest ) And Len ( Trim ( sMailDest ) ) > 0 ) Then 
				Continue
			End If
			
		// Cas du fax
		Case 2
			If Not IsNull ( sFaxDest ) And Len ( Trim ( sFaxDest ) ) > 0 Then
				sFaxDest = Trim ( sFaxDest )
				sFaxDest = F_Remplace ( sFaxDest, " ", "" )
				sFaxDest = F_Remplace ( sFaxDest, ".", "" )

				// email fax : chaine_libre@num_fax@fax  (ex: toto@00235125487@fax)
				sMailDest = "SURCOURF_ECHANGE_EXPRESS_" + Upper ( F_Remplace ( sVilleDest, " ", "_" ) )  + "@0" + sFaxDest + "@fax"
			Else
				Continue
			End If
			
	End Choose

	bRet = SQLCA.PS_I01_MAILPUSH ( &
		Long ( sIdSin ), &
		Upper ( SQLCA.DataBase ), &
		sMailDest, &
		sMailObjet, &
		bMailBody, &
		sBoiteMail, &
		sTypMail, &
		iIdAppli &
		) = 0

	If bRet Then 
		bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
	End If
	
	If Not bRet Then Exit
	
Next

Return bRet

end function

public function boolean uf_getautorisation (string assection, integer aino);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_getautorisation
//* Auteur			: F. Pinon
//* Date				: 09/09/2008 11:03:31
//* Libellé			: 
//* Commentaires	: 
//*
//* Arguments		: value string assection	 */
/* 	value integer aino	 */
//*
//* Retourne		: boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

String sFicIni
String sValeur, sAltDroit, sOper
integer iValeur
long lTrouve

sFicIni = stGlb.sfichierini
sOper     = stGlb.scodoper
sValeur = ProfileString ( sFicIni, "APPLICATION", asSection, "2" )
	
iValeur      = Integer ( sValeur )

sAltDroit = 'N'
	
If iValeur  = 1 Then
		
	// ... Période de test : L'opérateur doit avoir l'autorisation -NA
		
	SQLCA.ps_s01_autorisation(aiNo, sOper, -1, lTrouve )	
	
	if lTrouve > 0 then sAltDroit="O"
	
ElseIf iValeur = 2 Then
		
	// ... Fonction en production pour tout le monde
	
	sAltDroit = "O"	
	
End If
		
RETURN ( sAltDroit = "O" )
end function

private subroutine uf_controlersaisie_sms (ref string astext, ref string aspos);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_ControlerSaisie_SMS (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 22/08/2003 15:04:10
//* Libellé       : On contrôle que tous les inters la gestion de suivi par SMS soit autorisée
//*				  	  
//* Commentaires  : [FNAC_PROD_ECH_TECH]
//*
//* Arguments     : Réf		asPos		String
//*					  Réf		asText	String
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   03/08/2009   [CAMARA].[PRESTA_WEB_BOUTIQUE]
//*-----------------------------------------------------------------

Long	lTotInter, lCptInter, lDeb, lFin
String	sAltSuiviSMS, sNumPortSms
Boolean  bDP104

If asPos <> "" Then Return

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 104 )
//* #1 [CAMARA].[PRESTA_WEB_BOUTIQUE]
bDP104 = lDeb > 0 

/*------------------------------------------------------------------*/
/* Controle des Communes/CP des inter.                              */
/*------------------------------------------------------------------*/
lTotInter = idw_LstInter.RowCount ()

For lCptInter = 1 To lTotInter
	sAltSuiviSMS = idw_LstInter.GetItemString ( lCptInter, "ALT_SUIVI_SMS" )

	If sAltSuiviSMS = "O" And Not bDP104 Then

		stMessage.sTitre		= "Contrôle de saisie d'un interlocuteur (SMS)"
		stMessage.Bouton		= Ok!
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sVar[1]		= idw_LstInter.GetItemString ( lCptInter, "NOM" ) 
		stMessage.sCode		= "WINT215"
		f_Message ( stMessage )
		asPos = "ADR_CP"
	End If
	
	If asPos <> "" Then 
		asText = asText + " - Décocher le suivi par SMS sur l'interlocuteur " + stMessage.sVar[1] + "~n~r"
		Exit
	End If

	If asPos = "" then
		If idw_LstInter.GetItemString ( lCptInter, "ALT_SUIVI_SMS" ) = "O" And bDP104 Then
			sNumPortSms = Trim ( idw_LstInter.GetItemString ( lCptInter, "NUM_PORT_SMS" ) )
			
			If IsNull ( sNumPortSms ) Or sNumPortSms = "" Then
			
				asPos = "ALT_BLOC"
				stMessage.sTitre		= "Gestion suivi par SMS"
				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!
				stMessage.bErreurG	= False
				stMessage.sCode		= "WINT221"
				f_Message ( stMessage )	
				asText = asText + " - Un numéro de GSM sur l'interlocuteur " + stMessage.sVar[1] + "~n~r"
				Exit
				
			End If
			
			//[NUM_TEL_07]
			If asPos = "" And ( Not IsNumber ( sNumPortSms ) Or Len ( sNumPortSms ) <> 10 Or ( Left ( sNumPortSms, 2 ) <> "06" And Left ( sNumPortSms, 2 ) <> "07" ) ) Then
				asPos = "ALT_BLOC"
				stMessage.sTitre		= "Gestion suivi par SMS"
				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!
				stMessage.bErreurG	= False
				stMessage.sCode		= "WINT226"
				f_Message ( stMessage )
				asText = asText + " - Corriger le numéro de GSM sur l'interlocuteur " + stMessage.sVar[1] + "~n~r"				
			End If
			
		End If
	End If
	
	//* #1 [CAMARA].[PRESTA_WEB_BOUTIQUE]
	If asPos = "" then
		If idw_LstInter.GetItemString ( lCptInter, "ALT_SUIVI_SMS" ) = "N" And bDP104 And &
			idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT', 'CNV') AND ID_TYP_ART = 'SMS'", 1, idw_LstwCommande.Rowcount ()) > 0  Then
				asPos = "ALT_BLOC"
				stMessage.sTitre		= "Gestion suivi par SMS"
				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!
				stMessage.bErreurG	= False
				stMessage.sCode		= "WINT227"
				f_Message ( stMessage )
				asText = asText + " - Corriger incohérence presta SMS et suivi SMS sur l'interlocuteur assuré " + "~n~r"				
		End If			
	End If

Next


end subroutine

private subroutine uf_determiner_data_sinistre_plafpec (ref string asmtpecmonnaie, ref string asmtpeccentimes);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Data_Sinistre_PlafPec (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 11/10/2006 11:39:15
//* Libellé			: 
//* Commentaires	: Déterminer du MT TTC Max PEC  DCMP 060693
//*					  - le montant
//*					  Ou
//*					  - "Impossible de déterminer le montant de PEC"
//*
//* Arguments		: Ref		String	 asMtPecMonnaie  	//* #3 [FNAC_PROD_ECH_TECH]
//*					  Ref		String	 asMtPecCentimes 	//* #3 [FNAC_PROD_ECH_TECH]
//*
//* Retourne		: Aucun 		
//* 
//*-----------------------------------------------------------------
//* #1    JFF   30/11/2006   Modif Bug
//* #2    JFF   04/06/2007   [DCMP070163-070164-070248-070318] Gestion Prise en charge
//* #3 	 JFF	 20/10/2008	[FNAC_PROD_ECH_TECH]
//* #4 	 JFF	 20/10/2008	[FNAC_PROD_ECH_TECH].[20090128104812960]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//*-----------------------------------------------------------------

String sCasPart, sFiltre, sFiltreOrigLstCmde, sIdGti, sIdDetail, sMtPEC, sSeparateurMonnaie
String sFiltreOrigDivDet, sVal
Long   lDeb, lFin, lIdGti, lIdDetail, lRow, lChoixMonnaie, lTot, lCpt, lIdGtiDivDet, lIdDetailDivDet
Decimal {2} dcMtMaxTTC, dcMtPecNlleMethode
Boolean bAuMoinsUneCmde, bUneSeuleGti
s_Plafond_Pec stPlafPec
u_Datawindow udwNull
Long lRowPec, lRowDetail, lRowMtPec
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
String sRech

sCasPart = ""
sMtPEC = "[!! MONTANT DE PRISE EN CHARGE IMPOSSIBLE A DETERMINER !!]"

asMtPecMonnaie = sMtPec  	//* #3 [FNAC_PROD_ECH_TECH]
asMtPecCentimes = sMtPec 	//* #3 [FNAC_PROD_ECH_TECH]


lChoixMonnaie = idw_Produit.GetItemNumber ( 1, "COD_EURO" )
sSeparateurMonnaie = " "

// Casto
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 43 )
If lDeb > 0 Then sCasPart = "Casto"

// Darty Téléphonie
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 11 )
	If lDeb > 0 Then sCasPart = "Darty_Tel"
End If 

sCasPart = Upper ( sCasPart )

// #2

lRowPec = 1
lTot = idw_wDivDet.RowCount () 

DO UNTIL lRowPec > ltot 
	
	lRowPec = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC'", lRowPec, lTot )

	If lRowPec <= 0 Then Exit

	// Une Pec Trouvé
	If lRowPec > 0 Then
			lIdGtiDivDet = idw_wDivDet.GetItemNumber ( lRowPec, "ID_GTI" )
			lIdDetailDivDet = idw_wDivDet.GetItemNumber ( lRowPec, "ID_DETAIL" )

			lRowDetail = idw_wDetail.Find ( "ID_GTI = " + String ( lIdGtiDivDet ) + &
								  " AND ID_DETAIL = " + String ( lIdDetailDivDet ) + &
								  " AND COD_ETAT = 100" , 1, idw_wDetail.RowCount () )

				If lRowDetail > 0 Then
	
					lRowMtPec = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'MT_PEC' " + &
															 " AND ID_GTI = " + String ( lIdGtiDivDet ) + &
															 " AND ID_DETAIL = " + String ( lIdDetailDivDet ), &
															 1, lTot )	
															 
					If lRowMtPec > 0 Then
						dcMtPecNlleMethode = idw_wDivDet.GetItemDecimal ( lRowMtPec, "VAL_MT" )							
					End If 
	
				End If

	End If

//* #4 [FNAC_PROD_ECH_TECH].[20090128104812960]			
//	If dcMtPecNlleMethode <= 0 Then
	If dcMtPecNlleMethode > 0 Then		
		Exit
	Else
		lRowPec++
	End If
LOOP

// Un mt de pec est trouvé, on sort immédiatement avec ce montant
If dcMtPecNlleMethode > 0 Then
	sMtPec = F_Monnaie ( dcMtPecNlleMethode, lChoixMonnaie, sSeparateurMonnaie )

//* #3 [FNAC_PROD_ECH_TECH]
	asMtPecMonnaie = sMtPec
	asMtPecCentimes = String ( dcMtPecNlleMethode )
	asMtPecCentimes = F_Remplace ( asMtPecCentimes, ".", "" ) 

	// #5 JFF 19/10/2009	[FNAC_PROD_ECH_TECH].[BGE]
	asMtPecCentimes = Right ( Fill ( "0", 7 ) + asMtPecCentimes, 7)
	
	Return 
//* :#3 [FNAC_PROD_ECH_TECH]	
End If

// :#2

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
///* #2
//// #1
//Choose Case sCasPart
//	Case "DARTY_TEL"
//		sFiltre = "ID_TYP_ART = 'TEL' AND " + &		
//					 "COD_ETAT   = 'CNV' AND " + &  
//					 "CPT_VALIDE <= 0    AND " + &
//					 "ID_FOUR    = 'DTY' AND " + &
//					 "ISNUMBER ( PROBLEME )"		
//				 
//	Case Else 					 
//		sFiltre = "COD_ETAT = 'CNV' AND CPT_VALIDE <= 0"
//
//End Choose 
//// Fin #1
//
///*------------------------------------------------------------------*/
///* Recherche sur liste des commandes se trouvant au niveau du       */
///* sinistre.                                                        */
///*------------------------------------------------------------------*/
//sFiltreOrigLstCmde = idw_LstwCommande.Describe ( "datawindow.table.filter" )
//If sFiltreOrigLstCmde = "?" Then sFiltreOrigLstCmde = ""
//
//idw_LstwCommande.SetFilter ( sFiltre )
//idw_LstwCommande.Filter ()
//
//bAuMoinsUneCmde = idw_LstwCommande.RowCount () > 0 
//bUneSeuleGti  = idw_LstGti.RowCount () = 1
//
//// #1
//If Not bAuMoinsUneCmde Then 
//	idw_LstwCommande.SetFilter ( sFiltreOrigLstCmde )
//	idw_LstwCommande.Filter ()	
//	
//	// #2 Je laisse tout de même l'ancien contrôle au cas où. 
//	// Mais si on doit en sortir avec une erreur, je renvoi l'éventuel Mt_pec
//	// déterminé par la nouvelle méthode.
//	If dcMtPecNlleMethode > 0 Then
//		sMtPec = F_Monnaie ( dcMtPecNlleMethode, lChoixMonnaie, sSeparateurMonnaie )
//	End If
//	
//	Return sMtPEC
//End If
//// Fin #1
//
//If bAuMoinsUneCmde Then 
//	// mémorisation de la garantie
//	lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
//	sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
//	
//	// mémorisation de l'événement
//	lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
//	sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )
//	
//	lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
//	dcMtMaxTTC = 0 
//	If lRow > 0 Then
//		dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
//	End If
//	
//ElseIf bUneSeuleGti Then
//	lIdGti = idw_LstGti.GetItemNumber ( 1, "ID_GTI" )
//End If
//
////* F_Plafond_Pec 
////* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
////*					  Pour le type Autre, le retour est sous cette forme
////*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
////*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)
//
//:#2
//*/

bUneSeuleGti  = idw_LstGti.RowCount () = 1
If bUneSeuleGti Then
	lIdGti = idw_LstGti.GetItemNumber ( 1, "ID_GTI" )
End If

Choose Case sCasPart

//	Case "DARTY_TEL"
//		If bAuMoinsUneCmde Then
//			stPlafPec = F_Plafond_Pec ( "3", idw_WSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, udwNull, -1, -1 )
//		End If

	Case "CASTO"
		If bUneSeuleGti Then
			sVal = ""
			// [PC545].[BUG_BGE_721]
			//	[PC363].[10%]
			lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
			sVal = "[###]"
			
			If lRow > 0 Then
				lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
			End If
			
			// [PC301].[V15_EVOL_VETUSTE]
			lTotDetail = idw_wDetail.RowCount ()
			dcMtLu = 0
			dcMtMaxLu = 0
			For lCptDet = 1 To lTotDetail	
				
				sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
								"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
								"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
					
				lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
				If lRow > 0 Then
					dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
					If dcMtLu > dcMtMaxLu Then
						dcMtMaxLu = dcMtLu 
					End If
				End If					
				
			Next
			
			If dcMtMaxLu > 0 Then
				lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
			End If
			// [PC301].[V15_EVOL_VETUSTE]
			// :[PC545].[BUG_BGE_721]
			
			stPlafPec = F_Plafond_Pec ( "2" + sVal, idw_wSin, idw_wDivSin, idw_LstGti, idw_wdetail, udwNull, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, -1 )
			
		End If
		
//	Case Else 	
//		If bAuMoinsUneCmde Then
//			stPlafPec = F_Plafond_Pec ( "3", idw_WSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, udwNull, lIdGti, lIdDetail  )
//		End If
End Choose

//idw_LstwCommande.SetFilter ( sFiltreOrigLstCmde )
//idw_LstwCommande.Filter ()


//If bAuMoinsUneCmde Then
//	If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
//	If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
//	If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
//	If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
//	If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
//	If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0
//
//	sMtPEC = F_Monnaie ( dcMtMaxTTC, lChoixMonnaie, sSeparateurMonnaie )
//
If bUneSeuleGti And sCasPart = "CASTO" Then
	dcMtMaxTTC = stPlafPec.dcPlafValAch
	If ( dcMtMaxTTC > stPlafPec.dcPlafGti And stPlafPec.dcPlafGti > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti 
	If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
	If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0
	
	sMtPEC = F_Monnaie ( dcMtMaxTTC, lChoixMonnaie, sSeparateurMonnaie )

//* #3 [FNAC_PROD_ECH_TECH]
	asMtPecMonnaie = sMtPec
	asMtPecCentimes = String ( dcMtMaxTTC )
	asMtPecCentimes = F_Remplace ( asMtPecCentimes , ".", "" ) 
	
	Return 
//* :#3 [FNAC_PROD_ECH_TECH]	

End If

Return 



end subroutine

private function long uf_zn_trt_divsin_moderemplacement (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_ModeRemplacement (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 03/11/2008
//* Libellé			: dès qu'une presta Fnac est passée, on ne modifie plus le mode de remplacement
//* Commentaires	: [FNAC_PROD_ECH_TECH]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   09/01/2009   [FNAC_PROD_ECH_TECH].[20090112170517890]
//* #2    JFF   08/01/2010   [FNAC_TV_BGE]
//*-----------------------------------------------------------------

Integer iAction
Boolean bFnacTV
Long lRow, lDeb, lFin

asData = Upper ( asData )
iAction = 0

// #1 [FNAC_PROD_ECH_TECH].[20090112170517890]

// #2    JFF   08/01/2010   [FNAC_TV_BGE]
/*
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 108  )
bFnacTV= lDeb > 0

// #1 [FNAC_PROD_ECH_TECH].[20090112170517890]
If bFnacTv And asData = "1" Then
	idw_wDivSin.iiErreur = 6
	iAction = 1
	Return iAction
End If
*/

lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND ID_FOUR = 'FNC'", 1, idw_LstwCommande.RowCount () ) 

If lRow > 0 Then
	idw_wDivSin.iiErreur = 5
	iAction = 1
End If

Return iAction

end function

private function boolean uf_validation_finale_envoi_sms ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Envoi_SMS (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 14/01/2009 
//* Libellé       : Gestion Particulière pour l'envoi d'SMS sur un acte de gestion (diffèrent du push informatif)
//* Commentaires  : Aiguillage pour construction du SMS en fonction du produit et du cas de gestion.
//*					  [FNAC_PROD_ECH_TECH].[SMS]
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	 20/10/2008   [CAMARA].[SMS]
//* #2	 JFF	 24/09/2009   [GOSPORT].[SMS]
//*-----------------------------------------------------------------

Boolean bRet
Long    lDeb, lFin

bRet = True

// Gestion FNAC EPT
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 105)
If lDeb > 0 Then 
	bRet = This.uf_validation_finale_envoi_sms_rbsurfact ( 105 )
End If

//* #1 [CAMARA].[SMS]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 118)
If lDeb > 0 Then 
	bRet = This.uf_validation_finale_envoi_sms_rbsurfact ( 118 )
End If

//* #2 [GOSPORT].[SMS]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 120)
If lDeb > 0 Then 
	bRet = This.uf_validation_finale_envoi_sms_rbsurfact ( 120 )
End If


Return bRet

end function

private subroutine uf_determiner_data_propo_appareil (ref string aspropoappareil);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Data_Propo_Appareil (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 11/10/2006 11:39:15
//* Libellé			: [FNAC_PROD_ECH_TECH].[20090401150850217]
//* Commentaires	: Détermination des 3 propo d'appareils
//*					  Ou
//*					  "Impossible de déterminer les propositions d'appareils"
//*
//* Arguments		: Ref		String	 asPropoAppareil 
//*
//* Retourne		: Aucun 		
//* 
//*-----------------------------------------------------------------
//*-----------------------------------------------------------------

String sCasPart, sFiltre, sFiltreOrigLstCmde, sIdGti, sIdDetail
String sFiltreOrigDivDet, sValTemp, sVal
Long   lDeb, lFin, lIdGti, lIdDetail, lRow, lChoixMonnaie, lTot, lCpt, lIdGtiDivDet, lIdDetailDivDet
s_Plafond_Pec stPlafPec
u_Datawindow udwNull
Long lRowPec, lRowDetail, lCptZone, lRowZone


asPropoAppareil = ""

lRowPec = 1
lTot = idw_wDivDet.RowCount () 

DO UNTIL lRowPec > ltot 
	
	lRowPec = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND VAL_LST_CAR = 'O'", lRowPec, lTot )

	If lRowPec <= 0 Then Exit

	// Une Pec Trouvé
	If lRowPec > 0 Then
			lIdGtiDivDet = idw_wDivDet.GetItemNumber ( lRowPec, "ID_GTI" )
			lIdDetailDivDet = idw_wDivDet.GetItemNumber ( lRowPec, "ID_DETAIL" )

			lRowDetail = idw_wDetail.Find ( "ID_GTI = " + String ( lIdGtiDivDet ) + &
								  " AND ID_DETAIL = " + String ( lIdDetailDivDet ) + &
								  " AND COD_ETAT = 100" , 1, idw_wDetail.RowCount () )

				If lRowDetail > 0 Then

					For lCptZone = 1 To 3 

						lRowzone = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PROPO_APP_" + String ( lCptZone ) + "'" + &
																 " AND ID_GTI = " + String ( lIdGtiDivDet ) + &
																 " AND ID_DETAIL = " + String ( lIdDetailDivDet ), &
																 1, lTot )	
														 
						If lRowzone > 0 Then
							sValTemp = Trim ( idw_wDivDet.GetItemString ( lRowzone, "VAL_CAR" ) )
							
							If Not IsNull ( sValTemp  ) And sVal = "" Then

								asPropoAppareil += sValTemp  

								If lCptZone < 3 Then
									asPropoAppareil = asPropoAppareil + char ( 11 )
								End If
								
							End If
						End If 
					Next
				End If					
	End If

	If asPropoAppareil <> "" Then		
		Exit
	Else
		lRowPec++
	End If
LOOP


Return 



end subroutine

private function boolean uf_validation_finale_mcy_mail_telnomade ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MCY_Mail_TelNomade  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 19/06/2009 16:43:53
//* Libellé       : Gestion Particulière pour MOBISQUARE.
//* Commentaires  : [MOBISQUARE]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//* #2    JFF    26/10/09    [DCMP090651] Modif du mail
//			FPI	19/07/2011	[PC514] Suppr du message d'erreur si ZN_TMP_CAS_GESTION absent en cas de réparation
//*-----------------------------------------------------------------

Boolean bRet
String  sCasGestion
Long lRow

sCasGestion = This.uf_GestOng_Divers_Trouver ( "ZN_TMP_CAS_GESTION" )
bRet = False

// [PC514] 
lRow=idw_lstwCommande.Find("COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR  in ('MCY', 'ACU' )",1,idw_lstwCommande.RowCount())

If lRow <=0 Then return TRUE
// :[PC514]

// #2
If sCasGestion = "" Then
	
	// #3
	If this.uf_GetAutorisation2(208) Then Return TRUE

	stMessage.sTitre		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YesNo!
	stMessage.sVar[1]		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
	stMessage.sVar[2]		= "MOBISTORE CYBERPHONE"
	stMessage.sCode		= "COMD301"

	If F_Message ( stMessage ) = 2 Then
		Return FALSE
	Else 
		Return TRUE
	End If

End  If 

Choose Case sCasGestion

	Case "MAIL_AVEC_PROPO"
		bRet = This.uf_Validation_Finale_MCY_Mail_TelNomade1 ()

	Case "MAIL_SANS_PROPO"
		bRet = This.uf_Validation_Finale_MCY_Mail_TelNomade2 ()

End Choose

Return bRet

end function

private function boolean uf_validation_finale_envoi_sms_rbsurfact (integer ioptiondp);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_envoi_sms_rbsurfacture (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 14/01/2009 
//* Libellé       : Gestion SMS FNAC EPT : Type Remboursement sur Facture
//* Commentaires  : [FNAC_PROD_ECH_TECH].[SMS]
//*
//* Arguments     : Val		Integer		iOptionDp
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	 20/10/2008   [CAMARA].[SMS]
//* #2	 JFF	 24/09/2009   [GOSPORT].[SMS]
//*-----------------------------------------------------------------

String sSMSBody, sNumGSM, sMtPec, sLogin, sMdPasse, sCodTrt, sTypSms, sLibProdDP66, sIdFour
Long   lIdSin, lRow, lTotDet, lCptDet, lIdGti, lIdDetail, lDeb, lFin, LgMaxSms
Boolean bCasGestionOk, bAltSMS, bNumGSM, bCmdeFnacSms, bMtPecValide, bRet
n_cst_string	lnv_string

bCasGestionOk = FALSE
bAltSMS = FALSE
bNumGSM = FALSE
bRet = True

sCodTrt = "NETSIZE"
sLogin  = "spbCD"
sMdPasse = "i3m2i2d2"

//* #1 [CAMARA].[SMS]
Choose Case iOptionDp
	Case 105 // Fnac EPT
		sIdFour = "FNC"
		sTypSms = sIdFour + "_ASS_1"

	Case 118 // CAMARA
		sIdFour = "CAM"
		sTypSms = sIdFour + "_ASS_1"

// #2 [GOSPORT].[SMS]
	Case 120 // GOSPORT
		sIdFour = "GOS"
		sTypSms = sIdFour + "_ASS_1"

End Choose
//* :#1 [CAMARA].[SMS]

LgMaxSms = 160

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 66 )
sLibProdDP66 = ""
If lDeb > 0 Then
	sLibProdDP66 = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) )
	If IsNull ( sLibProdDP66  ) Or Trim ( sLibProdDP66 ) = "" Then 
		sLibProdDP66 = ""
	Else
		sLibProdDP66 += "."
	End If
End If

// Critère requis au niveau de l'interlocuteur 
lRow = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.Rowcount() )
If lRow > 0 Then
	bAltSMS = idw_LstInter.GetItemString ( lRow, "ALT_SUIVI_SMS" ) = "O"
	lIdSin  = idw_LstInter.GetItemNumber ( lRow, "ID_SIN" )

	sNumGSM = idw_LstInter.GetItemString ( lRow, "NUM_PORT_SMS" ) 
	bNumGSM = Len ( sNumGSM ) = 10 And Left ( sNumGSM, 2 ) = "06"
	sNumGSM = "+33" + Right ( sNumGSM, 9 )

End If

// Recherche Demande SMS
lRow = idw_LstwCommande.Find ( &
				"ID_FOUR = '" + sIdFour + "' AND " + &
				"COD_ETAT = 'CNV' AND " + &
				"ID_TYP_ART = 'SMS'" &
				, 1, idw_LstwCommande.Rowcount() ) 

bCmdeFnacSms = lRow > 0 

If bCmdeFnacSms Then
	lIdGti = idw_LstwCommande.GetItemNumber ( lRow, "ID_GTI" )
	lIdDetail = idw_LstwCommande.GetItemNumber ( lRow, "ID_DETAIL" )

	lRow = idw_wDivDet.Find ( &
						"ID_GTI = " + String ( lIdGti ) + " AND " + &
						"ID_DETAIL = " + String ( lIdDetail ) + " AND " + &
						"NOM_ZONE = 'pec'" &
						, 1, idw_wDivDet.Rowcount() ) 
	
			// Pec valide pour le SMS présente, dernier contrôle sur le montant
			If lRow > 0 Then
				lRow = idw_wDivDet.Find ( &
							"ID_GTI = " + String ( lIdGti ) + " AND " + &
							"ID_DETAIL = " + String ( lIdDetail ) + " AND " + &
							"NOM_ZONE = 'mt_pec' AND " + &
							"VAL_PCENT > 0 " &
							, 1, idw_wDivDet.Rowcount() ) 
				If lRow > 0 Then
					sMtPec = String ( idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" ) )
					sMtPec +=lnv_string.of_GlobalReplace( stGlb.smonnaiesymboledesire, "\", "" )
					bMtPecValide = TRUE
				End If
			End If
   
End If

bCasGestionOk =  bAltSMS And bNumGSM And bCmdeFnacSms And bMtPecValide

// Ok, on envoi le SMS
If bCasGestionOk Then

//* #1 [CAMARA].[SMS]
Choose Case iOptionDp
	Case 105 // Fnac EPT donné par Lisette
		sSmsBody  = sLibProdDP66 + "Nous vous confirmons que le diagnostic est conforme à votre déclaration."
		sSmsBody += "Le montant d'indemnisation ne pourra dépasser " + sMtPec

	Case 118 // CAMARA donné par Corinne/Maryline
		sSmsBody  = sLibProdDP66 + "Nous vous confirmons que le diagnostic est conforme à votre déclaration."
		sSmsBody += "Le montant d'indemnisation ne pourra dépasser " + sMtPec + "."
		sSmsBody += "Votre numéro de dossier est " + String ( lIdSin )

	// #2 [GOSPORT].[SMS]
	Case 120 // GOSPORT donné par Maryline
		sSmsBody  = sLibProdDP66 + "Nous vous confirmons que l'expertise est conforme à votre déclaration."
		sSmsBody += "Le montant d'indemnisation ne pourra dépasser " + sMtPec + "."
		
		
End Choose
//* :#1 [CAMARA].[SMS]


	// Si dépasse max autorisé, on tronque par la gauche, la partie droite est la plus pertinente.
	sSmsBody = Right ( sSmsBody, LgMaxSms )

	bRet = SQLCA.PS_I01_SMSPUSH ( &
	lIdSin, &
	Upper ( SQLCA.DataBase ), &
	sNumGSM, &
	sLogin, &
	sMdPasse, &
	sSmsBody, &
	sCodTrt, &
	sTypSms, &
	2 &
	) = 0

	If bRet Then 
		bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
	End If
	
End If	

Return bRet

end function

public subroutine uf_controlersaisie_pecweb (ref string astext, ref string aspos);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_controlersaisie_pecweb
//* Auteur			: F. Pinon
//* Date				: 05/08/2009 13:50:47
//* Libellé			: 
//* Commentaires	: [DCMP090366]
//*
//* Arguments		: ref string astext	 */
/* 	ref string aspos	 */
//*
//* Retourne		: (none)	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Long lRow
String sMail


lRow = idw_lstwcommande.Find("ID_FOUR='WBA' AND COD_ETAT <> 'ANN'",1,idw_lstwcommande.RowCount())
if lRow <=0 Then Return

lRow = idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())
if lRow <=0 Then Return

sMail = idw_lstinter.GetItemString( lRow, "ADR_MAIL")

if IsNull(sMail) Or Trim(sMail) = "" Then
	
	asPos = "ALT_BLOC"
	stMessage.sTitre		= "Gestion suivi par Mail"
	stMessage.Icon			= Information!
	stMessage.Bouton		= Ok!
	stMessage.bErreurG	= False
	stMessage.sCode		= "WINT228"
	f_Message ( stMessage )
	asText += "- corriger l'incohérence : adresse mail assuré, prestation WEB~n~r"
End if




end subroutine

private subroutine uf_set_profilfacturation ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Set_ProfilFacturation (PRIVATE)
//* Auteur        : F. Pinon
//* Date          : 06/10/2009 11:08:00
//* Libellé       : 
//* Commentaires  : [DCMP090595]
//*
//* Arguments     : 
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF 	  19/10/2009  [090619]
//*
//*-----------------------------------------------------------------

/*------------------------------------------------------------------*/
/* Rôle de facturation, droit -NA/208										  */
/*------------------------------------------------------------------*/
If Not This.uf_GetAutorisation2 ( 208 ) Then Return

idw_wSin.SetItem ( 1, "ALT_BLOC", "N" )
idw_wSin.SetItem ( 1, "ALT_SSUI", "N" )
idw_wSin.SetItem ( 1, "COD_MOT_SSUI", 0 )
idw_wSin.SetItem ( 1, "ALT_EDIT", "N" )

// #1 [090619] On se positionne sur l'onglet garantie
iUoOng.Uf_ChangerOnglet ( "02" )

end subroutine

private subroutine uf_determiner_courrier_forcage (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_determiner_courrier_forcage
//* Auteur			: F. Pinon
//* Date				: 22/10/2009 14:12:47
//* Libellé			: 
//* Commentaires	: [DCMP090629]
//*
//* Arguments		: ref string aspos	 */
/* 	value integer alcpt	 */
/* 	ref string asidnatcour	 */
/* 	ref string asidcour	 */
//*
//* Retourne		: (none)	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF  20/01/2011    [PC363].[MAIL_ASS_BC]
//* 
// 		FPI	11/05/2011		[PC514]
// 		 JFF   13/02/2012   [PM200][PSM]
//       JFF   02/12/2013 [PC938-1_V1]
//       JFF   12/01/2015 [DT125_LECLERC]
//       JFF   07/05/2015 [DT141]
//       JFF   07/05/2013 [DT127]
//		FPI	08/09/2015	[PC13442-2]
//       JFF   23/11/2016 [DT076-2][MANTIS22710]
//*-----------------------------------------------------------------

// [DT127] 
If asPos="" Then	
	This.uf_Determiner_Courrier_Forcage_DP288 ( asPos, alCpt, asIdNatCour, asIdCour )
End If

If asPos="" Then
	This.uf_Determiner_Courrier_Forcage_WEB( asPos, alCpt, asIdNatCour, asIdCour )
End IF

If asPos="" Then
	// [PM280-2]
	This.uf_Determiner_Courrier_Forcage_O2M_PM280 ( asPos, alCpt, asIdNatCour, asIdCour )
End if

If asPos="" Then
	This.uf_Determiner_Courrier_Forcage_SCFECHEXP( asPos, alCpt, asIdNatCour, asIdCour )
End if

// [PC363].[MAIL_ASS_BC]
If asPos="" Then
	This.uf_Determiner_Courrier_Forcage_AUCHAN ( asPos, alCpt, asIdNatCour, asIdCour )
End if

// [PC514]
// [DT076-2][MANTIS22710]
If asPos="" Then
	This.uf_Determiner_Courrier_Forcage_DP170 ( asPos, alCpt, asIdNatCour, asIdCour )		
End if

// [PM200][PSM]
If asPos="" Then
	This.uf_Determiner_Courrier_Forcage_PSM ( asPos, alCpt, asIdNatCour, asIdCour )
End If

// [PC938-1_V1]
If asPos="" Then
	This.uf_Determiner_Courrier_Forcage_Dp250 ( asPos, alCpt, asIdNatCour, asIdCour )
End If

// [DT125_LECLERC]
If asPos="" Then	
	This.uf_Determiner_Courrier_Forcage_LECLERC ( asPos, alCpt, asIdNatCour, asIdCour )
End If

// [DT141] 
If asPos="" Then	
	This.uf_Determiner_Courrier_Forcage_SBE_SFR ( asPos, alCpt, asIdNatCour, asIdCour )
End If

// [PC13442-2]
If asPos="" Then	
	This.uf_Determiner_Courrier_Forcage_MBS ( asPos, alCpt, asIdNatCour, asIdCour )
End If

end subroutine

private subroutine uf_determiner_courrier_forcage_scfechexp (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_determiner_courrier_forcage_scfechexp
//* Auteur			: F. Pinon
//* Date				: 22/10/2009 14:14:41
//* Libellé			: 
//* Commentaires	: [DCMP090629]
//*
//* Arguments		: ref string aspos	 */
/* 	value integer alcpt	 */
/* 	ref string asidnatcour	 */
/* 	ref string asidcour	 */
//*
//* Retourne		: (none)	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

n_cst_string lnvPFCString
DataWindowChild	dwChild
String sIdNatPresent, sIdNatCourForcage, sRech, sAdrMail
Long   lDeb, lFin, lTotCourrier, lLig

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 101 )

If lDeb <= 0 then Return 

// Cas d'une PEC Surcouf 
sAdrMail = idw_LstInter.GetItemString ( alCpt, "ADR_MAIL" )

If asPos = "" And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" And &
	( LEN(TRIM(sAdrMail)) <= 0  Or IsNull(sAdrMail)) And &
	idw_LstwCommande.Find ( "ID_FOUR = 'SCF' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.Rowcount ()) > 0 Then

	sIdNatPresent = asIdNatCour
	sIdNatCourForcage = "WTE028"


	If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

	If sIdNatPresent <> sIdNatCourForcage Then

		If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
			stMessage.bErreurG	= FALSE
			stMessage.Icon			= question!
			stMessage.sCode		= "WSIN610"
			stMessage.Bouton		= YesNO!
			stMessage.sVar[1] 	= sIdNatCourForcage
			
		Else
			stMessage.bErreurG	= FALSE
			stMessage.Icon			= question!
			stMessage.sCode		= "WSIN615"
			stMessage.Bouton		= YesNO!
			stMessage.sVar[1] 	= asIdNatCour
			stMessage.sVar[2] 	= sIdNatCourForcage
		End If 
		
		If F_Message ( stMessage ) = 1 Then

			stMessage.Icon			= Information!
			stMessage.Bouton		= Ok!							

			idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
			lTotCourrier	= dwChild.RowCount ()
			sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
			lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
	
	/*------------------------------------------------------------------*/
	/* On verifie si la nature de courrier existe. Si elle n'existe     */
	/* pas, par un effet du hasard bien sur, on arrete le traitement    */
	/* et on positionne sur REF_CIE.                                    */
	/*------------------------------------------------------------------*/
			If	lLig = 0	Then
	
	/*------------------------------------------------------------------*/
	/* On arme la structure de message maintenant, mais le message va   */
	/* être affiché dans le contrôle de gestion.                        */
	/*------------------------------------------------------------------*/
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= Information!
				stMessage.sCode		= "WSIN170"
				stMessage.sVar[1] 	= sIdNatCourForcage
				asPos = "REF_CIE"
			Else
				If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
					asIdNatCour = sIdNatCourForcage
					asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
					
					idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
					idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
					idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
				Else 
					// Le message est armé dans uf_GestionCP
					asPos = "REF_CIE"

				End If
			End If		
		End If
	End If
End If
end subroutine

private function long uf_zn_trt_divsin_num_fact (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_Num_Fact (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 03/11/2008
//* Libellé			: Contrôle de 3 zones App_Sin, Batt_sin, Alim_sin, Aut_Acc_Sin 
//* Commentaires	: [MSS_DIAG]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 		 JFF		03/06/2010 [DCMP100397] Numéro de facture Attitude
//*		 JFF     19/06/2012 [CONFO][NV_PROCESS]
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin

asData = Upper ( asData )
iAction = 0

//[DCMP100397] // [CONFO][NV_PROCESS]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 105 )
If iAction = 0 And lDeb > 0 Then
	If IsNull ( asData ) Or Len ( asData ) <> 10 Or Not IsNumber ( asData ) Then
		idw_wDivSin.iiErreur = 1
		iAction = 1
	End If
End If
// :[DCMP100397] 

IF iAction = 0 And asData <> "" Then
	idw_wDivSin.SetItem ( alRow,"ALT_PROT", "O" )
End If

Return iAction

end function

private function boolean uf_validation_finale_mcy_mail_telnomade1 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MCY_Mail_TelNomade1  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 19/06/2009 16:43:53
//* Libellé       : Gestion Particulière pour MOBISQUARE.
//* Commentaires  : [PC853]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//* #2    JFF    26/10/09    [DCMP090651] Modif du mail
//* #3    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		FPI	19/07/2011	[PC514] Ajout de ACUBE
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest, sLibTypApp
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sResponsable
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
String libPersonneMobisquare

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 116 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sTypMail = "PEC_MCP1"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
// [DCMP090283] 
sFiltre = "ID_TYP_ART <> 'CAF' AND " + &	
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			"ID_FOUR  in ('MCY', 'ACU') AND " + &
			 "ISNUMBER ( PROBLEME )"


/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE
For lCptCmd = 1 To 3
	lRow = idw_LstwCommande.InsertRow ( 0 )
	idw_LstwCommande.SetItem ( lRow, "ID_MARQ_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_MODL_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_REF_FOUR", "" )
	idw_LstwCommande.SetItem ( lRow, "MT_TTC_CMDE", 0 )
Next

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

/*------------------------------------------------------------------*/
/* Le mail sera construit dans une DW qui sera directement (d'un    */
/* coup écrite sur disque). Je préfère cette option plutôt que      */
/* d'écrire un fichier texte progressivement sur disque avec des    */
/* FileWrite. Je trouve la solution de la DW plus sûr.              */
/*------------------------------------------------------------------*/

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
	sNomMagasin = ""
	sResponsable = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	sResponsable = dwChild.GetItemString ( lRow2, "RESPONSABLE" )
End If	

If IsNull ( sMailDest ) Then sMailDest = ""
If IsNull ( sTelDest ) Then sTelDest = ""
If IsNull ( sNomMagasin ) Then sNomMagasin = ""

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
sMailObjet = "DAS_SPB_MOBISQUARE_CYBERPHONE_ASSURANCE_N°" + sIdSin
// sMailBody += "ADRESSE_FACTURATION : SPB MONDOVELO 76095 LE HAVRE CEDEX"

// [PC514] - Ajout de ACU
libPersonneMobisquare="PERSONNE_MOBISQUARE_CYBERPHONE_A_CONTACTER : "

If  idw_LstwCommande.GetItemString(1,"ID_FOUR") = "ACU" Then
	sMailObjet = "DAS_SPB_MOBISQUARE_ACUBE_ASSURANCE_N°" + sIdSin
	libPersonneMobisquare="PERSONNE_MOBISQUARE_ACUBE_A_CONTACTER : "
End if
// :[PC514]

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += "REFERENCE_SIN_SPB : " + sIdSin 

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_SPB_A_CONTACTER : " 
sMailBody += sSaut
sMailBody += "N°_TELEPHONE_SPB : " + String ( F_GetItem3 ( idw_Produit, 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) 
sMailBody += sSaut
sMailBody += "E-MAIL_EMETTEUR : mobisquareb2b@spb.eu" 
sMailBody += sSaut
sMailBody += "(M1)" 


/*------------------------------------------------------------------*/
/* 4 : Personne MOBISQUARE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
//sMailBody += "PERSONNE_MOBISQUARE_CYBERPHONE_A_CONTACTER : " + sResponsable
sMailBody += libPersonneMobisquare + sResponsable // [PC514]
sMailBody += sSaut
sMailBody += "NUM_TEL : " + sTelDest 
sMailBody += sSaut
sMailBody += "E-MAIL : " + sMailDest 


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody += sSaut 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "NOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) 
sMailBody += sSaut
sMailBody += "PRENOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_1 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_2 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_3 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
sMailBody += sSaut
sMailBody += "CODE POSTAL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += "TEL_ASSURE : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
dVal = Date ( Left ( F_GetItem3 ( idw_wSin, 1, "DTE_SURV" ), 10 ) )
sMailBody += "DATE_SURVENANCE_SINISTRE : " + String ( dVal , "dd/mm/yyyy" ) 
sMailBody += sSaut
dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( dVal, "dd/mm/yyyy" ) 
sMailBody += sSaut

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "-- LES MONTANTS SONT EXPRIMES EN EUROS --" 
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à Traiter														  */
/*------------------------------------------------------------------*/
sMailBody += sSaut 

sMailBody += sSaut
sMailBody += "APPAREIL_A_REMPLACER : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) 
sMailBody += sSaut

sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" )
sLibTypApp = Space ( 35 )
SQLCA.IM_S01_CODECAR ("-AR", Upper ( sTypApp ), sLibTypApp )
If IsNull ( sLibTypApp ) Then sLibTypApp = ""
sMailBody += "TYPE DE L_A_APPAREIL A REMPLACER : " + Upper ( sLibTypApp )

sMailBody += sSaut
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += "PROPOSITION_1 : "
sMailBody += sSaut
sMailBody +=  "MARQUE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) ) 
sMailBody += sSaut
sMailBody +=  "PRIX_TTC_1 : " + String ( idw_LstwCommande.GetItemDecimal ( 1, "MT_TTC_CMDE" ), "#####0.00" ) 
sMailBody += sSaut
sMailBody +=  "REFEFERENCE_MOBISQUARE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_REF_FOUR" ) ) 

sMailBody += sSaut

sMailBody += sSaut
sMailBody +=  "PROPOSITION_2 : " 
sMailBody += sSaut
sMailBody +=  "MARQUE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MODL_ART" ) ) 
sMailBody += sSaut
sMailBody +=  "PRIX_TTC_2 : " + String ( idw_LstwCommande.GetItemDecimal ( 2, "MT_TTC_CMDE" ), "#####0.00" ) 
sMailBody += sSaut
sMailBody +=  "REFEFERENCE_MOBISQUARE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_REF_FOUR" ) ) 

sMailBody += sSaut

sMailBody += sSaut
sMailBody +=  "PROPOSITION_3 : " 
sMailBody += sSaut
sMailBody +=  "MARQUE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MODL_ART" ) ) 
sMailBody += sSaut
sMailBody +=  "PRIX_TTC_3 : " + String ( idw_LstwCommande.GetItemDecimal ( 3, "MT_TTC_CMDE" ), "#####0.00" ) 
sMailBody += sSaut
sMailBody +=  "REFEFERENCE_MOBISQUARE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_REF_FOUR" ) ) 


/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )


If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
sMailBody += sSaut
// #2 [DCMP090651] Modif du mail
//sMailBody += "APPAREIL_A_REMETTRE_AU_CLIENT, LE CLIENT REGLE SON APPAREIL SUR PLACE AU MAGASIN ET SE FERA REMBOURSER PAR SPB SUR PRESENTATION DE LA FACTURE" 
sMailBody += "APPAREIL_A_REMETTRE_AU_CLIENT"
sMailBody += sSaut


/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
//sMailBody += sSaut
//sMailBody += sSaut
// sMailBody += "CLIENT_PASSE_AU_MAGASIN : " 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
//
/*
sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = "AUCUNE DATE PRECISEE PAR L'ASSURE"
sMailBody += "APPAREIL_DEPOSE_LE : " + sVal 
sMailBody += sSaut
*/

sMailBody += "CODE_DU_MAGASIN : " + Upper ( String ( F_GetItem3 ( idw_WSin, 1, "ID_ORIAN_BOUTIQUE" ) ) ) 
sMailBody += sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody += sSaut
sMailBody += "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) 
sMailBody += sSaut

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_mcy_mail_telnomade2 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MCY_Mail_TelNomade2 (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 19/06/2009 16:43:53
//* Libellé       : Gestion Particulière pour MOBISQUARE.
//* Commentaires  : [MOBISQUARE]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//* #2    JFF    26/10/09    [DCMP090651] Modif du mail
//* #3    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest, sLibTypApp
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sResponsable
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
String libPersonneMobisquare

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 116 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sTypMail = "PEC_MCY2"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			"ID_FOUR  in ('MCY','ACU')"// [PC514] - Ajout de ACU

			 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sVar[1]    = "MOBISTORE CYBERPHONE"
	stMessage.sVar[2]    = 	stMessage.sVar[1]
	stMessage.sCode		= "COMD311"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If	


/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD320"

	F_Message ( stMessage ) 
	Return FALSE
End If

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

/*------------------------------------------------------------------*/
/* Le mail sera construit dans une DW qui sera directement (d'un    */
/* coup écrite sur disque). Je préfère cette option plutôt que      */
/* d'écrire un fichier texte progressivement sur disque avec des    */
/* FileWrite. Je trouve la solution de la DW plus sûr.              */
/*------------------------------------------------------------------*/

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
	sNomMagasin = ""
	sResponsable = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	sResponsable = dwChild.GetItemString ( lRow2, "RESPONSABLE" )
End If	

If IsNull ( sMailDest ) Then sMailDest = ""
If IsNull ( sTelDest ) Then sTelDest = ""
If IsNull ( sNomMagasin ) Then sNomMagasin = ""

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
sMailObjet = "DAS_SPB_MOBISQUARE_CYBERPHONE_ASSURANCE_N°" + sIdSin
// sMailBody += "ADRESSE_FACTURATION : SPB MONDOVELO 76095 LE HAVRE CEDEX"

// [PC514] - Ajout de ACU
libPersonneMobisquare="PERSONNE_MOBISQUARE_CYBERPHONE_A_CONTACTER : "

If  idw_LstwCommande.GetItemString(1,"ID_FOUR") = "ACU" Then
	sMailObjet = "DAS_SPB_MOBISQUARE_ACUBE_ASSURANCE_N°" + sIdSin
	libPersonneMobisquare="PERSONNE_MOBISQUARE_ACUBE_A_CONTACTER : "
End if
// :[PC514]

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += "REFERENCE_SIN_SPB : " + sIdSin 

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_SPB_A_CONTACTER : " 
sMailBody += sSaut
sMailBody += "N°_TELEPHONE_SPB : " + String ( F_GetItem3 ( idw_Produit, 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) 
sMailBody += sSaut
sMailBody += "E-MAIL_EMETTEUR : mobisquareb2b@spb.fr" 
sMailBody += sSaut
sMailBody += "(M1)" 


/*------------------------------------------------------------------*/
/* 4 : Personne MOBISQUARE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
//sMailBody += "PERSONNE_MOBISQUARE_CYBERPHONE_A_CONTACTER : " + sResponsable
sMailBody += libPersonneMobisquare + sResponsable // [PC514]
sMailBody += sSaut
sMailBody += "NUM_TEL : " + sTelDest 
sMailBody += sSaut
sMailBody += "E-MAIL : " + sMailDest 


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody += sSaut 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "NOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) 
sMailBody += sSaut
sMailBody += "PRENOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_1 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_2 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_3 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
sMailBody += sSaut
sMailBody += "CODE POSTAL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += "TEL_ASSURE : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
dVal = Date ( Left ( F_GetItem3 ( idw_wSin, 1, "DTE_SURV" ), 10 ) )
sMailBody += "DATE_SURVENANCE_SINISTRE : " + String ( dVal , "dd/mm/yyyy" ) 
sMailBody += sSaut
dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( dVal, "dd/mm/yyyy" ) 
sMailBody += sSaut

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "-- LES MONTANTS SONT EXPRIMES EN EUROS --" 
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à Traiter														  */
/*------------------------------------------------------------------*/
sMailBody += sSaut 

sMailBody += sSaut
sMailBody += "APPAREIL_A_REMPLACER : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) 
sMailBody += sSaut

sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" )
sLibTypApp = Space ( 35 )
SQLCA.IM_S01_CODECAR ("-AR", Upper ( sTypApp ), sLibTypApp )
If IsNull ( sLibTypApp ) Then sLibTypApp = ""
sMailBody += "TYPE DE L_A_APPAREIL A REMPLACER : " + Upper ( sLibTypApp )

sMailBody += sSaut
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
sMailBody += sSaut
// #2 [DCMP090651] Modif du mail
//sMailBody += "APPAREIL_A_REMETTRE_AU_CLIENT, LE CLIENT REGLE SON APPAREIL SUR PLACE AU MAGASIN ET SE FERA REMBOURSER PAR SPB SUR PRESENTATION DE LA FACTURE" 
sMailBody += "APPAREIL_A_REMETTRE_AU_CLIENT"
sMailBody += sSaut


/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
//sMailBody += sSaut
//sMailBody += sSaut
// sMailBody += "CLIENT_PASSE_AU_MAGASIN : " 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
//
/*
sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = "AUCUNE DATE PRECISEE PAR L'ASSURE"
sMailBody += "APPAREIL_DEPOSE_LE : " + sVal 
sMailBody += sSaut
*/

sMailBody += "CODE_DU_MAGASIN : " + Upper ( String ( F_GetItem3 ( idw_WSin, 1, "ID_ORIAN_BOUTIQUE" ) ) ) 
sMailBody += sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody += sSaut
sMailBody += "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) 
sMailBody += sSaut

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_ex5_mail_pec ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_EX5_Mail_Pec  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 09/04/2010 16:43:53
//* Libellé       : Gestion Particulière pour EXPANSION 5.
//* Commentaires  : [EXP5].[MAIL_BOUTIQUE]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//*  	  	 JFF	  13/04/2010  [WEBSIM2].[FRANCE]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu


F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 130 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sTypMail = "PEC_EX51"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ) )

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'EX5' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*  #1 Retrait
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sVar[1]    = "MONDOVELO"
	stMessage.sVar[2]    = 	stMessage.sVar[1]
	stMessage.sCode		= "COMD311"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If
*/

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "EXPANSION"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

/*------------------------------------------------------------------*/
/* Le mail sera construit dans une DW qui sera directement (d'un    */
/* coup écrite sur disque). Je préfère cette option plutôt que      */
/* d'écrire un fichier texte progressivement sur disque avec des    */
/* FileWrite. Je trouve la solution de la DW plus sûr.              */
/*------------------------------------------------------------------*/

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
End If	

If IsNull ( sMailDest ) Then sMailDest = ""
If IsNull ( sTelDest ) Then sTelDest = ""
If IsNull ( sNomMagasin ) Then sNomMagasin = ""

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
sMailObjet = "Confirmation de prise en charge dossier n°" + sIdSin + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 

/*------------------------------------------------------------------*/
/* 1.2 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody += "ADRESSE_FACTURATION : SPB EXPANSION5 76095 LE HAVRE CEDEX"

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += "REFERENCE_SIN_SPB : " + sIdSin + "-" + F_GetItem3 ( idw_LstwCommande, 1, "ID_SEQ" ) 

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_SPB_A_CONTACTER : " 
sMailBody += sSaut
sMailBody += "N°_TELEPHONE_SPB : " + String ( F_GetItem3 ( idw_Produit, 1, "NUM_TEL" ), "@@@@.@@@.@@@" )
sMailBody += sSaut
sMailBody += "E-MAIL_EMETTEUR : xxxxxxx@spb.fr" 
sMailBody += sSaut
sMailBody += "(M1)" 


/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_EXPANSION5_A_CONTACTER : " 
sMailBody += sSaut
sMailBody += "NUM_TEL : " + sTelDest 
sMailBody += sSaut
sMailBody += "E-MAIL : " + sMailDest 


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody += sSaut 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "NOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) 
sMailBody += sSaut
sMailBody += "PRENOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_1 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_2 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_3 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
sMailBody += sSaut
sMailBody += "CODE POSTAL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += "TEL_ASSURE : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
dVal = Date ( Left ( F_GetItem3 ( idw_wSin, 1, "DTE_SURV" ), 10 ) )
sMailBody += "DATE_SURVENANCE_SINISTRE : " + String ( dVal , "dd/mm/yyyy" ) 
sMailBody += sSaut
dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "DATE_ACHAT_MATERIEL_SINISTRE : " + String ( dVal, "dd/mm/yyyy" ) 
sMailBody += sSaut

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "-- LES MONTANTS SONT EXPRIMES EN EUROS --" 
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à Traiter														  */
/*------------------------------------------------------------------*/
sMailBody += sSaut 

sMailBody += sSaut
sMailBody += "MATERIEL_A_REMPLACER : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) 
sMailBody += sSaut
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

//sMailBody += sSaut
//sMailBody += sSaut
sMailBody += "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
/* [WEBSIM2].[FRANCE] Suppression sur mail de Sandrine Lecroq du 27/04/2010 19h07
sMailBody += sSaut
sMailBody += "MATERIEL_A_REMETTRE_AU_CLIENT : " 
sMailBody += sSaut
*/

/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
//sMailBody += sSaut
//sMailBody += sSaut
// sMailBody += "CLIENT_PASSE_AU_MAGASIN : " 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
//
/*
sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = "AUCUNE DATE PRECISEE PAR L'ASSURE"
sMailBody += "APPAREIL_DEPOSE_LE : " + sVal 
sMailBody += sSaut
*/

sMailBody += "CODE_DU_MAGASIN : " + Upper ( String ( F_GetItem3 ( idw_WSin, 1, "ID_ORIAN_BOUTIQUE" ) ) ) 
sMailBody += sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody += sSaut
sMailBody += "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) 
sMailBody += sSaut

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

public function string uf_gestion_mdp_extranet_cmde_boutique (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Gestion_Mdp_Extranet_Cmde_Boutique (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 13/04/2010
//* Libellé       : Gestion du mdp lié à l'extranet des boutiques.
//* Commentaires  : [WEBSIM2].[FRANCE]
//*
//* Arguments     : String		asCas			Val
//*
//* Retourne      : String 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

String sVal, sVal2, sVal3, sRetour, sRech, sTypeMdp 
Long lRowCNV, lRowCWE, lRow, lDeb, lFin
Boolean bAltEdit 
n_cst_string lnvPFCString
Date dtValDate

bAltEdit = idw_Wsin.GetItemString ( 1, "ALT_EDIT" ) = "O"
asCas = Upper ( asCas )
sRetour = "0"

Choose Case asCas

	// Génére un nouveau mdp et l'écrit sur la Dw
	Case "GENERER"
		
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 81 )
		If lDeb <= 0 Then
			sRetour = "0"			
			stMessage.bErreurG	= FALSE
			stMessage.Icon			= Information!
			stMessage.sCode		= "WSIN692"
			stMessage.Bouton		= Ok!
			F_Message ( stMessage )
			Return sRetour
			
		ElseIf lDeb > 0 Then
			sRech = "( COD_ETAT IN ( 'CNV', 'CWE') AND ID_FOUR = 'WBB' ) "
			lRow = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())
			
			If lRow > 0 Then
				lDeb = idw_DetPro.Find ( "ID_CODE_NUM = " + String ( idw_LstwCommande.GetItemNumber ( lRow,"ID_GTI" ) ) , lDeb, lFin )
			Else 
				lDeb = 0
			End If

			If lDeb = 0 Then 
				sRetour = "0"			
				stMessage.sTitre		= "Problème de paramètrage"
				stMessage.Icon			= Exclamation!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN692" // [WEBSIM2] à Créer !
				F_Message ( stMessage )
				Return sRetour
			End If
		End IF
	
	
		sTypeMdp = Upper ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "TYPE_MDP", ";"))

		If sTypeMdp = "ALEATOIRE" Then
			sRetour = Upper ( F_Generer_Mdp ( K_NB_MX_CAR_MDP_NET_BTQ ) )				
		End If

		If sTypeMdp = "NOM_ASS" Then
			sRetour = Upper ( Trim ( idw_wSin.GetItemString ( 1, "NOM" ) ))
		End If


		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'mdp_net_boutique'", 1,  idw_WDivSin.RowCount () ) 
		If lRow > 0 Then
			uf_gestong_divers_majzone( "MDP_NET_BOUTIQUE", lRow, K_MAJZONE, sRetour )

			// Calcul date fin validité mdp.

			dtValDate = Date ( idw_WDivSin.GetItemDateTime ( lRow, "MAJ_LE" ) )
			sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DUR_VAL_PRSWB", ";")	
			sVal2 = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "UNIT_DUR_VAL", ";")	
			dtValDate = F_Plus_Date ( dtValDate, Long ( sVal ), sVal2 )
			sVal = String ( dtValDate, "DD/MM/YYYY" )

			// On écrit la date de fin de validité sur la commande.
			sRech = "( COD_ETAT IN ( 'CNV', 'CWE') AND ID_FOUR = 'WBB' ) "
			lRow = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())
			sVal3 = idw_LstwCommande.GetItemString ( lRow, "INFO_SPB_FRN_CPLT" )		
			If IsNull ( sVal3 ) Then sVal3 = ""
			lnvPFCString.of_Setkeyvalue ( sVal3, "DTE_FIN_VAL_MDP_BTQ", sVal, ";")
			idw_LstwCommande.SetItem ( lRow, "INFO_SPB_FRN_CPLT", sVal3 )		
		End If


	// Retourne le mdp existant
	Case "RETOURNER"
		sRetour = This.uf_GestOng_Divers_Trouver( "MDP_NET_BOUTIQUE" )

	// Test la présence, retourne "1" si présent, "0" si absent
	Case "PRESENCE_MDP"		
		sVal = This.uf_GestOng_Divers_Trouver( "MDP_NET_BOUTIQUE" )
		If Not IsNull ( sVal ) And Not Trim ( sVal ) = "" Then sRetour = "1"

	Case "PRESENCE_CMDE_WEB" 
		sRech = "( COD_ETAT IN ( 'CNV', 'CWE') AND ID_FOUR = 'WBB' ) "
		lRow = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())
		If lRow > 0 Then
			sRetour = "1"
		Else
			sRetour = "0"			
		End If
		
	Case "PRESENCE_CMDE_WEB_CNV_SEULE" 
		sRech = "( COD_ETAT IN ( 'CNV' ) AND ID_FOUR = 'WBB' ) "
		lRow = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())
		If lRow > 0 Then
			sRetour = "1"
		Else
			sRetour = "0"			
		End If		

	// annuler un mdp, on réécrit null dans la DW
	Case "ANNULER"
		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'mdp_net_boutique'", 1,  idw_WDivSin.RowCount () ) 
		If lRow > 0 Then
			uf_gestong_divers_majzone( "MDP_NET_BOUTIQUE", lRow, K_MAJZONE, stNul.str )
			sRetour = "1"
		End If 

	// On remet à N la case à cocher demandant la REgénération
	Case "INIT_REGEN"
		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'rgn_mdp_net_btq'", 1,  idw_WDivSin.RowCount () ) 
		If lRow > 0 Then
			uf_gestong_divers_majzone( "RGN_MDP_NET", lRow, K_MAJZONE, "N" )
			sRetour = "1"
		End If 
		
	// Demande de regénération ?
	Case "PRESENCE_DEM_REGEN"		
		sVal = This.uf_GestOng_Divers_Trouver( "RGN_MDP_NET_BTQ" )
		If Trim ( sVal ) = "O" Then sRetour = "1"

	// Sommes dans un cas où une dem de regén est nécessaire ?
	Case "CAS_DEM_REGEN" 
		sRech = "( COD_ETAT = 'CNV' AND ID_FOUR = 'WBB' ) "
		lRowCNV = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		sRech = "( COD_ETAT = 'CWE' AND ID_FOUR = 'WBB' ) "
		lRowCWE = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		If ( lRowCWE > 0 And This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "PRESENCE_MDP" ) = "1" ) Then 
			sRetour = "1"			
		Else 
			sRetour = "0"			
		End If

		// Pour être CEB
		If lRowCNV <= 0 And lRowCWE <= 0 Then
			sRetour = "0"
		End If

	// Si nous sommes dans un cas de cmde Web, le mdp est-il bien présent avant quitter le dossier ?
	Case "CONTROLE" 
		sRech = "( COD_ETAT = 'CNV' AND ID_FOUR = 'WBB' ) "
		lRowCNV = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		sRech = "( COD_ETAT = 'CWE' AND ID_FOUR = 'WBB' ) "
		lRowCWE = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		If ( lRowCNV > 0 Or lRowCWE > 0 ) And This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "PRESENCE_MDP" ) <> "1" Then 
			sRetour = "0"
		Else
			sRetour = "1"
		End If

	// Traitement Général
	Case "TRAITEMENT" 
	
		sRech = "( COD_ETAT = 'CNV' AND ID_FOUR = 'WBB' ) "
		lRowCNV = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		sRech = "( COD_ETAT = 'CWE' AND ID_FOUR = 'WBB' ) "
		lRowCWE = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'mdp_net_boutique'", 1,  idw_WDivSin.RowCount () )
		If lRow > 0 Then
			lRow = idw_WDivSin.Find ( "NOM_ZONE = 'rgn_mdp_net_btq'", 1,  idw_WDivSin.RowCount () )
		End If

		// Problème de param, les zones n'existent pas et elle sont nécessaire pour écire le mdp
		If lRow <=0 And ( lRowCNV > 0 Or lRowCWE > 0 ) Then
			sRetour = "0"
			stMessage.sTitre		= "Problème de paramètrage"
			stMessage.Icon			= Exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "WSIN693"	// [WEBSIM2] à Créer	!
			If bAltEdit Then F_Message ( stMessage )
		Else
			sRetour = "1"
		End If 

		If sRetour = "1" Then
			If ( lRowCNV > 0 And This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "PRESENCE_MDP" ) <> "1" ) Or &
  			   ( lRowCWE > 0 And This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "PRESENCE_DEM_REGEN" ) = "1")  Then

				If This.uf_GestionCP ( "PRESENCE", 0, "A" ) Then
						stMessage.bErreurG	= FALSE
						stMessage.Icon			= Information!
						stMessage.sCode		= "WSIN501"
						stMessage.Bouton		= Ok!
						If bAltEdit Then F_Message ( stMessage )

						sRetour = "0"
				Else
					This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "GENERER" )
					This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "INIT_REGEN" )
					sRetour = "1"
				End If	
			End If				
		End If
		
		If sRetour = "1" And lRowCNV <= 0 And lRowCWE <= 0 Then
			This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "ANNULER" )
			This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "INIT_REGEN" )
			sRetour = "1"
		End If
		
		
End Choose 		

Return sRetour
end function

private function long uf_zn_trt_divsin_rgn_mdp_net_btq (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_Rgn_Mdp_Net_Btq (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 13/04/2010
//* Libellé			: Contrôle de la zone RGN_MDP_NET_BTQ
//* Commentaires	: [WEBSIM2].[FRANCE]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin

asData = Upper ( asData )
iAction = 0

If asData = "O" Then
	If This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "CAS_DEM_REGEN" )	= "0" Then
		idw_wDivSin.iiErreur = 4
		iAction = 1
	End If
End If 

Return iAction

end function

private function string uf_epurezone (string asvaleur);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_epurezone
//* Auteur			: F. Pinon
//* Date				: 11/10/2010 15:34:44
//* Libellé			: Foncion d'épuration du contenu de zone (tab + retours chariots)
//* Commentaires	: [FPI.11102010] 
//*
//* Arguments		: value string asvaleur	 */
//*
//* Retourne		: string	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 		FPI	30/05/2012	[EpureModele]	Suppr des ; dans marque/modèle
//			FPI	27/11/2012	[VDoc9391]
//			FPI	27/09/2013	[VDoc12269]
//       JFF   31/05/2021  ajout ”  (c'est un double quote spécial) [EPUR_MODL]
//*-----------------------------------------------------------------

String sRet
Long lPos, lPos2

if isnull(asvaleur) then return asvaleur

sRet=asvaleur

// [VDoc9391] On supprime tout ce qu'il y a à droite du retour chariot
lPos =Pos(sRet,Char(13))
If lPos <=0 Then 
	lPos =Pos(sRet,Char(10))
else 
	lPos2=Pos(sRet,Char(10))
	If lPos2>0 Then lPos=Min(lPos,  lPos2)
End if

If lPos > 0 Then sRet=Left(sRet, lPos - 1)
// :[VDoc9391]

sRet = f_remplace(sRet,Char(13)," ")
sRet = f_remplace(sRet,Char(10)," ")
sRet = f_remplace(sRet,Char(9)," ")
sRet = f_remplace(sRet,Char(11)," ")
sRet = f_remplace(sRet,";"," ")	// [EpureModele]	
sRet = f_remplace(sRet,"~"","")// [VDoc12269]

// [EPUR_MODL]
sRet = f_remplace(sRet,"”","p")


Return sRet
end function

private function boolean uf_validation_finale_eco_mail_remplpc ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_ECO_Mail_RemplPC  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 13/10/2010 
//* Libellé       : Gestion Particulière pour ECONOCOM.
//* Commentaires  : [PC106_ECONOCOM]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			FPI		14/02/2013	[PC467-2]
//			FPI		27/01/2014	[PC988]
//			FPI		22/04/2014	[VDoc14051]
//			FPI		02/10/2014	[VDOC15495]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sLibGti, sIdEvt
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv 
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
String sCas, sIdFour

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 145 )
If lDeb <= 0 Then Return True

// [PC467-2]
sCas=lnvPFCString.of_getkeyvalue(idw_DetPro.GetItemString(lDeb,"VAL_CAR"),"CAS", ";")
If sCas="" Then sCas="TOSHIBA"
// :[PC467-2]

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL", ";")
sTypMail = "CMDEC1"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PCP' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN  ('ECO','CFI') " 			// [PC988]
//			 "ID_FOUR    = 'ECO' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "ECONOCOM"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdFour=idw_LstwCommande.GetItemString (1, "ID_FOUR")

// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
Choose Case sIdGti
	Case "10"
		sLibGti = "vol"
	Case "11"
		sLibGti = "bris"
		If  sIdFour = "CFI" Then sLibGti = "casse" // [PC988]
	Case Else 
		sLibGti = "GTI_NON_DEFINI_SOUS_uf_Validation_Finale_ECO_Mail_RemplPC"  
End Choose

If IsNull ( sMailDest ) Then sMailDest = ""

sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If

If sIdFour="CFI" Then
	// [VDOC15495]
	sMailObjet = "Commande appareil - Sinistre n°" + sIdSin
	// :[VDOC15495]
Else
	sMailObjet = "Commande de PC Sinistre n°" + sIdSin
End if

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut

If sIdFour="CFI" Then
	// [VDOC15495]
	sMailBody += "Dans le cadre de la garantie vol-casse pour l’Opération Ordi’60 du Conseil Général de l’Oise, nous avons validé le remplacement de la tablette Memup de " 
	sMailBody += + sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) +  ", suite au résultat de votre diagnostic."
	// :[VDOC15495]
Else
	sMailBody += "Dans le cadre de la garantie " + sLibGti + " Opération Ordi’60, nous avons validé le remplacement du PC de " + sAdrLibCiv + " "
	sMailBody += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) + "."
End if

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Je vous remercie de bien vouloir procéder au remplacement de l'appareil "
sMailBody += Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " 

// [VDOC15495]
if sIdFour <> "CFI" Then
	sMailBody += Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) + " "
End if
// :[VDOC15495]

If sIdFour="CFI" Then
	sMailBody += "et de bien vouloir nous faire parvenir le numéro de série du nouvel ordinateur portable." 
Else
	sMailBody += "et de bien vouloir nous faire parvenir le numéro de série du nouvel appareil." 
End if

sMailBody += sSaut
sMailBody += sSaut

// [PC467-2]
If sCas="SAMSUNG" Then
	sMailBody += "Dossier " + sIdSin
Else
	sMailBody += "Dossier ECO" + sIdSin + "-" + F_GetItem3 ( idw_LstwCommande, 1, "ID_SEQ" ) 
End if
// :[PC467-2]

sMailBody += sSaut
sMailBody += sSaut

sMailBody += sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sMailBody += sSaut
sMailBody += F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "TEL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
sMailBody += sSaut

// [PC467-2]
If sCas="SAMSUNG" Then
	sMailBody += "Model code : " + F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) + sSaut
End if
// :[PC467-2]

sMailBody += "Ancien n° de série : " + F_GetItem3 ( idw_WSin, 1, "NUM_IMEI_PORT" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dans cette attente,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Cordialement,"
sMailBody += sSaut

If sCas="SAMSUNG" Then
	sMailBody += sSaut
	sMailBody += "SPB" + sSaut
	sMailBody += "Ordi’60 Assurances" + sSaut
	sMailBody += "76095 LE HAVRE CEDEX" + sSaut
	sMailBody += "Fax : (0)820.901.560" + sSaut
Else
	sMailBody += "Pour SPB"
End if

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_sav_carrefour_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_sav_carrefour_mail  (PRIVATE)
//* Auteur        : FPI
//* Date          : 08/06/2011
//* Libellé       : Gestion Particulière pourCarrefour Casse Vol
//* Commentaires  : [PC321.V9]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
Decimal dcIdSin
String  sFiltreOrig, sFiltre
Long 	  lTotCmd, lDeb, lFin, lIdSeq, lIdInfoSpbFrn
Integer iRet

bRet=TRUE
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 141 )

If lDeb <=0 Then Return TRUE

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   <> 'ANN' AND " + &  
			 "INFO_SPB_FRN IN (1410,1425,1426,1430)    AND " + &
			 "ID_FOUR    = 'SCR' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd > 0 Then 

lIdSeq=idw_LstwCommande.GetItemNumber(1,"ID_SEQ")
dcIdsin = idw_LstwCommande.GetItemDecimal(1,"ID_SIN")

	iRet = SQLCA.PS_S11_MAILPUSH_SAV_CARREFOUR( &
		dcIdsin,			&
		lIdSeq			&
		)
		
	//bRet=(iRet	= 0) // TODO : Cas particulier à gérer ???
	
	If bRet Then 
		bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
	End If
End if

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

Return bRet

end function

private function boolean uf_validation_finale_rdc_mail_bonachat ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_RDC_Mail_BonAchat  (PRIVATE)
//* Auteur        : FPI
//* Date          : 28/12/2010 
//* Libellé       : Gestion Particulière pour RDC.
//* Commentaires  : [PC473]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			FPI		30/06/2011	[PC473.Correction] Reprise du montant de PEC
//			FPI		22/09/2015	[DT172]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin
String sVal,sMailDest
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv 
String sTexteCompl , sListeDetail, sValAchat
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd,    iIdAppli, lDeb, lFin, lCptDetail
DataWindowChild dwChild
n_cst_string lnvPFCString
Decimal dcValAchat
// [PC473.Correction] 
Long lCptDet, lIdGti, lIdDetail, lTotDetail
Decimal {2} dcMtMaxTTC, dcMtLu, dcMtMaxLu
String sRech
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
	
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 157 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL", ";")

sTexteCompl =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "LIB_CONTRAT", ";")
	
sTypMail = "CMDRD1"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'RDC' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
// [VDoc22801].Correction
//If lTotCmd <= 0 Then Return TRUE
If lTotCmd <= 0 Then
	idw_LstwCommande.SetFilter ( sFiltreOrig ) 
	idw_LstwCommande.Filter ()
	Return True
End if
// :[VDoc22801].Correction

// [PC473.Correction]
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "RUE DU COMMERCE"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	
	Return FALSE
End If
// :[PC473.Correction]

/*------------------------------------------------------------------*/
/* Création de la liste des détails concernés.                    */
/*------------------------------------------------------------------*/
sListeDetail=""

For lCptCmd = 1 To lTotCmd 
	sListeDetail += "( ID_GTI = " + string(idw_LstwCommande.GetItemNumber ( lCptCmd, "ID_GTI" ) ) + &
		" AND ID_DETAIL=" + string(idw_LstwCommande.GetItemNumber ( lCptCmd, "ID_DETAIL" ) ) + &
		") OR "
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sListeDetail=Left(sListeDetail, Len(sListeDetail) - 3)

lCptDetail=idw_wdetail.Find("ID_EVT IN (1326,1328) AND (" + sListeDetail + ")",1,idw_wdetail.RowCount())
 
If lCptDetail <=0 Then RETURN TRUE

If lCptDetail < idw_wdetail.RowCount() Then
	If idw_wdetail.Find("ID_EVT IN (1326,1328) AND (" + sListeDetail + ")",lCptDetail+1 ,idw_wdetail.RowCount()) > 0 Then 
		stMessage.sTitre		= "Problème construction mail"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.sVar[1]    = "RDC"
		stMessage.Bouton		= OK!
		stMessage.sCode		= "COMD321"

		F_Message ( stMessage ) 
		
		idw_LstwCommande.SetFilter ( sFiltreOrig ) // // [PC473.Correction]
		idw_LstwCommande.Filter ()
		Return FALSE
	End If
End if

// [PC473.Correction]
/*
sValAchat="0.00"
dcValAchat=idw_wdetail.GetItemDecimal(lCptDetail, "MT_VAL_ACHAT" ) 
if not isnull(dcValAchat) Then sValAchat = string(dcValAchat,"0.00")


lCptCmd = idw_lstwcommande.Find("ID_GTI = " + string(idw_wdetail.GetItemNumber ( lCptDetail, "ID_GTI" ) ) + &
		" AND ID_DETAIL=" + string(idw_wdetail.GetItemNumber ( lCptDetail, "ID_DETAIL" ) ),  &
		1,idw_lstwcommande.RowCount())
*/

// Récup de la valeur d'achat
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )

lRow = idw_wDetail.Find ( "ID_GTI = " + String(lIdGti) + " AND ID_DETAIL = " + String(lIdDetail), 1, idw_wDetail.RowCount () )

dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If

//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]
stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


lCptCmd=1
// :[PC473.Correction]

If IsNull ( sMailDest ) Then sMailDest = ""

// [DT172]
sMailObjet = sTexteCompl  + " / n° " + sIdSin + " / "
sMailObjet += 	F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) + " / " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) 
sMailObjet += " / Bon de remplacement"

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Cet assuré, suite à déclaration de sinistre, peut bénéficier d'un remplacement de son appareil sinistré, au titre de la garantie du contrat "
sMailBody += sTexteCompl + " Rueducommerce.com."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Marque et Modèle de l'appareil de remplacement :  "
sMailBody += Upper ( F_GetItem3 ( idw_wSin, lCptCmd, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, lCptCmd, "MODL_PORT" ) ) + "."
sMailBody += sSaut
sMailBody += "A cet effet, merci de bien vouloir éditer un bon d'achat de " + String ( dcMtMaxTTC , "#####0.00" )  // ald sValAchat [PC473.Correction]
sMailBody += "€ correspondant à la valeur d'un appareil de remplacement de marque et de modèle identique ou à défaut, "
sMailBody += "si cet appareil n'est plus commercialisé, par un appareil équivalent possédant les mêmes fonctionnalités dans la limite du prix d'achat de l'appareil d'origine, "
sMailBody += "sans pouvoir excéder le plafond de garantie."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° dossier sinistre : " + sIdSin
sMailBody += sSaut
sMailBody += "N° adhérent : " + idw_wsin.GetItemString(1,"ID_ADH")
sMailBody += sSaut
//sMailBody += "N° de commande : " + string(idw_LstwCommande.GetItemNumber(lCptCmd,"ID_SEQ"))

sMailBody += "N° de commande : " + uf_gestong_divers_trouver( "num_commande") // [DT172]

sMailBody += sSaut
sMailBody += sSaut

sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If

sMailBody += "Nom : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) 
sMailBody += sSaut
sMailBody += "Prénom : " +  Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "Adresse : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sMailBody += sSaut
sMailBody += "Code postal : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " 
sMailBody += sSaut
sMailBody += "Ville : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += "Téléphone portable : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
sMailBody += sSaut

sMailBody += "Sincères salutations" // [DT172]

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

// [PC473.Correction]
idw_LstwCommande.SetFilter ( sFiltreOrig ) 
idw_LstwCommande.Filter ()
		
Return bRet

end function

private function boolean uf_validation_finale_grosbill_mailaxaprs ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_GrosBill_MailAxaPRS  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 20/01/2011 
//* Libellé       : 
//* Commentaires  : [GROSBILL].[PC398-403-479]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		FPI	12/10/2011	[PC398] Numéro de facture
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest, sLibTypApp
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sResponsable, sNumFacture
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu


F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 159 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_AXA", ";")
sTypMail = "PRSAXA"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PRS' AND " + &	
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'AXA'"
			 
/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "AXA réparation"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

If IsNull ( sMailDest ) Then sMailDest = ""

sMailObjet = "Demande d'intervention sur dossier GROSBILL GEM n°" + sIdSin

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dans le cadre de notre contrat commun GrosBill GEM, je vous fais parvenir les informations d’un client nous ayant déclaré un sinistre :" 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nom/Prénom : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "Adresse : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sMailBody += sSaut
sMailBody += "Code Postal/Ville : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += "Teléphone : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
sMailBody += "Email : "

lRow = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.RowCount())
If lRow > 0 Then
	sMailBody += F_GetItem3 ( idw_LstInter, lRow, "ADR_MAIL")
End If 
sMailBody += sSaut

dVal = Date ( Left ( F_GetItem3 ( idw_wSin, 1, "DTE_SURV" ), 10 ) )
sMailBody += "Date de survenance de la panne : " + String ( dVal , "dd/mm/yyyy" ) 

sMailBody += sSaut
sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody += "Appareil en panne : " + Upper ( sVal ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) 
sMailBody += sSaut
sMailBody += "Numéro de série : " + F_GetItem3 ( idw_WSin, 1, "NUM_IMEI_PORT" ) 
sMailBody += sSaut

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If

sMailBody += "Prix d'achat : " +  String ( dcMtMaxTTC , "#####0.00" ) + "€"
sMailBody += sSaut

//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

//sMailBody += sSaut
//sMailBody += sSaut
sMailBody += "Montant de prise en charge maximum : " +  String ( dcMtMaxTTC , "#####0.00" ) + "€"
sMailBody += sSaut

// [PC398] N° de facture
sNumFacture=""
lRow=idw_wdivsin.Find("Upper(NOM_ZONE) = 'NUM_FACT'",1,idw_wdivsin.RowCount())
If lRow > 0 Then sNumFacture=idw_wdivsin.GetItemString(lRow,"VAL_CAR")
If IsNull ( sNumFacture ) Then sNumFacture = ""
// :[PC398]

dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "Date d'achat : " + String ( dVal, "dd/mm/yyyy" ) 
sMailBody += sSaut

//sMailBody += "Numéro de facture GrosBill : " + F_GetItem3 ( idw_wSin, 1, "ID_CONTRAT_ABONNE" )
sMailBody += "Numéro de facture GrosBill : " + sNumFacture // [PC398]
sMailBody += sSaut
sMailBody += "Description de la panne : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "PROBLEME" )) 
sMailBody += sSaut
sMailBody += "Numéro de dossier SPB : " + sIdSin + "-" + F_GetItem3 ( idw_LstwCommande, 1, "ID_SEQ" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dans cette attente,"
sMailBody += sSaut
sMailBody += "Cordialement,"
sMailBody += sSaut
sMailBody += "Pour SPB"

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_grosbill_mailgrbcmd ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_GrosBill_MailGrbCmd  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 20/01/2011 
//* Libellé       : 
//* Commentaires  : [GROSBILL].[PC398-403-479]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		FPI	 09/11/2011	[PC403][NDC_V7]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest, sLibTypApp
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sResponsable, sLibPolice, sOption67
String  sAdrLibCiv
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin, lIdPolice 
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
String sLibProdDP66, sLibAppRempl

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 159 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_GRB", ";")
sTypMail = "CMDGRB"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &	
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'GRB'"
			 
/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "GROSBILL"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

// Le libpolice
sLibPolice = ""
lRow = idw_Garantie.Find ( "ID_REV = " + String ( idw_wSin.GetItemNumber ( 1, "ID_REV" )) + " AND " + &
									"ID_GTI = " + String ( lIdGti ), 1, idw_Garantie.RowCount () )
If lRow > 0 Then
	lIdPolice = idw_Garantie.GetItemNumber ( lRow, "ID_POLICE" )
	lRow = idw_Police.Find ( "ID_POLICE = " + String ( lIdPolice  ), 1, idw_Police.Rowcount() )
	If lRow > 0 Then
		sLibPolice = idw_Police.GetItemString ( lRow, "LIB_POLICE" )
	End If
End If 

// sOption67
sOption67 = ""
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 67 )
If lDeb > 0 Then
	sOption67 = idw_DetPro.GetItemString ( lDeb, "VAL_CAR" )
End If 

//	[PC403][NDC_V7]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 66 )
sLibProdDP66 = ""
If lDeb > 0 Then
	sLibProdDP66 = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) )
	If IsNull ( sLibProdDP66  ) Or Trim ( sLibProdDP66 ) = "" Then 	sLibProdDP66 = ""
End If

lRow = idw_wdivdet.Find ("UPPER(NOM_ZONE) = 'PROPO_APP_1'",1, idw_wdivdet.RowCount())
sLibAppRempl=""
If lRow > 0 Then sLibAppRempl = idw_wdivdet.GetItemString(lRow,"VAL_CAR")

// Civilité
sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

If IsNull ( sMailDest ) Then sMailDest = ""

sMailObjet = "Contact client appareil de remplacement Dr n°" + sIdSin


sMailBody +="Contrat : Garantie " + sLibProdDP66 + sSaut
sMailBody +="Numéro : " + sLibPolice + sSaut
sMailBody += sSaut
sMailBody += sSaut
	
sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nous vous informons que " + sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) + " "
sMailBody += "nous a contacté pour le remplacement de son appareil dont vous trouverez les références ci-dessous :"

sMailBody += sSaut

sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sLibTypApp= sVal

sMailBody += "Désignation de l'appareil : " + Upper ( sVal ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) 
sMailBody += sSaut

dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "Date d'achat : " + String ( dVal, "dd/mm/yyyy" ) 
sMailBody += sSaut

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If

sMailBody += "Prix d'achat : " +  String ( dcMtMaxTTC , "#####0.00" ) + "€"
sMailBody += sSaut

//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

//sMailBody += sSaut
//sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Suite à l’accord de " + sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) + " "
sMailBody += "l’appareil de remplacement qui devra lui être livré est : "
sMailBody += sSaut
sMailBody += "Désignation de l'appareil de remplacement : " + Upper ( sLibTypApp ) + " " + sLibAppRempl // 	[PC403][NDC_V7] ajout "de remplt"
sMailBody += sSaut
sMailBody += "La valeur de remplacement de l'appareil est limitée à  : " + String ( dcMtMaxTTC , "#####0.00" ) + "€ TTC"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Si cette référence n’est plus disponible, nous vous laissons le soin de contacter  " 
sMailBody += sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) + " "
sMailBody += "afin de lui proposer un autre appareil."
sMailBody += sSaut
sMailBody += "Nous vous informons que le prix de l’appareil de remplacement ne doit en aucun cas être supérieur à " +String ( dcMtMaxTTC , "#####0.00" )  + "€."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Vous trouverez ci-dessous les coordonnées pour la livraison de l’appareil :"
sMailBody += sSaut
sMailBody += sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) + " "
sMailBody += sSaut
sMailBody += F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
If F_GetItem3 ( idw_LstwCommande, 1, "ADR_MAIL" ) <> "" Then
	sMailBody += " - " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_MAIL" )
End if
sMailBody += sSaut
sMailBody += F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" ) 
sMailBody += sSaut
If F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" ) <> "" Then
	sMailBody += F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" ) 
	sMailBody += sSaut
End if	
If F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" ) <> "" Then
	sMailBody += F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" ) 
	sMailBody += sSaut
End if	
sMailBody += Trim(F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ))  + " " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "La facture correspondant à l’appareil de remplacement qui sera livré à "
sMailBody += sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) + " "
sMailBody += "est à adresser à : facturation@spb.fr" 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nous vous remercions pour le suivi de ce dossier."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Assurances GrosBill.com"


idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private subroutine uf_determiner_courrier_forcage_auchan (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_Auchan (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 24/02/2011
//* Libellé       : [PC363].[MAIL_ASS_BC]
//* Commentaires  : 
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF     16/09/2016 [DT247][MANTIS21847]
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech
Long   				lDeb, lFin, lTotCourrier, lLig, lCpt
string				sTypApp, sAdrMail
Boolean				bCondition			

sAdrMail = idw_LstInter.GetItemString ( alCpt, "ADR_MAIL" ) 
If IsNull ( sAdrMail ) Then sAdrMail = ""


F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 140 )
If lDeb <= 0 Then Return 

For lCpt = 1 To 3
	
	Choose Case lCpt
	
		Case 1
			sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_BC", ";")
			bCondition = asPos = "" &
								And lDeb > 0 &
								And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" &
								And sAdrMail = "" &
								And sIdNatCourForcage <> "" &
								And idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR = 'AUC' AND ID_TYP_ART = 'CAF'", 1, idw_LstwCommande.rowCount()+1 ) > 0 &
			
		Case 2
			sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_MAT_RMPL_O2M", ";")
			bCondition = asPos = "" &
								And lDeb > 0 &
								And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" &
								And sAdrMail = "" &
								And sIdNatCourForcage <> "" &
								And idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR = 'O2M' AND ID_REF_FOUR = 'DECISION_SPB'", 1, idw_LstwCommande.rowCount()+1 ) > 0 &
	
		Case 3
			sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_REF_1749", ";")
	
			bCondition = asPos = "" &
								And lDeb > 0 &
								And sIdNatCourForcage <> "" &
								And idw_wRefus.Find ( "ID_MOTIF = 1749 AND ( ALT_OPE = 'O' OR ALT_MAC = 'O' ) ", 1, idw_wRefus.RowCount () ) > 0 &
								And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A"
	
	End Choose

	If IsNull ( sIdNatCourForcage ) Then sIdNatCourForcage  = ""
	
	If bCondition Then
	
			sIdNatPresent = asIdNatCour
			
			If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""
	
			If sIdNatPresent <> sIdNatCourForcage Then
	
				If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= question!
					stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
					stMessage.Bouton		= YesNO!
					stMessage.sVar[1] 	= sIdNatCourForcage
					
				Else
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= question!
					stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
					stMessage.Bouton		= YesNO!
					stMessage.sVar[1] 	= asIdNatCour
					stMessage.sVar[2] 	= sIdNatCourForcage
				End If 
				
				If F_Message ( stMessage ) = 1 Then
	
					stMessage.Icon			= Information!
					stMessage.Bouton		= Ok!							
	
					idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
					lTotCourrier	= dwChild.RowCount ()
					sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
					lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
			
			/*------------------------------------------------------------------*/
			/* On verifie si la nature de courrier existe. Si elle n'existe     */
			/* pas, par un effet du hasard bien sur, on arrete le traitement    */
			/* et on positionne sur REF_CIE.                                    */
			/*------------------------------------------------------------------*/
					If	lLig = 0	Then
			
			/*------------------------------------------------------------------*/
			/* On arme la structure de message maintenant, mais le message va   */
			/* être affiché dans le contrôle de gestion.                        */
			/*------------------------------------------------------------------*/
						stMessage.bErreurG	= FALSE
						stMessage.Icon			= Information!
						stMessage.sCode		= "WSIN170"
						stMessage.sVar[1] 	= sIdNatCourForcage
						asPos = "REF_CIE"
					Else
						If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
							asIdNatCour = sIdNatCourForcage
							asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
							
							idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
							idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
							idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
						Else 
							// Le message est armé dans uf_GestionCP
							asPos = "REF_CIE"
	
						End If
					End If		
				End If
			End If
	End If

Next
end subroutine

public subroutine uf_gestong_divers_majzone (string asnomzone, long alrow, integer aitrt, any aavalue);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GestOng_Divers_MajZone (PUBLIC)
//* Auteur        : Fabry JF/PHG
//* Date          : 24/01/2006
//* Libellé       : Mise à Jour par script d'une zone de l'onglet Divers
//*					  + gestion des valeurs par défaut si Initialisation
//* Commentaires  : 
//*
//* Arguments		: String			asNomZone		Val
//*					  Long			alRow				Val
//*					  Integer		aiTrt				Val : Type de traitement
//*																	1 - Defaut
//*																	2 - Maj de Zone
//*					  any				aaValue			Val : valeur à positionner dans le champs
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    22/06/2006  DCMP 060480
//*
//*       PHG	24/01/2006    	[CRAO_LOT1] 
//*									- Refonte Fonction pour gérer
//*								  	  le cas de mise à jour à la demande
//*									  et non plus uniquement le cas de la gestion
//*									  par defaut : remplace 
//*										uf_gestong_divers_defautzone
//*									- Gestion des colonnes de CRAO
//*
//* #2	 JFF	  06/02/2006  [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
//* #3	 PHG	  20/02/2007	[CRAO_LOT2.004] Anomalie 004 : retour MOA :
//*									- Le champ cra_last_dte doit pouvoir etre remis à null =>
//*									  Implementation du support de cette zone dans la fonction
//* #4    JFF    10/04/2007  DCMP070256
//* #5    JFF    04/06/2007  [DCMP070163-070164-070248-070318] Gestion Prise en charge
//* #6    JFF	  29/08/2007  [DCMP070587]
//*  	    JFF	  13/04/2010  [WEBSIM2].[FRANCE]
//			FPI	20/10/2010 [VDoc1059] - PC516 Valeur par défaut sur durée PGC
//* 		 JFF    04/11/2010 [PC301].[LOT2]
//       JFF  20/01/2011  [PC363].[PANNE_PGC]
//*       JFF   02/04/2011   [PC694][SFR2012]
//       JFF    14/11/2012  [VDOC9376]
//		FPI	18/04/2013	[PC918] V4
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//     JFF  24/05/2013  [PC512-5_ORANGE_V2_BIS]
// 		FPI	31/07/2013	[PC936] PGC exprimée en jours
//		FPI	13/08/2013	[DT058]
//       JFF   13/11/2013 [PC13371_72]
//       JFF   18/03/2014 [DT076_ADVISE_V3]
//		FPI	07/07/2014	 [PC13442]
//       JFF   30/07/2014 [PM234-4_V1]
//		FPI	06/10/2014	[PC13174]
//		FPI	07/10/2014	[OV3.FPI] Temporaire pour le prêt d'appareil endommagé au client
//		fpi		08/10/2014	[FORCER_PAIEMENT_PAYBOX]
//    JFF   09/02/2015 [DT133_CASTO]
//		FPI	05/06/2015	[VDOC17839]
//		FPI	19/08/2015	[DT167]
//		FPI	22/09/2015	[DT172]
//       JFF   04/05/2017 [DT288-1_LOT2] "GEOLOC_SIMPA2"
//       JFF   06/11/2017 [PC171933-V6]
//       JFF   18/12/2018 [PM471-1]
//       JFF   06/04/2020 [PM506-1]
//       JFF   28/06/2022 [RS3074_CASTO]
//       JFF   06/04/2023 [PMO139_RS4926]
//       JFF   26/09/2023 [RS5928_FRCH_CHQ]
//       JFF   22/11/2023 [RS6175_GC_SCRP_SIM2]
//       JFF   18/11/2024 [KSV649_ORREUCARA]
//       JFF   03/03/2025 [PMO268_MIG48]
//*-----------------------------------------------------------------

Boolean	bMajZone
Long		lDeb, lFin, lCpt
String	sIdCode
DateTime dtMajLe //#5
String sGCMoisMini, sGCMoisMax,sValCar, sValCar2  	// [VDoc1059] 
n_cst_string nvString								 // [VDoc1059] 
Long lGCMois
String sUnite

asNomZone = Upper ( asNomZone )
bMajZone = False

Choose Case asNomZone	

	Case "TYPE_APP"

		bMajZone = True

		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 25 )
		If lDeb <= 0 Then Return
		
		Choose Case aiTrt
			case K_DEFAUT
				For lCpt = lDeb To lFin
					// [DT167]
					If nvString.of_getkeyvalue( idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ) , "DEFAUT",";") = "OUI" Then
						sIdCode = idw_DetPro.GetItemString ( lCpt, "ID_CODE_CAR" ) 
						idw_wDivSin.SetItem ( alRow, "VAL_CAR", sIdCode )
						iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_TypeApp ( sIdCode, "VAL_LST_CAR", alRow, TRUE )  // [20241112110249883][DIVOBJ][JFF]
						Exit
					End If 
					// :[DT167]
				Next
		End choose
	// #1
	Case "CHOIX_PACK"

		bMajZone = True

		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 56 )
		If lDeb <= 0 Then Return
		Choose Case aiTrt
			case K_DEFAUT
				
				// [PM471-1]
				If Upper ( Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) ) ) = "DEFAUT" Then
					sIdCode = idw_DetPro.GetItemString ( lDeb, "ID_CODE_CAR" ) 
					idw_wDivSin.SetItem ( alRow, "VAL_CAR", sIdCode )
				End If 
				
			// [PC301].[LOT2]
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", string(aaValue) )
				
		End choose
	// Fin #1
	
	// [VDOC9376]
	Case "TYPAPP_REC_NEU"

		bMajZone = True

		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 226 )
		If lDeb <= 0 Then Return
		Choose Case aiTrt
			case K_DEFAUT
				For lCpt = lDeb To lFin
					// [PC13371_71]
					sValCar2 = nvString.of_getkeyvalue( Upper ( Trim ( idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ) ) ), "DEFAUT", ";")
					If sValCar2 = "OUI" Then
						sIdCode = idw_DetPro.GetItemString ( lCpt, "ID_CODE_CAR" ) 
						idw_wDivSin.SetItem ( alRow, "VAL_CAR", sIdCode )
						iUoGsSpSinistre2.Uf_Zn_Trt_DivSin_TypeApp ( sIdCode, "VAL_LST_CAR", alRow, TRUE )  // [20241112110249883][DIVOBJ][JFF]

						Exit
					End If 
				Next
		
			// [PC301].[LOT2]
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", string(aaValue) )
				
		End choose	
	
	// [PMO139_RS4926]
	Case "CRA_CTRL_IMEI", "TAILLE_TV"

		bMajZone = True

/* [PC946_ORANGE_OPPRO]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 75 )
		If lDeb <= 0 Then Return
*/

		Choose Case aiTrt
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", string(aaValue) )
		End choose

	Case "PROCESS_PRS", "BTQ_PSM"
		
		bMajZone = True
		idw_wDivSin.SetItem ( alRow, "VAL_NBRE", long(aaValue) )		


	Case "CRA_CPT_DMDE" // [CRAO_LOT1] Maj de la zone

		bMajZone = True

		// [KSV649_ORREUCARA]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 387 )
		If lDeb <=0 Then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 388 )
		End If 

		// [KSV649_ORREUCARA]
		If lDeb <=0 Then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 75 )
			If lDeb <= 0 Then Return
		End If 
		
		Choose Case aiTrt
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_NBRE", long(aaValue) )
		End choose

	Case "CRA_SUIVI_IMEI" // [CRAO_LOT1.002] Maj de la zone CRA_SUIVI_IMEI, pour la remettre à null eventuellement
							    // si CRA_CTRL_IMEI est positionné à O automatiquement suite uf_zn_numimeiport_numport.
		bMajZone = True

		// [KSV649_ORREUCARA]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 387 )
		If lDeb <=0 Then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 388 )
		End If 

		// [PMO268_MIG48]
		If lDeb <=0 Then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 394 )
		End If 

		// [KSV649_ORREUCARA]
		If lDeb <=0 Then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 75 )
			If lDeb <= 0 Then Return
		End If 

		
		Choose Case aiTrt
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_NBRE", long(aaValue) )
		End choose

	Case "CRA_DAT_GEN" // [CRAO_LOT1] Maj de la zone

		bMajZone = True

		// [KSV649_ORREUCARA]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 387 )
		If lDeb <=0 Then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 388 )
		End If 

		// [KSV649_ORREUCARA]
		If lDeb <=0 Then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 75 )
			If lDeb <= 0 Then Return
		End If 
		
		Choose Case aiTrt
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_DTE", datetime(aaValue) )
		End choose
	

	Case "CRA_LAST_DTE" //#3 [CRAO_LOT2.004]

		bMajZone = True

		// [KSV649_ORREUCARA]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 387 )
		If lDeb <=0 Then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 388 )
		End If 

		// [KSV649_ORREUCARA]
		If lDeb <=0 Then 
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 75 )
			If lDeb <= 0 Then Return
		End If 
		
		Choose Case aiTrt
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_DTE", datetime(aaValue) )
		End choose

		// [WEBSIM2].[FRANCE] 			// [PC363].[PANNE_PGC]
		// [PC694][SFR2012]
		// [VDOC8806]
		// [PC938_ORANGE_V3]
		// [PC512-5_ORANGE_V2_BIS]
		// [DT076_ADVISE_V3]
		// [PM234-4_V1]
		// [DT172]
		
	Case 	"MDP_NET", &
			"RGN_MDP_NET", &
			"MDP_NET_BOUTIQUE", &
			"PGC_O2M", &
			"CLASSE_CTG_SFR", &
			"APP_SIN", &
			"CONF_REFUS_PEC", &
			"NUM_TRANS_PAYBOX_1", &
			"NUM_TRANS_PAYBOX_2", &
			"ETAT_CAUTION_PAYBOX", &
			"LIB_POLICE", &
			"ID_BOUTIQUE_ADH", &
			"TV_SUPEG_32P", &
			"CODE_PARENTAL", &
			"CODE_VERROU_SHERPA_SCRIPT", &          
			"COD_BOUTIQUE_ADH", &
			"ORANGE_V2_BIS", &
			"FIN_SCRIPT", &
			"CLIENT_VIP", &
			"NUM_COMMANDE", &
			"FRN_REPA_ADH",&
			"FRN_REMPL_ADH",&
			"GEOLOC_SIMPA2",&
			"ADR_MAIL_REPA_ADH",&
			"DECLA_ATLAS_GT", &
			"PCE_MAIL_CASTO", &
			"PERSONNE_SIN", &
			"REVENTE_A_TRAITER_1", &
			"PM506_ETAT_APPEL_APIREST_LAB", &
			"PM506_PERSON_A_RISQUE", &
			"DOSSIER_BLOQUE_DR", &
			"RESIL_AUTO_ADH"

		bMajZone = True
		
		Choose Case aiTrt
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", aaValue )
		End choose

	Case "MT_VAL_PUBLIQUE" //#4

		bMajZone = True
		
		Choose Case aiTrt
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_MT", aaValue )
		End choose

	Case "DEC_ASSUREUR" //#6

		bMajZone = True
		
		Choose Case aiTrt
			case K_DEFAUT
				idw_wDivSin.SetItem ( alRow, "VAL_NBRE", 1 )
		End choose

	Case "ID_CLI_BQ", &
		  "REFUS_SCRIPT"

		bMajZone = True
		
		Choose Case aiTrt
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_NBRE", aaValue )
		End choose


	// [VDoc1059]  [RS6175_GC_SCRP_SIM2]
	Case  "DUREE_GTI_ORIGINE", "DUREE_GTI_ORIG"
		
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 85 )
		If lDeb <= 0 Then Return
	
		Choose Case aiTrt
			case K_DEFAUT
				// Si déjà renseigné, on sort
				 If idw_wDivSin.GetItemNumber(alRow,"VAL_NBRE") <> 0  Then Return
				
				// On récupère les 2 GC sur l'option 85
				sValCar=Trim(idw_DetPro.GetItemString(lDeb,"VAL_CAR"))
				
				// [PC936]
				sUnite=nvString.of_getkeyvalue( sValCar, "UNITE", ";")
				Choose Case sUnite
					Case "J"
						sGCMoisMini = nvString.of_getkeyvalue( sValCar, "GC_JOUR_MIN", ";")
						sGCMoisMax = nvString.of_getkeyvalue( sValCar, "GC_JOUR_MAX", ";")
					Case Else // en mois par défaut
						sGCMoisMini = nvString.of_getkeyvalue( sValCar, "GC_MOIS_MIN",";")
						sGCMoisMax = nvString.of_getkeyvalue( sValCar, "GC_MOIS_MAX",";")
				End Choose
				// :[PC936]
				
				if sGCMoisMini <> sGCMoisMax Then Return // Pas de valeur par défaut
				
				If lDeb <> lFin Then
					// On contrôle que la PGC est définie pareil pour tous les couple gti/evenement
					Do
						lDeb++
						sValCar2=Trim(idw_DetPro.GetItemString(lDeb,"VAL_CAR"))
						if sValCar <> sValCar2 Then Return	// On ne peut pas déterminer la valeur par défaut car on ne connait pas la gti/evt qui seront choisis
					Loop Until lDeb =lFin
				End if
				
				lGCMois = Long(sGCMoisMini)
				idw_wDivSin.SetItem ( alRow, "VAL_NBRE", lGCMois )
				
				If This.uf_zn_trt_divsin_duree_gti_origine( sGCMoisMini,"VAL_NBRE", alrow ) = 1 Then
					idw_wDivSin.SetItem ( alRow, "VAL_NBRE",Long(sValCar)) // On remet l'ancienne valeur par sécurité
				Else
					bMajZone = True
				End If

			// [PC363].[PANNE_PGC]
			Case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_NBRE", Long ( aaValue ))
				bMajZone = True
				
		End Choose				
	// :[VDoc1059]
	
	// [PC918]
	Case "GTI_NON_ACTIVEE_SITE" 

		bMajZone = True
		
		Choose Case aiTrt
			case K_DEFAUT
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", "O" )
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", aaValue )
		End choose

		// [DT058]
	Case "SANCTION_ECO"
		bMajZone = True
		
		Choose Case aiTrt
			case K_DEFAUT
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", "N" )
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", aaValue )
		End choose

	// [RS3074_CASTO]
	Case "ACCORD_CHUBB", "NUM_CAISSE", "NUM_HOTESSE"
		bMajZone = True
		
		Choose Case aiTrt
			case K_DEFAUT
				idw_wDivSin.SetItem ( alRow, "VAL_NBRE", 0 ) // Non renseigné
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_NBRE", aaValue )
		End choose
	
	Case "ECH_EXPRESS_48H",  "PRET_APP_ENDOMMAGE" // [PC13442]
		bMajZone = True
		
		Choose Case aiTrt
			case K_DEFAUT
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", "N" ) // Non renseigné
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", aaValue )
		End choose
	
	Case "INTERV_SERRURIER", "INT_SER_SUP_150" // [PC13174]
		bMajZone = True
		
		Choose Case aiTrt
			case K_DEFAUT
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", "N" ) // Non renseigné
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", aaValue )
		End choose
	
	Case "FRANCHISE_PAYBOX","MODE_PAIEMENT" // [FORCER_PAIEMENT_PAYBOX]
		Choose Case aiTrt
			case K_MAJZONE
				bMajZone = True
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", aaValue )
		End choose

	Case "PCE_MAIL_CASTO" // [DT133_CASTO]
		Choose Case aiTrt
			case K_MAJZONE
				bMajZone = True
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", aaValue )
		End choose
		
	Case "CODIC"		// [VDOC17839]
		Choose Case aiTrt
			case K_MAJZONE
				bMajZone = True
				idw_wDivSin.SetItem ( alRow, "VAL_NBRE", aaValue )
		End choose

	// [RS5928_FRCH_CHQ]		
	Case "DTE_EFF_ARTICLE", &
		  "PM506_APIREST_LAB_APPELEE_LE", & 
		  "DTE_CMPLT_ADH_PAYE_ASS_PAYBOX"

		bMajZone = True

		Choose Case aiTrt
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_DTE", datetime(aaValue) )
		End choose		


	// [PM471-1]
	Case "CHOIX_GRADE"

		bMajZone = True

		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 331 )
		If lDeb <= 0 Then Return
		Choose Case aiTrt
			case K_DEFAUT
				If Upper ( Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) ) ) = "DEFAUT" Then
					sIdCode = idw_DetPro.GetItemString ( lDeb, "ID_CODE_CAR" ) 
					idw_wDivSin.SetItem ( alRow, "VAL_CAR", sIdCode )
				End If 
		
			// [PC301].[LOT2]
			case K_MAJZONE
				idw_wDivSin.SetItem ( alRow, "VAL_CAR", string(aaValue) )
				
		End choose
	// Fin #1		
		
End Choose

If	bMajZone Then

	// #5
	dtMajLe = DateTime ( Today (), Now () )
	idw_wDivSin.SetItem ( alRow, "MAJ_LE", dtMajLe  )
	idw_wDivSin.SetItem ( alRow, "MAJ_PAR", stGlb.sCodOper )
	idw_wDivSin.SetItem ( alRow, "ALT_SUPP", "N" )

	// #5 Plus logique de mettre aussi à jour w_sin
	idw_wSin.SetItem ( 1, "MAJ_LE", dtMajLe )
	idw_wSin.SetItem ( 1, "MAJ_PAR", stGlb.sCodOper )

End If

end subroutine

private function boolean uf_validation_finale_eco_mail_remplpc2 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_ECO_Mail_RemplPC2  (PRIVATE)
//* Auteur        : FPI
//* Date          : 06/04/2011
//* Libellé       : Gestion Particulière pour ECONOCOM CG 60
//* Commentaires  :	[PC469]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 			FPI		27/12/2011 [PC469-1.NDCV2]
//			FPI		09/02/2012	[VDoc6761] Ajout de l'année de contrat
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin, sFic,  sIdGti, sLibGti, sNumIncident
String   sRech,  sVal,   sMailDest,sNomAssure
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv , sAnneeContrat
Blob    bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
n_cst_string lnvPFCString

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 166 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_CMD_PC", ";")
sAnneeContrat = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ANNEE_CONTRAT", ";")

sTypMail = "CMDEC1"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_GTI  IN  (10,11)    AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'ECO' " 


/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "ECONOCOM"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
Choose Case sIdGti
	Case "10"
		sLibGti = "vol"
	Case "11"
		sLibGti = "bris"
	Case Else 
		sLibGti = "GTI_NON_DEFINI_SOUS_uf_Validation_Finale_ECO_Mail_RemplPC2"  
End Choose

// N° d'incident
sNumIncident=""
lRow=idw_wdivsin.Find("Upper(NOM_ZONE) = 'NUM_HOT_LINE'",1,idw_wdivsin.RowCount())
If lRow > 0 Then sNumIncident=idw_wdivsin.GetItemString(lRow,"VAL_CAR")
If IsNull ( sNumIncident ) Then sNumIncident = ""

If IsNull ( sMailDest ) Then sMailDest = ""

// Nom assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )


sMailObjet = "[Case#" +sNumIncident + "] Commande de PC Sinistre n°" + sIdSin

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dans le cadre de la garantie " + sLibGti + " incluse dans l’Assurance Midi-Pyrénées, nous avons validé le remplacement du PC de "
sMailBody += sNomAssure + "."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nous vous remercions de bien vouloir procéder au remplacement de l'appareil "
sMailBody += Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) + " "
sMailBody += "et de bien vouloir nous faire parvenir le numéro de série du nouvel ordinateur portable." 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° incident Hotline Toshiba :  " + sNumIncident
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dossier " + sIdSin 
sMailBody += sSaut
sMailBody += sSaut

sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If

sMailBody += sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sMailBody += sSaut
sMailBody += F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "TEL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Ancien n° de série : " + F_GetItem3 ( idw_WSin, 1, "NUM_IMEI_PORT" ) 
sMailBody += sSaut

// [VDoc6761]
sMailBody += sSaut
sMailBody += "Année du contrat : " + sAnneeContrat
sMailBody += sSaut
// :[VDoc6761]

sMailBody += sSaut

// [PC469-1.NDCV2]
/*sMailBody += "Cordialement,"
sMailBody += sSaut
sMailBody += "Pour SPB"*/
sMailBody += "Bonne réception," +  sSaut
sMailBody +="Le service assurance Région Midi-Pyrénées" +  sSaut
sMailBody += sSaut
sMailBody +="Veuillez répondre à l’adresse suivante :" +  sSaut
sMailBody +="Insurance-crmp@spb.eu" +  sSaut
sMailBody +="ou" +  sSaut
sMailBody +="SPB service Région Midi-Pyrénées" +  sSaut
sMailBody +="76095 Le Havre Cedex" +  sSaut


idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_eco_mail_demenlevt ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_ECO_Mail_DemEnlevt  (PRIVATE)
//* Auteur        : FPI
//* Date          : 06/04/2011
//* Libellé       : Gestion Particulière pour ECONOCOM CG 60
//* Commentaires  :	[PC469]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin, sFic,  sNumIncident
String   sRech,  sVal,   sMailDest, sNomAssure
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv 
Blob    bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
n_cst_string lnvPFCString

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 166 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_ENLEV_PC", ";")

sTypMail = "CMDEC2"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'EDI' AND " + &		
			 "ID_GTI  =11    AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'TSF' " 


/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "ECONOCOM"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// N° d'incident
sNumIncident=""
lRow=idw_wdivsin.Find("Upper(NOM_ZONE) = 'NUM_HOT_LINE'",1,idw_wdivsin.RowCount())
If lRow > 0 Then sNumIncident=idw_wdivsin.GetItemString(lRow,"VAL_CAR")
If IsNull ( sNumIncident ) Then sNumIncident = ""

If IsNull ( sMailDest ) Then sMailDest = ""

sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )

sMailObjet = "Demande d’enlèvement pour établissement devis RTS sinistre n° " + sIdSin

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Suite à la déclaration d’un dommage dans le cadre de l’Assurance Région Midi-Pyrénées, nous vous remercions de bien vouloir organiser l’enlèvement du PC de "
sMailBody +=sNomAssure + " vers RTS pour établissement d’un devis de réparation."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° incident Hotline Toshiba :  " + sNumIncident
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dossier " + sIdSin 
sMailBody += sSaut
sMailBody += sSaut


sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If

sMailBody += sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sMailBody += sSaut
sMailBody += F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "TEL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° de série : " + F_GetItem3 ( idw_WSin, 1, "NUM_IMEI_PORT" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dans cette attente,"
sMailBody += sSaut
sMailBody += "Cordialement,"
sMailBody += sSaut
sMailBody += "Pour SPB"

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_eco_mail_refus ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_ECO_Mail_Refus  (PRIVATE)
//* Auteur        : FPI
//* Date          : 18/07/2011
//* Libellé       : Gestion Particulière pour ECONOCOM CG 60
//* Commentaires  :	[PC469]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 			FPI		27/12/2011	[PC469-1.NDCV2] Modif de l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet
String  sIdSin, sFic,  sNumIncident
String    sVal,   sMailDest, sNomAssure
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv, sGti
Blob    bMailBody
Long 	 lRow, iIdAppli, lDeb, lFin, lRowAssure
DataWindowChild dwchild
n_cst_string lnvPFCString

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 166 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_REFUS", ";")

sTypMail = "SAMREF"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

If idw_wsin.getItemNumber(1,"COD_ETAT") <>  200  Then Return TRUE


// N° d'incident
sNumIncident=""
lRow=idw_wdivsin.Find("Upper(NOM_ZONE) = 'NUM_HOT_LINE'",1,idw_wdivsin.RowCount())
If lRow > 0 Then sNumIncident=idw_wdivsin.GetItemString(lRow,"VAL_CAR")
If IsNull ( sNumIncident ) Then sNumIncident = ""

If IsNull ( sMailDest ) Then sMailDest = ""

// Assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )

lRowAssure=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())

// Gti
If idw_lstgti.Find("ID_GTI=10",1,idw_lstgti.RowCount()) > 0 Then
	sGti="vol"
Else
	sGti="dommage"
End if

//sMailObjet = "[Case#" + sNumIncident + "] Refus sinistre n° " + sIdSin
sMailObjet = "Refus sinistre n° " + sIdSin // [PC469-1.NDCV2]

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Suite à la déclaration d'un " + sGti + " dans le cadre de l'Assurance Région Midi-Pyrénées, nous vous informons du refus de prise en charge."
sMailBody += sSaut
sMailBody += sSaut
sMailBody +="Un courrier a été adressé au client."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° incident Hotline Toshiba :  " + sNumIncident
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dossier : " + sIdSin 
sMailBody += sSaut
sMailBody += sSaut


sMailBody += sNomAssure
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_1" )) 


sVal = Upper ( F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_2"  )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sMailBody += sSaut
sMailBody += F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_CP" ) + " " + Upper ( F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Tél. : " + F_GetItem3 ( idw_lstinter, lRowAssure, "NUM_TELD" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° de série : " + F_GetItem3 ( idw_WSin, 1, "NUM_IMEI_PORT" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dans cette attente,"
sMailBody += sSaut
sMailBody += "Cordialement,"
sMailBody += sSaut
sMailBody += "Pour SPB"

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_controlergestion_bge ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_BGE (PRIVATE)
//* Auteur			: JFF
//* Date				: 27/10/2009
//* Libellé			: 
//* Commentaires	: [FNAC_PROD_ECH_TECH].[BGE].[20091027112156767]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bRet (False si blocage)
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    17/11/2009  [FNAC_PROD_ECH_TECH].[BGE].[20091117114047107]
//*       JFF    11/01/2011  [DECIMAL_PAPILLON]
//*       JFF    07/06/2011  [PC545].[BGE_INCOMPLET]
//        JFF    15/07/2011  [PC501][EVOLPC]
//		    FPI	  11/08/2011  [ITSM77186] Erreur de message non trouvé
//        JFF    28/08/2012  [PM103_MANTIS4454]
//*-----------------------------------------------------------------

Long lDeb, lFin, lRowAss, lRowBGE, lTotCmde, lCptCmde, lIdSin, lIdSeq, lIdLot, lIdRev, lRow, lCptDp, lVal
Boolean bRet, bAppIncomplet, bPrestaRepBaseMan 
String sIdfourBge, sIdTypArtBge, sIdCourBge, sIdCour, sCodEtat, sCas, sCodEtatBase, sIdCourBGEIncomplet, sIdCourLesDeux
n_cst_string lnvPFCString
Decimal {2} dcIdsin


bRet = False
lIdRev = idw_WSin.GetItemNumber ( 1, "ID_REV" )

// Présence option pilotage contrôle
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 126 )
If lDeb <= 0 Then Return True

// [PC501][EVOLPC]
lRow = 0
For lCptDp = lDeb To lFin
	lVal = idw_DetPro.GetItemNumber ( lCptDp, "VAL_NUM" )
	If ( lVal = -1 And lRow = 0 ) Or ( lIdRev >= lVal and lVal <> -1 ) Then 
		lRow = lCptDp
	End If
Next 
lDeb = lRow
// :[PC501][EVOLPC]

sIdfourBge = Upper ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_FOUR_BGE", ";"))
sIdTypArtBge = Upper ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_TYP_ART_BGE", ";"))
sIdCourBge = Upper ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_BGE", ";"))
sIdCourBGEIncomplet = Upper ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_BGE_INCOMPLET", ";"))
sIdCourLesDeux = sIdCourBge + "/" + sIdCourBGEIncomplet 

//[PC545].[BGE_INCOMPLET]
bAppIncomplet = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () ) > 0

// Présence flux BGE ?
lRowBGE = idw_LstwCommande.Find ( "ID_FOUR = '" + sIdfourBge + "' AND ID_TYP_ART = '" + sIdTypArtBge + "' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.Rowcount () )

// [PM103_MANTIS4454]
bPrestaRepBaseMan = FALSE
If lRowBGE > 0 Then
	bPrestaRepBaseMan = lnvPFCString.of_getkeyvalue ( idw_LstwCommande.GetItemString ( lRowBGE, "INFO_SPB_FRN_CPLT" ), "PRESTA_REPRISE_BASE_MANUELLE", ";") = "OUI" 
End If

lRowAss = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.Rowcount () )
If lRowAss <= 0 Then Return False

// Courrier en cours pour l'assuré	
sIdCour = idw_LstInter.GetItemString ( lRowAss , "ID_COUR" )
If IsNull ( sIdCour ) Then sIdCour = ""

// Le courrier en cours est-il un BGE ? avec présence BGE Flux ?
bRet = ( Pos ( sIdCourLesDeux, sIdCour, 1 ) > 0 And lRowBGE > 0 ) Or &
		 ( Pos ( sIdCourLesDeux, sIdCour, 1 ) <= 0 And lRowBGE <= 0 )

stMessage.berreurg=FALSE // [ITSM77186]

// Ce n'est pas un BGE
If Not bRet Then
	// Présence courrier et absence Flux
	If ( Pos ( sIdCourLesDeux, sIdCour, 1 ) > 0 And lRowBGE <= 0 ) Then
		stMessage.sCode		= "WSIN684"	
		stMessage.sVar [1]	= sIdfourBge
		
	// Présence Flux et absence courrier
	ElseIf ( Pos ( sIdCourLesDeux, sIdCour, 1 ) <= 0 And lRowBGE > 0 ) Then
		stMessage.sCode		= "WSIN685"		
		stMessage.sVar [1]	= sIdfourBge
		stMessage.sVar [2]	= sIdCourLesDeux 
	End If
	
	stMessage.sTitre		= "Cohérence Bon d'échange"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= False
	
End If	

// [PC545].[BGE_INCOMPLET]
If bRet and lRowBGE > 0 Then
	If bAppIncomplet Then
		If Pos ( sIdCourBGEIncomplet, sIdCour, 1 ) <= 0 Then
			bRet = False
			stMessage.sCode		= "WSIN702"		
			stMessage.sVar [1]	= sIdCourBGEIncomplet
		End If
	Else
		If Pos ( sIdCourBGE, sIdCour, 1 ) <= 0 Then
			bRet = False
			stMessage.sCode		= "WSIN703"		
			stMessage.sVar [1]	= sIdCourBGE
		End If
	End If
End If
// [PC545].[BGE_INCOMPLET]

// Edition obligatoire
If bRet and Pos ( sIdCourLesDeux, sIdCour, 1 ) > 0 And lRowBGE > 0 Then

	bRet = idw_wSin.GetItemString ( 1, "ALT_EDIT" ) = "O" 

	// [PM103_MANTIS4454]
	If bPrestaRepBaseMan Then
		idw_wSin.SetItem ( 1, "ALT_EDIT", "N" )
		stMessage.sCode		= "WSIN730"
		F_Message ( stMessage )
		bRet = TRUE
	Else
		If Not bRet Then
			stMessage.sCode		= "WSIN686"
			idw_wSin.SetItem ( 1, "ALT_EDIT", "O" )
		End If
	End If
	
End If

// #1 [FNAC_PROD_ECH_TECH].[BGE].[20091117114047107]
If bRet And idw_wDetail.Find ( "COD_ETAT = 500 AND ID_I_REG = 0 AND ALT_REG <> 'O'", 1, idw_wDetail.RowCount () ) > 0 Then
	If bRet then
		If idw_LstwCommande.Find ( "ID_FOUR = 'FNC' AND COD_ETAT = 'RPC' AND NOT ISNULL ( DTE_ENV_CLI )", 1, idw_LstwCommande.RowCount() ) > 0 Then
			stMessage.sCode		= "WSIN687"
			bRet = False
		End If
	End If
	
	If bRet then
		If idw_LstwCommande.Find ( "ID_FOUR = 'FNC' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() ) > 0 Then
			stMessage.sCode		= "WSIN688"
			bRet = False
		End If
	End If
	
	If bRet then
		If idw_LstwCommande.Find ( "ID_FOUR = 'FNC' AND COD_ETAT = 'ECT'", 1, idw_LstwCommande.RowCount() ) > 0 Then
			stMessage.sCode		= "WSIN689"
			bRet = False
		End If
	End If
	
	If bRet then
		idw_LstwCommande.SetFilter ( "ID_FOUR = 'FNC' AND COD_ETAT = 'ANN'" )
		idw_LstwCommande.Filter ()
	
		lTotcmde = idw_LstwCommande.Rowcount ()
		
		For lCptCmde = 1 To lTotcmde 
			
			sCodEtat = idw_LstwCommande.GetItemString ( lCptCmde, "COD_ETAT" )
			lIdSin = idw_LstwCommande.GetItemNumber (  lCptCmde, "ID_SIN" ) 
			lIdSeq = idw_LstwCommande.GetItemNumber (  lCptCmde, "ID_SEQ" ) 

			// [DECIMAL_PAPILLON]
			dcIdsin = dec (lIdSin)
			SELECT 'ID_LOT=' + Convert ( Varchar ( 10 ), c.id_lot_cmd ) + ';COD_ETAT=' + c.cod_etat
			INTO 	 :sCas
			FROM   sysadm.commande c
			WHERE  c.id_sin = :dcIdsin
			AND    c.id_seq = :lIdSeq
			USING  SQLCA ;

			lIdLot = Long ( lnvPFCString.of_getkeyvalue (sCas, "ID_LOT", ";"))
			sCodEtatBase = lnvPFCString.of_getkeyvalue (sCas, "COD_ETAT", ";")
		
			If ( lIdLot = 0 And sCodEtatBase = 'ANN' ) Or ( sCodEtat = 'ANN' And sCodEtatBase <> 'ANN' ) Then
				bRet = False
				stMessage.sCode		= "WSIN690"
				Exit
			End If
		Next
	
		idw_LstwCommande.SetFilter ( "" )
		idw_LstwCommande.Filter ()
	
	End If
End If
// :#1 [FNAC_PROD_ECH_TECH].[BGE].[20091117114047107]

Return bRet
end function

private function boolean uf_validation_finale_mbs_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MBS_Mail  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 02/09/2011
//* Libellé       : MAIL pour Mobistore.
//* Commentaires  :  [PC10][DIAG_NOMADE]
//*
//* Arguments     :
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*		FPI		18/12/2012	[PC10-2]
//			FPI		11/08/2014	[PC13442]
// 			FPI		20/11/2014	[PC13442.V6]
//			FPI		08/09/2015	[PC13442-2]
//       JFF   28/06/2016 [PC151549]
//*-----------------------------------------------------------------
Boolean bRet, bTel, bCAF, bAEF, bNomade, bO2M, bDevis, bCVC, bATC, bRepa
Boolean bechExpress, bBSTHorsCAF, bBSTCAF
String  sCasGestion, sFiltreOrig, sFiltre
Long lRow, lTotCmd, lNbrMail, lDeb, lFin
Long lIdGti

bechExpress=FALSE // [PC13442]

If this.uf_GetAutorisation2(208) Then Return TRUE

lNbrMail = 0

// [PC13442]
lRow=idw_wdivsin.Find("NOM_ZONE='ech_express_48h'", 1, idw_wdivsin.RowCount())
If lRow > 0 Then
	bechExpress=( idw_wdivsin.GetItemString(lRow, "VAL_CAR") = "O" )
End if
// :[PC13442]

sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

sFiltre = "ID_TYP_ART IN ('TEL') AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bTel = True
	lIdGti= idw_LstwCommande.GetItemNumber(1, "ID_GTI") // [PC13442]
	lNbrMail ++
End If

sFiltre = "ID_TYP_ART IN ('CAF') AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bCAF = True
	lIdGti= idw_LstwCommande.GetItemNumber(1, "ID_GTI") // [PC13442]
	lNbrMail ++
End If

sFiltre = "ID_TYP_ART = 'AEF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bAEF = True
	lNbrMail ++
End If

sFiltre = "ID_TYP_ART = 'DEV' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bDevis = True
	lNbrMail ++
End If

sFiltre = "ID_TYP_ART NOT IN ( 'TEL', 'CAF', 'AEF', 'DEV' ) AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bNomade = True
	lIdGti= idw_LstwCommande.GetItemNumber(1, "ID_GTI") // [PC13442]
	lNbrMail ++
End If

sFiltre = "ID_TYP_ART = 'EDI' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'O2M'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

bO2M = lTotCmd > 0 

// [PC10-2]
sFiltre = "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'CVC'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

bCVC = lTotCmd > 0 
// :[PC10-2]

// [PC13442-2]
sFiltre = "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'ATC'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

bATC = lTotCmd > 0 
// :[PC13442-2]

// [PC151549]
sFiltre = "ID_TYP_ART <> 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'BST'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bBSTHorsCAF = True
	lIdGti= idw_LstwCommande.GetItemNumber(1, "ID_GTI") // [PC13442]
	lNbrMail ++
End If

sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'BST'" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bBSTCAF = True
	lIdGti= idw_LstwCommande.GetItemNumber(1, "ID_GTI") // [PC13442]
	lNbrMail ++
End If

sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN ( 'O2M', 'PSM' )" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()
lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	bRepa = True
End If
// [PC151549]

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

If lNbrMail > 1 Then
	bRet = False
	
	stMessage.sTitre		= "Incohérence (plusieurs mails)"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= Ok!
	stMessage.sCode		= "WSIN706"

	F_Message ( stMessage ) 
	
	Return bRet 
	
End IF

// [PC13442]
if bechExpress Then

	// [PC151549]
	If bTel or bCaf or bNomade or bAEF or bBSTCAF Or bBSTHorsCAF Then
		bRet = This.uf_validation_finale_mbs_ech_express( lIdGti )
		Return bRet
	End if

	// [PC151549]
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 302 )
	
	// [PC13442.V6]
	// [PC151549]
	If bO2M And lDeb <= 0 Then
		bRet = This.uf_validation_finale_mbs_ech_express_o2m()
		Return bRet
	End if
End if
// :[PC13442]

Choose Case TRUE
	// [PC151549]
	Case bTel, bBSTHorsCAF
		bRet = This.uf_validation_finale_mbs_mail_tel1_pm191( )

	// [PC151549]
	Case bCAF, bBSTCAF
		bRet = This.uf_validation_finale_mbs_mail_tel2_pm191( )
		
	Case bAEF
			bRet = This.uf_validation_finale_mbs_mail_diag_pm191( )
	Case bNomade 
			bRet = This.uf_validation_finale_mbs_mail_nomade_191( ) 
	Case bDevis
		bRet = This.uf_validation_finale_mbs_mail_devis_pm19( ) 
	Case bO2M, bCVC, bATC, bRepa
		// Rien, c'est normal
		bRet = True

	Case Else
		
		stMessage.sTitre		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= YesNo!
		stMessage.sVar[1]		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
		stMessage.sVar[2]		= "MOBISTORE"
		stMessage.sCode		= "COMD301"
	
		If F_Message ( stMessage ) = 2 Then
			Return FALSE
		Else 
			Return TRUE
		End If

End Choose

Return bRet

end function

private function boolean uf_validation_finale_lde_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_LDE_Mail  (PRIVATE)
//* Auteur        : FPI
//* Date          : 13/09/2011
//* Libellé       : Gestion Particulière pour Lyonnaise des Eaux
//* Commentaires  : [PC19]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
Long 	  lRowInterReg, lDeb, lFin
Integer lTypMail, iidAppli
Decimal dcIdsin
String scasretour
Long lRet

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 185 )
If lDeb <= 0 Then Return True

lTypMail=0
dcIdsin= idw_WSin.GetItemDecimal( 1, "ID_SIN" )

// Mail de refus
If idw_WSin.GetItemNumber(1,"COD_ETAT") = 200 Then
	lTypMail=1
End if

// Mail de PEC ?
if lTypMail=0 Then
	If idw_WSin.GetItemNumber(1,"COD_ETAT") = 100 And &
		idw_WSin.GetItemNumber(1,"CPT_VALIDE")=0 Then lTypMail=2
End if

// Mail de règlement
if lTypMail=0 Then
	lRowInterReg=idw_lstinter.find("COD_INTER='T' AND MT_A_REG > 0",1,idw_lstinter.RowCount())
	if lRowInterReg > 0 Then lTypMail=3
End if

if lTypMail=0 Then Return TRUE

lRet = SQLCA.PS_S12_MAILPUSH_LDE( dcidsin, lTypMail, scasretour) 

bRet=(lRet= 0)

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private subroutine uf_gestion_dtefingti_dp29 (string asduree, string asunite, string asdureeminmaj, string asuniteminmaj, boolean abecraser);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Gestion_DteFinGti_DP29 (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 10/01/2005 17:40:17
//* Libellé       : Gestion particulière de la date de fin de garantie
//* Commentaires  : DCMP L. Fouquier DCMP 050018 : Calcul automatique d'une date de fin de GTI
//*					  pour les produits 1 an ou 2 an définit dans DET_PRO comme tel.
//*
//* Arguments     : String 	asDuree		Val
//*					  String    asUnite	   Val
//*					  String 	asDureeMinMaj		Val
//*					  String 	asUniteMinMaj		Val
//* Retourne      : Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JFF	20/10/2008	[FNAC_PROD_ECH_TECH]
//*      JFF   21/06/2011  [PC545].[POINT][9]
//*      FPI   19/10/2011  [VDoc5713] Ajout de l'écrasement de la date de gti
//*      JFF   05/02/2012  [PC820-1] nlle règle (voir plus)
// 		FPI	12/03/2018	 [PI056] - DTE_FIN_GTI en datetime
//*-----------------------------------------------------------------
Boolean	bForcage
Date	   dDteAdh, dDteFinGti, dDteResil
Long lDeb, lFin

dDteAdh = idw_Wsin.GetItemDate ( 1, "DTE_ADH" )


// [PC820-1] nlle règle de contradiction
// Si dte_Resil présente alors Si dte_fin_gti présente, on la laisse Si non, dte_fin_gti = dte_resil
dDteFinGti = Date(idw_Wsin.GetItemDateTime ( 1, "DTE_FIN_GTI" )) // [PI056] - DTE_FIN_GTI en datetime
dDteResil = idw_Wsin.GetItemDate ( 1, "DTE_RESIL" )

// Si date de résil renseigné
// PC820-1_MODIF_DP29
If Not IsNull ( dDteResil ) Then
	// Alors si pas de date de fin garantie alors
	If IsNull ( dDteFinGti ) Then
		idw_Wsin.SetItem ( 1, "DTE_FIN_GTI", dDteFinGti  )
		idw_Wsin.SetItem ( 1, "DTE_FIN_GTI_PREC", dDteFinGti  )
	Else
		Return
	End If
End If

/*------------------------------------------------------------------*/
/* Date d'adhésion nulle => Dans tous les cas on ne pourra rien     */
/* calculé.                                                         */
/*------------------------------------------------------------------*/
If IsNull ( dDteAdh ) Then Return

/*------------------------------------------------------------------*/
/* Si la date de fin de garantie est déjà renseignée, on ne la      */
/* retouche pas, exceptée si elle est égale à la date d'adhésion    */
/* dans ce cas, on la recalcule.                                    */
/*------------------------------------------------------------------*/
If Not IsNull ( dDteFinGti ) Then 

/*------------------------------------------------------------------*/
/* La date de fin de gti n'est pas nulle et est différente de la    */
/* date d'adhésion donc on la laisse.                               */
/*------------------------------------------------------------------*/
	If dDteFinGti <> dDteAdh And Not abEcraser Then // [VDoc5713] Ajout de "Not bEcraser"
		Return		
	End If
End If

SetNull ( dDteFinGti )

//* #1 [FNAC_PROD_ECH_TECH]
dDteFinGti = F_Plus_Date ( dDteAdh, Long ( asDuree ), Upper ( asUnite ) )

// [PC545].[POINT][9]
If Not IsNull ( asDureeMinMaj ) And Len ( asDureeMinMaj ) > 0 And IsNumber ( asDureeMinMaj ) Then
	dDteFinGti = F_Plus_Date ( dDteFinGti, Long ( asDureeMinMaj ), Upper ( asUniteMinMaj ) )
End If
// :[PC545].[POINT][9]

If Not IsNull ( dDteFinGti ) Then
	idw_Wsin.SetItem ( 1, "DTE_FIN_GTI", Datetime(dDteFinGti)  ) // [PI056] - DTE_FIN_GTI en datetime
	idw_Wsin.SetItem ( 1, "DTE_FIN_GTI_PREC", Datetime(dDteFinGti) ) // [PI056] - DTE_FIN_GTI en datetime
End If


end subroutine

private subroutine uf_validation_finale (ref s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Validation_Finale (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 05/11/1998 11:12:36
//* Libellé			: 
//* Commentaires	: 
//*
//* Arguments		: s_Pass			astPass			(Réf) Structure de passage
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ PAR		Date		Modification
//* #1  CAG 10/02/2003  DCMP 020450 : Ajout des boîtes archives
//* #2  JFF	12/11/2003  Gestion particuliere 
//* #3  JFF 20/09/2005  DCMP 050499 M. Legac : J'ai besoin de retourner un code stoppant la validation si les stocks a-novo
//* 							ne permettent plus de validation la commande.
//* #4  JFF 05/07/2006  Je shunte le remise à '' du noboite si null
//* #5  JFF 14/03/2008  [HVALS2] Autorisation de valider en fct d'un créneau horaire.
//* #6  FPI 09/09/2008  [DCMP80334] Double validation des montants
//*     JFF 23/03/2011  [ITSM63255] Correctif erreur sql 2627 Pk PrimaryKey
//*     JFF 21/10/2011  [ITSM85146]
//      JFF 23/05/2012  [PM103][1]
//      JFF 18/09/2012  [ITSM129947]
// 		FPI	11/10/2013	[VDOC12394]
//      JFF 19/11/2014 [VDOC15650]
//      JFF 26/11/2014 [CORRECTIF_VALIDATION]
// 	  JFF 30/12/2014 [ITSM_260394]
//      JFF 11/03/2019 [DT339]
//      JFF 22/10/2019 [PI087_PM473_2]
//      JFF 03/11/2023 [RS6114_MAIL_CMA]
//      JFF 07/03/2024 [HP252_276_HUB_PRESTA]
//      JFF 22/02/2025 [TRT_APRES_COMMIT][PMO268_MIG48]
//*------------------------------------------------------------------

//*------------------------------------------------------------------
// [PM251-2]
// !!!!!!! ATTENTION !!!!!!!!!
// En cas de modification de cette fonction, PENSER à modifier aussi w_sp_trt_autofact::wf_pm251_2_validation_auto
//*------------------------------------------------------------------

Long dcIdSin, lDeb, lFin, lRetValidation, lErrSql2627, lCpt, lSqlCode, lSqlDbCode, lRet, dcIdInter, dcIdDoc
String sProc, sCodOper, sFicEssai, sSql, sNoBoite, sMethode, sCasRetour
DateTime	dtValideLe
Boolean bRet, b2Tour, bRet2, bRetHubPresta, bMesHubPresta
// #6
Decimal dcIdProd 
String sRet
n_cst_se_double_val nvDoubleVal
int iRet
s_Message stMessageHub

bMesHubPresta = FALSE

// [ITSM63255]
For lCpt = 1 To 2

	dcIdSin		= idw_wSin.GetItemNumber ( 1, "ID_SIN" )
	sCodOper 	= stGLB.sCodOper
	sFicEssai	= astPass.sTab[1]
	sProc			= Space ( 60 )
	dtValideLe	= DateTime ( Today (), Now () )
	bRet			= True
	lErrSql2627 = 0
	b2Tour 		= False
	SetNull ( dcIdInter )
	SetNull ( dcIdDoc )
	
	If ibSaisieValidation Then
		sMethode = "SVE"
	Else
		sMethode = ""
	End If
	
	// #6
	If Not ( ( stGlb.sCodOper = "JFF" Or stGlb.sCodOper = "FPI" ) And F_CLE_A_TRUE ( "SHUNT_DBLE_VALID" ) ) Then
		dcIdProd = idw_wSin.GetItemDecimal ( 1, "ID_PROD")
		
		nvDoubleVal=CREATE n_cst_se_double_val
	
		iRet=nvDoubleVal.uf_DoubleValidationOK(stGLB.sCodOper, dcIdSin, dcIdProd, &
							stglb.sfichierini, itrTrans, sRet)
	
		stmessage.svar[1] = sRet
	
		If iRet <> nvdoubleval.K_OK Then 
			stMessage.sTitre		= "Validation Finale d'un dossier"
			stMessage.Icon			= StopSign!
			stMessage.bErreurG	= True
	
			Choose case iRet
			Case nvdoubleval.K_ERR_INITALISATION
				stMessage.sCode="DVAL001" 
			Case nvdoubleval.K_ANNULE
				stMessage.sCode="DVAL002"
			Case nvdoubleval.K_ERR_NIVEAU_REQUIS
				stMessage.sCode="DVAL003"
			Case nvdoubleval.K_ERR_SAISIE
				stMessage.sCode="DVAL004"
			Case nvdoubleval.K_ERR_DROIT_INSUFFISANT
				stMessage.sCode="DVAL005"
			Case nvdoubleval.K_ERR_OPER_INCONNU
				stMessage.sCode="DVAL008"
				stmessage.svar[1] = "Opérateur inexistant"
			Case nvdoubleval.K_ERR_LIRE_UO
				stMessage.sVar[1] = string(dcIdProd)
				stMessage.sCode="DVAL006"
			Case nvdoubleval.K_OK
				stMessage.sCode="DVAL007"
			Case nvdoubleval.K_ERR_LIRE_MONTANT
				stMessage.sCode="DVAL009"
			Case nvdoubleval.K_ERR_HISTO
				stMessage.sCode="DVAL010"
			Case Else
				stMessage.sCode="DVAL008"
			end choose
		
			f_commit(itrTrans,False)
			f_message(stMessage)
			bRet=FALSE
		End if
		
		DESTROY nvDoubleVal
	End if
	// Fin #6
	
	//#5
	If bRet Then
		bRet = This.uf_Validation_Finale_Horaire ()
	End If
	// :#5
	
	/*------------------------------------------------------------------*/
	/* Le 04/06/1999.                                                   */
	/* Modif DGA: On vérifie si l'on peut ecrire dans le répertoire de  */
	/* TRACE. Si ce n'est pas le cas, on arrete tout.                   */
	/*------------------------------------------------------------------*/
	If bRet Then 
		If	F_Verifier_Ecriture_Trace ( sFicEssai ) < 0	Then
		/*------------------------------------------------------------------*/
		/* On affiche un message d'erreur que l'on ne peut tracer. On sort  */
		/* ensuite immédiatement de la fonction.                            */
		/*------------------------------------------------------------------*/
			stMessage.sTitre		= "Validation Finale d'un dossier"
			stMessage.Icon			= StopSign!
			stMessage.bErreurG	= TRUE
			stMessage.sCode		= "APPLI09"
			stMessage.bTrace  	= False
		
			F_Message ( stMessage )
			bRet = False
		
		End If
	End If
	
	/*------------------------------------------------------------------*/
	/* DGA. Le 21/08/2003.                                              */
	/* Gestion des boites archives.                                     */
	/*------------------------------------------------------------------*/
	If bRet Then
		If	idw_BoiteArchive.RowCount () = 1	Then
			If	idw_BoiteArchive.GetItemNumber ( 1, "ID_TYP_ARCH" ) = 2	Then 
				sNoBoite = "CENTRALISE"
			Else
				sNoBoite = idw_BoiteArchive.GetItemString ( 1, "NO_BOITE" )
			End If
		End If
	
		// #4
		//	If	IsNull ( sNoBoite ) Then sNoBoite = ''
		If Trim ( sNoBoite ) = "" Then SetNull ( sNoBoite ) // #4
	
		// #3
		lRetValidation = itrTrans.PS_VALIDATION	(	dcIdSin,				&
											sCodOper,			&
											sNoBoite,			&
											sProc,				&
											dtValideLe,			&
											sMethode 			&
										)

		lSqlDbCode = itrTrans.SqlDbCode
		
		// [ITSM_260394]
		If lSqlDbCode <> 0 Then
			lRetValidation = lSqlDbCode 
		End If
		
		// [CORRECTIF_VALIDATION]
		If lRetValidation < 0 Then bRet = FALSE
	
	/*------------------------------------------------------------------*/
	/* La zone sProc est passée par référence. Elle est armée à ''      */
	/* dans la procédure. Si une erreur survient, on arme cette chaîne  */
	/* pour expliquer ou est survenue l'erreur.                         */
	/*------------------------------------------------------------------*/
		sProc = Trim ( sProc )
		If	sProc <> "" Then bRet = False
	
	/*------------------------------------------------------------------*/
	/* Si SqlDbCode est armé, on part du principe qu'il y a eu une      */
	/* erreur, et ce quel que soit la valeur de sProc.                  */
	/*------------------------------------------------------------------*/
		If itrTrans.SqlCode <> 0 Or itrTrans.SqlDbCode <> 0	Then bRet = False
	
	/*------------------------------------------------------------------*/
	/* #2 : Gestion particuliere 				                             */
	/* A executer juste apres la PS de val et avant le COMMIT			  */
	/*------------------------------------------------------------------*/
		If bRet Then
			bRet = This.uf_Validation_Finale_Trt_Particuliers ()
		End If
	
	/*------------------------------------------------------------------*/
	/* Delete des zones temporaires sur w_div_sin et div_sin            */
	/*------------------------------------------------------------------*/
		If bRet Then
			F_Execute ( "Exec sysadm.PS_D01_W_DIV_SIN " + String ( dcIdSin ) + "., 'zn_tmp_cas_gestion'", SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDbCode = 0
		End If
		
		If bRet Then
			// [PM103][1]
			F_Execute ( "Exec sysadm.PS_D01_W_DIV_SIN " + String ( dcIdSin ) + "., 'zn_tmp_PM103_1'", SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDbCode = 0
			// :[PM103][1]
		End If
		
		If bRet Then		
			// [VDOC12394]
			F_Execute ( "Exec sysadm.PS_D01_W_DIV_SIN " + String ( dcIdSin ) + "., 'ctl_sepa'", SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDbCode = 0
			// :[VDOC12394]
		End If

		// [VDOC12394]
		If bRet Then
			F_Execute ( "Exec sysadm.PS_I_DIV_SIN_ETAT_ASS " + String ( dcIdSin ) + "., '" + Trim ( sCodOper ) + "'", SQLCA )
			bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDbCode = 0
		End If 
		// [VDOC12394]
	
	/*------------------------------------------------------------------*/
	/* On s'occupe maintenant du COMMIT, ou du ROLLBACK.                */
	/*------------------------------------------------------------------*/
		If	bRet	Then
	
	/*------------------------------------------------------------------*/
	/* On récupére la variable dtValideLe passée en OUTPUT. On          */
	/* positionne cette variable dans W_SIN.MAJ_LE. Elle sera           */
	/* récupérée dans le script Ue_MajAccueil de la fenêtre de          */
	/* SINISTRE. Nous aurons ainsi la même valeur dans le fichier de    */
	/* TRACE et dans les tables.                                        */
	/*------------------------------------------------------------------*/
			F_Commit ( itrTrans, True )
			idw_wSin.SetItem ( 1, "MAJ_LE", dtValideLe )


			// [HP252_276_HUB_PRESTA]
			If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
				If IsValid ( itrHubPrestataire ) Then
					F_Commit_Hub_Prestataire ( itrHubPrestataire, True )
					This.uf_GestionTransSqlHubPresta	( "DECONNEXION_HUB" )	
				End If 
			End If
		
		
			// [TRT_APRES_COMMIT] 
			// Traitement spécial très particulier après commit style, appeller une API par exemple
			// Règle : La validation du dossier est acté, réussi, ce traitement, doit gérer seul en aval
			//         ses trt sql s'il y en a sur Commit ou Rollback
			If F_CLE_A_TRUE ( "TRT_APRES_COMMIT" ) Then
					iUoGsSpSinistre2.uf_validation_finale_trt_partaprescommit () 
			End If 
		
		Else
	/*------------------------------------------------------------------*/
	/* On charge les valeurs de la structure Message avec les valeurs   */
	/* de itrTrans, avant de faire un ROLLBACK.                         */
	/*------------------------------------------------------------------*/
			//#3
			Choose Case lRetValidation 
				Case -1000 
					stMessage.sTitre		= "Validation Finale d'un dossier"
					stMessage.Icon			= Exclamation!
					stMessage.bErreurG	= False
					stMessage.sCode		= "WSIN490"
					stMessage.bTrace  	= False

					// [HP252_276_HUB_PRESTA]
					If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
						If IsValid ( itrHubPrestataire ) Then
							F_Commit_Hub_Prestataire ( itrHubPrestataire, False )
							This.uf_GestionTransSqlHubPresta	( "DECONNEXION_HUB" )	
						End If 
					End If					
					
					// [VDOC4288]
					F_Commit ( itrTrans, False )
					F_Message ( stMessage )					

				// [VDOC5021]
				Case -1001 
					stMessage.sTitre		= "Validation Finale d'un dossier"
					stMessage.Icon			= Exclamation!
					stMessage.bErreurG	= False
					stMessage.sCode		= "WSIN491"
					stMessage.bTrace  	= False

					// [HP252_276_HUB_PRESTA]
					If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
						If IsValid ( itrHubPrestataire ) Then
							F_Commit_Hub_Prestataire ( itrHubPrestataire, False )
							This.uf_GestionTransSqlHubPresta	( "DECONNEXION_HUB" )	
						End If 
					End If					
					
					F_Commit ( itrTrans, False )
					
					F_Execute ( "Exec sysadm.PS_U_REDRESSEMENT_CMDE_ANNUL " + String ( dcIdSin ) + ".", itrTrans )				
					F_Commit ( itrTrans, True)
					
					F_Message ( stMessage )					
	
				// [ITSM85146] IM_CUR_ARCHIVE_VAL_SVE / PS_I03_ARCHIVE_BLOB_VAL
				Case -1002
					If lCpt = 1 Then
						b2Tour = True

						// [HP252_276_HUB_PRESTA]
						If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
							If IsValid ( itrHubPrestataire ) Then
								F_Commit_Hub_Prestataire ( itrHubPrestataire, False )
								This.uf_GestionTransSqlHubPresta	( "DECONNEXION_HUB" )	
							End If 
						End If						
						
						F_Commit ( itrTrans, False )
						F_Execute ( "Update sysadm.w_courrier Set id_canal = 'CO' where id_sin = " + String ( dcIdSin ) + ".", itrTrans )				
						F_Commit ( itrTrans, True )
					End If
	
				Case Else
	
					// [ITSM63255] Erreur PrimayKey
					If lCpt = 1 And ( lRetValidation = 2627 Or itrTrans.SqlDbCode = 2627 ) Then
						lErrSql2627 = 2627
						
						// [HP252_276_HUB_PRESTA]
						If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
							If IsValid ( itrHubPrestataire ) Then
								F_Commit_Hub_Prestataire ( itrHubPrestataire, False )
								This.uf_GestionTransSqlHubPresta	( "DECONNEXION_HUB" )	
							End If 
						End If						
						
						F_Commit ( itrTrans, False )
						F_Execute ( "Exec sysadm.PS_CORRIGE_CPT_VALIDE " + String ( dcIdSin ) + ".", itrTrans )				
						F_Commit ( itrTrans, True )

						// [ITSM129947]
						F_Commit ( itrTrans, False )
						F_Execute ( "Delete from sysadm.wkfs_w_queue where id_sin= " + String ( dcIdSin ) + ".", itrTrans )				
						F_Commit ( itrTrans, True )
						
					Else
						stMessage.sTitre		= "Validation Finale d'un dossier"
						stMessage.Icon			= StopSign!
						stMessage.bErreurG	= False
						stMessage.sVar[1] 	= sProc
						stMessage.sVar[2] 	= String ( itrTrans.SqlDbCode )
						stMessage.sVar[3] 	= itrTrans.SqlErrText
						stMessage.sCode		= "WSIN280"
						stMessage.bTrace  	= True

					
						// [HP252_276_HUB_PRESTA]
						If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
							If IsValid ( itrHubPrestataire ) Then
								bRetHubPresta = itrHubPrestataire.SqlCode = 0 And itrHubPrestataire.SqlDbCode = 0
								If NOT bRetHubPresta Then
								
									bMesHubPresta = True
									stMessageHub = stMessage
							
									stMessageHub.sTitre		= "Validation Finale d'une prestation HUB"
									stMessageHub.Icon			= StopSign!
									stMessageHub.bErreurG	= False
									stMessageHub.sVar[1] 	= "Connexion au HUB ou edi.PS_HP276_I_HP_VALIDATION_PRESTA_DANS_LE_HUB_PRESTATAIRE sur base PRESTATAIRE"
									stMessageHub.sVar[2] 	= String ( itrHubPrestataire.SqlDbCode )
									stMessageHub.sVar[3] 	= itrHubPrestataire.SqlErrText
									stMessageHub.sCode		= "WSIN280"
									stMessageHub.bTrace  	= FALSE
								
								End If 

								F_Commit_Hub_Prestataire ( itrHubPrestataire, False )
								This.uf_GestionTransSqlHubPresta	( "DECONNEXION_HUB" )	
								
							End If 
						End If						
						
						/*------------------------------------------------------------------*/
						/* On peut envoyer le ROLLBACK.                                     */
						/*------------------------------------------------------------------*/
						F_Commit ( itrTrans, False )
						/*------------------------------------------------------------------*/
						/* On peut afficher le message sans risques.                        */
						/*------------------------------------------------------------------*/
						F_Message ( stMessage )					

						// [HP252_276_HUB_PRESTA]
						If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
							If bMesHubPresta THen F_Message ( stMessageHub )					
						End If 
						
					End If
			End Choose
		End If
	End If

// [ITSM63255]
If lErrSql2627 > 0 Then b2Tour = True
If Not b2Tour Then Exit

Next

// [POSITION_SIMPA2]
idw_wSin.PostEvent ( "ue_fermerword", 1, 0 ) // #4

astPass.bRetour = bRet

// [PI087_PM473_2]
// Gestion de la trace ici. Si problème, je n'affecte pas la validation, c'est déjà commité et je ne touche pas au bRet
If bRet Then
	lRet = SQLCA.PS_I_PI087_TRACE_DOSSIER_V01 ( dcIdSin, "VALIDATION", stGLB.sCodOper, dcIdInter, dcIdDoc )
	
	bRet2 = SQLCA.SqlCode = 0 And SQLCA.SqlDbCode = 0 And lRet > 0
	
	F_Commit ( SQLCA, bRet2 ) 
	
	If Not bRet2 Then
		stMessage.sTitre		= "Validation Finale d'un dossier"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= False
		stMessage.sVar[1] 	= "PS_I_PI087_TRACE_DOSSIER"
		stMessage.sVar[2] 	= String ( SQLCA.SqlDbCode )
		stMessage.sVar[3] 	= SQLCA.SqlErrText
		stMessage.sCode		= "WSIN848"
		F_Message ( stMessage )

	End If 
End If 	

istAttenteDiverse.Hide ()

end subroutine

private function boolean uf_validation_finale_mail_pec_assure ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_mail_pec_assure  (PRIVATE)
//* Auteur        : FPI
//* Date          : 05/04/2011 
//* Libellé       : Gestion Particulière pour CAM.
//* Commentaires  : [PC434]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin
String sVal,sMailDest,sSql
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail
Blob    bMailBody
Long 	  lRow, lTotCmd, lCptCmd,    iIdAppli, lDeb, lFin, lIdDetail, lIdGti
n_cst_string lnvPFCString
Decimal dcMtPec

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 165 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
	
sTypMail = "CMDPEC"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'MAI' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'CAM' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then
	// Rajout JFF !!!
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()	
	
	Return TRUE
End If

lIdDetail=idw_LstwCommande.GetItemNumber(1,"ID_DETAIL")
lIdGti=idw_LstwCommande.GetItemNumber(1,"ID_GTI")

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// Récup de l'adr_mail
lRow=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())

If lRow > 0 Then sMailDest = idw_lstinter.GetItemString(lRow,"ADR_MAIL")
If IsNull ( sMailDest ) Then sMailDest = ""

// Récup du mt de PEC
dcMtPec=0.00
lRow=idw_wdivdet.Find("UPPER ( NOM_ZONE ) = 'MT_PEC'  AND ID_DETAIL=" + String(lIdDetail) + " AND ID_GTI=" + String(lIdGti),1,idw_wdivdet.RowCount())
If lRow > 0 Then
	dcMtPec=idw_wdivdet.GetItemDecimal(lRow,"VAL_MT")
	If isNull(dcMtPec) Then dcMtPec=0.00
End if

sMailObjet = "Camara Produits Nomades – Dossier n°  " + sIdSin + " - Bon d’échange"

sMailBody += "Nous avons le plaisir de vous informer de la prise en charge de votre dossier."
sMailBody += sSaut + sSaut
sMailBody += "Nous vous invitons à vous rendre en magasin pour retirer votre appareil de remplacement en présentant cet email."
sMailBody +=  sSaut + sSaut
sMailBody += "Nous vous rappelons que nous intervenons à hauteur de " + String(dcMtPec,"0.00") + "€, si vous souhaitez acquérir un appareil d’un montant supérieur, la différence reste à votre charge."
sMailBody +=  sSaut + sSaut
sMailBody += "Pour tout renseignement, vous pouvez nous contacter au 0 970 809 759*"
sMailBody +=  sSaut + sSaut
sMailBody += "Cordialement, "
sMailBody += sSaut + sSaut
sMailBody += "Votre gestionnaire. "
sMailBody += sSaut+ sSaut+ sSaut
sMailBody += "*Numéro facturé au prix d'une communication locale, régionale ou nationale, selon les offres de chaque opérateur"


bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

If bRet Then
	sSql = "Exec sysadm.PS_U20_COMMANDE_VAL_MAIL " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."

	F_Execute ( sSql, SQLCA )
	bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

End if
	
Return bRet
end function

private function long uf_zn_trt_divsin_recupo2m (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_RecupO2M (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 03/11/2012
//* Libellé			: Contrôle de 3 zones recup_donnee et recup_materiel
//* Commentaires	: [RECUP_DONNEE_O2M]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			FPI		14/06/2012	[PC512-2] Ajout contrôle date de decl
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin
String sValCar, sVal
n_cst_string nvString

asData = Upper ( asData )
iAction = 0

lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND ID_FOUR IN ( 'O2M' )", 1, idw_LstwCommande.RowCount () ) 

If lRow > 0 Then
	idw_wDivSin.iiErreur = 3
	iAction = 1
End If

// [PC512-2]
If iAction = 0 Then
	f_rechdetpro (lDeb, lFin,idw_detpro, idw_wsin.GetItemNumber( 1, "ID_PROD"), "-DP", 205)
	If lDeb > 0 Then
		sValCar=idw_detpro.GetItemString(lDeb, "VAL_CAR")
		sVal=nvString.of_getkeyvalue( sValCar , "CONDITION_DTE_DECL", ";")
		
		if sVal <> "" Then
			if idw_wsin.GetItemDate(1, "DTE_DECL") < Date(sVal) Then
				idw_wDivSin.iiErreur = 5
				stMessage.svar[1]=sVal
				iAction = 1
			End if
		End if
		
	End if
End if
// :[PC512-2]

Return iAction

end function

private function long uf_zn_natsin ();//*-----------------------------------------------------------------
//*
//* Fonction		: uf_zn_natsin (PRIVATE)
//* Auteur			: FPI
//* Date				: 23/01/2012
//* Libellé			: [PC494]
//* Commentaires	: Contrôle de ID_NAT_SIN
//*
//* Arguments		: Aucun
//*
//* Retourne		: long
//*
//* JFF		15/05/2012		[ITSM115501]
//*-----------------------------------------------------------------

Long lDeb, lVal1, lVal2
Long lIdNatSin
Integer iAction

iAction = 0

lIdNatSin	= Long ( idw_wSin.GetText () )

// Ne concerne que la nature 24 - NON LIVRAISON
// If lIdNatSin<>  24 Then Return iAction 

lDeb=idw_wdivsin.Find("Upper(NOM_ZONE) = 'DTE_RELANCE_ASS_COMM'",1,idw_wdivsin.rowcount( ) )
If lDeb > 0 And lIdNatSin = 24 Then
	stMessage.bErreurg=FALSE
	stMessage.Icon=Information!
	stMessage.scode="WSIN721"
	stMessage.stitre="Gestion des sinistres - SIMPA2"
	f_message(stMessage)
End if

// [ITSM115501]
If iAction = 0 Then
	lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
	
	lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	If  lVal1 > 0 Or lVal2 > 0 Then
		iAction = 1
		idw_wSin.iiErreur = 1
	End If 
End If
// [ITSM115501]

Return iAction


end function

private subroutine uf_determiner_courrier_forcage_psm (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_PSM (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 24/02/2011
//* Libellé       : [PM200][PSM]
//* Commentaires  : 
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF     15/03/2012 [PM200][PSM][MANTIS2927]
//*       JFF     13/03/2013 [PC836_MANTIS6721]
//        JFF     07/05/2013 [PC938_ORANGE_V3]
//        JFF     03/10/2013 [VDOC10920]
//			 JFF     17/06/2014 [DT87][MANTIS11451]
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech
Long   				lDeb, lFin, lTotCourrier, lLig, lCpt
string				sTypApp, sAdrMail, sCodeBoutiqueProximite 
Boolean				bCondition			
String 				sIdCourForce

sAdrMail = idw_LstInter.GetItemString ( alCpt, "ADR_MAIL" ) 
If IsNull ( sAdrMail ) Then sAdrMail = ""

If asPos <> "" Then Return

// [PC938_ORANGE_V3][MANTIS7779]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
If lDeb > 0 Then
	Return	
End If

If idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) <> "A" Then Return

// [PM200][PSM][MANTIS2927]
// [DT87][MANTIS11451]
lDeb = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR = 'PSM' AND ID_TYP_ART = 'PRS' AND INFO_SPB_FRN NOT IN ( 2116 )", 1, idw_LstwCommande.rowCount()+1 ) 

If lDeb <= 0 Then Return 

sCodeBoutiqueProximite = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( lDeb, "INFO_SPB_FRN_CPLT" ), "CODE_BTQ_PSM_PROXIMITE", ";")

// [PC836_MANTIS6721]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 209 )
If lDeb > 0 Then
	sIdCourForce = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_FORCE", ";")		

	If Len ( Trim ( sIdCourForce )) > 0 Then
		sIdNatCourForcage = sIdCourForce
	Else
		
		If sCodeBoutiqueProximite = "" Or IsNull ( sCodeBoutiqueProximite ) Then
			// [VDOC10920]
			sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "WTE223_MODIFIE_EN", ";")		
			If Len ( Trim ( sIdNatCourForcage )) <= 0 Then
				sIdNatCourForcage = "WTE223"
			End If
			// [VDOC10920]
		Else 
			
			// [VDOC10920]
			sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "WTE224_MODIFIE_EN", ";")		
			If Len ( Trim ( sIdNatCourForcage )) <= 0 Then
				sIdNatCourForcage = "WTE224"
			End If
			// [VDOC10920]
		End If

	End IF
Else 

	If sCodeBoutiqueProximite = "" Or IsNull ( sCodeBoutiqueProximite ) Then
		sIdNatCourForcage = "WTE223"
	Else 
		sIdNatCourForcage = "WTE224"
	End If		
End If
// [PC836_MANTIS6721]

If IsNull ( sIdNatCourForcage ) Then sIdNatCourForcage  = ""
	
sIdNatPresent = asIdNatCour

If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

If sIdNatPresent <> sIdNatCourForcage Then

	If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
		stMessage.bErreurG	= FALSE
		stMessage.Icon			= question!
		stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
		stMessage.Bouton		= YesNO!
		stMessage.sVar[1] 	= sIdNatCourForcage
		
	Else
		stMessage.bErreurG	= FALSE
		stMessage.Icon			= question!
		stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
		stMessage.Bouton		= YesNO!
		stMessage.sVar[1] 	= asIdNatCour
		stMessage.sVar[2] 	= sIdNatCourForcage
	End If 
	
	If F_Message ( stMessage ) = 1 Then

		stMessage.Icon			= Information!
		stMessage.Bouton		= Ok!							

		idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
		lTotCourrier	= dwChild.RowCount ()
		sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
		lLig				= dwChild.Find ( sRech, 1, lTotCourrier )

/*------------------------------------------------------------------*/
/* On verifie si la nature de courrier existe. Si elle n'existe     */
/* pas, par un effet du hasard bien sur, on arrete le traitement    */
/* et on positionne sur REF_CIE.                                    */
/*------------------------------------------------------------------*/
		If	lLig = 0	Then

/*------------------------------------------------------------------*/
/* On arme la structure de message maintenant, mais le message va   */
/* être affiché dans le contrôle de gestion.                        */
/*------------------------------------------------------------------*/
			stMessage.bErreurG	= FALSE
			stMessage.Icon			= Information!
			stMessage.sCode		= "WSIN170"
			stMessage.sVar[1] 	= sIdNatCourForcage
			asPos = "REF_CIE"
		Else
			If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
				asIdNatCour = sIdNatCourForcage
				asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
				
				idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
				idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
				idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
			Else 
				// Le message est armé dans uf_GestionCP
				asPos = "REF_CIE"

			End If
		End If		
	End If
End If				

end subroutine

private function boolean uf_validation_finale_cds_mail_pec ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_CDS_Mail_PEC  (PRIVATE)
//* Auteur        : FPI
//* Date          : 20/02/2012
//* Libellé       : Gestion Particulière pour CDiscount
//* Commentaires  :	[PC413-1Lot1]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 			FPI	25/02/2013 	[VDOC10441] On prend le montant de PEC et non la valeur d'achat
//			FPI	16/05/2013	[PM191-4_VSR] Mail destinataire à vide
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin
String   sRech,  sVal,   sMailDest,sNomAssure, sAdrLibCiv, sIdDetail, sIdGti
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail,sMailPecCDS
Blob    bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
n_cst_string lnvPFCString
s_plafond_pec stPlafPec
u_datawindow udwnull
decimal dcMtMaxTTC

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 37 )
If lDeb <= 0 Then Return True

sMailPecCDS=lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "MAIL_PEC_ASSURE", ";")
sBoiteMail=lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")

if sMailPecCDS <> "OUI" Then return TRUE

sTypMail = "CMDCDS"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "COD_ETAT   = 'CNV' AND " + &  
			 "ID_TYP_ART   = 'EDI' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'CDS' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers  CDiscount on stoppe.          */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "CDISCOUNT"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If


// Récup de l'adr_mail
lRow=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())

If lRow > 0 Then sMailDest = idw_lstinter.GetItemString(lRow,"ADR_MAIL")
If IsNull ( sMailDest ) Then sMailDest = ""

// [PM191-4_VSR]
if sMailDest = "" Then Return TRUE

sMailObjet = "Confirmation de prise en charge dossier n°" + sIdSin + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 

sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If

sMailBody += sAdrLibCiv + ", "
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nous avons le plaisir de vous informer que suite à l'étude de votre dossier, nous avons effectué une prise en charge."
sMailBody += sSaut
sMailBody += sSaut

lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If

// [VDOC10441] Récup du mt de PEC
dcMtMaxTTC=0.00
lRow=idw_wdivdet.Find("UPPER ( NOM_ZONE ) = 'MT_PEC'  AND ID_DETAIL=" + String(lIdDetail) + " AND ID_GTI=" + String(lIdGti),1,idw_wdivdet.RowCount())
If lRow > 0 Then
	dcMtMaxTTC=idw_wdivdet.GetItemDecimal(lRow,"VAL_MT")
End if

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

sMailBody += "Par conséquent, Cdiscount vous adressera ultérieurement des bons d'achat d'un montant total de " + String(dcMtMaxTTC, "#####0.00") + "€ TTC"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nous vous invitons pour ce faire à vous connecter sur votre espace personnel sur le site www.cdiscount.com afin d'obtenir vos bons d'achat."

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nous restons à votre disposition pour tout renseignement complémentaire."

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Bonne réception," + sSaut
sMailBody += "Le Service Assurance CDiscount."

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Veuillez répondre à l'adresse suivante : assurancecdiscount@spb.fr ou " + sSaut
sMailBody += "SPB service Cdiscount" + sSaut
sMailBody += "76095 Le Havre Cedex" + sSaut


idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_confo_mail_refus ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Confo_Mail_Refus  (PRIVATE)
//* Auteur        : JFF
//* Date          : 19/03/2012
//* Libellé       : 
//* Commentaires  :	[CONFO][MEUBLE][PC542]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    27/08/2012  MANTIS4105 - PC543
//        JFF    14/09/2012  [MANTIS4704]
//        JFF    12/10/2012  [MANTIS4749]
//        JFF    23/10/2012  [MANTIS4749] Date adh ald date achat
//*-----------------------------------------------------------------

Boolean bRet
String  sIdSin, sFic,  sNumIncident, sFiltreOrigRef, sFiltreOrigDivDet, sLibPolice, sDteDecl, sDteAchat
String    sVal,   sMailDest, sNomAssure, sFiltre, sLibArt, sLibEvt, sLibArtDecl, sNumFacture
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv, sGti, sLibArtRef, sLibProdDP66
Blob    bMailBody
Long 	 lRow, iIdAppli, lDeb, lFin, lRowAssure, lTot, lCpt, lIdGti, lIdDetail, lIdPolice, lRow2, lIdEvt 
DataWindowChild dwchild
n_cst_string lnvPFCString

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 207 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL_PROD", ";")

// If IsNull ( sBoiteMail ) OR Len ( sBoiteMail ) <= 0 Then Return False

sTypMail = "CFMREF"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

// Ref sin
sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

// Adr mail boutique
idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If

// Num facture
sNumFacture=""
lRow=idw_wdivsin.Find("Upper(NOM_ZONE) = 'NUM_FACT'",1,idw_wdivsin.RowCount())
If lRow > 0 Then sNumFacture=idw_wdivsin.GetItemString(lRow,"VAL_CAR")
If IsNull ( sNumFacture ) Then sNumFacture = ""

// Liste art Ref
sFiltreOrigRef = idw_wRefus.Describe ( "datawindow.table.filter" )
If sFiltreOrigRef = "?" Then sFiltreOrigRef = ""

idw_wRefus.SetFilter ( "ID_MOTIF = 1536" )
idw_wRefus.Filter ()
lTot = idw_wRefus.RowCount()
sLibArtRef = ""

// [MANTIS4704]
If lTot <= 0 Then Return True

For lCpt = 1 To lTot
	lIdGti = idw_wRefus.GetItemNumber ( lCpt, "ID_GTI")
	lIdDetail = idw_wRefus.GetItemNumber ( lCpt, "ID_DETAIL")
	
	lRow = idw_wDivDet.Find ( "ID_GTI = " + String ( lIdGti ) + " AND " + &
									  "ID_DETAIL = " + String ( lIdDetail ) + " AND " + &
									  "UPPER ( NOM_ZONE ) = 'LIB_ARTICLE'" &
									  , 1, idw_wDivDet.RowCount () )
									  
	sLibArt = F_GetItem3 (idw_wDivDet, lRow, "VAL_CAR" )
									  
	lRow = idw_wDetail.Find ( "ID_GTI = " + String ( lIdGti ) + " AND " + &
							  		  "ID_DETAIL = " + String ( lIdDetail ) &
										, 1, idw_wDetail.RowCount () )

	lIdEvt = idw_wDetail.GetItemNumber ( lRow, "ID_EVT" )
	
	If idw_wDetail.GetItemNumber ( lRow, "COD_ETAT" ) = 200 Then
		sLibEvt = Space ( 35 )

// [MANTIS4749]
//		SQLCA.IM_S01_CODE("+EV", lIdEvt, sLibEvt )

		sLibEvt = Trim ( sLibEvt  )
// [MANTIS4749]
//		sLibArtRef += "- " +  Trim ( sLibEvt ) + "/" + Trim ( sLibArt )
		sLibArtRef += "- " +  Trim ( sLibArt )
		sLibArtRef += sSaut
		
	End IF
	
Next 

// Liste art Decl
sFiltreOrigDivDet = idw_wDivDet.Describe ( "datawindow.table.filter" )
If sFiltreOrigDivDet = "?" Then sFiltreOrigDivDet = ""

idw_wDivDet.SetFilter ( "UPPER ( NOM_ZONE ) = 'LIB_ARTICLE' AND NOT ISNULL ( VAL_CAR ) AND LEN ( VAL_CAR ) > 0" )
idw_wDivDet.Filter ()
lTot = idw_wDivDet.RowCount()
sLibArtDecl = ""

For lCpt = 1 To lTot

	sLibArt = F_GetItem3 (idw_wDivDet, lCpt, "VAL_CAR" )

	lIdGti = idw_wDivDet.GetItemNumber ( lCpt, "ID_GTI")
	lIdDetail = idw_wDivDet.GetItemNumber ( lCpt, "ID_DETAIL")

	lRow = idw_wDetail.Find ( "ID_GTI = " + String ( lIdGti ) + " AND " + &
							  		  "ID_DETAIL = " + String ( lIdDetail ) &
										, 1, idw_wDetail.RowCount () )
	
	lIdEvt = idw_wDetail.GetItemNumber ( lRow, "ID_EVT" )
	
	sLibEvt = Space ( 35 )
// [MANTIS4749]
//	SQLCA.IM_S01_CODE("+EV", lIdEvt, sLibEvt )
	sLibEvt = Trim ( sLibEvt  )

// [MANTIS4749]
//	sLibArtDecl += "- " +  Trim ( sLibEvt ) + "/" + Trim ( sLibArt ) 
	sLibArtDecl += "- " +  Trim ( sLibArt )
	sLibArtDecl += sSaut

Next


// Assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "PRENOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "NOM" )
lRowAssure=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())


// Le libpolice
sLibPolice = ""
lRow = idw_Garantie.Find ( "ID_REV = " + String ( idw_wSin.GetItemNumber ( 1, "ID_REV" )) + " AND " + &
									"ID_GTI = " + String ( lIdGti ), 1, idw_Garantie.RowCount () )
If lRow > 0 Then
	lIdPolice = idw_Garantie.GetItemNumber ( lRow, "ID_POLICE" )
	lRow = idw_Police.Find ( "ID_POLICE = " + String ( lIdPolice  ), 1, idw_Police.Rowcount() )
	If lRow > 0 Then
		sLibPolice = idw_Police.GetItemString ( lRow, "LIB_POLICE" )
	End If
End If 

// Gti
lRow = idw_CodeGarantie.Find ( "ID_GTI=" + String ( lIdGti ), 1, idw_CodeGarantie.RowCount() )
sGti = Lower ( idw_CodeGarantie.GetItemString ( lRow, "LIB_GTI" ) )

//	Option 66
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 66 )
sLibProdDP66 = ""
If lDeb > 0 Then
	sLibProdDP66 = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) )
	If IsNull ( sLibProdDP66  ) Or Trim ( sLibProdDP66 ) = "" Then 	sLibProdDP66 = ""
End If

// DteDecl
sDteDecl = String ( idw_wSin.GetItemDate ( 1, "DTE_DECL" ), "DD/MM/YYYY" )

// sDteAchat
// [MANTIS4749] Date adh ald date achat
sDteAchat = String ( idw_wSin.GetItemDate ( 1, "DTE_ADH" ), "DD/MM/YYYY" )	

// Corps du mail
sMailObjet = sLibProdDP66  + " - Suivi dossier Client n° " + sIdSin 

//  [MANTIS4105]
sMailBody += "Contrat : " + sLibProdDP66 + " - N°" + sLibPolice
sMailBody += sSaut
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nous vous informons que " + sNomAssure + " nous a contacté pour une déclaration de sinistre au titre de l'assurance " + sGti + " pour le (les) produit(s) ci-dessous :"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += sLibArtDecl
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Suite à l’analyse de sa demande, nous vous informons avoir notifié à " + sNomAssure + " un refus de prise en charge pour le motif « Défaut / Dommage préexistant » pour le (les) produit(s) ci-dessous :"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += sLibArtRef
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "En effet, ce type de sinistre ne peut pas être pris en charge au titre du contrat d'assurance."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "A toutes fins utiles, vous trouverez ci-dessous :"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "- Coordonnées de l'assuré" 
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_1" )) + " " + Upper ( F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_2" )) 
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_CP" )) + " " + Upper ( F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_VILLE" ))
sMailBody += sSaut
sMailBody += "Tél. : " + F_GetItem3 ( idw_lstinter, lRowAssure, "NUM_TELD" ) 
sMailBody += sSaut
sMailBody += "Mail : " + F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_MAIL" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "- Données de la facture"
sMailBody += sSaut
sMailBody += "Numéro de facture : " + sNumFacture
sMailBody += sSaut
sMailBody += "Date d'achat : " + sDteAchat 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "- Informations dossier" 
sMailBody += sSaut
sMailBody += "Numéro du dossier : " + sIdSin
sMailBody += sSaut
sMailBody += "Date de déclaration : " + sDteDecl
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Pour toute information complémentaire, vous pouvez nous joindre en répondant à ce mail ou par téléphone au " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + "."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Cordialement"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "SPB"

idw_wRefus.SetFilter ( sFiltreOrigRef )
idw_wRefus.Filter ()

idw_wDivDet.SetFilter ( sFiltreOrigDivDet )
idw_wDivDet.Filter ()


// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function long uf_zn_id_detsin ();//*-----------------------------------------------------------------
//*
//* Fonction		: uf_zn_id_detsin (PRIVATE)
//* Auteur			: JFF
//* Date				: 16/05/2012
//* Libellé			: [ITSM115501]
//* Commentaires	: Contrôle de ID_NAT_SIN
//*
//* Arguments		: Aucun
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------

Long lDeb, lVal1, lVal2
Long lIdDetSin
Integer iAction

iAction = 0

lIdDetSin = Long ( idw_wSin.GetText () )

If iAction = 0 Then
	lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
	
	lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	If  lVal1 > 0 Or lVal2 > 0 Then
		iAction = 1
		idw_wSin.iiErreur = 1
	End If 
End If

Return iAction


end function

private function integer uf_zn_altedit ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_AltEdit (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 23/05/2012
//* Libellé			: 
//* Commentaires	: Controle de ALT_SSUI
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//      JFF   23/05/2012 [PM103][1]
//*-----------------------------------------------------------------

Int iAction

iAction = 0

/*------------------------------------------------------------------*/
/* On vient de mettre la zone Sans Suite à NON.                     */
/*------------------------------------------------------------------*/
If gbModeReprise_223 And idw_wSin.GetText () = "O" Then
	iAction = 1
	idw_wSin.iiErreur = 1
End If

Return iAction


end function

private function boolean uf_validation_finale_mds_mail_tel_pm191 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MDS_Mail_Tel  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 29/01/2007 16:43:53
//* Libellé       : Gestion Particulière pour MEDIA SATURN TELEPHONIE.
//* Commentaires  : Média Saturn téléphonie [DCMP060794]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		  FPI	 06/02/2012		[PR027] Rachat Saturn par Boulanger
//		  FPI	12/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin,  sNomMagasin, sIdGti
String  sIdDetail, sRech,  sVal,  sMailDest, sTelDest, sSaut
String  sMailBody, sMailObjet, sBoiteMail, sTypMail, sXml, sMailFrom
String sMailCc, sMailCci
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, lDeb, lFin
DataWindowChild dwChild
Blob bMailBody
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Int iIdAppli = 2  // SIMPA2
s_pass stPass

sVal = ""

sMailBody=""
sTypMail="CMDMDS"
sSaut = char (10 )

sMailCc=""
 
sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ) )

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MDS' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 
/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()
	Return TRUE
End If	

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "MEDIA SATURN"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	
	If isNull(sMailDest) Then 
		bRet=FALSE
		sMailDest=""
	End if
	
	if isnull(sTelDest) Then sTelDest=""
End If	

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC16132]
sMailObjet=  "AIG SPB_MEDIA_SATURN_ASSURANCE_N°" + sIdSin + " (TELEPHONE/REMPLACEMENT)" 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.2 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody+="ADRESSE_FACTURATION : SPB BOULANGER Téléphonie Mobile 76095 LE HAVRE CEDEX"  + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+="REFERENCE_SIN_SPB : " + sIdSin + "-" + String ( idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )) + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_SPB_A_CONTACTER : " +sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" )  + sSaut
sMailBody+="E-MAIL_EMETTEUR : saturn@spb.fr"   + sSaut
sMailBody+="(M3)"    + sSaut


/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_BOULANGER_A_CONTACTER : "  + sSaut
sMailBody+= "NUM_TEL : " + sTelDest  + sSaut
sMailBody+= "E-MAIL : " + sMailDest  + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+= "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+="ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+="CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+="TEL_ASSURE : " + idw_LstwCommande.GetItemString ( 1, "ADR_TEL1" ) + sSaut
sMailBody+= "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+= "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut


/*------------------------------------------------------------------*/
/* 6 : Appareil à Traiter														  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut

sMailBody+= "APPAREIL_A_REMPLACER : " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut


/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+=sSaut
sMailBody+="MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut
sMailBody+= "-- LES MONTANTS SONT EXPRIMES EN EUROS --"  + sSaut

sMailBody+=sSaut
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody+="NOM_ET_CODE_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M3"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_mds_mail_nomade1_19 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MDS_Mail_Nomade1  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 09/10/2006 16:43:53
//* Libellé       : Gestion Particulière pour MEDIA SATURN.
//* Commentaires  : Cas de gestion : "10/CMDE_MDS"
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		FPI	01/12/2011	[PR026] Rachat de Media Saturn par Boulanger
//		  FPI	12/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin,  sNomMagasin, sIdGti, sCodMag
String  sIdDetail, sRech,  sVal,  sMailDest, sTelDest, sSaut
String  sMailBody, sMailObjet, sBoiteMail, sTypMail, sMailFrom
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2
DataWindowChild dwChild
Blob bMailBody
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet, lDeb, lFin
Decimal{2}	dcMtLu, dcMtMaxLu
Int iIdAppli = 2  // SIMPA2
s_pass stPass
String sXml
String sMailCc, sMailCci

sVal = ""

sMailBody=""
sTypMail="CMDMDS"
sSaut = char (10 )
sMailCc=""

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MDS' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sVar[1]    = "BOULANGER"
	stMessage.sVar[2]    = 	stMessage.sVar[1]
	stMessage.sCode		= "COMD311"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "BOULANGER"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
	sCodMag=""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	if isNull(sTelDest) Then sTelDest=""
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	sCodMag = dwChild.GetItemString ( lRow2, "COD_MAG" )
End If	

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC16132]
sMailObjet= "AIG_SATURN_ASSURANCE_N°" + sIdSin + " (NOMADE/REMPLACEMENT)" 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.2 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody+="ADRESSE_FACTURATION : SPB BOULANGER Produit Nomade 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+="REFERENCE_SIN_SPB : " + sIdSin + "-" + String ( idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )) + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+="N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+="E-MAIL_EMETTEUR : saturn@spb.fr" + sSaut
sMailBody+="(M1)" + sSaut


/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "Personne BOULANGER à contacter : "  + sSaut
sMailBody+= "N° tel : " + sTelDest  + sSaut
sMailBody+= "E-mail : " + sMailDest  + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" ))   + sSaut
sMailBody+=  "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" ))   + sSaut
sMailBody+=  "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" ))   + sSaut
sMailBody+= "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" ))   + sSaut
sMailBody+=  "ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ))   + sSaut
sMailBody+=  "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) )   + sSaut
sMailBody+=  "Numéro de téléphone de l’assuré : " + idw_LstwCommande.GetItemString ( 1, "ADR_TEL1" )   + sSaut
sMailBody+=  "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" )   + sSaut
sMailBody+=  "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" )   + sSaut // [PI056]
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à Traiter														  */
/*------------------------------------------------------------------*/

sMailBody+=   "APPAREIL_A_REMPLACER : " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ))  + sSaut
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+= "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut
sMailBody+= "-- LES MONTANTS SONT EXPRIMES EN EUROS --" + sSaut

sMailBody+=sSaut
sMailBody+= "PRODUIT_A_REMETTRE_AU_CLIENT : " + sSaut


/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut

sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = "AUCUNE DATE PRECISEE PAR L'ASSURE"
sMailBody+="Date de passage au magasin le : " + sVal + sSaut

If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody+=  "CODE_DU_MAGASIN :  " +  sCodMag + sSaut

sMailBody+= "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut


// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M1"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )


bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_mds_mail_nomade2_19 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MDS_Mail_Nomade2  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 25/01/2005 16:43:53
//* Libellé       : Gestion Particulière pour MEDIA SATURN.
//* Commentaires  : Cas de gestion : "11/EXPERT_MDS"
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		 FPI	 01/12/2011	  [PR026] Rachat de Media Saturn par Boulanger
//		  FPI	12/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin,  sNomMagasin, sIdGti, sCodMag
String  sIdDetail, sRech,  sVal,  sMailDest, sTelDest, sSaut, sMailFrom
String  sMailBody, sMailObjet, sBoiteMail, sTypMail, sXml
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, lDeb, lFin
DataWindowChild dwChild
Blob bMailBody
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Int iIdAppli = 2  // SIMPA2
s_pass stPass
String sMailCc, sMailCci

sMailCc=""
sVal = ""

sMailBody=""
sTypMail="CMDMDS"
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ) )

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'AEF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MDS' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sVar[1]    = "BOULANGER"
	stMessage.sVar[2]    = 	stMessage.sVar[1]
	stMessage.sCode		= "COMD311"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers TREMBLAY, on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "BOULANGER"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321" 

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
 	sCodMag=""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	if isNull(sTelDest) Then sTelDest=""
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	sCodMag = dwChild.GetItemString ( lRow2, "COD_MAG" )
End If	

/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC16132]
sMailObjet= "AIG_SATURN_ASSURANCE_N°" + sIdSin + " (NOMADE/EXPERTISE)" 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.2 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody+= "ADRESSE_FACTURATION : SPB BOULANGER Produit Nomade 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+="REFERENCE_SIN_SPB : " + sIdSin + "-" + String ( idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )) + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=  "PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+= "E-MAIL_EMETTEUR : saturn@spb.fr" + sSaut
sMailBody+= "(M2)" + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "Personne BOULANGER à contacter : " + sSaut
sMailBody+=  "N° tél : " + sTelDest + sSaut
sMailBody+=  "E-mail : " + sMailDest + sSaut

/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" ))  + sSaut
sMailBody+= "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" ))  + sSaut
sMailBody+="ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" ))  + sSaut
sMailBody+= "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" ))  + sSaut
sMailBody+="ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ))  + sSaut
sMailBody+= "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) )  + sSaut
sMailBody+= "Numéro de téléphone de l’assuré : " + idw_LstwCommande.GetItemString ( 1, "ADR_TEL1" )  + sSaut
sMailBody+= "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" )  + sSaut
sMailBody+= "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" )  + sSaut // [PI056]

/*------------------------------------------------------------------*/
/* 6 : Appareil à traiter														  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut

sMailBody+="APPAREIL_A_EXPERTISER : " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut

sMailBody+= "DESCRIPTION_DU_DOMMAGE : " + sSaut
sVal = Upper ( idw_LstwCommande.GetItemString ( 1, "PROBLEME" ))
Do While Len ( sVal ) > 0 
	sMailBody+= Left ( sVal, 60 ) + sSaut
	sVal = Mid ( sVal, 61, Len ( sVal ) ) 
Loop

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+=sSaut
sMailBody+= "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut
sMailBody+= "-- LES MONTANTS SONT EXPRIMES EN EUROS --"  + sSaut

sMailBody+=sSaut
sMailBody+= "PRODUIT DEPOSE PAR LE CLIENT  : "  + sSaut

/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
/* Shunter suite DCMP060821 */
//lRow = idw_Mail.InsertRow ( 0 )
//idw_Mail.SetItem ( lRow, "TEXTE", "CLIENT_PASSE_AU_MAGASIN : " )
//
sMailBody+=sSaut


sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = "AUCUNE DATE PRECISEE PAR L'ASSURE"
sMailBody+="DATE_DE_PASSAGE_AU_MAGASIN_LE : " + sVal  + sSaut

If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody+=sSaut
sMailBody+= "CODE_DU_MAGASIN :  " +  sCodMag + sSaut

sMailBody+= "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut



/*------------------------------------------------------------------*/
/* 9 : Etat de retour pour DARTY ASSURANCE								  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+=  "=========================================================================" + sSaut
sMailBody+= "===== ZONE RESERVEE A BOULANGER POUR LE RESULTAT DE L'EXPERTISE ======" + sSaut
sMailBody+=  "=========== MARQUER D'UN 'X' L'ETAT DE PRESTATION CORRESPONDANT =========" + sSaut
sMailBody+=  "=========================================================================" + sSaut
sMailBody+=sSaut
sMailBody+=  "DATE_EXPERTISE :   _ _ / _ _ / _ _ _ _" + sSaut
sMailBody+=sSaut
sMailBody+=  "ETAT_PRESTATION_1 :  |_| SUITE EXPERTISE, REMPLACEMENT ACCEPTE" + sSaut
sMailBody+=sSaut
sMailBody+=  "ETAT_PRESTATION_2 :  |_| SUITE EXPERTISE, REMPLACEMENT REFUSE" + sSaut

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M2"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function string uf_createxml_ksl (string asobjet, string asmailfrom, string asmaildest, string ascodemaquette, string ascas, s_pass astpass);//*-----------------------------------------------------------------
//*
//* Fonction		: uf_createxml_ksl (PRIVATE)
//* Auteur			: FPI	
//* Date				: 13/06/2012
//* Libellé			: Créer le contenu XML pour KSL
//* Commentaires	: 
//*
//* Arguments		: 
//*
//* Retourne		: 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------
String sRet

Choose case Upper(asCas)
	Case "MAIL_COMMANDE"
		sRet+="<commande id_seq=~"" + string(astPass.lTab[1]) + "~" id_four=~"" + astPass.sTab[1] + "~" id_typ_art=~"" + astPass.sTab[2] + "~" code_mail=~"" + astPass.sTab[3] + "~"/>~n"
End choose

Return sRet
end function

private function boolean uf_validation_finale_darty_mail_nomade19 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Darty_Mail_Nomade1  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 25/01/2005 16:43:53
//* Libellé       : Gestion Particulière pour DARTY NOMADE.
//* Commentaires  : Cas de gestion : "11/NPCP/>300/PRS_DST"
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
// 		FPI	13/02/2017	[VDoc22982]
//*       JFF    21/06/2017  [VDOC24056]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sTypMail, sMailFrom, sSaut
String sMailBody, sMailObjet, sXml, sMailDest, sVille
Blob bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lTotDetail, lCptDet, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString		
s_pass stPass
Integer iidAppli
String sMailCc, sMailCci

sMailCc=""
sSaut = char (10 )
sMailBody=""
sTypMail="CMDDTY"
iidAppli=2

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ) )

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'DST' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sCode		= "COMD280"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers TREMBLAY, on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD290"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailDest=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_DST", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if


/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 1ère ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC3763]
// [VDOC16132]
sMailObjet= "AIG SPB_DARTYASSURANCEN°" + sIdSin 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.1 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody+="ADRESSE_FACTURATION : SPB Darty Assurance Produit Nomade 76095 LE HAVRE CEDEX"  + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+="REFERENCE_SIN_SPB : SP" + sIdSin + "-" + String ( idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )) + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_SPB_A_CONTACTER : "  + sSaut
sMailBody+="N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" )  + sSaut
sMailBody+="E-MAIL_EMETTEUR : dartyprodnomade@spb.fr"  + sSaut
sMailBody+="(M1)"  + sSaut


/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_DARTY_A_CONTACTER : "  + sSaut
sMailBody+="Service assurance : 0980 984 984"  + sSaut
sMailBody+="E-MAIL : assurance@darty.fr"  + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut 
sMailBody+=sSaut
sMailBody+="NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+="PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+="ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+="ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+="ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+="CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+="TEL_ASSURE : " + idw_LstwCommande.GetItemString ( 1, "ADR_TEL1" ) + sSaut
sMailBody+="DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+="DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+="-- LES MONTANTS SONT EXPRIMES EN EUROS --" + sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à réparer														  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* Récupération du libellé du type d'appareil                       */
/* (l'Evaluate+LookUpDisplay ne fonctionne pas (!?)                 */
/*------------------------------------------------------------------*/
sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+="APPAREIL_A_REPARER : " + Upper ( sVal ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut

sMailBody+="DESCRIPTION_DU_DOMMAGE : "  + sSaut
sVal = Upper ( idw_LstwCommande.GetItemString ( 1, "PROBLEME" ) )
Do While Len ( sVal ) > 0 
	sMailBody+=Left ( sVal, 60 ) + sSaut 
	sVal = Mid ( sVal, 61, Len ( sVal ) ) 
Loop

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

//[BUG_STRUCTPB11]
/*n_cst_debug_struct_pb11 lnvDebugStPb11
lnvDebugStPb11.uf_verifstruct( stPlafPec, gstppecdebug , "uf_validation_finale_darty_mail_nomade1")*/
//:[BUG_STRUCTPB11]

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+=sSaut
sMailBody+="MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut
sMailBody+="MONTANT_MAXIMUM_REPARATION_TTC : " + String ( dcMtMaxTTC * 0.7, "#####0.00" ) + sSaut

/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "CLIENT PASSE AU MAGASIN : " + sSaut
sMailBody+="CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
//[VDoc22982]
sVille = Fill ( " ", 35 )
SQLCA.PS_S04_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin, sVille ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then
	sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."
Else
	sNomMagasin=Trim(sNomMagasin)
	if not isnull(sVille) Then sNomMagasin+=" - " + Trim(sVille)
End if
// :[VDoc22982]

sMailBody+="NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

/*------------------------------------------------------------------*/
/* 9 : Etat de retour pour SAV TREMBLAY									  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="=========================================================================" + sSaut
sMailBody+="================ ZONE RESERVEE A DARTY SAV BEZONS =======================" + sSaut
sMailBody+= "=========================================================================" + sSaut
sMailBody+=sSaut
sMailBody+="NUM_INTERVENTION : ________________________" + sSaut
sMailBody+="DATE_D_ENVOI :   _ _ / _ _ / _ _ _ _" + sSaut
sMailBody+= "BON_CHRONO   : __________________________" + sSaut
sMailBody+="ETAT_PRESTATION_1 :  |_| Prise en charge par SAV BEZONS et réparé" + sSaut
sMailBody+="ETAT_PRESTATION_2 :  |_| Non prise en charge par SAV BEZONS et non réparé" + sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M1"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_darty_mail_tel19 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Darty_Mail_Tel1 (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/11/2003 16:43:53
//* Libellé       : Gestion Particulière pour DARTY TELEPHONIE.
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   15/12/2003	  Demande de C. Chauvin/O.Caen, ajout adresse de 
//*								  facturation SPB
//*-----------------------------------------------------------------
//* #1    JFF   04/06/2007   [DCMP070163-070164-070248-070318] Gestion Prise en charge
//* #2    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
// 		FPI	13/02/2017	[VDoc22982]
//*       JFF    21/06/2017  [VDOC24056]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sIdSin, sNomMagasin, sVille
String  sRech, sTypMail, sMailFrom, sSaut
String sMailBody, sMailObjet, sXml, sMailDest
Integer iidAppli
Blob bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lDeb, lFin
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
String sVal
s_pass stPass
String sMailCc, sMailCci

sMailCc=""
sVal = ""

SetNull ( udwNull )

sSaut = char (10 )
sMailBody=""
sTypMail="CMDDTY"
iidAppli=2

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'TEL' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'DTY' AND " + &
			 "ISNUMBER ( PROBLEME )"

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then Return TRUE
For lCptCmd = 1 To 3
	lRow = idw_LstwCommande.InsertRow ( 0 )
	idw_LstwCommande.SetItem ( lRow, "ID_MARQ_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_MODL_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_REF_FOUR", "" )
	idw_LstwCommande.SetItem ( lRow, "MT_TTC_CMDE", 0 )
Next

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailDest=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_DTY", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 1ère ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC16132]
sMailObjet= "AIG SPB_DARTYASSURANCEN°" + sIdSin 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.1 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody+="ADRESSE_FACTURATION : SPB Darty Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX"  + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+="REFERENCE_SIN_SPB : SP" + sIdSin  + sSaut
sMailBody+= "(M1)"  + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_SPB_A_CONTACTER : "  + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" )  + sSaut
sMailBody+= "E-MAIL_EMETTEUR : assurancedarty@spb.fr"  + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_DARTY_A_CONTACTER : "  + sSaut
sMailBody+="Service Assurance : 0980 984 984"  + sSaut
sMailBody+="E-MAIL : assurance@darty.fr"  + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" ))  + sSaut
sMailBody+="PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" ))  + sSaut
sMailBody+= "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" ))  + sSaut
sMailBody+="ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" ))  + sSaut
sMailBody+="ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ))  + sSaut
sMailBody+= "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" )   + sSaut
sMailBody+="VILLE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) )  + sSaut
sMailBody+="TEL_ASSURE : " + idw_LstwCommande.GetItemString ( 1, "ADR_TEL1" )  + sSaut
sMailBody+="DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" )  + sSaut
sMailBody+="DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" )  + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+="-- LES MONTANTS SONT EXPRIMES EN EUROS --"  + sSaut

/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="GSM_A_REMPLACER : " + + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut
sMailBody+="PROPOSITION_1 : " + sSaut
sMailBody+="MARQUE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) ) + sSaut
sMailBody+="PRIX_TTC_1 : " + String ( idw_LstwCommande.GetItemDecimal ( 1, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+="CODIC_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_REF_FOUR" ) ) + sSaut

sMailBody+=sSaut

sMailBody+="PROPOSITION_2 : "  + sSaut
sMailBody+="MARQUE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MODL_ART" ) ) + sSaut
sMailBody+="PRIX_TTC_2 : " + String ( idw_LstwCommande.GetItemDecimal ( 2, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+="CODIC_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_REF_FOUR" ) ) + sSaut

sMailBody+=sSaut

sMailBody+="PROPOSITION_3 : " + sSaut
sMailBody+="MARQUE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MODL_ART" ) ) + sSaut
sMailBody+="PRIX_TTC_3 : " + String ( idw_LstwCommande.GetItemDecimal ( 3, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+="CODIC_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_REF_FOUR" ) ) + sSaut

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/

//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

// #3
//stPlafPec = F_Plafond_Pec ( "1", idw_WSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, udwNull, -1, -1 )

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, -1, -1 )

dcMtMaxTTC = stPlafPec.dcPlafEvt

If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

sMailBody+=sSaut
sMailBody+="MONTANT_MAXIMUM_INDEMNISATION_TTC : " + String ( dcMtMaxTTC, "#####0.00" ) + sSaut

/*------------------------------------------------------------------*/
/* 8 : GSM à remettre au client												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="GSM_A_REMETTRE_AU_CLIENT : " + sSaut
sMailBody+=sSaut
sMailBody+= "CLIENT PASSE AU MAGASIN : " + sSaut
sMailBody+="CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
//[VDoc22982]
sVille = Fill ( " ", 35 )
SQLCA.PS_S04_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin, sVille ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then
	sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."
Else
	sNomMagasin=Trim(sNomMagasin)
	if not isnull(sVille) Then sNomMagasin+=" - " + Trim(sVille)
End if
// :[VDoc22982]

sMailBody+="NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M1"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_darty_mail_tel29 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Darty_Mail_Tel2 (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/11/2003 16:43:53
//* Libellé       : Gestion Particulière pour DARTY TELEPHONIE.
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   15/12/2003	  Demande de C. Chauvin/O.Caen, ajout adresse de 
//*								  facturation SPB
//*-----------------------------------------------------------------
//* #1    JFF   04/06/2007   [DCMP070163-070164-070248-070318] Gestion Prise en charge
//* #2    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF   27/04/2011   [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
// 		FPI	13/02/2017	[VDoc22982]
//*       JFF    21/06/2017  [VDOC24056]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin, sNomMagasin, sIdGti, sVille
String  sIdDetail, sRech, sVal, sFiltreOrigDDDW, sTypMail, sMailFrom, sSaut
String sMailBody, sMailObjet, sXml, sMailDest
Blob bMailBody
Integer iidAppli
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lDeb, lFin
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
DataWindowChild dwChild
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
s_pass stPass
String sMailCc, sMailCci

sMailCc=""
SetNull ( udwNull )

sSaut = char (10 )
sMailBody=""
sTypMail="CMDDTY"
iidAppli=2

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'DTY' "


/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sVar[1]    = "DARTY"
	stMessage.sVar[2]    = 	stMessage.sVar[1]
	stMessage.sCode		= "COMD311"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If	


/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD320"

	F_Message ( stMessage ) 
	Return FALSE
End If


lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailDest=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_DTY", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 1ère ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC3763]
// [VDOC16132]
sMailObjet= "AIG SPB_DARTYASSURANCEN°" + sIdSin 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.1 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody+="ADRESSE_FACTURATION : SPB Darty Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+="REFERENCE_SIN_SPB : SP" + sIdSin + sSaut
sMailBody+="(M2)" + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+="N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+="E-MAIL_EMETTEUR : assurancedarty@spb.fr" + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_DARTY_A_CONTACTER : " + sSaut
sMailBody+= "Service Assurance : 0980 984 984" + sSaut
sMailBody+="E-MAIL : assurance@darty.fr" + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+= "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+="ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+="ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+="CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" )  + sSaut
sMailBody+="VILLE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+= "TEL_ASSURE : " + idw_LstwCommande.GetItemString ( 1, "ADR_TEL1" ) + sSaut
sMailBody+="DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+="DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+="-- LES MONTANTS SONT EXPRIMES EN EUROS --" + sSaut

/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* Récupération du libellé du type d'appareil                       */
/* (l'Evaluate+LookUpDisplay ne fonctionne pas (!?)                 */
/*------------------------------------------------------------------*/
sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+="APPAREIL_A_REMPLACER : " + Upper ( sVal ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/

//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

// #3
//stPlafPec = F_Plafond_Pec ( "1", idw_WSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, udwNull, -1, -1 )

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0

For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					

Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, -1, -1 )


dcMtMaxTTC = stPlafPec.dcPlafEvt

If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

sMailBody+=sSaut
sMailBody+="MONTANT_MAXIMUM_INDEMNISATION_TTC : " + String ( dcMtMaxTTC, "#####0.00")  + sSaut


/*------------------------------------------------------------------*/
/* 8 : GSM à remettre au client												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="GSM_A_REMETTRE_AU_CLIENT : " + sSaut
sMailBody+=sSaut
sMailBody+="CLIENT PASSE AU MAGASIN : " + sSaut
sMailBody+="CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
//[VDoc22982]
sVille = Fill ( " ", 35 )
SQLCA.PS_S04_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin, sVille ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then
	sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."
Else
	sNomMagasin=Trim(sNomMagasin)
	if not isnull(sVille) Then sNomMagasin+=" - " + Trim(sVille)
End if
// :[VDoc22982]

sMailBody+="NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut


// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M2"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )


bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	"", &
	sTypMail, &
	iIdAppli, &
	"KSL", &
	-1, &
	sXml &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_darty_mail_nomade29 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Darty_Mail_Nomade2  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 25/01/2005 16:43:53
//* Libellé       : Gestion Particulière pour DARTY NOMADE.
//* Commentaires  : Cas de gestion : "11/NPCP/<=300/CMD_DTY"
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
// 		FPI	13/02/2017	[VDoc22982]
//*       JFF    21/06/2017  [VDOC24056]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sNomMagasin, sIdGti, sIdEvt, sVille
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW
String sMailDest, sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lTotDetail, lCptDet, lDeb, lFin
Integer iIdAppli
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sSaut = char (10 )
sMailBody=""
sTypMail="CMDDTY"
iIdAppli=2

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'DTY' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sCode		= "COMD310"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD320"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailDest=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_DTY", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 1ère ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC3763]
// [VDOC16132]
sMailObjet="AIG SPB_DARTYASSURANCEN°" + sIdSin + " (NOMADE/REMPLACEMENT HORS PROPOSITION SPB)" 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.1 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody+="ADRESSE_FACTURATION : SPB Darty Assurance Produit Nomade 76095 LE HAVRE CEDEX"  + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+="REFERENCE_SIN_SPB : SP" + sIdSin + "-" + String ( idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )) + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+="E-MAIL_EMETTEUR : dartyprodnomade@spb.fr" + sSaut
sMailBody+= "(M2)" + sSaut


/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "PERSONNE_DARTY_A_CONTACTER : " + sSaut
sMailBody+="Service assurance : 0980 984 984" + sSaut
sMailBody+= "E-MAIL : assurance@darty.fr" + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+=  "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+=  "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+=  "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+=  "TEL_ASSURE : " + idw_LstwCommande.GetItemString ( 1, "ADR_TEL1" ) + sSaut
sMailBody+=  "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+=  "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+= "-- LES MONTANTS SONT EXPRIMES EN EUROS --" + sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à réparer														  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* Récupération du libellé du type d'appareil                       */
/* (l'Evaluate+LookUpDisplay ne fonctionne pas (!?)                 */
/*------------------------------------------------------------------*/
sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+= "APPAREIL_A_REMPLACER : " + Upper ( sVal ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+=sSaut
sMailBody+="MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut


/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="PRODUIT A REMETTRE AU MAGASIN : " + sSaut
sMailBody+="CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
//[VDoc22982]
sVille = Fill ( " ", 35 )
SQLCA.PS_S04_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin, sVille ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then
	sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."
Else
	sNomMagasin=Trim(sNomMagasin)
	if not isnull(sVille) Then sNomMagasin+=" - " + Trim(sVille)
End if
// :[VDoc22982]

sMailBody+= "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M2"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )


bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_darty_mail_nomade39 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Darty_Mail_Nomade3  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 25/01/2005 16:43:53
//* Libellé       : Gestion Particulière pour DARTY NOMADE.
//* Commentaires  : Cas de gestion : "11/PCP/PRS_DTY"
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
// 		FPI	13/02/2017	[VDoc22982]
//*       JFF    21/06/2017  [VDOC24056]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin,  sNomMagasin, sIdGti, sIdEvt, sVille
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW
String sMailDest, sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lTotDetail, lCptDet, lDeb, lFin
Integer iIdAppli
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sVal = ""
sSaut = char (10 )
sMailBody=""
sTypMail="CMDDTY"
iIdAppli=2

/*------------------------------------------------------------------*/
/* Répertoire d'écriture.                                           */
/*------------------------------------------------------------------*/

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'DTY' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sCode		= "COMD330"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers TREMBLAY, on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD340"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailDest=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_DTY", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 1ère ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC3763]
// [VDOC16132]
sMailObjet="AIG SPB_DARTYASSURANCEN°" + sIdSin + " (NOMADE/REPARATION PCP)" 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.1 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody+="ADRESSE_FACTURATION : SPB Darty Assurance Produit Nomade 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+= "REFERENCE_SIN_SPB : SP" + sIdSin + "-" + String ( idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )) + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+="PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+= "E-MAIL_EMETTEUR : dartyprodnomade@spb.fr" + sSaut
sMailBody+= "(M3)" + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "PERSONNE_DARTY_A_CONTACTER : "  + sSaut
sMailBody+= "Service assurance : 0980 984 984"  + sSaut
sMailBody+= "E-MAIL : assurance@darty.fr"  + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+= "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+="ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+= "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+="TEL_ASSURE : " + idw_LstwCommande.GetItemString ( 1, "ADR_TEL1" ) + sSaut
sMailBody+= "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+= "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+="-- LES MONTANTS SONT EXPRIMES EN EUROS --" + sSaut


/*------------------------------------------------------------------*/
/* 6 : Appareil à réparer														  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* Récupération du libellé du type d'appareil                       */
/* (l'Evaluate+LookUpDisplay ne fonctionne pas (!?)                 */
/*------------------------------------------------------------------*/
sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+= "APPAREIL_A_REPARER : " + Upper ( sVal ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut

sMailBody+= "DESCRIPTION_DU_DOMMAGE : " + sSaut
sVal = Upper ( idw_LstwCommande.GetItemString ( 1, "PROBLEME" ) )
Do While Len ( sVal ) > 0 
	sMailBody+= Left ( sVal, 60 ) + sSaut
	sVal = Mid ( sVal, 61, Len ( sVal ) ) 
Loop

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+=sSaut
sMailBody+= "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut
sMailBody+= "MONTANT_MAXIMUM_REPARATION_TTC : " + String ( dcMtMaxTTC * 0.7, "#####0.00" ) + sSaut


/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "PRODUIT A DEPOSER PAR LE CLIENT : " + sSaut
sMailBody+= "CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) )) + sSaut

sNomMagasin = Fill ( " ", 35 )
//[VDoc22982]
sVille = Fill ( " ", 35 )
SQLCA.PS_S04_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin, sVille ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then
	sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."
Else
	sNomMagasin=Trim(sNomMagasin)
	if not isnull(sVille) Then sNomMagasin+=" - " + Trim(sVille)
End if
// :[VDoc22982]

sMailBody+= "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

/*------------------------------------------------------------------*/
/* 9 : Etat de retour pour DARTY ASSURANCE								  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="=========================================================================" + sSaut
sMailBody+= "================ ZONE RESERVEE A DARTY ASSURANCE ===================" + sSaut
sMailBody+= "=========================================================================" + sSaut
sMailBody+=sSaut
sMailBody+= "NUM_INTERVENTION : ________________________" + sSaut
sMailBody+= "DATE_D_ENVOI :   _ _ / _ _ / _ _ _ _" + sSaut
sMailBody+="BON_CHRONO   : ____________________________" + sSaut
sMailBody+= "ETAT_PRESTATION_1 :  |_| Prise en charge par DARTY ASSURANCE et réparé" + sSaut
sMailBody+= "ETAT_PRESTATION_2 :  |_| Non prise en charge par DARTY ASSURANCE et non réparé" + sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M3"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_darty_mail_nomade49 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Darty_Mail_Nomade4  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/11/2003 16:43:53
//* Libellé       : Gestion Particulière pour DARTY TELEPHONIE.
//* Commentaires  : Cas de gestion : "10/PCP/CMD_DTY"
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
// 		FPI	13/02/2017	[VDoc22982]
//*       JFF    21/06/2017  [VDOC24056]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt, sVille
String  sIdDetail, sRech, sVal, sFiltreOrigDDDW, sMtValAchat, sRepSav, sRepFicSav, sTypApp
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lTotDetail, lCptDet, lDeb, lFin
String sMailDest, sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu
DatawindowChild dwChild
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Integer iIdAppli
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDDTY"
iIdAppli=2


sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

sTypApp = Upper ( This.uf_GestOng_Divers_Trouver( "TYPE_APP" ) )

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = '" + sTypApp + "' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'DTY' AND " + &
			 "ISNUMBER ( PROBLEME )"

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sCode		= "COMD310"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If

/*------------------------------------------------------------------*/
/* Plus de 3 commandes vers DARTY, on stoppe.                       */
/*------------------------------------------------------------------*/
If lTotCmd > 3 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD340"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To 3
	lRow = idw_LstwCommande.InsertRow ( 0 )
	idw_LstwCommande.SetItem ( lRow, "ID_MARQ_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_MODL_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_REF_FOUR", "" )
	idw_LstwCommande.SetItem ( lRow, "MT_TTC_CMDE", 0 )
Next

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next


// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailDest=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_DTY", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

// TODO : sMailDest pour les mails Darty

/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 1ère ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC3763]
// [VDOC16132]
sMailObjet= "AIG SPB_DARTYASSURANCEN°" + sIdSin + " (NOMADE/REMPLACEMENT " + sTypApp +" AVEC PROPOSITIONS SPB)" 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.1 #1 : Demande de C. Chauvin/O Caen, placer l'adresse de       */
/* facturation.                                                     */
/*------------------------------------------------------------------*/
sMailBody+= "ADRESSE_FACTURATION : SPB Darty Assurance Produit Nomade 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+= "REFERENCE_SIN_SPB : SP" + sIdSin + "-" + String ( idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" ) ) + "/" + + String ( idw_LstwCommande.GetItemNumber ( 2, "ID_SEQ" ) ) + "/" + String ( idw_LstwCommande.GetItemNumber ( 3, "ID_SEQ" ))+ sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+=  "E-MAIL_EMETTEUR : dartyprodnomade@spb.fr" + sSaut
sMailBody+= "(M4)" + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne DARTY à contacter.											  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=  "PERSONNE_DARTY_A_CONTACTER : " + sSaut
sMailBody+=  "Service Assurance : 0980 984 984" + sSaut
sMailBody+=  "E-MAIL : assurance@darty.fr" + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+= "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+="ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+="ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+= "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+="TEL_ASSURE : " + idw_LstwCommande.GetItemString ( 1, "ADR_TEL1" ) + sSaut
sMailBody+= "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+= "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+= "-- LES MONTANTS SONT EXPRIMES EN EUROS --" + sSaut


/*------------------------------------------------------------------*/
/* 6 : Appareil à remplacer													  */
/*------------------------------------------------------------------*/
/* Récupération du libellé du type d'appareil                       */
/* (l'Evaluate+LookUpDisplay ne fonctionne pas (!?)                 */
/*------------------------------------------------------------------*/
sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+="APPAREIL_A_REMPLACER : " + Upper ( sVal ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "PROPOSITION_1 : " + sSaut
sMailBody+= "MARQUE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) ) + sSaut
sMailBody+= "PRIX_TTC_1 : " + String ( idw_LstwCommande.GetItemDecimal ( 1, "MT_TTC_CMDE" ), "#####0.00" ) 
sMailBody+= "CODIC_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_REF_FOUR" ) ) + sSaut

sMailBody+=sSaut

sMailBody+= "PROPOSITION_2 : " + sSaut
sMailBody+= "MARQUE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MODL_ART" ) ) + sSaut
sMailBody+= "PRIX_TTC_2 : " + String ( idw_LstwCommande.GetItemDecimal ( 2, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+= "CODIC_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_REF_FOUR" ) ) + sSaut

sMailBody+=sSaut

sMailBody+= "PROPOSITION_3 : " + sSaut
sMailBody+= "MARQUE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MODL_ART" ) ) + sSaut
sMailBody+= "PRIX_TTC_3 : " + String ( idw_LstwCommande.GetItemDecimal ( 3, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+= "CODIC_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_REF_FOUR" ) ) + sSaut

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+=sSaut
sMailBody+="MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut

/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "PRODUIT A REMETTRE AU CLIENT : "  + sSaut
sMailBody+= "CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) )  + sSaut

sNomMagasin = Fill ( " ", 35 )
//[VDoc22982]
sVille = Fill ( " ", 35 )
SQLCA.PS_S04_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin, sVille ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then
	sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."
Else
	sNomMagasin=Trim(sNomMagasin)
	if not isnull(sVille) Then sNomMagasin+=" - " + Trim(sVille)
End if
// :[VDoc22982]


sMailBody+= "NOM_DU_MAGASIN : " + Upper ( sNomMagasin )  + sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M4"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If
Return bRet

end function

private function boolean uf_validation_finale_mbs_mail_devis_pm19 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MBS_Mail_Devis  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 02/09/2011
//* Libellé       : MAIL pour Mobistore Devis.
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 	// [PC10][DIAG_NOMADE]
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet, bMobistore
String  sFiltreOrig, sFiltre,  sIdSin, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMailDest,  sVal, sTypApp, sLibTypApp
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Decimal{2}	dcMtMaxTTC
DataWindowChild dwChild
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Integer iIdAppli
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDMBS"
iIdAppli=2

bRet = True

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'DEV' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'" 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then Return TRUE

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC3763]
// [VDOC16132]
sMailObjet = "AIG SPB_MOBISTORE_ASSURANCE_N°" + sIdSin + "(Demande de devis)" 
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.2 #1 : adresse de facturation.                                 */
/*------------------------------------------------------------------*/
sMailBody+= "ADRESSE_FACTURATION : SPB Mobistore Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+= "REFERENCE_SIN_SPB : SP" + sIdSin + sSaut
sMailBody+= "(M5)" + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+=  "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+=  "E-MAIL_EMETTEUR : assurancemobistore@spb.fr" + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne MOBISTORE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "COORDONNEES_BOUTIQUE : " + sSaut

sMailBody+= "Service Assurance : " + dwChild.GetItemString ( lRow2, "ADR_TEL" ) + sSaut

sMailBody+= "E-MAIL : " + sMailDest + sSaut

/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+=  "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+=  "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+= "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" )  + sSaut
sMailBody+=  "VILLE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+=  "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+=  "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à traiter														  */
/*------------------------------------------------------------------*/
sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" )
sLibTypApp = Space ( 35 )
SQLCA.IM_S01_CODECAR ("-AR", Upper ( sTypApp ), sLibTypApp )
If IsNull ( sLibTypApp ) Then sLibTypApp = ""


sMailBody+=sSaut
sMailBody+=  "APPAREIL_ENDOMMAGE : " + sLibTypApp + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) )  + sSaut
sMailBody+=sSaut

sMailBody+= "DESCRIPTION_DU_DOMMAGE : "  + sSaut
sVal = Upper ( idw_LstwCommande.GetItemString ( 1, "PROBLEME" ) )
Do While Len ( sVal ) > 0 
	sMailBody+= Left ( sVal, 60 )  + sSaut
	sVal = Mid ( sVal, 61, Len ( sVal ) ) 
Loop



/*------------------------------------------------------------------*/
/* 9 : Etat de retour pour DARTY ASSURANCE								  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+=  "======================================================================================"  + sSaut
sMailBody+= "====================== ZONE RESERVEE A MOBISTORE POUR LE DEVIS ======================="  + sSaut
sMailBody+=  "== PARTIE A IMPRIMER PUIS A DONNER A L'ASSURE QUI DOIT L'ENVOYER PAR LA POSTE A SPB =="  + sSaut
sMailBody+= "===================================== POUR ETUDE ====================================="  + sSaut
sMailBody+=  "======================================================================================"  + sSaut
sMailBody+=sSaut
sMailBody+=  "-- LES MONTANTS SONT A EXPRIMER EN EUROS --"  + sSaut
sMailBody+=sSaut
sMailBody+=  "DATE_DEVIS :   _ _ / _ _ / _ _ _ _"  + sSaut
sMailBody+=sSaut
sMailBody+=  "MONTANT DEVIS : _ _ _ _ _ , _ _ "  + sSaut
sMailBody+=sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M5"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

end function

private function boolean uf_validation_finale_mbs_mail_diag_pm191 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MBS_Mail_Diag  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 02/09/2011
//* Libellé       : MAIL pour Mobistore DIag.
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*			FPI	09/03/2012	[VDoc7065]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet, bMobistore
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMailDest,  sRepSav, sRepFicSav, sVal, sTypApp, sLibTypApp
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Decimal{2}	dcMtMaxTTC
DataWindowChild dwChild
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Integer iIdAppli
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDMBS"
iIdAppli=2

bRet = True

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'AEF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'" 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then Return TRUE

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/
lRow = idw_Mail.InsertRow ( 0 )

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC3763]
// [VDOC16132]
sMailObjet = "AIG SPB_MOBISTORE_ASSURANCE_N°" + sIdSin + "(Diagnostic/Expertise)" + sSaut
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.2 #1 : adresse de facturation.                                 */
/*------------------------------------------------------------------*/
sMailBody+= "ADRESSE_FACTURATION : SPB Mobistore Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+= "REFERENCE_SIN_SPB : " + sIdSin  // [VDoc7065]

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+="E-MAIL_EMETTEUR : assurancemobistore@spb.fr" + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne MOBISTORE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "COORDONNEES_BOUTIQUE : " + sSaut

sMailBody+= "NUM_TEL : " + dwChild.GetItemString ( lRow2, "ADR_TEL" ) + sSaut // [VDoc7065]

sMailBody+="E-MAIL : " + sMailDest + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" ))  + sSaut
sMailBody+= "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" ))  + sSaut
sMailBody+= "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" ))  + sSaut
sMailBody+= "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" ))  + sSaut
sMailBody+="ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ))  + sSaut
sMailBody+= "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" )   + sSaut
sMailBody+= "VILLE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) )  + sSaut
sMailBody+= "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" )  + sSaut
sMailBody+="DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" )  + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+="-- LES MONTANTS SONT EXPRIMES EN EUROS --"  + sSaut


/*------------------------------------------------------------------*/
/* 6 : Appareil à traiter														  */
/*------------------------------------------------------------------*/
sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" )
sLibTypApp = Space ( 35 )
SQLCA.IM_S01_CODECAR ("-AR", Upper ( sTypApp ), sLibTypApp )
If IsNull ( sLibTypApp ) Then sLibTypApp = ""


sMailBody+=sSaut
sMailBody+=  "APPAREIL_A_EXPERTISER : " + sLibTypApp + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) )  + sSaut
sMailBody+=sSaut

sMailBody+=  "DESCRIPTION_DU_DOMMAGE : "  + sSaut
sVal = Upper ( idw_LstwCommande.GetItemString ( 1, "PROBLEME" ) )
Do While Len ( sVal ) > 0 
	sMailBody+=  Left ( sVal, 60 )  + sSaut
	sVal = Mid ( sVal, 61, Len ( sVal ) ) 
Loop

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+=sSaut
sMailBody+="MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut

sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* 8 : GSM à remettre au client												  */
/*--------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "APPAREIL_A_REMETTRE_AU_CLIENT SI REMPLACEMENT ACCEPTE : " + sSaut // [VDoc7065] Mobile <- appareil

sMailBody+=sSaut
sMailBody+= "CLIENT PASSE AU MAGASIN : " + sSaut
sMailBody+= "CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody+= "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut


/*------------------------------------------------------------------*/
/* 9 : Etat de retour pour DARTY ASSURANCE								  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "=========================================================================" + sSaut
sMailBody+="===== ZONE RESERVEE A MOBISTORE POUR LE RESULTAT DE L'EXPERTISE ======" + sSaut
sMailBody+= "=========== MARQUER D'UN 'X' L'ETAT DE PRESTATION CORRESPONDANT =========" + sSaut
sMailBody+="=========================================================================" + sSaut
sMailBody+=sSaut
sMailBody+="DATE_EXPERTISE :   _ _ / _ _ / _ _ _ _" + sSaut
sMailBody+=sSaut
sMailBody+= "ETAT_PRESTATION_1 :  |_| SUITE EXPERTISE, REMPLACEMENT ACCEPTE" + sSaut
sMailBody+=sSaut
sMailBody+= "ETAT_PRESTATION_2 :  |_| SUITE EXPERTISE, REMPLACEMENT REFUSE" + sSaut

//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If



Return bRet

end function

private function boolean uf_validation_finale_mbs_mail_nomade_191 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MBS_Mail_Nomade  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 05/09/2011
//* Libellé       : MAIL pour Mobistore.
//* Commentaires  : [PC10][DIAG_NOMADE]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			FPI	09/03/2012	[VDoc7065]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet, bMobistore
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMailDest,  sRepSav, sRepFicSav, sVal
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Decimal{2}	dcMtMaxTTC
DataWindowChild dwChild
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Integer iIdAppli
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDMBS"
iIdAppli=2

bRet = True

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ) )

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART NOT IN ( 'TEL', 'CAF', 'AEF' ) AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'" 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then Return TRUE
For lCptCmd = 1 To 3
	lRow = idw_LstwCommande.InsertRow ( 0 )
	idw_LstwCommande.SetItem ( lRow, "ID_MARQ_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_MODL_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_REF_FOUR", "" )
	idw_LstwCommande.SetItem ( lRow, "MT_TTC_CMDE", 0 )
Next

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next


// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/
idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC3763]
// [VDOC16132]
sMailObjet="AIG SPB_MOBISTORE_ASSURANCE_N°" + sIdSin + "(Proposition de remplacement Nomade)" 

/*------------------------------------------------------------------*/
/* 1.2 #1 : adresse de facturation.                                 */
/*------------------------------------------------------------------*/
sMailBody+= "ADRESSE_FACTURATION : SPB Mobistore Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+=  "REFERENCE_SIN_SPB : " + sIdSin + sSaut // [VDOC7065] Suppr de SP & id_typ_mail

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=  "PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+=  "E-MAIL_EMETTEUR : assurancemobistore@spb.fr" + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne MOBISTORE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=  "COORDONNEES_BOUTIQUE : " + sSaut

sMailBody+=  "NUM_TEL : " + dwChild.GetItemString ( lRow2, "ADR_TEL" ) + sSaut

sMailBody+=  "E-MAIL : " + sMailDest + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+=  "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+=  "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" )  + sSaut
sMailBody+=  "VILLE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+=  "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+=  "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+=  "-- LES MONTANTS SONT EXPRIMES EN EUROS --" + sSaut


/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "APPAREIL_A_REMPLACER : " + + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut

sMailBody+=sSaut
sMailBody+=  "PROPOSITION_1 : " + sSaut
sMailBody+=  "MARQUE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) ) + sSaut
sMailBody+=  "PRIX_TTC_1 : " + String ( idw_LstwCommande.GetItemDecimal ( 1, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+=  "REFEFERENCE_MOBISTORE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_REF_FOUR" ) ) + sSaut

sMailBody+=sSaut

sMailBody+=  "PROPOSITION_2 : " + sSaut
sMailBody+=  "MARQUE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MODL_ART" ) ) + sSaut
sMailBody+= "PRIX_TTC_2 : " + String ( idw_LstwCommande.GetItemDecimal ( 2, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+=  "REFEFERENCE_MOBISTORE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_REF_FOUR" ) ) + sSaut

sMailBody+=sSaut

sMailBody+=  "PROPOSITION_3 : " + sSaut
sMailBody+=  "MARQUE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MODL_ART" ) ) + sSaut
sMailBody+=  "PRIX_TTC_3 : " + String ( idw_LstwCommande.GetItemDecimal ( 3, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+=  "REFEFERENCE_MOBISTORE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_REF_FOUR" ) ) + sSaut

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow3 = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow3 > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow3, "MT_VAL_PUBLIQUE" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+=sSaut
sMailBody+= "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut

/*------------------------------------------------------------------*/
/* 8 : GSM à remettre au client												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+=  "APPAREIL_A_REMETTRE_AU_CLIENT : " + sSaut

sMailBody+=sSaut
sMailBody+=  "CLIENT PASSE AU MAGASIN : " + sSaut
sMailBody+= "CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody+=  "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If


Return bRet

end function

private function boolean uf_validation_finale_mbs_mail_tel1_pm191 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MBS_Mail_Tel1  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/11/2003 16:43:53
//* Libellé       : MAIL pour Mobistore.
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//       JFF   28/06/2016 [PC151549]
//*-----------------------------------------------------------------

Boolean bRet, bMobistore
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMailDest,  sRepSav, sRepFicSav, sVal
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Decimal{2}	dcMtMaxTTC
DataWindowChild dwChild
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Integer iIdAppli
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci
String sContenu, sObjet, sSql

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDMBS"
iIdAppli=2

bRet = True

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
// [PC151549]
sFiltre = "ID_TYP_ART = 'TEL' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS' AND " + &
			 "ISNUMBER ( PROBLEME )"

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 302 )
If lDeb > 0 Then
	sTypMail="CMDBST"
	sFiltre = "ID_TYP_ART <> 'CAF' AND " + &		
				 "COD_ETAT   = 'CNV' AND " + &  
				 "CPT_VALIDE <= 0    AND " + &
				 "ID_FOUR    = 'BST' " 
End If					 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then Return TRUE
For lCptCmd = 1 To 3
	lRow = idw_LstwCommande.InsertRow ( 0 )
	idw_LstwCommande.SetItem ( lRow, "ID_MARQ_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_MODL_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_REF_FOUR", "" )
	idw_LstwCommande.SetItem ( lRow, "MT_TTC_CMDE", 0 )
Next

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/
idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC3763]
// [VDOC16132]
// [PC151549]
If sTypMail = "CMDBST" Then
	sMailObjet = "SPB_ASSURANCE_N°" + sIdSin + "(Proposition de remplacement Téléphone)" 
Else 
	sMailObjet = "AIG SPB_MOBISTORE_ASSURANCE_N°" + sIdSin + "(Proposition de remplacement Téléphone)" 
End If
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.2 #1 : adresse de facturation.                                 */
/*------------------------------------------------------------------*/
// [PC151549]
If sTypMail = "CMDBST" Then
	sMailBody+=  "ADRESSE_FACTURATION : SPB Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut
Else 
	sMailBody+=  "ADRESSE_FACTURATION : SPB Mobistore Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut
End If
/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+=  "REFERENCE_SIN_SPB : SP" + sIdSin + sSaut
sMailBody+=  "(M1)" + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+=  "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut

// [PC151549]
If sTypMail <> "CMDBST" Then
	sMailBody+=  "E-MAIL_EMETTEUR : assurancemobistore@spb.fr" + sSaut
End If

/*------------------------------------------------------------------*/
/* 4 : Personne MOBISTORE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=  "COORDONNEES_BOUTIQUE : " + sSaut

sMailBody+= "Service Assurance : " + dwChild.GetItemString ( lRow2, "ADR_TEL" ) + sSaut

sMailBody+=  "E-MAIL : " + sMailDest + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+=  "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+=  "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+=  "ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+=  "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" )  + sSaut
sMailBody+= "VILLE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+= "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+=  "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+=  "-- LES MONTANTS SONT EXPRIMES EN EUROS --" + sSaut


/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=  "MOBILE_A_REMPLACER : " + + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut
sMailBody+=  "PROPOSITION_1 : " + sSaut
sMailBody+=  "MARQUE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) ) + sSaut
sMailBody+= "PRIX_TTC_1 : " + String ( idw_LstwCommande.GetItemDecimal ( 1, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+=  "REFEFERENCE_MOBISTORE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_REF_FOUR" ) ) + sSaut

sMailBody+=sSaut

sMailBody+=  "PROPOSITION_2 : " + sSaut
sMailBody+=  "MARQUE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MODL_ART" ) ) + sSaut
sMailBody+=  "PRIX_TTC_2 : " + String ( idw_LstwCommande.GetItemDecimal ( 2, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+=  "REFEFERENCE_MOBISTORE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_REF_FOUR" ) ) + sSaut

sMailBody+=sSaut

sMailBody+=  "PROPOSITION_3 : " + sSaut
sMailBody+=  "MARQUE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MODL_ART" ) ) + sSaut
sMailBody+=  "PRIX_TTC_3 : " + String ( idw_LstwCommande.GetItemDecimal ( 3, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
sMailBody+=  "REFEFERENCE_MOBISTORE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_REF_FOUR" ) ) + sSaut

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow3 = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow3 > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow3, "MT_VAL_PUBLIQUE" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

// [ITM23505] - Mouchard pour mt PEC à 0
If dcMtMaxTTC = 0 Then
	
	F_Commit ( itrTrans, False )
	
	sContenu="Pb calcul du montant de PEC sur mail Mobistore = 0 dans la fonction u_gs_sp_sinistre::uf_Validation_Finale_MBS_Mail_Tel1_pm191" + sSaut + &
		"sinistre " + sIdSin + " trigramme " + stGlb.sCodoper
	sObjet	= "Pb calcul du montant de PEC sur mail Mobistore = 0"

	sSql = "Exec sysadm.PS_S01_MAIL " + &
		  "'jf.fabry@spb.fr,fpinon@spb.eu'"				 + ", " + &
		  "'" + sContenu + "'"		 + ", " + &
		  "'" + sObjet + "'"		 + ", " + &
		  "'noreply@spb.eu'"		    + ", " + &
		  "''"			 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"

	F_execute ( sSql, itrTrans )
	F_Commit ( itrTrans, true )
	
	stMessage.sTitre="(ITSM23505) Mail Mobistore"
	stMessage.sCode="GENE013"
	stMessage.sVar[1]="Une erreur s'est produite sur le calcul du montant de PEC pour le mail Mobistore." + sSaut + &
		sSaut + "Merci d'ouvrir un ticket ITSM auprès du 2110"
	
	
	f_message(stmessage)
	
	Return false
End if
// :[ITM23505] - Mouchard pour mt PEC à 0

sMailBody+=sSaut
sMailBody+= "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut

/*------------------------------------------------------------------*/
/* 8 : GSM à remettre au client												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+=  "MOBILE_A_REMETTRE_AU_CLIENT : " + sSaut
sMailBody+=sSaut
sMailBody+=  "CLIENT PASSE AU MAGASIN : " + sSaut
sMailBody+=  "CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody+= "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M1"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If



Return bRet

end function

private function boolean uf_validation_finale_mbs_mail_tel2_pm191 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MBS_Mail_Tel2  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 17/11/2003 16:43:53
//* Libellé       : MAIL pour Mobistore.
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF    27/04/2011  [VDOC3763]
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		FPI		28/02/2012	[VDoc7065][PC10]
//		  FPI	19/06/2012		[PM191-2] Refonte des mails pour KSL
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//        JFF   28/06/2016   [PC151549]
//       JFF   14/03/2025 [PMO268_MIG56]
//*-----------------------------------------------------------------

Boolean bRet, bMobistore
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMailDest,  sRepSav, sRepFicSav, sVal, sFiltreOrigDDDW
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Decimal{2}	dcMtMaxTTC
DataWindowChild dwChild
s_Plafond_Pec stPlafPec
U_Datawindow udwNull

n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Integer iIdAppli
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci, sLibProd 

sMailCc=""
bRet = True
sSaut = char (10 )
sMailBody=""
sTypMail="CMDMBS"
iIdAppli=2

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))
sLibProd = ""

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
// [PC151549]
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'"


F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 302 )
If lDeb > 0 Then
	sTypMail="CMDBST"
	sLibProd="Mobil’Zen 3" // [PMO268_MIG56]
	sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
				 "COD_ETAT   = 'CNV' AND " + &  
				 "CPT_VALIDE <= 0    AND " + &
				 "ID_FOUR    = 'BST'"
	
End If 

// [PMO268_MIG56]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 395 )
If lDeb > 0 Then
	sLibProd="Mobil’Zen 4"
End If 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sVar[1]    = "BOOST" // [PMO268_MIG56]
	stMessage.sVar[2]    = 	stMessage.sVar[1]
	stMessage.sCode		= "COMD311"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If	


/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD320"

	F_Message ( stMessage ) 
	Return FALSE
End If

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/
idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC16132]
// [PC151549]
If sTypMail = "CMDBST" Then
	sMailObjet = "SPB_ASSURANCE_N°" + sIdSin + "(Choix remplacement)" 
Else
	sMailObjet = "AIG SPB_MOBISTORE_ASSURANCE_N°" + sIdSin + "(Choix remplacement)" 	
End If
// :[VDOC16132]

/*------------------------------------------------------------------*/
/* 1.2 #1 : adresse de facturation.                                 */
/*------------------------------------------------------------------*/
// [PC151549]
// [PC151549]
If sTypMail = "CMDBST" Then
	sMailBody+=  "ADRESSE_FACTURATION : SPB Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut
Else 
	sMailBody+=  "ADRESSE_FACTURATION : SPB Mobistore Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut
End If

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+= "REFERENCE_SIN_SPB : " + sIdSin + sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut

// [PC151549]
If sTypMail <> "CMDBST" Then
	sMailBody+= "E-MAIL_EMETTEUR : assurancemobistore@spb.fr" + sSaut
End If

/*------------------------------------------------------------------*/
/* 4 : Personne MOBISTORE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "COORDONNEES_BOUTIQUE : " + sSaut

sMailBody+= "NUM_TEL : " + dwChild.GetItemString ( lRow2, "ADR_TEL" ) + sSaut // [VDoc7065][PC10]

sMailBody+= "E-MAIL : " + sMailDest + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut 
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + sSaut
sMailBody+= "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + sSaut
sMailBody+="ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" )) + sSaut
sMailBody+= "ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" )) + sSaut
sMailBody+= "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" )  + sSaut
sMailBody+= "VILLE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) ) + sSaut
sMailBody+= "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" ) + sSaut
sMailBody+= "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" ) + sSaut // [PI056]
sMailBody+=sSaut

sMailBody+= "-- LES MONTANTS SONT EXPRIMES EN EUROS --" + sSaut


/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* Récupération du libellé du type d'appareil                       */
/* (l'Evaluate+LookUpDisplay ne fonctionne pas (!?)                 */
/*------------------------------------------------------------------*/
sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+="APPAREIL_A_REMPLACER : " + Upper ( sVal ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
sMailBody+=sSaut


/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow3 = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow3 > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow3, "MT_VAL_PUBLIQUE" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0


sMailBody+=sSaut
sMailBody+= "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut

/*------------------------------------------------------------------*/
/* 8 : GSM à remettre au client												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "APPAREIL_A_REMETTRE_AU_CLIENT : " + sSaut // [VDoc7065][PC10]

sMailBody+=sSaut
sMailBody+= "CLIENT PASSE AU MAGASIN : " + sSaut
sMailBody+="CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody+="NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="Cordialement," + sSaut
sMailBody+=sSaut
sMailBody+="Service Assurance " + sLibProd + "."


// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If


Return bRet

end function

private function boolean uf_validation_finale_converlance_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Converlance_Mail  (PRIVATE)
//* Auteur        : FPI
//* Date          : 27/06/2012
//* Libellé       : MAIL pour Converlance
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 	// [PC10-2]
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF   21/08/2014   [ITSM231230]
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//*-----------------------------------------------------------------


Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin, sNomMagasin, sIdGti, sIdEvt, sFiltreOrigdddw
String  sIdDetail, sRech, sMailDest,  sVal, sTypApp, sLibTypApp
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail, lIdTypMail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Decimal{2}	dcMtMaxTTC
DataWindowChild dwChild
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Integer iIdAppli
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDCVC"
iIdAppli=2

bRet = True

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
sFiltre = "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'CVC'" 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then
	// Rajout JFF !!!
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()	
	Return TRUE
End If

// [VDOC16132]
Choose Case idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART")
	Case 'TEL'
		lIdTypMail=1
		sMailObjet='AIG SPB_CONVERLANCE_ASSURANCE_N°' + sIdSin + ' (Proposition de remplacement Téléphone)'
	Case 'CAF'
		lIdTypMail=2
		sMailObjet='AIG SPB_CONVERLANCE_ASSURANCE_N°' + sIdSin + ' (Choix remplacement)'
	Case 'AEF'
		lIdTypMail=3
		sMailObjet='AIG SPB_CONVERLANCE_ASSURANCE_N°' + sIdSin + ' (Diagnostic/Expertise)'
	Case Else
		lIdTypMail=4
		sMailObjet='AIG SPB_CONVERLANCE_ASSURANCE_N°' + sIdSin + ' (Proposition de remplacement Nomade)'
End Choose
// :[VDOC16132]

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

If lIdTypMail=1 or lIdTypMail=4 Then // TEL - 3 mobiles proposés
	For lCptCmd = 1 To 3
		lRow = idw_LstwCommande.InsertRow ( 0 )
		idw_LstwCommande.SetItem ( lRow, "ID_MARQ_ART", "" )
		idw_LstwCommande.SetItem ( lRow, "ID_MODL_ART", "" )
		idw_LstwCommande.SetItem ( lRow, "ID_REF_FOUR", "" )
		idw_LstwCommande.SetItem ( lRow, "MT_TTC_CMDE", 0 )
	Next
End if
	
lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	


/*------------------------------------------------------------------*/
/* 1.2 #1 : adresse de facturation.                                 */
/*------------------------------------------------------------------*/
sMailBody+= "ADRESSE_FACTURATION : SPB Mobistore Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+= "REFERENCE_SIN_SPB : " + sIdSin  +sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+="E-MAIL_EMETTEUR : assurancemobistore@spb.fr" + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne MOBISTORE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "COORDONNEES_BOUTIQUE : " + sSaut

sMailBody+= "NUM_TEL : " + dwChild.GetItemString ( lRow2, "ADR_TEL" ) + sSaut 

sMailBody+="E-MAIL : " + sMailDest + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" ))  + sSaut
sMailBody+= "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" ))  + sSaut
sMailBody+= "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" ))  + sSaut
sMailBody+= "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" ))  + sSaut
sMailBody+="ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ))  + sSaut
sMailBody+= "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" )   + sSaut
sMailBody+= "VILLE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) )  + sSaut
sMailBody+= "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" )  + sSaut
sMailBody+="DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" )  + sSaut  // [PI056]
sMailBody+=sSaut

sMailBody+="-- LES MONTANTS SONT EXPRIMES EN EUROS --"  + sSaut


/*------------------------------------------------------------------*/
/* 6 : Appareil à traiter														  */
/*------------------------------------------------------------------*/
If lIdTypMail =2 Then
	
	/*------------------------------------------------------------------*/
	/* Récupération du libellé du type d'appareil                       */
	/*------------------------------------------------------------------*/
	sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
	idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
	sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
	dwChild.SetFilter ( "" ) 
	dwChild.Filter ( ) 
	lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
	sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
	dwChild.SetFilter ( sFiltreOrigDDDW  ) 
	dwChild.Filter ( ) 

	sMailBody+="APPAREIL_A_REMETTRE_AU_CLIENT : " + sSaut
	sMailBody+=sSaut
End if

If lIdTypMail=3 Then // AEF
	sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" )
	sLibTypApp = Space ( 35 )
	SQLCA.IM_S01_CODECAR ("-AR", Upper ( sTypApp ), sLibTypApp )
	If IsNull ( sLibTypApp ) Then sLibTypApp = ""


	sMailBody+=sSaut
	sMailBody+=  "APPAREIL_A_EXPERTISER : " + sLibTypApp + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) )  + sSaut
	sMailBody+=sSaut

	sMailBody+=  "DESCRIPTION_DU_DOMMAGE : "  + sSaut
	sVal = Upper ( idw_LstwCommande.GetItemString ( 1, "PROBLEME" ) )
	Do While Len ( sVal ) > 0 
		sMailBody+=  Left ( sVal, 60 )  + sSaut
		sVal = Mid ( sVal, 61, Len ( sVal ) ) 
	Loop
End if

If lIdTypMail=4 or lIdTypMail= 1 Then // Nomade ou Tel
	sMailBody+=sSaut
	
	If lIdTypMail=4 Then
		sMailBody+= "APPAREIL_A_REMPLACER : " + + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
	Else
		sMailBody+=  "MOBILE_A_REMPLACER : " + + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
	End if

	sMailBody+=sSaut
	sMailBody+=  "PROPOSITION_1 : " + sSaut
	sMailBody+=  "MARQUE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) ) + sSaut
	sMailBody+=  "PRIX_TTC_1 : " + String ( idw_LstwCommande.GetItemDecimal ( 1, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
	sMailBody+=  "REFEFERENCE_MOBISTORE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_REF_FOUR" ) ) + sSaut

	sMailBody+=sSaut

	sMailBody+=  "PROPOSITION_2 : " + sSaut
	sMailBody+=  "MARQUE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MODL_ART" ) ) + sSaut
	sMailBody+= "PRIX_TTC_2 : " + String ( idw_LstwCommande.GetItemDecimal ( 2, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
	sMailBody+=  "REFEFERENCE_MOBISTORE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_REF_FOUR" ) ) + sSaut

	sMailBody+=sSaut

	sMailBody+=  "PROPOSITION_3 : " + sSaut
	sMailBody+=  "MARQUE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MODL_ART" ) ) + sSaut
	sMailBody+=  "PRIX_TTC_3 : " + String ( idw_LstwCommande.GetItemDecimal ( 3, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
	sMailBody+=  "REFEFERENCE_MOBISTORE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_REF_FOUR" ) ) + sSaut
End if

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

// [ITSM231230] pose d'un mouchard bloquant sur ITSM.
If dcMtMaxTTC = 0 Then
	stMessage.sTitre  	= "ITSM231230 Mouchard A.Haize"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= Ok!
	stMessage.sCode = "WSIN775"
	F_Message ( stMessage )
	bRet = False
	Return bRet
End If

sMailBody+=sSaut
sMailBody+="MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut

sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* 8 : GSM à remettre au client												  */
/*--------------------------------------*/
sMailBody+=sSaut
Choose Case lIdTypMail
	Case 1
		sMailBody+= "MOBILE_A_REMETTRE_AU_CLIENT : " + sSaut 
	Case 4
		sMailBody+= "APPAREIL_A_REMETTRE_AU_CLIENT : " + sSaut 
	Case Else
		sMailBody+=sSaut
		sMailBody+= "APPAREIL_A_REMETTRE_AU_CLIENT SI REMPLACEMENT ACCEPTE : " + sSaut 
End Choose

sMailBody+=sSaut
sMailBody+= "CLIENT PASSE AU MAGASIN : " + sSaut
sMailBody+= "CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody+= "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

If lIdTypMail=3 Then
	/*------------------------------------------------------------------*/
	/* 9 : Etat de retour pour CONVERLANCE 					     */
	/*------------------------------------------------------------------*/
	sMailBody+=sSaut
	sMailBody+=sSaut
	sMailBody+= "=========================================================================" + sSaut
	sMailBody+="===== ZONE RESERVEE A MOBISTORE POUR LE RESULTAT DE L'EXPERTISE ======" + sSaut
	sMailBody+= "=========== MARQUER D'UN 'X' L'ETAT DE PRESTATION CORRESPONDANT =========" + sSaut
	sMailBody+="=========================================================================" + sSaut
	sMailBody+=sSaut
	sMailBody+="DATE_EXPERTISE :   _ _ / _ _ / _ _ _ _" + sSaut
	sMailBody+=sSaut
	sMailBody+= "ETAT_PRESTATION_1 :  |_| SUITE EXPERTISE, REMPLACEMENT ACCEPTE" + sSaut
	sMailBody+=sSaut
	sMailBody+= "ETAT_PRESTATION_2 :  |_| SUITE EXPERTISE, REMPLACEMENT REFUSE" + sSaut
End if

//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If



Return bRet

end function

private function boolean uf_validation_finale_msg_dp206 (string asvalcar);//*-----------------------------------------------------------------
//*
//* Fonction		: uf_validation_finale_msg_dp206 (PRIVATE)
//* Auteur			: FPI
//* Date				: 17/07/2012
//* Libellé			: 
//* Commentaires	: [PC801]
//*
//* Arguments		: asValcar	colonne Val_car de l'option 206
//*
//* Retourne		: sPos si pb appel de PS
//*
//*-----------------------------------------------------------------
// 		26/11/2012	FPI	[PC801].Mantis5942
//		14/05/2013	FPI	 [ITSM156344] Si dossier sans suite pas de contrôle.
//*-----------------------------------------------------------------

Integer iNbSinMax
Long lNbAutreSin
n_cst_string nvString
Date dDteAdh, dDteResult
Decimal dcDurPerRnv_Adh, dcIdSin, dcIdProd, dcIdEts, dcIdGti
String sUntPerRnv_Adh, sIdAdh
Long lCptMax, lCpt, lRow
Datetime dtDteAdhRenouv, dtDteSurv
Boolean bMsg, bRet

iNbSinMax=1
bRet=TRUE
lNbAutreSin=0
bMsg=FALSE

if idw_wsin.GetItemNumber(1,"COD_ETAT") = 900 Then return TRUE // [ITSM156344]

if not isnull(asValCar) Then
	iNbSinMax=Integer(nvString.of_getkeyvalue( asValCar, "NB_SIN_MAX", ";")	)
	
	if iNbSinMax=0 Then iNbSinMax=1
End if

If iNbSinMax > 1 Then
	// Si le nb max de sin > 1, on regarde les autres sin réglés
	dcIdSin		= idw_wSin.GetItemNumber ( 1, "ID_SIN" )
	dcIdProd		= idw_wSin.GetItemNumber ( 1, "ID_PROD" )
	dcIdEts		= idw_wSin.GetItemNumber ( 1, "ID_ETS" )
	sIdAdh		= idw_wSin.GetItemString ( 1, "ID_ADH" )
	dtDteSurv	= DateTime ( idw_wSin.GetItemDate ( 1, "DTE_SURV_DATE" ) )
	dcIdGti		= idw_lstgti.GetItemNumber ( 1, "ID_GTI" )
	
	dDteAdh		= idw_wSin.GetItemDate ( 1, "DTE_ADH" )
	dcDurPerRnv_Adh		= idw_produit.GetItemNumber ( 1, "DUR_PERRNV_ADH" )
	sUntPerRnv_Adh		   = idw_produit.GetItemString ( 1, "UNT_PERRNV_ADH" )
	/*----------------------------------------------------------------------*/
	/* On calcule la date du dernier renouvellement.                        */
	/* En fonction de l'unité de periode de renouvellement (ANNEE,MOIS,JOUR)*/
	/*----------------------------------------------------------------------*/
	Choose Case sUntPerRnv_Adh
		Case "A"
		  lCptMax = 30
		Case "M"
		  lCptMax = 360
		Case "J"
		 lCptMax = 10950
	End Choose
	
	For	lCpt = 1 To lCptMax
			dDteResult = F_Plus_Date ( dDteAdh, dcDurPerRnv_Adh, sUntPerRnv_Adh )
			If	dDteResult <= idw_wSin.GetItemDate ( 1, "DTE_SURV_DATE" )	Then
				dDteAdh = dDteResult
			Else
				Exit
			End If
	Next
	
	dtDteAdhRenouv = DateTime ( dDteAdh )
	
	lNbAutreSin = 0
	
	//itrTrans.PS_S11_W_GTI_NBSIN ( dcIdSin, dcIdProd, dcIdEts, sIdAdh, dcIdGti, dtDteSurv, dtDteAdhRenouv, iNbAutreSin )
	itrTrans.ps_s01_sinistre_nbsin_regles(  dcIdSin, dcIdProd, dcIdEts, sIdAdh, dtDteSurv, dtDteAdhRenouv, lNbAutreSin ) // [PC801].Mantis5942
	If	Not F_Procedure ( stMessage, itrTrans, "PS_S11_W_GTI_NBSIN" )	Then 
	/*------------------------------------------------------------------*/
	/* Il y a une erreur dans l'appel de la procédure, la structure     */
	/* stMessage vient d'être armée, on affiche le message.             */
	/*------------------------------------------------------------------*/
		f_Message ( stMessage )
		bRet=FALSE
	End if
End if

// Règlement assuré
If idw_wsin.GetItemNumber (1,"COD_ETAT") = 500 and &
	idw_lstinter.Find("COD_INTER='A' And MT_A_REG > 0",1,idw_lstinter.RowCount()) > 0 Then bMsg=TRUE
	
// Première commande de remplacement
lRow = idw_lstwcommande.Find("COD_ETAT <> 'ANN' and ID_TYP_ART <> 'EDI'",1,idw_lstwcommande.RowCount())
If lRow > 0 And (Not bMsg) Then
	If  idw_lstwcommande.GetItemNumber(lRow,"CPT_VALIDE") = 0 Then bMsg=TRUE
End if
	
If bMsg and iNbSinMax <= lNbAutreSin+1 Then
	stmessage.berreurg=FALSE
	stMessage.icon=Information!
	stmessage.scode="CASP600"
	stMessage.sTitre		= "Validation Finale d'un dossier"
	f_message(stMessage)
End if

Return bRet
end function

private function long uf_zn_trt_divsin_franchise_paybox (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_zn_trt_divsin_franchise_paybox (PRIVATE)
//* Auteur			: FPI
//* Date				: 19/07/2012
//* Libellé			: Contrôle de la zone franchise_paybox 
//* Commentaires	: [PC801]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer iAction
Long lRow, lIdProd
String sValActuel, sIdTypListe, sAltListeCodeCar, sIdTypZone

asData = Upper ( asData )
iAction = 0
lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )

// Si décision déjà prise, on ne peut plus modifier.
sValActuel= uf_GestOng_Divers_Trouver ( "FRANCHISE_PAYBOX" ) 
If iAction = 0 And sValActuel = "O" Then
	idw_wDivSin.iiErreur = 0
	iAction = 2
End If	

If iAction = 0 Then
	sIdTypListe	= Space ( 3 ) 
	sAltListeCodeCar = Space ( 1 ) 
	sIdTypZone = Space ( 5 ) 

	SQLCA.PS_S_RECUP_PARAM_ZONE_DIV_PRO ( lIdProd, "mode_paiement", sIdTypListe, sAltListeCodeCar, sIdTypZone )
	
	If sIdTypListe = "-WB" Then
		iAction = 1
		idw_wDivSin.iiErreur = 17
		Return iAction 
	End IF 
	
	stMessage.sTitre		= "Franchise paybox"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sCode		= "WSIN605"

	If F_Message ( stMessage ) = 2 Then
		lRow = idw_wDivSin.Find ( "UPPER ( NOM_ZONE ) = 'FRANCHISE_PAYBOX'", 1, idw_wDivSin.Rowcount () )
		idw_wDivSin.SetItem ( lRow, "VAL_CAR", sValActuel )
		idw_wDivSin.iiErreur = 0
		iAction = 2
	End If
End IF

Return iAction

end function

private function long uf_zn_trt_divsin_dim_sup_150cm (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_dim_sup_150cm (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 08/08/2012
//* Libellé			: 
//* Commentaires	: [BLCODE]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin

asData = Upper ( asData )
iAction = 0

lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND ID_FOUR IN ( 'BLC') AND ID_REF_FOUR = 'A_DIAGNOSTIQUER'", 1, idw_LstwCommande.RowCount () ) 

If lRow > 0 Then
	idw_wDivSin.iiErreur = 3
	iAction = 1
End If

Return iAction

end function

private function long uf_zn_trt_divsin_poids_sup_30kg (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_zn_trt_divsin_poids_sup_30kg (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 08/08/2012
//* Libellé			: 
//* Commentaires	: [BLCODE]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin

asData = Upper ( asData )
iAction = 0

lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND ID_FOUR IN ( 'BLC') AND ID_REF_FOUR = 'A_DIAGNOSTIQUER'", 1, idw_LstwCommande.RowCount () ) 

If lRow > 0 Then
	idw_wDivSin.iiErreur = 3
	iAction = 1
End If

Return iAction

end function

private function boolean uf_validation_finale_ore_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_ore_mail  (PRIVATE)
//* Auteur        : FPI
//* Date          : 21/08/2012
//* Libellé       : Gestion Particulière pour Orange Réunion
//* Commentaires  : [PC767]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
Decimal dcIdSin
String  sFiltreOrig, sFiltre, sRetour
Long 	  lTotCmd, lDeb, lFin, lIdSeq, lIdInfoSpbFrn
Integer iRet

bRet=TRUE
sRetour=Fill(" ",50)

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   <> 'ANN' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'ORE' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd > 0 Then 

lIdSeq=idw_LstwCommande.GetItemNumber(1,"ID_SEQ")
dcIdsin = idw_LstwCommande.GetItemDecimal(1,"ID_SIN")

	iRet = SQLCA.PS_S16_MAILPUSH_ORANGE_REUNION( &
		dcIdsin,			&
		lIdSeq,			&
		sRetour 			&
		)
		
	//bRet=(iRet	= 0) // TODO : Cas particulier à gérer ???
	
	If bRet Then 
		bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
	End If
End if

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

Return bRet

end function

private function boolean uf_validation_finale_omt_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_omt_mail  (PRIVATE)
//* Auteur        : FPI
//* Date          : 24/08/2012
//* Libellé       : Gestion Particulière pour Outremer Telecom
//* Commentaires  : [PC874]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			FPI	19/02/2013	[PC874_TEL] Ajout de la commande de tel
//*-----------------------------------------------------------------

Boolean bRet, bCAF
Decimal dcIdSin, dcMtMaxTtc, dcMtLu,dcMtMaxLu
String  sFiltreOrig, sFiltre, sRetour, sVal,sIdGti,sIdDetail, sRech,sMontantIndemnisation
Long 	  lTotCmd, lDeb, lFin, lIdSeq, lRow, lIdGti, lIdDetail, lTotDetail, lCptDet
Integer iRet
n_cst_string lnvpfcstring
u_datawindow udwnull
s_plafond_pec stPlafPec

bRet=TRUE
sRetour=Fill(" ",50)
SetNull (udwnull)

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART in ('CAF','TEL') AND " + &		
			 "COD_ETAT   <> 'ANN' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'OMT' " 
		
/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then 
	bCAF=TRUE
	lTotCmd = 0 // 23/11/2012 - on génère un fichier de commande
Else
	sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   <> 'ANN' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'OMT' " 
	 idw_LstwCommande.SetFilter ( sFiltre )
	idw_LstwCommande.Filter ()

	lTotCmd = idw_LstwCommande.RowCount () 
End if

if lTotCmd=0 Then 
		idw_LstwCommande.SetFilter ( sFiltreOrig )
		idw_LstwCommande.Filter ()
		return TRUE
End if

lIdSeq=idw_LstwCommande.GetItemNumber(1,"ID_SEQ")
dcIdsin = idw_LstwCommande.GetItemDecimal(1,"ID_SIN")

If bCaf Then
	// --------------------------
	// Commande d'appareil
	// --------------------------

	/* -----------------------------------
	 Calcul du mt indemnisation
	 --------------------------------------*/
 
	// mémorisation de la garantie
	lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
	sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
	// mémorisation de l'événement
	lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
	sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )
	
	lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
	dcMtMaxTTC = 0 
	If lRow > 0 Then
		dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
	End If
	
	sVal = ""
	lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
	sVal = "[###]"
	
	If lRow > 0 Then
		lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
	End If
	
	// [PC301].[V15_EVOL_VETUSTE]
	lTotDetail = idw_wDetail.RowCount ()
	dcMtLu = 0
	dcMtMaxLu = 0
	For lCptDet = 1 To lTotDetail	
		
		sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
						"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
						"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
			
		lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
		If lRow > 0 Then
			dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
			If dcMtLu > dcMtMaxLu Then
				dcMtMaxLu = dcMtLu 
			End If
		End If					
		
	Next
	
	If dcMtMaxLu > 0 Then
		lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
	End If
	
	stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )
	
	If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
	If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
	If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
	If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
	If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
	If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0
	
	If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0
	
	sMontantIndemnisation=String ( dcMtMaxTTC , "#####0.00" ) 

	// Appel de la PS de mailpush

	iRet = SQLCA.PS_S18_MAILPUSH_OUTREMER_TELECOM( &
		dcIdsin,			&
		lIdSeq,			&
		sMontantIndemnisation, &
		sRetour 			&
		)
Else
	// --------------------------
	// Réparation d'appareil
	// --------------------------

	iRet = SQLCA.PS_S19_MAILPUSH_SAV_OUTREMER_TELECOM( &
		dcIdsin,			&
		lIdSeq,			&
		sRetour 			&
		)
End if

//bRet=(iRet	= 0) // TODO : Cas particulier à gérer ???

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

Return bRet

end function

private function boolean uf_validation_finale_mcprotect_mail_tn ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_mcprotect_mail_tn  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 19/06/2009 16:43:53
//* Libellé       : Gestion Particulière pour MOBISQUARE.
//* Commentaires  : [MOBISQUARE]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//* #2    JFF    26/10/09    [DCMP090651] Modif du mail
//			FPI	19/07/2011	[PC514] Suppr du message d'erreur si ZN_TMP_CAS_GESTION absent en cas de réparation
//			JFF	03/09/2012	[PC853]
//*-----------------------------------------------------------------

Boolean bRet
String  sCasGestion
Long lRow

sCasGestion = This.uf_GestOng_Divers_Trouver ( "ZN_TMP_CAS_GESTION" )
bRet = False

// [PC514] // [PC853]
lRow=idw_lstwCommande.Find("COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR  in ('ACU', 'FPC', 'CYT' )",1,idw_lstwCommande.RowCount())

If lRow <=0 Then return TRUE
// :[PC514]

// #2
If sCasGestion = "" Then
	
	// #3
	If this.uf_GetAutorisation2(208) Then Return TRUE

	stMessage.sTitre		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YesNo!
	stMessage.sVar[1]		= idw_Produit.GetItemString ( 1, "LIB_LONG" )
	stMessage.sVar[2]		= "MCPROTECT"
	stMessage.sCode		= "COMD301"

	If F_Message ( stMessage ) = 2 Then
		Return FALSE
	Else 
		Return TRUE
	End If

End  If 

Choose Case sCasGestion

	Case "MAIL_AVEC_PROPO"
		bRet = This.uf_Validation_Finale_MCPROTECT_Mail_TN1 ()

	Case "MAIL_SANS_PROPO"
		bRet = This.uf_Validation_Finale_MCPROTECT_Mail_TN2 ()

End Choose

Return bRet

end function

private function boolean uf_validation_finale_mcprotect_mail_tn1 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MCPROTECT_Mail_TN1  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 19/06/2009 16:43:53
//* Libellé       : Gestion Particulière pour MOBISQUARE.
//* Commentaires  : [MOBISQUARE]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//* #2    JFF    26/10/09    [DCMP090651] Modif du mail
//* #3    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		FPI	19/07/2011	[PC514] Ajout de ACUBE
//			JFF	03/09/2012	[PC853]
//		FPI	26/02/2013	[PC853_1] Pas d'option 119 sur les prod 481__
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest, sLibTypApp
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sResponsable, sIdFour
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
String libPersonneMobisquare

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 116 )

// [PC853_1]
If lDeb<=0 Then 
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 219 )
End if
// :[PC853_1]

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sTypMail = "PEC_MCP1"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
// [DCMP090283] // [PC853]
sFiltre = "ID_TYP_ART <> 'CAF' AND " + &	
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			"ID_FOUR  in ('ACU', 'FPC', 'CYT') AND " + &
			 "ISNUMBER ( PROBLEME )"// [PC514] - Ajout de ACU


/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE
For lCptCmd = 1 To 3
	lRow = idw_LstwCommande.InsertRow ( 0 )
	idw_LstwCommande.SetItem ( lRow, "ID_MARQ_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_MODL_ART", "" )
	idw_LstwCommande.SetItem ( lRow, "ID_REF_FOUR", "" )
	idw_LstwCommande.SetItem ( lRow, "MT_TTC_CMDE", 0 )
Next

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdFour = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" ) 

/*------------------------------------------------------------------*/
/* Le mail sera construit dans une DW qui sera directement (d'un    */
/* coup écrite sur disque). Je préfère cette option plutôt que      */
/* d'écrire un fichier texte progressivement sur disque avec des    */
/* FileWrite. Je trouve la solution de la DW plus sûr.              */
/*------------------------------------------------------------------*/

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
	sNomMagasin = ""
	sResponsable = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	sResponsable = dwChild.GetItemString ( lRow2, "RESPONSABLE" )
End If	

If IsNull ( sMailDest ) Then sMailDest = ""
If IsNull ( sTelDest ) Then sTelDest = ""
If IsNull ( sNomMagasin ) Then sNomMagasin = ""

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC16132]
Choose Case sIdFour
	Case "ACU"
		sMailObjet = "AIG_SPB_MCPROTECT_ACUBE_ASSURANCE_N°" + sIdSin
		libPersonneMobisquare="PERSONNE_MCPROTECT_ACUBE_A_CONTACTER : "

	Case "FPC"
		sMailObjet = "AIG_SPB_MC_PROTECT_FPC_GROUP_ASSURANCE_N°" + sIdSin
		libPersonneMobisquare="PERSONNE_MC_PROTECT_FPC_GROUP_A_CONTACTER : "

	Case "CYT"
		sMailObjet = "AIG_SPB_MC_PROTECT_CYBERTEAM_ASSURANCE_N°" + sIdSin
		libPersonneMobisquare="PERSONNE_MC_PROTECT_CYBERTEAM_A_CONTACTER : "

End Choose
// :[VDOC16132]
// :[PC514]



/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += "REFERENCE_SIN_SPB : " + sIdSin 

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_SPB_A_CONTACTER : " 
sMailBody += sSaut
sMailBody += "N°_TELEPHONE_SPB : " + String ( F_GetItem3 ( idw_Produit, 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) 
sMailBody += sSaut
sMailBody += "E-MAIL_EMETTEUR : mcprotect@spb.eu" 
sMailBody += sSaut
sMailBody += "(M1)" 


/*------------------------------------------------------------------*/
/* 4 : Personne MOBISQUARE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
//sMailBody += "PERSONNE_MOBISQUARE_CYBERPHONE_A_CONTACTER : " + sResponsable
sMailBody += libPersonneMobisquare + sResponsable // [PC514]
sMailBody += sSaut
sMailBody += "NUM_TEL : " + sTelDest 
sMailBody += sSaut
sMailBody += "E-MAIL : " + sMailDest 


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody += sSaut 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "NOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) 
sMailBody += sSaut
sMailBody += "PRENOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_1 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_2 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_3 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
sMailBody += sSaut
sMailBody += "CODE POSTAL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += "TEL_ASSURE : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
dVal = Date ( Left ( F_GetItem3 ( idw_wSin, 1, "DTE_SURV" ), 10 ) )
sMailBody += "DATE_SURVENANCE_SINISTRE : " + String ( dVal , "dd/mm/yyyy" ) 
sMailBody += sSaut
dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( dVal, "dd/mm/yyyy" ) 
sMailBody += sSaut

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "-- LES MONTANTS SONT EXPRIMES EN EUROS --" 
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à Traiter														  */
/*------------------------------------------------------------------*/
sMailBody += sSaut 

sMailBody += sSaut
sMailBody += "APPAREIL_A_REMPLACER : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) 
sMailBody += sSaut

sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" )
sLibTypApp = Space ( 35 )
SQLCA.IM_S01_CODECAR ("-AR", Upper ( sTypApp ), sLibTypApp )
If IsNull ( sLibTypApp ) Then sLibTypApp = ""
sMailBody += "TYPE DE L_A_APPAREIL A REMPLACER : " + Upper ( sLibTypApp )

sMailBody += sSaut
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += "PROPOSITION_1 : "
sMailBody += sSaut
sMailBody +=  "MARQUE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) ) 
sMailBody += sSaut
sMailBody +=  "PRIX_TTC_1 : " + String ( idw_LstwCommande.GetItemDecimal ( 1, "MT_TTC_CMDE" ), "#####0.00" ) 
sMailBody += sSaut
sMailBody +=  "REFEFERENCE_MCPROTECT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_REF_FOUR" ) ) 

sMailBody += sSaut

sMailBody += sSaut
sMailBody +=  "PROPOSITION_2 : " 
sMailBody += sSaut
sMailBody +=  "MARQUE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MODL_ART" ) ) 
sMailBody += sSaut
sMailBody +=  "PRIX_TTC_2 : " + String ( idw_LstwCommande.GetItemDecimal ( 2, "MT_TTC_CMDE" ), "#####0.00" ) 
sMailBody += sSaut
sMailBody +=  "REFEFERENCE_MCPROTECT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_REF_FOUR" ) ) 

sMailBody += sSaut

sMailBody += sSaut
sMailBody +=  "PROPOSITION_3 : " 
sMailBody += sSaut
sMailBody +=  "MARQUE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MODL_ART" ) ) 
sMailBody += sSaut
sMailBody +=  "PRIX_TTC_3 : " + String ( idw_LstwCommande.GetItemDecimal ( 3, "MT_TTC_CMDE" ), "#####0.00" ) 
sMailBody += sSaut
sMailBody +=  "REFEFERENCE_MCPROTECT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_REF_FOUR" ) ) 


/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )


If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
sMailBody += sSaut
// #2 [DCMP090651] Modif du mail
//sMailBody += "APPAREIL_A_REMETTRE_AU_CLIENT, LE CLIENT REGLE SON APPAREIL SUR PLACE AU MAGASIN ET SE FERA REMBOURSER PAR SPB SUR PRESENTATION DE LA FACTURE" 
sMailBody += "APPAREIL_A_REMETTRE_AU_CLIENT"
sMailBody += sSaut


/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
//sMailBody += sSaut
//sMailBody += sSaut
// sMailBody += "CLIENT_PASSE_AU_MAGASIN : " 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
//
/*
sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = "AUCUNE DATE PRECISEE PAR L'ASSURE"
sMailBody += "APPAREIL_DEPOSE_LE : " + sVal 
sMailBody += sSaut
*/

sMailBody += "CODE_DU_MAGASIN : " + Upper ( String ( F_GetItem3 ( idw_WSin, 1, "ID_ORIAN_BOUTIQUE" ) ) ) 
sMailBody += sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody += sSaut
sMailBody += "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) 
sMailBody += sSaut

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_mcprotect_mail_tn2 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_MCPROTECT_Mail_TN2 (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 19/06/2009 16:43:53
//* Libellé       : Gestion Particulière pour MOBISQUARE.
//* Commentaires  : [MOBISQUARE]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//* #2    JFF    26/10/09    [DCMP090651] Modif du mail
//* #3    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		FPI	26/02/2013	[PC853_1] Pas d'option 119 sur les prod 481__
//		FPI	05/12/2014	[VDOC16132] CHARTIS devient AIG dans l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest, sLibTypApp
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sResponsable, sIdFour
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
String libPersonneMobisquare

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 116 )

// [PC853_1]
If lDeb<=0 Then 
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 219 )
End if
// :[PC853_1]

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sTypMail = "PEC_MCY2"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR  IN ( 'ACU', 'FPC', 'CYT')" 
			 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sVar[1]    = "MCPROTECT"
	stMessage.sVar[2]    = 	stMessage.sVar[1]
	stMessage.sCode		= "COMD311"

	If F_Message ( stMessage ) = 2 Then	
		// ON stoppe
		Return FALSE
	Else
		// ON continue sans mail
		Return TRUE
	End If
End If	


/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD320"

	F_Message ( stMessage ) 
	Return FALSE
End If

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdFour = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" ) 

/*------------------------------------------------------------------*/
/* Le mail sera construit dans une DW qui sera directement (d'un    */
/* coup écrite sur disque). Je préfère cette option plutôt que      */
/* d'écrire un fichier texte progressivement sur disque avec des    */
/* FileWrite. Je trouve la solution de la DW plus sûr.              */
/*------------------------------------------------------------------*/

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
	sNomMagasin = ""
	sResponsable = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	sResponsable = dwChild.GetItemString ( lRow2, "RESPONSABLE" )
End If	

If IsNull ( sMailDest ) Then sMailDest = ""
If IsNull ( sTelDest ) Then sTelDest = ""
If IsNull ( sNomMagasin ) Then sNomMagasin = ""

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
// [VDOC16132]
Choose Case sIdFour
	Case "ACU"
		sMailObjet = "AIG_SPB_MCPROTECT_ACUBE_ASSURANCE_N°" + sIdSin
		libPersonneMobisquare="PERSONNE_MCPROTECT_ACUBE_A_CONTACTER : "

	Case "FPC"
		sMailObjet = "AIG_SPB_MC_PROTECT_FPC_GROUP_ASSURANCE_N°" + sIdSin
		libPersonneMobisquare="PERSONNE_MC_PROTECT_FPC_GROUP_A_CONTACTER : "

	Case "CYT"
		sMailObjet = "AIG_SPB_MC_PROTECT_CYBERTEAM_ASSURANCE_N°" + sIdSin
		libPersonneMobisquare="PERSONNE_MC_PROTECT_CYBERTEAM_A_CONTACTER : "

End Choose
// :[VDOC16132]
// :[PC514]

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += "REFERENCE_SIN_SPB : " + sIdSin 

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "PERSONNE_SPB_A_CONTACTER : " 
sMailBody += sSaut
sMailBody += "N°_TELEPHONE_SPB : " + String ( F_GetItem3 ( idw_Produit, 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) 
sMailBody += sSaut
sMailBody += "E-MAIL_EMETTEUR : mcprotect@spb.eu" 
sMailBody += sSaut
sMailBody += "(M1)" 


/*------------------------------------------------------------------*/
/* 4 : Personne MOBISQUARE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody += sSaut
sMailBody += sSaut
//sMailBody += "PERSONNE_MOBISQUARE_CYBERPHONE_A_CONTACTER : " + sResponsable
sMailBody += libPersonneMobisquare + sResponsable // [PC514]
sMailBody += sSaut
sMailBody += "NUM_TEL : " + sTelDest 
sMailBody += sSaut
sMailBody += "E-MAIL : " + sMailDest 


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody += sSaut 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "NOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) 
sMailBody += sSaut
sMailBody += "PRENOM_ASSURE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_1 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_2 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
sMailBody += sSaut
sMailBody += "ADRESSE_CLIENT_3 : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
sMailBody += sSaut
sMailBody += "CODE POSTAL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += "TEL_ASSURE : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
sMailBody += sSaut
dVal = Date ( Left ( F_GetItem3 ( idw_wSin, 1, "DTE_SURV" ), 10 ) )
sMailBody += "DATE_SURVENANCE_SINISTRE : " + String ( dVal , "dd/mm/yyyy" ) 
sMailBody += sSaut
dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "DATE_ACHAT_APPAREIL_SINISTRE : " + String ( dVal, "dd/mm/yyyy" ) 
sMailBody += sSaut

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "-- LES MONTANTS SONT EXPRIMES EN EUROS --" 
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : Appareil à Traiter														  */
/*------------------------------------------------------------------*/
sMailBody += sSaut 

sMailBody += sSaut
sMailBody += "APPAREIL_A_REMPLACER : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) 
sMailBody += sSaut

sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" )
sLibTypApp = Space ( 35 )
SQLCA.IM_S01_CODECAR ("-AR", Upper ( sTypApp ), sLibTypApp )
If IsNull ( sLibTypApp ) Then sLibTypApp = ""
sMailBody += "TYPE DE L_A_APPAREIL A REMPLACER : " + Upper ( sLibTypApp )

sMailBody += sSaut
sMailBody += sSaut

/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
sMailBody += sSaut
// #2 [DCMP090651] Modif du mail
//sMailBody += "APPAREIL_A_REMETTRE_AU_CLIENT, LE CLIENT REGLE SON APPAREIL SUR PLACE AU MAGASIN ET SE FERA REMBOURSER PAR SPB SUR PRESENTATION DE LA FACTURE" 
sMailBody += "APPAREIL_A_REMETTRE_AU_CLIENT"
sMailBody += sSaut


/*------------------------------------------------------------------*/
/* 8 : Client passe au magasin												  */
/*------------------------------------------------------------------*/
//sMailBody += sSaut
//sMailBody += sSaut
// sMailBody += "CLIENT_PASSE_AU_MAGASIN : " 
sMailBody += sSaut

//sMailBody += sSaut
//sMailBody += sSaut
//
/*
sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = "AUCUNE DATE PRECISEE PAR L'ASSURE"
sMailBody += "APPAREIL_DEPOSE_LE : " + sVal 
sMailBody += sSaut
*/

sMailBody += "CODE_DU_MAGASIN : " + Upper ( String ( F_GetItem3 ( idw_WSin, 1, "ID_ORIAN_BOUTIQUE" ) ) ) 
sMailBody += sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody += sSaut
sMailBody += "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) 
sMailBody += sSaut

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_sav_carrefour_mail2 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Sav_Carrefour_Mail2  (PRIVATE)
//* Auteur        : FPI
//* Date          : 12/10/2012
//* Libellé       : MAIL pour Sav Carrefour
//* Commentaires  : [PC846/864]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin, sNomAssure
String  sRech, sMailDest,sVal
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
DataWindowChild dwChild
U_Datawindow udwNull
n_cst_string lnvPFCString
s_pass stPass
Long lTotDetail, lCptDet
Integer iIdAppli
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDSCR"
iIdAppli=2

bRet = True

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART ='EDI' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'SCR'" 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then Return TRUE

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "PRENOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "NOM" )

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 224 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	

// Contrôle possibilité envoi de mail
bRet=(sMailDest <> "" and sMailFrom <> "")
If not bRet Then Return False

sMailObjet="Dossier n° " + sIdSin + " -  Garantie Carrefour Petit Electroménager" 

sMailBody+= "Bonjour," + sSaut
sMailBody+=  sSaut
sMailBody+= "SPB est intervenu sur le dossier n°" + sIdSin + " de " + sNomAssure
sMailBody+= ", merci de consulter ce dossier sur l'extranet." + sSaut
sMailBody+=  sSaut
sMailBody+= "Cordialement" + sSaut
sMailBody+=  sSaut
sMailBody+= "Votre gestionnaire" + sSaut


// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If


Return bRet
end function

private function boolean uf_validation_finale_lbe_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_lbe_mail  (PRIVATE)
//* Auteur        : FPI
//* Date          : 23/10/2012
//* Libellé       : MAIL pour carte cadeau leclerc [PC884]
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			FPI		13/06/2013	[DT044_1]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin
String sVal,sMailDest,sSql
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sBoiteMailCc, sLibPolice, sVilleBoutique
Blob    bMailBody
Long 	  lRow, lTotCmd, lCptCmd,    iIdAppli, lDeb, lFin, lIdDetail, lIdGti, lIdPolice
n_cst_string lnvPFCString
Decimal dcMtPec
DatawindowChild ldwcBoutique

/*F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sBoiteMailCc	= lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
*/

sBoiteMail="noreply@spb.eu" 	// [PM191-4] "CSPB"

sTypMail = "CMDLBE"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'LBE' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then Return TRUE

lIdDetail=idw_LstwCommande.GetItemNumber(1,"ID_DETAIL")
lIdGti=idw_LstwCommande.GetItemNumber(1,"ID_GTI")

// Récup du mt de PEC
dcMtPec=idw_LstwCommande.getItemDecimal(1,"MT_TTC_CMDE")

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// Récup de l'adr_mail
lRow=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())

If lRow > 0 Then sMailDest = idw_lstinter.GetItemString(lRow,"ADR_MAIL")
If IsNull ( sMailDest ) Then sMailDest = ""

If sMailDest = "" Then return TRUE

// Le libpolice
sLibPolice = ""
lRow = idw_Garantie.Find ( "ID_REV = " + String ( idw_wSin.GetItemNumber ( 1, "ID_REV" )) + " AND " + &
									"ID_GTI = " + String ( lIdGti ), 1, idw_Garantie.RowCount () )
If lRow > 0 Then
	lIdPolice = idw_Garantie.GetItemNumber ( lRow, "ID_POLICE" )
	lRow = idw_Police.Find ( "ID_POLICE = " + String ( lIdPolice  ), 1, idw_Police.Rowcount() )
	If lRow > 0 Then
		sLibPolice = idw_Police.GetItemString ( lRow, "LIB_POLICE" )
	End If
End If 

// Ville de boutique
sVilleBoutique=""
idw_wsin.GetChild("ID_ORIAN_BOUTIQUE",ldwcBoutique)
lRow=ldwcBoutique.Find("ID_BOUTIQUE=" + String(idw_wsin.GetItemNumber(1,"ID_ORIAN_BOUTIQUE")),1,ldwcBoutique.RowCount())
If lRow > 0 Then
	sVilleBoutique=ldwcBoutique.GetItemString(lRow,"ADR_VILLE")
End if

sMailObjet = "Votre dossier n° " + sIdSin + " – Carte cadeau ELECLERC – Contrat n° "+ sLibPolice

sMailBody = "Bonjour," +sSaut 
sMailBody += sSaut
sMailBody += "Nous avons le plaisir de vous informer de la prise en charge de votre dossier." +sSaut 
sMailBody += sSaut
sMailBody += "A cet effet, nous vous informons qu’une Carte Cadeau E. LECLERC créditée d’un montant de " +String(dcMtPec,"0.00")

// [DT044_1]
sMailBody += "€ TTC sera à votre disposition dans le magasin E. LECLERC de " + sVilleBoutique + " dans les prochains jours." +sSaut 
sMailBody += sSaut
sMailBody += "Pour retirer votre Carte Cadeau E. LECLERC, nous vous invitons à vous présenter avec ce courrier à l’accueil de votre Centre E. LECLERC." +sSaut 
sMailBody += sSaut
sMailBody += "Grâce à cette carte cadeau E.LECLERC, vous pourrez procéder, à votre convenance, à l’achat du produit de substitution que vous souhaitez." +sSaut 
sMailBody += sSaut + sSaut
sMailBody += "Cordialement, " +sSaut 
sMailBody += sSaut
sMailBody += "Le Service Assurance" + sSaut	// [DT044_1]
sMailBody += sSaut


bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If


Return bRet
end function

private function long uf_zn_trt_divsin_typapprecneu (string asdata, string asnomcol, long alrow, boolean abforcer);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_TypAppRecNeu (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 14/11/2012
//* Libellé			: Contrôle de la zone virtuelle ChoixPack
//* Commentaires	: 	
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*					  Boolean		abForcer			Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    09/01/2009  [20090109130126653]
//        JFF    02/04/2011  [PC694][SFR2012]
//*-----------------------------------------------------------------

String sTypeApp, sIdMarq 
DataWindowChild dwChild
Integer iAction
Long lRow, lDeb, lFin

sTypeApp = Upper ( asData )
iAction = 0

/*------------------------------------------------------------------*/
/* Pour Modifier lle Type d'app., il faut qu'aucun détail soit 'à   */
/* régler' ou 'réglé' ET qu'aucune Prestation non annulée n'existe. */
/*------------------------------------------------------------------*/
//If idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' ", 1, idw_LstwCommande.RowCount () ) > 0 And Not abForcer Then
// [20090109130126653]
If idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND ID_TYP_ART NOT IN ( 'EDI', 'PRS') ", 1, idw_LstwCommande.RowCount () ) > 0 And Not abForcer Then
	idw_wDivSin.iiErreur = 3 
	
	iAction = 1
End If

Return iAction


end function

private function boolean uf_validation_finale_oop_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_OOP_Mail (PRIVATE)
//* Auteur        : FPI
//* Date          : 07/01/2013
//* Libellé       : Gestion Particulière pour OOP
//* Commentaires  : [PC889]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			FPI		20/01/2014	[PC889-1]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sLibGti, sIdEvt
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv , sNomAssure
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 231 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL", ";")
sTypMail = "CMDOOP"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'OOP' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "Orange Open Pro"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	
	// Rajout JFF !!!
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()		
	
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

// Assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "PRENOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "NOM" )

// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )

If IsNull ( sMailDest ) Then sMailDest = ""

//[PC889-1]
sMailObjet = "PC SINISTRE – REF SPB " + sIdSin + " - Orange Offre Location de Tablettes" 

sMailBody += "Objet : demande de remplacement d’une tablette " + sSaut
sMailBody += sSaut

sMailBody += "Bonjour," + sSaut
sMailBody += sSaut

sMailBody += "Suite à la déclaration de sinistre d’une tablette " 
sMailBody += Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) )  + " "
sMailBody += Upper ( F_GetItem3 ( idw_wSin, 1, "NUM_IMEI_PORT" ) ) + " concernant " + sNomAssure
sMailBody += " nous vous remercions de procéder au remplacement de celle-ci."+ sSaut
sMailBody += sSaut

sMailBody += "La nouvelle tablette de remplacement devra être acheminée à l’adresse suivante :" + sSaut

sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If

sMailBody += sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sMailBody += sSaut
sMailBody += F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) )  + sSaut
sMailBody += sSaut

sMailBody += "Nous restons à votre entière disposition pour tout renseignement complémentaire et vous prions d’agréer, nos salutations distinguées." + sSaut
sMailBody += sSaut

sMailBody += "SPB" + sSaut

sMailBody += "orangeloctablettes@spb.eu" + sSaut // [PC889_1]

sMailBody += sSaut

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_eco_mail_samsung ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_ECO_Mail_Samsung (PRIVATE)
//* Auteur        : FPI
//* Date          : 14/02/2011
//* Libellé       : Gestion Particulière pour ECONOCOM CG 60 - Samsung
//* Commentaires  :	[PC467-2]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			 FPI		27/01/2014	[PC988]
//			FPI	18/04/2014	[VDOC14221] suppr du mail de refus
//			FPI	22/04/2014	[VDOC14051] Modification contenu mail enlvt
//			FPI	02/10/2014	[VDOC15495]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin, sGti
String   sRech,  sVal,   sMailDest, sNomAssure, sIdFour
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdresse 
Blob    bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin, lRowAssure
DataWindowChild dwChild
n_cst_string lnvPFCString

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 234 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")

// [PM191-4] [PC467-2] TODO : modifier la boite mail et mettre "insurance-cg60@spb.eu"

iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )
sTypMail=""

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'EDI' AND " + &		
			 "ID_GTI  =11    AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR IN ('SAM','CFI') " 
			 // [PC988]
			// "ID_FOUR    = 'SAM' " 


/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

// Demande d'enlèvement ?
idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd > 0 Then
	sTypMail = "CMDEC2"
	sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_ENLEV_PC", ";")
End if

// Refus
/*	[VDOC14221] suppr du mail de refus*/
// [VDOC15495] Réactivation du mail de refus uniqt produit 37702
If sTypMail="" And idw_wsin.getItemNumber(1,"COD_ETAT") =  200 Then
	sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_REFUS", ";")
	if sMailDest <> "" Then sTypMail = "ECOREF" // On ne fait le mail que si l'adresse email est paramétrée
End if

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
If sTypMail = "" Then Return TRUE

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers SAM on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 and sTypMail = "CMDEC2" Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "ECONOCOM"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

If IsNull ( sMailDest ) Then sMailDest = ""
sIdFour= idw_LstwCommande.GetItemString ( 1, "ID_FOUR" ) 

// Gti
If idw_lstgti.Find("ID_GTI=10",1,idw_lstgti.RowCount()) > 0 Then
	sGti="vol"
Else
	sGti="dommage"
End if

sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )


if sTypMail="CMDEC2" Then
	sMailObjet = "Demande d’enlèvement pour établissement devis RTS sinistre n° " + sIdSin
	// [PC988]
	If  sIdFour= "CFI" Then 
		// [VDOC15495]
		sMailObjet="Demande d'enlèvement pour l'établissement du diagnostic de validation de la casse - sinistre n° " + sIdSin
		// :[VDOC15495]
	End if
Else
	sMailObjet = "Refus sinistre n° " + sIdSin
End if

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Suite à la déclaration d’un " + sGti + " dans le cadre de "

// [VDOC15495]
if sIdFour="CFI" Then
	sMailBody+="la garantie vol-casse pour l'Opération Ordi'60 du Conseil Général de l'Oise, "
Else
	sMailBody+="l’Assurance Région de l’Oise, "
End if
// :[VDOC15495]

if sTypMail="CMDEC2" Then
	sMailBody += "nous vous remercions de bien vouloir organiser l’enlèvement du PC de "
	
	If  sIdFour= "CFI" Then 
		sMailBody +=sNomAssure + " vers CFI pour diagnostic."
	Else
		sMailBody +=sNomAssure + " vers CEAT pour établissement d’un devis de réparation."
	End if
Else
	sMailBody += "nous vous informons du refus de prise en charge. " + sSaut
	sMailBody += "Un courrier a été adressé au client."
End if

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dossier " + sIdSin 
sMailBody += sSaut
sMailBody += sSaut

if sTypMail="CMDEC2" Then
	// On prend l'adresse de la commande
	sAdresse = ""
	idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
	lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
	If lRow > 0 Then
		sAdresse = dwChild.GetItemString ( lRow, "LIB_CODE" )
	End If

	sAdresse += " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
	sAdresse += sSaut
	sAdresse += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 
	
	sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
	If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
		sAdresse += sSaut
		sAdresse += sVal 
	End If
	
	sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
	If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
		sAdresse += sSaut
		sAdresse += sVal 
	End If
	
	sAdresse+= sSaut
	sAdresse += F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
Else
	// On prend l'adresse de l'inter assuré
	lRowAssure=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())
	
	sAdresse = sNomAssure
	sAdresse += sSaut
	sAdresse += Upper ( F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_1" )) 
	
	
	sVal = Upper ( F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_2"  )) 
	If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
		sAdresse += sSaut
		sAdresse += sVal 
	End If
	
	sAdresse += sSaut
	sAdresse += F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_CP" ) + " " + Upper ( F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_VILLE" ) ) 
End if

sMailBody += sAdresse

sMailBody += sSaut
sMailBody += sSaut

if sTypMail="CMDEC2" Then
	sMailBody += "TEL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) 
Else
	sMailBody += "TEL : " +  F_GetItem3 (  idw_lstinter, lRowAssure, "NUM_TELD"  )
End if

sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Model code : " + F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) + sSaut
sMailBody += "N° de série : " + F_GetItem3 ( idw_WSin, 1, "NUM_IMEI_PORT" ) 
sMailBody += sSaut
sMailBody += sSaut
if sTypMail="CMDEC2" Then sMailBody += "Dans cette attente," + sSaut
sMailBody += "Cordialement,"
sMailBody += sSaut
sMailBody += "SPB" + sSaut
sMailBody += "Ordi’60 Assurances" + sSaut
sMailBody += "76095 LE HAVRE CEDEX" + sSaut
sMailBody += "Fax : (0)820.901.560" + sSaut

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function long uf_zn_trt_divsin_gti_non_activee (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_Gti_non_activee (PRIVATE)
//* Auteur			: FPI
//* Date				: 18/04/2013
//* Libellé			: Contrôle de la zone gti_non_activee_site
//* Commentaires	: [PC918] V4
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer iAction
Long lRow
String sValActuel

asData = Upper ( asData )
iAction = 0

sValActuel= uf_GestOng_Divers_Trouver ( "GTI_NON_ACTIVEE_SITE" ) 

If asData="N" Then
	stMessage.sTitre		= "Garantie non-activée sur site"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sCode		= "WSIN742"

	If F_Message ( stMessage ) = 2 Then
		lRow = idw_wDivSin.Find ( "UPPER ( NOM_ZONE ) = 'GTI_NON_ACTIVEE_SITE'", 1, idw_wDivSin.Rowcount () )
		idw_wDivSin.SetItem ( lRow, "VAL_CAR", sValActuel )
		idw_wDivSin.iiErreur = 0
		iAction = 2
	End If
End IF

Return iAction

end function

private function string uf_controlergestion_caution (ref boolean abmessage, string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_Caution
//* Auteur			: Fabry JF
//* Date				: 10/05/2013
//* Libellé			: 
//* Commentaires	: [PC938_ORANGE_V3]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   Date	      Modification
//  JFF   07/05/2013 [DT081_EVOL_PRET_BRIS]
//  JFF   18/04/2013 [DT081_EVOL_PRET_BRIS][MANTIS10956]
//  JFF   29/09/2014 [DT081-1_CREDIMM]
//  JFF   06/01/2015 [ITSM_262502]
//  JFF   21/04/2015 [ITSM28878]
//  JFF   15/12/2015 [DT191]
//*-----------------------------------------------------------------

String sPos, sVal2, sVal, sPathIE, sUrlPaybox
Long lVal1, lVal2, lRow, lDeb, lFin, lRow2
n_cst_string lnvPFCString
datetime dtMajLe1, dtMajLe2, dtMajRetour

sPos = ""

Choose Case asCas
	Case "1ER_NUM_TRANS"

		//lVal1 = idw_LstwCommande.find ( "ID_FOUR = 'O2M' AND ID_GTI = 10 AND COD_ETAT = 'CNV' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET' ) > 0 ",1,  idw_LstwCommande.rowCount()+1 )	
		// [DT191]
		lVal1 = 0 // Shunt définitif de cette fonctionnalité pour le Vol DT191
		
		// [DT081_EVOL_PRET_BRIS]
		lVal2 = idw_LstwCommande.find ( "ID_FOUR = 'O2M' AND ID_TYP_ART = 'PST' AND ID_GTI <> 10 AND COD_ETAT = 'CNV' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET' ) > 0 AND POS ( INFO_SPB_FRN_CPLT, 'TYP_APP_PRET=' ) > 0 AND POS ( INFO_SPB_FRN_CPLT, 'TYP_APP_PRET=ENTREE_GAM' ) <= 0",1,  idw_LstwCommande.rowCount()+1 )
		
		// [DT081_EVOL_PRET_BRIS]
		If lVal1 <= 0 And lVal2 <= 0 Then Return sPos
		
		// Lecture des numéros en base.
		sVal = space ( 35 )
		sVal2 = This.uf_Gestong_Divers_Trouver ( "NUM_TRANS_PAYBOX_1" )
		If IsNull ( sVal2 ) Then sVal2 = ""
		lVal1 = idw_wSin.GetItemNumber ( 1, "ID_SIN" )		
		
		SQLCA.PS_S_VAL_W_DIV_SIN_V01 ( lVal1, "num_trans_paybox_1", sVal, dtMajRetour )
		If IsNull ( sVal ) Then sVal = ""
		sVal = Trim ( sVal)		
		
		If Trim ( sVal ) <> Trim ( sVal2 ) Then
			lRow = idw_wdivsin.Find("upper(nom_zone)='NUM_TRANS_PAYBOX_1'", 1 , idw_wdivsin.Rowcount()+1 )
			// Exprès je n'appelle pas uf_gestong_divers_majzone, il ne faut surtout pas, la valeur ne doit pas partir en base, elle s'y trouve déjà.
			idw_wDivSin.SetItem ( lRow, "VAL_CAR", sVal ) 
			idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "O" )
			idw_wDivSin.SetItem ( lRow, "MAJ_LE", dtMajRetour )			
		End If
		
		sVal = space ( 35 )
		sVal2 = This.uf_Gestong_Divers_Trouver ( "NUM_TRANS_PAYBOX_2" )
		If IsNull ( sVal2 ) Then sVal2 = ""			
		lVal1 = idw_wSin.GetItemNumber ( 1, "ID_SIN" )		
		
		SQLCA.PS_S_VAL_W_DIV_SIN_V01 ( lVal1, "num_trans_paybox_2", sVal, dtMajRetour )
		If IsNull ( sVal ) Then sVal = ""
		sVal = Trim ( sVal)
		
		If Trim ( sVal ) <> Trim ( sVal2 ) Then
			lRow = idw_wdivsin.Find("upper(nom_zone)='NUM_TRANS_PAYBOX_2'", 1 , idw_wdivsin.Rowcount()+1 )
			// Exprès je n'appelle pas uf_gestong_divers_majzone, il ne faut surtout, la valeur ne doit pas partir en base, elle s'y trouve déjà.
			idw_wDivSin.SetItem ( lRow, "VAL_CAR", sVal )
			idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "O" )
			idw_wDivSin.SetItem ( lRow, "MAJ_LE", dtMajRetour )
		End If
		
		
		sVal = This.uf_Gestong_Divers_Trouver ( "NUM_TRANS_PAYBOX_1" )
		If IsNull ( sVal ) Then sVal = ""
		
		sVal2 = This.uf_Gestong_Divers_Trouver ( "NUM_TRANS_PAYBOX_2" )
		If IsNull ( sVal2 ) Then sVal2 = ""
		
		// Volontairement je ne regarde pas la pièce car si la presta est en TYP_RELAI=PRET, c'est qu'elle n'est pas cochée
		// et si elle l'était pas la suite, un contrôle d'incohérence empêcehra d'arriver jusqu'ici.
		
		// tout est ok, on a amu num trans, on s'en va.
		If Not ( Trim ( sVal ) = "" and Trim ( sVal2 ) = "" ) Then Return sPos
		
		stMessage.sTitre		= "Contrôle de gestion"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN745"
		stMessage.Bouton		= YESNO!
		
		sPos = "ALT_BLOC"
		
		If F_Message ( stMessage ) = 2 Then
			lVal1 = idw_LstwCommande.find("ID_FOUR = 'O2M' AND ID_GTI = 10 AND COD_ETAT = 'CNV' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET' ) > 0 ",1,  idw_LstwCommande.rowCount()+1 )	
			If lVal1 > 0 Then
				idw_LstwCommande.DeleteRow ( lVal1 )

				// [DT081_EVOL_PRET_BRIS]
				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN766"
				stMessage.Bouton		= Ok!
				F_Message ( stMessage )
			End If
			
			lVal1 = idw_LstwCommande.find("ID_FOUR = 'PSM' AND ID_TYP_ART = 'REL' AND ID_GTI = 10 AND COD_ETAT = 'CNV' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET' ) > 0 ",1,  idw_LstwCommande.rowCount()+1 )	
			If lVal1 > 0 Then
				idw_LstwCommande.DeleteRow ( lVal1 )
				
				// [DT081_EVOL_PRET_BRIS]
				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN767"
				stMessage.Bouton		= Ok!
				F_Message ( stMessage )
				
			End If

			// [DT081_EVOL_PRET_BRIS]
			lVal2 = idw_LstwCommande.find ( "ID_FOUR = 'O2M' AND ID_TYP_ART = 'PST' AND ID_GTI <> 10 AND COD_ETAT = 'CNV' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET' ) > 0 AND POS ( INFO_SPB_FRN_CPLT, 'TYP_APP_PRET=' ) > 0 ",1,  idw_LstwCommande.rowCount()+1 )
			If lVal2 > 0 Then
				idw_LstwCommande.DeleteRow ( lVal2 )
				
				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN768"
				stMessage.Bouton		= Ok!
				F_Message ( stMessage )
			End IF
			
			//  [DT081_EVOL_PRET_BRIS][MANTIS10956]
			lVal2 = idw_LstwCommande.find ( "ID_TYP_ART = 'PRS' AND ID_GTI <> 10 AND COD_ETAT = 'CNV'",1,  idw_LstwCommande.rowCount()+1 )
			If lVal2 > 0 Then
				idw_LstwCommande.DeleteRow ( lVal2 )
				
				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN770"
				stMessage.Bouton		= Ok!
				F_Message ( stMessage )
			End IF
		
			abMessage = FALSE
			Return sPos
		End If
		
		abMessage = FALSE
		
		
	Case "DEBIT_IMM"

		sVal = space ( 35 )
		lVal1 = idw_wSin.GetItemNumber ( 1, "ID_SIN" )		
		
		SQLCA.PS_S_VAL_W_DIV_SIN_V01 ( lVal1, "etat_caution_paybox", sVal, dtMajRetour )
		If IsNull ( sVal ) Then sVal = ""
		sVal = Trim ( sVal)
		
		Choose Case sVal 
			Case "DEBTOT", "DEBPAR"
				// Ok, déjà débité
				// Exprès je n'appelle pas uf_gestong_divers_majzone, il ne faut surtout, la valeur ne doit pas partir en base, elle s'y trouve déjà.
				lRow = idw_wdivsin.Find("nom_zone='etat_caution_paybox'", 1 , idw_wdivsin.Rowcount()+1 )
				idw_wDivSin.SetItem ( lRow, "VAL_CAR", sVal ) 
				idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "O" )
				idw_wDivSin.SetItem ( lRow, "MAJ_LE", dtMajRetour )

				sVal = space ( 35 )
				SQLCA.PS_S_VAL_W_DIV_SIN_V01 ( lVal1, "mt_debit_caution_paybox", sVal, dtMajRetour )
				If IsNull ( sVal ) Then sVal = ""
				sVal = Trim ( sVal)

				lRow = idw_wdivsin.Find("nom_zone='mt_debit_caution_paybox'", 1 , idw_wdivsin.Rowcount()+1 )				
				idw_wDivSin.SetItem ( lRow, "VAL_MT", Dec (sVal) ) 
				idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "O" )
				idw_wDivSin.SetItem ( lRow, "MAJ_LE", dtMajRetour )				
				
				sVal = space ( 35 )
				SQLCA.PS_S_VAL_W_DIV_SIN_V01 ( lVal1, "dte_debit_caution_paybox", sVal, dtMajRetour )
				If IsNull ( sVal ) Then sVal = ""
				sVal = Trim ( sVal)
				
				lRow = idw_wdivsin.Find("nom_zone='dte_debit_caution_paybox'", 1 , idw_wdivsin.Rowcount()+1 )				
				idw_wDivSin.SetItem ( lRow, "VAL_DTE", DateTime (sVal) ) 
				idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "O" )
				idw_wDivSin.SetItem ( lRow, "MAJ_LE", dtMajRetour )
				
				Return "OK"
				
			Case Else

				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN748"
				stMessage.Bouton		= OK!
				
				sPos = "ALT_BLOC"
				
				F_Message ( stMessage ) 
				abMessage = FALSE				
				
		End Choose 

	// [DT081-1_CREDIMM]		  
	Case "RECREDIT_IMM"

		sVal = space ( 35 )
		lVal1 = idw_wSin.GetItemNumber ( 1, "ID_SIN" )		
		
		SQLCA.PS_S_VAL_W_DIV_SIN_V01 ( lVal1, "etat_caution_paybox", sVal, dtMajRetour )
		If IsNull ( sVal ) Then sVal = ""
		sVal = Trim ( sVal)
		
		Choose Case sVal 
			Case "RECRED"
				// Ok, déjà récrédité
				// Exprès je n'appelle pas uf_gestong_divers_majzone, il ne faut surtout, la valeur ne doit pas partir en base, elle s'y trouve déjà.
				lRow = idw_wdivsin.Find("nom_zone='etat_caution_paybox'", 1 , idw_wdivsin.Rowcount()+1 )
				idw_wDivSin.SetItem ( lRow, "VAL_CAR", sVal ) 
				idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "O" )
				idw_wDivSin.SetItem ( lRow, "MAJ_LE", dtMajRetour )
				
				sVal = space ( 35 )
				SQLCA.PS_S_VAL_W_DIV_SIN_V01 ( lVal1, "dte_recredit_caution_paybox", sVal, dtMajRetour )
				If IsNull ( sVal ) Then sVal = ""
				sVal = Trim ( sVal)
				
				lRow = idw_wdivsin.Find("nom_zone='dte_recredit_caution_paybox'", 1 , idw_wdivsin.Rowcount()+1 )				
				idw_wDivSin.SetItem ( lRow, "VAL_DTE", DateTime (sVal) ) 
				idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "O" )
				idw_wDivSin.SetItem ( lRow, "MAJ_LE", dtMajRetour )
				
				Return "OK"
				
			Case Else

				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN779"
				stMessage.Bouton		= OK!
				
				sPos = "ALT_BLOC"
				
				F_Message ( stMessage ) 
				abMessage = FALSE				
				
		End Choose 
		  
	Case "NOUV_NUM"

		sVal = space ( 35 )
		sVal2 = This.uf_Gestong_Divers_Trouver ( "NUM_TRANS_PAYBOX_1" )
		If IsNull ( sVal2 ) Then sVal2 = ""
		lVal1 = idw_wSin.GetItemNumber ( 1, "ID_SIN" )		
		
		SQLCA.PS_S_VAL_W_DIV_SIN_V01 ( lVal1, "num_trans_paybox_1", sVal, dtMajRetour )
		If IsNull ( sVal ) Then sVal = ""
		sVal = Trim ( sVal)		
		
		If Trim ( sVal ) <> Trim ( sVal2 ) Then
			lRow = idw_wdivsin.Find("upper(nom_zone)='NUM_TRANS_PAYBOX_1'", 1 , idw_wdivsin.Rowcount()+1 )
			// Exprès je n'appelle pas uf_gestong_divers_majzone, il ne faut surtout, la valeur ne doit pas partir en base, elle s'y trouve déjà.
			idw_wDivSin.SetItem ( lRow, "VAL_CAR", sVal ) 
			idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "O" )
			idw_wDivSin.SetItem ( lRow, "MAJ_LE", dtMajRetour )			
		End If
		
		sVal = space ( 35 )
		sVal2 = This.uf_Gestong_Divers_Trouver ( "NUM_TRANS_PAYBOX_2" )
		If IsNull ( sVal2 ) Then sVal2 = ""			
		lVal1 = idw_wSin.GetItemNumber ( 1, "ID_SIN" )		
		
		SQLCA.PS_S_VAL_W_DIV_SIN_V01 ( lVal1, "num_trans_paybox_2", sVal, dtMajRetour )
		If IsNull ( sVal ) Then sVal = ""
		sVal = Trim ( sVal)
		
		If Trim ( sVal ) <> Trim ( sVal2 ) Then
			lRow = idw_wdivsin.Find("upper(nom_zone)='NUM_TRANS_PAYBOX_2'", 1 , idw_wdivsin.Rowcount()+1 )
			// Exprès je n'appelle pas uf_gestong_divers_majzone, il ne faut surtout, la valeur ne doit pas partir en base, elle s'y trouve déjà.
			idw_wDivSin.SetItem ( lRow, "VAL_CAR", sVal )
			idw_wDivSin.SetItem ( lRow, "ALT_SUPP", "O" )	
			idw_wDivSin.SetItem ( lRow, "MAJ_LE", dtMajRetour )			
		End If


		sVal = This.uf_Gestong_Divers_Trouver ( "NUM_TRANS_PAYBOX_1" )
		If IsNull ( sVal ) Then sVal = ""			
		
		If Trim ( sVal ) = "" Then
			dtMajLe1 = DateTime ( 1900-01-01 )
		Else 
			lRow = idw_wdivsin.Find("upper(nom_zone)='NUM_TRANS_PAYBOX_1'", 1 , idw_wdivsin.Rowcount()+1 )
			
			If lRow > 0 Then
				dtMajLe1 = idw_wdivsin.GetItemDateTime ( lRow, "MAJ_LE" )
			End If
		End If

		sVal = This.uf_Gestong_Divers_Trouver ( "NUM_TRANS_PAYBOX_2" )
		If IsNull ( sVal ) Then sVal = ""			

		If Trim ( sVal ) = "" Then
			dtMajLe2 = DateTime ( 1900-01-01 )
		Else 
			lRow = idw_wdivsin.Find("upper(nom_zone)='NUM_TRANS_PAYBOX_2'", 1 , idw_wdivsin.Rowcount()+1 )
		
			If lRow > 0 Then
				dtMajLe2 = idw_wdivsin.GetItemDateTime ( lRow, "MAJ_LE" )
			End If
		End IF

		If Date ( dtMajLe1 ) = TODAY () Or Date ( dtMajLe2 ) = TODAY () Then
			Return "OK"
		Else 
				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN749"
				stMessage.Bouton		= OK!
				
				sPos = "ALT_BLOC"
				
				F_Message ( stMessage ) 
				abMessage = FALSE				
			
		End IF
		
End CHoose

// [DT081-1_CREDIMM]		  
Choose Case asCas
	Case "1ER_NUM_TRANS", "DEBIT_IMM", "NOUV_NUM", "RECREDIT_IMM"

		sPathIE = ProfileString ( stGlb.sFichierIni, "DOCUMENTATION", "IE_W7", "" )
		If Trim ( sPathIE ) = "" Then
			stMessage.sTitre		= "Contrôle de gestion"
			stMessage.Icon			= Information!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "WSIN746"
			stMessage.Bouton		= OK!
			stMessage.sVar[1]    = "DOCUMENTATION"
			stMessage.sVar[2]    = "IE_W7"
		
			sPos = "ALT_BLOC"
			
			F_Message ( stMessage ) 
			abMessage = FALSE
			Return sPos
		End IF
		
		If Not FileExists ( sPathIE ) Then
			sPathIE = ProfileString ( stGlb.sFichierIni, "DOCUMENTATION", "IE_XP_ET_TS", "" )
			If Trim ( sPathIE ) = "" Then
				stMessage.sTitre		= "Contrôle de gestion"
				stMessage.Icon			= Information!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "WSIN746"
				stMessage.Bouton		= OK!
				stMessage.sVar[1]    = "DOCUMENTATION"
				stMessage.sVar[2]    = "IE_XP_ET_TS"
			
				sPos = "ALT_BLOC"
				
				F_Message ( stMessage ) 
				abMessage = FALSE
				Return sPos
			End IF	
		End If
		
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
		
		sUrlPaybox = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "URL_PAYBOX", ";")
		sUrlPaybox += "?id_sin=" + String ( idw_wsin.GetItemNumber ( 1, "ID_SIN" ))
		sUrlPaybox += "&nom_ass=" + String ( idw_wsin.GetItemString ( 1, "NOM" ))
		sUrlPaybox += "&prenom_ass=" + String ( idw_wsin.GetItemString ( 1, "PRENOM" ))
		

		// [DT081_EVOL_PRET_BRIS] -- MT_CAUTION
		lRow = idw_LstwCommande.find ( "ID_FOUR = 'O2M' AND ID_TYP_ART = 'PST' AND ID_GTI <> 10 AND COD_ETAT = 'CNV' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET' ) > 0 AND POS ( INFO_SPB_FRN_CPLT, 'TYP_APP_PRET=' ) > 0 ",1,  idw_LstwCommande.rowCount()+1 )
		If lRow > 0 Then
			sVal2 = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( lRow, "INFO_SPB_FRN_CPLT" ), "TYP_APP_PRET", ";")	

			//  [ITSM28878]
			lRow2 = idw_DetPro.Find ( "ID_CODE_DP = 259 AND POS ( VAL_CAR, 'TYP_APP_PRET=" + sVal2 + ";' ) > 0", 1, idw_DetPro.RowCount () )				
		
			If lRow2 > 0 Then
				sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lRow2, "VAL_CAR" ), "MT_CAUTION", ";")	
			End If
			
			If Not IsNumber ( sVal ) Then sVal = "0"

		Else
			sVal = This.uf_Gestong_Divers_Trouver ( "MT_VAL_PUBLIQUE" )
			If IsNull ( sVal ) Then 
				If dec ( sVal ) <= 0 Then
					stMessage.sTitre		= "Contrôle de gestion"
					stMessage.Icon			= exclamation!
					stMessage.bErreurG	= FALSE
					stMessage.sCode		= "WSIN747"
					stMessage.Bouton		= OK!
				
					sPos = "ALT_BLOC"
					
					F_Message ( stMessage ) 
					abMessage = FALSE
					Return sPos
					
				End If
			End If
		End If 				

		// [DT081-1_CREDIMM]
		If asCas = "RECREDIT_IMM" Then
			sVal = This.uf_Gestong_Divers_Trouver ( "MT_DEBIT_CAUTION_PAYBOX" )				
		End If 
		
		sUrlPaybox += "&montant=" + sVal
		
		sUrlPaybox = sPathIE + " " + sUrlPaybox 

		Choose Case asCas
			Case "DEBIT_IMM"
				sUrlPaybox += "&action=DEBIMM"

			// [DT081-1_CREDIMM]		  				
			Case "RECREDIT_IMM"
				sUrlPaybox += "&action=RECIMM"
			
			Case "NOUV_NUM"
				sUrlPaybox += "&action=NOUVNUM"

			Case "1ER_NUM_TRANS"
				sUrlPaybox += "&action=1ERNUM"
				
		End Choose 
		
		sUrlPaybox += "&email="
		
		lRow = idw_LstInter.Find ( "COD_INTER='A'", 1, idw_LstInter.RowCount () )
		If lRow > 0 Then
			sVal = idw_LstInter.GetItemString ( lRow, "ADR_MAIL" ) 
			If IsNull ( sVal ) Then sVal = ""
			sUrlPaybox += Trim ( sVal )
		End IF
		
		
		Run( sUrlPaybox, Maximized!)

End Choose 

return sPos
end function

private function long uf_zn_id_territ (boolean abmodified);//*-----------------------------------------------------------------
//*
//* Fonction		: uf_zn_id_territ (PRIVATE)
//* Auteur			: JFF
//* Date				: 16/05/2012
//* Libellé			: [ITSM115501]
//* Commentaires	: Contrôle de ID_NAT_SIN
//*
//* Arguments		: Aucun
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
// 	FPI	14/08/2013	[DT058]
//*-----------------------------------------------------------------

Long lDeb, lVal1, lVal2, lFin, lRowSanction, lRowAccordChubb
Long lIdTerrit
Integer iAction
String sValCar
n_cst_string nvString

iAction = 0

If abModified Then
	lIdTerrit	= Long ( idw_wSin.GetText () )
Else
	lIdTerrit = idw_wSin.GetItemNumber(1,"ID_TERRIT")
End if

If iAction = 0 Then
	lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
	
	lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	If  lVal1 > 0 Or lVal2 > 0 Then
		iAction = 1
		idw_wSin.iiErreur = 1
	End If 
End If

// [DT058]
If iAction=0  Then
	F_rechdetpro(lDeb, lFin, idw_detpro, idw_wsin.GetItemNumber(1,"ID_PROD"), "-DP", 246)
	If ldeb > 0 Then
		sValCar=idw_detpro.GetItemString(lDeb,"VAL_CAR")
		sValCar=nvString.of_getkeyvalue( sValCar, "PAYS", ";")
		
		lRowSanction=idw_wdivsin.Find("NOM_ZONE='sanction_eco'",1, idw_wdivsin.RowCount())
		lRowAccordChubb=idw_wdivsin.Find("NOM_ZONE='accord_chubb'",1, idw_wdivsin.RowCount())

		If Pos(sValCar, "#" + String(lIdTerrit) +"#") > 0 And lRowSanction > 0 And lRowAccordChubb > 0 Then
			// Pays sous sanction Eco USA
			uf_gestong_divers_majzone("SANCTION_ECO",lRowSanction, K_MAJZONE , "O")
			If abModified Then 
				uf_gestong_divers_majzone("ACCORD_CHUBB",lRowAccordChubb, K_MAJZONE , 0)
				idw_wDivSin.SetItem ( lRowAccordChubb,"ALT_PROT", "N" )
			End if
		Else
			// Pays non concerné
			uf_gestong_divers_majzone("SANCTION_ECO",lRowSanction, K_MAJZONE , "N")
			If abModified Then uf_gestong_divers_majzone("ACCORD_CHUBB",lRowAccordChubb, K_MAJZONE , 4)
			idw_wDivSin.SetItem ( lRowAccordChubb,"ALT_PROT", "O" )
		End if
	End if
		
End if

Return iAction


end function

public function boolean uf_controlergestion_sanction_eco_usa ();//*-----------------------------------------------------------------
//*
//* Fonction		: uf_controler_sanction_eco (PUBLIC)
//* Auteur			: FPI
//* Date				: 14/08/2013
//* Libellé			: [DT58]
//* Commentaires	: Contrôle territoire sous sanction économique USA
//*
//* Arguments		: 
//*
//* Retourne		: TRUE si on peut commander/régler sur le dossier ; FALSE sinon
//*
//*-----------------------------------------------------------------
Boolean bRet=TRUE
Boolean bEditer, bFrais
Long lDeb, lFin, lRow
String sVal

F_rechdetpro(lDeb, lFin, idw_detpro, idw_wsin.GetItemNumber(1,"ID_PROD"), "-DP", 246)
If ldeb <= 0 Then return TRUE

// Récupération de la ligne indiquant que le pays de survenance est sous sanction économique USA
lRow=idw_wdivsin.Find("UPPER(NOM_ZONE)='SANCTION_ECO'",1, idw_wdivsin.RowCount())
If lRow <=0 Then 
		bRet=FALSE
		stMessage.scode="WDET631"
		stMessage.sVar[1]="sanction_eco"
End if

If bRet Then
	If idw_wdivsin.GetItemString(lRow,"VAL_CAR") = "N" Then return TRUE // Pays non concerné
	
	// Récupération du résultat de la demande d'accord Chubb
	lRow=idw_wdivsin.Find("UPPER(NOM_ZONE)='ACCORD_CHUBB'",1, idw_wdivsin.RowCount())
	If lRow <=0 Then 
		bRet=FALSE
		stMessage.scode="WDET631"
		stMessage.sVar[1]="accord_chubb"
	Else
		sVal=String(idw_wdivsin.GetItemNumber(lRow,"VAL_NBRE"))
	End if
End if

If bRet Then 
	// Contrôle du résultat de la demande d'accord Chubb
	If sVal="2" Then return TRUE
	
	// Contrôle courrier ou frais présent (les commandes &  règlements ont été bloqués au niveau du détail)
	bEditer=(idw_wsin.GetItemString(1,"ALT_EDIT") = "O")
	bFrais=(idw_wfrais.RowCount() > 0)
	
	If bEditer or bFrais Then
		stMessage.sVar[1]=""
		If bEditer Then
			stMessage.sVar[1]="décocher la case ~"Editer~""
		End if
		If bFrais Then
			if bEditer Then stMessage.sVar[1]+=" et "
			stMessage.sVar[1]+="supprimer les frais"
		End if
	End if
	
	// Resultat <> "Accord"
	Choose Case sVal
		Case "0"
			// Non renseigné
			stMessage.scode="WSIN755"
			bRet=FALSE
		Case "1"
			// Demande en cours
			If bEditer or bFrais Then
				stMessage.scode="WSIN756"
				bRet=FALSE
			End if
		Case "3"
			// Refus
			stMessage.scode="WDET634"
			bRet=FALSE
	End Choose
End if

If not bRet Then
	// Init du message d'erreur
	stmessage.stitre="Pays sous sanction économique USA"
	stmessage.berreurg=FALSE
End if

Return bRet
end function

private function boolean uf_controler_sepa (string ascodebq, string ascodeag, long alidinter);//*-----------------------------------------------------------------
//*
//* Fonction		: uf_controler_sepa (PRIVATE)
//* Auteur			: FPI
//* Date				: 11/10/2013	
//* Libellé			: [VDoc12394]
//* Commentaires	: 	
//*
//* Arguments		: Aucun
//*
//*-----------------------------------------------------------------
//	FPI - 01/03/2016 - [VDoc20041] changement de webservice
//	JFF - 10/01/2018 - [SHUNT_WS_SEPA]
//*-----------------------------------------------------------------
Boolean bRet
Long lRet, lRowDS
n_cst_sp_ws_sepa_caller uoWsCaller
n_cst_sp_ws_spbsepa_caller uoWsSpbCaller  //  [VDoc20041]
String sValSepaOK, sVal
datawindowchild dwChild

bRet=TRUE

// Si le ctl a déjà été fait OK
lRowDS = idw_wDivSin.Find ( "Upper ( NOM_ZONE ) = 'CTL_SEPA'", 1, idw_wDivSin.RowCount () ) 
If lRowDS >  0 Then
	sVal=idw_wDivSin.GetItemString(lRowDS,"VAL_CAR")
	if Pos(sVal,"#" + String(alidinter) + "#") > 0 Then Return TRUE
End if

//  [VDoc20041]
// Appel du WebService
/* Défintivement shunté par JF le 22/01/2019
	// bRet = SQLCA.PS_S02_AGENCE ( asCodeBq, asCodeAg) > 0 

	uoWsSpbCaller=CREATE n_cst_sp_ws_spbsepa_caller
	If not isValid (isoapcnx) Then isoapcnx = CREATE soapconnection
	
	lRet=uoWsSpbCaller.createproxy(isoapcnx )
	
	if lRet<>-1 Then	
		bRet=uoWsSpbCaller.isbankcounterexist( asCodeBq, asCodeAg)
	End if
	
	destroy uoWsSpbCaller
*/
bRet = TRUE

// :[VDoc20041]

// Mise à jour dans div_sin
sValSepaOK=String(alidInter) + "#"

if lRowDS <=0 Then
	If bRet Then
		// Ajout dans div_sin uniqt si OK
		if idw_wDivSin.RowCount()=0 Then
			idw_wDivSin.GetChild ( "VAL_LST_CAR", dwChild )
			dwChild.Retrieve("-AR")
			idw_wDivSin.GetChild ( "VAL_LST_NBRE", dwChild )
			dwChild.Retrieve("-MB")
		End if
		
		lRowDS = idw_wDivSin.InsertRow (0)
	
		idw_wDivSin.SetItem ( lRowDS, "ID_SIN", idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )
		idw_wDivSin.SetItem ( lRowDS, "NOM_ZONE", "ctl_sepa" )
		idw_wDivSin.SetItem ( lRowDS, "LIB_LABEL", "Contrôle Banque/Agence SEPA" )
		idw_wDivSin.SetItem ( lRowDS, "ID_TYP_LISTE", "-XX" )
		idw_wDivSin.SetItem ( lRowDS, "ALT_LISTE_CODECAR", "N" )
		idw_wDivSin.SetItem ( lRowDS, "ID_TYP_ZONE", "C" )
		idw_wDivSin.SetItem ( lRowDS, "ALT_OBLIG", "N" )
		idw_wDivSin.SetItem ( lRowDS, "ALT_PROT", "O" )
		idw_wDivSin.SetItem ( lRowDS, "CPT_TRI", 1000 )
		idw_wDivSin.SetItem ( lRowDS, "VAL_DTE", stNul.dtm )	// [PI056].20190926
		idw_wDivSin.SetItem ( lRowDS, "VAL_CAR","#" +  sValSepaOK)
		idw_wDivSin.SetItem ( lRowDS, "VAL_NBRE", stNul.lng)
		idw_wDivSin.SetItem ( lRowDS, "VAL_MT", stNul.dcm )
		idw_wDivSin.SetItem ( lRowDS, "ALT_SUPP", "N" )
		idw_wDivSin.SetItem ( lRowDS, "CREE_LE", DateTime ( Today (), Now () ) )
		idw_wDivSin.SetItem ( lRowDS, "MAJ_LE", DateTime ( Today (), Now () ) )
		idw_wDivSin.SetItem ( lRowDS, "MAJ_PAR", stGlb.sCodOper )
	End if
Else
	// Mise à jour dans div_sin
	sVal=idw_wDivSin.GetItemString(lRowDS,"VAL_CAR")
	
	If bRet Then
		// Ctl OK : on ajoute l'inter à la liste
		if pos(sVal, sValSepaOK) <=0 Then 
			If sVal ="" Then sVal="#"
			sVal+=sValSepaOK
		End if
	Else
		// Ctl NOK : on l'enlève de la liste s'il y est
		if pos(sVal, sValSepaOK) > 0 Then 
			
			sVal=f_remplace(sVal,"#" +sValSepaOK,"#")
			If sVal="#" Then sVal=""
			
		End if
	End if
	
	idw_wDivSin.SetItem ( lRowDS, "VAL_CAR",sVal)
End If

Return bRet
end function

private subroutine uf_determiner_courrier_forcage_dp250 (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_Dp250 (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 02/12/2013
//* Libellé       : On met à jour le tableau de des droits de modifications des courriers.
//* Commentaires  : [PC938-1_V1]
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//        JFF   21/02/2107   [DT288]
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech, sFiltreOrig, sVal, sFind
Long   				lDeb, lFin, lTotCourrier, lLig, lTotCmd, lCpt, lIdgti, lProcess, lRow
n_cst_attrib_key	lnv_Key[]
string				sTypApp, sIdFour

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 250 )
If lDeb <= 0 Then
	Return	
End If

If asPos <> "" Then Return

If idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) <> "A" Then Return


sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV'" )
idw_LstwCommande.Filter ()
idw_LstwCommande.Sort ()
sVal = ""

lTotCmd = idw_LstwCommande.RowCount () 


For lCpt = 1 To lTotCmd
	lIdGti = idw_LstwCommande.GetItemNumber ( lCpt, "ID_GTI" )
	lProcess = idw_LstwCommande.GetItemNumber ( lCpt, "INFO_SPB_FRN" )
	sVal = This.uf_Gestong_Divers_Trouver ( "CONS_APPPRETVOL" )
	sIdFour = idw_LstwCommande.GetItemString ( lCpt, "ID_FOUR" ) // [DT288]

	Choose Case sVal
		Case "O" 
			sVal = "CONS"
		Case Else 
			sVal = "REST"
	End CHoose
	
	Choose Case lIdGti
		Case 10			
			sFind = "ID_CODE_NUM = " + String ( lIdGti ) + " AND ID_CODE_CAR = '" + sVal + "'"
		Case 11, 24 // [ITSM209374] Ajout de l'oxydation
			sFind = "ID_CODE_NUM = " + String ( lIdGti ) 
	End Choose

	lRow = idw_DetPro.Find ( sFind, lDeb, lFin )
	
	If lRow > 0 Then
		// [DT288]
		sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lRow, "VAL_CAR" ), String ( lProcess ) + "#" + sIdFour , ";")		
		
		If Len ( Trim ( sVal )) > 0 And Not IsNull ( sVal ) Then
			Exit
		End If 
	End If
	
Next

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()
idw_LstwCommande.Sort ()

If Len ( Trim ( sVal )) <= 0 Or IsNull ( sVal ) Then Return

sIdNatPresent = asIdNatCour
sIdNatCourForcage = sVal

If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

If sIdNatPresent <> sIdNatCourForcage Then

	If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
		stMessage.bErreurG	= FALSE
		stMessage.Icon			= question!
		stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
		stMessage.Bouton		= YesNO!
		stMessage.sVar[1] 	= sIdNatCourForcage
		
	Else
		stMessage.bErreurG	= FALSE
		stMessage.Icon			= question!
		stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
		stMessage.Bouton		= YesNO!
		stMessage.sVar[1] 	= asIdNatCour
		stMessage.sVar[2] 	= sIdNatCourForcage
	End If 
	
	If F_Message ( stMessage ) = 1 Then

		stMessage.Icon			= Information!
		stMessage.Bouton		= Ok!							

		idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
		lTotCourrier	= dwChild.RowCount ()
		sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
		lLig				= dwChild.Find ( sRech, 1, lTotCourrier )

/*------------------------------------------------------------------*/
/* On verifie si la nature de courrier existe. Si elle n'existe     */
/* pas, par un effet du hasard bien sur, on arrete le traitement    */
/* et on positionne sur REF_CIE.                                    */
/*------------------------------------------------------------------*/
		If	lLig = 0	Then

/*------------------------------------------------------------------*/
/* On arme la structure de message maintenant, mais le message va   */
/* être affiché dans le contrôle de gestion.                        */
/*------------------------------------------------------------------*/
			stMessage.bErreurG	= FALSE
			stMessage.Icon			= Information!
			stMessage.sCode		= "WSIN170"
			stMessage.sVar[1] 	= sIdNatCourForcage
			asPos = "REF_CIE"
		Else
			If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
				asIdNatCour = sIdNatCourForcage
				asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
				
				idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
				idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
				idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
			Else 
				// Le message est armé dans uf_GestionCP
				asPos = "REF_CIE"

			End If
		End If		
	End If
End If


end subroutine

private subroutine uf_controler_eco_msg_cg60 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_controler_eco_msg_cg60  (PRIVATE)
//* Auteur        : FPI
//* Date          : 06/01/2014
//* Libellé       : Gestion Particulière pour CG60
//* Commentaires  : 	[VDOC13226]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre
Long lRowReg, lDeb, lFin, lTotCmd

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 145 )
If lDeb <= 0 Then Return 

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PCP' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'ECO' " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

lRowReg=idw_lstgti.Find("COD_ETAT in  (550,500,600)",1,idw_lstgti.RowCount())

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 0 or lRowReg > 0 Then 
	stMessage.sTitre		= "SCC CG60 - VDoc13226"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "WSIN763"

	F_Message ( stMessage ) 
End If

end subroutine

private function boolean uf_validation_finale_mail_srr ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_mail_srr  (PRIVATE)
//* Auteur        : FPI
//* Date          : 10/02/2014
//* Libellé       : Gestion Particulière pour SFR La réunion.
//* Commentaires  : [PC925]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    30/10/2024  [MCO1054]
//*-----------------------------------------------------------------

Boolean bRet, bNoBALproduit
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sLibGti, sIdEvt
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv, sVal1
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lTotDetail, lIdDetail, lRow2, iIdAppli, lDeb, lFin, lCptDet 
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
String sMontantIndemnisation

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 256 )
If lDeb <= 0 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "SFR La Réunion"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD842"

	F_Message ( stMessage ) 
	Return FALSE
End if

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_PRS", ";")
sTypMail = "CMDSRR"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

// [MCO1054]
bNoBALproduit = True
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 136 )
If lDeb > 0 Then 
	sVal = lnvPFCString.of_getkeyvalue ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_PROD", ";")
	bNoBALproduit = sVal = "" Or sVal = "noreply@spb.eu"
End If 
// [MCO1054]

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN  ('SRR') "
			 
/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers SRR on stoppe.                      */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "SFR La Réunion"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	
	// Rajout JFF !!!
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()	
	
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

If IsNull ( sMailDest ) Then sMailDest = ""

// Civilité
sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If

// Montant de PEC
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If

lIdGti=idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
lIdDetail=idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sVal = "[###]"

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0
	
If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0
	
sMontantIndemnisation=String ( dcMtMaxTTC , "#####0.00" ) 
	
sMailObjet = "Demande de réparation - Dossier n° " + sIdSin 
sMailObjet += " " + UPPER(F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper(F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ))
sMailObjet += " – Assurance Mobile SRR"

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nous vous informons de la déclaration de sinistre de " + sAdrLibCiv + " "
sMailBody += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody+=" concernant le dommage de son appareil :"
sMailBody += sSaut
sMailBody+="	- Marque : " + F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" )  + sSaut
sMailBody+="	- Modèle : " + F_GetItem3 ( idw_wSin, 1, "MODL_PORT" )  + sSaut
sMailBody+="	- IMEI : " + F_GetItem3 ( idw_wSin, 1, "NUM_IMEI_PORT" )  + sSaut
sMailBody+="	- Description du problème : " + F_GetItem3 ( idw_LstwCommande, 1, "PROBLEME" )  + sSaut
sMailBody += sSaut
sMailBody += "Nous avons demandé à l’Assuré l’envoi de son appareil auprès de vos services." + sSaut
sMailBody += sSaut
sMailBody +="A réception de celui-ci, nous vous remercions de vérifier la conformité du n° IMEI et d’effectuer une pré-expertise au regard des conditions d’exclusion du contrat d’assurance."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Merci également de prendre en compte le montant du plafond d’indemnisation ci-dessous pour définir si l’appareil est réparable par vos soins." + sSaut
sMailBody += "                                                      " + sMontantIndemnisation + sSaut
sMailBody += sSaut

sMailBody +="Nous restons à votre entière disposition pour tout renseignement complémentaire et vous prions d’agréer, nos salutations distinguées." + sSaut
sMailBody += sSaut

// [MCO1054]
If bNoBALproduit Then 
	sMailBody +="****************************************************************" + sSaut
	sMailBody += sSaut
	sMailBody +="AVERTISSEMENT : NE PAS REPONDRE A CE MAIL" + sSaut
	sMailBody += sSaut
	sMailBody +="****************************************************************" + sSaut
	sMailBody += sSaut
	sMailBody +="Cet e-mail étant généré de façon automatique, nous vous remercions de ne pas utiliser l'adresse d'origine pour nous contacter, votre message ne pouvant être traité en retour." + sSaut
End If 
// [MCO1054]

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_advise_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_ADVISE_Mail (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 19/03/2014
//* Libellé       : Gestion Particulière pour ADVISE.
//* Commentaires  : [DT076_ADVISE]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//* #2    JFF    26/10/09    [DCMP090651] Modif du mail
//* #3    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		FPI	26/02/2013	[PC853_1] Pas d'option 119 sur les prod 481__
//		FPI	23/05/2014	[ITSM214496] PEC forcée
//		FPI	28/07/2014	[DT076] - Refonte du mail
//		JFF	05/08/2014	[DT076][MANTIS11768]
//		JFF	04/08/2015	[VDOC18283]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest, sLibTypApp
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sResponsable, sIdFour, sXml, sMailFrom
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin, lCodeMag, lIdSeq
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
String libPersonneMobisquare
s_pass stPass

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 252 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
If IsNull ( sBoiteMail ) Then sBoiteMail = ""
sMailFrom=sBoiteMail
sTypMail = "PECADV"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR  IN ( 'ADV')" 
			 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	// ON continue sans mail
	Return TRUE
End If	


/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sVar[1]		= "Advise"
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdFour = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" ) 

/*------------------------------------------------------------------*/
/* Le mail sera construit dans une DW qui sera directement (d'un    */
/* coup écrite sur disque). Je préfère cette option plutôt que      */
/* d'écrire un fichier texte progressivement sur disque avec des    */
/* FileWrite. Je trouve la solution de la DW plus sûr.              */
/*------------------------------------------------------------------*/

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow = idw_wdivsin.Find("nom_zone='cod_boutique_adh'", 1 , idw_wdivsin.Rowcount()+1 )
If lRow > 0 Then
	sVal = idw_wdivsin.GetItemString ( lRow, "VAL_CAR" )
Else
	sVal = "-1"
End If
lCodeMag = Long ( sVal ) 


lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + sVal, 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
	sNomMagasin = ""
	sResponsable = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	sResponsable = dwChild.GetItemString ( lRow2, "RESPONSABLE" )
End If	

If IsNull ( sMailDest ) Then sMailDest = ""
If IsNull ( sTelDest ) Then sTelDest = ""
If IsNull ( sNomMagasin ) Then sNomMagasin = ""
If IsNull ( sResponsable ) Then sResponsable = ""

If sMailDest = "" Then
	
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sVar[1]		= sNomMagasin
	stMessage.sCode		= "COMD847"

	F_Message ( stMessage ) 
	Return FALSE

End If

// :[DT076]
sMailObjet = "ADVISE ASSURANCE – BON DE PRISE EN CHARGE – " + sIdSin

//	[VDOC18283]
lIdSeq = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" ) 
If IsNull ( lIdSeq ) Then lIdSeq = 0 
sMailObjet += "-" + String ( lIdSeq )

sMailBody = "Bonjour," + sSaut
sMailBody += sSaut
sMailBody +="Nous vous informons de la prise en charge du remplacement de l’appareil de " 
sMailBody += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " 
sMailBody += Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) + " :" + sSaut
sMailBody += sSaut
sMailBody += "REFERENCE SIN ADVISE : " + sIdSin

//	[VDOC18283]
lIdSeq = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" ) 
If IsNull ( lIdSeq ) Then lIdSeq = 0 
sMailBody += "-" + String ( lIdSeq )

sMailBody += sSaut

dVal = Date ( F_GetItem3 ( idw_wSin, 1, "DTE_ACH_PORT" ))
sMailBody += "DATE ACHAT APPAREIL SINISTRE : " + String ( dVal, "dd/mm/yyyy" ) + sSaut

dVal = Date ( Left ( F_GetItem3 ( idw_wSin, 1, "DTE_SURV" ), 10 ) )
sMailBody += "DATE SURVENANCE SINISTRE : " + String ( dVal , "dd/mm/yyyy" )  + sSaut

sMailBody += "APPAREIL A REMPLACER : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + " " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) + sSaut
// :[DT076]

/*------------------------------------------------------------------*/
/* 6 : GSM à remplacer															  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 

// [ITSM214496] - si la PEC est forcée
sRech	=		"ID_GTI = "	+ sIdGti	+ " AND " 	+ &
				"ID_DETAIL = "	+ sIdDetail 	+ " AND " 	+ &
				"UPPER ( NOM_ZONE ) = 'ALT_PEC' AND VAL_CAR='O'"
	
lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
If lRow > 0 Then
	sRech	=		"ID_GTI = "	+ sIdGti	+ " AND " 	+ &
				"ID_DETAIL = "	+ sIdDetail 	+ " AND " 	+ &
				"UPPER ( NOM_ZONE ) = 'MT_PEC'"
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtMaxTTC=idw_wDivDet.GetItemDecimal(lRow, "VAL_MT") 
	End if
End if
// :[ITSM214496]

If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

sMailBody += "MONTANT MAXIMUM INDEMNISATION TTC : " +  String ( dcMtMaxTTC , "#####0.00" )  + sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , lCodeMag, sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody += "APPAREIL A REMETTRE AU CLIENT PAR : " + Upper ( sNomMagasin ) + sSaut
sMailBody += sSaut
sMailBody += "Nous vous remercions et restons à votre disposition pour toute information complémentaire à l’adresse : " + sBoiteMail + sSaut
sMailBody += sSaut
sMailBody += "Service Sinistre Advise" + sSaut
sMailBody += sSaut
sMailBody += "ADVISE SAS de courtage d'assurance au capital de 100 000 €, Immatriculée au RCS de Paris sous le n° 482 112 141 et à l'ORIAS "
sMailBody += "sous le n° 07 028 723 (http://www.orias.fr). Sous le contrôle de l'Autorité de Contrôle Prudentiel et de Résolution - "
sMailBody += "	61 Rue Taitbout - 75436 Paris Cedex 09" + sSaut
// :[DT076]

// [PB_MAILPUSH]
// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)
// :[PB_MAILPUSH]

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

// [PB_MAILPUSH]
bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	'', &
	'', &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

/*	bRet = SQLCA.PS_I01_MAILPUSH ( &
		Long ( sIdSin ), &
		Upper ( SQLCA.DataBase ), &
		sMailDest, &
		sMailObjet, &
		bMailBody, &
		sBoiteMail, &
		sTypMail, &
		iIdAppli &
		) = 0*/
// :[PB_MAILPUSH]
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function long uf_zn_trt_divsin_telediag_ok (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_telediag_ok (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 28/05/2014
//* Libellé			: 
//* Commentaires	: [PC786-1_AUCHAN_GEM]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      	Date	     Modification
//* JFF 	15/06/2017 	[PC13321-3][MANTIS25406]
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin, lVal1, lVal2, lTot 
n_cst_string lnvPFCString
asData = Upper ( asData )
iAction = 0

lVal1 = idw_LstwCommande.Find ("ID_FOUR = 'BLC' AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.rowCount() )

If lVal1 > 0  Then
		idw_wDivSin.iiErreur = 8
		iAction = 1
		Return iAction 
End If

// [PC13321-3]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 266)
lVal1 = idw_LstwCommande.Find ("COD_ETAT <> 'ANN'", 1, idw_LstwCommande.rowCount() )

// [PC13321-3][MANTIS25406]
If lDeb > 0 And lVal1 > 0 Then
	Choose Case lnvPFCString.of_getkeyvalue( idw_DetPro.GetItemString(lDeb,"VAL_CAR") , "VARIANTE", ";") 
		Case  "BRUN", "GRIS"
			idw_wDivSin.iiErreur = 14
			iAction = 1
			Return iAction 
	End Choose 
End If

If lDeb > 0 And asData = "N" Then
	Choose case lnvPFCString.of_getkeyvalue( idw_DetPro.GetItemString(lDeb,"VAL_CAR") , "VARIANTE", ";") 
		Case  "BRUN", "GRIS"
		
			idw_wDivDet.SetFilter ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )" )
			idw_wDivDet.Filter ()
			lTot = idw_wDivDet.RowCount ()
			idw_wDivDet.SetFilter ( "" )
			idw_wDivDet.Filter ()
			idw_wDivDet.Sort ()			
			
			If lTot > 0 Then
				idw_wDivSin.iiErreur = 15
				iAction = 1
				Return iAction 
			End If
	End Choose 
End If

// [PC13321-3]

Return iAction

end function

private function boolean uf_validation_finale_advise_mail_2 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_ADVISE_Mail_2 (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 18/06/2014
//* Libellé       : Gestion Particulière pour ADVISE.
//* Commentaires  : [DT076_ADVISE_V3]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    15/12/06    N'est pas nécessaire pour une gestion Mondovelo.
//*								  Il n'y a pas plusieurs "cas de gestion" (un seul cas)
//* #2    JFF    26/10/09    [DCMP090651] Modif du mail
//* #3    JFF   27/01/2010   [DCMP090283] Renommage ..._TEL et ..._TEL1
//*       JFF    17/06/2011  [PC545].[BUG_BGE_721]
//		FPI	26/02/2013	[PC853_1] Pas d'option 119 sur les prod 481__
//		FPI	23/05/2014	[ITSM214496] PEC forcée
//		JFF	05/08/2014	[DT076][MANTIS11768]
//		JFF	04/08/2015	[VDOC18283]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp, sMailAssure
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest, sLibTypApp
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sResponsable, sIdFour, sMailFrom,sXml
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin, lCodeMag, lIdSeq
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
String libPersonneMobisquare
s_pass stPass

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 252 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
If IsNull ( sBoiteMail ) Then sBoiteMail = ""
sMailFrom=sBoiteMail
sTypMail = "ADVPSM"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

lRow = idw_LstInter.Find ( "COD_INTER='A'", 1, idw_LstInter.RowCount () )
If lRow > 0 Then
	sMailAssure = idw_LstInter.GetItemString ( lRow, "ADR_MAIL" ) 
	If IsNull ( sMailAssure ) Then sMailAssure = ""
End IF
		

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "INFO_SPB_FRN = 2116 AND " + &
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR IN ( 'PSM' )" 
			 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	// ON continue sans mail
	Return TRUE
End If	


/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sVar[1]		= "Advise"
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdFour = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" ) 

/*------------------------------------------------------------------*/
/* Le mail sera construit dans une DW qui sera directement (d'un    */
/* coup écrite sur disque). Je préfère cette option plutôt que      */
/* d'écrire un fichier texte progressivement sur disque avec des    */
/* FileWrite. Je trouve la solution de la DW plus sûr.              */
/*------------------------------------------------------------------*/

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow = idw_wdivsin.Find("nom_zone='cod_boutique_adh'", 1 , idw_wdivsin.Rowcount()+1 )
If lRow > 0 Then
	sVal = idw_wdivsin.GetItemString ( lRow, "VAL_CAR" )
Else
	sVal = "-1"
End If
lCodeMag = Long ( sVal ) 


lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + sVal, 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
	sTelDest = ""
	sNomMagasin = ""
	sResponsable = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
	sTelDest = dwChild.GetItemString ( lRow2, "ADR_TEL" )
	sNomMagasin = dwChild.GetItemString ( lRow2, "ADR_NOM" )
	sResponsable = dwChild.GetItemString ( lRow2, "RESPONSABLE" )
End If	

If IsNull ( sMailDest ) Then sMailDest = ""
If IsNull ( sTelDest ) Then sTelDest = ""
If IsNull ( sNomMagasin ) Then sNomMagasin = ""
If IsNull ( sResponsable ) Then sResponsable = ""

If sMailDest = "" Then
	
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sVar[1]		= sNomMagasin
	stMessage.sCode		= "COMD847"

	F_Message ( stMessage ) 
	Return FALSE

End If

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
Choose Case sIdFour
	Case "ADV"
		//	[DT076][MANTIS11768]
		sMailObjet = "ADVISE_ASSURANCE_N°" + sIdSin

		//	[VDOC18283]
		lIdSeq = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" ) 
		If IsNull ( lIdSeq ) Then lIdSeq = 0 
		sMailObjet += "-" + String ( lIdSeq )
		
		sMailObjet+= " - Bon prépayé envoyé par le centre technique de réparation"
		
		libPersonneMobisquare="PERSONNE_ADVISE_A_CONTACTER : "

	Case "PSM"
		//	[DT076][MANTIS11768]
		sMailObjet = "ADVISE_ASSURANCE_N°" + sIdSin 

		//	[VDOC18283]
		lIdSeq = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" ) 
		If IsNull ( lIdSeq ) Then lIdSeq = 0 
		sMailObjet += "-" + String ( lIdSeq )
		
		sMailObjet+= " - Bon prépayé envoyé par le centre technique de réparation"

End Choose
// :[PC514]

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Suite à la déclaration de sinistre de " +  Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ))  
sMailBody += " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ))
sMailBody += ", nous vous informons qu’un bon prépayé a été adressé à ce client afin qu’il expédie son appareil endommagé vers notre centre technique de réparation."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Le bon prépayé a été envoyé par mail, ou à défaut par voie postale."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Veuillez trouver ci-dessous les coordonnées utilisées :"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "- Adresse mail : " + sMailAssure
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "- Adresse postale : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) 
sMailBody += sSaut
sMailBody += "                    " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" )) 
sMailBody += sSaut

If Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) <> "" Then
	sMailBody += "                    " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
	sMailBody += sSaut
End If

If Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) <> "" Then
	sMailBody += "                    " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
	sMailBody += sSaut
End If

sMailBody += "                    " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Nous restons à votre entière disposition pour tout renseignement complémentaire et vous prions d’agréer, nos salutations distinguées."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "****************************************************************"
sMailBody += sSaut
sMailBody += "AVERTISSEMENT : NE PAS REPONDRE A CE MAIL"
sMailBody += sSaut
sMailBody += "****************************************************************"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Cet e-mail étant généré de façon automatique, nous vous remercions de ne pas utiliser l'adresse d'origine pour nous contacter, votre message ne pouvant être traité en retour."

// [PB_MAILPUSH]
// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)
// :[PB_MAILPUSH]

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

// [PB_MAILPUSH]
	bRet = SQLCA.PS_I02_MAILPUSH( &
		Long ( sIdSin ), &
		Upper ( SQLCA.DataBase ), &
		sMailFrom, &
		sMailDest, &
		'', &
		'', &
		sMailObjet, &
		bMailBody, &
		'', &
		sTypMail, &
		iIdAppli, &
		'KSL', &
		-1, &
		sXml &
		) = 0
		
/*	bRet = SQLCA.PS_I01_MAILPUSH ( &
		Long ( sIdSin ), &
		Upper ( SQLCA.DataBase ), &
		sMailDest, &
		sMailObjet, &
		bMailBody, &
		sBoiteMail, &
		sTypMail, &
		iIdAppli &
		) = 0
*/
// :[PB_MAILPUSH]
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function long uf_zn_trt_divsin_cra_last_dte (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_cra_last_dte (PRIVATE)
//* Auteur			: FPI
//* Date				: 01/07/2014
//* Libellé			: Contrôle de la zone cra_last_dte
//* Commentaires	: [DT031-2]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../.... 
//*-----------------------------------------------------------------

Integer iAction
Long lRow, lDeb, lFin

if asData="" Then return 0

F_rechdetpro(lDeb, lFin, idw_detpro, idw_wsin.getitemNumber( 1, "ID_PROD"), "-DP", 263)
if lDeb <=0 Then return 0

iAction=0

if idw_lstwcommande.RowCount() > 0 or idw_wrefus.RowCount() > 0 &
						Or idw_wreggti.RowCount() >0 Then 
	idw_wDivSin.iiErreur = 4
	iAction = 1			
Else
	lRow=idw_wdivsin.Find("upper(nom_zone)='CRA_SUIVI_IMEI'",1,idw_wdivsin.RowCount())

	If lRow > 0 Then 
		uf_gestong_divers_majzone( "CRA_SUIVI_IMEI", lRow, K_MAJZONE, 2)
	End if
End if

Return iAction

end function

public subroutine uf_police_orange_v2bis ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_Police_Orange_V2BIS (PRIVATE)
//* Auteur			: JFF
//* Date				: 30/07/2014
//* Libellé			: 
//* Commentaires	: // [PC512-5_ORANGE_V2_BIS]
//*						  [PM234-4_V1]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Long lDeb, lFin, lRow
n_cst_string lnvString
String sVal, sValCar, sVal2

// [PC512-5_ORANGE_V2_BIS]
If This.uf_GestOng_Divers_Trouver ( "ORANGE_V2_BIS" ) = "O" Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 241 )
	If lDeb > 0 Then
		sValCar = idw_DetPro.GetItemString ( lDeb , "VAL_CAR" )
		sVal = lnvString.of_getkeyvalue( sValCar, "LIB_POLICE", ";")
		If IsNull ( sVal ) Then sVal = ""
		If Trim ( sVal ) = "" Then sVal = "Lib Police Absent -DP/241"
		
		If Len ( sVal ) > 0 Then

			sVal2 = This.uf_GestOng_Divers_Trouver ( "LIB_POLICE" ) 
			If IsNUll ( sVal2 ) Or Trim ( sVal2 ) = "" Then
				lRow = idw_WDivSin.Find ( "NOM_ZONE = 'lib_police'", 1,  idw_WDivSin.RowCount () ) 
	
				If lRow > 0 Then
					This.uf_gestong_divers_majzone( "LIB_POLICE", lRow, K_MAJZONE, sVal )					
				End If
			End If
			
		End If
	Else
		stMessage.sTitre		= "Paramètrage"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sCode		= "WSIN757"
		iPbControler.Enabled = FALSE
		If isTypeTrt = "S" Then F_Message ( stMessage )
	End IF
End If
// [PC512-5_ORANGE_V2_BIS]	


end subroutine

private function boolean uf_validation_finale_mbs_ech_express (long alidgti);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_mbs_ech_express  (PRIVATE)
//* Auteur        : FPI
//* Date          : 11/08/2014
//* Libellé       : MAIL pour Mobistore dans le cadre de l'échange express 48h.
//* Commentaires  : [PC13442]
//*
//* Arguments     : alIdGti	Long	id garantie
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    19/05/2015  [PC13442-1][MANTIS15248]
//*       JFF    28/06/2016  [PC151549]
//       JFF   14/03/2025 [PMO268_MIG56]
//*-----------------------------------------------------------------

Boolean bRet, bMobistore
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt
String  sIdDetail, sRech, sMailDest,  sRepSav, sRepFicSav, sVal, sAdrLibCiv
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml, sLibProd
Decimal{2}	dcMtMaxTTC
DataWindowChild dwChild
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Integer iIdAppli
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDMBS"
sLibProd="Mobil’Zen 2"
iIdAppli=2

bRet = True

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
// [PC151549]
sFiltre = "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'MBS'" 

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 302 )
If lDeb > 0 Then
	sTypMail="CMDBST"
	sLibProd="Mobil’Zen 3"
	sFiltre = "COD_ETAT   = 'CNV' AND " + &  
				 "CPT_VALIDE <= 0    AND " + &
				 "ID_FOUR    = 'BST'" 
End If

// [PMO268_MIG56]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 395 )
If lDeb > 0 Then
	sLibProd="Mobil’Zen 4"
End If 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

lIdGti=idw_LstwCommande.GetItemNumber(1, "ID_GTI")

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/
idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
sMailObjet="Accord de principe – Remplacement Express " 
if lIdGti=10 Then 
	sMailObjet+="Vol"
Else
	sMailObjet+="Dommage/Oxydation"
End if

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow3 = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow3 > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow3, "MT_VAL_PUBLIQUE" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If


sMailBody="Bonjour," + sSaut
sMailBody+=sSaut
sMailBody+=sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + " nous a fait part du "

if lIdGti=10 Then 
	sMailBody+="vol de son appareil "
Else
	sMailBody+="dommage subi par son appareil "
End if

sMailBody+="dans le cadre de son adhésion à l’assurance « " + sLibProd + " ». Les éléments, tels que décrits, sont couverts par son contrat. "
sMailBody+="De ce fait, nous vous prions de bien vouloir procéder au "

if lIdGti=10 Then 
	sMailBody+="remplacement de son appareil, dans le cadre de la prise en charge de son dossier n° " + sIdSin 
	sMailBody+=", pour un montant de " + String ( dcMtMaxTTC , "#####0.00" ) + "€." + sSaut
	sMailBody+=sSaut
	sMailBody+="Nous vous remercions de nous retourner, en réponse à ce mail, les coordonnées du nouvel appareil (marque, modèle et numéro de série ou IMEI). " + sSaut
Else
	sMailBody+="diagnostic de son appareil " + f_getItem3(idw_wsin, 1,"MARQ_PORT") + " " + f_getItem3(idw_wsin, 1,"MODL_PORT") 
	sMailBody+=", dont le numéro de série/IMEI est le "+ f_getItem3(idw_wsin, 1,"NUM_IMEI_PORT") + ", pour le motif suivant : " 
	/*If lIdGti=11 Then
		sMailBody+="Dommage accidentel. " + sSaut
	Else
		sMailBody+="Oxydation. " + sSaut
	End if*/
	sMailBody+= lower( idw_wsin.Describe ( "Evaluate ('LookUpDisplay ( ID_NATSIN )', 1)" ) )  + "." + sSaut
	
	sMailBody+="Ce diagnostic a pour but de valider la prise en charge de son dossier n° " + sIdSin + ". " 
	sMailBody+="En cas de confirmation des faits, le montant alloué à la prise en charge de ce dossier est de " +  String ( dcMtMaxTTC , "#####0.00" ) + "€." + sSaut
	sMailBody+=sSaut
	sMailBody+="A la suite de votre diagnostic, nous vous remercions de nous retourner, en réponse à ce mail :" + sSaut
	sMailBody+="-	Les coordonnées du nouvel appareil (marque, modèle et numéro de série ou IMEI) en cas d’acceptation du dossier." + sSaut
	sMailBody+="-	Le résultat du diagnostic en cas de refus du dossier." + sSaut
End if

// [PC13442-1][MANTIS15248]
/* Vu avec Elodie Duboc et Lisette, je shunte cette partie.
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="De plus, en cas d’acceptation du dossier, nous vous remercions de transmettre l’appareil endommagé,"
sMailBody+="en l’envoyant dans un colis de taille adaptée à celle du bien, en y apposant le bon prépayé que vous "
sMailBody+="aurez téléchargé et imprimé (modalités de récupération du bon définies dans le mail qui vous a été transmis "
sMailBody+="par notre centre technique)."
sMailBody+=sSaut
*/

sMailBody+=sSaut
sMailBody+="Cordialement," + sSaut
sMailBody+=sSaut
sMailBody+="Service Assurance " + sLibProd + "."

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If


Return bRet

end function

private function long uf_zn_trt_divsin_dcnxdeclaatlas (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_DcnxDeclaAtlas (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 28/08/2014
//* Libellé			: [PM234-4_V1]
//* Commentaires	: 
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin

asData = Upper ( asData )
iAction = 0

If asData = "O" Then
	If Not This.uf_GetAutorisation2 ( 27 )	Then
		idw_wDivSin.iiErreur = 9
		iAction = 1
		Return iAction 
	End If

   stMessage.sTitre   = "Déconnexion Décla Atlas"
   stMessage.Icon     = Exclamation!
   stMessage.bErreurG = FALSE
   stMessage.sCode    = "P234019" 
   stMessage.Bouton   = YesNo!

   If F_Message ( stMessage ) = 2 Then
      iAction = 2 // Reject tha data
		Return iAction
	End If

	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'manque_info_atlas'", 1,  idw_WDivSin.RowCount () )
	If lRow > 0 Then
		This.uf_gestong_divers_majzone( "MANQUE_INFO_ATLAS", lRow, K_MAJZONE, "N" )
	End If

End If 

If asData = "N" Then
	iAction = 2
End If

Return iAction

end function

public function boolean uf_scripting_v2bis ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Scripting_V2BIS
//* Auteur			: Fabry JF
//* Date				: 10/05/2013
//* Libellé			: 
//* Commentaires	: [PM234-4_V1]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   Date	      Modification
//*-----------------------------------------------------------------

Long lIdNatsin, lIdDetSin, lRow, lRow2, lRefus
String sLibNatSin
Boolean bV2BIS, bFinScript

/*
22  VOL AVEC EFFRACTION                
32	VOL PAR INTRODUCTION CLANDESTINE   
37	VOL A LA SAUVETTE                  
27  DOMMAGE ACCIDENTEL                 
*/

lRow = idw_WDivSin.Find ( "NOM_ZONE = 'decla_atlas' AND VAL_CAR = 'O'", 1,  idw_WDivSin.RowCount () )

lRow2 = idw_WDivSin.Find ( "NOM_ZONE = 'dcnx_decla_atlas' AND VAL_CAR = 'O'", 1,  idw_WDivSin.RowCount () )
If lRow2 > 0 Then lRow = 0

If lRow <= 0 Then Return True

lRow = idw_WDivSin.Find ( "NOM_ZONE = 'fin_script' AND VAL_CAR = 'O'", 1,  idw_WDivSin.RowCount () )
If lRow > 0 Then Return True


bV2BIS = False
lRefus = -1
bFinScript = True

lIdNatSin = idw_wSin.GetItemNumber ( 1, "ID_NATSIN" )	
lIdDetSin = idw_wSin.GetItemNumber ( 1, "ID_DETSIN" )	
sLibNatSin = idw_wSin.Describe ( "Evaluate ( 'LookUpDisplay ( ID_NATSIN )', 1 ) " )

If IsNull ( lIdNatSin ) Or lIdNatSin = 0 Then
	stMessage.Bouton		= Ok!
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "P234022" 

	bFinScript = False
	
	f_Message ( stMessage ) 
	
	Return bFinScript	
	
End If

If IsNull ( lIdDetSin ) Or lIdDetSin = 0 Then
	stMessage.Bouton		= Ok!
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "P234023" 

	bFinScript = False	
	
	f_Message ( stMessage ) 
	
	Return bFinScript	
	
End If




Choose Case lIdNatsin
		
	Case 22 // VOL AVEC EFFRACTION
		
			// l’appareil était-il visible de l’extérieur ?
			stMessage.Bouton		= YESNO!
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "P234001" 

			// NON
			If f_Message ( stMessage ) = 2 Then
				
				/*
				91	LOCAL IMMOBILIER              91, 26, 10, 12, 11     
				11	AERONEF    
				12	BATEAU    
				10	VEHICULE   
				26	HABITATION   
				
				71	BIEN MOBILIER                    
				13	CARAVANE     
				*/


				Choose Case lIdDetSin 
					Case 71, 13
						
						// Détail bien mobilier (caisson, vestiaire) / caravane -> V2bis
						bV2BIS = True
						
					Case Else // 91, 11, 12, 10, 26
						// 	Détail local immobilier / habitation / véhicule / bateau / aéronef -> V2
						bV2BIS = False
						
				End Choose 
				
				
			
			// OUI
			Else 

				Choose Case lIdDetSin 
						
					Case 91, 71, 26
						
						// Détail bien mobilier (caisson, vestiaire) / caravane -> V2bis
						bV2BIS = True
						
					Case Else 
						// Autre lieu -> refus
						bV2BIS = False
						lRefus = 1740
						
				End Choose 
				
			End If
			
		
	Case 32 // VOL PAR INTRODUCTION CLANDESTINE

			// qui se trouvait sur les lieux au moment des faits ?
			// L'adhérent ? (Oui)
			stMessage.Bouton		= YESNO!
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "P234002" 

			// Oui Adhérent
			If f_Message ( stMessage ) = 1 Then
				
				Choose Case lIdDetSin 
					Case 13
						
						// Détail caravane -> V2bis
						bV2BIS = True
						
					Case Else // 91, 26, 10, 12, 11     
						//	Détail local immobilier / habitation / véhicule terrestre à moteur / bateau / aéronef 
						bV2BIS = False
						
				End Choose
			
			// Non adhérent
			Else 
				// qui se trouvait sur les lieux au moment des faits ?
				// Personne autorisée par l'Adhérent ? (Oui)
				stMessage.Bouton		= YESNO!
				stMessage.Icon			= Question!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "P234003" 
				
				// Oui Personne autorisée par l'Adhérent
				If f_Message ( stMessage ) = 1 Then
					
					//	Si personne autorisée par l’adhérent sur les lieux -> V2bis
					bV2BIS = True
					
				//	Autre personne sur les lieux -> refus
				Else 
					bV2BIS = False
					lRefus = 1744
				End If			
				
			End If 

		
		
	Case 37 // VOL A LA SAUVETTE

			// à quelle distance se trouvait l’appareil garanti au moment du vol ?
			// 1 mètre ? (Oui)
			stMessage.Bouton		= YESNO!
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "P234004" 

			// Oui 1 mètre
			If f_Message ( stMessage ) = 1 Then
				bV2BIS = False
			Else
				// à quelle distance se trouvait l’appareil garanti au moment du vol ?
				// 2-3 mètres  ? (Oui)
				stMessage.Bouton		= YESNO!
				stMessage.Icon			= Question!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "P234005" 
				
				// Oui 2-3 mètre
				If f_Message ( stMessage ) = 1 Then
					bV2BIS = True
				
				// Plus de 3 mètres
				Else 
					bV2BIS = False
					lRefus = 1745
				End If
				
			End If
		
		
	Case 27 // DOMMAGE ACCIDENTEL
		
			// le dommage est-il extérieurement visible ?
			// (Oui)
			stMessage.Bouton		= YESNO!
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "P234006" 

			// Oui 
			If f_Message ( stMessage ) = 1 Then
				bV2BIS = False
				
			// Non	
			Else
				bV2BIS = True
			
			End If
		
End Choose

// Dommage
If Pos ( sLibNatSin, "DOMMAGE" ) > 0 And lIdNatsin <> 27 Then

	// y a-t-il une notion d’accident ou d’événement extérieur dans la déclaration de l’assuré ? 
	stMessage.Bouton		= YESNO!
	stMessage.Icon			= Question!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "P234007" 
	

	// Oui 
	If f_Message ( stMessage ) = 1 Then
		bV2BIS = False

		stMessage.Bouton		= Ok!
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "P234008" 

		bFinScript = False	
		
		f_Message ( stMessage ) 
		
	// Non	
	Else
		bV2BIS = True
	
	End If
		
		
End IF 

// Traitement des réponses

If bFinScript Then

	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'fin_script'", 1,  idw_WDivSin.RowCount () )
	If lRow > 0 Then
		This.uf_gestong_divers_majzone( "FIN_SCRIPT", lRow, K_MAJZONE, "O" )
	End If

	If lRefus > 0 Then
		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'refus_script'", 1,  idw_WDivSin.RowCount () )
		If lRow > 0 Then
			This.uf_gestong_divers_majzone( "REFUS_SCRIPT", lRow, K_MAJZONE, lRefus )
		End If
	End If 

	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'orange_v2_bis'", 1,  idw_WDivSin.RowCount () )
	If bV2BIS Then
		If lRow > 0 Then
			This.uf_gestong_divers_majzone( "ORANGE_V2_BIS", lRow, K_MAJZONE, "O" )
		End If
		This.uf_Police_Orange_V2BIS ()		
	End If 

End If


Return bFinScript
end function

private function long uf_zn_trt_divsin_recredit_imm (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_Recredit_Imm (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 30/09/2014
//* Libellé			: [DT081-1_CREDIMM]
//* Commentaires	: 
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Integer iAction
String sVal
Long lRow, lDeb, lFin

asData = Upper ( asData )
iAction = 0
sVal = This.uf_GestOng_Divers_Trouver ( "ETAT_CAUTION_PAYBOX" ) 

If asData = "O" Then

	Choose Case sVal
		Case "DEBTOT", "DEBPAR", "RECRKO"
			// OK on peut recréditer

			If Not This.uf_GetAutorisation2 ( 30 )	Then
					idw_wDivSin.iiErreur = 12
					iAction = 1
					Return iAction 
			End If
			
		Case "RECRED"			

			idw_wDivSin.iiErreur = 11
			iAction = 1 
			Return iAction
			
		Case Else

			idw_wDivSin.iiErreur = 10
			iAction = 1 
			Return iAction
			
	End CHoose 
	
End If 

If asData = "N" Then
	If sVal = "RECRED" Then
		idw_wDivSin.iiErreur = 11
		iAction = 1 
		Return iAction
	End If
End If

Return iAction

end function

private function long uf_zn_trt_divsin_interv_serrurier (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_interv_serrurier (PRIVATE)
//* Auteur			: FPI
//* Date				: 06/10/2014
//* Libellé			: 
//* Commentaires	: [PC13174]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin, lVal1, lVal2

asData = Upper ( asData )
iAction = 0

if idw_wDetail.Find ( "ID_EVT=1419 And (COD_ETAT = 600 OR COD_ETAT = 500)", 1, idw_wDetail.RowCount () ) > 0  Then 
		iAction = 2
End If

Return iAction

end function

private function long uf_zn_trt_divsin_pret_app_endommage (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_Divsin_pret_app_endommage (PRIVATE)
//* Auteur			: FPI
//* Date				: 07/10/2014
//* Libellé			: Contrôle de la zone pret_app_endommage
//* Commentaires	: 
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Long lRow
Long lCpt, lIdGti, lIdDetail 
Integer iAction=0
n_cst_string lnvPFCString		
String sVal, sRech


If asData="N" Then return 0

stMessage.sTitre   = "Recrédit de caution"
stMessage.Icon     = Exclamation!
stMessage.bErreurG = FALSE
stMessage.sCode    = "WSIN780" 
stMessage.Bouton   = YesNo!

If F_Message ( stMessage ) = 2 Then
	iAction = 2 // Reject tha data
End If

Return iAction


end function

private function long uf_zn_trt_divsin_paybox_cb_forcee (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_franchise_paybox_cb_forcee (PRIVATE)
//* Auteur			: FPI
//* Date				: 08/10/2014
//* Libellé			: Contrôle de la zone franchise_paybox_cb_forcee
//* Commentaires	: [FORCER_PAIEMENT_PAYBOX]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../.... 
//*-----------------------------------------------------------------

Integer iAction
Long lRow, lDeb, lFin

if asData="N" Then return 2

if not uf_getautorisation2( 29) Then return 2

iAction=0

stMessage.sTitre      = "Gestion de sinistres SIMPA2"
stMessage.Icon         = Information!
stMessage.bErreurG   = FALSE
stMessage.sCode      = "WSIN781"
stMessage.Bouton      = YesNo!
			
If F_Message ( stMessage ) = 2 Then
	iAction = 2 // Reject tha data
End If

If iAction=0 Then
	lRow=idw_wdivsin.Find("upper(nom_zone)='MODE_PAIEMENT'",1,idw_wdivsin.RowCount())

	If lRow > 0 Then 
		uf_gestong_divers_majzone( "MODE_PAIEMENT", lRow, K_MAJZONE, "CB")
	End if

	lRow=idw_wdivsin.Find("upper(nom_zone)='FRANCHISE_PAYBOX'",1,idw_wdivsin.RowCount())

	If lRow > 0 Then 
		uf_gestong_divers_majzone( "FRANCHISE_PAYBOX", lRow, K_MAJZONE, "O")
	End if
End if

Return iAction

end function

private function boolean uf_validation_finale_mbs_ech_express_o2m ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_mbs_ech_express_o2m  (PRIVATE)
//* Auteur        : FPI
//* Date          : 11/08/2014
//* Libellé       : MAIL pour Mobistore dans le cadre de l'échange express 48h / diag O2M.
//* Commentaires  : [PC13442.V6]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
String  sIdSin, sFiltre
String  sIdDetail, sRech, sMailDest,  sRepSav, sRepFicSav, sVal, sAdrLibCiv
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
DataWindowChild dwChild
n_cst_string lnvPFCString
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci
Integer iIdAppli
n_cst_cmd_commun lnvCmdCommun
Long lIdProd
String sNomLigne1, sNomLigne2, sAdrLigne1, sAdrLigne2, sCp, sVille

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDMBS"
iIdAppli=2

bRet = True
lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )
sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))


sFiltre = "ID_TYP_ART = 'EDI' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_REF_FOUR ='A_DIAGNOSTIQUER'  AND " + &
			 "ID_FOUR    = 'O2M'" 

lRow3=idw_lstwcommande.Find(sFiltre,1,idw_lstwcommande.RowCount())

if lRow3 <=0 Then return bRet

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/
idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	

If not bRet Then return FALSE

// Adresse O2M
lnvCmdCommun.uf_GetAdresseO2M_2 ( &
	"", &
	"", &
	0, &
	"",&
	"",&
	"",&
	0,&
	"",&
	"",&
	idw_LstwCommande,&
	idw_wDivSin,&
	idw_DetPro,& 
	lIdProd,&
	sNomLigne1,&
	sNomLigne2,& 
	sAdrLigne1,& 
	sAdrLigne2,&
	sCP,&
	sVille )

/*------------------------------------------------------------------*/
/* 1.1 : Ligne Objet du mail --> 2ème ligne du fichier Texte qui    */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
sMailObjet="Procédure d’envoi du mobile sinistré chez SPBS  – dossier " + sIdSin

sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, lRow3, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If


sMailBody="Bonjour," + sSaut
sMailBody+=sSaut
sMailBody+="Nous revenons vers vous concernant le dossier n° " + sIdSin + " de " + sAdrLibCiv + " " + Upper ( F_GetItem3 ( idw_LstwCommande, lRow3, "ADR_NOM" )) + "."
sMailBody+=sSaut
sMailBody+="Nous vous remercions de transmettre le bien dont vous avez effectué l’expertise, " 
sMailBody+="par le biais d’un colis de taille adaptée, à l’adresse suivante :" + sSaut
sMailBody+=sSaut

If Not IsNull ( sNomLigne1 ) And Len ( sNomLigne1 ) > 0 Then sMailBody += sNomLigne1 + sSaut
If Not IsNull ( sNomLigne2 ) And Len ( sNomLigne2 ) > 0 Then sMailBody += sNomLigne2 + sSaut
If Not IsNull ( sAdrLigne1 ) And Len ( sAdrLigne1 ) > 0 Then sMailBody += sAdrLigne1 + sSaut
If Not IsNull ( sAdrLigne2 ) And Len ( sAdrLigne2 ) > 0 Then sMailBody += sAdrLigne2 +sSaut
If Not IsNull ( sCP ) And Len ( sCP ) > 0 Then sMailBody += sCP 
If Not IsNull ( sVille ) And Len ( sVille ) > 0 Then sMailBody += " " + sVille + sSaut

sMailBody+=sSaut
sMailBody+="Cordialement," + sSaut
sMailBody+=sSaut
sMailBody+="Service Assurance Mobil’Zen 2."

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	"" &
	) = 0
	
If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If


Return bRet

end function

private subroutine uf_determiner_courrier_forcage_leclerc (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_Leclerc (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 24/02/2011
//* Libellé       : 
//* Commentaires  : [DT125_LECLERC]
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech
Long   				lDeb, lFin, lTotCourrier, lLig, lCpt
string				sTypApp, sAdrMail
Boolean				bCondition			


F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 61 )
If lDeb <= 0 Then Return 

sAdrMail = idw_LstInter.GetItemString ( alCpt, "ADR_MAIL" ) 
If IsNull ( sAdrMail ) Then sAdrMail = ""

If sAdrMail = "" Then
	sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_POSTAL", ";")
Else 
	sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_MAIL", ";")
End If 

bCondition = asPos = "" &
					And lDeb > 0 &
					And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" &
					And sIdNatCourForcage <> "" &
					And idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR = 'LBE' AND ID_TYP_ART = 'CAF'", 1, idw_LstwCommande.rowCount()+1 ) > 0 
			

If IsNull ( sIdNatCourForcage ) Then sIdNatCourForcage  = ""

If bCondition Then

		sIdNatPresent = asIdNatCour
		
		If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

		If sIdNatPresent <> sIdNatCourForcage Then

			If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= sIdNatCourForcage
				
			Else
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= asIdNatCour
				stMessage.sVar[2] 	= sIdNatCourForcage
			End If 
			
			If F_Message ( stMessage ) = 1 Then

				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!							

				idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
				lTotCourrier	= dwChild.RowCount ()
				sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
				lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
		
		/*------------------------------------------------------------------*/
		/* On verifie si la nature de courrier existe. Si elle n'existe     */
		/* pas, par un effet du hasard bien sur, on arrete le traitement    */
		/* et on positionne sur REF_CIE.                                    */
		/*------------------------------------------------------------------*/
				If	lLig = 0	Then
		
		/*------------------------------------------------------------------*/
		/* On arme la structure de message maintenant, mais le message va   */
		/* être affiché dans le contrôle de gestion.                        */
		/*------------------------------------------------------------------*/
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= Information!
					stMessage.sCode		= "WSIN170"
					stMessage.sVar[1] 	= sIdNatCourForcage
					asPos = "REF_CIE"
				Else
					If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
						asIdNatCour = sIdNatCourForcage
						asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
						
						idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
						idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
						idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
					Else 
						// Le message est armé dans uf_GestionCP
						asPos = "REF_CIE"

					End If
				End If		
			End If
		End If
End If


end subroutine

public function boolean uf_validation_finale_mail_ctl_imei ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_mail_ctl_imei  (PRIVATE)
//* Auteur        : FPI
//* Date          : 27/01/2015
//* Libellé       : Envoi de mail de contrôle IMEI Orange
//* Commentaires  : [DT129]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//        JFF   02/09/2019 [DT424]
//*-----------------------------------------------------------------
n_cst_string nvString 
Boolean bEnvoyer, bRet, bDT424_Flux
Long lRow, lDeb, lFin
String sSql

bRet=TRUE
bEnvoyer=FALSE

F_rechdetpro (lDeb, lFin, idw_detpro, idw_wsin.GetItemNumber(1,"ID_PROD"), "-DP", 268)
if lDeb <=0 Then return TRUE

// DT424
bDT424_Flux = nvString.of_getkeyvalue(idw_detpro.GetItemString(lDeb,"VAL_CAR"), "DT424_FLUX",";") = "OUI"

If nvString.of_getkeyvalue(idw_detpro.GetItemString(lDeb,"VAL_CAR"), "CONTESTATION_UNIQT",";") <> "OUI" Then
	bEnvoyer=(uf_gestong_divers_trouver( "CRA_CTRL_IMEI") = "O")
End if

If not bEnvoyer Then
	lRow=idw_wdivsin.Find("Upper(NOM_ZONE)='CONTESTATION' And CPT_VALIDE <=0 And VAL_CAR='O'", 1, idw_wdivsin.rowcount( ))
	bEnvoyer=(lRow > 0)
End if

If bEnvoyer Then
	
	// [DT424]
/*	If F_CLE_A_TRUE ( "DT424" ) Then
		If bDT424_Flux Then
			sSql = "Exec sysadm.PS_S_COMMANDE_ORANGE_CTL_IMEI " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
		Else 
			sSql = "Exec sysadm.PS_S_MAILPUSH_ORANGE_CTL_IMEI " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."			
		End If 
	Else */
		sSql = "Exec sysadm.PS_S_MAILPUSH_ORANGE_CTL_IMEI " + String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "."
//	End If 	
		
	F_Execute ( sSql, SQLCA )
	bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0

End if

Return bRet

end function

public function boolean uf_scripting_v2bis_ent ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Scripting_V2BIS_ENT
//* Auteur			: Fabry JF
//* Date				: 10/05/2013
//* Libellé			: 
//* Commentaires	: [PM234-4_V1]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   Date	      Modification
//*-----------------------------------------------------------------

Long lIdNatsin, lIdDetSin, lRow, lRow2, lRefus
String sLibNatSin
Boolean bV2BIS, bFinScript

/*
22  VOL AVEC EFFRACTION                
32	VOL PAR INTRODUCTION CLANDESTINE   
37	VOL A LA SAUVETTE                  
27  DOMMAGE ACCIDENTEL                 
*/

lRow = idw_WDivSin.Find ( "NOM_ZONE = 'decla_atlas' AND VAL_CAR = 'O'", 1,  idw_WDivSin.RowCount () )

lRow2 = idw_WDivSin.Find ( "NOM_ZONE = 'dcnx_decla_atlas' AND VAL_CAR = 'O'", 1,  idw_WDivSin.RowCount () )
If lRow2 > 0 Then lRow = 0

If lRow <= 0 Then Return True

lRow = idw_WDivSin.Find ( "NOM_ZONE = 'fin_script' AND VAL_CAR = 'O'", 1,  idw_WDivSin.RowCount () )
If lRow > 0 Then Return True


bV2BIS = False
lRefus = -1
bFinScript = True

lIdNatSin = idw_wSin.GetItemNumber ( 1, "ID_NATSIN" )	
lIdDetSin = idw_wSin.GetItemNumber ( 1, "ID_DETSIN" )	
sLibNatSin = idw_wSin.Describe ( "Evaluate ( 'LookUpDisplay ( ID_NATSIN )', 1 ) " )

If IsNull ( lIdNatSin ) Or lIdNatSin = 0 Then
	stMessage.Bouton		= Ok!
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "P234022" 

	bFinScript = False
	
	f_Message ( stMessage ) 
	
	Return bFinScript	
	
End If

If IsNull ( lIdDetSin ) Or lIdDetSin = 0 Then
	stMessage.Bouton		= Ok!
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "P234023" 

	bFinScript = False	
	
	f_Message ( stMessage ) 
	
	Return bFinScript	
	
End If




Choose Case lIdNatsin
		
	Case 22 // VOL AVEC EFFRACTION
		
			// l’appareil était-il visible de l’extérieur ?
			stMessage.Bouton		= YESNO!
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "P234001" 

			// NON
			If f_Message ( stMessage ) = 2 Then
				
				/*
				91	LOCAL IMMOBILIER              91, 26, 10, 12, 11     
				11	AERONEF    
				12	BATEAU    
				10	VEHICULE   
				26	HABITATION   
				
				71	BIEN MOBILIER                    
				13	CARAVANE     
				*/


				Choose Case lIdDetSin 
					Case 71, 13, 12, 11
						
						// Détail bien mobilier (caisson, vestiaire) / caravane  / bateau / aéronef -> V2bis
						bV2BIS = True
						
					Case Else // 91, 10, 26
						// Détail local immobilier / habitation / véhicule -> V2
						bV2BIS = False
						
				End Choose 
				
				
			
			// OUI
			Else 

				Choose Case lIdDetSin 
						
					Case 91, 71, 26
						
						//	Détail Local immobilier / Bien mobilier (caisson, vestiaire) / Habitation -> V2bis
						bV2BIS = True
						
					Case Else 
						// Autre lieu -> refus
						bV2BIS = False
						lRefus = 1740
						
				End Choose 
				
			End If
			
		
	Case 32 // VOL PAR INTRODUCTION CLANDESTINE

			// qui se trouvait sur les lieux au moment des faits ?
			// L'adhérent ? (Oui)
			stMessage.Bouton		= YESNO!
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "P234002" 

			// Oui Adhérent
			If f_Message ( stMessage ) = 1 Then
				
				Choose Case lIdDetSin 
					Case 91, 13, 12, 11
						
						//	Détail  local immobilier, caravane, bateau, aéronef -> V2bis
						bV2BIS = True
						
					Case Else 
						// Détail habitation / véhicule terrestre à moteur -> V2
						bV2BIS = False
						
				End Choose
			
			// Non adhérent
			Else 
				// qui se trouvait sur les lieux au moment des faits ?
				// Personne autorisée par l'Adhérent ? (Oui)
				stMessage.Bouton		= YESNO!
				stMessage.Icon			= Question!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "P234003" 
				
				// Oui Personne autorisée par l'Adhérent
				If f_Message ( stMessage ) = 1 Then
					
					//	Si personne autorisée par l’adhérent sur les lieux -> V2bis
					bV2BIS = True
					
				//	Autre personne sur les lieux -> refus
				Else 
					bV2BIS = False
					lRefus = 1744
				End If			
				
			End If 

		
		
	Case 37 // VOL A LA SAUVETTE

			// à quelle distance se trouvait l’appareil garanti au moment du vol ?
			// 1 mètre ? (Oui)
			stMessage.Bouton		= YESNO!
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "P234004" 

			// Oui 1 mètre
			If f_Message ( stMessage ) = 1 Then
				bV2BIS = False
			Else
				// à quelle distance se trouvait l’appareil garanti au moment du vol ?
				// 2-3 mètres  ? (Oui)
				stMessage.Bouton		= YESNO!
				stMessage.Icon			= Question!
				stMessage.bErreurG	= FALSE
				stMessage.sCode		= "P234005" 
				
				// Oui 2-3 mètre
				If f_Message ( stMessage ) = 1 Then
					bV2BIS = True
				
				// Plus de 3 mètres
				Else 
					bV2BIS = False
					lRefus = 1745
				End If
				
			End If
		
		
	Case 27 // DOMMAGE ACCIDENTEL
		
			// le dommage est-il extérieurement visible ?
			// (Oui)
			stMessage.Bouton		= YESNO!
			stMessage.Icon			= Question!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "P234006" 

			// Oui 
			If f_Message ( stMessage ) = 1 Then
				bV2BIS = False
				
			// Non	
			Else
				bV2BIS = True
			
			End If
		
End Choose

// Dommage
If Pos ( sLibNatSin, "DOMMAGE" ) > 0 And lIdNatsin <> 27 Then

	// y a-t-il une notion d’accident ou d’événement extérieur dans la déclaration de l’assuré ? 
	stMessage.Bouton		= YESNO!
	stMessage.Icon			= Question!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "P234007" 
	

	// Oui 
	If f_Message ( stMessage ) = 1 Then
		bV2BIS = False

		stMessage.Bouton		= Ok!
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "P234008" 

		bFinScript = False	
		
		f_Message ( stMessage ) 
		
	// Non	
	Else
		bV2BIS = True
	
	End If
		
		
End IF 

// Traitement des réponses

If bFinScript Then

	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'fin_script'", 1,  idw_WDivSin.RowCount () )
	If lRow > 0 Then
		This.uf_gestong_divers_majzone( "FIN_SCRIPT", lRow, K_MAJZONE, "O" )
	End If

	If lRefus > 0 Then
		lRow = idw_WDivSin.Find ( "NOM_ZONE = 'refus_script'", 1,  idw_WDivSin.RowCount () )
		If lRow > 0 Then
			This.uf_gestong_divers_majzone( "REFUS_SCRIPT", lRow, K_MAJZONE, lRefus )
		End If
	End If 

	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'orange_v2_bis'", 1,  idw_WDivSin.RowCount () )
	If bV2BIS Then
		If lRow > 0 Then
			This.uf_gestong_divers_majzone( "ORANGE_V2_BIS", lRow, K_MAJZONE, "O" )
		End If
		This.uf_Police_Orange_V2BIS ()		
	End If 

End If


Return bFinScript
end function

public function boolean uf_pi052_droitparam (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_PI052_DroitParam			(PUBLIC)
//* Auteur			: Fabry JF
//* Date				: 12/06/2014
//* Libellé			: 
//* Commentaires	: [PI052]
//*
//* Arguments		: Aucun
//*
//* Retourne		: Integer						 1 = Tout est OK
//*														-1 = Il y a un problème
//*
//*-----------------------------------------------------------------
//* MAJ      PAR      Date	   Modification
//*-----------------------------------------------------------------
Long lDeb, lFin
String sVal
n_cst_string lnvPFCString
boolean bPI052_GenEdtKsl

/*
If F_CLE_A_TRUE ( "PI052" ) Then
	Choose Case asCas 
		Case "RECH", "INFO"
		
			// Recherche si le produit (et User en recette) est éligible au PI052
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 262 )
			If lDeb > 0 Then
				
				sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "PHASE_RECETTE", ";")
				
				If Len ( Trim ( sVal ) ) = 0 Then
					If asCas = "INFO" Then
						bPI052_GenEdtKsl = TRUE
					Else
						ibPI052_GenEdtKsl2 = TRUE
					End If
				End If
				
				If Len ( Trim ( sVal ) ) > 0 Then
					If Pos ( sVal, "#" + stGlb.sCodOper + "#" ) > 0 Then
						If asCas = "INFO" Then
							bPI052_GenEdtKsl = TRUE
						Else
							ibPI052_GenEdtKsl2 = TRUE
						End If
					End If
				End If
				
			End If 
		Case Else // "DESACT"
			
			ibPI052_GenEdtKsl2 = FALSE

	End Choose
	
End If	
*/

Return bPI052_GenEdtKsl



end function

private function long uf_zn_trt_divsin_dte_restit_app_pret (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_dte_restit_app_pret (PRIVATE)
//* Auteur			: JFF
//* Date				: 31/03/2015
//* Libellé			: 
//* Commentaires	: [DT081-4]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../.... 
//*-----------------------------------------------------------------

Integer iAction
Long lRow, lDeb, lFin
String sInfoFrnSpbFrn 
n_cst_string lnvPFCString

if asData="" Then return 0

F_rechdetpro(lDeb, lFin, idw_detpro, idw_wsin.getitemNumber( 1, "ID_PROD"), "-DP", 259)
if lDeb <=0 Then return 1

iAction=0

lRow = idw_LstwCommande.find ( "ID_FOUR = 'O2M' AND ID_TYP_ART = 'PST' AND POS ( INFO_SPB_FRN_CPLT, 'TYP_RELAI=PRET' ) > 0 AND POS ( INFO_FRN_SPB_CPLT, 'DTE_RESTIT_APP_PRET=' ) <= 0",1,  idw_LstwCommande.rowCount()+1 )

If lRow <= 0 Then
	idw_wDivSin.iiErreur = 5
	iAction = 1			
	Return iAction 
End If

stMessage.sTitre     = "Décision sur saisie"
stMessage.Icon       = Exclamation!
stMessage.bErreurG   = FALSE
stMessage.sCode      = "WDSN002" 
stMessage.Bouton     = YesNo!

If F_Message ( stMessage ) = 2 Then
	iAction = 2
	idw_wDivSin.SetItem ( alRow,"VAL_DTE", stNul.dtm)	
	Return iAction 	
End If

idw_wDivSin.SetItem ( alRow,"ALT_PROT", "O" )

sInfoFrnSpbFrn = idw_LstwCommande.GetItemString ( lRow, "INFO_FRN_SPB_CPLT" )
lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbFrn, "DTE_RESTIT_APP_PRET", String ( Date ( asData ), "dd/mm/yyyy" ) , ";")
idw_LstwCommande.SetItem ( lRow, "INFO_FRN_SPB_CPLT", sInfoFrnSpbFrn ) 

Return iAction

end function

public function string uf_controlergestion_mobilzen2 ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_MobilZen2 (PRIVATE)
//* Auteur			: JFF
//* Date				: 02/04/2015
//* Libellé			: 
//* Commentaires	: [PC13442-1]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bRet (False si blocage)
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

String sPos
Long lVal

sPos = ""

lVal = idw_wRefus.Find ( "ALT_OPE='O'", 1, idw_wrefus.RowCount() )

If lVal > 0 Then
	
	lVal = 1
	Do While lVal > 0 
		lVal = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND COD_ETAT = 'ECT' AND ID_REF_FOUR = 'A_DIAGNOSTIQUER'", 1, idw_LstwCommande.RowCount ())
		If lVal > 0 Then
			idw_LstwCommande.SetItem ( lVal, "COD_ETAT", "ANN" )
			idw_LstwCommande.SetItem ( lVal, "MAJ_LE", DateTime ( Today (), Now ()) )
			idw_LstwCommande.SetItem ( lVal, "COMMENT_FRN", "Annulée automatique sur cochage de refus manuel par le GT." )
		End If
	Loop 	
	
End If

Return sPos
end function

public function string uf_controlergestion_ajoutparaauto ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_AjoutParaAuto (PRIVATE)
//* Auteur			: JFF
//* Date				: 06/05/2015
//* Libellé			: 
//* Commentaires	: [DT141]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bRet (False si blocage)
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//        JFF   26/01/2016   [PC151425]
//        JFF   09/06/2021   [RS_493_PARAINFOAUTO]
//        JFF   18/08/2021 [RS_950_INS_PAR_DYN][RS950] Suppression de l'ancine traitement RS_493_PARAINFOAUTO
//        JFF   04/12/2023 [RS6217_PARA_AUTO]
//        JFF   30/01/2025 [MON311_SPL_PACI]
//*-----------------------------------------------------------------

String sPos, sVal, sVal1, sVal2, sIdPara, sCleParaOrig, sCleParaWork
Long lVal, lDeb, lFin, lRow, lRow1, lRow2, lRow3, lIdSin, lIdCas, lVal1, lCpt, lVal2, lRowGti1, lRowGti2, lDeb378, lFin378, lDeb392, lFin392
n_cst_string	lnvString
Decimal {2} dcVal, dcMtPlafAReg

sPos = ""

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 275 )
// [PC151425]
If lDeb <= 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 298 )
End If 

If lDeb > 0 Then
	sVal = idw_wSin.GetItemString ( 1, "MARQ_PORT" )
	If sVal = "APPLE" Then
		lRow = idw_wPiece.Find ( "ID_GTI = 10 AND ALT_RECLAME = 'O' AND ID_I = 0", 1, idw_wPiece.Rowcount () )
		lRow1 = idw_wParaInfo.Find ( "ID_I = 0 AND ID_PARA = 'Z129'", 1, idw_wParaInfo.Rowcount () )
		lRow2 = idw_ParaProd.Find ( "ID_PARA = 'Z129'", 1, idw_ParaProd.Rowcount () )
		
		IF lRow > 0 And lRow1 <= 0 And lRow2 > 0 Then
			sVal1 = idw_ParaProd.GetItemString ( lRow2, "CPT_VER" )
			sVal2 = idw_ParaProd.GetItemString ( lRow2, "LIB_PARA" )
			lIdSin = idw_wSin.GetItemNumber ( 1, "ID_SIN" )

			lRow3 = idw_wParaInfo.InsertRow ( 0 )
			idw_wParaInfo.SetItem ( lRow3, "ID_SIN", lIdSin  )
			idw_wParaInfo.SetItem ( lRow3, "ID_I", 0 )
			idw_wParaInfo.SetItem ( lRow3, "ID_PARA", "Z129" )			
			idw_wParaInfo.SetItem ( lRow3, "CPT_TRI", 1 )
			idw_wParaInfo.SetItem ( lRow3, "MAJ_PAR", stGlb.sCodOper )			
			idw_wParaInfo.SetItem ( lRow3, "LIB_PARA", sVal2 )						
			idw_wParaInfo.SetItem ( lRow3, "CPT_VER", sVal1 )									
		End If
			
	End If

End If

// [RS6217_PARA_AUTO]
F_RechDetPro ( lDeb378, lFin378, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 378 )

If lDeb378 > 0 Then
	// [MON311_SPL_PACI]
	If F_CLE_A_TRUE ( "MON311_SPL_PACI" ) Then
		lIdCas = Long ( lnvString.of_getkeyvalue( idw_DetPro.GetItemString ( lDeb378, "VAL_CAR" ), "CAS", ";"))
		
		sCleParaOrig = "ID_PARA"
		sCleParaWork = sCleParaOrig
		
		For lCpt = 1 To 2 
			If lCpt > 1 Then 
				sCleParaWork = sCleParaOrig + String ( lCpt ) 
			End If 
			
			sIdPara = lnvString.of_getkeyvalue( idw_DetPro.GetItemString ( lDeb378, "VAL_CAR" ), sCleParaWork, ";")		
			
			If sIdPara = "" Then Continue
			
			lRow1 = idw_wParaInfo.Find ( "ID_I = 0 AND ID_PARA = '" + sIdPara + "'", 1, idw_wParaInfo.Rowcount () )
			lRow2 = idw_ParaProd.Find ( "ID_PARA = '" + sIdPara + "'", 1, idw_ParaProd.Rowcount () )
			
			Choose Case lIdCas 
				
				// RS6217
				Case 1
		
					lVal = idw_wDetail.Find ( "( COD_ETAT = 200 )", 1, idw_wDetail.RowCount () ) + idw_LstGti.Find ( "( COD_ETAT = 200 )", 1, idw_LstGti.RowCount () )
					lVal1 = idw_LstGti.Find ( "MT_PLAF_AREG > 0 ", 1, idw_LstGti.RowCount () )
		
					If lVal > 0 Or lVal1 > 0 Then lRow = 1 
				
				// [MON311_SPL_PACI]
				Case 2
					F_RechDetPro ( lDeb392, lFin392, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 392 )
					If lDeb392 > 0 Then
						
						// Garantie du param dp/392 (1 (clé) en théorie
						lVal = Long ( F_CLE_VAL ( "ID_GTI", idw_DetPro.GetItemString ( lDeb392, "VAL_CAR"), ";"))
						
						// Souplesse de saisie sur GTI du param (1)
						lVal1 = idw_wDivDet.Find ( &
						"ID_GTI = " + String ( lVal ) + " AND " + &
						"UPPER ( NOM_ZONE ) = 'SOUPLESSE_1' " + " AND " + &
						"LEN ( VAL_CAR ) > 0 AND VAL_CAR <> 'AAA'" &
						, 1, idw_wDivDet.RowCount ())
						
						// lVal1 = idw_wDivDet.Find ( "ID_GTI = " + String ( lVal ) + " AND ID_SPL <> 'AAA' AND NOT ISNULL ( ID_SPL )", 1, idw_wDivDet.RowCount ()) 

						// Souplesse de saisie sur autre GTI 
						lVal2 = idw_wDivDet.Find ( &
						"ID_GTI <> " + String ( lVal ) + " AND " + &
						"UPPER ( NOM_ZONE ) = 'SOUPLESSE_1' " + " AND " + &
						"LEN ( VAL_CAR ) > 0 AND VAL_CAR <> 'AAA'" &
						, 1, idw_wDivDet.RowCount ())

						// lVal2 = idw_wDivDet.Find ( "ID_GTI <> " + String ( lVal ) + " AND ID_SPL <> 'AAA' AND NOT ISNULL ( ID_SPL )", 1, idw_wDivDet.RowCount ()) 

						// Row GTI de la Gti du param 392 (1) avec mt_a_reg 
						lRowGti1 = idw_LstGti.Find ( "ID_GTI = " + String ( lVal ) + " AND MT_PLAF_AREG > 0", 1, idw_LstGti.RowCount () )

						// Row GTI Autre Gti avec mt_a_reg 						
						lRowGti2 = idw_LstGti.Find ( "ID_GTI <> " + String ( lVal ) + " AND MT_PLAF_AREG > 0", 1, idw_LstGti.RowCount () )						

						// ID_PARA spécial pour la GTI 1
						// ID_PARA2 pour tout Gti y compris 1
						
						If sCleParaWork = "ID_PARA" And lVal1 > 0 And lRowGti1 > 0 Then lRow = 1
						If sCleParaWork = "ID_PARA2" And (( lVal1 > 0 And lRowGti1 > 0 ) Or ( lVal2 > 0 And lRowGti2 > 0 )) Then lRow = 1
						
					End If 	
				
			End Choose
		
			IF lRow > 0 And lRow1 <= 0 And lRow2 > 0 Then
				sVal1 = idw_ParaProd.GetItemString ( lRow2, "CPT_VER" )
				sVal2 = idw_ParaProd.GetItemString ( lRow2, "LIB_PARA" )
				lIdSin = idw_wSin.GetItemNumber ( 1, "ID_SIN" )
		
				lRow3 = idw_wParaInfo.InsertRow ( 0 )
				idw_wParaInfo.SetItem ( lRow3, "ID_SIN", lIdSin  )
				idw_wParaInfo.SetItem ( lRow3, "ID_I", 0 )
				idw_wParaInfo.SetItem ( lRow3, "ID_PARA", sIdPara )			
				idw_wParaInfo.SetItem ( lRow3, "CPT_TRI", 1 )
				idw_wParaInfo.SetItem ( lRow3, "MAJ_PAR", stGlb.sCodOper )			
				idw_wParaInfo.SetItem ( lRow3, "LIB_PARA", sVal2 )						
				idw_wParaInfo.SetItem ( lRow3, "CPT_VER", sVal1 )									
			End If			
			
		Next 
		

	Else 
	
		lIdCas = Long ( lnvString.of_getkeyvalue( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "CAS", ";"))
		sIdPara = lnvString.of_getkeyvalue( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_PARA", ";")		
	
		lRow1 = idw_wParaInfo.Find ( "ID_I = 0 AND ID_PARA = '" + sIdPara + "'", 1, idw_wParaInfo.Rowcount () )
		lRow2 = idw_ParaProd.Find ( "ID_PARA = '" + sIdPara + "'", 1, idw_ParaProd.Rowcount () )
		
		Choose Case lIdCas 
			
			// RS6217
			Case 1
	
				lVal = idw_wDetail.Find ( "( COD_ETAT = 200 )", 1, idw_wDetail.RowCount () ) + idw_LstGti.Find ( "( COD_ETAT = 200 )", 1, idw_LstGti.RowCount () )
				lVal1 = idw_LstGti.Find ( "MT_PLAF_AREG > 0 ", 1, idw_LstGti.RowCount () )
	
				If lVal > 0 Or lVal1 > 0 Then lRow = 1 
			
			
		End Choose
	
		IF lRow > 0 And lRow1 <= 0 And lRow2 > 0 Then
			sVal1 = idw_ParaProd.GetItemString ( lRow2, "CPT_VER" )
			sVal2 = idw_ParaProd.GetItemString ( lRow2, "LIB_PARA" )
			lIdSin = idw_wSin.GetItemNumber ( 1, "ID_SIN" )
	
			lRow3 = idw_wParaInfo.InsertRow ( 0 )
			idw_wParaInfo.SetItem ( lRow3, "ID_SIN", lIdSin  )
			idw_wParaInfo.SetItem ( lRow3, "ID_I", 0 )
			idw_wParaInfo.SetItem ( lRow3, "ID_PARA", sIdPara )			
			idw_wParaInfo.SetItem ( lRow3, "CPT_TRI", 1 )
			idw_wParaInfo.SetItem ( lRow3, "MAJ_PAR", stGlb.sCodOper )			
			idw_wParaInfo.SetItem ( lRow3, "LIB_PARA", sVal2 )						
			idw_wParaInfo.SetItem ( lRow3, "CPT_VER", sVal1 )									
		End If
	End IF 
End If 


Return sPos
end function

private subroutine uf_determiner_courrier_forcage_sbe_sfr (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_SBE_SFR (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 07/05/2015
//* Libellé       : 
//* Commentaires  : [DT141]
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF   27/06/2016   [DT247]
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech
Long   				lDeb, lFin, lTotCourrier, lLig, lCpt
string				sTypApp, sAdrMail
Boolean				bCondition			


F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 275 )
If lDeb <= 0 Then Return 

sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_REFUS", ";")

bCondition = asPos = "" &
					And lDeb > 0 &
					And sIdNatCourForcage <> "" &
					And idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND ID_FOUR = 'SBE' AND ID_REF_FOUR ='A_DIAGNOSTIQUER' AND STATUS_GC IN ( 153, 154 ) AND POS ( INFO_FRN_SPB_CPLT, 'FACT_PRESENTE=NON' ) > 0", 1, idw_LstwCommande.rowCount()+1 ) > 0 &
					And idw_wRefus.Find ( "ALT_OPE = 'O'", 1, idw_wRefus.RowCount () ) <= 0 &
					And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A"

// [DT247]
If Not bCondition Then
	sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_COUR_REF_1749", ";")

	bCondition = asPos = "" &
						And lDeb > 0 &
						And sIdNatCourForcage <> "" &
						And idw_wRefus.Find ( "ID_MOTIF = 1749 AND ( ALT_OPE = 'O' OR ALT_MAC = 'O' ) ", 1, idw_wRefus.RowCount () ) > 0 &
						And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A"
End If


If IsNull ( sIdNatCourForcage ) Then sIdNatCourForcage  = ""

If bCondition Then

		sIdNatPresent = asIdNatCour
		
		If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

		If sIdNatPresent <> sIdNatCourForcage Then

			If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= sIdNatCourForcage
				
			Else
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= asIdNatCour
				stMessage.sVar[2] 	= sIdNatCourForcage
			End If 
			
			If F_Message ( stMessage ) = 1 Then

				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!							

				idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
				lTotCourrier	= dwChild.RowCount ()
				sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
				lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
		
		/*------------------------------------------------------------------*/
		/* On verifie si la nature de courrier existe. Si elle n'existe     */
		/* pas, par un effet du hasard bien sur, on arrete le traitement    */
		/* et on positionne sur REF_CIE.                                    */
		/*------------------------------------------------------------------*/
				If	lLig = 0	Then
		
		/*------------------------------------------------------------------*/
		/* On arme la structure de message maintenant, mais le message va   */
		/* être affiché dans le contrôle de gestion.                        */
		/*------------------------------------------------------------------*/
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= Information!
					stMessage.sCode		= "WSIN170"
					stMessage.sVar[1] 	= sIdNatCourForcage
					asPos = "REF_CIE"
				Else
					If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
						asIdNatCour = sIdNatCourForcage
						asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
						
						idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
						idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
						idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
					Else 
						// Le message est armé dans uf_GestionCP
						asPos = "REF_CIE"

					End If
				End If		
			End If
		End If
End If


end subroutine

private function boolean uf_validation_finale_mail_sogedep ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale__mail_SOGEDEP (PRIVATE)
//* Auteur        : FPI
//* Date          : 26/05/2015
//* Libellé       : Gestion Particulière pour SOGEDEP
//* Commentaires  : [PC786-2]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp, sMailAssure
String  sMailDest, sRech, sVal, sIdDetail, sIdSeq, sFiltreOrigDDDW
u_datawindow udwnull
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sMailFrom,sXml
Blob    bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
s_pass stPass
DatawindowChild dwChild

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 278 )
If lDeb<= 0 Then
	
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD842"

	F_Message ( stMessage ) 
	Return FALSE

End If

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
If IsNull ( sBoiteMail ) Then sBoiteMail = ""

sMailDest=lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_SOGEDEP", ";")

sMailFrom=sBoiteMail
sTypMail = "SOGED"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

lRow = idw_LstInter.Find ( "COD_INTER='A'", 1, idw_LstInter.RowCount () )
If lRow > 0 Then
	sMailAssure = idw_LstInter.GetItemString ( lRow, "ADR_MAIL" ) 
	If IsNull ( sMailAssure ) Then sMailAssure = ""
End IF
		

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR  IN ( 'SOG' )" 
			 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()


/*------------------------------------------------------------------*/
/* La zone PROBLEME contient un chiffre indiquant l'ordre de choix  */
/* par le gestionnaire. On tri donc sur cet ordre.                  */
/*------------------------------------------------------------------*/
idw_LstwCommande.SetSort ( "PROBLEME A" )
idw_LstwCommande.Sort ()
lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	// ON continue sans mail
	
	// Rajout JFF !!!
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()	
	
	Return TRUE
End If	


/*------------------------------------------------------------------*/
/* Plus d'une prestation vers SOGEDEP on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sVar[1]		= "Sogedep"
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

// Récup de l'adresse
lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdSeq=String(idw_LstwCommande.GetItemNumber(1,"ID_SEQ"))

// Calcul Montant
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )


sRech	=		"ID_GTI = "	+ sIdGti	+ " AND " 	+ &
				"ID_DETAIL = "	+ sIdDetail 	+ " AND " 	+ &
				"UPPER ( NOM_ZONE ) = 'PEC' AND VAL_CAR='O'"
	
lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
If lRow > 0 Then
	sRech	=		"ID_GTI = "	+ sIdGti	+ " AND " 	+ &
				"ID_DETAIL = "	+ sIdDetail 	+ " AND " 	+ &
				"UPPER ( NOM_ZONE ) = 'MT_PEC'"
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtMaxTTC=idw_wDivDet.GetItemDecimal(lRow, "VAL_MT") 
	End if
End if

If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0
	
If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

// Récupération du type d'appareil
sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sTypApp = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 
	
// Construction du mail
sMailObjet ="Prestation SPB AUCHAN GEM – dossier " + sIdSin + "-" + sIdSeq

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Suite à la déclaration de sinistre de " +  Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ))  
sMailBody += " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ))
sMailBody += ", merci d'effectuer les réparations sur l'appareil sinistré selon les informations ci-dessous :"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "NOM DE L'ASSURE : " +  Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" )) + sSaut
sMailBody += "PRENOM DE L'ASSURE : " +  Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" )) + sSaut
sMailBody += "ADRESSE : " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" ))  + sSaut

If Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) <> "" Then
	sMailBody += "          " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )) 
	sMailBody += sSaut
End If

If Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) <> "" Then
	sMailBody += "          " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" )) 
	sMailBody += sSaut
End If

sMailBody += "CODE POSTAL : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" )  + sSaut
sMailBody += "VILLE : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" )  + sSaut

sMailBody += "N° TEL 1 : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" )  + sSaut
sMailBody += "N° TEL 2 : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL2" )  + sSaut
sMailBody += "MAIL DE L'ASSURE : " + sMailAssure + sSaut
sMailBody += sSaut

sMailBody += "FAMILLE DE PRODUIT : " + sTypApp  + sSaut
sMailBody += "MARQUE : " + F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" )  + sSaut
sMailBody += "MODELE : " + F_GetItem3 ( idw_wSin, 1, "MODL_PORT" )  + sSaut
sMailBody += "N° DE SERIE : " + F_GetItem3 ( idw_wSin, 1, "NUM_IMEI_PORT" )  + sSaut
sMailBody += sSaut

sMailBody += "SYMPTOME PANNE DECLAREE : " + F_GetItem3 ( idw_LstwCommande, 1, "PROBLEME" )  + sSaut
sMailBody += sSaut

sMailBody +="Valeur de l'appareil assuré (plafond) : " + String ( dcMtMaxTTC , "#####0.00" ) + sSaut 
sMailBody += "REFERENCE SPB : "  +  sIdSin + "-" + sIdSeq + sSaut
sMailBody += sSaut
sMailBody += sSaut

sMailBody += "Nous restons à votre entière disposition pour tout renseignement complémentaire et vous prions d’agréer, nos salutations distinguées."

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
		Long ( sIdSin ), &
		Upper ( SQLCA.DataBase ), &
		sMailFrom, &
		sMailDest, &
		'', &
		'', &
		sMailObjet, &
		bMailBody, &
		'', &
		sTypMail, &
		iIdAppli, &
		'KSL', &
		-1, &
		sXml &
		) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function string uf_controlergestion_frais_compensation ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_frais_compensation
//* Auteur			: Fabry JF
//* Date				: 18/06/2015
//* Libellé			: 
//* Commentaires	: [VDOC17959]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   Date	      Modification
//*-----------------------------------------------------------------

Long lRow, lCodeEtatFrais
String sPos
Decimal {2} dcMtAReglerWSin, dcMtAReglerwFrais


sPos = ""

lRow  = idw_wFrais.find ( "MT_FRAIS > 0 AND ID_TYP_FRAIS IN ( 3, 4, 5 )", 1, idw_wFrais.RowCount ())
If lRow > 0 Then
	dcMtAReglerwFrais = idw_wFrais.GetItemDecimal ( lRow, "MT_FRAIS" ) 
	lCodeEtatFrais = idw_wFrais.GetItemNumber ( lRow, "COD_ETAT" )
End If

dcMtAReglerWSin = idw_wsin.GetItemDecimal (1, "MT_A_REG")

If dcMtAReglerWSin > dcMtAReglerwFrais And dcMtAReglerwFrais > 0 And lCodeEtatFrais = 500 Then

	stMessage.sTitre		= "vDoc17959, Anne-Marie Brument"
	stMessage.Icon			= exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "V017959"
	stMessage.Bouton		= OK!

	sPos = "ALT_BLOC"

	F_Message ( stMessage ) 
End If

Return sPos


end function

private function boolean uf_validation_finale_qdr_ibe_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_QDR_IBE_mail (PRIVATE)
//* Auteur        : FPI
//* Date          : 02/07/2015
//* Libellé       : Gestion Particulière pour IBELEM / QUADRIA
//* Commentaires  : [PC14613]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sIdEvt, sTypApp, sMailAssure
String  sMailDest, sRech, sVal, sIdDetail, sIdSeq, sIdFour, sLibPolice, sNomAssure
u_datawindow udwnull
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sMailFrom,sXml, sAdrLibCiv, sLibTypApp
Blob    bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin, lIdSin, lIdProd
Decimal{2}	dcMtMaxTTC, dcIdPolice, dcPrixAchat
s_Plafond_Pec stPlafPec
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
s_pass stPass
n_cst_attrib_key	lnv_Key[]
Decimal dcIdSin, dcIdProd
DatawindowChild dwChild

iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

lIdSin=idw_WSin.GetItemNumber ( 1, "ID_SIN" )
sIdSin = String ( lIdSin )

lIdProd=idw_WSin.GetItemNumber ( 1, "ID_PROD" )
/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR  IN ( 'QDR','IBE' )" 
			 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd= idw_LstwCommande.RowCount()

If lTotCmd <= 0 Then 
	// ON continue sans mail
	
	// Rajout JFF !!!
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()
	
	Return TRUE
End If	

sIdFour= idw_LstwCommande.GetItemString(1, "ID_FOUR")

// Récup des info relatives au mail

lnv_Key[1].iskeyname	 ="ID_FOUR"
lnv_Key[1].iakeyvalue =sIdFour
lnv_Key[2].iskeyname	 ="MAIL_FROM"
lnv_Key[3].iskeyname	 ="ADR_MAIL"
lnv_Key[4].iskeyname	 ="NOMS"

F_RechDetPro_withkey( lDeb, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 282, lnv_Key )
If lDeb<= 0 Then
	
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD842"

	F_Message ( stMessage ) 
	Return FALSE

End If

sBoiteMail = lnv_Key[2].iakeyvalue

sMailDest= lnv_Key[3].iakeyvalue

sMailFrom=sBoiteMail
sTypMail = "CM" + sIdFour

/*------------------------------------------------------------------*/
/* Plus d'une prestation on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sVar[1]		= "IBELEM / Quadria"
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

// Récup de l'adresse de livraison
If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" ) ) Then
	idw_LstwCommande.SetItem ( 1, "ADR_LIVR2", "" ) 
End If
If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
	idw_LstwCommande.SetItem ( 1, "ADR_LIVR_CPL", "" ) 
End If

sAdrLibCiv = ""
idw_LstwCommande.GetChild ( "ADR_COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sAdrLibCiv = dwChild.GetItemString ( lRow, "LIB_CODE" ) + " "
End If

sAdrLibCiv+=Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ))  + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ))

// Libellé de police
sIdSeq=String(idw_LstwCommande.GetItemNumber(1,"ID_SEQ"))
lIdGti = idw_LstwCommande.GetItemNumber(1,"ID_GTI")
sLibPolice=Space(35)

SQLCA.ps_s01_lib_police_v01( Dec(lIdSin), Dec(lIdProd), -1, Dec(lIdGti), stNul.dcm , sLibPolice)  
		
// Nom de l'assuré 
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )

// Type d'appareil
sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" )
sLibTypApp = Space ( 35 )
SQLCA.IM_S01_CODECAR ("-AR", Upper ( sTypApp ), sLibTypApp )
If IsNull ( sLibTypApp ) Then sLibTypApp = ""

// Calcul Montant
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )


sRech	=		"ID_GTI = "	+ sIdGti	+ " AND " 	+ &
				"ID_DETAIL = "	+ sIdDetail 	+ " AND " 	+ &
				"UPPER ( NOM_ZONE ) = 'PEC' AND VAL_CAR='O'"
	
lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
If lRow > 0 Then
	sRech	=		"ID_GTI = "	+ sIdGti	+ " AND " 	+ &
				"ID_DETAIL = "	+ sIdDetail 	+ " AND " 	+ &
				"UPPER ( NOM_ZONE ) = 'MT_PEC'"
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtMaxTTC=idw_wDivDet.GetItemDecimal(lRow, "VAL_MT") 
	End if
End if

If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0
	
If IsNull ( dcMtMaxTTc ) Then dcMtMaxTTC = 0

// Prix d'achat
sRech	=		"ID_GTI = "	+ sIdGti	+ " AND " 	+ &
				"ID_DETAIL = "	+ sIdDetail 	

lRow=idw_wdetail.Find(sRech,1,idw_wdetail.RowCount( ))
dcPrixAchat=idw_wdetail.GetItemDecimal(lRow, "MT_VAL_ACHAT")

// Construction du mail
sMailObjet ="Garantie Dommage et Vol Appareils informatiques  – dossier " + sIdSin + "-" + sIdSeq

sMailBody += "Madame, Monsieur, "+ sSaut
sMailBody += sSaut
sMailBody += "Vous trouverez dans le présent mail un tableau récapitulatif pour une commande d’Appareil de remplacement au titre du contrat " + &
	sLibPolice + "." + sSaut
sMailBody += sSaut
sMailBody += "Merci de bien vouloir répondre au mail suivant avec le tableau de l’Appareil livré complété à l’adresse suivante : " + sBoiteMail + &
	"." + sSaut
sMailBody += sSaut

sMailBody += "Informations générales" + sSaut
sMailBody += "--------------------------" + sSaut
sMailBody += sSaut
sMailBody+="N° contrat : "+ sLibPolice + sSaut
If sIdFour="IBE" Then
	sMailBody+="Nom du revendeur : IBELEM"  + sSaut
Else
	sMailBody+="Nom du revendeur : QUADRIA"  + sSaut
End if

sMailBody+="Nom correspondant: "  + f_remplace( String(lnv_Key[4].iakeyValue), "#"," ; ") + sSaut
sMailBody+="Mail correspondant : "  + f_remplace( sMailDest, ","," ; ") + sSaut
sMailBody+="N° Sinistre : " + sIdSin  + sSaut
sMailBody += sSaut

sMailBody += "Adresse de livraison" + sSaut
sMailBody += "--------------------------" + sSaut
sMailBody += sSaut
sMailBody+="Destinataire Appareil de remplacement : " +  sAdrLibCiv + sSaut 
sMailBody+="Adresse de livraison : " +  F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" ) + sSaut
If F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" ) <> "" Then
sMailBody += "                               " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" )
	sMailBody += sSaut
End If
sMailBody+="Complément Adresse de livraison : " +  F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPL" ) + sSaut
sMailBody+="Code Postal : " +  F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + sSaut
sMailBody+="Ville : " +  F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) + sSaut
sMailBody+="Téléphone : " +  F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) + sSaut
sMailBody += sSaut
sMailBody+="Assuré : " + sNomAssure + sSaut 
sMailBody += sSaut
sMailBody += "Appareil sinistré" + sSaut
sMailBody += "-------------------" + sSaut
sMailBody += sSaut
sMailBody+="Type de matériel : " + sLibTypApp + sSaut
sMailBody+="Marque : " + idw_wsin.GetItemString(1,"MARQ_PORT") + sSaut
sMailBody+="Modèle : " + idw_wsin.GetItemString(1,"MODL_PORT")  + sSaut
sMailBody+="N° de série : " + idw_wsin.GetItemString(1,"NUM_IMEI_PORT") + sSaut
sMailBody+="Prix d’Achat TTC : " + String(dcPrixAchat,"0.00") + sSaut
sMailBody += sSaut

sMailBody += "Prise en charge" + sSaut
sMailBody += "-------------------" + sSaut
sMailBody += sSaut
sMailBody+="Montant de Prise en charge : " + String(dcMtMaxTTc,"0.00") + sSaut
sMailBody += sSaut
sMailBody += sSaut

sMailBody += "Tableau de l’Appareil livré : à compléter par le fournisseur" + sSaut
sMailBody += "-------------------------------------------------------------------" + sSaut
sMailBody += sSaut
sMailBody += "Type de matériel : " + sSaut
sMailBody += "Marque : " + sSaut
sMailBody += "Modèle : " + sSaut
sMailBody += "Référence du produit : " + sSaut
sMailBody += "N° de série : " + sSaut
sMailBody += "Prix d’achat HT : " + sSaut
sMailBody += "Taille de l’écran : " + sSaut
sMailBody += "Capacité de stockage (mémoire de stockage) : " + sSaut
sMailBody += "Disque Dur (DD) ou SSD : " + sSaut
sMailBody += "Processeur : " + sSaut
sMailBody += "Mémoire vive : " + sSaut
sMailBody += "Poids brut en kg : " + sSaut
sMailBody += "Poids total en kg : " + sSaut
sMailBody += "Disponibilité Appareil de remplacement (OUI/NON) : " + sSaut
sMailBody += "Date d’envoi Appareil de remplacement (JJ/MM/AAAA) : " + sSaut
sMailBody += "Valeur appareil livré (HT) : " + sSaut
sMailBody += sSaut

sMailBody += "En cas de question, vous pouvez nous contacter à l’adresse mail indiquée ci-dessus ou au numéro de téléphone suivant : " + &
	"0 970.820.343 (du lundi au samedi hors jours légalement chômés et/ou fériés, et sauf interdiction législative ou règlementaire de 8h00 à 20h00). " + &
	sSaut
sMailBody += sSaut
sMailBody += "Cordialement," + sSaut
sMailBody += sSaut
sMailBody += "SPB"

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
		Long ( sIdSin ), &
		Upper ( SQLCA.DataBase ), &
		sMailFrom, &
		sMailDest, &
		'', &
		'', &
		sMailObjet, &
		bMailBody, &
		'', &
		sTypMail, &
		iIdAppli, &
		'KSL', &
		-1, &
		sXml &
		) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

// Rajout JFF !!!
idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

Return bRet

end function

private function string uf_determiner_data_sinistre (ref string asdatainter[], string ascas, integer aicasinter, ref s_pass atabvariable[], ref string astabcodevar[]);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Data_Sinistre (PRIVATE)
//* Auteur			: Erick John Stark
//* Date				: 26/06/1998 11:39:15
//* Libellé			: 
//* Commentaires	: Génération du fichier des DATAS pour les variables du Sinistre
//*
//* Arguments		: String		asDataInter[]		Réf		// Tableau de data de ts les inter (SVE DCMP040020)
//*					  String		asCas					Val		// COUR_AUTO Ou CP_UNIQUEMENT
//*					  Int			aiCasInter			Int		// pour CP_UNIQUEMENT, on spécifi l'inter
//*
//* Retourne		: String				=	"" -> On continue
//*											<>	"" -> Une erreur est rencontrée, on arrête le contrôle de gestion
//*
//*-----------------------------------------------------------------
// #1 Modif  DBI le 04/04/2000 Pb si une seule gti qui n'existe pas avec id_rev
//    				l'id_police = -1 et fait planter le calcul lib_police/lib_cie
// #2 DCMP 020458, JF	F, Le 09/12/2002, Ajout du média entrant 'Internet'
// #3			JFF		23/08/02 Renseignement de la variable ZVAR05 (idem à SAVANE) avec le Prénom et nom du Gestionnaire
// #4			JFF		03/02/03 DMDI8557 : Ajout de plusieurs de téléphonie en variables, pour les courriers ORANGE.
// #5			JFF		29/12/03 DCMP 030483 : Courrier MUST&ORANGE
// #6			JFF		15/03/04 DCMP 040020 : SVE
// #7			JFF		DCMP 040141 : On supprime tout ce qui est dérrière la parenthèse
// #8			JFF		DCMP 040020 : Signature électronique
// #9 		JFF		DCMP 040241 : Si Optin 22 trouvé PLIBCO = PLIBLO
// #10 		JFF		DCMP 040368 : Armement ZVAR23, si prod à carte, afficher num carte (formaté)
// #11		CAG		03/09/2004 DCMP 040348 : Armement ZVAR24 avec la marque et le modèle de la dernière cmde créée
// #12     MADM      Projet DNTMAIL1/2 Mails sortant en remplacement des courriers
// #13      JFF      DCMP 060532, armement nom produit et nom option
// #14 		DGA      19/09/2006   Gestion d'un répertoire temporaire DCMP-060643
// #15 		JCA      19/09/2006   DCMP-060644
// #16 		JFF      11/10/2006   DCMP-060693 Armement d'une var suppl avec MtMaxTTC PEC
// #17 		JFF      31/10/2006   DCMP-060693 Armement d'une var suppl avec date dépôt
// #18 		JCA      04/12/2006   DCMP-060880 Armement d'une var suppl avec date dépôt
// #19		JCA		26/12/2006	DCMP 060907 - Changement de l'appel à F_Determiner_Montant_Frais_Envoi
//												ajout des arguments alidprod (Val), adwdetpro (Ref), adcFrais (Ref)
// #20		JFF		06/02/2006  [SITE_CMDE] Gestion des nouvelles option d'autorisation 79, 80, 81
// #21	   JFF      18/09/2007 [ALAPAGE]
// #22		PHG		03/03/2008  [DCMP080111] Creation de nouvelle Variable.
// #23		PHG		20/06/2008	[DCMP080469] Creation de nouvelle Variable.
// #24	   JFF	   20/10/2008	[FNAC_PROD_ECH_TECH]
// #25		FPI 		13/01/2008	[DCMP90007]	Ajout de la variable ZVAR43
// #26 		FPI		[DCMP090007].[20080116155731] Test du cas de gestion SCORE GAME + test adr2=""
// #27      JFF      [FNAC_PROD_ECH_TECH].[20090401150850217]
// #28		FPI		[DCMP090247] Ajout de ZVAR45 : Horaires d'ouverture
// #29      JFF      [DMDI26408]  DMDI non traitée en fait, je fais plutôt la modification de code qui éradiquera définitivement ces DMDI
// #30		FPI		[DCMP090552] N° téléphone joignable depuis l'étranger
// #31	   JFF 		19/10/2009	[FNAC_PROD_ECH_TECH].[BGE]
// #32      JFF      20/11/2009  [POLICE_PARTICULIERE]
//     	   JFF	   13/04/2010  [WEBSIM2].[FRANCE]
//			FPI		07/06/2010	[DCMP100400]
//		 	FPI	24/06/2010 [DCMP100551] Modification de l'option 76
//			 JFF     04/11/2010 [PC301].[LOT2]
//			 JFF     04/11/2010 [PC301].[NDC_V12]
//			FPI	14/02/2011	[VDoc2465] ZVAR12 ne prend pas en compte les Garanties misent "SANS SUITE". 
//*       JFF    22/02/2011 [PC363_AUC].[VAR_WD_MAT_REMP_O2M]
//			FPI	23/11/2011	[PR10-Lot1]	Ajout ZVAR56
//				   FPI		05/12/2011	[ITSM92321] 
// 		 JFF   13/02/2012   [PM200][PSM]
// 		 JFF   27/02/2012   [PM200][PSM][MANTIS2745]
//		FPI	25/10/2012	[VDoc9286] ZVAR60
//       JFF  13/11/2012    [VDOC9057]
//       JFF  17/12/2012    [PM200_LOT3_V3]
//		FPI	30/01/2013	[VDoc10098] ZVAR62
//    JFF   18/03/2013  [PC896_CDISCOUNT][V4]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//		FPI	23/07/2013	[PC954]
//		FPI	27/09/2013	[VDoc12269]
//       JFF   07/05/2013 [VDOC13497]
//		FPI	26/03/2014	[PC925]
//       JFF   08/04/2014 [PM255]
//       JFF   12/06/2014 [PI052]
// 		FPI	13/06/2014	[VDOC15104]
// 		FPI	21/04/2015	[VDOC17436]
//       JFF   12/10/2015 [PC694-4]
//       JFF   05/02/2016 [VDOC19876]
//       JFF   13/04/2016 [DT191-2][MANTIS20230]
//       JFF   17/05/2016 [PM280-2]
//       JFF   27/06/2016 [DT247]
//		FPI 	11/07/2016 [DT176] ajout de ZVAS24
//		FPI 	14/09/2016	[PC151259]
//       JFF   28/09/2016 [DT262]
//		FPI	04/11/2016	[VDOC22301]
// 		FPI	08/12/2016	[VDOC22243]
//       JFF   10/01/2017 [DT262][V3]
//       JFF   18/01/2017 [DT289]
//       JFF   29/05/2017 [PC151259-2]
//       JFF   23/08/2017 [DT288-3_LOT1][PM280]
//       JFF   05/10/2017 [PC171918]
//		FPI	20/11/2017 [PC171918] Réponses de script
//		FPI	30/11/2017	[PC171933]
//		JFF	16/01/2018	[VDOC25509]
//		FPI	16/02/2018	[VDOC25726]
// 	FPI	12/03/2018 [PI056] - dte_fin_gti en datetime
//		FPI	30/03/2018	[DT339]	
//		FPI	29/06/2018 [VDoc26409]
// 		FPI 	18/07/2018 [VDOC26434]
// 		JFF	20/08/2018 [VDOC26595]
// 		JFF	13/09/2018 [VDOC26755]
//       JFF   04/02/2019 [PM421-3]
//       JFF   15/03/2019 [VDOC27689]
//       JFF   20/03/2019 [PM421-4]
//       JFF   29/03/2019 [DT410]
//       JFF   05/08/2019 [DT443]
//       JFF   13/02/2020 [VDOC29047]
//       JFF   17/08/2020 [PM360-4]
//       JFF   13/12/2022 [RS4207]
//       JFF   22/11/2023 [RS6175_GC_SCRP_SIM2]
//-----------------------------------------------------------------
String sVide[], sVarSinistre[], sZVAR14, sZVAR15, sZVAR18, sZVAR19, sRepWin, sFic, sFiltre, sFiltreOrig, sTriOrig, sRetTrtMdp
String sLibDept // #15 
String sNomLigne1, sNomLigne2, sAdrLigne1, sAdrLigne2, sCP, sVille // [ADRESSE_O2M]
Long lTotPolice, lLig, lTotGti, lTotGtiSaisi, lCpt, lIdGti, lTotEts, lIdGrp, lTotInter, lIdI, lIdProd, lIdEts
Long lIdPolice[], lRow, lPos, lDeb, lFin, lIdSin, lIdRev, lIdIGti1er, lIdBOutique
Long lChoixMonnaie, lTotCmd, lCptMax
Date dDteOppo, dDte1ErUf, dtValDate
Boolean bPoliceConnu, bVal, bOkDp66, bAltEdit
String sVal, sVal2, sRech, sCodAdh, sLibGrp, sPos, sVarInter, sNomFic, sIdCour, sBIN, sValURL, sFicIniApp, sIdSin, sIdSeq, sVarNonArmee
String sMtPecMonnaie, sMtPecCentimes 	//* #24 [FNAC_PROD_ECH_TECH]
String sSeparateurMonnaie, sVal1
Dec {2} dcMtFranaReg, dcFrais //#19
Dec {2} dcMtTTCCmde, dcMtValAchat, dcMtValAchatTmp, dcMtPlaf
Dec dcIdSin
Int	iCpt, iPos
n_cst_string lnvPFCString
String sVal3 							// #25
String sBGE_ZVAR48 // #31 [FNAC_PROD_ECH_TECH].[BGE]
DataWindowChild dwChild
//u_DeclarationFuncky uoDeclarationFuncky //[I037] Migration FUNCKy
Integer iFic
n_cst_cmd_commun	lnvCmdCommun  // [ADRESSE_O2M]
string sTypApp	//  [DCMP100551]
String sVar1, sVar2, sVar3
n_cst_attrib_key	lKey[]
String sVarTmpPI052
DateTime dtDteSurv
Date dDteFinGti
String sIdAdh, sChaine, sIdFour, sIdSousFourn
String sZvarNbreIndem, sZvarIndem
Decimal{5}   dcDurPerRnv_Adh
String       sUntPerRnv_Adh
Date dDteAdh, dDteResult, dDteAdhRenouvApSurv, dDteSurv
String sLibPoliceDef
Long lRow1

lChoixMonnaie = idw_Produit.GetItemNumber ( 1, "COD_EURO" )
sSeparateurMonnaie = " "

sPos = ""
sVarNonArmee = "!! VARIABLE NON ARMEE=>PROBLEME DE PARAMETRAGE, CONTACTEZ EPG AU 2245"
bAltEdit = idw_Wsin.GetItemString ( 1, "ALT_EDIT" ) = "O"

// #32 [POLICE_PARTICULIERE]
lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )
lIdRev  = idw_wSin.GetItemNumber ( 1, "ID_REV" )
lIdSin  = idw_wSin.GetItemNumber ( 1, "ID_SIN" )

// [DT247]
lIdEts = idw_wSin.GetItemNumber ( 1, "ID_ETS" )
sIdAdh =  idw_wSin.GetItemString ( 1, "ID_ADH" )
dtDteSurv = idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )
dDteSurv  = idw_wSin.GetItemDate ( 1, "DTE_SURV_DATE" )

// [DT262]
dDteFinGti = Date(idw_wSin.GetItemDateTime ( 1, "DTE_FIN_GTI" )	) // [PI056]

// [VDOC27689]
dDteAdh				= idw_wSin.GetItemDate ( 1, "DTE_ADH" )
dcDurPerRnv_Adh	= idw_produit.GetItemNumber ( 1, "DUR_PERRNV_ADH" )
sUntPerRnv_Adh		= idw_produit.GetItemString ( 1, "UNT_PERRNV_ADH" )


// [DT191-2][MANTIS20230]
This.Uf_Determiner_Data_Recup_Adr_PickUp ()

If idw_LstGti.RowCount () > 0 Then
	lIdIGti1er = idw_LstGti.GetItemNumber ( 1, "ID_GTI" )
Else
	lIdIGti1er = -1
End If
// #32 [POLICE_PARTICULIERE]

// #31 [FNAC_PROD_ECH_TECH].[BGE]
sBGE_ZVAR48 = "0100" // Code prestataire SPB pour FNAC

sFicIniApp = stGLB.sFichierIni

/*------------------------------------------------------------------*/
/* La première chose à faire est de supprimer tous les fichiers de  */
/* DATAS qui peuvent exister dans le répertoire temporaire. En      */
/* effet, le gestionnaire a trés bien pu faire un CTRL ( sans       */
/* bloquer le dossier ), puis supprimer un interlocuteur et faire   */
/* de nouveau CTRL. Or la fonction Uf_Enregistrer_Blob_Blob se      */
/* base - pour les DATAS - uniquement sur l'existence du fichier.   */
/*------------------------------------------------------------------*/
//uoDeclarationFuncky = Create u_DeclarationFuncky
/*------------------------------------------------------------------*/  
/* #14. DCMP-060643                                                 */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//sNomFic = isRepWin + "\TEMP\" + stGlb.sCodAppli + "*.DT"
sNomFic = stGLB.sRepTempo + stGlb.sCodAppli + "*.DT"
//uoDeclarationFuncky.Uf_FEraseAll ( sNomFic )
stGLB.uoWin.Uf_FEraseAll ( sNomFic )

//Destroy uoDeclarationFuncky

/*------------------------------------------------------------------*/
/* On réarme le tableau des variables à vide.                       */
/*------------------------------------------------------------------*/
sVide [ ilTotVar ] = ""
iuoLibelle.Uf_Initialiser_Tableau ( sVide [] )

/*------------------------------------------------------------------*/
/* On génére d'abord les informations pour le sinistre. On les      */
/* conserve dans un tableau en local, pour éviter de les retraiter  */
/* pour chaque interlocuteur.                                       */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* CIVILITE DE L'ASSURE                                             */
/*------------------------------------------------------------------*/
	sVal = idw_wSin.Describe ( "Evaluate ( 'LookUpDisplay ( COD_CIV )', 1 ) " )
	iuoLibelle.Uf_SetValue ( "ACIVAS", sVal )	
/*------------------------------------------------------------------*/
/* NOM DE l'ASSURE                                                  */
/*------------------------------------------------------------------*/
	sVal = idw_wSin.GetItemString ( 1, "NOM" )
	iuoLibelle.Uf_SetValue ( "ANOMAS", sVal )
/*------------------------------------------------------------------*/
/* PRENOM DE l'ASSURE                                               */
/*------------------------------------------------------------------*/
	sVal = idw_wSin.GetItemString ( 1, "PRENOM" )
	iuoLibelle.Uf_SetValue ( "APREAS", sVal )
/*------------------------------------------------------------------*/
/* Modification DBI le 20/10/1998                                   */
/* Ajout de variable contenant le rib de l'assuré pour affichage    */
/* dans le courrier banque                                          */
/*------------------------------------------------------------------*/

	lLig = iDw_LstInter.Find ( "COD_INTER = 'A'", 1, iDw_LstInter.RowCount () )

	If lLig > 0 Then

		sVal = iDw_LstInter.GetItemString ( lLig, "RIB_BQ" )
		iuoLibelle.Uf_SetValue ( "ARIBBQ", sVal )

		sVal = iDw_LstInter.GetItemString ( lLig, "RIB_GUI" )
		iuoLibelle.Uf_SetValue ( "ARIBGU", sVal )

		sVal = iDw_LstInter.GetItemString ( lLig, "RIB_CPT" )

		// [PM360-4]
		sVal = Fill ( "X", 9 ) + Right ( sVal, 2 ) 
		
		iuoLibelle.Uf_SetValue ( "ARIBCP", sVal )

		sVal = iDw_LstInter.GetItemString ( lLig, "RIB_CLE" )
		iuoLibelle.Uf_SetValue ( "ARIBCL", sVal )

		// [VDOC25726]
		sVal= iDw_LstInter.GetItemString ( lLig, "ADR_MAIL" )
		If not isNull(sVal) Then iuoLibelle.Uf_SetValue ( "ZVAT23", sVal )
	End If

/*------------------------------------------------------------------*/
/* DETAIL DE SINISTRE                                               */
/*------------------------------------------------------------------*/
	sVal = idw_wSin.Describe ( "Evaluate ( 'LookUpDisplay ( ID_DETSIN )', 1 ) " )
	iuoLibelle.Uf_SetValue ( "IDETSI", sVal )
/*------------------------------------------------------------------*/
/* NATURE DE SINISTRE                                               */
/*------------------------------------------------------------------*/
	sVal = idw_wSin.Describe ( "Evaluate ( 'LookUpDisplay ( ID_NATSIN )', 1 ) " )
	iuoLibelle.Uf_SetValue ( "INATSI", sVal )
/*------------------------------------------------------------------*/
/* TERRITORIALITE DE SURVENANCE                                     */
/*------------------------------------------------------------------*/
	sVal = idw_wSin.Describe ( "Evaluate ( 'LookUpDisplay ( ID_TERRIT )', 1 ) " )
	iuoLibelle.Uf_SetValue ( "ITERSI", sVal )
/*------------------------------------------------------------------*/
/* DATE RECU                                                        */
/*------------------------------------------------------------------*/
	sVal = isDteCourCli
	iuoLibelle.Uf_SetValue ( "INRECD", sVal )
/*------------------------------------------------------------------*/
/* INFORMATION RECUE                                                */
/*------------------------------------------------------------------*/
	Choose Case isCodRecu
	Case "C"
		sVal = "courrier"
	Case "F"
		sVal = "fax"
	Case "T"
		sVal = "appel téléphonique"
	// #2 DCMP 020458, JFF
	Case "I"
		sVal = "e-mail"
	Case "Q"
		sVal = "questionnaire"
	Case Else
		sVal = ""
	End Choose
	iuoLibelle.Uf_SetValue ( "INRECU", sVal )
/*------------------------------------------------------------------*/
/* CODE SECTEUR                                                     */
/*------------------------------------------------------------------*/
	sVal = String ( idw_Produit.GetItemNumber ( 1, "ID_DEPTS" ) )
	iuoLibelle.Uf_SetValue ( "PCODDG", sVal )
// #15
	sLibDept = space ( 35 )
	itrTrans.IM_S01_DEPARTEMENT( Dec(sVal), sLibDept )
	iuoLibelle.Uf_SetValue ( "ZVAR28", sLibDept )
// #15 - fin
/*------------------------------------------------------------------*/
/* CODE DEPARTEMENT DU PRODUIT                                      */
/*------------------------------------------------------------------*/
	sVal = String ( idw_Produit.GetItemNumber ( 1, "ID_DEPT" ) )
	iuoLibelle.Uf_SetValue ( "PCODDP", sVal )
// #15
	sLibDept = space ( 35 )
	itrTrans.IM_S01_DEPARTEMENT( Dec(sVal), sLibDept )
	iuoLibelle.Uf_SetValue ( "ZVAR27", sLibDept )
// #15 - fin
/*------------------------------------------------------------------*/
/* NOM DE LA COMPAGNIE D'ASSURANCE/NO DE LA POLICE                  */
/*------------------------------------------------------------------*/
	lTotPolice	= idw_Police.RowCount ()

	lIdPolice[1]= idw_Produit.GetItemNumber ( 1, "ID_POLICE" )
/*----------------------------------------------------------------------------*/
/* Si le N° de Police est connu, on recherche le nom de la compagnie.         */
/*----------------------------------------------------------------------------*/
	If	Not IsNull ( lIdPolice[1] )	Then
		sRech 	= "ID_POLICE = " + String ( lIdPolice[1] )
		lLig		= idw_Police.Find ( sRech, 1, lTotPolice )

		sVal		= idw_Police.GetItemString ( lLig, "LIB_CIE" )
		iuoLibelle.Uf_SetValue ( "PCOMPA", sVal )

// #32 [POLICE_PARTICULIERE]
//		sVal		= idw_Police.GetItemString ( lLig, "LIB_POLICE" )
		sVal = Fill ( " ", 35 )
		//SQLCA.PS_S01_LIB_POLICE ( lIdSin, lIdProd, lIdRev, lIdIGti1er, sVal ) 
		SQLCA.PS_S01_LIB_POLICE_V01 ( lIdSin, lIdProd, lIdRev, lIdIGti1er, lIdPolice[1], sVal )  // [PC683]
		iuoLibelle.Uf_SetValue ( "PPOLIC", sVal )
	Else
/*------------------------------------------------------------------*/
/* Sinon, si la révision est connue et qu'il existe une seule       */
/* police parmi toutes les garanties saisies, on peut afficher le   */
/* N° de la Police.                                                 */
/*------------------------------------------------------------------*/
		If	idw_wSin.GetItemNumber ( 1, "ID_REV" ) <> -1	Then
			lTotGti			= idw_Garantie.RowCount ()
			lTotGtiSaisi	= idw_LstGti.RowCount ()
/*------------------------------------------------------------------*/
/* On arme un tableau correspondant au N° de police que l'on        */
/* trouve pour la garantie saisie. (Recherche de la police sur la   */
/* DW GARANTIE).                                                    */
/*------------------------------------------------------------------*/
			For	lCpt = 1 To lTotGtiSaisi
					lIdGti	= idw_LstGti.GetItemNumber ( lCpt, "ID_GTI" )
					sRech		= "ID_GTI = " + String ( lIdGti )
					lLig		= idw_Garantie.Find ( sRech, 1, lTotGti )
/*------------------------------------------------------------------*/
/* Modification DBI le 11/08/1999 - jour de l'éclipse               */
/* Gestion lIdPolice [ lCpt ] = -1 dans le cas ou garantie existe   */
/* sur                                                              */
/* le produit mais pas les conditions ( voir chargement ci-dessus ) */
/*------------------------------------------------------------------*/
					If lLig > 0 Then
						lIdPolice[ lCpt ] = idw_Garantie.GetItemNumber ( lLig, "ID_POLICE" )
					Else
						lIdPolice[ lCpt ] = -1
					End If
			Next

			bPoliceConnu = True
/*------------------------------------------------------------------*/
/* Si on n'a saisi aucune garantie, la police est forcément         */
/* inconnue.                                                        */
/*------------------------------------------------------------------*/
			If			lTotGtiSaisi = 0	Then	
						bPoliceConnu = False
			Else
/*------------------------------------------------------------------*/
/* On compare le tableau des polices récupérées. S'il en existe     */
/* une de différente, il ne faut pas armer le N° de police. S'il    */
/* existe une seule garantie de saisie, on arme le N° de police.    */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Modification DBI le 11/08/1999 - jour de l'éclipse               */
/* Gestion lIdPolice [ lCpt ] = -1 dans le cas ou garantie existe   */
/* sur                                                              */
/* le produit mais pas les conditions ( voir chargement ci-dessus ) */
/*------------------------------------------------------------------*/

				For	lCpt = 2 To lTotGtiSaisi
						If	( lIdPolice[ lCpt ]  <> -1 ) And &
							( lIdPolice[ lCpt ]	<>	lIdPolice[ 1 ] )	Then

							bPoliceConnu = False
							Exit
						End If
				Next
			End If


			If	bPoliceConnu And lIdPolice[1] <> -1	Then	// #1 Modif DBI le 04/04/2000

				sRech 	= "ID_POLICE = " + String ( lIdPolice[1] )
				lLig		= idw_Police.Find ( sRech, 1, lTotPolice )

				sVal		= idw_Police.GetItemString ( lLig, "LIB_CIE" )
				iuoLibelle.Uf_SetValue ( "PCOMPA", sVal )

// #32      JFF      20/11/2009  [POLICE_PARTICULIERE]
//				sVal		= idw_Police.GetItemString ( lLig, "LIB_POLICE" )
				sVal = Fill ( " ", 35 )
//				SQLCA.PS_S01_LIB_POLICE ( lIdSin, lIdProd, lIdRev, lIdIGti1er, sVal ) 
				SQLCA.PS_S01_LIB_POLICE_V01 ( lIdSin, lIdProd, lIdRev, lIdIGti1er, lIdPolice[1], sVal )  // [PC683]
		
// subroutine PS_S01_LIB_POLICE (Long dcIdSin, Long dcIdprod, Long dcIdRev, Long dcIdGti, ref String sLibPolice ) RPCFUNC ALIAS FOR "sysadm.PS_S01_LIB_POLICE" // [POLICE_PARTICULIERE]
				
				iuoLibelle.Uf_SetValue ( "PPOLIC", sVal )
			End If
		
		End If
	End If
	
	// Je stocke le libellé de la police 
	// [DT410]
	sLibPoliceDef = sVal
	
/*------------------------------------------------------------------*/
/* CODE PRODUIT                                                     */
/*------------------------------------------------------------------*/
	sVal = String ( idw_wSin.GetItemNumber ( 1, "ID_PROD" ) )
	iuoLibelle.Uf_SetValue ( "PIDPRO", sVal )
/*------------------------------------------------------------------*/
/* LIBELLE COURT DU PRODUIT                                         */
/*------------------------------------------------------------------*/
/* #9 : DCMP 040241																  */
/*------------------------------------------------------------------*/
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 22 )
	If lDeb > 0 Then
		sVal = idw_Produit.GetItemString ( 1, "LIB_LONG" )
	Else
		sVal = idw_Produit.GetItemString ( 1, "LIB_COURT" )
	End If

	iuoLibelle.Uf_SetValue ( "PLIBCO", sVal )

//#13 On en profite pour armée ZVAR25 avec la même valeur. 
//    Elle sera éventuellement modifier par l'option -DP/66
	iuoLibelle.Uf_SetValue ( "ZVAR25", sVal )		 	

//#13 nom produit pour l'assuré
  bOkDp66 = FALSE
  F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 66 )
   If lDeb > 0 Then
		sVal = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) )

		If sVal <> "" And Not IsNull ( sVal ) Then
			iuoLibelle.Uf_SetValue ( "ZVAR25", sVal )
			bOkDp66 = TRUE
		End If
	End If 

 //#13 nom option pour l'assuré
 F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 67 )
 If lDeb > 0 And bOkDp66 Then
 	sVal = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) )

	If sVal <> "" And Not IsNull ( sVal ) Then
	 	iuoLibelle.Uf_SetValue ( "ZVAR26", sVal )
	Else
	 	iuoLibelle.Uf_SetValue ( "ZVAR26", "" )		 			
	End If
 Else 	 
 	iuoLibelle.Uf_SetValue ( "ZVAR26", "" )		 	
 End If 
	
	
/*------------------------------------------------------------------*/
/* LIBELLE LONG DU PRODUIT                                          */
/*------------------------------------------------------------------*/
	sVal = idw_Produit.GetItemString ( 1, "LIB_LONG" )
	iuoLibelle.Uf_SetValue ( "PLIBLO", sVal )
/*------------------------------------------------------------------*/
/* NUMERO DE FAX PRODUIT                                            */
/*------------------------------------------------------------------*/
	//#30 - [DCMP090552] - Déplacement de l'affectation dans la boucle des inters
	/*sVal = Uf_Format_NumTel ( idw_Produit.GetItemString ( 1, "NUM_FAX" ) )
	iuoLibelle.Uf_SetValue ( "PNOFAX", sVal )*/
/*------------------------------------------------------------------*/
/* NUMERO DE TELEPHONE PRODUIT                                      */
/*------------------------------------------------------------------*/
	//#30 - [DCMP090552] - Déplacement de l'affectation dans la boucle des inters
/*	sVal = Uf_Format_NumTel ( idw_Produit.GetItemString ( 1, "NUM_TEL" ) )
	iuoLibelle.Uf_SetValue ( "PNOTEL", sVal )*/
	
/*------------------------------------------------------------------*/
/* OPERATEUR QUI A MIS A JOUR LE DOSSIER                            */
/*------------------------------------------------------------------*/
	sVal = stGlb.sCodOper
	iuoLibelle.Uf_SetValue ( "SCODOP", sVal )
/*------------------------------------------------------------------*/
/* DATE D'ADHESION                                                  */
/*------------------------------------------------------------------*/
	sVal = String ( idw_wSin.GetItemDate ( 1, "DTE_ADH" ), "DD/MM/YYYY" )
	iuoLibelle.Uf_SetValue ( "SDTADH", sVal )
/*------------------------------------------------------------------*/
/* DATE DE SURVENANCE DU SINISTRE                                   */
/*------------------------------------------------------------------*/
	sVal = String ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" ), "DD/MM/YYYY" )
	iuoLibelle.Uf_SetValue ( "SDTESU", sVal )
/*------------------------------------------------------------------*/
/* DUREE D'OPPOSITION                                               */
/*------------------------------------------------------------------*/
	lTotGtiSaisi	= idw_LstGti.RowCount ()
	sRech				= "ID_GTI = 7"
	lLig				= idw_LstGti.Find ( sRech, 1, lTotGtiSaisi )
	If	lLig > 0	Then
		dDteOppo		= Date ( idw_LstGti.GetItemDateTime ( lLig, "DTE_OPPO" ) )
//Migration PB8-WYNIWYG-03/2006 FM
//		dDte1erUf	= idw_LstGti.GetItemDate ( lLig, "DTE_1ER_UF" )
		dDte1erUf	= Date(idw_LstGti.GetItemDateTime ( lLig, "DTE_1ER_UF" ))
//Fin Migration PB8-WYNIWYG-03/2006 FM
		If	Not IsNull ( dDteOppo ) And Not IsNull ( dDte1ErUf )	Then
			sVal = String ( DaysAfter ( dDte1ErUf, dDteOppo ) )
			If	sVal = "1" Then
				sVal = sVal + " er"
			Else
				sVal = sVal + " ème"
			End If
			iuoLibelle.Uf_SetValue ( "SDUOPP", sVal )
		End If
	End If
/*------------------------------------------------------------------*/
/* NUMERO DE CARTE OU D'ADHESION                                    */
/*------------------------------------------------------------------*/
	sVal = idw_wSin.GetItemString ( 1, "ID_ADH" )
	iuoLibelle.Uf_SetValue ( "SIDADH", sVal )
/*------------------------------------------------------------------*/
/* NUMERO DE SINISTRE                                               */
/*------------------------------------------------------------------*/
	sVal = String ( idw_wSin.GetItemNumber ( 1, "ID_SIN" ) )
	iuoLibelle.Uf_SetValue ( "SIDSIN", sVal )
/*------------------------------------------------------------------*/
/* NUMERO ETS                                                       */
/*------------------------------------------------------------------*/
	sVal = String ( idw_wSin.GetItemNumber ( 1, "ID_ETS" ) )
	iuoLibelle.Uf_SetValue ( "SIDETS", sVal )
/*------------------------------------------------------------------*/
/* LIBELLE ASSOCIE A ID_ETS                                         */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* Si COD_ADH = 1,2,4,5,6 le libellé du groupe est armé sur le      */
/* retrieve de la DDDW DD_S01_ETABLISSEMENT. (Fonction              */
/* Uf_Preparer_Modifier). Il ne reste donc qu'a faire un Find pour  */
/* trouver ce libellé.                                              */
/*------------------------------------------------------------------*/
	sCodAdh = idw_Produit.GetItemString ( 1, "COD_ADH" )
	Choose Case sCodAdh
	Case "1", "2", "4", "5", "6"
		idw_wSin.GetChild ( "ID_ETS", dwChild )
		lTotEts	= dwChild.RowCount ()
		sRech		= "ID_ETS = " + String ( idw_wSin.GetItemNumber ( 1, "ID_ETS" ) )
		lLig		= dwChild.Find ( sRech, 1, lTotEts )
		sVal		= dwChild.GetItemString ( lLig, "LIB_GRP" )

/*------------------------------------------------------------------*/
/* Si COD_ADH = "3", la zone ID_ETS sert pour la jointure avec      */
/* ID_GRP sur GROUPE. La zone ID_ETS est armée sur la création du   */
/* WorkFlow.                                                        */
/* (Utilisation de la commande PS_S01_CARTE_SINISTRE).              */
/*------------------------------------------------------------------*/
	Case "3"
		lIdGrp	= idw_wSin.GetItemNumber ( 1, "ID_ETS" )
		sLibGrp	= Space ( 35 )
		itrTrans.IM_S01_GROUPE ( lIdGrp, sLibGrp )
/*------------------------------------------------------------------*/
/* La commande qui récupére le nom du groupe vient d'échouer, on    */
/* arréte le traitement des variables immédiatement. Le message va  */
/* être affiché dans la fonction Uf_Controler_Gestion().            */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* La personne peut bloquer son dossier et appeler le service       */
/* informatique.                                                    */
/*------------------------------------------------------------------*/
		If	Not F_Procedure ( stMessage, itrTrans, "IM_S01_GROUPE" )	Then			
			Return ( "REF_CIE" )
		Else
			sVal = sLibGrp
		End If
	End Choose
	iuoLibelle.Uf_SetValue ( "SLIETS", sVal )
/*------------------------------------------------------------------*/
/* MONTANT DE LA FRANCHISE UF APPLIQUE                              */
/*------------------------------------------------------------------*/
	lTotGtiSaisi	= idw_LstGti.RowCount ()
	sRech				= "ID_GTI = 7"
	lLig				= idw_LstGti.Find ( sRech, 1, lTotGtiSaisi )
	If	lLig > 0	Then
		dcMtFranaReg = idw_LstGti.GetItemNumber ( lLig, "MT_FRAN_AREG" )

		sVal = String ( dcMtFranaReg )
		iuoLibelle.Uf_SetValue ( "SMTFRA", sVal )
	End If

/*------------------------------------------------------------------*/
/* #3 : Renseignement de la variable ZVAR05 (idem à SAVANE) avec le */
/* Prénom et nom du Gestionnaire.											  */
/*------------------------------------------------------------------*/
/* Si l'on est en SEV ou (en SVE ET autorisation 10 ) Alors ..      */
/*------------------------------------------------------------------*/
	
	/*----------------------------------------------------------------------------------------------*/
	/* #12 : Ajout du paramétre -1 de l'interlocuteur suite modif  de la fonction uf_GetAutorisation*/
	/*----------------------------------------------------------------------------------------------*/
	This.Uf_GetAutorisation ( "", sBIN, bVal, bVal, bVal, -1 )
	If Not ibSaisieValidation Or ( ibSaisieValidation And Mid ( sBIN, 10, 1 ) = "1" ) Then
		iUoLibelle.Uf_SetValue ( "ZVAR05" ,  stGlb.sPrenomOper + " " + stGlb.sNomOper )
	Else
		iUoLibelle.Uf_SetValue ( "ZVAR05" ,  "Pour SPB" )
	End If

/*------------------------------------------------------------------*/
/* On arme une seconde variable avec le nom et prénom du            */
/* gestionnaire dans tous les cas, pour l'enveloppe.                */
/* différence avec ZVAR05 : ZVAR05 peut varier, ZVAR22 est fixe.    */
/*------------------------------------------------------------------*/
	iUoLibelle.Uf_SetValue ( "ZVAR22" ,  stGlb.sPrenomOper + " " + stGlb.sNomOper )

/*------------------------------------------------------------------*/
/* #11 CAG 03/09/04		                                            */
/*------------------------------------------------------------------*/
	idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV' AND ID_TYP_ART NOT IN ( 'EDI', 'PRS' )" )	
	
	idw_LstwCommande.Filter ()
	// Pas besoin de filtrer sur id_seq, le tri est fait dans la dw, la première lgn est la dernière cmde
	If idw_LstwCommande.RowCount () > 0 Then
		
		// [VDOC19876]
		IF idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" ) = "RST" Then
			iUoLibelle.Uf_SetValue ( "ZVAR24", idw_Wsin.GetItemString ( 1, "MARQ_PORT" ) + " " + idw_Wsin.GetItemString ( 1, "MODL_PORT" )  )								
		Else
			iUoLibelle.Uf_SetValue ( "ZVAR24", idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) + " " + idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) )				
		End If
		// [PC301].[LOT2]		

		dcMtTTCCmde = idw_LstwCommande.GetItemDecimal ( 1, "MT_TTC_CMDE" )
		sVal = F_Monnaie ( dcMtTTCCmde, lChoixMonnaie, sSeparateurMonnaie )
		iUoLibelle.Uf_SetValue ( "ZVAR52", sVal )

		// [PC301].[NDC_V12]
		sVal = String ( idw_LstwCommande.GetItemDatetime ( 1, "CREE_LE" ), "DD/MM/YYYY" )
		iUoLibelle.Uf_SetValue ( "ZVAR53", sVal )		
		
		dtValDate = Date ( sVal )
		
		// [RS6175_GC_SCRP_SIM2]
		sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "DUREE_GTI_ORIG" )	)			

		If IsNull ( sVal ) Then sVal = ""

		dtValDate = F_Plus_Date ( dtValDate, Long ( sVal ), "M" )
		sVal = String ( dtValDate, "DD/MM/YYYY" )
		
		iUoLibelle.Uf_SetValue ( "ZVAR54", sVal )
		// :[PC301].[LOT2]
		
	End If

	idw_LstwCommande.SetFilter ( "ID_FOUR NOT IN ( 'FNC' ) AND COD_ETAT = 'CNV'" )
	idw_LstwCommande.Filter ()
	// Pas besoin de filtrer sur id_seq, le tri est fait dans la dw, la première lgn est la dernière cmde
	If idw_LstwCommande.RowCount () > 0 Then

		/*------------------------------------------------------------------*/
		/*#12 Initialisation du numéro de commande                          */
		/*------------------------------------------------------------------*/
		sIdSin = string (idw_LstwCommande.GetItemNumber ( 1 , "ID_SIN"))
		sIdSeq = string ( idw_LstwCommande.GetItemNumber ( 1 , "ID_SEQ"))
		iUoLibelle.Uf_SetValue ( "NUMCMD", sIdSin + "-" + sIdSeq )

		/*------------------------------------------------------------------*/
		/*#12 Initialisation de la variable des frais d'envoi               */
		/*------------------------------------------------------------------*/
		// #19
		//  [DCMP100551]
//		F_Determiner_Montant_Frais_Envoi ( String ( idw_LstwCommande.GetItemNumber ( 1 , "INFO_SPB_FRN" ) ), idw_Wsin.object.id_prod[1], idw_DetPro, dcFrais ) // #19 
		sTypApp="-1"
		
		lDeb=idw_wdivsin.find("Upper(nom_zone)='TYPE_APP'",1,idw_wdivsin.RowCount())
		if lDeb > 0 Then sTypApp = idw_wdivsin.GetItemString(lDeb,"VAL_CAR")
		
		F_Determiner_Montant_Frais_Envoi ( String ( idw_LstwCommande.GetItemNumber ( 1 , "INFO_SPB_FRN" ) ), idw_Wsin.object.id_prod[1], sTypApp, idw_DetPro, dcFrais ) 
		// :[DCMP100551]
		
		If not Isnull ( dcFrais ) and dcFrais <> 0 Then iuoLibelle.Uf_SetValue ( "MTFREV", string ( dcFrais ) )
		// #19 - FIN
		
	End If
	idw_LstwCommande.SetFilter ( "" )
	idw_LstwCommande.Filter ()

	// #16 Montant Max TTC Pris en charge
	//* #24 [FNAC_PROD_ECH_TECH])
	This.Uf_Determiner_Data_Sinistre_PlafPec ( sMtPecMonnaie, sMtPecCentimes )
	If IsNull ( sMtPecMonnaie ) Then sMtPecMonnaie = ""
	iuoLibelle.Uf_SetValue ( "ZVAR30", sMtPecMonnaie )
	
	If IsNull ( sMtPecCentimes ) Then sMtPecCentimes = ""
	iuoLibelle.Uf_SetValue ( "ZVAR41", sMtPecCentimes )

	idw_LstwCommande.SetFilter ( "ID_FOUR = 'FNC' AND COD_ETAT = 'CNV'" )
	idw_LstwCommande.Filter ()
	// Pas besoin de filtrer sur id_seq, le tri est fait dans la dw, la première lgn est la dernière cmde
	If idw_LstwCommande.RowCount () > 0 Then

		/*------------------------------------------------------------------*/
		/*#12 Initialisation du numéro de commande                          */
		/*------------------------------------------------------------------*/
		sIdSin = string (idw_LstwCommande.GetItemNumber ( 1 , "ID_SIN"))
		sIdSeq = string ( idw_LstwCommande.GetItemNumber ( 1 , "ID_SEQ"))
		iUoLibelle.Uf_SetValue ( "ZVAR40", sIdSin + sIdSeq )		

		// #31 [FNAC_PROD_ECH_TECH].[BGE]
		sBGE_ZVAR48 += sIdSin + sIdSeq 
		sBGE_ZVAR48 += "9" // Code devise
		sBGE_ZVAR48 += Right ( Fill ( "0", 7 ) + sMtPecCentimes, 7) // Montant en Centimes sur 7 chiffres bourré à gauche		

	Else // Pas de BGE
		sBGE_ZVAR48 = ""
	End If
	iUoLibelle.Uf_SetValue ( "ZVAR48", sBGE_ZVAR48 )		
	

	//* :#24 [FNAC_PROD_ECH_TECH]
	idw_LstwCommande.SetFilter ( "" )
	idw_LstwCommande.Filter ()

/*------------------------------------------------------------------*/
/* #4 : JFF le 03/02/03 : Ajout des variables de téléhponie         */
/* nécéssaires au courriers ORANGE                                  */
/*------------------------------------------------------------------*/
	// [VDOC22243]
	sVal=idw_wSin.GetItemString ( 1, "NUM_PORT" )
	If isNull(sVal) Then sVal=""

	if sVal = "06 10 10 10 10" Or sVal="06 01 02 03 04" Then sVal=""
	
	If sVal <> "" Then
		iUoLibelle.Uf_SetValue ( "ZVAR06" ,  Right ( "0000000000" + F_Format_Num_Tel ( sVal, FALSE) , 10 ) )  // N° du mobile // #20
	End if
	// :[VDOC22243]
	
	iUoLibelle.Uf_SetValue ( "ZVAR07" ,  idw_wSin.GetItemString ( 1, "ID_CONTRAT_ABONNE" ) )  // Contrat de l'abonné
	iUoLibelle.Uf_SetValue ( "ZVAR08" ,  uf_epurezone(idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" )) )  // IMEI // [VDoc12269]

	// [PC896_CDISCOUNT][V4]
	sVal = idw_wSin.GetItemString ( 1, "MARQ_PORT" )
	If sVal = "PAS_DE_MARQUE" Then
		sVal = ""	
	End If
	iUoLibelle.Uf_SetValue ( "ZVAR09" ,  sVal )  // ORIAN Marque Portable
	
	iUoLibelle.Uf_SetValue ( "ZVAR10" ,  idw_wSin.GetItemString ( 1, "MODL_PORT" ) )  // ORIAN Modèle Portable

	idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
	sVal = String ( idw_wSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) )	
	lRow = dwChild.Find ( "ID_BOUTIQUE = " + sVal, 1, dwChild.RowCount () )
	If lRow > 0 Then
		sVal += " " + dwChild.GetItemString ( lRow, "ADR_VILLE" )
	
		//* #24 [FNAC_PROD_ECH_TECH]
		sVal2 = dwChild.GetItemString ( lRow, "ADR_NOM" )		
		
		// #25 - [DCMP090007]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 109  )
		sVal3 = ""
		If lDeb > 0 Then // #26 - [DCMP090007].[20080116155731]
			// [PI052]
			sVal3 = "GAME " 
		End If

		if not isnull(sVal2) Then sVal3 +=sVal2 

		// [PI052]
		iUoLibelle.Uf_SetValue ( "ZVAR74", sVal3 )
		
		sVal3 = sVal3 + char(11)
		
		sVarTmpPI052 = ""
		if not isnull(dwChild.GetItemString ( lRow, "ADR_1" )) Then
			// [PI052]
			sVarTmpPI052 = dwChild.GetItemString ( lRow, "ADR_1" )
			sVal3 += sVarTmpPI052
			iUoLibelle.Uf_SetValue ( "ZVAR75", sVarTmpPI052 )
		End if
		sVal3 = sVal3 + char(11)
		
		sVarTmpPI052 = ""
		if not isnull(dwChild.GetItemString ( lRow, "ADR_2" )) And  Trim (dwChild.GetItemString ( lRow, "ADR_2" )) <>""  Then
			// [PI052]
			sVarTmpPI052 = dwChild.GetItemString ( lRow, "ADR_2" )
			sVal3 += sVarTmpPI052 + Char(11)
			iUoLibelle.Uf_SetValue ( "ZVAR76", sVarTmpPI052 )			
		End if

		sVarTmpPI052 = ""		
		if not isnull(dwChild.GetItemString ( lRow, "ADR_CP" )) Then
			// [PI052]
			sVarTmpPI052 = dwChild.GetItemString ( lRow, "ADR_CP" )
			sVal3 += sVarTmpPI052 + " "
		End if
		
		sVal3 +=Upper(dwChild.GetItemString ( lRow, "ADR_VILLE" ))
		// [PI052]
		sVarTmpPI052 += Upper(dwChild.GetItemString ( lRow, "ADR_VILLE" ))
		iUoLibelle.Uf_SetValue ( "ZVAR77", sVarTmpPI052 )
		// #25 - Fin [DCMP090007]
		
/*------------------------------------------------------------------*/
/* #7 DCMP 040141 : On supprime tout ce qui est dérrière la         */
/* parenthèse.                                                      */
/*------------------------------------------------------------------*/
		lPos = Pos ( sVal, "(", 1 )
		If lPos > 0 Then
			sVal = Replace ( sVal, lPos, Len ( sVal ) - lPos + 1, "" ) 
		End If
	
	End If

	iUoLibelle.Uf_SetValue ( "ZVAR11" ,  Trim ( sVal ) )  // ORIAN Boutique
	iUoLibelle.Uf_SetValue ( "ZVAR42" ,  Trim ( sVal2 ) )  //* #24 [FNAC_PROD_ECH_TECH]
	
	// #25 - [DCMP090007]
	iUoLibelle.Uf_SetValue ( "ZVAR43", sVal3)


/*------------------------------------------------------------------*/
/* #5 : JFF le 29/12/03                                             */
/* #12: MADM le 27/07/2006	: Ajout du TRIM sur l'armement de sval   */
/*------------------------------------------------------------------*/
	lDeb= Long(idw_LstGti.Describe ( "Evaluate ( 'sum(if( cod_etat =900,0,1) for all)', 1 )" ) )
	
	// [VDoc2465]
	
//	If idw_LstGti.RowCount () = 1 Then
	If  lDeb = 1 Then 	
		lDeb = idw_LstGti.Find("COD_ETAT <> 900", 1, idw_LstGti.RowCount ())
		If lDeb <= 0 Then lDeb=1
		sVal = Trim ( Lower ( idw_LstGti.Describe ( "Evaluate ( 'LookUpDisplay ( ID_GTI )', " + string(lDeb) + " )" ) ))
		
		//sVal = Trim ( Lower ( idw_LstGti.Describe ( "Evaluate ( 'LookUpDisplay ( ID_GTI )', 1 )" ) ))
		// :[VDoc2465]
		
		iPos = Pos ( sVal, "telephone", 1 )
		If iPos > 0 Then 
			sVal = Replace ( sVal, iPos, 9, "" )
		End If
		sVal = Trim ( sVal )
		
		iUoLibelle.Uf_SetValue ( "ZVAR13" , sVal )  // ex : bris

		// on précise le genre.
		Choose Case idw_LstGti.GetItemNumber ( 1, "ID_GTI" )
			/*--------------------------------------------------------------------*/
		   /* #12 : MADM le 27/07/06  Ajout de la gti 22 au genre "le"           */
			/*--------------------------------------------------------------------*/
			// #18	ajout de 6, 14, 20
			Case 10, 11, 22, 6, 14, 20
				sVal = "le " + sVal
			// #18	ajout de 4, 13, 15, 19, 23, 26
			Case 12, 18, 4, 13, 15, 19, 23, 26
				sVal = "la " + sVal
			/*--------------------------------------------------------------------*/
		   /* #12 : MADM le 27/07/06  Ajout du genre "l'" avec les gti 17,24,27  */
			/*--------------------------------------------------------------------*/	
			// #18	ajout de 9, 16, 25
			Case 17, 24, 27, 9, 16, 25
				sVal = "l'" + sVal
			// #18	ajout de l'article "les" avec 1, 2, 3, 5, 7, 8, 21
			Case 1, 2, 3, 5, 7, 8, 21
				sVal = "les " + sVal
			/*--------------------------------------------------------------------*/
		   /* #12 : MADM le 27/07/06  traitement du cas Else "VARIABLE NON ARMEE"*/
			/*--------------------------------------------------------------------*/
			Case Else
				sVal = sVarNonArmee 
		End Choose

		iUoLibelle.Uf_SetValue ( "ZVAR12" , sVal )  // ex : le bris

	Else
		iUoLibelle.Uf_SetValue ( "ZVAR12" , "!!PLUS D'UNE GARANTIE!!" )  
	End If	

	sVal = String ( idw_wSin.GetItemDate ( 1, "DTE_DECL" ), "DD/MM/YYYY" )
	iUoLibelle.Uf_SetValue ( "ZVAR17" , sVal )  // Date de déclaration.

/*------------------------------------------------------------------*/
/* #12 : MADM le 24/07/06                                           */
/*------------------------------------------------------------------*/
/*--------------------------------------------------------------------*/
/* #12 : MADM le 28/08/06  Armement de l'ID produit                   */
/*--------------------------------------------------------------------*/
  F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 58 )
   If lDeb > 0 Then
		sVal = idw_DetPro.GetItemString ( lDeb, "VAL_CAR" )
		iuoLibelle.Uf_SetValue ( "CODSVO", sVal )
	Else
		iuoLibelle.Uf_SetValue ( "CODSVO", sVarNonArmee )
   End If
	
	
	
  F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 59 )
   If lDeb > 0 Then
		sVal =  idw_DetPro.GetItemString ( lDeb, "VAL_CAR" )
		iuoLibelle.Uf_SetValue ( "NOMSAV", sVal )	
	Else
		iuoLibelle.Uf_SetValue ( "NOMSAV", sVarNonArmee )	
	End If

	
  F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 60 )
   If lDeb > 0 Then
		sVal =  idw_DetPro.GetItemString ( lDeb, "VAL_CAR" )
		iuoLibelle.Uf_SetValue ( "URLSPB", sVal )
	Else
		iuoLibelle.Uf_SetValue ( "URLSPB", sVarNonArmee )		 	
	End If

// #15 Coût de l'appel.
  F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 70 )
   If lDeb > 0 Then
		sVal =  idw_DetPro.GetItemString ( lDeb, "VAL_CAR" )
		iuoLibelle.Uf_SetValue ( "ZVAR29", sVal )
	Else
// #29 [DMDI26408]
//		iuoLibelle.Uf_SetValue ( "ZVAR29", sVarNonArmee )		 	
		iuoLibelle.Uf_SetValue ( "ZVAR29", "" )		 	
// #29 :[DMDI26408]		
	End If
// #15 - fin
/*-----------------------------------------------------------------------*/
/*#12 lecture de la clé URL_ACROBAT dans la section DIVERS du fichier INI*/
/* et Initialisation de la variable de l'URL                             */
/*-----------------------------------------------------------------------*/
sValURL	= ProfileString ( sFicIniApp, "DIVERS", "URL_ACROBAT",  "" )
iuoLibelle.Uf_SetValue ( "URLACR", sValURL )

// #17 
sVal = This.uf_GestOng_Divers_Trouver ( "DTE_PASS_MAG" )
If IsNull ( sVal ) Then sVal = ""
iuoLibelle.Uf_SetValue ( "ZVAR31", sVal )

// #20 Gestion Horaire d'ouverture 
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 84 )
If lDeb > 0 Then
 sVal = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ) )
 If IsNull ( sVal ) Then sVal = ""
 iuoLibelle.Uf_SetValue ( "ZVAR32", sVal )
End If

// #20 Si l'utilisateur demande une regénération de mdp OU 
// ( qu'une cmde Web a été passée ET Aucun mdp n'a encore été généré ) ALORS
// On génére un nouveau mdp
sRetTrtMdp = This.uf_Gestion_Mdp_Extranet_Cmde ( "TRAITEMENT" )
If sPos = "" And sRetTrtMdp = "0" Then 
	iuoLibelle.Uf_SetValue ( "MDPCMD", "" )
	sPos = "ALT_BLOC"
Else
	// #20 Armement du mdp donnant accès au site 
	sVal = This.uf_Gestion_Mdp_Extranet_Cmde ( "RETOURNER" )
	If IsNull ( sVal ) Then sVal = ""
	iuoLibelle.Uf_SetValue ( "MDPCMD", sVal )
End If

// #20 Armement de l'URL donnant accès au site
sRetTrtMdp = ""
sVal = This.uf_Gestion_Mdp_Extranet_Cmde ( "PRESENCE_CMDE_WEB" )
sVal2 = This.uf_Gestion_Mdp_Extranet_Cmde ( "RETOURNER" )

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 80 )
If lDeb > 0 Then
	sRech = "( COD_ETAT IN ( 'CNV', 'CWE') AND ID_FOUR = 'WBA' ) "
	lRow = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())
	
	If lRow > 0 Then
		lDeb = idw_DetPro.Find ( "ID_CODE_NUM = " + String ( idw_LstwCommande.GetItemNumber ( lRow,"ID_GTI" ) ) + " AND " + &
										 "ID_CODE_CAR = '" + idw_LstwCommande.GetItemString ( lRow,"ID_TYP_ART" ) + "'" , lDeb, lFin )
	Else 
		lDeb = 0
	End If
End If									

// Si l'on a l'option Et une cmde Web ET un mdp valide Alors on ctrle et on arme
If lDeb > 0 And sVal = "1" And Not IsNull ( sVal2 ) And Trim ( sVal2 ) <> "" Then
	sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "URL", ";")
	If Pos ( Upper ( sVal ), "HTTP://", 1 ) <= 0 Then
		iuoLibelle.Uf_SetValue ( "URLCMD", "" )		
		sRetTrtMdp = "0"
	Else
		iuoLibelle.Uf_SetValue ( "URLCMD", sVal )
	End If
Else
	iuoLibelle.Uf_SetValue ( "URLCMD", sVarNonArmee )
End If

If sPos = "" And sRetTrtMdp = "0" Then 
	sPos = "ALT_BLOC"
	stMessage.sTitre		= "Problème de paramètrage"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "WSIN498"
	If bAltEdit Then F_Message ( stMessage )
End If

// Armement de la date d'expiration du mdp
// Attention j'utilise le lDEB précédemment armé avec l'opt 80
If sPos = "" And lDeb > 0 Then
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'mdp_net'", 1,  idw_WDivSin.RowCount () )
	If lRow > 0 Then
		dtValDate = Date ( idw_WDivSin.GetItemDateTime ( lRow, "MAJ_LE" ) )
		sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DEL_MDP", ";")	
		dtValDate = F_Plus_Date ( dtValDate, Long ( Left ( sVal, Len ( sVal ) -1 ) ), Right ( sVal, 1 ) )
		sVal = String ( dtValDate, "DD/MM/YYYY" )
		sVal = Left ( sVal, 2 ) + " " + F_Mois_En_Lettre ( Long ( Mid ( sVal, 4, 2 )) ) + " " + Right ( sVal, 4 )
		If Left ( sVal, 1 ) = "0" Then sVal = Right ( sVal, Len ( sVal ) - 1 )
		
		iuoLibelle.Uf_SetValue ( "FINVAL", sVal  )
	Else 
		iuoLibelle.Uf_SetValue ( "FINVAL", "" )
	End If
End If
// /#20

// [WEBSIM2].[FRANCE]
// Si l'utilisateur demande une regénération de mdp pour la boutique OU 
// ( qu'une cmde Web a été passée ET Aucun mdp n'a encore été généré ) ALORS
// On génére un nouveau mdp
sRetTrtMdp = This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "TRAITEMENT" )
If sPos = "" And sRetTrtMdp = "0" Then 
	iuoLibelle.Uf_SetValue ( "ZVAR04", "" )
	sPos = "ALT_BLOC"
Else
	// #20 Armement du mdp donnant accès au site 
	sVal = This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "RETOURNER" )
	If IsNull ( sVal ) Then sVal = ""
	iuoLibelle.Uf_SetValue ( "ZVAR04", sVal )
End If

// #20 Armement de l'URL donnant accès au site
sRetTrtMdp = ""
sVal = This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "PRESENCE_CMDE_WEB" )
sVal2 = This.uf_Gestion_Mdp_Extranet_Cmde_Boutique ( "RETOURNER" )

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 81 )
If lDeb > 0 Then
	sRech = "( COD_ETAT IN ( 'CNV', 'CWE') AND ID_FOUR = 'WBB' ) "
	lRow = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())
	
	If lRow > 0 Then
		lDeb = idw_DetPro.Find ( "ID_CODE_NUM = " + String ( idw_LstwCommande.GetItemNumber ( lRow,"ID_GTI" ) ) , lDeb, lFin )
	Else 
		lDeb = 0
	End If
End If									
If sPos = "" And sRetTrtMdp = "0" Then 
	sPos = "ALT_BLOC"
	stMessage.sTitre		= "Problème de paramètrage"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "WSIN692" // [WEBSIM2] à Créer !
	If bAltEdit Then F_Message ( stMessage )
End If

// Armement de la date d'expiration du mdp
// Attention j'utilise le lDEB précédemment armé avec l'opt 80
If sPos = "" And lDeb > 0 Then
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'mdp_net_boutique'", 1,  idw_WDivSin.RowCount () )
	If lRow > 0 Then
		dtValDate = Date ( idw_WDivSin.GetItemDateTime ( lRow, "MAJ_LE" ) )
		sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DUR_VAL_PRSWB", ";")	
		sVal2 = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "UNIT_DUR_VAL", ";")	
		dtValDate = F_Plus_Date ( dtValDate, Long ( sVal ), sVal2 )
		sVal = String ( dtValDate, "DD/MM/YYYY" )
		sVal = Left ( sVal, 2 ) + " " + F_Mois_En_Lettre ( Long ( Mid ( sVal, 4, 2 )) ) + " " + Right ( sVal, 4 )
		If Left ( sVal, 1 ) = "0" Then sVal = Right ( sVal, Len ( sVal ) - 1 )
		
		iuoLibelle.Uf_SetValue ( "ZVAR49", sVal  )
	Else 
		iuoLibelle.Uf_SetValue ( "ZVAR49", "" )
	End If
End If
// /#20
// :[WEBSIM2].[FRANCE]

/*------------------------------------------------------------------*/
/* #5 : JFF le 02/01/04                                             */
/*------------------------------------------------------------------*/
	/*------------------------------------------------------------------*/
	/* Récupération des données stockées sur disque pour construire     */
	/* ZVAR14 et ZVAR15																  */
	/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #14. DCMP-060643                                                 */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/	
//	sRepWin = stGlb.sWinDir + "\TEMP\"
	sFic	  = stGLB.sRepTempo + "ZV1415.TXT"
   sVal = ""
	sZVAR14 = ""
	sZVAR15 = ""
	sZVAR18 = ""
	sZVAR19 = ""
	iCpt = 1	

//Migration PB8-WYNIWYG-03/2006 FM
//	If FileExists ( sFic ) Then
	If f_FileExists ( sFic ) Then
//Fin Migration PB8-WYNIWYG-03/2006 FM
		iFic = FileOpen ( sFic, LineMode!, Read!, LockRead!, Replace! )
		Do While FileRead ( iFic, sVal ) <> -100
			sVarTmpPI052 = ""
			
			sVal = Upper ( sVal )
			sVarTmpPI052 = sVal 		// [PI052]
						
			IF Mod ( iCpt, 2 ) <> 0 Then
				sZVAR14 += sVal + Char (11)
			Else
				sZVAR15 += sVal + Char (11)
			End If
			
			sZVAR18 += sVal + Char (11)
			sZVAR19 += "q" + Char (11)

			// [PI052]
			Choose Case iCpt
				Case 1
					iUoLibelle.Uf_SetValue ( "ZVAS15" , sVarTmpPI052 )
				Case 2
					iUoLibelle.Uf_SetValue ( "ZVAS16" , sVarTmpPI052 )					
				Case 3
					iUoLibelle.Uf_SetValue ( "ZVAS17" , sVarTmpPI052 )										
				Case 4
					iUoLibelle.Uf_SetValue ( "ZVAS18" , sVarTmpPI052 )															
				Case Else
					// Pas d'action
			
			End Choose
			
			iCpt ++
		Loop
		FileClose ( iFic )	

		sZVAR14 = Left( sZVAR14, Len ( sZVAR14 ) - 1 )
		sZVAR15 = Left( sZVAR15, Len ( sZVAR15 ) - 1 )
		sZVAR18 = Left( sZVAR18, Len ( sZVAR18 ) - 1 )
		sZVAR19 = Left( sZVAR19, Len ( sZVAR19 ) - 1 )

		If This.ibPI052_GenEdtKsl2 Then sZVAR14 = ""
		iUoLibelle.Uf_SetValue ( "ZVAR14" , sZVAR14 )  // Affichage des mobiles partie gauche

		If This.ibPI052_GenEdtKsl2 Then sZVAR15 = ""		
		iUoLibelle.Uf_SetValue ( "ZVAR15" , sZVAR15 )  // Affichage des mobiles partie Droite

		If This.ibPI052_GenEdtKsl2 Then sZVAR18 = ""
		iUoLibelle.Uf_SetValue ( "ZVAR18" , sZVAR18 )  // Affichage des mobiles sur coupon réponse

		If This.ibPI052_GenEdtKsl2 Then sZVAR19 = ""		
		iUoLibelle.Uf_SetValue ( "ZVAR19" , sZVAR19 )  // Affichage des puces pour le coupon réponses

	End If

/*------------------------------------------------------------------*/
/* #8 : Armement de la signature.                                   */
/*------------------------------------------------------------------*/
	If ibSaisieValidation Then
		iUoLibelle.Uf_SetValue ( "ZVAR21" , isFicSig )  
	End If

/*------------------------------------------------------------------*/
/* #10 : Numéro de carte formaté												  */
/*------------------------------------------------------------------*/
	Choose Case idw_Produit.GetItemString ( 1, "COD_ADH" )
		Case "3", "4"
			sVal = idw_Wsin.GetItemString ( 1, "ID_ADH" )
			If Len ( sVal ) = 16 Then
				sVal = Mid ( sVal, 7, 9 )
			Else 
				sVal = ""
			End IF			

			iUoLibelle.Uf_SetValue ( "ZVAR23" , sVal )  
		Case Else
			sVal = ""
			iUoLibelle.Uf_SetValue ( "ZVAR23" , sVal )  
	
	End Choose 

// #21
lRow = idw_wDivSin.Find ( "Upper (NOM_ZONE) = 'TYPE_APP'", 1, idw_wDivSin.RowCount () ) 
If lRow >0 Then 
	sVal = Upper ( idw_wDivSin.GetItemString ( lRow, "VAL_LST_CAR" ) )

	//* #24 [FNAC_PROD_ECH_TECH]
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 106 )
	If lDeb > 0 Then
		lRow = idw_DetPro.Find ( "ID_TYP_CALC = '-AR' AND ID_CODE_CAR = '" + sVal + "'", lDeb, lFin )
		If lRow > 0 Then
			sVal2 = idw_DetPro.GetItemString ( lRow, "VAL_CAR")
			iUoLibelle.Uf_SetValue ( "ZVAR37" ,  sVal2 )  			
		End If
	End If
	//* :#24 [FNAC_PROD_ECH_TECH]	
	
	idw_wDivSin.Getchild ( "VAL_LST_CAR", dwChild )
	
	sFiltreOrig = dwChild.Describe ("DataWindow.Table.filter") 
	If sFiltreOrig = "?" Then sFiltreOrig = ""
	dwChild.Setfilter ( "" )
	
	lRow = dwChild.Find ( "ID_CODE = '" + sVal + "' AND UPPER (NOM_ZONE) = 'TYPE_APP'", 1, dwChild.Rowcount () )
	
	If lRow > 0 Then
		sVal = dwChild.GetItemString ( lRow, "LIB_CODE" )
	Else 
		sVal = ""
	End If
	
	If IsNull ( sVal ) Then sVal = ""
	iUoLibelle.Uf_SetValue ( "ZVAR33" , sVal )  
	
	dwChild.Setfilter ( sFiltreOrig )
	dwChild.Sort () 
End If
// :21

// #22 [DCMP080111]
// N° de Panier
sVal = uf_gestong_divers_trouver("NUM_PANIER" )
if Not lnvPFCString.of_IsEmpty(sVal) Then
	iUoLibelle.Uf_SetValue ( "ZVAR35" , sVal )  
End If

// SKU Identifiant de l'appareil
sVal = uf_gestong_divers_trouver("SKU_IDENT_APPAREIL" )
if Not lnvPFCString.of_IsEmpty(sVal) Then
	iUoLibelle.Uf_SetValue ( "ZVAR36" , sVal )
End If

// N° de Serie => Voir ZVAR08
// DAte d'Achat
sVal = string(uf_Lire_Date_Achat(), "dd/mm/yyyy" ) 
if sVal = "01/01/1900" then sval = "!!!!! PLUSIEURS DATE D'ACHAT OU DATE ACHAT NON SAISIE !!!!!"
iuoLibelle.Uf_SetValue ( "ZVAR38", sVal )
//

// #23 [DCMP080469]
lIdGrp	= idw_produit.GetItemNumber ( 1, "ID_GRP" )
sVal = Space ( 35 )
itrTrans.IM_S01_GROUPE ( lIdGrp, sVal )
if itrTrans.SQLCode <> 0 THen
	sVal = "!!!!! LECTURE LIBELLE CONTRACTANT PRINCIPAL IMPOSSIBLE !!!!!"
End if
iuoLibelle.Uf_SetValue ( "ZVAR39", sVal )


// #27 [FNAC_PROD_ECH_TECH].[20090401150850217]
This.Uf_Determiner_Data_Propo_Appareil ( sVal )
iuoLibelle.Uf_SetValue ( "ZVAR44", sVal )
// :#27 [FNAC_PROD_ECH_TECH].[20090401150850217]

// #28 [DCMP090247]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 84 )
If lDeb > 0 Then
	sVal = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR") )
	iUoLibelle.Uf_SetValue ( "ZVAR45" ,  sVal )  			
End if	
// #28 [DCMP090247] - Fin

// #29 [ATLAS].Courrier
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 119)
If lDeb > 0 Then
	sVal = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR") )
	sVal2 = lnvPFCString.of_getkeyvalue (sVal, "URL_ATLAS", ";")
	iUoLibelle.Uf_SetValue ( "ZVAR46" ,  sVal2 )  			
	sVal2 = lnvPFCString.of_getkeyvalue (sVal, "EMAIL", ";")
	iUoLibelle.Uf_SetValue ( "ZVAR47" ,  sVal2 )  			
End if	
// #29 [ATLAS].Courrier - Fin

// [DCMP100400]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 136)
If lDeb > 0 Then
	sVal = Trim ( idw_DetPro.GetItemString ( lDeb, "VAL_CAR") )
	sVal2 = lnvPFCString.of_getkeyvalue (sVal, "ADR_MAIL_PROD", ";")
	iUoLibelle.Uf_SetValue ( "ZVAR51" ,  sVal2 )  			
End if	
// Fin [DCMP100400]

// [ADRESSE_O2M]
// [VDOC9057]
lnvCmdCommun.uf_GetAdresseO2M_2 ( &
	"", &
	"", &
	0, &
	"",&
	"",&
	"",&
	0,&
	"",&
	"",&
	idw_LstwCommande,&
	idw_wDivSin,&
	idw_DetPro,& 
	lIdProd,&
	sNomLigne1,&
	sNomLigne2,& 
	sAdrLigne1,& 
	sAdrLigne2,&
	sCP,&
	sVille )
	
	
sVal2 = ""
sVarTmpPI052 = ""
If Not IsNull ( sNomLigne1 ) And Len ( sNomLigne1 ) > 0 Then 
	// [PI052]
	sVarTmpPI052 = sNomLigne1 
	sVal2 += sVarTmpPI052 + Char (11)
	iUoLibelle.Uf_SetValue ( "ZVAR78", sVarTmpPI052 )	
End If

sVarTmpPI052 = ""
If Not IsNull ( sNomLigne2 ) And Len ( sNomLigne2 ) > 0 Then 
	// [PI052]
	sVarTmpPI052 = sNomLigne2 
	sVal2 += sVarTmpPI052 + Char (11)
	iUoLibelle.Uf_SetValue ( "ZVAR79", sVarTmpPI052 )		
End If 

sVarTmpPI052 = ""
If Not IsNull ( sAdrLigne1 ) And Len ( sAdrLigne1 ) > 0 Then 
	// [PI052]
	sVarTmpPI052 = sAdrLigne1 
	sVal2 += sVarTmpPI052 + Char (11)
	iUoLibelle.Uf_SetValue ( "ZVAR80", sVarTmpPI052 )			
End If

sVarTmpPI052 = ""
If Not IsNull ( sAdrLigne2 ) And Len ( sAdrLigne2 ) > 0 Then 
	// [PI052]
	sVarTmpPI052 = sAdrLigne2 
	sVal2 += sVarTmpPI052 + Char (11)
	iUoLibelle.Uf_SetValue ( "ZVAR81", sVarTmpPI052 )				
End IF

sVarTmpPI052 = ""
If Not IsNull ( sCP ) And Len ( sCP ) > 0 Then 
	// [PI052]
	sVarTmpPI052 = sCP 
	sVal2 += sVarTmpPI052 
End If

If Not IsNull ( sVille ) And Len ( sVille ) > 0 Then 
	// [PI052]
	sVarTmpPI052 += " " + sVille
	sVal2 += " " + sVille + Char (11)
	iUoLibelle.Uf_SetValue ( "ZVAR82", sVarTmpPI052 )					
End If

If This.ibPI052_GenEdtKsl2 Then sVal2 = ""
iUoLibelle.Uf_SetValue ( "ZVAR50" ,  sVal2 )  			
// :[ADRESSE_O2M]

// [PC363_AUC].[VAR_WD_MAT_REMP_O2M]
idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ()
lRow = idw_LstwCommande.Find ( "ID_FOUR = 'O2M' AND COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'MARQUE_REMPL', 1) > 0", 1, idw_LstwCommande.RowCount ())
If lRow > 0 Then
	sVal = idw_LstwCommande.GetItemString ( lRow, "INFO_FRN_SPB_CPLT" )
	sVal2 = lnvPFCString.of_getkeyvalue ( sVal, "MARQUE_REMPL", ";")	
	If IsNull ( sVal2 ) Then sVal2 = ""
	
	sVal3 = lnvPFCString.of_getkeyvalue ( sVal, "MODELE_REMPL", ";")	
	If IsNull ( sVal3 ) Then sVal3 = ""
	
	sVal2 += " " + sVal3
	iUoLibelle.Uf_SetValue ( "ZVAR55" ,  sVal2 )  			
	
End If
// [PC363_AUC].[VAR_WD_MAT_REMP_O2M]

// [PR10-Lot1]
idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ()

lRow = idw_LstwCommande.Find ( "ID_FOUR = 'GAM' AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount ())
If lRow > 0 Then
	sVal = idw_LstwCommande.GetItemString ( lRow, "INFO_FRN_SPB_CPLT" )
	
	sVal2 = lnvPFCString.of_getkeyvalue ( sVal, "NO_BON", ";")	
	If IsNull ( sVal2 ) Then 
		sVal2 = ""
	Else
		if RightA(sVal2,1) = "]" Then sVal2=LeftA(sVal2, LenA(sVal2) -1)
	End if
	
	iUoLibelle.Uf_SetValue ( "ZVAR56" ,  sVal2 )  			
	
End If
// :[PR10-Lot1]

// [PM200][PSM]
idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ()

lRow = idw_LstwCommande.Find ( "ID_FOUR = 'PSM' AND COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount ())
If lRow > 0 Then
	sVal = idw_LstwCommande.GetItemString ( lRow, "INFO_SPB_FRN_CPLT" )
	sVal2 = lnvPFCString.of_getkeyvalue ( sVal, "CODE_BTQ_PSM_CENTRALE", ";")	

	snomligne1=Space(35)
	snomligne2=Space(35)
	sadrligne1=Space(40)
	sadrligne2=Space(40)
	scp=Space(35)
	sville=Space(35)
	
	lIdBoutique= Long ( lnvPFCString.of_getkeyvalue (sVal, "CODE_BTQ_PSM_CENTRALE", ";") )
	SQLCA.PS_S_adresse_centrale_psm( lIdSin, String(lIdBoutique), 'SEL_BOUTIQUE', snomligne1, snomligne2, sadrligne1, sadrligne2, scp, sville)

	sVarTmpPI052 = ""
	If (not isnull(sNomLigne1)) and  len(trim(sNomLigne1)) > 0 Then 
		// [PI052]
		sVarTmpPI052 = sNomLigne1 
		sVal = sVarTmpPI052 
	End If
	
	If (not isnull(sNomLigne2)) and  len(trim(sNomLigne2)) > 0 Then 
		// [PI052]
		sVarTmpPI052 += " " + sNomLigne2 
		sVal+= " " + sNomLigne2 
		iUoLibelle.Uf_SetValue ( "ZVAR83", sVarTmpPI052 )								
	End If
	sVal = sVal + Char ( 11 )

	sVarTmpPI052 = ""	
	If (not isnull(sAdrLigne1)) and  len(trim(sAdrLigne1)) > 0 Then 
		sVarTmpPI052 = sAdrLigne1
		sVal += sVarTmpPI052 
	End IF	
	
	If (not isnull(sAdrLigne2)) and  len(trim(sAdrLigne2)) > 0 Then 
		sVarTmpPI052 += " " + sAdrLigne2
		sVal += " " + sAdrLigne2
		iUoLibelle.Uf_SetValue ( "ZVAR84", sVarTmpPI052 )										
	End If
	sVal = sVal + Char ( 11 )

	sVarTmpPI052 = ""	
	If (not isnull(sCp)) and  len(trim(sCp)) > 0 Then 
		sVarTmpPI052 = sCp 
		sVal += sVarTmpPI052 
	End If
	
	If (not isnull(sVille)) and  len(trim(sVille)) > 0 Then 
		sVarTmpPI052 += " " + sVille
		sVal += " " + sVille
	End If

	iUoLibelle.Uf_SetValue ( "ZVAR85", sVarTmpPI052 )											

	If This.ibPI052_GenEdtKsl2 Then sVal = ""
	iUoLibelle.Uf_SetValue ( "ZVAR57" ,  sVal )
	
	
// [PM200_LOT3_V3]
	iUoLibelle.Uf_SetValue ( "ZVAR61" , "adapté à la taille de celui-ci, à l'adresse suivante : " )  					
		
	sVal = idw_LstwCommande.GetItemString ( lRow, "INFO_SPB_FRN_CPLT" )
	sVal2 = lnvPFCString.of_getkeyvalue ( sVal, "CODE_BTQ_PSM_PROXIMITE", ";")	

	If Len ( Trim ( sVal2 ) ) > 0  Then
	 // J'enlève le premier #
	 sVal2 = RIGHT ( sVal2, Len ( sVal2 ) -1 )
	End If

	sVal = ""
	iCpt = 1
	Do While Len ( Trim ( sVal2 ) ) > 0
		iPos = Pos ( sVal2, "#", 1 ) 
		If iPos = 0 Then Exit
		
		lIdBoutique = Long ( Mid ( sVal2, 1, iPos -1 ))
		sVal2 = RIGHT ( sVal2, Len ( sVal2 ) - iPos )

		snomligne1=Space(35)
		snomligne2=Space(35)
		sadrligne1=Space(40)
		sadrligne2=Space(40)
		scp=Space(35)
		sville=Space(35)

		SQLCA.PS_S_adresse_centrale_psm( lIdSin, String(lIdBoutique), 'SEL_BOUTIQUE', snomligne1, snomligne2, sadrligne1, sadrligne2, scp, sville)

		If (not isnull(sNomLigne1)) and  len(trim(sNomLigne1)) > 0 Then sVar1 = sNomLigne1
		If (not isnull(sNomLigne2)) and  len(trim(sNomLigne2)) > 0 Then sVar1+= " " + sNomLigne2 

		If (not isnull(sAdrLigne1)) and  len(trim(sAdrLigne1)) > 0 Then sVar2 =sAdrLigne1
		If (not isnull(sAdrLigne2)) and  len(trim(sAdrLigne2)) > 0 Then sVar2+= " " + sAdrLigne2
	
		If (not isnull(sCp)) and  len(trim(sCp)) > 0 Then sVar3 =sCp 
		If (not isnull(sVille)) and  len(trim(sVille)) > 0 Then sVar3 += " " + sVille

	// [PM200_LOT3_V3]
		If iCpt = 1 Then
			iUoLibelle.Uf_SetValue ( "ZVAR61" ,  "à l’adresse du « Point Service Mobiles » proche de chez vous soit " + sNomLigne1 )
			
			// [PI052]
			iUoLibelle.Uf_SetValue ( "ZVAR86", sVar1 )
			iUoLibelle.Uf_SetValue ( "ZVAR87", sVar2 )
			iUoLibelle.Uf_SetValue ( "ZVAR88", sVar3 )
			
		End If

		If iCpt > 1 Then
			sVal = sVal + Char ( 11 ) + Char ( 11 )
			
			// [PI052]
			iUoLibelle.Uf_SetValue ( "ZVAR89", sVar1 )
			iUoLibelle.Uf_SetValue ( "ZVAR90", sVar2 )
			iUoLibelle.Uf_SetValue ( "ZVAR91", sVar3 )
			
		End If
		sVal = sVal + sVar1 + Char ( 11 ) + sVar2 + Char ( 11 ) + sVar3
		iCpt ++
	Loop
	sVal = sVal + Char ( 11 )

	If This.ibPI052_GenEdtKsl2 Then sVal = ""	
	iUoLibelle.Uf_SetValue ( "ZVAR58" ,  sVal )

	// [PM200][PSM][MANTIS2745]
	If iCpt = 2  Then // Deux mais en fait c'est 1 boutique
		sVal = "L'adresse du << Point Service Mobiles >> le plus proche de chez vous est :"
		iUoLibelle.Uf_SetValue ( "ZVAR59" ,  sVal )  			
	End If 

	If iCpt > 2 Then
		sVal = "L'adresse des " + String ( iCpt - 1 ) + " << Point Service Mobiles >> les plus proches de chez vous sont :"
		iUoLibelle.Uf_SetValue ( "ZVAR59" ,  sVal )  						
	End If
	// [PM200][PSM][MANTIS2745]

End If
// [PM200][PSM]

// [VDoc9286] ZVAR60
dcMtValAchat=0

lRow=idw_wdetail.Find("COD_ETAT in (100,500,550,600)",1, idw_wdetail.RowCount())

Do While lRow > 0
	dcMtValAchatTmp=idw_wdetail.GetItemDecimal(lRow, "MT_VAL_ACHAT") 

	If dcMtValAchatTmp > 0 and dcMtValAchatTmp <> 9999 and dcMtValAchatTmp > dcMtValAchat Then dcMtValAchat=dcMtValAchatTmp
		
	If lRow = idw_wdetail.RowCount() Then
		lRow=-1
	Else
		lRow=idw_wdetail.Find("COD_ETAT in (100,500,550,600)",lRow+1, idw_wdetail.RowCount())
	End if

Loop

iUoLibelle.Uf_SetValue ( "ZVAR60" ,  String(dcMtValAchat,"0.00" ) ) 
// :[VDoc9286] 

// 	[VDoc10098] ZVAR62
// S'il y a un diag, on prend le montant de frais assuré depuis la 95.
// S'il y a une réparation, on prend le montant de frais assuré depuis la 76.
sVal=""

lRow=idw_lstwcommande.Find("ID_TYP_ART='PRS' and COD_ETAT <> 'ANN'",1,idw_lstwcommande.RowCount())
if lRow > 0 Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, lIdProd, '-DP', 76 )
	If lDeb > 0 Then 
		sVal=String(idw_DetPro.Getitemdecimal( lDeb, "VAL_NUM"),"0.00")
	End If 
Else
	lRow=idw_lstwcommande.Find("ID_REF_FOUR='A_DIAGNOSTIQUER' and COD_ETAT <> 'ANN'",1,idw_lstwcommande.RowCount())
	if lRow > 0 Then
		sTypApp="-1"
		
		lDeb=idw_wdivsin.find("Upper(nom_zone)='TYPE_APP'",1,idw_wdivsin.RowCount())
		if lDeb > 0 Then sTypApp = idw_wdivsin.GetItemString(lDeb,"VAL_CAR")
		
		lKey[1].iskeyname = "TYP_APP"
		lKey[1].iakeyvalue = sTypApp
		lKey[2].iskeyname = "ACTION"
		lKey[2].iakeyvalue = "A_DIAGNOSTIQUER"
		lKey[3].iskeyname = "MT_FRAIS"
		F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 95, lKey )
		If lDeb > 0 And lRow > 0 Then 
			if not isnull(lKey[3].iakeyvalue) And Trim ( lKey[3].iakeyvalue ) <> "" Then sVal = lKey[3].iakeyvalue
		End if
	End if
End if

iUoLibelle.Uf_SetValue ( "ZVAR62" ,  sVal ) 

// :[VDoc10098] ZVAR62

// [PC938_ORANGE_V3]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
If lDeb > 0 Then
	lRow = idw_lstwcommande.Find ( "ID_TYP_ART NOT IN ( 'PRS', 'EDI', 'REL')", 1, idw_lstwcommande.RowCount())
	
	If lRow > 0 Then
		sVal = idw_lstwcommande.Describe ( "Evaluate ( 'LookUpDisplay ( ADR_COD_CIV )', 1 ) " ) 
		
		// [VDOC15104]
		sVal += " " + &
				 F_GetItem3 ( idw_lstwcommande, 1, "ADR_NOM" ) + " " + &
				 F_GetItem3 ( idw_lstwcommande, 1, "ADR_PRENOM" )	+ Char (11) + &
				 F_GetItem3 ( idw_lstwcommande, 1, "ADR_LIVR1" ) + Char (11) + &
				 F_GetItem3 ( idw_lstwcommande, 1, "ADR_LIVR2" ) + Char (11) + &
				 F_GetItem3 ( idw_lstwcommande, 1, "ADR_LIVR_CPL" ) + Char (11) + &
				 F_GetItem3 ( idw_lstwcommande, 1, "ADR_CP" ) + " " + &
				 F_GetItem3 ( idw_lstwcommande, 1, "ADR_VILLE" ) 
		
		// [PI052]
		iUoLibelle.Uf_SetValue ( "ZVAR92" ,  F_GetItem3 ( idw_lstwcommande, 1, "ADR_NOM" ) )
		iUoLibelle.Uf_SetValue ( "ZVAR93" ,  F_GetItem3 ( idw_lstwcommande, 1, "ADR_PRENOM" ) )
		iUoLibelle.Uf_SetValue ( "ZVAR94" ,  F_GetItem3 ( idw_lstwcommande, 1, "ADR_LIVR1" ) )
		iUoLibelle.Uf_SetValue ( "ZVAR95" ,  F_GetItem3 ( idw_lstwcommande, 1, "ADR_LIVR2" ) )		
		iUoLibelle.Uf_SetValue ( "ZVAR96" ,  F_GetItem3 ( idw_lstwcommande, 1, "ADR_LIVR_CPL" ) )				
		iUoLibelle.Uf_SetValue ( "ZVAR97" ,  F_GetItem3 ( idw_lstwcommande, 1, "ADR_CP" ) )						
		iUoLibelle.Uf_SetValue ( "ZVAR98" ,  F_GetItem3 ( idw_lstwcommande, 1, "ADR_VILLE" ) )								

		If This.ibPI052_GenEdtKsl2 Then sVal = ""
		iUoLibelle.Uf_SetValue ( "ZVAR63" ,  sVal ) 						 				 
				 
	End If 

	sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "MT_VAL_PUBLIQUE" ) )
	If IsNull ( sVal ) Then sVal = ""
	iUoLibelle.Uf_SetValue ( "ZVAR64" ,  sVal )
End If
// [PC938_ORANGE_V3]

// [PC954]
sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "CODE_EAN" ) )
If IsNull ( sVal ) Then sVal = ""
iUoLibelle.Uf_SetValue ( "ZVAR65" ,  sVal )

sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "NUM_BON_VENTE" ) )
If IsNull ( sVal ) Then sVal = ""
iUoLibelle.Uf_SetValue ( "ZVAR66" ,  sVal )

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
If not isnull( idw_wSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )) Then
	sVal = String ( idw_wSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) )	
	lRow = dwChild.Find ( "ID_BOUTIQUE = " + sVal, 1, dwChild.RowCount () )
	If lRow > 0 Then
		sVal = dwChild.GetItemString ( lRow, "ADR_TEL" )
		If IsNull ( sVal ) Then sVal = ""
		iUoLibelle.Uf_SetValue ( "ZVAR67" ,  sVal )

		sVal = dwChild.GetItemString ( lRow, "ADR_FAX" )
		If IsNull ( sVal ) Then sVal = ""
		iUoLibelle.Uf_SetValue ( "ZVAR68" ,  sVal )
	End if
End if
// :[PC954]

idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ()

// [VDOC13497]
sVarTmpPI052 = ""
// [PI052]
sVarTmpPI052 = "ADAR" 
sVal  = sVarTmpPI052 + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAR99", sVarTmpPI052 )

sVarTmpPI052 = "Générale Télécom Services"
sVal += sVarTmpPI052  + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAS01", sVarTmpPI052 )

sVarTmpPI052 = "SAV"
sVal += sVarTmpPI052 + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAS02", sVarTmpPI052 )

sVarTmpPI052 = "15, Allée Jean Jaurès"
sVal += sVarTmpPI052  + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAS03", sVarTmpPI052 )

sVarTmpPI052 = "31000 TOULOUSE - France"
sVal += sVarTmpPI052 
iUoLibelle.Uf_SetValue ( "ZVAS04", sVarTmpPI052 )

If This.ibPI052_GenEdtKsl2 Then sVal = ""
iUoLibelle.Uf_SetValue ( "ZVAR69" ,  sVal )
// [VDOC13497]

// [PC925]
sVarTmpPI052 = ""
// [PI052]
sVarTmpPI052 = "SAV ASSURANCES SRR" 
sVal  = sVarTmpPI052 + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAS05", sVarTmpPI052 )

sVarTmpPI052 = "SPB"
sVal += sVarTmpPI052 + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAS06", sVarTmpPI052 )

sVarTmpPI052 = "CS 91083" 
sVal += sVarTmpPI052 + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAS07", sVarTmpPI052 )

sVarTmpPI052 = "97404 SAINT DENIS CEDEX"
sVal += sVarTmpPI052 

iUoLibelle.Uf_SetValue ( "ZVAS08", sVarTmpPI052 )

If This.ibPI052_GenEdtKsl2 Then sVal = ""
iUoLibelle.Uf_SetValue ( "ZVAR70" ,  sVal )
// :[PC925]

// [PM255]
sVarTmpPI052 = ""
// [PI052]

sVarTmpPI052 = gsAdrNomPickUp 
sVal = sVarTmpPI052 + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAS09", sVarTmpPI052 )

sVarTmpPI052 = gsAdrPreNomPickUp 
sVal += sVarTmpPI052 + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAS10", sVarTmpPI052 )	

sVarTmpPI052 = gsAdr1PickUp 
sVal += sVarTmpPI052 + Char ( 11 ) 
iUoLibelle.Uf_SetValue ( "ZVAS11", sVarTmpPI052 )

If Len ( Trim ( gsAdr2PickUp ) ) > 0 And Not IsNull ( gsAdr2PickUp ) Then
	sVarTmpPI052 = gsAdr2PickUp 
	sVal += sVarTmpPI052 + Char ( 11 ) 
	iUoLibelle.Uf_SetValue ( "ZVAS12", sVarTmpPI052 )		
End If

If Len ( Trim ( gsAdrCpltPickUp ) ) > 0 And Not IsNull ( gsAdrCpltPickUp ) Then
	sVarTmpPI052 = gsAdrCpltPickUp 
	sVal += sVarTmpPI052 + Char ( 11 ) 
	iUoLibelle.Uf_SetValue ( "ZVAS13", sVarTmpPI052 )				
End If

sVarTmpPI052 = gsAdrCpPickUp + " "+ gsAdrVillePickUp 
sVal += sVarTmpPI052 
iUoLibelle.Uf_SetValue ( "ZVAS14", sVarTmpPI052 )

If This.ibPI052_GenEdtKsl2 Then sVal = ""
iUoLibelle.Uf_SetValue ( "ZVAR71" ,  sVal )

iUoLibelle.Uf_SetValue ( "ZVAR72" ,  gsHorairePickUp )

iUoLibelle.Uf_SetValue ( "ZVAR73" ,  gsCodePickUp )


// [VDOC17436]
sVal = idw_wSin.Describe ( "Evaluate ( 'LookUpDisplay ( ID_DETSIN )', 1 ) " )
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 277 )
If lDeb > 0 Then
	lRow = idw_DetPro.Find ( "ID_TYP_CALC = '+DT' AND ID_CODE_NUM = " + String(idw_wsin.GetItemNumber(1,"ID_DETSIN")) + "", lDeb, lFin )
	If lRow > 0 Then
		sVal = idw_DetPro.GetItemString ( lRow, "VAL_CAR")			
	End If
End If
iUoLibelle.Uf_SetValue ( "ZVAS19" ,  sVal )  
// :[VDOC17436]


// [PC694-4] // [PC151425]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 291 )
If lDeb > 0 Then
	sVal =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "URL_PAYBOX", ";") 
	sVal = F_Remplace ( sVal, "#ID_SIN#", String ( lIdSin ) )
	iuoLibelle.Uf_SetValue ( "ZVAS20", sVal )
End If

// [PM280-2]
// [DT288-3_LOT1][PM280]
lRow = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR IN ( 'O2M' ) AND ( ( ID_REF_FOUR = 'A_REPARER' AND POS ( INFO_SPB_FRN_CPLT, 'A_REP_GARANTIE=OUI' ) > 0) OR ID_REF_FOUR = 'CONTEST_SUR_REMPL' ) ", 1, idw_LstwCommande.RowCount () )	

// [DT288-3_LOT1][PM280]
If lRow > 0 Then
	idw_LstwCommande.SetFilter ( &
		"ID_FOUR IN ( 'O2M' ) AND " + &
		"COD_ETAT <> 'ANN' AND " + &
		"( ID_TYP_ART NOT IN ( 'DEV', 'AEF', 'CAS', 'SMS', 'BAM', 'ALE', 'ACC', 'PCM', 'MAI', 'REL', 'PST', 'RES', 'REA', 'PRS', 'EDI', 'RST' ) " + &
		"  OR " + &
		"  ( ID_TYP_ART = 'RST' AND POS ( INFO_SPB_FRN_CPLT, 'RST_CMDE+SUIVI=OUI' ) > 0 ) " + &
		") " + &
		" AND STATUS_GC NOT IN ( 176, 239, 203 )" )
	
	idw_LstwCommande.Filter ()
	idw_LstwCommande.sort ()
	
	If idw_LstwCommande.RowCount () > 0 Then
		
		// [VDOC19876]
		IF idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" ) = "RST" Then
			iUoLibelle.Uf_SetValue ( "ZVAS21", idw_Wsin.GetItemString ( 1, "MARQ_PORT" ) + " " + idw_Wsin.GetItemString ( 1, "MODL_PORT" )  )
		Else
			iUoLibelle.Uf_SetValue ( "ZVAS21", idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) + " " + idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) )
		End If
		// [PC301].[LOT2]		
	End If 
End If 

// [DT247]
lRow = idw_Plafond.Find ( "ID_TYP_PLAF = '748'", 1, idw_Plafond.RowCount ())
If lRow > 0 Then
	sChaine = Space ( 100 )
	SQLCA.PS_S_W_GTI_NBSIN_RESIL_ADH_DATA ( lIdSin, lIdProd, lIdEts, sIdAdh, dtDteSurv, sChaine)
End If	

sVal = lnvPFCString.of_getkeyvalue( sChaine, "DTE_SURV", ";")
If IsDate ( sVal ) Then iUoLibelle.Uf_SetValue ( "ZVAS22", sVal )

sVal = lnvPFCString.of_getkeyvalue( sChaine, "DTE_DECL", ";")
If IsDate ( sVal ) Then iUoLibelle.Uf_SetValue ( "ZVAS23", sVal )
// :[DT247]

// [DT176] NDC V3
lRow=idw_LstwCommande.Find("ID_FOUR='CMA' and MT_TTC_CMDE > 1000",1,idw_LstwCommande.RowCount()) // [DT339] passage de 1250 à 1000

If lRow > 0 Then

	// [RS4207]
	sVal="Avant de vous rendre en magasin, nous vous remercions de bien vouloir nous contacter au 0 970 808 91*, afin d’activer ce bon d’achat."

	iUoLibelle.Uf_SetValue ( "ZVAS24", sVal )
End if
// Fin  [DT176] NDC V3

// [PC151259]
// ZVAS25 - REP SC ADVISE NATURE
sVal=uf_getreponse_script("ZVAS25_CASSE", false)
sVal2=uf_getreponse_script("ZVAS25_PANNE", false)
sVal3=uf_getreponse_script("ZVAS25_OXY", false)

if sVal="OUI" Then sVal="1"	
if sVal2="OUI" Then sVal="2"
if sVal3="OUI" Then sVal="3"

if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS25", sVal )

// ZVAS26 - REP SC ADVISE DATE DOMMAGE
sVal=uf_getreponse_script("ZVAS26", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS26", sVal )

// ZVAS27 - REP SC ADVISE SEUL?
sVal=uf_getreponse_script("ZVAS27", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS27", sVal )

// ZVAS28 - REP SC ADVISE NOM ACCOMPAGNANT
sVal=uf_getreponse_script("ZVAS28", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS28", sVal )

// ZVAS29 - REP SC ADVISE CET ETAT RETROUVE
sVal=uf_getreponse_script("ZVAS29", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS29", sVal )

// ZVAS30 - REP SC ADVISE ORIGINE INCONNUE
sVal=uf_getreponse_script("ZVAS30", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS30", sVal )

// ZVAS31 - REP SC ADVISE EVT DOMMAGE
sVal=uf_getreponse_script("ZVAS31", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS31", sVal )

// ZVAS32 - REP SC ADVISE ECHAPPE DES MAINS
sVal=uf_getreponse_script("ZVAS32", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS32", sVal )

// ZVAS33 - REP SC ADVISE TOMBE
sVal=uf_getreponse_script("ZVAS33", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS33", sVal )

// ZVAS34 - REP SC ADVISE BOUSCULE
sVal=uf_getreponse_script("ZVAS34", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS34", sVal )

// ZVAS35 - REP SC ADVISE FONCTIONNE ENCORE
sVal=uf_getreponse_script("ZVAS35", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS35", sVal )

// ZVAS36 - REP SC ADVISE TACTILE
sVal=uf_getreponse_script("ZVAS36", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS36", sVal )

// ZVAS37 - REP SC ADVISE ETAT FONCTION
sVal=uf_getreponse_script("ZVAS37", true)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS37", sVal )

// ZVAS38 - REP SC ADVISE ETAT ECRAN
sVal=uf_getreponse_script("ZVAS38", true)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS38", sVal )

// ZVAS39 - REP SC ADVISE ETAT AFFICHAGE
sVal=uf_getreponse_script("ZVAS39", true)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS39", sVal )

// ZVAS40 - REP SC ADVISE ETAT CLAVIER
sVal=uf_getreponse_script("ZVAS40", true)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS40", sVal )

// ZVAS41 - REP SC ADVISE TOUCHES PRESENTES
sVal=uf_getreponse_script("ZVAS41", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS41", sVal )

// ZVAS42 - REP SC ADVISE ETAT FACADE
sVal=uf_getreponse_script("ZVAS42", true)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS42", sVal )

// ZVAS43 - REP SC ADVISE PRECISIONS
sVal=uf_getreponse_script("ZVAS43", False) // [ITSM448753] false ald true
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS43", sVal )

// ZVAS45 - REP SC ADVISE DEGAT EAUX
sVal=uf_getreponse_script("ZVAS45", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS45", sVal )

// ZVAS46 - REP SC ADVISE PRIS EAU
sVal=uf_getreponse_script("ZVAS46", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS46", sVal )

// ZVAS47 - REP SC ADVISE LIQUIDE RENVERSE
sVal=uf_getreponse_script("ZVAS47", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS47", sVal )

// ZVAS48 - REP SC ADVISE BATTERIE CHARGE
sVal=uf_getreponse_script("ZVAS48", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS48", sVal )

// ZVAS49 - REP SC ADVISE CONNEXIONS OK
sVal=uf_getreponse_script("ZVAS49", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS49", sVal )

// ZVAS50 - REP SC ADVISE EMETTRE APPEL OK
sVal=uf_getreponse_script("ZVAS50", true)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS50", sVal )

// ZVAS51 - REP SC ADVISE RECEVOIR APPEL OK
sVal=uf_getreponse_script("ZVAS51", true)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS51", sVal )

// [PI052] // [PC151259] // [PC151259-2] // [PC171918]
sVarTmpPI052 = ""
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN ( 'EKO', 'DGC', 'NET', 'SMT', 'RAV', 'RTP', 'SFG' )" 

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount ()

If lTotCmd = 1 Then
	sIdFour = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" ) 
	sIdSousFourn = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "SOUS_FRN", ";")
	
	If sIdSousFourn = "" Then sIdSousFourn = sIdFour
	
	sVal = Space (35) ; sNomLigne1 = Space (35) ; sAdrLigne1 = Space (35) ; sAdrLigne2 = Space (35) ; sCP = Space (35) ; sVille = Space (35)
	SQLCA.PS_S_BOUTIQUE_ADRESSE_3 ( lIdProd, sIdFour, sIdSousFourn, sVal, sNomLigne1, sAdrLigne1, sAdrLigne2, sCP, sVille) 
	
	sVarTmpPI052 = sNomLigne1 
	sVal = sVarTmpPI052 + Char ( 11 ) 
	iUoLibelle.Uf_SetValue ( "ZVAS56", sVarTmpPI052 )
	
	sVarTmpPI052 = sAdrLigne1 
	sVal += sVarTmpPI052 + Char ( 11 ) 
	iUoLibelle.Uf_SetValue ( "ZVAS57", sVarTmpPI052 )
	
	If Len ( Trim ( sAdrLigne2 ) ) > 0 And Not IsNull ( sAdrLigne2 ) Then
		sVarTmpPI052 = sAdrLigne2 
		sVal += sVarTmpPI052 + Char ( 11 ) 
		iUoLibelle.Uf_SetValue ( "ZVAS58", sVarTmpPI052 )		
	End If
	
	sVarTmpPI052 = sCP + " "+ sVille 
	sVal += sVarTmpPI052 
	iUoLibelle.Uf_SetValue ( "ZVAS59", sVarTmpPI052 )
	
	If This.ibPI052_GenEdtKsl2 Then sVal = ""
	iUoLibelle.Uf_SetValue ( "ZVAS55" ,  sVal )
End If		

idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ()

// :[PC151259]


// [DT262]
sVal = String ( dDteFinGti, "DD/MM/YYYY" )
iuoLibelle.Uf_SetValue ( "ZVAS44", sVal )

// [DT262][V3]
sZvarNbreIndem = Space ( 10 )
sZvarIndem = Space ( 8000 )
	
SQLCA.PS_S01_SINISTRE_ZVAR_DT262 ( lIdSin, sZvarNbreIndem, sZvarIndem ) 

iuoLibelle.Uf_SetValue ( "ZVAS60", sZvarNbreIndem )
iuoLibelle.Uf_SetValue ( "ZVAS61", sZvarIndem )

// [VDOC22301]
idw_LstwCommande.SetFilter ("")
idw_LstwCommande.Filter()
idw_LstwCommande.Sort()

// Données commandes de remplacement
lRow=idw_LstwCommande.Find ( &
			"COD_ETAT <> 'ANN' AND " + &
			"( ID_TYP_ART NOT IN ( 'DEV', 'AEF', 'CAS', 'SMS', 'BAM', 'ALE', 'ACC', 'PCM', 'MAI', 'REL', 'PST', 'RES', 'REA', 'PRS', 'EDI', 'RST' ) " + &
			"  OR " + &
			"( ID_TYP_ART = 'RST' AND POS ( INFO_SPB_FRN_CPLT, 'RST_CMDE+SUIVI=OUI' ) > 0 )) ", &
			1,idw_LstwCommande.RowCount())

If lRow > 0 Then
	sVal=idw_LstwCommande.GetItemString ( lRow, "ID_MARQ_ART" ) 
	iuoLibelle.Uf_SetValue ( "ZVAS52", sVal )
	
	sVal=idw_LstwCommande.GetItemString ( lRow, "ID_MODL_ART" )	
	iuoLibelle.Uf_SetValue ( "ZVAS53", sVal )
	
	dtValDate=Date(idw_LstwCommande.GetItemDateTime ( lRow, "CREE_LE" )	)
	sVal=String(dtValDate,"dd/mm/yyyy")
	iuoLibelle.Uf_SetValue ( "ZVAS54", sVal )
	
End if
// :[VDOC22301]

// [DT289]
// [VDOC26595]
// [VDOC26755]
// [DT289][VDOC26595]
sRech	=	"ID_PROD = "		+ String (lIdProd ) 			+ " AND " 	+ &
			"ID_REV = "			+ String ( lIdRev ) 			+ " AND " 	+ &
			"ID_CPT_PLAF = 0"										+ " AND " 	+ &
			"ID_TYP_PLAF = '736'"

lRow = idw_Plafond.Find ( sRech, 1, idw_Plafond.RowCount ())

If lRow > 0 Then 
	dcMtPlaf = idw_Plafond.GetItemDecimal ( lRow, "MT_PLAF" )

	sRech	=	"ID_PROD = "		+ String (lIdProd ) 			+ " AND " 	+ &
				"ID_REV = "			+ String ( lIdRev ) 			+ " AND " 	+ &
				"ID_CPT_PLAF = 0"										+ " AND " 	+ &
				"ID_TYP_PLAF = '736' " + " AND " 	+ &
				"MT_PLAF <> " + String ( dcMtPlaf )
	
	idw_Plafond.SetFilter ( sRech )
	idw_Plafond.Filter ()
	
	If idw_Plafond.RowCount () > 1 Then dcMtPlaf = 0

	idw_Plafond.SetFilter ( "" )
	idw_Plafond.Filter ()
	
	If IsNull ( dcMtPlaf ) Then dcMtPlaf = 0
	
	iuoLibelle.Uf_SetValue ( "ZVAS62", String ( dcMtPlaf ) )
End If
// :[DT289][VDOC26595]


// [VDOC26755]
sRech	=	"ID_PROD = "		+ String (lIdProd ) 			+ " AND " 	+ &
			"ID_REV = "			+ String ( lIdRev ) 			+ " AND " 	+ &
			"ID_CPT_PLAF = 0"										+ " AND " 	+ &
			"ID_TYP_PLAF = '680'"

lRow = idw_Plafond.Find ( sRech, 1, idw_Plafond.RowCount ())

If lRow > 0 Then 
	dcMtPlaf = idw_Plafond.GetItemDecimal ( lRow, "MT_PLAF" )

	sRech	=	"ID_PROD = "		+ String (lIdProd ) 			+ " AND " 	+ &
				"ID_REV = "			+ String ( lIdRev ) 			+ " AND " 	+ &
				"ID_CPT_PLAF = 0"										+ " AND " 	+ &
				"ID_TYP_PLAF = '680' " + " AND " 	+ &
				"MT_PLAF <> " + String ( dcMtPlaf )
	
	idw_Plafond.SetFilter ( sRech )
	idw_Plafond.Filter ()
	
	If idw_Plafond.RowCount () > 1 Then dcMtPlaf = 0

	idw_Plafond.SetFilter ( "" )
	idw_Plafond.Filter ()
	
	If IsNull ( dcMtPlaf ) Then dcMtPlaf = 0
	
	iuoLibelle.Uf_SetValue ( "ZVAS74", String ( dcMtPlaf ) )
End If
// :[VDOC26755]
		
// [PC171918]
// ZVAS63 - REP SC ADVISE ELEMENTS HS
sVal=uf_getreponse_script("ZVAS63", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS63", sVal )

// ZVAS64 - REP SC ADVISE DOMM ESTHETIQUE
sVal=uf_getreponse_script("ZVAS64", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS64", sVal )

// ZVAS65 - REP SC ADVISE INUTILISABLE
sVal=uf_getreponse_script("ZVAS65", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS65", sVal )

// ZVAS66 - REP SC ADVISE NIVEAU DOMMAGE
sVal=uf_getreponse_script("ZVAS66", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS66", sVal )

// ZVAS67 - REP SC ADVISE PREC DOM ESTH
sVal=uf_getreponse_script("ZVAS67", true)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS67", sVal )

// ZVAS68 - REP SC ADVISE ELT MECANIQUES
sVal=uf_getreponse_script("ZVAS68", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS68", sVal )

// ZVAS69 - REP SC ADVISE PREC ELT MECA
sVal=uf_getreponse_script("ZVAS69", true)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS69", sVal )

// ZVAS70 - ELT BON ETAT ?
sVal=uf_getreponse_script("ZVAS70", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS70", sVal )

// ZVAS71 - PIECES A CHANGER
sVal=uf_getreponse_script("ZVAS71", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS71", sVal )

// ZVAS72 - REPARABLE ?
sVal=uf_getreponse_script("ZVAS72", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS72", sVal )

// ZVAS73 - DEVIS REPAR
sVal=uf_getreponse_script("ZVAS73", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS73", sVal )

// ZVAS75 - GONDOLE
sVal=uf_getreponse_script("ZVAS75", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS75", sVal )

// ZVAS76 - NIVEAU GONDOLE
sVal=uf_getreponse_script("ZVAS76", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS76", sVal )

// ZVAS77 - ELTS OXYDES
sVal=uf_getreponse_script("ZVAS77", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS77", sVal )

// ZVAS78 - SUITE REGLAGE
sVal=uf_getreponse_script("ZVAS78", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS78", sVal )

// ZVAS79 - SUITE REPARATION
sVal=uf_getreponse_script("ZVAS79", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS79", sVal )

// ZVAS80 - SUITE SURTENSION
sVal=uf_getreponse_script("ZVAS80", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS80", sVal )

// ZVAS81 - SUITE ERR BRANCHT
sVal=uf_getreponse_script("ZVAS81", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS81", sVal )

// ZVAS82 - SUITE CHOC
sVal=uf_getreponse_script("ZVAS82", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS82", sVal )

// ZVAS83 - SUITE MAJ LOG
sVal=uf_getreponse_script("ZVAS83", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS83", sVal )

// ZVAS84 - SUITE VIRUS
sVal=uf_getreponse_script("ZVAS84", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS84", sVal )

// ZVAS85 - LORS MISE EN SERV
sVal=uf_getreponse_script("ZVAS85", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS85", sVal )

// ZVAS86 - SUITE INTERV TECH
sVal=uf_getreponse_script("ZVAS86", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS86", sVal )

// ZVAS87 - SUITE INSTALL
sVal=uf_getreponse_script("ZVAS87", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS87", sVal )

// ZVAS88 - VANDALISME
sVal=uf_getreponse_script("ZVAS88", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS88", sVal )

// ZVAS89 - SUITE MODIF ORIG
sVal=uf_getreponse_script("ZVAS89", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS89", sVal )

// ZVAS90 - MODIF ASSURE
sVal=uf_getreponse_script("ZVAS90", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS90", sVal )

// ZVAS91 - MODIF REPAR
sVal=uf_getreponse_script("ZVAS91", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS91", sVal )

// ZVAS92 - PREC MODIF
sVal=uf_getreponse_script("ZVAS92", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS92", sVal )

// ZVAS93 - ELTS ELEC
sVal=uf_getreponse_script("ZVAS93", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS93", sVal )

// ZVAS94 - PREC ELTS ELEC
sVal=uf_getreponse_script("ZVAS94", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS94", sVal )

// ZVAS95 - REP SC ADVISE DATE DER UTIL
sVal=uf_getreponse_script("ZVAS95", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS95", sVal )

// ZVAS96 - REP SC ADVISE APP ETAT FONCTIONNE
sVal=uf_getreponse_script("ZVAS96", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS96", sVal )

// :[PC171918]

// [PC171933]

// ZVAS97 - REP SC PERTE SUITE ACCIDENT
sVal=uf_getreponse_script("ZVAS97", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS97", sVal )

// ZVAS98 - REP SC ACCIDENT TRANSP?
sVal=uf_getreponse_script("ZVAS98", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS98", sVal )

// ZVAS99 - REP SC LIEU PERTE
sVal=uf_getreponse_script("ZVAS99", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAS99", sVal )

// ZVAT01 - REP SC CIRC. PERTE
sVal=uf_getreponse_script("ZVAT01", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT01", sVal )

// ZVAT02 - REP SC VOL APERCU IMMEDIAT.
sVal=uf_getreponse_script("ZVAT02", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT02", sVal )

// ZVAT03 - REP SC AGRESSION
sVal=uf_getreponse_script("ZVAT03", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT03", sVal )

// ZVAT04 - REP SC DECLA POLICE
sVal=uf_getreponse_script("ZVAT04", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT04", sVal )

// ZVAT05 - REP SC TEMOINS
sVal=uf_getreponse_script("ZVAT05", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT05", sVal )

// ZVAT06 - REP SC VOL A DOMICILE
sVal=uf_getreponse_script("ZVAT06", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT06", sVal )

// ZVAT07 - REP SC LIEU VOL
sVal=uf_getreponse_script("ZVAT07", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT07", sVal )

// ZVAT08 - REP SC LIEU ENTREE VOLEURS
sVal=uf_getreponse_script("ZVAT08", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT08", sVal )

// ZVAT09 - REP SC EFFRACTION
sVal=uf_getreponse_script("ZVAT09", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT09", sVal )

// ZVAT10 - REP SC REPARATION
sVal=uf_getreponse_script("ZVAT10", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT10", sVal )

// ZVAT11 - REP SC VOL LIEU PUBLIC
sVal=uf_getreponse_script("ZVAT11", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT11", sVal )

// ZVAT12 - REP SC APPAREIL SUR VOUS
sVal=uf_getreponse_script("ZVAT12", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT12", sVal )

// ZVAT13 - REP SC UTILISATION APP LORS DU VOL
sVal=uf_getreponse_script("ZVAT13", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT13", sVal )

// ZVAT14 - REP SC APPAREIL POSE
sVal=uf_getreponse_script("ZVAT14", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT14", sVal )

// ZVAT15 - REP SC DEPLACT SANS APPAREIL
sVal=uf_getreponse_script("ZVAT15", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT15", sVal )

// ZVAT16 - REP SC APPAREIL AU VESTIAIRE
sVal=uf_getreponse_script("ZVAT16", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT16", sVal )

// ZVAT17 - REP SC PRET APPAREIL
sVal=uf_getreponse_script("ZVAT17", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT17", sVal )

// ZVAT18 - REP SC VOL DANS TRANSP COMMUN
sVal=uf_getreponse_script("ZVAT18", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT18", sVal )

// ZVAT19 - REP SC APPAREIL DANS UN SAC
sVal=uf_getreponse_script("ZVAT19", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT19", sVal )

// ZVAT20 - REP SC APPAREIL VISIBLE
sVal=uf_getreponse_script("ZVAT20", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT20", sVal )

// ZVAT21 - REP SC APPAREIL POSE A PROXIMITE
sVal=uf_getreponse_script("ZVAT21", false)
if sVal <> "" Then iUoLibelle.Uf_SetValue ( "ZVAT21", sVal )

// :[PC171933]

//	[VDOC25509]
sVal= This.uf_GestOng_Divers_Trouver ( "CRA_LAST_DTE" ) 
iuoLibelle.Uf_SetValue ( "ZVAT22", sVal )	



//	:[VDOC25509]

// [VDoc26409]
//lRow = idw_lstwcommande.Find ( "ID_TYP_ART = 'PRS' AND POS ( INFO_SPB_FRN_CPLT, 'A_REPARER_SAV=OUI') > 0 ", idw_lstwcommande.RowCount(),1)
lRow=idw_lstwcommande.RowCount() //	[VDOC26434]

If lRow > 0 Then
	sVal = idw_lstwcommande.Describe ( "Evaluate ( 'LookUpDisplay ( ADR_COD_CIV )', 1 ) " ) 
	
	sVal += " " + &
			 F_GetItem3 ( idw_lstwcommande, lRow, "ADR_NOM" ) + " " + &
			 F_GetItem3 ( idw_lstwcommande, lRow, "ADR_PRENOM" )	+ Char (11) + &
			 F_GetItem3 ( idw_lstwcommande, lRow, "ADR_LIVR1" ) + Char (11) 
			 
			 if F_GetItem3 ( idw_lstwcommande, lRow, "ADR_LIVR2" ) <> "" Then 
				sVal+= F_GetItem3 ( idw_lstwcommande, lRow, "ADR_LIVR2" ) + Char (11) 
			 End if
			
			 if F_GetItem3 ( idw_lstwcommande, lRow, "ADR_LIVR_CPL" ) <> "" Then 
				sVal+= F_GetItem3 ( idw_lstwcommande, lRow, "ADR_LIVR_CPL" ) + Char (11) 
			 End if

			 sVal+= F_GetItem3 ( idw_lstwcommande, lRow, "ADR_CP" ) + " " + &
			 F_GetItem3 ( idw_lstwcommande, lRow, "ADR_VILLE" ) 
	
	iUoLibelle.Uf_SetValue ( "ZVAT24" ,  sVal ) 	
	 
End If 
// :[VDoc26409]


// [PM421-3]
sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "NUM_CARTE_CADEAU" )	)
If IsNull ( sVal ) Then sVal = ""

iUoLibelle.Uf_SetValue ( "ZVAT25", sVal )


sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "MOTIF_DEMANDE" )	)
If IsNull ( sVal ) Then sVal = ""

iUoLibelle.Uf_SetValue ( "ZVAT26", sVal )	

// [VDOC27689]
/*---------------------------------------------------------------------*/
/* On calcule la date du dernier renouvellement + 1, justa après la surv*/
/* En fonction de l'unité de periode de renouvellement (ANNEE,MOIS,JOUR)*/
/*---------------------------------------------------------------------*/
iUoLibelle.Uf_SetValue ( "ZVAT27", "" )

If Not IsNull ( dDteSurv ) And Not IsNull ( dDteAdh ) Then

	Choose Case sUntPerRnv_Adh
		Case "A"
		  lCptMax = 30
		Case "M"
		  lCptMax = 360
		Case "J"
		 lCptMax = 10950
	End Choose
	For	lCpt = 1 To lCptMax
			dDteResult = F_Plus_Date ( dDteAdh, dcDurPerRnv_Adh, sUntPerRnv_Adh )
			If	dDteResult <= dDteSurv	Then
				dDteAdh = dDteResult
			Else
				Exit
			End If
	Next

	// On refait un tour
	dDteResult = F_Plus_Date ( dDteAdh, dcDurPerRnv_Adh, sUntPerRnv_Adh )
	dDteResult = F_Plus_Date ( dDteResult , -1, "J" )
	dDteAdhRenouvApSurv 	= dDteResult
	
	iUoLibelle.Uf_SetValue ( "ZVAT27", String ( dDteAdhRenouvApSurv, "dd/mm/yyyy" ) )	
End If 

// [PM421-4]
sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "DTE_OFFRE" )	)
If IsNull ( sVal ) Then sVal = ""

iUoLibelle.Uf_SetValue ( "ZVAT28", sVal )


sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "NUM_OFFRE" )	)
If IsNull ( sVal ) Then sVal = ""

iUoLibelle.Uf_SetValue ( "ZVAT29", sVal )	


// [DT410]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), "-DP", 334 )
If lDeb > 0 Then

	lLig = iDw_LstInter.Find ( "COD_INTER = 'A' AND CPT_COUR = 0", 1, iDw_LstInter.RowCount () )

	If lLig > 0 Then
		sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "URL_NOTICE", ";")
		iuoLibelle.Uf_SetValue ( "ZVAT30", sVal )
		
		sVal = "Votre notice d'assurance a été mise à jour sous la référence " + sLibPoliceDef + ". Vous la trouverez à l’adresse suivante : " 
		iuoLibelle.Uf_SetValue ( "ZVAT33", sVal )			
	End If 
End IF 

// [PM421-6]
// Le NUM_CARTE_CADEAU est déjà armé plus haut sur PM421-3/ZVAT25
sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "DTE_CARTE_CADEAU" )	)
If IsNull ( sVal ) Then sVal = ""

iUoLibelle.Uf_SetValue ( "ZVAT31", sVal )	

sVal = Trim ( This.uf_GestOng_Divers_Trouver ( "MT_CARTE_CADEAU" )	)
If IsNull ( sVal ) Then sVal = ""

iUoLibelle.Uf_SetValue ( "ZVAT32", sVal )	
	

// [DT443]
sRech =  "ID_REF_FOUR IN ( 'A_REPARER', 'A_DIAGNOSTIQUER', 'A_DESOXYDER' ) AND COD_ETAT <> 'ANN' " 
sRech += " AND ( POS ( COMMENT_FRN, 'BVIE') > 0 OR POS ( COMMENT_FRN, 'PIE') > 0) "
lRow = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

sRech =  "ID_REF_FOUR IN ( 'A_REPARER', 'A_DIAGNOSTIQUER', 'A_DESOXYDER' ) AND COD_ETAT <> 'ANN' "
sRech += " AND ( POS ( COMMENT_FRN, 'BVIT') > 0 OR POS ( COMMENT_FRN, 'BVID') > 0 OR POS ( COMMENT_FRN, 'BVIP') > 0 )"
lRow1 = idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.RowCount ())

// Attention Row et id_seq sont inversés en tri :)
If lRow > 0  Then
	sVal = "économiquement"
End If 

If lRow1 > 0  Then
	sVal = "techniquement"
End If 

If lRow > 0 And lRow1 > 0 Then
	If lRow < lRow1 Then
		sVal = "économiquement"
	Else 
		sVal = "techniquement"			
	End If 
End If 

iUoLibelle.Uf_SetValue ( "ZVAT34", sVal )	
	

// [VDOC29047]
lRow = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.RowCount())
If lRow > 0 Then
	 sVal = &
	 idw_LstInter.Describe ( "Evaluate ( 'LookUpDisplay ( COD_CIV )', " + String ( lRow ) + " ) " ) + " " + &
	 F_GetItem3 ( idw_LstInter, lRow, "NOM" ) + ", " + &
	 F_GetItem3 ( idw_LstInter, lRow, "ADR_1" ) 
	 sVal1 = F_GetItem3 ( idw_LstInter, lRow, "ADR_LIVR2" ) 

	 If sVal1 <> "" Then sVal += sVal
	 sVal+= + ", " + &
	 F_GetItem3 ( idw_LstInter, lRow, "ADR_CP" ) + " " + &
	 F_GetItem3 ( idw_LstInter, lRow, "ADR_VILLE" ) 

	iUoLibelle.Uf_SetValue ( "ZVAT35", sVal )	
End IF 

/*------------------------------------------------------------------*/
/* !! Coder au dessus de cette lignes !!									  */
/*------------------------------------------------------------------*/
/* Fin des variables pour le Sinistre. On conserve ces variables    */
/* dans un tableau en local.                                        */
/*------------------------------------------------------------------*/
iuoLibelle.Uf_Recuperer_Tableau_Variable ( sVarSinistre )

/*------------------------------------------------------------------*/
/* On génére maintenant les DATAS pour les interlocuteurs.          */
/*------------------------------------------------------------------*/
lTotInter = idw_LstInter.RowCount ()
For	lCpt = 1 To lTotInter

		lIdI		= idw_LstInter.GetItemNumber ( lCpt, "ID_I" )

		// #6
		If asCas = "CP_UNIQUEMENT" Then
			If lIdI <> aiCasInter Then Continue			
		End If

/*------------------------------------------------------------------*/
/* S'il n'y a pas de courrier pour cet interlocuteur, on ne génére  */
/* pas de fichier de DATAS.                                         */
/*------------------------------------------------------------------*/
		sIdCour = idw_LstInter.GetItemString ( lCpt, "ID_COUR" )

		// #6
		If asCas = "COUR_AUTO" Then
			If	IsNull ( sIdCour ) Or sIdCour = "" Then Continue
		End If

/*------------------------------------------------------------------*/
/* On arme pour l'interlocuteur en cours la liste des variables     */
/* générées pour le sinistre.                                       */
/*------------------------------------------------------------------*/
		iuoLibelle.Uf_Initialiser_Tableau ( sVarSinistre [] )

		// #30 - [DCMP090552]
		sVal2 = idw_LstInter.GetItemString (lCpt, "ADR_CP")
		lDeb = 0
		
		if sVal2 = "00000" or sVal2 = "98000" Then
			F_RechDetPro ( lDeb, lFin, idw_DetPro, lIdProd, '-DP', 120 )
		End if
		
		if lDeb > 0 Then
			sVal3 = idw_detpro.getItemString(lDeb, "VAL_CAR")
			sVal3 = lnvPFCString.of_getkeyvalue( sVal3, "INDICATIF", ";")
			
			sVal = idw_Produit.GetItemString ( 1, "NUM_TEL" )
			sVal = Mid(sVal,2)
			sVal = String (sVal, "@@@ @@@ @@@" )
			sVal= sVal3 + " " + sVal
			iuoLibelle.Uf_SetValue ( "PNOTEL", sVal )
			
			sVal = idw_Produit.GetItemString ( 1, "NUM_FAX" )
			sVal = Mid(sVal,2)
			sVal = String (sVal, "@@@ @@@ @@@" )
			sVal= sVal3 + " " + sVal
			iuoLibelle.Uf_SetValue ( "PNOFAX", sVal )
		Else
			sVal = idw_Produit.GetItemString ( 1, "NUM_TEL" )
			sVal = Uf_Format_NumTel ( sVal )
			iuoLibelle.Uf_SetValue ( "PNOTEL", sVal )
			
			sVal = idw_Produit.GetItemString ( 1, "NUM_FAX" )
			sVal = Uf_Format_NumTel ( sVal )
			iuoLibelle.Uf_SetValue ( "PNOFAX", sVal )
		End If
		// Fin #30 - [DCMP090552]
		
/*------------------------------------------------------------------*/
/* On détermine toutes les DATAS pour l'interlocuteur. Si tout se   */
/* passe bien, on arme une chaine de caractères correpondant au     */
/* contenu des variables trouvées. On réinitialise ensuite le       */
/* tableau à vide pour l'interlocuteur suivant. (A part les         */
/* variables du sinistre).                                          */
/*------------------------------------------------------------------*/
		If asCas = "CP_UNIQUEMENT" Then // #20 On ne test pas sPos pour les CP
			sPos = Uf_Determiner_Data_Interlocuteur ( lCpt )	

		ElseIf sPos = "" Then // // #20 on test sPos pour les cour auto
			sPos = Uf_Determiner_Data_Interlocuteur ( lCpt )
		End If 
	
		If	sPos = ""	Then
			sVarInter = ""
			iuoLibelle.Uf_Creer_Chaine ( sVarInter, stSpb )
			
			// [PI052] Récupère le contenu de variable pour chaque inter.
			/*
			If F_CLE_A_TRUE ( "PI052" ) Then
				iuoLibelle.Uf_Recuperer_Tableau_Variable ( aTabVariable[ lIdI + 1 ].sTab [] )
			End If 
			*/
		
			iuoLibelle.Uf_Initialiser_Tableau ( sVide [] )
/*------------------------------------------------------------------*/
/* On ecrit la chaine de caractères dans le fichier des DATAS pour  */
/* l'interlocuteur courant.                                         */
/*------------------------------------------------------------------*/
/* #6 si l'on est en SVE, aiguillage vers l'alimentation d'un       */
/* tableau de data.                                                 */
/*------------------------------------------------------------------*/
			If ibSaisieValidation Then
				asDataInter [ lIdI + 1 ] = sVarInter 
			Else
				/*------------------------------------------------------------------*/
				/* On ouvre le fichier en mode Replace!, mais normalement il        */
				/* n'existe plus. Ils viennent en effet d'être supprimés            */
				/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/  
/* #14. DCMP-060643                                                 */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/			
//				sNomFic	= isRepWin + "\TEMP\" + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".DT"
				sNomFic	= stGLB.sRepTempo + stGlb.sCodAppli + String ( lIdI, "0000" ) + ".DT"
				iFic		= FileOpen ( sNomFic, LineMode!, Write!, LockReadWrite!, Replace! )

				If	iFic > 0 Then
					FileWrite ( iFic, sVarInter )
					FileClose ( iFic )
				End If
			End IF
			
		Else
			Return ( sPos )
		End If
Next

// [PI052] Récupére le code des variables
/*
If F_CLE_A_TRUE ( "PI052" ) Then
	iuoLibelle.Uf_Recuperer_Tableau_Variable_PI052 ( asTabCodeVar[] )			
End If
*/

Return ( sPos )
end function

public function string uf_controlergestion_a_rep_force ();//*-----------------------------------------------------------------
//*
//* Fonction		: uf_controlergestion_a_rep_force (PUBLIC)
//* Auteur			: JFF
//* Date				: 05/08/2015
//* Libellé			: [VDOC18276]
//* Commentaires	: 
//*
//* Arguments		: 
//*
//* Retourne		: 
//*
//*-----------------------------------------------------------------
//* JFF	14/03/2016 [VDOC20267]
//  JFF  07/03/2024 [HP252_276_HUB_PRESTA]
//*-----------------------------------------------------------------

Boolean bRet, bDiag
Long lVal1, lVal2, lVal3
String sPos

bDiag = False
bRet = True
sPos = ""

// [HP252_276_HUB_PRESTA] 'A_DIAG_FORCE' [20250228130407143]
lVal1 = idw_LstwCommande.find( "ID_REF_FOUR IN ( 'A_REPARER_FORCE', 'A_DIAG_FORCE', 'REFUSE_A_REEXP' ) AND COD_ETAT = 'CNV'",1,  idw_LstwCommande.rowCount()+1 )

// Controle Incomplet Hub 
// [HP252_276_HUB_PRESTA]
If idw_LstwCommande.Find ( "POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0", 1, idw_LstwCommande.RowCount () ) > 0 Then

	lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_REPARER' ) AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 169 )", 1, idw_LstwCommande.rowCount()+1 ) 								
	If lVal2 = 0 Then
		lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 169 )", 1, idw_LstwCommande.rowCount()+1 ) 							
		If lVal2 > 0 Then bDiag = True 
	End If 		
	
	If lVal1 <= 0 And lVal2 > 0 Then
		bRet = False
		
		stMessage.sTitre		= "Hub Prestataire : Géoloc. Active"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN924"
		stMessage.sVar[1]		= "A_REPARER_FORCE"
		If bDiag Then stMessage.sVar[1] = "A_DIAG_FORCE"
		sPos	= "ALT_BLOC"				
		Return sPos
	End If 
	
 	If lVal1 > 0 And lVal2 > 0 Then
		Return sPos
	End If 
	
End IF 

// [HP252_276_HUB_PRESTA] 'A_DIAG_FORCE' [20250228130407143], pour GEOLOC pas de REFUSE_A_REXP possible (cf Olfa)
// MIG82 01/04/2025, je rajoute suite demande Lisette le REFUSE_A_REXP
lVal1 = idw_LstwCommande.find( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DESOXYDER_FORCE', 'A_DIAG_FORCE' ) AND COD_ETAT = 'CNV'",1,  idw_LstwCommande.rowCount()+1 )

// Controle Géoloc Hub
// [HP252_276_HUB_PRESTA]
If idw_LstwCommande.Find ( "POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0", 1, idw_LstwCommande.RowCount () ) > 0 Then

	lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_REPARER' ) AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 305 )", 1, idw_LstwCommande.rowCount()+1 ) 								
	If lVal2 = 0 Then
		lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 305 )", 1, idw_LstwCommande.rowCount()+1 ) 							
		If lVal2 > 0 Then bDiag = True 
	End If 		
	
	If lVal1 <= 0 And lVal2 > 0 Then
		bRet = False
		
		stMessage.sTitre		= "Hub Prestataire : Géoloc. Active"
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sCode		= "WSIN923"
		stMessage.sVar[1]		= "A_REPARER_FORCE"
		If bDiag Then stMessage.sVar[1] = "A_DIAG_FORCE"
		sPos	= "ALT_BLOC"				
		Return sPos
	End If 
	
 	If lVal1 > 0 And lVal2 > 0 Then
		Return sPos
	End If 
	
End IF 

// [HP252_276_HUB_PRESTA] 'A_DIAG_FORCE' [20250228130407143]
lVal1 = idw_LstwCommande.find( "ID_REF_FOUR IN ( 'A_REPARER_FORCE', 'A_DESOXYDER_FORCE', 'A_DIAG_FORCE' ) AND COD_ETAT = 'CNV'",1,  idw_LstwCommande.rowCount()+1 )

// Problème de parenthès, faux
// lVal2 = idw_LstwCommande.Find ( "( ID_REF_FOUR = 'A_REPARER' OR POS ( INFO_SPB_FRN_CPLT, 'A_REPARER_SAV=OUI') > 0 OR ( POS ( INFO_SPB_FRN_CPLT, 'A_CONTROLER_SAV=OUI') > 0 ) AND ID_REF_FOUR = 'A_REPARER' ) AND ID_TYP_ART = 'PRS' AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 154 )", 1, idw_LstwCommande.rowCount()+1 ) 		
lVal2 = idw_LstwCommande.Find ( "( ID_REF_FOUR = 'A_REPARER' OR POS ( INFO_SPB_FRN_CPLT, 'A_REPARER_SAV=OUI') > 0 OR ( POS ( INFO_SPB_FRN_CPLT, 'A_CONTROLER_SAV=OUI') > 0 AND ID_REF_FOUR = 'A_REPARER' ) ) AND ID_TYP_ART = 'PRS' AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 153, 154 )", 1, idw_LstwCommande.rowCount()+1 ) 		

// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	If idw_LstwCommande.Find ( "POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0", 1, idw_LstwCommande.RowCount () ) > 0 Then
		lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_REPARER' ) AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 153 )", 1, idw_LstwCommande.rowCount()+1 ) 								
		If lVal2 = 0 Then
			lVal2 = idw_LstwCommande.Find ( "ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 153 )", 1, idw_LstwCommande.rowCount()+1 ) 							
			If lVal2 > 0 Then bDiag = True 
		End If 		
	End IF 
End If

lVal3 = idw_LstwCommande.Find ( "( ID_REF_FOUR = 'A_DESOXYDER' OR POS ( INFO_SPB_FRN_CPLT, 'A_DESOXYDER_SAV=OUI') > 0 OR ( POS ( INFO_SPB_FRN_CPLT, 'A_CONTROLER_SAV=OUI') > 0) AND ID_REF_FOUR = 'A_DESOXYDER' ) AND ID_TYP_ART = 'PRS' AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN') AND STATUS_GC IN ( 153, 154 )", 1, idw_LstwCommande.rowCount()+1 )

/*
If lVal1 > 0 And ( lVal2 <= 0 And lVal3 <= 0 ) And &
	idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) = idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT", Primary!, TRUE ) And &
	idw_wSin.GetItemString ( 1, "MARQ_PORT" ) = idw_wSin.GetItemString ( 1, "MARQ_PORT", Primary!, TRUE ) And &
	idw_wSin.GetItemString ( 1, "MODL_PORT" ) = idw_wSin.GetItemString ( 1, "MODL_PORT", Primary!, TRUE ) Then
*/

If lVal1 > 0 And lVal2 <= 0 And lVal3 <= 0 Then
	bRet = False
	
	stMessage.sTitre		= "vDoc18276 : P.Fermey/E.Olivier"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "WSIN922"
	sPos	= "ALT_BLOC"				
	Return sPos
End If 

If lVal1 > 0 And ( lVal2 > 0 Or lVal3 > 0 ) And &
	idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) = idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT", Primary!, TRUE ) And &
	idw_wSin.GetItemString ( 1, "MARQ_PORT" ) = idw_wSin.GetItemString ( 1, "MARQ_PORT", Primary!, TRUE ) And &
	idw_wSin.GetItemString ( 1, "MODL_PORT" ) = idw_wSin.GetItemString ( 1, "MODL_PORT", Primary!, TRUE ) &
	Then

	bRet = False
	
	stMessage.sTitre		= "vDoc18276 : P.Fermey/E.Olivier"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "V018276"
	If bDiag Then 	stMessage.sCode = "V018277"
	sPos	= "ALT_BLOC"				

	Return sPos

End If


Return sPos
end function

private subroutine uf_determiner_courrier_forcage_dp288 (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_Dp288 (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 02/09/2015
//* Libellé       : 
//* Commentaires  : [DT127] courrier AIG
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    09/11/2015  [DT127-1]
//*       JFF    10/11/2015  [DT127-2]
//*       JFF    17/11/2015  [DT127][NTCAS7/8] suite mail de N. Tonnetot, modif sur cas 7 et 8
//*       JFF    10/12/2015  [DT127-1][NTCAS8/11] suite mail de F. Lebarbay, modif sur cas 8 et 11
//*       JFF    28/09/2016  [DT262]
//*		 JFF    31/10/2016  [DT262] ITSM 423997
//*		 JFF    01/03/2017  [DT262] Mail NT le 20/02/2017 16h08
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech 
Long   				lDeb, lFin, lTotCourrier, lLig, lCpt, lIdNatSin, lIdDetSin, lRow, lIdProd, lRefusPertinent
string				sTypApp, sAdrMail
Boolean				bCondition, bRefusTrouve, bRefusUnique, bCasTrouve, bMsgRefPasUnique
n_cst_attrib_key	lKey[], lKeyNull[]

bCasTrouve = False
bMsgRefPasUnique = False
lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )

F_RechDetPro ( lDeb, lFin,idw_DetPro, lIdProd, "-DP", 288 )
If lDeb <= 0 Then Return 

lIdNatSin = idw_wSin.GetItemNumber ( 1, "ID_NATSIN" )
lIdDetSin = idw_wSin.GetItemNumber ( 1, "ID_DETSIN" )
sIdNatCourForcage = ""
stMessage.sCode = ""

// [DT127]
// Cas 1 : refus 1066
If Not bCasTrouve Then 
	lRefusPertinent = 1066
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "1"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If

// [DT127]
// Cas 2 : nature 37 "vol sauvette" ET refus 611
If Not bCasTrouve Then 
	lRefusPertinent = 611
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "2"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And lIdNatSin = 37 And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If 

// [DT127]
// Cas 3,4,5 : nature 32 "vol intro clandestine" ET  refus 611
If Not bCasTrouve Then 
	lRefusPertinent = 611
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "3"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And lIdNatSin = 32 And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If


// [DT127]
// Cas 6 : nature 22 "vol effraction" ET détail 23 OU 24 OU 27 ET refus 612
If Not bCasTrouve Then 
	lRefusPertinent = 612
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "6"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And lIdNatSin = 22 And sIdNatCourForcage <> "" Then
		Choose Case lIdDetSin 
			Case 23, 24, 27
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT127]
// [DT127][NTCAS7/8] ajout 32, 37
// Cas 7 : garantie 10 OU 8 ET nature différente de 22 OU 23 OU 31 Et refus 611
If Not bCasTrouve Then 
	lRefusPertinent = 611
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_GTI IN ( 8, 10) AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_GTI IN ( 8, 10) AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "7"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		Choose Case lIdNatSin 
			Case 22, 23, 31, 32, 37
				// Hors critère
			Case Else
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT127]
// [DT127][NTCAS7/8] ajout 32
// [DT127-1][NTCAS8/11] ajout 32 ou 37
// Cas 8,9 : garantie 10 OU 8 ET nature différente de 22 OU 23 Et refus 611
If Not bCasTrouve Then 
	lRefusPertinent = 611
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_GTI IN ( 8, 10) AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_GTI IN ( 8, 10) AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "8"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		Choose Case lIdNatSin 
			Case 22, 23, 32, 37
				// Hors critère
			Case Else
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT127-1]
// Cas 10 : nature 22 "vol effraction" ET détail 13 ou 22 ou 23 ou 24 ou 25 ou 91 ET refus 612
If Not bCasTrouve Then 
	lRefusPertinent = 612
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "10"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And lIdNatSin = 22 And sIdNatCourForcage <> "" Then
		Choose Case lIdDetSin 
			Case 13, 22, 23, 24, 25, 91
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT127-1]
// [DT127-1][NTCAS8/11] ajout 37
// Cas 11 : garantie 10 ou 8 ET nature différente de 22 ou 23 ou 31 ou 32 ET refus 611
If Not bCasTrouve Then 
	lRefusPertinent = 611
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_GTI IN ( 8, 10) AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_GTI IN ( 8, 10) AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "11"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		Choose Case lIdNatSin 
			Case 22, 23, 31, 32, 37
				// Hors critère
			Case Else
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If


// [DT127-2]
// Cas 12 : nature 22 "vol effraction" ET détail 23 OU 73 OU 95 ET refus 612
If Not bCasTrouve Then 
	lRefusPertinent = 612
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "12"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And lIdNatSin = 22 And sIdNatCourForcage <> "" Then
		Choose Case lIdDetSin 
			Case 23, 73, 95
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT127-2]
// Cas 13 : nature 22 "vol effraction" ET détail 13 OU 15 OU 22 OU 24 OU 25 OU 29 OU 92 ET refus 612
If Not bCasTrouve Then 
	lRefusPertinent = 612
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "13"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And lIdNatSin = 22 And sIdNatCourForcage <> "" Then
		Choose Case lIdDetSin 
			Case 13, 15, 22, 24, 25, 29, 92
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT127-2]
// Cas 14 : nature 22 "vol effraction" ET détail 16 OU 22 OU 24 OU 25 OU 93 ET refus 612
If Not bCasTrouve Then 
	lRefusPertinent = 612
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "14"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And lIdNatSin = 22 And sIdNatCourForcage <> "" Then
		Choose Case lIdDetSin 
			Case 16, 22, 24, 25, 93
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT127-2]
// Cas 15 : nature 22 "vol effraction" ET détail 17 OU 18 OU 19 OU 94 ET refus 612
If Not bCasTrouve Then 
	lRefusPertinent = 612
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "15"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And lIdNatSin = 22 And sIdNatCourForcage <> "" Then
		Choose Case lIdDetSin 
			Case 17, 18, 19, 94
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT262]

// [DT262]
// Cas 16 : nature 11 ou 12 ou 20 ET refus 611
If Not bCasTrouve Then 
	lRefusPertinent = 611
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "16"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		Choose Case lIdNatSin 
			Case 11, 12, 20
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT262]
// Cas 17 : nature 28 ET refus 611
If Not bCasTrouve Then 
	lRefusPertinent = 611
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "17"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		Choose Case lIdNatSin 
			Case 28
				bCasTrouve =True
				If Not bRefusUnique Then
					bMsgRefPasUnique =True
				End If
		End Choose
	End If
End If

// [DT262]
// Cas 18 : refus 1816
If Not bCasTrouve Then 
	lRefusPertinent = 1816
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "18"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If

// [DT262]
// Cas 19 : refus 1817
If Not bCasTrouve Then 
	lRefusPertinent = 1817
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "19"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If

// [DT262]
// Cas 20 : refus 390
If Not bCasTrouve Then 
	lRefusPertinent = 390
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "20"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If


// [DT262]
// Cas 21 : refus 602
If Not bCasTrouve Then 
	lRefusPertinent = 602
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "21"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If

// [DT262]
// Cas 22 : refus 601
If Not bCasTrouve Then 
	lRefusPertinent = 601
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "22"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If

// [DT262]
// Cas 23 : refus 1165
If Not bCasTrouve Then 
	lRefusPertinent = 1165
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "23"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If


// [DT262] ITSM 423997
// Cas 24 : refus 1823
If Not bCasTrouve Then 
	lRefusPertinent = 1823
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "24"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If

// [DT262] Mail NT le 20/02/2017 16h08
// Cas 25 : refus 1483
If Not bCasTrouve Then 
	lRefusPertinent = 1483
	bRefusTrouve = idw_wRefus.Find ( "ID_MOTIF = " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) > 0 
	bRefusUnique = idw_wRefus.Find ( "ID_MOTIF <> " + string ( lRefusPertinent ) + " AND ID_I = 0", 1, idw_wRefus.Rowcount () ) <= 0 
	
	lKey=lKeyNull
	sIdNatCourForcage = ""
	lKey[1].iskeyname = "CAS"
	lKey[1].iakeyvalue = "25"
	lKey[2].iskeyname = "ID_COUR"
	
	F_RechDetPro_withKey ( lRow, idw_DetPro, lIdProd , "-DP", 288, lKey )
	If lRow > 0 Then 
		if not isnull(lKey[2].iakeyvalue) And Trim ( lKey[2].iakeyvalue ) <> "" Then sIdNatCourForcage = lKey[2].iakeyvalue
	End if
	
	If Not bCasTrouve And bRefusTrouve And sIdNatCourForcage <> "" Then
		bCasTrouve =True
		If Not bRefusUnique Then
			bMsgRefPasUnique =True
		End If
	End If
End If

///// Fin des Cas => traitement ////

If bCasTrouve And bMsgRefPasUnique Then
	stMessage.sTitre	   = "DT127 : Courrier de refus Aig"
	stMessage.bErreurG	= FALSE
	stMessage.Icon			= question!
	stMessage.sCode		= "WSIN792" 
	stMessage.Bouton		= Ok!
	stMessage.sVar[1] 	= String ( lRefusPertinent )
	stMessage.sVar[2] 	= sIdNatCourForcage
	stMessage.sVar[3] 	= String ( lRefusPertinent )
	
	F_Message ( stMessage )
	
End If

bCondition = asPos = "" &
					And lDeb > 0 &
					And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" &
					And sIdNatCourForcage <> "" &
					And bCasTrouve &
					And Not bMsgRefPasUnique

If IsNull ( sIdNatCourForcage ) Then sIdNatCourForcage  = ""

If bCondition Then

		sIdNatPresent = asIdNatCour
		
		If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

		If sIdNatPresent <> sIdNatCourForcage Then

			If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= sIdNatCourForcage
				
			Else
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= asIdNatCour
				stMessage.sVar[2] 	= sIdNatCourForcage
			End If 
			
			If F_Message ( stMessage ) = 1 Then

				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!							

				idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
				lTotCourrier	= dwChild.RowCount ()
				sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
				lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
		
		/*------------------------------------------------------------------*/
		/* On verifie si la nature de courrier existe. Si elle n'existe     */
		/* pas, par un effet du hasard bien sur, on arrete le traitement    */
		/* et on positionne sur REF_CIE.                                    */
		/*------------------------------------------------------------------*/
				If	lLig = 0	Then
		
		/*------------------------------------------------------------------*/
		/* On arme la structure de message maintenant, mais le message va   */
		/* être affiché dans le contrôle de gestion.                        */
		/*------------------------------------------------------------------*/
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= Information!
					stMessage.sCode		= "WSIN170"
					stMessage.sVar[1] 	= sIdNatCourForcage
					asPos = "REF_CIE"
				Else
					If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
						asIdNatCour = sIdNatCourForcage
						asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
						
						idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
						idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
						idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
					Else 
						// Le message est armé dans uf_GestionCP
						asPos = "REF_CIE"

					End If
				End If		
			End If
		End If
End If


end subroutine

private function boolean uf_validation_finale_atech_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Atech_Mail  (PRIVATE)
//* Auteur        : FPI
//* Date          : 08/09/2015
//* Libellé       : MAIL pour Atech
//* Commentaires  : Construction du Mail
//*
//* Arguments     : 	// [PC13442-2]
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------


Boolean bRet
String  sFiltreOrig, sFiltre,  sIdSin, sNomMagasin, sIdGti, sIdEvt, sFiltreOrigdddw
String  sIdDetail, sRech, sMailDest,  sVal, sTypApp, sLibTypApp
Long 	  lRow, lTotCmd, lCptCmd, lRow2, lRow3, lDeb, lFin, lIdGti, lIdDetail, lIdTypMail
String  sMailFrom, sSaut, sMailBody, sTypMail, sMailObjet, sXml
Decimal{2}	dcMtMaxTTC
DataWindowChild dwChild
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
Long lTotDetail, lCptDet
Decimal{2}	dcMtLu, dcMtMaxLu
Integer iIdAppli
s_pass stPass
Blob bMailBody
String sMailCc, sMailCci

sMailCc=""
sVal = ""

sSaut = char (10 )
sMailBody=""
sTypMail="CMDATC"
iIdAppli=2

bRet = True

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les mobiles qui nous intéressent.   */
/*------------------------------------------------------------------*/
sFiltre = "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    = 'ATC'" 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* S'il n'y a aucune ligne, on ne construit pas de mail.            */
/* mais on commit normalement la validation.								  */
/*------------------------------------------------------------------*/
If lTotCmd <= 0 Then 
	// Rajout JFF !!!
	idw_LstwCommande.SetFilter ( sFiltreOrig )
	idw_LstwCommande.Filter ()	
	Return TRUE
End If

Choose Case idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART")
	Case 'TEL'
		lIdTypMail=1
		sMailObjet='AIG SPB_ATECH_ASSURANCE_N°' + sIdSin + ' (Proposition de remplacement Téléphone)'
	Case 'CAF'
		lIdTypMail=2
		sMailObjet='AIG SPB_ATECH_ASSURANCE_N°' + sIdSin + ' (Choix remplacement)'
	Case 'AEF'
		lIdTypMail=3
		sMailObjet='AIG SPB_ATECH_ASSURANCE_N°' + sIdSin + ' (Diagnostic/Expertise)'
	Case Else
		lIdTypMail=4
		sMailObjet='AIG SPB_ATECH_ASSURANCE_N°' + sIdSin + ' (Proposition de remplacement Nomade)'
End Choose

// Adresse mail from
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 215 )
If lDeb > 0 Then
	sVal=	idw_DetPro.GetItemString(lDeb,"VAL_CAR")
	sMailFrom=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL", ";")
	sMailCci=lnvPFCString.of_getkeyvalue( sVal, "ADR_MAIL_PRODUIT", ";")
End if

If lIdTypMail=1 or lIdTypMail=4 Then // TEL - 3 mobiles proposés
	For lCptCmd = 1 To 3
		lRow = idw_LstwCommande.InsertRow ( 0 )
		idw_LstwCommande.SetItem ( lRow, "ID_MARQ_ART", "" )
		idw_LstwCommande.SetItem ( lRow, "ID_MODL_ART", "" )
		idw_LstwCommande.SetItem ( lRow, "ID_REF_FOUR", "" )
		idw_LstwCommande.SetItem ( lRow, "MT_TTC_CMDE", 0 )
	Next
End if
	
lTotCmd = idw_LstwCommande.RowCount () 

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

/*--------------------------------------------------------------------*/
/* 1 : Ligne du mail Destinataire --> 1ère ligne du fichier Texte qui */
/* devra être Découpé par EIN et placé en mail dest.                  */
/*--------------------------------------------------------------------*/

idw_WSin.GetChild ( "ID_ORIAN_BOUTIQUE", dwChild )
lRow2 = dwChild.Find ( "ID_BOUTIQUE = " + String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" )), 1, dwChild.RowCount () )
If lRow2 <= 0 Then 
	bRet = FALSE
	sMailDest = ""
Else 
	sMailDest = dwChild.GetItemString ( lRow2, "ADR_MAIL" )
End If	


/*------------------------------------------------------------------*/
/* 1.2 #1 : adresse de facturation.                                 */
/*------------------------------------------------------------------*/
sMailBody+= "ADRESSE_FACTURATION : SPB Mobistore Assurance Téléphonie Mobile 76095 LE HAVRE CEDEX" + sSaut

/*------------------------------------------------------------------*/
/* 2 : Référence SPB																  */
/*------------------------------------------------------------------*/
sMailBody+= "REFERENCE_SIN_SPB : " + sIdSin  +sSaut

/*------------------------------------------------------------------*/
/* 3 : Personne SPB à contacter.												  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "PERSONNE_SPB_A_CONTACTER : " + sSaut
sMailBody+= "N°_TELEPHONE_SPB : " + String ( idw_Produit.GetItemString ( 1, "NUM_TEL" ), "@@@@.@@@.@@@" ) + sSaut
sMailBody+="E-MAIL_EMETTEUR : assurancemobistore@spb.fr" + sSaut

/*------------------------------------------------------------------*/
/* 4 : Personne MOBISTORE à contacter.										  */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+= "COORDONNEES_BOUTIQUE : " + sSaut

sMailBody+= "NUM_TEL : " + dwChild.GetItemString ( lRow2, "ADR_TEL" ) + sSaut 

sMailBody+="E-MAIL : " + sMailDest + sSaut


/*------------------------------------------------------------------*/
/* 5 : Coordonnées de l'assuré et renseignements.					     */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+= "NOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" ))  + sSaut
sMailBody+= "PRENOM_ASSURE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" ))  + sSaut
sMailBody+= "ADRESSE_CLIENT_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR1" ))  + sSaut
sMailBody+= "ADRESSE_CLIENT_2 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR2" ))  + sSaut
sMailBody+="ADRESSE_CLIENT_3 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ))  + sSaut
sMailBody+= "CODE POSTAL : " + idw_LstwCommande.GetItemString ( 1, "ADR_CP" )   + sSaut
sMailBody+= "VILLE : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_VILLE" ) )  + sSaut
sMailBody+= "DATE_SURVENANCE_SINISTRE : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" )  + sSaut
sMailBody+="DATE_ACHAT_APPAREIL_SINISTRE : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" )  + sSaut  // [PI056]
sMailBody+=sSaut

sMailBody+="-- LES MONTANTS SONT EXPRIMES EN EUROS --"  + sSaut


/*------------------------------------------------------------------*/
/* 6 : Appareil à traiter														  */
/*------------------------------------------------------------------*/
If lIdTypMail =2 Then
	
	/*------------------------------------------------------------------*/
	/* Récupération du libellé du type d'appareil                       */
	/*------------------------------------------------------------------*/
	sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
	idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
	sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
	dwChild.SetFilter ( "" ) 
	dwChild.Filter ( ) 
	lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
	sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
	dwChild.SetFilter ( sFiltreOrigDDDW  ) 
	dwChild.Filter ( ) 

	sMailBody+="APPAREIL_A_REMETTRE_AU_CLIENT : " + sSaut
	sMailBody+=sSaut
End if

If lIdTypMail=3 Then // AEF
	sTypApp = uf_GestOng_Divers_Trouver ( "TYPE_APP" )
	sLibTypApp = Space ( 35 )
	SQLCA.IM_S01_CODECAR ("-AR", Upper ( sTypApp ), sLibTypApp )
	If IsNull ( sLibTypApp ) Then sLibTypApp = ""


	sMailBody+=sSaut
	sMailBody+=  "APPAREIL_A_EXPERTISER : " + sLibTypApp + " " + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) )  + sSaut
	sMailBody+=sSaut

	sMailBody+=  "DESCRIPTION_DU_DOMMAGE : "  + sSaut
	sVal = Upper ( idw_LstwCommande.GetItemString ( 1, "PROBLEME" ) )
	Do While Len ( sVal ) > 0 
		sMailBody+=  Left ( sVal, 60 )  + sSaut
		sVal = Mid ( sVal, 61, Len ( sVal ) ) 
	Loop
End if

If lIdTypMail=4 or lIdTypMail= 1 Then // Nomade ou Tel
	sMailBody+=sSaut
	
	If lIdTypMail=4 Then
		sMailBody+= "APPAREIL_A_REMPLACER : " + + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
	Else
		sMailBody+=  "MOBILE_A_REMPLACER : " + + Upper ( idw_wSin.GetItemString ( 1, "MARQ_PORT" ) ) + " " + Upper ( idw_wSin.GetItemString ( 1, "MODL_PORT" ) ) + sSaut
	End if

	sMailBody+=sSaut
	sMailBody+=  "PROPOSITION_1 : " + sSaut
	sMailBody+=  "MARQUE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_MODL_ART" ) ) + sSaut
	sMailBody+=  "PRIX_TTC_1 : " + String ( idw_LstwCommande.GetItemDecimal ( 1, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
	sMailBody+=  "REFEFERENCE_MOBISTORE_1 : " + Upper ( idw_LstwCommande.GetItemString ( 1, "ID_REF_FOUR" ) ) + sSaut

	sMailBody+=sSaut

	sMailBody+=  "PROPOSITION_2 : " + sSaut
	sMailBody+=  "MARQUE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_MODL_ART" ) ) + sSaut
	sMailBody+= "PRIX_TTC_2 : " + String ( idw_LstwCommande.GetItemDecimal ( 2, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
	sMailBody+=  "REFEFERENCE_MOBISTORE_2 : " + Upper ( idw_LstwCommande.GetItemString ( 2, "ID_REF_FOUR" ) ) + sSaut

	sMailBody+=sSaut

	sMailBody+=  "PROPOSITION_3 : " + sSaut
	sMailBody+=  "MARQUE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MARQ_ART" ) ) + " " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_MODL_ART" ) ) + sSaut
	sMailBody+=  "PRIX_TTC_3 : " + String ( idw_LstwCommande.GetItemDecimal ( 3, "MT_TTC_CMDE" ), "#####0.00" ) + sSaut
	sMailBody+=  "REFEFERENCE_MOBISTORE_3 : " + Upper ( idw_LstwCommande.GetItemString ( 3, "ID_REF_FOUR" ) ) + sSaut
End if

/*------------------------------------------------------------------*/
/* 7 : Montant Maximum majoré													  */
/*------------------------------------------------------------------*/
// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
// mémorisation de l'événement
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
dcMtMaxTTC = 0 
If lRow > 0 Then
	dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
End If


//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

sVal = ""
// [PC545].[BUG_BGE_721]
//	[PC363].[10%]
lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
sVal = "[###]"

If lRow > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
End If

// [PC301].[V15_EVOL_VETUSTE]
lTotDetail = idw_wDetail.RowCount ()
dcMtLu = 0
dcMtMaxLu = 0
For lCptDet = 1 To lTotDetail	
	
	sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
					"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
					"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
		
	lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
	If lRow > 0 Then
		dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
		If dcMtLu > dcMtMaxLu Then
			dcMtMaxLu = dcMtLu 
		End If
	End If					
	
Next

If dcMtMaxLu > 0 Then
	lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
End If
// [PC301].[V15_EVOL_VETUSTE]
// :[PC545].[BUG_BGE_721]

stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )

If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0

// [ITSM231230] pose d'un mouchard bloquant sur ITSM.
If dcMtMaxTTC = 0 Then
	stMessage.sTitre  	= "ITSM231230 Mouchard A.Haize"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= Ok!
	stMessage.sCode = "WSIN775"
	F_Message ( stMessage )
	bRet = False
	Return bRet
End If

sMailBody+=sSaut
sMailBody+="MONTANT_MAXIMUM_INDEMNISATION_TTC : " +  String ( dcMtMaxTTC , "#####0.00" ) + sSaut

sMailBody+=sSaut

/*------------------------------------------------------------------*/
/* 8 : GSM à remettre au client												  */
/*--------------------------------------*/
sMailBody+=sSaut
Choose Case lIdTypMail
	Case 1
		sMailBody+= "MOBILE_A_REMETTRE_AU_CLIENT : " + sSaut 
	Case 4
		sMailBody+= "APPAREIL_A_REMETTRE_AU_CLIENT : " + sSaut 
	Case Else
		sMailBody+=sSaut
		sMailBody+= "APPAREIL_A_REMETTRE_AU_CLIENT SI REMPLACEMENT ACCEPTE : " + sSaut 
End Choose

sMailBody+=sSaut
sMailBody+= "CLIENT PASSE AU MAGASIN : " + sSaut
sMailBody+= "CODE_DU_MAGASIN : " + Upper ( String ( idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ) ) ) + sSaut

sNomMagasin = Fill ( " ", 35 )
SQLCA.PS_S01_BOUTIQUE ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) , idw_WSin.GetItemNumber ( 1, "ID_ORIAN_BOUTIQUE" ), sNomMagasin ) 
If sNomMagasin = "" Or IsNull ( sNomMagasin ) Then sNomMagasin = "AUCUNE REF. SUR CE CODE MAG."

sMailBody+= "NOM_DU_MAGASIN : " + Upper ( sNomMagasin ) + sSaut

If lIdTypMail=3 Then
	/*------------------------------------------------------------------*/
	/* 9 : Etat de retour pour ATECH 					     */
	/*------------------------------------------------------------------*/
	sMailBody+=sSaut
	sMailBody+=sSaut
	sMailBody+= "=========================================================================" + sSaut
	sMailBody+="===== ZONE RESERVEE A ATECH POUR LE RESULTAT DE L'EXPERTISE ======" + sSaut
	sMailBody+= "=========== MARQUER D'UN 'X' L'ETAT DE PRESTATION CORRESPONDANT =========" + sSaut
	sMailBody+="=========================================================================" + sSaut
	sMailBody+=sSaut
	sMailBody+="DATE_EXPERTISE :   _ _ / _ _ / _ _ _ _" + sSaut
	sMailBody+=sSaut
	sMailBody+= "ETAT_PRESTATION_1 :  |_| SUITE EXPERTISE, REMPLACEMENT ACCEPTE" + sSaut
	sMailBody+=sSaut
	sMailBody+= "ETAT_PRESTATION_2 :  |_| SUITE EXPERTISE, REMPLACEMENT REFUSE" + sSaut
End if

//* F_Plafond_Pec 
//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
//*					  Pour le type Autre, le retour est sous cette forme
//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "M0"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )

bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If



Return bRet

end function

private subroutine uf_determiner_courrier_forcage_mbs (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_MBS (PRIVATE)
//* Auteur        : FPI
//* Date          : 08/09/2015
//* Libellé       : 
//* Commentaires  : [PC13442-2]
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech
Long   				lDeb, lFin, lTotCourrier, lLig, lCpt, lRow
string				sTypApp, sAdrMail
Boolean				bCondition			

sIdNatCourForcage=""

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 274 )
If lDeb <= 0 Then Return 

// Ce cas n'est que pour le siège de PhoneCity
If idw_wsin.GetItemNumber(1,"ID_ORIAN_BOUTIQUE") <> 1 Then return

lRow=idw_lstgti.Find("ID_GTI=10",1,idw_lstgti.RowCount())
If lRow > 0 Then
	sIdNatCourForcage=lnvPFCString.of_getkeyvalue( idw_DetPro.GetItemString(lDeb,"VAL_CAR"), "ID_COUR_VOL_SIEGE",";")
Else
	sIdNatCourForcage=lnvPFCString.of_getkeyvalue( idw_DetPro.GetItemString(lDeb,"VAL_CAR"), "ID_COUR_SIEGE_DOM_OXY",";")
End if

bCondition = asPos = "" &
					And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" &
					And sIdNatCourForcage <> "" &
					And idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR = 'MBS' AND ID_TYP_ART = 'CAF'", 1, idw_LstwCommande.rowCount()+1 ) > 0 
			
If isnull(sIdNatCourForcage) Then sIdNatCourForcage=""

If bCondition Then

		sIdNatPresent = asIdNatCour
		
		If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

		If sIdNatPresent <> sIdNatCourForcage Then

			If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= sIdNatCourForcage
				
			Else
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= asIdNatCour
				stMessage.sVar[2] 	= sIdNatCourForcage
			End If 
			
			If F_Message ( stMessage ) = 1 Then

				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!							

				idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
				lTotCourrier	= dwChild.RowCount ()
				sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
				lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
		
		/*------------------------------------------------------------------*/
		/* On verifie si la nature de courrier existe. Si elle n'existe     */
		/* pas, par un effet du hasard bien sur, on arrete le traitement    */
		/* et on positionne sur REF_CIE.                                    */
		/*------------------------------------------------------------------*/
				If	lLig = 0	Then
		
		/*------------------------------------------------------------------*/
		/* On arme la structure de message maintenant, mais le message va   */
		/* être affiché dans le contrôle de gestion.                        */
		/*------------------------------------------------------------------*/
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= Information!
					stMessage.sCode		= "WSIN170"
					stMessage.sVar[1] 	= sIdNatCourForcage
					asPos = "REF_CIE"
				Else
					If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
						asIdNatCour = sIdNatCourForcage
						asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
						
						idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
						idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
						idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
					Else 
						// Le message est armé dans uf_GestionCP
						asPos = "REF_CIE"

					End If
				End If		
			End If
		End If
End If


end subroutine

private function string uf_controlergestion_cplt_adh_paybox (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_Cplt_Adh_PayBox
//* Auteur			: Fabry JF
//* Date				: 12/10/2015
//* Libellé			: 
//* Commentaires	: [PC694-4]
//*
//* Arguments		: asCas
//*
//* Retourne		: 
//*
//*-----------------------------------------------------------------
//* MAJ   Date	      Modification
//  FPI	12/03/2018 [PI056] - dte_fin_gti en datetime
//  JFF  01/06/2018 [PC151425-1]
//  JFF  11/06/2018 [PC151425-1]
//  JFF  19/03/2019 [PC151425-1][V4]
//  JFF  16/08/2022 [EVOL_CTRLE_SMAIN]
//  JFF   26/09/2023 [RS5928_FRCH_CHQ]
//*-----------------------------------------------------------------
String sPos, sIdPara, sCptVer, sLibPce, sVal 
Long   lDeb, lFin, lVal1, lTot, lCpt, lIdGti, lCodePce, lRow, lIdPce, lCptTri, lIdSin, lCodePcePB, lCodePceDBL 
Date 	 dDteFinGti, dDteAdh, dtValDate, dtCreeLeParam, dtPivotFranchisePBox
n_cst_string lnvPFCString
Integer iPerCtrleMois, iCodEtat, iCodEtatBase 
Boolean bCpltAdhPaye, bCtrleGti, bMsgGeneral, bFranchisePaye, bPceDBL, bPrestaValidees 

sPos = ""
bCtrleGti = False
bMsgGeneral = False
bCpltAdhPaye = False
bFranchisePaye = False
bPceDBL = False

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 291)
If lDeb <= 0 Then Return ""

dtCreeLeParam = Date ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DTE_EFFET_CREE_LE_DOS", ";"))
If Date ( idw_Wsin.GetItemDateTime ( 1, "CREE_LE" )) < dtCreeLeParam Then Return ""

// [PC151425-1]
/*
If F_CLE_A_TRUE ( "PC151425-1" ) Then
	dtPivotFranchisePBox = Date ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DTE_EFFET_FRANCHISE_PBOX", ";"))
	If Date ( idw_Wsin.GetItemDateTime ( 1, "CREE_LE" )) < dtPivotFranchisePBox Then bFranchisePaye = TRUE
	
	// [PC151425-1]
	lCodePcePB = Long ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "CODE_PCE_PB", ";") )

	// [PC151425-1][V4]
	lCodePceDBL = Long ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "CODE_PCE_DBL", ";") )	
End If 
*/

iPerCtrleMois = Long ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "PER_CTRL_MOIS", ";") )
lCodePce = Long ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "CODE_PCE", ";") )

iCodEtat = idw_Wsin.GetItemNumber ( 1, "COD_ETAT" )
iCodEtatBase = idw_Wsin.GetItemNumber ( 1, "COD_ETAT", primary!, TRUE )
dDteAdh = idw_Wsin.GetItemDate ( 1, "DTE_ADH" )
dDteFinGti = Date(idw_Wsin.GetItemDateTime ( 1, "DTE_FIN_GTI" ) ) // [PI056]


// [EVOL_CTRLE_SMAIN]
idw_LstwCommande.SetFilter (  "COD_ETAT NOT IN ( 'CNV' )" )
idw_LstwCommande.Filter ()
lTot = idw_LstwCommande.RowCount ()

bPrestaValidees = lTot > 0 

idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ()
idw_LstwCommande.Sort ()


If IsNull ( dDteAdh ) Or IsNull ( dDteFinGti ) Then
	stMessage.sTitre		= "PC694-4 : Smaïn Krizez"
	stMessage.Icon			= exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "WSIN795"
	stMessage.Bouton		= OK!

	sPos = "ALT_BLOC"

	If asCas = "OUVERTURE" Then
		F_Message ( stMessage )
	End If

	Return sPos 
End If

sVal = This.uf_GestOng_Divers_Trouver ( "DTE_CMPLT_ADH_PAYE_ASS_PAYBOX" )
If IsNull ( sVal ) Then sVal = ""
bCpltAdhPaye = Trim ( sVal ) <> ""

// [PC151425-1]
/*
If F_CLE_A_TRUE ( "PC151425-1" ) Then
	If Not bFranchisePaye Then
		sVal = This.uf_GestOng_Divers_Trouver ( "DTE_FRANCHISE_PAYE_ASS_PAYBOX" )
		If IsNull ( sVal ) Then sVal = ""
		bFranchisePaye = Trim ( sVal ) <> ""
	End If 
End If
*/

dtValDate = F_Plus_Date ( dDteAdh, iPerCtrleMois, "M" )
dtValDate = F_Plus_Date ( dtValDate, -1, "J" )

// -	Contrôle : Si la dte_fin_gti - dte_adh < 13 mois ET « Complément adhésion payé par PayBox » non coché sur divers Alors
// [PC151425-1]
/*
If F_CLE_A_TRUE ( "PC151425-1" ) Then
	// [EVOL_CTRLE_SMAIN]
	If Not ( ( &
					( dDteFinGti < dtValDate And Not bCpltAdhPaye ) &
					 Or &
					 Not bFranchisePaye &
				) &
				And iCodEtat <> 200 &
				And iCodEtat <> 900 &
				And iCodEtatBase <> 550 &
				And iCodEtatBase <> 600 &
				And Not bPrestaValidees &
			 ) Then Return ""
Else */
	// [EVOL_CTRLE_SMAIN]
	If Not ( dDteFinGti < dtValDate And &
				Not bCpltAdhPaye &
				And iCodEtat <> 200 &
				And iCodEtat <> 900 &
				And iCodEtatBase <> 550 &
				And iCodEtatBase <> 600 &
				And Not bPrestaValidees &
			 ) Then Return ""
// End If			 

If asCas = "OUVERTURE" Then
	
	stMessage.sTitre		= "PC694-4 : Smaïn Krizez"
	stMessage.Icon			= exclamation!
	stMessage.bErreurG	= FALSE

	// [PC151425-1]
	/*
	If F_CLE_A_TRUE ( "PC151425-1" ) Then
		
		If dDteFinGti < dtValDate And bFranchisePaye And Date ( idw_Wsin.GetItemDateTime ( 1, "CREE_LE" )) < dtPivotFranchisePBox Then 

			// [RS5928_FRCH_CHQ]
			stMessage.sCode		= "WSIN900"	
		
			stMessage.sVar [1]   = String ( lCodePce )	
		End If
		
		If dDteFinGti >= dtValDate And Not bFranchisePaye Then 
			stMessage.sCode		= "WSIN823"	
			stMessage.sVar [1]   = String ( lCodePcePB )		
		End If

		If dDteFinGti < dtValDate And Not bCpltAdhPaye And Not bFranchisePaye Then 		
			// [PC151425-1][V4]
			stMessage.sCode		= "WSIN843"	// Ancien WSIN796
			stMessage.sVar [1]   = String ( lCodePceDBL )
		End If
	Else */
		// [RS5928_FRCH_CHQ]
		stMessage.sCode		= "WSIN900"	

		stMessage.sVar [1]   = String ( lCodePce )		
//	End If 
	

	stMessage.Bouton		= OK!
	F_Message ( stMessage )

	sPos = "ALT_BLOC"

	Return sPos 
End If


idw_wDivDet.SetFilter ( "UPPER ( NOM_ZONE ) = 'ALT_PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )" )
idw_wDivDet.Filter ()
lTot = idw_wDivDet.RowCount ()

For lCpt = lTot To 1 Step -1
	idw_wDivDet.DeleteRow ( lCpt ) 
	bMsgGeneral = True
Next 
idw_wDivDet.SetFilter ( "" )
idw_wDivDet.Filter ()
idw_wDivDet.Sort ()


idw_wDivDet.SetFilter ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )" )
idw_wDivDet.Filter ()
lTot = idw_wDivDet.RowCount ()

For lCpt = lTot To 1 Step -1
	idw_wDivDet.DeleteRow ( lCpt ) 
	bMsgGeneral = True
Next 
idw_wDivDet.SetFilter ( "" )
idw_wDivDet.Filter ()
idw_wDivDet.Sort ()


idw_wDivDet.SetFilter ( "UPPER ( NOM_ZONE ) = 'MT_PEC' AND VAL_MT > 0" )
idw_wDivDet.Filter ()
lTot = idw_wDivDet.RowCount ()

For lCpt = lTot To 1 Step -1
	idw_wDivDet.DeleteRow ( lCpt )
	bMsgGeneral = True
Next 
idw_wDivDet.SetFilter ( "" )
idw_wDivDet.Filter ()
idw_wDivDet.Sort ()


idw_wDivDet.SetFilter ( "UPPER ( NOM_ZONE ) = 'ALT_PLAF_PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )" )
idw_wDivDet.Filter ()
lTot = idw_wDivDet.RowCount ()

For lCpt = lTot To 1 Step -1
	idw_wDivDet.DeleteRow ( lCpt ) 
	bMsgGeneral = True
Next 
idw_wDivDet.SetFilter ( "" )
idw_wDivDet.Filter ()
idw_wDivDet.Sort ()


idw_wDivDet.SetFilter ( "UPPER ( NOM_ZONE ) = 'DTE_PEC' AND NOT ISNULL ( VAL_DTE )" )
idw_wDivDet.Filter ()
lTot = idw_wDivDet.RowCount ()

For lCpt = lTot To 1 Step -1
	idw_wDivDet.DeleteRow ( lCpt ) 
	bMsgGeneral = True
Next 
idw_wDivDet.SetFilter ( "" )
idw_wDivDet.Filter ()
idw_wDivDet.Sort ()


idw_wDetail.SetFilter ( "COD_ETAT = 500" )
idw_wDetail.Filter ()
lTot = idw_wDetail.RowCount ()

For lCpt = lTot To 1 Step -1
	idw_wDetail.SetItem ( lCpt, "ALT_ATT", "O" ) 
	idw_wDetail.SetItem ( lCpt, "COD_ETAT", 0 ) 
	bCtrleGti = TRUE
	bMsgGeneral = True
Next 
idw_wDetail.SetFilter ( "" )
idw_wDetail.Filter ()
idw_wDetail.Sort ()


idw_LstwCommande.SetFilter (  "COD_ETAT <> 'ANN'" )
idw_LstwCommande.Filter ()
lTot = idw_LstwCommande.RowCount ()

For lCpt = lTot To 1 Step -1
	idw_LstwCommande.DeleteRow ( lCpt )
	bMsgGeneral = True
Next 
idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ()
idw_LstwCommande.Sort ()

lTot = idw_LstGti.RowCount ()

// [PC151425-1]
/*
If F_CLE_A_TRUE ( "PC151425-1" ) Then
	For lCpt = lTot To 1 Step -1
		lIdSin = idw_LstGti.GetItemNumber ( lCpt, "ID_SIN" ) 
		lIdGti = idw_LstGti.GetItemNumber ( lCpt, "ID_GTI" ) 
		
		If bCtrleGti Then 
			idw_LstGti.SetItem ( lCpt, "COD_ETAT", 0 ) 	
		End If

		// [PC151425-1][V4]
		If dDteFinGti < dtValDate And Not bCpltAdhPaye And  Not bFranchisePaye Then 
			If idw_wPiece.Find ( "ID_GTI = " + String ( lIdGti ) + &
									  " AND ID_PCE = " + String ( lCodePceDBL ) + &
									  " AND ID_I = 0", 1, idw_wPiece.RowCount () ) > 0 Then
				
				bPceDBL = True

			Else 
		
				lRow = idw_Piece.Find ( &
					"     ID_GTI = " + String ( lIdGti ) + &
					" AND ID_PCE = " + String ( lCodePceDBL ) + & 
					" AND COD_TYP_PCE = 'G'" , 1, idw_Piece.RowCount () ) 
				
				If lRow <= 0 Then 
					stMessage.sTitre		= "PC694-4 : Smaïn Krizez"
					stMessage.Icon			= exclamation!
					stMessage.bErreurG	= FALSE
					stMessage.sCode		= "WSIN793"
					stMessage.Bouton		= OK!
					stMessage.sVar [1]   = String ( lCodePceDBL )
				
					sPos = "ALT_BLOC"
				
					Return sPos 
				End If
				
				lIdPce  = idw_Piece.GetItemNumber ( lRow, "ID_PCE" )
				sIdPara = idw_Piece.GetItemString ( lRow, "ID_PARA" )
				lCptTri = idw_Piece.GetItemNumber ( lRow, "CPT_TRI" )
				sCptVer = idw_Piece.GetItemString ( lRow, "CPT_VER" )
				sLibPCe = idw_Piece.GetItemString ( lRow, "LIB_CODE" )
				
				lRow = idw_wPiece.InsertRow ( 0 )
				idw_wPiece.SetItem ( lRow, "ID_SIN", lIdSin )
				idw_wPiece.SetItem ( lRow, "ID_GTI", lIdGti )
				idw_wPiece.SetItem ( lRow, "ID_DETAIL", -1 )
				idw_wPiece.SetItem ( lRow, "ID_PCE", lIdPce )
				idw_wPiece.SetItem ( lRow, "ID_I", 0 )
				idw_wPiece.SetItem ( lRow, "ID_PARA", sIdPara )
				idw_wPiece.SetItem ( lRow, "CPT_TRI", lCptTri )
				idw_wPiece.SetItem ( lRow, "CREE_LE", stNul.dtm )
				idw_wPiece.SetItem ( lRow, "MAJ_LE", stNul.dtm )
				idw_wPiece.SetItem ( lRow, "MAJ_PAR", stGlb.sCodOper )
				idw_wPiece.SetItem ( lRow, "CPT_VER", sCptVer )
				idw_wPiece.SetItem ( lRow, "ALT_RECLAME", "O" )
				idw_wPiece.SetItem ( lRow, "LIB_PCE", sLibPCe )
				idw_wPiece.SetItem ( lRow, "ALT_RECLAME_AVANT", "N" )
				idw_wPiece.SetItem ( lRow, "ID_I_AVANT", stNul.iNum )
				
				bMsgGeneral = True
				
				bPceDBL = True
				
			End If
		End If		


		If dDteFinGti < dtValDate And Not bCpltAdhPaye And Not bPceDBL Then 
			If idw_wPiece.Find ( "ID_GTI = " + String ( lIdGti ) + &
									  " AND ID_PCE = " + String ( lCodePce ) + &
									  " AND ID_I = 0", 1, idw_wPiece.RowCount () ) <= 0 Then
		
				lRow = idw_Piece.Find ( &
					"     ID_GTI = " + String ( lIdGti ) + &
					" AND ID_PCE = " + String ( lCodePce ) + & 
					" AND COD_TYP_PCE = 'G'" , 1, idw_Piece.RowCount () ) 
				
				If lRow <= 0 Then 
					stMessage.sTitre		= "PC694-4 : Smaïn Krizez"
					stMessage.Icon			= exclamation!
					stMessage.bErreurG	= FALSE
					stMessage.sCode		= "WSIN793"
					stMessage.Bouton		= OK!
					stMessage.sVar [1]   = String ( lCodePce )
				
					sPos = "ALT_BLOC"
				
					Return sPos 
				End If
				
				lIdPce  = idw_Piece.GetItemNumber ( lRow, "ID_PCE" )
				sIdPara = idw_Piece.GetItemString ( lRow, "ID_PARA" )
				lCptTri = idw_Piece.GetItemNumber ( lRow, "CPT_TRI" )
				sCptVer = idw_Piece.GetItemString ( lRow, "CPT_VER" )
				sLibPCe = idw_Piece.GetItemString ( lRow, "LIB_CODE" )
				
				lRow = idw_wPiece.InsertRow ( 0 )
				idw_wPiece.SetItem ( lRow, "ID_SIN", lIdSin )
				idw_wPiece.SetItem ( lRow, "ID_GTI", lIdGti )
				idw_wPiece.SetItem ( lRow, "ID_DETAIL", -1 )
				idw_wPiece.SetItem ( lRow, "ID_PCE", lIdPce )
				idw_wPiece.SetItem ( lRow, "ID_I", 0 )
				idw_wPiece.SetItem ( lRow, "ID_PARA", sIdPara )
				idw_wPiece.SetItem ( lRow, "CPT_TRI", lCptTri )
				idw_wPiece.SetItem ( lRow, "CREE_LE", stNul.dtm )
				idw_wPiece.SetItem ( lRow, "MAJ_LE", stNul.dtm )
				idw_wPiece.SetItem ( lRow, "MAJ_PAR", stGlb.sCodOper )
				idw_wPiece.SetItem ( lRow, "CPT_VER", sCptVer )
				idw_wPiece.SetItem ( lRow, "ALT_RECLAME", "O" )
				idw_wPiece.SetItem ( lRow, "LIB_PCE", sLibPCe )
				idw_wPiece.SetItem ( lRow, "ALT_RECLAME_AVANT", "N" )
				idw_wPiece.SetItem ( lRow, "ID_I_AVANT", stNul.iNum )
				
				bMsgGeneral = True
			End If
		End If		
		
		If Not bFranchisePaye And Not bPceDBL Then 
			If idw_wPiece.Find ( "ID_GTI = " + String ( lIdGti ) + &
									  " AND ID_PCE = " + String ( lCodePcePB ) + &
									  " AND ID_I = 0", 1, idw_wPiece.RowCount () ) <= 0 Then
		
				lRow = idw_Piece.Find ( &
					"     ID_GTI = " + String ( lIdGti ) + &
					" AND ID_PCE = " + String ( lCodePcePB ) + & 
					" AND COD_TYP_PCE = 'G'" , 1, idw_Piece.RowCount () ) 
				
				If lRow <= 0 Then 
					stMessage.sTitre		= "PC694-4 : Smaïn Krizez"
					stMessage.Icon			= exclamation!
					stMessage.bErreurG	= FALSE
					stMessage.sCode		= "WSIN793"
					stMessage.Bouton		= OK!
					stMessage.sVar [1]   = String ( lCodePcePB )
				
					sPos = "ALT_BLOC"
				
					Return sPos 
				End If
				
				lIdPce  = idw_Piece.GetItemNumber ( lRow, "ID_PCE" )
				sIdPara = idw_Piece.GetItemString ( lRow, "ID_PARA" )
				lCptTri = idw_Piece.GetItemNumber ( lRow, "CPT_TRI" )
				sCptVer = idw_Piece.GetItemString ( lRow, "CPT_VER" )
				sLibPCe = idw_Piece.GetItemString ( lRow, "LIB_CODE" )
				
				lRow = idw_wPiece.InsertRow ( 0 )
				idw_wPiece.SetItem ( lRow, "ID_SIN", lIdSin )
				idw_wPiece.SetItem ( lRow, "ID_GTI", lIdGti )
				idw_wPiece.SetItem ( lRow, "ID_DETAIL", -1 )
				idw_wPiece.SetItem ( lRow, "ID_PCE", lIdPce )
				idw_wPiece.SetItem ( lRow, "ID_I", 0 )
				idw_wPiece.SetItem ( lRow, "ID_PARA", sIdPara )
				idw_wPiece.SetItem ( lRow, "CPT_TRI", lCptTri )
				idw_wPiece.SetItem ( lRow, "CREE_LE", stNul.dtm )
				idw_wPiece.SetItem ( lRow, "MAJ_LE", stNul.dtm )
				idw_wPiece.SetItem ( lRow, "MAJ_PAR", stGlb.sCodOper )
				idw_wPiece.SetItem ( lRow, "CPT_VER", sCptVer )
				idw_wPiece.SetItem ( lRow, "ALT_RECLAME", "O" )
				idw_wPiece.SetItem ( lRow, "LIB_PCE", sLibPCe )
				idw_wPiece.SetItem ( lRow, "ALT_RECLAME_AVANT", "N" )
				idw_wPiece.SetItem ( lRow, "ID_I_AVANT", stNul.iNum )
				
				bMsgGeneral = True
			End If
		End If		
	Next 
	
Else */
	For lCpt = lTot To 1 Step -1
		lIdSin = idw_LstGti.GetItemNumber ( lCpt, "ID_SIN" ) 
		lIdGti = idw_LstGti.GetItemNumber ( lCpt, "ID_GTI" ) 
		
		If bCtrleGti Then 
			idw_LstGti.SetItem ( lCpt, "COD_ETAT", 0 ) 	
		End If
	
		If idw_wPiece.Find ( "ID_GTI = " + String ( lIdGti ) + &
								  " AND ID_PCE = " + String ( lCodePce ) + &
								  " AND ID_I = 0", 1, idw_wPiece.RowCount () ) > 0 Then
			Continue
		End If
	
		lRow = idw_Piece.Find ( &
			"     ID_GTI = " + String ( lIdGti ) + &
			" AND ID_PCE = " + String ( lCodePce ) + & 
			" AND COD_TYP_PCE = 'G'" , 1, idw_Piece.RowCount () ) 
		
		If lRow <= 0 Then 
			stMessage.sTitre		= "PC694-4 : Smaïn Krizez"
			stMessage.Icon			= exclamation!
			stMessage.bErreurG	= FALSE
			stMessage.sCode		= "WSIN793"
			stMessage.Bouton		= OK!
			stMessage.sVar [1]   = String ( lCodePce )
		
			sPos = "ALT_BLOC"
		
			Return sPos 
		End If
		
		lIdPce  = idw_Piece.GetItemNumber ( lRow, "ID_PCE" )
		sIdPara = idw_Piece.GetItemString ( lRow, "ID_PARA" )
		lCptTri = idw_Piece.GetItemNumber ( lRow, "CPT_TRI" )
		sCptVer = idw_Piece.GetItemString ( lRow, "CPT_VER" )
		sLibPCe = idw_Piece.GetItemString ( lRow, "LIB_CODE" )
		
		lRow = idw_wPiece.InsertRow ( 0 )
		idw_wPiece.SetItem ( lRow, "ID_SIN", lIdSin )
		idw_wPiece.SetItem ( lRow, "ID_GTI", lIdGti )
		idw_wPiece.SetItem ( lRow, "ID_DETAIL", -1 )
		idw_wPiece.SetItem ( lRow, "ID_PCE", lIdPce )
		idw_wPiece.SetItem ( lRow, "ID_I", 0 )
		idw_wPiece.SetItem ( lRow, "ID_PARA", sIdPara )
		idw_wPiece.SetItem ( lRow, "CPT_TRI", lCptTri )
		idw_wPiece.SetItem ( lRow, "CREE_LE", stNul.dtm )
		idw_wPiece.SetItem ( lRow, "MAJ_LE", stNul.dtm )
		idw_wPiece.SetItem ( lRow, "MAJ_PAR", stGlb.sCodOper )
		idw_wPiece.SetItem ( lRow, "CPT_VER", sCptVer )
		idw_wPiece.SetItem ( lRow, "ALT_RECLAME", "O" )
		idw_wPiece.SetItem ( lRow, "LIB_PCE", sLibPCe )
		idw_wPiece.SetItem ( lRow, "ALT_RECLAME_AVANT", "N" )
		idw_wPiece.SetItem ( lRow, "ID_I_AVANT", stNul.iNum )
		
		bMsgGeneral = True
		
	Next 
// End If

If bMsgGeneral Then
	sPos = "ALT_BLOC" // Pour recontrôler les garanties & détails
	stMessage.sTitre		= "PC694-4 : Smaïn Krizez"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE

	// [PC151425-1]
/*	
	If F_CLE_A_TRUE ( "PC151425-1" ) Then
		
		If dDteFinGti < dtValDate And bFranchisePaye And Date ( idw_Wsin.GetItemDateTime ( 1, "CREE_LE" )) < dtPivotFranchisePBox Then 

			// [RS5928_FRCH_CHQ]
			stMessage.sCode		= "WSIN899"					

			stMessage.sVar [1]   = String ( lCodePce )	
		End If
		
		If dDteFinGti >= dtValDate And Not bFranchisePaye Then 
			stMessage.sCode		= "WSIN825"	
			stMessage.sVar [1]   = String ( lCodePcePB )		
		End If

		If dDteFinGti < dtValDate And Not bCpltAdhPaye And Not bFranchisePaye Then 		
			// [PC151425-1][V4]
			stMessage.sCode		= "WSIN844"	
			stMessage.sVar [1]   = String ( lCodePceDBL )		
		End If
	Else */

		// [RS5928_FRCH_CHQ]
		stMessage.sCode		= "WSIN899"					
		
		stMessage.sVar [1]   = String ( lCodePce )
//	End If 
	
	stMessage.Bouton		= OK!
	
	sPos = "ALT_BLOC"
End If 



Return sPos


end function

private function boolean uf_validation_finale_samsung_mail_refus ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_SAMSUNG_Mail_Refus  (PRIVATE)
//* Auteur        : JFF
//* Date          : 06/01/2015
//* Libellé       : Gestion Particulière pour SAMSUNG
//* Commentaires  :	[PC13313]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 			FPI		27/12/2011	[PC469-1.NDCV2] Modif de l'objet du mail
//*-----------------------------------------------------------------

Boolean bRet
String  sIdSin, sFic,  sNumIncident
String    sVal,   sMailDest, sNomAssure
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv, sGti
String sMarque, sModele
Blob    bMailBody
Long 	 lRow, iIdAppli, lDeb, lFin, lRowAssure
DataWindowChild dwchild
n_cst_string lnvPFCString

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 294 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL", ";")

sTypMail = "SAMREF"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

If idw_wsin.getItemNumber(1,"COD_ETAT") <>  200  Then Return TRUE


// N° d'incident
sNumIncident=""
lRow=idw_wdivsin.Find("Upper(NOM_ZONE) = 'NUM_HOT_LINE'",1,idw_wdivsin.RowCount())
If lRow > 0 Then sNumIncident=idw_wdivsin.GetItemString(lRow,"VAL_CAR")
If IsNull ( sNumIncident ) Then sNumIncident = ""

If IsNull ( sMailDest ) Then sMailDest = ""

// Assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )

lRowAssure=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())

// Gti
If idw_lstgti.Find("ID_GTI=10",1,idw_lstgti.RowCount()) > 0 Then
	sGti="vol"
Else
	sGti="dommage"
End if

sMarque = F_GetItem3 ( idw_wsin, 1, "MARQ_PORT" ) 
sModele = F_GetItem3 ( idw_wsin, 1, "MODL_PORT" ) 

//sMailObjet = "[Case#" + sNumIncident + "] Refus sinistre n° " + sIdSin
sMailObjet = "Refus sinistre n° " + sIdSin + "/n° certificat " + F_GetItem3 ( idw_WSin, 1, "ID_CONTRAT_ABONNE" ) 

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Suite à la déclaration d'un " + sGti + " dans le cadre de l'Assurance Garanties Dommages Smartphone & Tablette option B2B, nous vous informons du refus de prise en charge."
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Dossier : " + sIdSin 
sMailBody += sSaut
sMailBody += sSaut


sMailBody += sNomAssure
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_1" )) 


sVal = Upper ( F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_2"  )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sMailBody += sSaut
sMailBody += F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_CP" ) + " " + Upper ( F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Tél. : " + F_GetItem3 ( idw_lstinter, lRowAssure, "NUM_TELD" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Modèle : " + sMarque + " " + sModele 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° de série : " + F_GetItem3 ( idw_WSin, 1, "NUM_IMEI_PORT" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° de certificat : " + F_GetItem3 ( idw_WSin, 1, "ID_CONTRAT_ABONNE" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Cordialement,"
sMailBody += sSaut
sMailBody += Trim ( stGlb.sNomOper ) + " " + Trim ( stGlb.sPrenomOper )
sMailBody += sSaut
sMailBody += "SPB"
sMailBody += sSaut
sMailBody += "SAMSUNG - Garanties Dommages Smartphone & Tablette"
sMailBody += sSaut
sMailBody += "CS 90000"
sMailBody += sSaut
sMailBody += "76095 LE HAVRE CEDEX"
sMailBody += sSaut
sMailBody += "Fax : " + String ( idw_Produit.GetItemString ( 1, "NUM_FAX" ), "(@)@@@.@@@.@@@" ) 



// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_validation_finale_samsung_mail_rempl ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Samsung_Mail_Rempl  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 06/01/2016
//* Libellé       : Gestion Particulière pour SAMSUNG.
//* Commentaires  : [PC13313]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			FPI		14/02/2013	[PC467-2]
//			FPI		27/01/2014	[PC988]
//			FPI		22/04/2014	[VDoc14051]
//			FPI		02/10/2014	[VDOC15495]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sNomMagasin, sIdGti, sLibGti, sIdEvt
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sRepSav, sMailDest, sTelDest
String  sMailBody, sSaut, sMailObjet, sBoiteMail, sTypMail, sAdrLibCiv, sLibFour, sNomAssure, sMarque, sModele
Blob    bMailBody
Date    dVal
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lRow2, iIdAppli, lDeb, lFin, lRowAssure
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
String sCas, sIdFour

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 294 )
If lDeb <= 0 Then Return True

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
sMailDest =  lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL", ";")
sTypMail = "SAMRMP"
iIdAppli = 2  // SIMPA2
sMailBody = ""
sMailObjet= ""
sSaut = char (10 )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
sFiltre = "ID_TYP_ART IN ( 'TEL', 'TPC' ) AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN  ('CDP','CIS', 'WBA') "


/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

/*------------------------------------------------------------------*/
/* Pas de prestation trouvée, donc problème dans ce cas de gestion. */
/*------------------------------------------------------------------*/
//#1 Ajout
If lTotCmd <= 0 Then Return TRUE

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers DARTY ASS.on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.sVar[1]    = "ECONOCOM"
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD321"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdFour=idw_LstwCommande.GetItemString (1, "ID_FOUR")

Choose Case sIdFour
	Case "CDP"
		sLibFour = "C-DiscountPRO"
	Case "CIS"
		sLibFour = "CORIOLIS"
	Case Else 
		sLibFour = "notre prestataire"
End Choose 

// mémorisation de la garantie
lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )

Choose Case sIdGti
	Case "10"
		sLibGti = "vol"
	Case "11"
		sLibGti = "bris"
	Case Else 
		sLibGti = "GTI_NON_DEFINI_SOUS_uf_Validation_Finale_ECO_Mail_RemplPC"  
End Choose

If IsNull ( sMailDest ) Then sMailDest = ""

// Assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )

lRowAssure=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())

sMarque = F_GetItem3 ( idw_wsin, 1, "MARQ_PORT" ) 
sModele = F_GetItem3 ( idw_wsin, 1, "MODL_PORT" ) 

sMailObjet = "Envoi appareil de remplacement SPB sinistre n° " + sIdSin + "/n° certificat " + F_GetItem3 ( idw_WSin, 1, "ID_CONTRAT_ABONNE" ) 

sMailBody += "Bonjour,"
sMailBody += sSaut
sMailBody += sSaut

sMailBody += "Dans le cadre de la garantie SAMSUNG - Dommages Smartphone & Tablette option B2B, nous vous informons de l’envoi de l’appareil de remplacement chez CEAT par l’intermédiaire de " + sLibFour + "."
sMailBody += ""

sMailBody += sSaut
sMailBody += sSaut

sMailBody += sNomAssure
sMailBody += sSaut
sMailBody += Upper ( F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_1" )) 


sVal = Upper ( F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_2"  )) 
If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 Then
	sMailBody += sSaut
	sMailBody += sVal 
End If

sMailBody += sSaut
sMailBody += F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_CP" ) + " " + Upper ( F_GetItem3 (  idw_lstinter, lRowAssure, "ADR_VILLE" ) ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Tél. : " + F_GetItem3 ( idw_lstinter, lRowAssure, "NUM_TELD" ) 
sMailBody += sSaut
sMailBody += "Dossier : " + sIdSin 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Modèle : " + sMarque + " " + sModele 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° de série : " + F_GetItem3 ( idw_WSin, 1, "NUM_IMEI_PORT" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "N° de certificat : " + F_GetItem3 ( idw_WSin, 1, "ID_CONTRAT_ABONNE" ) 
sMailBody += sSaut
sMailBody += sSaut
sMailBody += sSaut
sMailBody += "Cordialement,"
sMailBody += sSaut
sMailBody += Trim ( stGlb.sNomOper ) + " " + Trim ( stGlb.sPrenomOper )
sMailBody += sSaut
sMailBody += "SPB"
sMailBody += sSaut
sMailBody += "SAMSUNG - Garanties Dommages Smartphone & Tablette"
sMailBody += sSaut
sMailBody += "CS 90000"
sMailBody += sSaut
sMailBody += "76095 LE HAVRE CEDEX"
sMailBody += sSaut
sMailBody += "Fax : " + String ( idw_Produit.GetItemString ( 1, "NUM_FAX" ), "(@)@@@.@@@.@@@" ) 


idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

// [MIGPB11] [EMD] : Debut Migration : Forcer la création de Blob en ANSI
//bMailBody = Blob ( sMailBody )
bMailBody = Blob ( sMailBody, EncodingANSI! )
// [MIGPB11] [EMD] : Fin Migration

bRet = SQLCA.PS_I01_MAILPUSH ( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailDest, &
	sMailObjet, &
	bMailBody, &
	sBoiteMail, &
	sTypMail, &
	iIdAppli &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

public function string uf_controlergestion_auditassureurelsa ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_AuditAssureurElsa (PRIVATE)
//* Auteur			: JFF
//* Date				: 04/03/2016
//* Libellé			: 
//* Commentaires	: [AUDIT_ASSUREUR_ELSA]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bRet (False si blocage)
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF    15/04/2016  [VDOC20572]
//*-----------------------------------------------------------------

String sPos, sVal, sSaut, sMailBody, sIdSin, sMailBodyOrig, sObjet, sSql, sIdProd, sAdrMail
String sTabData [], sTabData2 [], sTabNull [], sTabRes []
Long lRow, lTel,lTot, lCpt, lTotTab
Boolean bEnvoi = False

Choose Case idw_produit.GetItemNumber ( 1, "ID_GRP" ) 
	Case 254, 678, 669
		// Ok 
	Case Else
		Return "" // Pas de contrôle
End Choose 

sPos = ""
sSaut = char (10 ) + char (10 ) 
sVal = ""
sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ) )
sIdProd = String ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) )
sAdrMail = ProfileString ( stGlb.sFichierIni, "AUDIT_ASSUREUR_ELSA", "ADR_MAIL_AUDIT_ASSUREUR_ELSA", "" )

If sAdrMail = "" Then Return ""

sObjet = "Alerte << Dossier audit assureur >> : " + sIdSin

sMailBodyOrig = "Bonjour Elsa," + sSaut 
sMailBodyOrig += "Déclenchement alerte le : " + String ( Today (), "dd/mm/yyyy hh:mm:ss" ) + sSaut 
sMailBodyOrig += "Sinistre : " + sIdSin + sSaut 
sMailBodyOrig += "Créé le : " + String ( idw_WSin.GetItemDatetime ( 1, "CREE_LE" ) , "dd/mm/yyyy hh:mm:ss" )+ sSaut 
sMailBodyOrig += "Produit : " + sIdProd + sSaut 
sMailBodyOrig += "Instruit par le GT : " + stGlb.sCodoper + ", nom : " + stGlb.sNomOper + ", prénom : " + stGlb.sPrenomOper + sSaut 

// MAIL
sTabData = sTabNull 

	// Elsa/Thomas
sTabData [1] = "actacomts"
sTabData [2] = "actacom"
sTabData [3] = "actacomps"
sTabData [4] = "actacomtl"
sTabData [5] = "gaia.martine"
sTabData [6] = "lebasketteur46"

	// Sandrine
sTabData [7] = "roybanque@gmail.com"
sTabData [8] = "r.osei@orange.fr"
sTabData [9] = "yeb-boa@orange.fr"
sTabData [10] = "roybanque@hotmail.fr"
sTabData [11] = "ri.osei8989@gmail.com"
sTabData [12] = "r.oseiyeb@gmail.com"
sTabData [13] = "oseiye@gmail.com"
sTabData [14] = "oseiyeboah89@gmail.com"


lTotTab = UpperBound ( sTabData )

lRow = 0 
For lCpt = 1 To lTotTab
	lRow = idw_LstInter.Find ( "POS ( lower ( ADR_MAIL ) , '" + sTabData [lCpt] + "' ) > 0", 1, idw_LstInter.Rowcount() )
	IF lRow > 0 Then Exit
Next 

If lRow > 0 Then
	bEnvoi = TRUE
	sVal = sTabData [lCpt]
	sMailBodyOrig += "Type Alerte : Mail détecté : " + sVal + sSaut 
End If

// RIB
sTabData = sTabNull 

	// Elsa/Thomas
sTabData [1] = "50010602750"
sTabData [2] = "1330785X037"

	// Sandrine
sTabData [3] = "00085215245"	
sTabData [4] = "00012441101"
sTabData [5] = "32219024257"
sTabData [5] = "0828525J025"
sTabData [6] = "1025517F025"
sTabData [7] = "00000335045"
sTabData [8] = "00000335142"


lTotTab = UpperBound ( sTabData )

lRow = 0
For lCpt = 1 To lTotTab
	lRow = idw_LstInter.Find ( "RIB_CPT = '" + sTabData [lCpt] + "'", 1, idw_LstInter.Rowcount() )
	IF lRow > 0 Then Exit
Next 

If lRow > 0 Then
	bEnvoi = TRUE
	sVal = sTabData [lCpt]
	sMailBodyOrig += "Type Alerte : RIB détecté : " + sVal + sSaut 
End If




// Tel
sTabData = sTabNull 
sTabData [1] = "0603989798"
sTabData [2] = "0640081877"
sTabData [3] = "0673300168"

lTotTab = UpperBound ( sTabData )

lRow = 0
lTel = 0

For lCpt = 1 To lTotTab
	lRow = idw_LstInter.Find ( "NUM_TELD = '" + sTabData [lCpt] + "' OR NUM_TELB = '" + sTabData [lCpt] + "' OR NUM_FAX = '" + sTabData [lCpt] + "'", 1, idw_LstInter.Rowcount() )	
	IF lRow > 0 Then Exit
Next 

If lRow <= 0 Then
	For lCpt = 1 To lTotTab
		lRow = idw_WSin.Find ( "F_REMPLACE ( NUM_PORT, ' ', '' ) = '" + sTabData [lCpt] + "'", 1, idw_WSin.Rowcount() )		
		IF lRow > 0 Then Exit
	Next 
End If

If lRow > 0 Then
	bEnvoi = TRUE
	sVal = sTabData [lCpt] 
	sMailBodyOrig += "Type Alerte : Num Tel détecté : " + sVal + sSaut 
End If




// Adresse
sTabData = sTabNull 

	// Elsa/Thomas
sTabData [1] = "POS ( Upper( Trim ( if ( IsNull ( adr_1 ), '', adr_1)) + ' ' + Trim ( if ( IsNull ( adr_2 ), '', adr_2))), 'JEAN' ) > 0 AND " + &
		 	 	   "POS ( Upper( Trim ( if ( IsNull ( adr_1 ), '', adr_1)) + ' ' + Trim ( if ( IsNull ( adr_2 ), '', adr_2))), 'JAUR' ) > 0 AND " + &
		         "POS ( Upper( Trim ( if ( IsNull ( adr_ville), '', adr_ville))) , 'CAHORS' ) > 0" 
sTabData2[1] = "POS ( Upper( Trim ( if ( IsNull ( adr_livr1), '', adr_livr1)) + Trim ( if ( IsNull ( adr_livr2 ), '', adr_livr2)) + Trim (  if ( IsNull ( adr_livr_cpl ), '', adr_livr_cpl))), 'JEAN' ) > 0 AND " + &
				   "POS ( Upper( Trim ( if ( IsNull ( adr_livr1), '', adr_livr1)) + Trim ( if ( IsNull ( adr_livr2 ), '', adr_livr2)) + Trim (  if ( IsNull ( adr_livr_cpl ), '', adr_livr_cpl))), 'JAUR' ) > 0 AND " + &
					"POS ( Upper( Trim ( if ( IsNull ( adr_ville), '', adr_ville))), 'CAHORS' ) > 0"
sTabRes  [1] = "Les chaines ''JEAN'' et ''JAUR'' ont été détectées dans l''adresse ainsi que la ville ''CAHORS''."

	// Sandrine
sTabData [2] = "POS ( Upper( Trim ( if ( IsNull ( adr_1 ), '', adr_1)) + ' ' + Trim ( if ( IsNull ( adr_2 ), '', adr_2))), '46' ) > 0 AND " + &
		 	 	   "POS ( Upper( Trim ( if ( IsNull ( adr_1 ), '', adr_1)) + ' ' + Trim ( if ( IsNull ( adr_2 ), '', adr_2))), 'SOUGER' ) > 0 AND " + &
		         "POS ( Upper( Trim ( if ( IsNull ( adr_ville), '', adr_ville))) , 'AUXERRE' ) > 0" 
sTabData2[2] = "POS ( Upper( Trim ( if ( IsNull ( adr_livr1), '', adr_livr1)) + Trim ( if ( IsNull ( adr_livr2 ), '', adr_livr2)) + Trim (  if ( IsNull ( adr_livr_cpl ), '', adr_livr_cpl))), '46' ) > 0 AND " + &
				   "POS ( Upper( Trim ( if ( IsNull ( adr_livr1), '', adr_livr1)) + Trim ( if ( IsNull ( adr_livr2 ), '', adr_livr2)) + Trim (  if ( IsNull ( adr_livr_cpl ), '', adr_livr_cpl))), 'SOUGER' ) > 0 AND " + &
					"POS ( Upper( Trim ( if ( IsNull ( adr_ville), '', adr_ville))), 'AUXERRE' ) > 0" 
sTabRes  [2] = "Les chaines ''46'' et ''SOUGER'' ont été détectées dans l''adresse ainsi que la ville ''AUXERRE''."


sTabData [3] = "POS ( Upper( Trim ( if ( IsNull ( adr_1 ), '', adr_1)) + ' ' + Trim ( if ( IsNull ( adr_2 ), '', adr_2))), '3' ) > 0 AND " + &
		 	 	   "POS ( Upper( Trim ( if ( IsNull ( adr_1 ), '', adr_1)) + ' ' + Trim ( if ( IsNull ( adr_2 ), '', adr_2))), 'PROM' ) > 0 AND " + &
		 	 	   "POS ( Upper( Trim ( if ( IsNull ( adr_1 ), '', adr_1)) + ' ' + Trim ( if ( IsNull ( adr_2 ), '', adr_2))), 'CHAP' ) > 0 AND " + &					  
		         "POS ( Upper( Trim ( if ( IsNull ( adr_ville), '', adr_ville))) , 'JOIGNY' ) > 0" 
sTabData2[3] = "POS ( Upper( Trim ( if ( IsNull ( adr_livr1), '', adr_livr1)) + Trim ( if ( IsNull ( adr_livr2 ), '', adr_livr2)) + Trim (  if ( IsNull ( adr_livr_cpl ), '', adr_livr_cpl))), '3' ) > 0 AND " + &
				   "POS ( Upper( Trim ( if ( IsNull ( adr_livr1), '', adr_livr1)) + Trim ( if ( IsNull ( adr_livr2 ), '', adr_livr2)) + Trim (  if ( IsNull ( adr_livr_cpl ), '', adr_livr_cpl))), 'PROM' ) > 0 AND " + &
				   "POS ( Upper( Trim ( if ( IsNull ( adr_livr1), '', adr_livr1)) + Trim ( if ( IsNull ( adr_livr2 ), '', adr_livr2)) + Trim (  if ( IsNull ( adr_livr_cpl ), '', adr_livr_cpl))), 'CHAP' ) > 0 AND " + &					
					"POS ( Upper( Trim ( if ( IsNull ( adr_ville), '', adr_ville))), 'JOIGNY' ) > 0" 
sTabRes  [3] = "Les chaines ''3'' et ''PROM'' et ''CHAP'' ont été détectées dans l''adresse ainsi que la ville ''JOIGNY''."


lTotTab = UpperBound ( sTabData )
lRow = 0

For lCpt = 1 To lTotTab
	If lRow <= 0 Then
		lRow = idw_LstInter.Find ( sTabData [lCpt], 1, idw_LstInter.Rowcount() )
	End If 
	
	
	If lRow <= 0 Then
		lRow = idw_LstwCommande.Find ( sTabData2 [lCpt], 1, idw_LstwCommande.Rowcount() )
	End If 
	
	
	If lRow <= 0 Then
		lRow = idw_WSin.Find ( sTabData [lCpt], 1, idw_WSin.Rowcount() )
	End If 
	IF lRow > 0 Then Exit
Next 

If lRow > 0 Then
	bEnvoi = TRUE
	sVal = sTabRes [lCpt]
	sMailBodyOrig += "Type Alerte : Adresse détectée : " + sVal + sSaut 
End If

// NOM 
sTabData = sTabNull 
sTabData [1] = " OSEI "
sTabData [2] = " OSEI YE "
sTabData [3] = " OSEI OAH "
sTabData [4] = " OSEI YEB "
sTabData [5] = " OSEI YEBOAH "
sTabData [6] = " OSEIYEBOAH "

lTotTab = UpperBound ( sTabData )

lRow = 0

For lCpt = 1 To lTotTab
	lRow = idw_LstInter.Find ( "POS ( Upper ( ' ' + NOM + ' ' ) , '" + sTabData [lCpt] + "' ) > 0", 1, idw_LstInter.Rowcount() )
	IF lRow > 0 Then Exit
Next

If lRow > 0 Then
	bEnvoi = TRUE
	sVal = sTabData [lCpt]
	sMailBodyOrig += "Type Alerte : Nom détecté : " + sVal + sSaut 
End If



// Envoi
If bEnvoi Then

	If Not This.uf_GetAutorisation2(227) Then

	 idw_LstwCommande.SetFilter ( "COD_ETAT = 'CNV'" )
	 idw_LstwCommande.Filter ()
	 lTot = idw_LstwCommande.Rowcount ()
	 For lCpt = lTot To 1 Step -1
		idw_LstwCommande.DeleteRow (lCpt) // Suppression presta demandée par Corinne Auger
	 Next
	 idw_LstwCommande.SetFilter ( "" )
	 idw_LstwCommande.Filter ()

	End If

 sSql = "Exec sysadm.PS_S01_MAIL '" + sAdrMail + "', "  +&
		  "'" + sMailBodyOrig + "'"		 + ", " + &
		  "'" + sObjet + "'"		 + ", " + &
		  "'Alerte SIMPA2'"		    + ", " + &
		  "''"			 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"

	F_execute ( sSql, SQLCA )
	F_Commit ( SQLCA, true )
	
	stMessage.sTitre		= "Audit assureur"
	stMessage.Icon			= Information!
	stMessage.sCode		= "WSIN799"		
	stMessage.bErreurG	= False

	// [VDOC20572]
	If This.uf_GetAutorisation2(208) Or This.uf_GetAutorisation2(227) Then
		sPos = ""			
		stMessage.sCode		= "WSIN800"		
		stMessage.Icon			= Exclamation!
		F_Message ( stMessage ) 
	Else
		sPos = "ALT_BLOC"			
	End If
	
End If

Return sPos
end function

public subroutine uf_determiner_data_recup_adr_pickup ();//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::Uf_Determiner_Data_Recup_Adr_PickUp (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 13/04/2016
//* Libellé			: [DT191-2][MANTIS20230]
//* Commentaires	: Récupère l'adresse du Pick Up
//*
//* Arguments		: 
//*
//* Retourne		: 
//*
//*-----------------------------------------------------------------
//* MAJ 			PAR		Date		Modification
//*-----------------------------------------------------------------

Long lRow

If Not IsNull ( gsAdrNomPickUp ) And Len ( Trim ( gsAdrNomPickUp  ) ) > 0 Then Return

lRow = idw_LstwCommande.Find ( "POS ( INFO_SPB_FRN_CPLT, 'CODE_PICK_UP' ) > 0", 1, idw_LstwCommande.RowCount () )

If lRow <= 0 Then Return

gsAdrCivPickUp	  = idw_LstwCommande.GetItemString ( lRow, "ADR_COD_CIV" )
gsAdrNomPickUp   = idw_LstwCommande.GetItemString ( lRow, "ADR_NOM" )
gsAdrPreNomPickUp = idw_LstwCommande.GetItemString ( lRow, "ADR_PRENOM" )
gsAdr1PickUp     = idw_LstwCommande.GetItemString ( lRow, "ADR_LIVR1" )
gsAdr2PickUp     = idw_LstwCommande.GetItemString ( lRow, "ADR_LIVR2" )
gsAdrCpltPickUp  = idw_LstwCommande.GetItemString ( lRow, "ADR_LIVR_CPL" )
gsAdrCpPickUp    = idw_LstwCommande.GetItemString ( lRow, "ADR_CP" )
gsAdrVillePickUp = idw_LstwCommande.GetItemString ( lRow, "ADR_VILLE" )


end subroutine

public function long uf_zn_marqport (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_MarqPort (PUBLIC)
//* Auteur			: Catherine Abdmeziem
//* Date				: 10/06/2003
//* Libellé			: Modification de la zone MARQ_PORT en dddw
//* Commentaires	: 	
//*
//* Arguments		: Aucun
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    10/04/2007  DCMP070256
//* #2    JFF    21/08/2007  Hors DCMP, modif urgente pour le DVT.
//* #3	 PHG	  09/09/2008  [DCMP080625] Désactivation Controle Marque/modèle
//*													obligatoire
//			 FPI	 03/04/2011	  [PC494]
//*       JFF   19/09/2011   [PM82][LOT1]
//*       JFF   15/05/2012	  [ITSM115501]
//        JFF   24/08/2012   [ITSM127916]
//        JFF   31/08/2012   [ITSM128535]
//        JFF   19/02/2013	  [VDOC9304_PM82_LOT1]
//        JFF   02/10/2014   [VDOC15485]
//        JFF   23/09/2015   [PM82-5]
//        JFF   07/03/2015   [ITSM367948]
//        JFF   12/05/2016   [MOTEUR_RECH_IFR]
//        JFF   04/05/2017   [DT288-1_LOT2]
//        JFF   15/05/2019   [DT386_EXTR_AXA]
//        JFF   11/05/2022   [RS2980_IFR]
//        JFF   07/03/2024   [HP252_276_HUB_PRESTA]
//        JFF   18/02/2025   [PMO268_MIG48][20250410100203163]
//*-----------------------------------------------------------------

String				sFind, sGetText, sTypeApp, sVal, sCodeRet, sModele, sMarque
Long					lRow, lDeb, lFin, lRow2, lTotDetail, lCptDet, lVal1, lVal2, lVal3, lVal4, lVal5, lVal6, lVal7
DataWindowChild	dwChild
Integer				iAction

sFind = ""
iAction = 0
idw_wSin.iiErreur = 1
lRow = 1


sTypeApp = This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )

/*------------------------------------------------------------------*/
/* Pour Modifier la marque, il faut qu'aucun détail soit 'à         */
/* régler' ou 'réglé' ET qu'aucune Prestation non annulée n'existe. */
/*------------------------------------------------------------------*/
// #1 OR MT_VAL_PUBLIQUE > 0 
// #1 suppression du OR MT_VAL_PUBLIQUE > 0 

// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	// [PM82][LOT1]
	// [ITSM115501]
	lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () ) 
	
	lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	// [PM82-5] // [HP252_276_HUB_PRESTA]
	lVal3 = idw_LstwCommande.Find ( "(( ID_TYP_ART= 'PRS' AND ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER')) Or ( ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 )) AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN')", 1, idw_LstwCommande.RowCount () ) 
//	lVal6 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER') AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT IN ( 'RFO', 'RPC')", 1, idw_LstwCommande.RowCount () ) 
	lVal6 =0 
	
	// [ITSM367948]
	lVal4 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DESOXYDER_FORCE', 'PEC_A_RECYCLER' ) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
	
	If ( lVal4 > lVal3 And lVal3 > 0 ) Or ( lVal4 > lVal6 And lVal6 > 0 ) Then lVal4 = 0 
	If lVal6 > 0 And lVal3 <= 0 Then lVal3 = lVal6
Else
	// [PM82][LOT1]
	// [ITSM115501]
	lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () ) 
	
	lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	// [PM82-5]
	lVal3 = idw_LstwCommande.Find ( "ID_TYP_ART= 'PRS' AND ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER') AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN')", 1, idw_LstwCommande.RowCount () ) 
	lVal6 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER') AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT IN ( 'RFO', 'RPC')", 1, idw_LstwCommande.RowCount () ) 
	
	// [ITSM367948]
	lVal4 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DESOXYDER_FORCE', 'PEC_A_RECYCLER' ) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
	
	If ( lVal4 > lVal3 And lVal3 > 0 ) Or ( lVal4 > lVal6 And lVal6 > 0 ) Then lVal4 = 0 
	If lVal6 > 0 And lVal3 <= 0 Then lVal3 = lVal6
End If 	
	
// [ITSM128535]
lVal5 = 1
If isReferentielApp = "REF_CODIC_DARTY" Then
	sVal = idw_Wsin.GetItemString ( 1, "MARQ_PORT" )
	If IsNull ( sVal ) Then sVal = ""
	idw_Wsin.Getchild ( "MARQ_PORT3", dwChild ) 
	sFind = "MARQUE = '" + sVal + "'"
	lVal5 = dwChild.Find ( sFind, 1, dwChild.RowCount () )
End If


If (( lVal1 > 0 Or lVal2 > 0 ) And Not ( lVal3 > 0 And lVal4 <= 0 )) And lVal5 > 0 Then
	lRow = -1
	idw_wSin.iiErreur = 2
End If 


// [DT288-1_LOT2]
If lRow > 0 Then
	lRow2 = idw_wdivsin.Find("UPPER (NOM_ZONE) = 'GEOLOC_SIMPA2'", 1, idw_wdivsin.RowCount())
	If lRow2 > 0 And sGetText <> "APPLE" Then 
		This.uf_gestong_divers_majzone( "GEOLOC_SIMPA2", lRow2, K_MAJZONE, "N" )
	End If		
End If

/*------------------------------------------------------------------*/
/* Pour DARTY (Profuit Mobile) Si CODIC trouvé ET Valide, alors     */
/* tout est déterminé automatiquement, don interdiction de          */
/* modifier la Marque/modele.                                       */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 31 )
If lRow <> -1 and lDeb > 0 Then
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'codic'", 1,  idw_WDivSin.RowCount () ) 
	If lRow > 0 And ibCodicDartyValide Then
		lRow = -1
		idw_wSin.iiErreur = 3
	End If
End If

/*------------------------------------------------------------------*/
/* #3 [DCMP080625] Si Option 75 active ( Controle IMEI) et Controle */
/* IMEI En Cours ou déja effectué, on ne peux modifier la marque et */
/* le modèle.																		  */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 75 )
If lRow <> -1 and lDeb > 0 Then
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'cra_suivi_imei'", 1,  idw_WDivSin.RowCount () ) 
	If lRow > 0 Then
		if long(idw_WDivSin.object.val_nbre[lRow]) > 0 Then
			lRow = -1
			idw_wSin.iiErreur = 4 
		End If
	End If
End If
//

// [MOTEUR_RECH_IFR]
If asCas = "CONTROLE" Then
	Return lRow
End If

sGetText = Upper ( idw_wSin.GetText () )

sGetText = TRIM ( F_EPURE_CHAINE ( sGetText, "EXCL_SLASHX2" ))

If Not IsNull ( sGetText ) and sGetText <> "" And lRow <> -1 Then
	
	Choose Case isReferentielApp
		Case "IFR"
			// [RS2980_IFR]
			gsCodeRetPrixIfr = "" // On réinitialise puisqu'on rappelle

			sCodeRet = Space ( 20 )
			
			sMarque = Trim ( idw_wSin.GetItemString ( 1, "MARQ_PORT2" ))
			sModele = Trim ( idw_wSin.GetItemString ( 1, "MODL_PORT2" ))

			SQLCA.PS_U_MARQUAGE_PRIX_IFR_A_REVOIR ( sMarque, sModele, sCodeRet ) 
			F_Commit ( SQLCA, SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0)

			If sCodeRet = "URGE" Then

				gsCodeRetPrixIfr = sCodeRet
				
				lRow = -1
				idw_wSin.iiErreur = 5
				
			End if 			
		
			If lRow <> -1 Then
				
				idw_wSin.GetChild ( "MARQ_PORT2", dwChild )
				sFind = "MARQUE = '" + sGetText + "'"
				lRow = dwChild.Find ( sFind, 1, dwChild.RowCount () )
	
				idw_Wsin.Getchild ( "MODL_PORT2", dwChild ) 
				dwChild.SetFilter ( "MARQUE = '" + sGetText + "'")
				dwChild.Filter ()
				dwChild.Sort ()
			
				// #1
				If lRow > 0 Then
					lRow2 = idw_WDivSin.Find ( "NOM_ZONE = 'mt_val_publique'", 1,  idw_WDivSin.RowCount () ) 
					If lRow2 > 0 Then 
						This.uf_gestong_divers_majzone( "MT_VAL_PUBLIQUE", lRow2, K_MAJZONE, 0 )
					End If
				End If
	
				// #2
				lTotDetail = idw_wDetail.RowCount ()
				For lCptDet = 1 To lTotDetail 
					idw_wDetail.SetItem ( lCptDet, "MT_VAL_PUBLIQUE", 0 )
				Next
				
			End If 
				

		Case "REF_CODIC_DARTY"

			idw_Wsin.Getchild ( "MARQ_PORT3", dwChild ) 
			dwChild.SetFilter ( "TYPE_APP = '" + sTypeApp + "'")
			dwChild.Filter ()
			dwChild.Sort ()


			sFind = "MARQUE = '" + sGetText + "'"
			lRow = dwChild.Find ( sFind, 1, dwChild.RowCount () )

			idw_Wsin.Getchild ( "MODL_PORT3", dwChild ) 
			dwChild.SetFilter ( "MARQUE = '" + sGetText + "' AND TYPE_APP = '" + sTypeApp + "'")
			dwChild.Filter ()
			dwChild.Sort ()


		Case Else

			// [PMO268_MIG48][20250410100203163] Cas Maxi Coffe, on ne modifia le model de l'adhésion (API)
/*
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 395 )
			If lRow <> -1 And lDeb > 0 Then
				lRow = -1
				idw_wSin.iiErreur = 6									
			End IF 
*/

			// [DT386_EXTR_AXA]
			// [PMO268_MIG48]
			If lRow <> -1 Then
				F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 336 )
				If lDeb > 0 Then
					// Saisie Libre sans Contrôle
					lRow = 1	
				Else 
					idw_wSin.GetChild ( "MARQ_PORT", dwChild )
					sFind = "LIB_CODE = '" + sGetText + "'"
					lRow = dwChild.Find ( sFind, 1, dwChild.RowCount () )
				End If 
			End If 
	End Choose 

End If

// Pour Ref AUTRE
If lRow > 0 and sGetText="PAS_DE_MARQUE" Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 313 )
	If lDeb <= 0 Then
		lRow=0
	End If 
End If

// [PC494] pour IFR !!
If lRow > 0 and sGetText="PAS DE MARQUE" Then
	F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 169 )
	if lDeb <= 0 Then
		lRow=0
	Else
		idw_WSin.SetItem(1,"NUM_IMEI_PORT","111111111111119")
		idw_WSin.SetItem(1,"NUM_PORT","0600000000")
	End if
	
End if
// :[PC494]

If lRow <= 0 Then
	iAction = 1
End If

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

public function long uf_zn_modlport ();//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Zn_ModlPort (PUBLIC)
//* Auteur			: Fabry JF
//* Date				: 30/09/04
//* Libellé			: Modification de la zone MODL_PORT en dddw
//* Commentaires	: 	
//*
//* Arguments		: Aucun
//*
//Migration PB8-WYNIWYG-03/2006 OR
////* Retourne		: Rien
//* Retourne		: long
//Fin Migration PB8-WYNIWYG-03/2006 OR
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1   JCA   08/06/2006	  Remplacement des simple cote et double cote (abreviation pour unité du pouce) par lettre p (pouce)   
//* #2   JFF   10/04/2007    DCMP070256
//* #3   JFF   21/08/2007    Hors DCMP, modif urgente pour le DVT.
//* #4	PHG	09/09/2008	  [DCMP080625] Désactivation Controle Marque/modèle
//*													obligatoire
//*      JFF   19/09/2011   [PM82][LOT1]
//*      JFF   27/02/2012   [ITSM107892]
//			JFF   17/04/2012   [ITSM112924]
//       JFF   24/08/2012   [ITSM127916]
//       JFF   31/08/2012   [ITSM128535]
//       JFF   19/02/2013	 [VDOC9304_PM82_LOT1]
//       JFF   02/10/2014 	 [VDOC15485]
//       JFF   23/09/2015   [PM82-5]
//       JFF   07/03/2015   [ITSM367948]
// 		JFF	30/11/2018   [ITSM576497]
//       JFF   17/01/2020   [EPURE_MODL_MB]
//       JFF   11/05/2022   [RS2980_IFR]
//       JFF   07/03/2024   [HP252_276_HUB_PRESTA]
//       JFF   18/02/2025   [PMO268_MIG48][20250410100203163]
//*-----------------------------------------------------------------

String				sFind, sGetText, sVal, sCodeRet, sMarque, sModele
Long					lRow, lDeb, lFin, lRow2, lTotDetail, lCptDet, lVal1, lVal2, lVal3, lVal4, lVal5, lVal6
DataWindowChild	dwChild
Integer				iAction

sFind = ""
iAction = 0
idw_wSin.iiErreur = 1
lRow = 1

/*------------------------------------------------------------------*/
/* Pour Modifier la marque, il faut qu'aucun détail soit 'à         */
/* régler' ou 'réglé' ET qu'aucune Prestation non annulée n'existe. */
/*------------------------------------------------------------------*/
// #2 OR MT_VAL_PUBLIQUE > 0 
// #3 suppression du OR MT_VAL_PUBLIQUE > 0 	

// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	// [PM82][LOT1]
	// [ITSM115501]
	lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () ) 
	
	lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	// [PM82-5] // [HP252_276_HUB_PRESTA]
	lVal3 = idw_LstwCommande.Find ( "(( ID_TYP_ART= 'PRS' AND ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER')) Or ( ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND POS ( INFO_SPB_FRN_CPLT, 'HP_ID_HUB_PRESTA') > 0 )) AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN')", 1, idw_LstwCommande.RowCount () ) 
//	lVal6 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER') AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT IN ( 'RFO', 'RPC')", 1, idw_LstwCommande.RowCount () ) 
	lVal6 =0 
	
	// [ITSM367948]
	lVal4 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DESOXYDER_FORCE', 'PEC_A_RECYCLER' ) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
	
	If ( lVal4 > lVal3 And lVal3 > 0 ) Or ( lVal4 > lVal6 And lVal6 > 0) Then lVal4 = 0 
	If lVal6 > 0 And lVal3 <= 0 Then lVal3 = lVal6

Else
	// [PM82][LOT1]
	// [ITSM115501]
	lVal1 = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
			  idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () ) 
	
	lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () )
	
	// [PM82-5]
	lVal3 = idw_LstwCommande.Find ( "ID_TYP_ART= 'PRS' AND ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER') AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT NOT IN ( 'RFO', 'RPC', 'ANN')", 1, idw_LstwCommande.RowCount () ) 
	lVal6 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'A_DIAGNOSTIQUER') AND STATUS_GC IN ( 153, 154 ) AND COD_ETAT IN ( 'RFO', 'RPC')", 1, idw_LstwCommande.RowCount () ) 
	
	// [ITSM367948]
	lVal4 = idw_LstwCommande.Find ( "ID_REF_FOUR IN ( 'REFUSE_A_REEXP', 'A_REPARER_FORCE', 'A_DESOXYDER_FORCE', 'PEC_A_RECYCLER' ) AND COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )
	
	If ( lVal4 > lVal3 And lVal3 > 0 ) Or ( lVal4 > lVal6 And lVal6 > 0) Then lVal4 = 0 
	If lVal6 > 0 And lVal3 <= 0 Then lVal3 = lVal6
End If 

// [ITSM128535]
lVal5 = 1
If isReferentielApp = "REF_CODIC_DARTY" Then
	sVal = idw_Wsin.GetItemString ( 1, "MODL_PORT" )
	If IsNull ( sVal ) Then sVal = ""
	idw_wSin.GetChild ( "MODL_PORT3", dwChild )
	sFind = "REFERENCE = '" + sVal + "'"
	lVal5 = dwChild.Find ( sFind, 1, dwChild.RowCount () )
End If

If (( lVal1 > 0 Or lVal2 > 0 ) And Not ( lVal3 > 0 And lVal4 <= 0 )) And lVal5 > 0 Then
	lRow = -1
	idw_wSin.iiErreur = 2
End If 

/*------------------------------------------------------------------*/
/* Pour DARTY (Profuit Mobile) Si CODIC trouvé ET Valide, alors     */
/* tout est déterminé automatiquement, don interdiction de          */
/* modifier la Marque/modele.                                       */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 31 )
If lRow <> -1 And lDeb > 0 Then
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'codic'", 1,  idw_WDivSin.RowCount () ) 
	If lRow > 0 And ibCodicDartyValide Then
		lRow = -1
		idw_wSin.iiErreur = 3
	End If
End If

/*------------------------------------------------------------------*/
/* #4 [DCMP080625] Si Option 75 active ( Controle IMEI) et Controle */
/* IMEI En Cours ou déja effectué, on ne peux modifier la marque et */
/* le modèle.																		  */
/*------------------------------------------------------------------*/
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 75 )
If lRow <> -1 and lDeb > 0 Then
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'cra_suivi_imei'", 1,  idw_WDivSin.RowCount () ) 
	If lRow > 0 Then
		// [ITSM576497]
		if long(idw_WDivSin.object.val_nbre[lRow]) = 1 Then
			lRow = -1
			idw_wSin.iiErreur = 4
		End If
	End If
End If
//

sGetText = Upper ( idw_wSin.GetText () )

// #1
// [ITSM112924]
sGetText = F_Remplace ( sGetText, '"', 'P' )
sGetText = F_Remplace ( sGetText, "''", 'P' )
sGetText = F_Remplace ( sGetText, "'", 'P' )	
sGetText = F_Remplace ( sGetText, ";", ' ' )		

sGetText = TRIM ( F_EPURE_CHAINE ( sGetText, "EXCL_SLASHX2" ))


// #1 FIN

If Not IsNull ( sGetText ) and sGetText <> "" And lRow <> -1 Then
	
	Choose Case isReferentielApp
		Case "IFR"
			
			// [RS2980_IFR]
			gsCodeRetPrixIfr = "" // On réinitialise puisqu'on rappelle

			sCodeRet = Space ( 20 )

			sMarque = Trim ( idw_wSin.GetItemString ( 1, "MARQ_PORT2" ))
			sModele = Trim ( idw_wSin.GetItemString ( 1, "MODL_PORT2" ))

			SQLCA.PS_U_MARQUAGE_PRIX_IFR_A_REVOIR ( sMarque, sModele, sCodeRet ) 
			F_Commit ( SQLCA, SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0)

			If sCodeRet = "URGE" Then

				gsCodeRetPrixIfr = sCodeRet
				
				lRow = -1
				idw_wSin.iiErreur = 5
				
			End if 			
		
			If lRow <> -1 Then
				idw_wSin.GetChild ( "MODL_PORT2", dwChild )
				sFind = "REFERENCE = '" + sGetText + "'"
				lRow = dwChild.Find ( sFind, 1, dwChild.RowCount () )
				
				// #2
				If lRow > 0 Then
					lRow2 = idw_WDivSin.Find ( "NOM_ZONE = 'mt_val_publique'", 1,  idw_WDivSin.RowCount () ) 
					If lRow2 > 0 Then 
						This.uf_gestong_divers_majzone( "MT_VAL_PUBLIQUE", lRow2, K_MAJZONE, 0 )
					End If
				End If
	
				// #2
				lTotDetail = idw_wDetail.RowCount ()
				For lCptDet = 1 To lTotDetail 
					idw_wDetail.SetItem ( lCptDet, "MT_VAL_PUBLIQUE", 0 )
				Next

			End IF 	

		Case "REF_CODIC_DARTY"
			idw_wSin.GetChild ( "MODL_PORT3", dwChild )
			sFind = "REFERENCE = '" + sGetText + "'"
			lRow = dwChild.Find ( sFind, 1, dwChild.RowCount () )

		Case Else
			// Saisie Libre sans Contrôle
			lRow = 1
			
			// [PMO268_MIG48][20250410100203163] Cas Maxi Coffe, on ne modifia le model de l'adhésion (API)
			F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 395 )
			If lRow <> -1 And lDeb > 0 Then
				lRow = -1
				idw_wSin.iiErreur = 6
			End IF 

	End Choose 

End If

If lRow <= 0 Then
	iAction = 1
End If

// #1
// [ITSM107892]
if lRow <> -1 And isReferentielApp = "REF_SIMPA2_CODE_MB" then

	// EPURE_MODL_MB
	sGetText = F_EPURE_CHAINE ( sGetText, "EXCL_SLASHX2" ) 
	
	idw_wSin.SetItem ( 1, "MODL_PORT", sGetText) 	
	iAction = 2	
end If
// :[ITSM107892]
// #1 FIN

//Migration PB8-WYNIWYG-03/2006 OR
//idw_wSin.SetActionCode ( iAction )
Return iAction
//Fin Migration PB8-WYNIWYG-03/2006 OR

end function

private subroutine uf_determiner_courrier_forcage_o2m_pm280 (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_O2M (PRIVATE)
//* Auteur        : PHG
//* Date          : 10/12/2007
//* Libellé       : On met à jour le tableau de des droits de modifications des courriers.
//* Commentaires  : 
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//			 JFF     17/06/2014 [DT87][MANTIS11451]
//        JFF     30/06/2015 [DT156]
//        JFF     17/05/2016 [PM280-2]
// 		 JFF		15/09/2016 [PC151549][MANTIS21781]
//        JFF   	23/08/2017 [DT288-3_LOT1][PM280]
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech
Long   				lDeb, lFin, lTotCourrier, lLig, lDeb2
n_cst_attrib_key	lnv_Key[]
string				sTypApp
String 				sAction

// [PM280-2]
sAction = "A_REP_GARANTIE"
lDeb2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR = 'O2M' AND ID_REF_FOUR = 'A_REPARER' AND POS ( INFO_SPB_FRN_CPLT, 'A_REP_GARANTIE=OUI' ) > 0", 1, idw_LstwCommande.rowCount()+1 )

If lDeb2 <= 0 Then
	sAction = "CONTEST_SUR_REMPL"
	lDeb2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR = 'O2M' AND ID_REF_FOUR = 'CONTEST_SUR_REMPL'", 1, idw_LstwCommande.rowCount()+1 )
End IF


// [PC938_ORANGE_V3][MANTIS7779]
// [PM280-2]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
If lDeb > 0 And lDeb2 <=0 Then
	Return	
End If

// [PC151549][MANTIS21781]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 302 )
If lDeb > 0 And lDeb2 <=0 Then
	If This.uf_GestOng_Divers_Trouver ( "ech_express_48h" ) <> "O" Then
		Return
	End If
End If 

// 
// [DT156] 
// [PM280-2]
If lDeb2 <=0 Then
	sAction = "A_DIAGNOSTIQUER"
	lDeb2 = idw_LstwCommande.Find ( "COD_ETAT = 'CNV' AND ID_FOUR = 'O2M' AND ID_REF_FOUR = 'A_DIAGNOSTIQUER' AND INFO_SPB_FRN NOT IN ( 985 )", 1, idw_LstwCommande.rowCount()+1 )
End If 

If asPos = "" &
	And idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) = "A" &
	and lDeb2 > 0 &
	Then
	
	sTypApp = uf_GestOng_Divers_Trouver("TYPE_APP")
	lnv_Key[1].iskeyname	 ="TYP_APP"
	lnv_Key[1].iakeyvalue =sTypApp
	lnv_Key[2].iskeyname	 ="ID_COUR"
	lnv_Key[3].iskeyname	 ="ACTION"
	lnv_Key[3].iakeyvalue =sAction  // [PM280-2]
		
	F_RechDetPro_withkey( lDeb, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 95, lnv_Key )
	If lDeb > 0 Then
		sIdNatPresent = asIdNatCour
		
		sIdNatCourForcage = lnv_Key[2].iakeyvalue
		
		If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""

		If sIdNatPresent <> sIdNatCourForcage Then

			If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= sIdNatCourForcage
				
			Else
				stMessage.bErreurG	= FALSE
				stMessage.Icon			= question!
				stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
				stMessage.Bouton		= YesNO!
				stMessage.sVar[1] 	= asIdNatCour
				stMessage.sVar[2] 	= sIdNatCourForcage
			End If 
			
			If F_Message ( stMessage ) = 1 Then

				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!							

				idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
				lTotCourrier	= dwChild.RowCount ()
				sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
				lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
		
		/*------------------------------------------------------------------*/
		/* On verifie si la nature de courrier existe. Si elle n'existe     */
		/* pas, par un effet du hasard bien sur, on arrete le traitement    */
		/* et on positionne sur REF_CIE.                                    */
		/*------------------------------------------------------------------*/
				If	lLig = 0	Then
		
		/*------------------------------------------------------------------*/
		/* On arme la structure de message maintenant, mais le message va   */
		/* être affiché dans le contrôle de gestion.                        */
		/*------------------------------------------------------------------*/
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= Information!
					stMessage.sCode		= "WSIN170"
					stMessage.sVar[1] 	= sIdNatCourForcage
					asPos = "REF_CIE"
				Else
					If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
						asIdNatCour = sIdNatCourForcage
						asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
						
						idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
						idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
						idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
					Else 
						// Le message est armé dans uf_GestionCP
						asPos = "REF_CIE"

					End If
				End If		
			End If
		End If
	End if 
End If


end subroutine

public function string uf_getreponse_script (string asclequest, boolean abcode);//*-----------------------------------------------------------------
//*
//* Fonction		: uf_getreponse_script (Public)
//* Auteur			: FPI
//* Date				: 14/09/2016
//* Libellé			: [PC151259]
//* Commentaires	: Renvoie la réponse à un script
//*
//* Arguments		:	asclequest	clé de la question
//* 					 	abCode true si on souhaite le code, false si on veut le libellé de la réponse
//*
//* Retourne		: le libellé ou le code de la réponse, vide si la question n'existe pas ou si l'id_archive n'est pas dans div_sin
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 			FPI		02/01/2017	[ITSM435885]
// 			FPI		30/03/2017 [ITSM453453]
//*-----------------------------------------------------------------
string sret=""
long lRow, lIdArchive
string sVal, sLibVal
n_cst_string nvstring

lRow=idw_wdivsin.Find("UPPER(NOM_ZONE)='ID_ARCH_SCRIPT'",1,idw_wdivsin.RowCount())
if lRow <= 0 Then return ""

lIdArchive=idw_wdivsin.GetItemNumber(lRow,"VAL_NBRE")
if isnull(lIdArchive) Then Return ""

sVal=Fill(" ",254)
sLibVal=Fill(" ",254)

if SQLCA.ps_s_archive_reponse( lidarchive, asclequest, sVal, sLibVal) = 0 Then Return ""

if abCode Then
	sRet=sVal
Else
	sRet=nvstring.of_globalreplace(sLibVal,char(13) + Char(10),char(11)) // [ITSM435885]
	sRet=nvstring.of_globalreplace(sLibVal,char(13),char(11))
	sRet=nvstring.of_globalreplace(sLibVal,char(10),char(11))
	sRet=nvstring.of_globalreplace(sRet,char(9)," ")
	sRet=nvstring.of_globalreplace(sRet,"~"","") // [ITSM453453]
End if 

return sret
end function

public function string uf_controlergestion_interdirereglpresta ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_InterdireReglPresta (PRIVATE)
//* Auteur			: JFF
//* Date				: 28/09/2016
//* Libellé			: 
//* Commentaires	: [DT262]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bRet (False si blocage)
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

String sPos, sIMEI
Boolean bMtAReg, bPrestaCNV, bPEC 
Long lDeb, lFin

sPos = ""

// [DT262]
F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 308 )
If lDeb <= 0 Then Return sPos

bMtAReg = idw_wSin.GetItemDecimal ( 1, "MT_A_REG" ) > 0 
bPrestaCNV = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount () ) > 0 
bPEC = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND VAL_CAR = 'O'", 1, idw_wDivDet.RowCount () ) > 0 
sIMEI = Trim ( idw_wSin.GetItemString ( 1, "NUM_IMEI_PORT" ) )

If ( sIMEI = "" Or IsNull ( sIMEI ) ) And ( bMtAReg Or bPrestaCNV Or bPEC ) Then
	stMessage.sTitre		= "DT262 : IMEI Absent"
	stMessage.Icon		= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "WSIN805"
	sPos	= "ALT_BLOC"	
End IF

Return sPos

end function

private function long uf_zn_trt_divsin_degolocalisation (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_degolocalisation (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 04/11/2016
//* Libellé			: 
//* Commentaires	: [DT176]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin

asData = Upper ( asData )
iAction = 0

lRow = idw_LstwCommande.Find ( "ID_TYP_ART = 'PRS'", 1, idw_LstwCommande.RowCount () ) 

If lRow > 0 Then
	idw_wDivSin.iiErreur = 13
	iAction = 1
End If

Return iAction

end function

private function boolean uf_validation_finale_advise5_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_advise5_mail  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 08/11/2016 16:43:53
//* Libellé       : Gestion Particulière pour ADVISE 5.
//* Commentaires  : 
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 		JFF	 23/02/2017   [MANTIS24068] chgt adr mail
// 		JFF	 29/03/2017   [VDOC23412] chgt de phrase
//       JFF    29/05/2017   [PC151259-2]
//       JFF    29/05/2017   [PC151259-2]
//       JFF    05/10/2017   [PC171918]
// 		JFF	 17/05/2018   [VDOC26177] maj mail
// 		JFF	 22/06/2018   [VDOC26344]
//       JFF    12/12/2018   [VDOC27245]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt, sIdSousFourn 
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sTypMail, sMailFrom, sSaut, sBoiteMail 
String sMailBody, sMailObjet, sXml, sMailDest, sIdFour, sNomAssure
Blob bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lTotDetail, lCptDet, lDeb, lFin, lIdProd
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString		
s_pass stPass
Integer iidAppli
String sMailCc, sMailCci
Boolean bPrestaSav 
Long lRowAssure

sMailCc=""
sSaut = char (10 )
sMailBody=""
sTypMail="PRSADV"
iidAppli=2

lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
// [PC151259-2] // [PC171918]
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN ( 'EKO', 'DGC', 'NET', 'SMT', 'RAV', 'RTP', 'SFG' ) " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd <= 0 Then 
	// ON continue sans mail
	Return TRUE
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers TREMBLAY, on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD951"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdFour = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" ) 
sIdSousFourn = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "SOUS_FRN", ";")
If sIdSousFourn = "" Then sIdSousFourn = sIdFour 

bPrestaSav = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "A_REPARER_SAV", ";") = "OUI"
If Not bPrestaSav Then bPrestaSav = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "A_DESOXYDER_SAV", ";") = "OUI"
If Not bPrestaSav Then bPrestaSav = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "A_CONTROLER_SAV", ";") = "OUI"

F_RechDetPro ( lDeb, lFin, idw_DetPro, lIdProd, "-DP", 252 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
If IsNull ( sBoiteMail ) Then sBoiteMail = ""
sMailFrom=sBoiteMail

// Armement sMailDest
sMailDest = space ( 128 )

// [PC151259-2]
sMailDest = Trim ( uf_GestOng_Divers_Trouver("ADR_MAIL_REPA_ADH") )
If IsNull ( sMailDest ) Then sMailDest = ""

If sMailDest = "" Then
	sMailDest = "servicesinistre@advise-assurance.com" // Défaut donné par S.Vabre.
End If

sMailCci=""

/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 1ère ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
If bPrestaSav Then 
	sMailObjet= "Demande de prise en charge SAV - Dossier n°" + sIdSin + " / " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) ) + " - ADVISE 5/" + sIdSousFourn
Else
	sMailObjet= "Demande de réparation - Dossier n°" + sIdSin + " / " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) ) + " - ADVISE 5/" + sIdSousFourn
End If

// Assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )


sMailBody+= "Bonjour," + sSaut
sMailBody+= sSaut
sMailBody+= sSaut
sMailBody+= "Nous vous informons de la déclaration de sinistre de " + sNomAssure + " concernant le dommage de son appareil" + sSaut
sMailBody+= sSaut
sMailBody+= sSaut

sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
If sFiltreOrigDDDW = "?" Then sFiltreOrigDDDW = ""
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+= "Type : " + Upper ( sVal ) + sSaut
sMailBody+= "Marque : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + sSaut
sMailBody+= "Modèle : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) + sSaut
sMailBody+= "IMEI/SERIE : " + Upper ( F_GetItem3 ( idw_wSin, 1, "NUM_IMEI_PORT" ) ) + sSaut

// [VDOC26344]
lRowAssure=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())
sMailBody += "Tél. : " + F_GetItem3 ( idw_lstinter, lRowAssure, "NUM_TELD" ) + sSaut

sMailBody+="Date d'achat de l'appareil sinistré : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" )  + sSaut  // [PI056]

lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )

If lRow > 0 Then
	sVal = String ( idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" ) )
	If IsNull ( sVal ) Then sVal = "Absente"
End If

sMailBody+="Montant de la valeur d'achat : " + sVal + " €" + sSaut	

sMailBody+= "Date de survenance du sinistre : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" )  + sSaut	

sVal = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
idw_LstGti.GetChild ( "ID_GTI", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
If sFiltreOrigDDDW = "?" Then sFiltreOrigDDDW = ""
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_GTI = " + sVal, 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_GTI" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+= "Garantie : " + Upper ( sVal ) + sSaut
sMailBody+= "Description du problème : " 


sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "PROBLEME" ) )
Do While Len ( sVal ) > 0 
	sMailBody+=Left ( sVal, 60 ) + sSaut 
	sVal = Mid ( sVal, 61, Len ( sVal ) ) 
Loop

sMailBody+= sSaut
sMailBody+= sSaut


// [PC151259-1]
// [VDOC23412] 

// [VDOC26046]
sMailBody+= "Nous vous remercions de prendre contact avec l'assuré aux coordonnées ci-dessous afin :" + sSaut	
sMailBody+= "   -  De trouver dans un premier temps une solution téléphonique" + sSaut	
sMailBody+= "   -  Où si impossible intervenir à son domicile." + sSaut		

sMailBody+= sSaut

sMailBody+= "Nom : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) + sSaut
sMailBody+= "Prénom : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) + sSaut
sMailBody+= "Adresse postale : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" ) + " " 
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" ) + " " 
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPLT" ) + " "
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " 
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) + " " + sSaut
sMailBody+= "Adresse mail : " + F_GetItem3 ( idw_LstInter, 1, "ADR_MAIL" ) + sSaut

// [VDOC26046]
sMailBody+= "N° de tél de l'assuré (1) : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) + sSaut
sMailBody+= "N° de tél de l'assuré (2) : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL2" ) + sSaut	
sMailBody+= "N° de tél de l'assuré (3) : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL3" ) + sSaut	

sMailBody+= sSaut

If Not bPrestaSav Then

	sMailBody+= "Au cours de votre intervention, nous vous remercions de vérifier la conformité du n°IMEI/SERIE et d’effectuer une pré-expertise au regard des conditions d’exclusion du contrat d’assurance." + sSaut
	sMailBody+= sSaut
	sMailBody+= "Merci également de prendre en compte le montant du plafond d’indemnisation ci-dessous pour définir si l’appareil est réparable par vos soins." + sSaut
	sMailBody+= sSaut		
	
	/*------------------------------------------------------------------*/
	/* 7 : Montant Maximum majoré													  */
	/*------------------------------------------------------------------*/
	// mémorisation de la garantie
	lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
	sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
	// mémorisation de l'événement
	lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
	sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )
	
	lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
	dcMtMaxTTC = 0 
	If lRow > 0 Then
		dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
	End If
	
	
	//* F_Plafond_Pec 
	//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
	//*					  Pour le type Autre, le retour est sous cette forme
	//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
	//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)
	
	sVal = ""
	// [PC545].[BUG_BGE_721]
	//	[PC363].[10%]
	lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
	sVal = "[###]"
	
	If lRow > 0 Then
		lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
	End If
	
	// [PC301].[V15_EVOL_VETUSTE]
	lTotDetail = idw_wDetail.RowCount ()
	dcMtLu = 0
	dcMtMaxLu = 0
	For lCptDet = 1 To lTotDetail	
		
		sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
						"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
						"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
			
		lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
		If lRow > 0 Then
			dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
			If dcMtLu > dcMtMaxLu Then
				dcMtMaxLu = dcMtLu 
			End If
		End If					
		
	Next
	
	If dcMtMaxLu > 0 Then
		lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
	End If
	// [PC301].[V15_EVOL_VETUSTE]
	// :[PC545].[BUG_BGE_721]
	
	stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )
	
	//[BUG_STRUCTPB11]
	/*n_cst_debug_struct_pb11 lnvDebugStPb11
	lnvDebugStPb11.uf_verifstruct( stPlafPec, gstppecdebug , "uf_validation_finale_darty_mail_nomade1")*/
	//:[BUG_STRUCTPB11]
	
	If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
	If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
	If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
	If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
	If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
	If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0
	
	
	sMailBody+= String ( dcMtMaxTTC , "#####0.00" ) + " Euros TTC." + sSaut // [VDOC27245]
End If 

sMailBody+= sSaut
// [MANTIS24068] chgt adr mail
// [PC171918] chgt adr mail en dur par variable dp/252
sMailBody+= "Votre retour doit être adressé impérativement à l’adresse mail " + sBoiteMail + " ; l’objet "
sMailBody+= "du mail précisera obligatoirement la mention ADVISE5 et la référence du dossier sinistre : "
sMailBody+= "ADVISE5 - dossier n°" + sIdSin + " / " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + " - ADVISE 5/" + sIdSousFourn + sSaut
sMailBody+= sSaut

sMailBody+= "Nous restons à votre entière disposition pour tout renseignement complémentaire et vous prions d’agréer, nos salutations distinguées."

/*------------------------------------------------------------------*/
/* 9 : Etat de retour pour le réparateur                            */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="=========================================================================" + sSaut
sMailBody+="================ ZONE RESERVEE AU REPARATEUR " + sIdSousFourn + " ========" + sSaut
sMailBody+= "========================================================================" + sSaut
sMailBody+=sSaut
sMailBody+="NUM_INTERVENTION : ________________________" + sSaut
sMailBody+="DATE_DE_TRAITEMENT/ENVOI_CLIENT :   _ _ / _ _ / _ _ _ _" + sSaut
sMailBody+="BON_CHRONO (SI ENVOI)  : __________________________" + sSaut
sMailBody+="ETAT_PRESTATION_1 :  |_| Réparé" + sSaut
sMailBody+="ETAT_PRESTATION_2 :  |_| Irréparable couvert (Bris Visible Irréparable Economiquement)" + sSaut
sMailBody+="ETAT_PRESTATION_3 :  |_| Irréparable non couvert (Bris Non Visible)" + sSaut

// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "PRSADV"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )


bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function long uf_zn_trt_divsin_taille_ecran (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_taille_ecran (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 12/12/2016
//* Libellé			: 
//* Commentaires	: [DT269]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin, lVal1, lVal2

asData = Upper ( asData )
iAction = 0

lVal1 = idw_LstwCommande.rowCount() 

If lVal1 > 0  Then
		idw_wDivSin.iiErreur = 9
		iAction = 1
End If

Return iAction

end function

private subroutine uf_determiner_courrier_forcage_dp170 (ref string aspos, integer alcpt, ref string asidnatcour, ref string asidcour);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Determiner_Courrier_Forcage_DP170 (PRIVATE)
//* Auteur        : FPI
//* Date          : 11/05/2011
//* Libellé       : [PC514]
//* Commentaires  : 
//*
//* Arguments     : String 		asPos					Ref
//*					  Integer  		alCpt					Val
//*					  String			asIdNatCour			Ref
//*					  Integer		asIdCour				Ref
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*
//*-----------------------------------------------------------------

n_cst_string 		lnvPFCString
DataWindowChild	dwChild
String 				sIdNatPresent, sIdNatCourForcage, sRech, sIdGti
Long   				lDeb, lFin, lTotCourrier, lLig, lCpt
String 				sIdFour, sTypArt
Boolean				bChoixCritere

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 170 )
If lDeb <= 0 Then Return 

// Ne s'applique qu'à l'assuré
If idw_LstInter.GetItemString ( alCpt, "COD_INTER" ) <> "A" Then Return

For lCpt = lDeb To lFin

	bChoixCritere = FALSE

	sIdNatCourForcage = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ), "ID_COUR", ";")
	If IsNull ( sIdNatCourForcage ) Then sIdNatCourForcage  = ""
	
	sIdFour = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ), "ID_FOUR", ";")
	If IsNull ( sIdFour ) Then sIdFour  = ""
	
	sTypArt = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ), "ID_TYP_ART", ";")
	If IsNull ( sTypArt ) Then sTypArt  = ""
	
	sIdGti = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lCpt, "VAL_CAR" ), "ID_GTI", ";")
	If IsNull ( sTypArt ) Then sTypArt  = ""


	// Contrôle du param
	If sIdNatCourForcage="" Then Return
	If sIdFour = "" Then Return

	// Construction de la chaine de recherche
	sRech="COD_ETAT = 'CNV' AND ID_FOUR = '" + sIdFour + "' "
	
	If ( sTypArt = "" Or sTypArt = "-1" ) And ( sIdGti = "" Or sIdGti = "-1" ) Then
		bChoixCritere = True
	End if
	
	If Not bChoixCritere And sTypArt <> "" And sTypArt <> "-1" And ( sIdGti = "" Or sIdGti = "-1" ) Then
		bChoixCritere = True	
		sRech += "AND ID_TYP_ART = '" + sTypArt + "' "
	End if
	
	If Not bChoixCritere And sIdGti <> "" And sIdGti <> "-1" And ( sTypArt = "" Or sTypArt = "-1" ) Then
		bChoixCritere = True	
		sRech += "AND ID_GTI = " + sIdGti 
	End if
	
	If Not bChoixCritere And sIdGti <> "" And sIdGti <> "-1" And sTypArt <> "" And sTypArt <> "-1" Then
		bChoixCritere = True	
		sRech += "AND ID_GTI = " + sIdGti + " AND ID_TYP_ART = '" + sTypArt + "' "
	End if

	If bChoixCritere And idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.rowCount() ) > 0 Then
		Exit
	End If
	
Next

If Not bChoixCritere Then return

If idw_LstwCommande.Find ( sRech, 1, idw_LstwCommande.rowCount() ) > 0 Then
			
	sIdNatPresent = asIdNatCour
			
	If IsNull ( sIdNatPresent ) Then sIdNatPresent = ""
	
	If sIdNatPresent <> sIdNatCourForcage Then
	
		If IsNull ( sIdNatPresent ) Or Trim ( sIdNatPresent) = ""Then
			stMessage.bErreurG	= FALSE
			stMessage.Icon			= question!
			stMessage.sCode		= "WSIN610" // Pas de courrier auto, propsitino de forçage
			stMessage.Bouton		= YesNO!
			stMessage.sVar[1] 	= sIdNatCourForcage
					
		Else
			stMessage.bErreurG	= FALSE
			stMessage.Icon			= question!
			stMessage.sCode		= "WSIN615" // courrier auto présent+ proposition de forçage
			stMessage.Bouton		= YesNO!
			stMessage.sVar[1] 	= asIdNatCour
			stMessage.sVar[2] 	= sIdNatCourForcage
		End If 

		If F_Message ( stMessage ) = 1 Then
	
				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!							
	
				idw_LstInter.GetChild ( "ID_NAT_COUR", dwChild )
				lTotCourrier	= dwChild.RowCount ()
				sRech				= "ID_NAT_COUR = '" + sIdNatCourForcage + "'"
				lLig				= dwChild.Find ( sRech, 1, lTotCourrier )
			
			/*------------------------------------------------------------------*/
			/* On verifie si la nature de courrier existe. Si elle n'existe     */
			/* pas, par un effet du hasard bien sur, on arrete le traitement    */
			/* et on positionne sur REF_CIE.                                    */
			/*------------------------------------------------------------------*/
				If	lLig = 0	Then
			
			/*------------------------------------------------------------------*/
			/* On arme la structure de message maintenant, mais le message va   */
			/* être affiché dans le contrôle de gestion.                        */
			/*------------------------------------------------------------------*/
					stMessage.bErreurG	= FALSE
					stMessage.Icon			= Information!
					stMessage.sCode		= "WSIN170"
					stMessage.sVar[1] 	= sIdNatCourForcage
					asPos = "REF_CIE"
				Else
					If This.uf_GestionCP ( "DELETE", 0, "A" ) Then
						asIdNatCour = sIdNatCourForcage
						asIdCour		= dwChild.GetItemString ( lLig, "ID_COUR" )
						
						idw_LstInter.SetItem ( alCpt, "ALT_PART", "N" )
						idw_LstInter.SetItem ( alCpt, "ID_COUR", stNul.Str )
						idw_LstInter.SetItem ( alCpt, "ID_NAT_COUR", stNul.Str )
						
						// On force l'édition
						idw_wsin.setitem( 1, "ALT_EDIT","O")
					Else 
						// Le message est armé dans uf_GestionCP
						asPos = "REF_CIE"

					End If
				End If		// de la recherche du courrier
				
			End If // du f_message
	End If
End if


end subroutine

public function boolean uf_controlergestion_typ_app_ds (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_Typ_App_ds
//* Auteur			: JFF
//* Date				: 12/04/2012
//* Libellé			: [ITSM456410] 
//* Commentaires	: ATLAS ou SHERPA ou le SCRIPTING envoie de la merde vers SIMPA2, 
//*					  il faut donc contrôler la donnée présente car elle a pu ne pas être saisie par le GT
//*					  mais par un programme extérieur.
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 
//*-----------------------------------------------------------------

Boolean bRet
String sVal, sFiltreOrigDDDW
DataWindowChild dwChild
Long lRow

bRet = True

sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )

If sVal = "" Then Return TRUE

idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
If sFiltreOrigDDDW = "?" Then sFiltreOrigDDDW = ""

dwChild.SetFilter ( "UPPER ( NOM_ZONE ) = 'TYPE_APP'" ) 
dwChild.Filter ( ) 

lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

If lRow <= 0 Then
	bRet = False
	stMessage.bErreurG	= FALSE
	stMessage.sCode		= "WSIN812"		
	stMessage.Icon			= Exclamation!
	If asCas = "PREPA_MOD" Then	
		F_Message ( stMessage ) 	
	End If
End If

Return bRet
end function

private subroutine uf_controler_saisie_email (ref string astext, ref string aspos);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_ControlerSaisie_SMS (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 22/08/2003 15:04:10
//* Libellé       : On contrôle que tous les inters la gestion de suivi par SMS soit autorisée
//*				  	  
//* Commentaires  : [FNAC_PROD_ECH_TECH]
//*
//* Arguments     : Réf		asPos		String
//*					  Réf		asText	String
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   03/08/2009   [CAMARA].[PRESTA_WEB_BOUTIQUE]
//*-----------------------------------------------------------------

Long	lTotInter, lCptInter, lDeb, lFin
String	sAltSuiviSMS, sNumPortSms
Boolean  bDP104

If asPos <> "" Then Return

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 104 )
//* #1 [CAMARA].[PRESTA_WEB_BOUTIQUE]
bDP104 = lDeb > 0 

/*------------------------------------------------------------------*/
/* Controle des Communes/CP des inter.                              */
/*------------------------------------------------------------------*/
lTotInter = idw_LstInter.RowCount ()

For lCptInter = 1 To lTotInter
	sAltSuiviSMS = idw_LstInter.GetItemString ( lCptInter, "ALT_SUIVI_SMS" )

	If sAltSuiviSMS = "O" And Not bDP104 Then

		stMessage.sTitre		= "Contrôle de saisie d'un interlocuteur (SMS)"
		stMessage.Bouton		= Ok!
		stMessage.Icon			= Information!
		stMessage.bErreurG	= FALSE
		stMessage.sVar[1]		= idw_LstInter.GetItemString ( lCptInter, "NOM" ) 
		stMessage.sCode		= "WINT215"
		f_Message ( stMessage )
		asPos = "ADR_CP"
	End If
	
	If asPos <> "" Then 
		asText = asText + " - Décocher le suivi par SMS sur l'interlocuteur " + stMessage.sVar[1] + "~n~r"
		Exit
	End If

	If asPos = "" then
		If idw_LstInter.GetItemString ( lCptInter, "ALT_SUIVI_SMS" ) = "O" And bDP104 Then
			sNumPortSms = Trim ( idw_LstInter.GetItemString ( lCptInter, "NUM_PORT_SMS" ) )
			
			If IsNull ( sNumPortSms ) Or sNumPortSms = "" Then
			
				asPos = "ALT_BLOC"
				stMessage.sTitre		= "Gestion suivi par SMS"
				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!
				stMessage.bErreurG	= False
				stMessage.sCode		= "WINT221"
				f_Message ( stMessage )	
				asText = asText + " - Un numéro de GSM sur l'interlocuteur " + stMessage.sVar[1] + "~n~r"
				Exit
				
			End If
			
			//[NUM_TEL_07]
			If asPos = "" And ( Not IsNumber ( sNumPortSms ) Or Len ( sNumPortSms ) <> 10 Or ( Left ( sNumPortSms, 2 ) <> "06" And Left ( sNumPortSms, 2 ) <> "07" ) ) Then
				asPos = "ALT_BLOC"
				stMessage.sTitre		= "Gestion suivi par SMS"
				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!
				stMessage.bErreurG	= False
				stMessage.sCode		= "WINT226"
				f_Message ( stMessage )
				asText = asText + " - Corriger le numéro de GSM sur l'interlocuteur " + stMessage.sVar[1] + "~n~r"				
			End If
			
		End If
	End If
	
	//* #1 [CAMARA].[PRESTA_WEB_BOUTIQUE]
	If asPos = "" then
		If idw_LstInter.GetItemString ( lCptInter, "ALT_SUIVI_SMS" ) = "N" And bDP104 And &
			idw_LstwCommande.Find ( "COD_ETAT IN ( 'ECT', 'CNV') AND ID_TYP_ART = 'SMS'", 1, idw_LstwCommande.Rowcount ()) > 0  Then
				asPos = "ALT_BLOC"
				stMessage.sTitre		= "Gestion suivi par SMS"
				stMessage.Icon			= Information!
				stMessage.Bouton		= Ok!
				stMessage.bErreurG	= False
				stMessage.sCode		= "WINT227"
				f_Message ( stMessage )
				asText = asText + " - Corriger incohérence presta SMS et suivi SMS sur l'interlocuteur assuré " + "~n~r"				
		End If			
	End If

Next


end subroutine

private function boolean uf_validation_finale_advise6_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_advise6_mail  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 06/10/2017 
//* Libellé       : Gestion Particulière pour ADVISE 6.
//* Commentaires  : // [PC171918]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 		JFF	 23/02/2017   [MANTIS24068] chgt adr mail
// 		JFF	 29/03/2017   [VDOC23412] chgt de phrase
//       JFF    29/05/2017   [PC151259-2]
//       JFF    29/05/2017   [PC151259-2]
//       JFF    05/10/2017   [PC171918]
// 		JFF	 17/05/2018   [VDOC26177] maj mail
// 		JFF	 22/06/2018   [VDOC26344]
//       JFF    12/12/2018   [VDOC27245]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt, sIdSousFourn 
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sTypMail, sMailFrom, sSaut, sBoiteMail 
String sMailBody, sMailObjet, sXml, sMailDest, sIdFour, sNomAssure
Blob bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lTotDetail, lCptDet, lDeb, lFin, lIdProd
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString		
s_pass stPass
Integer iidAppli
String sMailCc, sMailCci
Boolean bPrestaSav 
Long lRowAssure

sMailCc=""
sSaut = char (10 )
sMailBody=""
sTypMail="PRSADV"
iidAppli=2

lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
// [PC151259-2] // [PC171918]
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN ( 'RAV', 'SFG' ) " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd <= 0 Then 
	// ON continue sans mail
	Return TRUE
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers TREMBLAY, on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD951"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdFour = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" ) 
sIdSousFourn = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "SOUS_FRN", ";")
If sIdSousFourn = "" Then sIdSousFourn = sIdFour 

bPrestaSav = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "A_REPARER_SAV", ";") = "OUI"
If Not bPrestaSav Then bPrestaSav = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "A_DESOXYDER_SAV", ";") = "OUI"
If Not bPrestaSav Then bPrestaSav = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "A_CONTROLER_SAV", ";") = "OUI"

F_RechDetPro ( lDeb, lFin, idw_DetPro, lIdProd, "-DP", 252 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
If IsNull ( sBoiteMail ) Then sBoiteMail = ""
sMailFrom=sBoiteMail

// Armement sMailDest
sMailDest = space ( 128 )

// [PC151259-2]
sMailDest = Trim ( uf_GestOng_Divers_Trouver("ADR_MAIL_REPA_ADH") )
If IsNull ( sMailDest ) Then sMailDest = ""

If sMailDest = "" Then
	sMailDest = "servicesinistre@advise-assurance.com" // Défaut donné par S.Vabre.
End If

sMailCci=""

/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 1ère ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
If bPrestaSav Then 
	sMailObjet= "Demande de prise en charge SAV - Dossier n°" + sIdSin + " / " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) ) + " - ADVISE 6/" + sIdSousFourn
Else
	sMailObjet= "Demande de réparation - Dossier n°" + sIdSin + " / " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) ) + " - ADVISE 6/" + sIdSousFourn
End If

// Assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )


sMailBody+= "Bonjour," + sSaut
sMailBody+= sSaut
sMailBody+= sSaut
sMailBody+= "Nous vous informons de la déclaration de sinistre de " + sNomAssure + " concernant le dommage de son appareil" + sSaut
sMailBody+= sSaut
sMailBody+= sSaut

sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
If sFiltreOrigDDDW = "?" Then sFiltreOrigDDDW = ""
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+= "Type : " + Upper ( sVal ) + sSaut
sMailBody+= "Marque : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + sSaut
sMailBody+= "Modèle : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) + sSaut
sMailBody+= "IMEI/SERIE : " + Upper ( F_GetItem3 ( idw_wSin, 1, "NUM_IMEI_PORT" ) ) + sSaut

// [VDOC26344]
lRowAssure=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())
sMailBody += "Tél. : " + F_GetItem3 ( idw_lstinter, lRowAssure, "NUM_TELD" ) + sSaut

sMailBody+="Date d'achat de l'appareil sinistré : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" )  + sSaut  // [PI056]

lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )

If lRow > 0 Then
	sVal = String ( idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" ) )
	If IsNull ( sVal ) Then sVal = "Absente"
End If

sMailBody+="Montant de la valeur d'achat : " + sVal + " €" + sSaut	

sMailBody+= "Date de survenance du sinistre : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" )  + sSaut	

sVal = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
idw_LstGti.GetChild ( "ID_GTI", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
If sFiltreOrigDDDW = "?" Then sFiltreOrigDDDW = ""
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_GTI = " + sVal, 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_GTI" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+= "Garantie : " + Upper ( sVal ) + sSaut
sMailBody+= "Description du problème : " 


sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "PROBLEME" ) )
Do While Len ( sVal ) > 0 
	sMailBody+=Left ( sVal, 60 ) + sSaut 
	sVal = Mid ( sVal, 61, Len ( sVal ) ) 
Loop

sMailBody+= sSaut
sMailBody+= sSaut


// [PC151259-1]
// [VDOC23412] 

// [VDOC26177]
	sMailBody+= "Nous vous remercions de prendre contact avec l'assuré aux coordonnées ci-dessous afin :" + sSaut	
	sMailBody+= "   -  De trouver dans un premier temps une solution téléphonique" + sSaut	
	sMailBody+= "   -  Où si impossible intervenir à son domicile." + sSaut		

sMailBody+= sSaut

sMailBody+= "Nom : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) + sSaut
sMailBody+= "Prénom : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) + sSaut
sMailBody+= "Adresse postale : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" ) + " " 
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" ) + " " 
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPLT" ) + " "
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " 
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) + " " + sSaut
sMailBody+= "Adresse mail : " + F_GetItem3 ( idw_LstInter, 1, "ADR_MAIL" ) + sSaut

// [VDOC26177]
sMailBody+= "N° de tél de l'assuré (1) : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL1" ) + sSaut
sMailBody+= "N° de tél de l'assuré (2) : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL2" ) + sSaut	
sMailBody+= "N° de tél de l'assuré (3) : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_TEL3" ) + sSaut	

sMailBody+= sSaut

If Not bPrestaSav Then 
	
	sMailBody+= "Au cours de votre intervention, nous vous remercions de vérifier la conformité du n°IMEI/SERIE et d’effectuer une pré-expertise au regard des conditions d’exclusion du contrat d’assurance." + sSaut

	sMailBody+= sSaut
	sMailBody+= "Merci également de prendre en compte le montant du plafond d’indemnisation ci-dessous pour définir si l’appareil est réparable par vos soins." + sSaut
	sMailBody+= sSaut		
	
	/*------------------------------------------------------------------*/
	/* 7 : Montant Maximum majoré													  */
	/*------------------------------------------------------------------*/
	// mémorisation de la garantie
	lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
	sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
	// mémorisation de l'événement
	lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
	sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )
	
	lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
	dcMtMaxTTC = 0 
	If lRow > 0 Then
		dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
	End If
	
	
	//* F_Plafond_Pec 
	//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
	//*					  Pour le type Autre, le retour est sous cette forme
	//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
	//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)
	
	sVal = ""
	// [PC545].[BUG_BGE_721]
	//	[PC363].[10%]
	lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
	sVal = "[###]"
	
	If lRow > 0 Then
		lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
	End If
	
	// [PC301].[V15_EVOL_VETUSTE]
	lTotDetail = idw_wDetail.RowCount ()
	dcMtLu = 0
	dcMtMaxLu = 0
	For lCptDet = 1 To lTotDetail	
		
		sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
						"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
						"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
			
		lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
		If lRow > 0 Then
			dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
			If dcMtLu > dcMtMaxLu Then
				dcMtMaxLu = dcMtLu 
			End If
		End If					
		
	Next
	
	If dcMtMaxLu > 0 Then
		lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
	End If
	// [PC301].[V15_EVOL_VETUSTE]
	// :[PC545].[BUG_BGE_721]
	
	stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )
	
	//[BUG_STRUCTPB11]
	/*n_cst_debug_struct_pb11 lnvDebugStPb11
	lnvDebugStPb11.uf_verifstruct( stPlafPec, gstppecdebug , "uf_validation_finale_darty_mail_nomade1")*/
	//:[BUG_STRUCTPB11]
	
	If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
	If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
	If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
	If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
	If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
	If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0
	
	
	sMailBody+= String ( dcMtMaxTTC , "#####0.00" ) + " Euros TTC." + sSaut // [VDOC27245]
End If 

sMailBody+= sSaut
// [MANTIS24068] chgt adr mail
// [PC171918] chgt adr mail en dur par variable dp/252
sMailBody+= "Votre retour doit être adressé impérativement à l’adresse mail " + sBoiteMail + " ; l’objet "
sMailBody+= "du mail précisera obligatoirement la mention ADVISE5 et la référence du dossier sinistre : "
sMailBody+= "ADVISE5 - dossier n°" + sIdSin + " / " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + " - ADVISE 6/" + sIdSousFourn + sSaut
sMailBody+= sSaut

sMailBody+= "Nous restons à votre entière disposition pour tout renseignement complémentaire et vous prions d’agréer, nos salutations distinguées."

/*------------------------------------------------------------------*/
/* 9 : Etat de retour pour le réparateur                            */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="=========================================================================" + sSaut
sMailBody+="================ ZONE RESERVEE AU REPARATEUR " + sIdSousFourn + " ========" + sSaut
sMailBody+= "========================================================================" + sSaut
sMailBody+=sSaut
sMailBody+="NUM_INTERVENTION : ________________________" + sSaut
sMailBody+="DATE_DE_TRAITEMENT/ENVOI_CLIENT :   _ _ / _ _ / _ _ _ _" + sSaut
sMailBody+="BON_CHRONO (SI ENVOI)  : __________________________" + sSaut
sMailBody+="ETAT_PRESTATION_1 :  |_| Réparé" + sSaut
sMailBody+="ETAT_PRESTATION_2 :  |_| Irréparable couvert (Bris Visible Irréparable Economiquement)" + sSaut
sMailBody+=sSaut
// [PC171918]
sMailBody+="        Si irréparable couvert alors y a-t-il eu un SWAP ? : |_| " + sSaut
sMailBody+="        Si oui, quel marque : |_________________________________| " + sSaut
sMailBody+="        Si oui, quel modèle : |_________________________________| " + sSaut
sMailBody+="        le numéro de série  : |_________________________________| " + sSaut
sMailBody+="        le prix TTC         : |______________,_________________€| " + sSaut
sMailBody+="        l'état              : NEUF |_|    RECONDITIONNE |_|       " + sSaut
sMailBody+=sSaut
sMailBody+="ETAT_PRESTATION_3 :  |_| Irréparable non couvert (Bris Non Visible)" + sSaut



// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "PRSADV"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )


bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function long uf_zn_trt_divsin_pceillisiblecasto (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_PceIllisibleCasto (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 31/10/2017
//* Libellé			: 
//* Commentaires	: [DT330]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin, lVal1, lVal2

asData = Upper ( asData )
iAction = 0

If Upper ( asData ) = "O" Then
	stMessage.sTitre		= "Pièces Illisibles"
	stMessage.Icon		= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "WSIN816"
	
	F_Message ( stMessage )
	
End If 

Return iAction

end function

private function long uf_zn_trt_divsin_forcer_refus_1676 (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_forcer_refus_1676 (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 27/11/2017
//* Libellé			: 
//* Commentaires	: // [PM426-2]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//        JFF   27/11/2017   [PM426-2]
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin, lVal1, lVal2

asData = Upper ( asData )
iAction = 0

lVal1 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND VAL_CAR = 'O'", 1, idw_wDivDet.RowCount () )
lVal2 = idw_LstGti.Find ( "COD_ETAT IN ( 500, 550, 600 )", 1, idw_LstGti.RowCount () )

If lVal1 > 0 Or lVal2 > 0 Then
		idw_wDivSin.iiErreur = 7
		iAction = 1
End If

Return iAction


end function

private function boolean uf_controlergestion_orangeparnasse (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_OrangeParnasse (PRIVATE)
//* Auteur			: JFF
//* Date				: 13/02/2018
//* Libellé			: Fonction pilotant les modification liées à OrangeParnasse
//* Commentaires	: [DT346]
//*
//* Arguments		: Val		String		asCas "PREPA_MOD", "CTRLEGES"
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*	    JFF 		 26/09/2018 [VDOC26840]
//*-----------------------------------------------------------------

Long lDeb, lFin, lIdNatSin, lCodEtat, lTot, lRow, lCpt, lDecAssureur 
Boolean bLock, bAMUPEC, bAMUForcageRegl, bAMUForcagePEC, bMtReg, bAMUCmdeValidee, bAMUPECValidee
String sOriFilter, sFilter

String sClientVIP, sVal, sMes

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 272 )
If lDeb <= 0 Then Return True

sClientVIP = Trim ( uf_GestOng_Divers_Trouver ("CLIENT_VIP") )

If IsNull ( sClientVIP ) Then sClientVIP = ""

If sClientVIP <> "VIPPAR" Then Return True

lRow = idw_LstInter.Find ( "COD_INTER = 'A'", 1, idw_LstInter.RowCount ())

stMessage.sTitre		= "DT346/Gestion Orange Parnasse"
stMessage.Icon			= Information!
stMessage.bErreurG	= FALSE
stMessage.Bouton		= OK!
stMessage.sCode		= "WSIN817"

F_Message ( stMessage )

// Forçage du RIB
idw_LstInter.SetItem ( lRow, "COD_MODE_REG", "VA" )
idw_LstInter.SetItem ( lRow, "RIB_BQ",  "30004" )
idw_LstInter.SetItem ( lRow, "RIB_GUI", "00274" )		
idw_LstInter.SetItem ( lRow, "RIB_CPT", "00010742381" )				
idw_LstInter.SetItem ( lRow, "RIB_CLE", "58" )


// Forçage mail si pas de mail.
idw_LstInter.SetItem ( lRow, "ADR_MAIL", "desk@parnasse.fr" )
This.uf_decompo_adr_mail ()

If asCas = "CTRLE_GES" Then	
	lRow = idw_LstInter.Find ( "COD_INTER = 'T'", 1, idw_LstInter.RowCount ())
	
	If lRow > 0 Then
		stMessage.sTitre		= "DT346/Gestion Orange Parnasse"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sCode		= "WSIN818"
		
		F_Message ( stMessage )	
		
		Return False
	End If
End If 		


Return TRUE
end function

private function long uf_zn_trt_divsin_typapparecaneu (string asdata, string asnomcol, long alrow, boolean abforcer);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_TypAppARecANeu (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 05/03/2018
//* Libellé			: Contrôle de la zone virtuelle ChoixPack
//* Commentaires	: [VDOC25738]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*					  Boolean		abForcer			Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

String sTypeApp, sIdMarq, sTypAppActuel
DataWindowChild dwChild
Integer iAction
Long lRow, lDeb, lFin

sTypeApp = Upper ( asData )
sTypAppActuel = This.uf_GestOng_Divers_Trouver ( "TYPAPP_AREC_ANEU" )

If IsNull ( sTypAppActuel ) Then sTypAppActuel = "" 

iAction = 0

If sTypAppActuel <> "" And idw_wDetail.Find ( "COD_ETAT = 600 OR COD_ETAT = 500", 1, idw_wDetail.RowCount () ) + &
	idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' ", 1, idw_LstwCommande.RowCount () ) + &
	idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'PEC' AND ( VAL_LST_CAR = 'O' Or VAL_CAR = 'O' )", 1, idw_wDivDet.Rowcount () ) > 0 And Not abForcer Then
		idw_wDivSin.iiErreur = 10
		iAction = 1
End If

Return iAction


end function

public function boolean uf_controlergestion_refareexp_cordon ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_RefAReexp_Cordon (PRIVATE)
//* Auteur			: JFF
//* Date				: 19/04/2018
//* Libellé			: 
//* Commentaires	: [DT288-4]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bRet (False si blocage)
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 		JFF	 06/08/2018   [MANTIS28873] ajout BVIE
//       JFF    21/11/2018   [VDOC27123]
//*-----------------------------------------------------------------

String sPos, sIMEI
Boolean bMtAReg, bPrestaCNV, bPEC 
Long lDeb, lFin, lVal, lRow
date dDtePivot 

sPos = ""

lVal = idw_LstGti.Find ( "ID_GTI IN ( 11 ) AND COD_ETAT = 200", 1, idw_LstGti.RowCount() )

// [VDOC27123]BVID/BVIP/BVIT
If lVal > 0 And idw_LstwCommande.Find ( "ID_FOUR = 'COR' AND COD_ETAT <> 'ANN' AND STATUS_GC = 21 AND ( POS ( COMMENT_FRN, '[BVIE]' ) > 0 OR POS ( COMMENT_FRN, '[BVID]' ) > 0 OR POS ( COMMENT_FRN, '[BVIP]' ) > 0 OR POS ( COMMENT_FRN, '[BVIT]' ) > 0 )", 1, idw_LstwCommande.RowCount ()) > 0 Then

	dDtePivot = Today ()
	dDtePivot = F_PLUS_DATE ( dDtePivot, -30, "J" )

	// [VDOC27123]BVID/BVIP/BVIT
	lRow = idw_LstwCommande.Find ( "ID_FOUR = 'COR' AND COD_ETAT <> 'ANN' AND STATUS_GC = 21 AND ( POS ( COMMENT_FRN, '[BVIE]' ) > 0 OR POS ( COMMENT_FRN, '[BVID]' ) > 0 OR POS ( COMMENT_FRN, '[BVIP]' ) > 0 OR POS ( COMMENT_FRN, '[BVIT]' ) > 0 ) AND DTE_ENV_CLI >= DATETIME ( '" + String ( dDtePivot, "yyyy-mm-dd hh:mm:ss" ) + "')", 1, idw_LstwCommande.RowCount ())

	If lRow <= 0 Then
		stMessage.sTitre		= "DT288 : Condition commande CORDON"
		stMessage.Icon			= Exclamation!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= Ok!
		stMessage.sCode = "WSIN821"
		F_Message ( stMessage ) 
		// On ne bloque pas, c'est informatif
	End IF 
	
End If

Return TRUE

end function

private function boolean uf_validation_finale_advise_aas_mail ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_advise_AAS_mail  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 02/08/2018
//* Libellé       : Gestion Particulière pour ADVISE pour AAS.
//* Commentaires  : // [DT363]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 		JFF	 23/02/2017   [MANTIS24068] chgt adr mail
// 		JFF	 29/03/2017   [VDOC23412] chgt de phrase
//       JFF    29/05/2017   [PC151259-2]
//       JFF    29/05/2017   [PC151259-2]
//       JFF    05/10/2017   [PC171918]
// 		JFF	 17/05/2018   [VDOC26177] maj mail
// 		JFF	 22/06/2018   [VDOC26344]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt, sIdSousFourn 
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sTypMail, sMailFrom, sSaut, sBoiteMail 
String sMailBody, sMailObjet, sXml, sMailDest, sIdFour, sNomAssure
Blob bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lTotDetail, lCptDet, lDeb, lFin, lIdProd
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu, dcMtPec
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString		
s_pass stPass
Integer iidAppli
String sMailCc, sMailCci, sMtPec , sSql 
Boolean bPrestaSav 
Long lRowAssure

sMailCc=""
sSaut = char (10 )
sMailBody=""
sTypMail="PRSADV"
iidAppli=2

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
// [PC151259-2] // [PC171918]
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN ( 'AAS' ) " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd <= 0 Then 
	// ON continue sans mail
	Return TRUE
End If

lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )
sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))
lIdDetail=idw_LstwCommande.GetItemNumber(1,"ID_DETAIL")
lIdGti=idw_LstwCommande.GetItemNumber(1,"ID_GTI")
lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )


/*------------------------------------------------------------------*/
/* Plus d'une prestation vers TREMBLAY, on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD951"

	F_Message ( stMessage ) 
	Return FALSE
End If


// Récup du mt de PEC
dcMtPec=0.00
lRow=idw_wdivdet.Find("UPPER ( NOM_ZONE ) = 'MT_PEC'  AND ID_DETAIL=" + String(lIdDetail) + " AND ID_GTI=" + String(lIdGti),1,idw_wdivdet.RowCount())
If lRow > 0 Then
	dcMtPec=idw_wdivdet.GetItemDecimal(lRow,"VAL_MT")
	If isNull(dcMtPec) Then dcMtPec=0.00
	sMtPec = String ( dcMtPec, "#,##0.00" )
End if


sSql = "Exec sysadm.PS_I_MAILPUSH_DT363_REMPL_AAS " + & 
				String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "." + &
				", -1" +  & 
				", " + String ( lIdProd ) + &
				", " + String ( lIdGti ) + &
				", '" + sMtPec + "'" 				
				
F_Execute ( sSql, SQLCA )
bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0



Return bRet

end function

private function boolean uf_validation_finale_samsung_infopec ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_Samsung_InfoPec  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 05/10/2017 
//* Libellé       : Mail samsung.
//* Commentaires  : // [DT361]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 		JFF	 23/02/2017   [MANTIS24068] chgt adr mail
// 		JFF	 29/03/2017   [VDOC23412] chgt de phrase
//       JFF    29/05/2017   [PC151259-2]
//       JFF    29/05/2017   [PC151259-2]
//       JFF    05/10/2017   [PC171918]
// 		JFF	 17/05/2018   [VDOC26177] maj mail
// 		JFF	 22/06/2018   [VDOC26344]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt, sIdSousFourn 
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sTypMail, sMailFrom, sSaut, sBoiteMail 
String sMailBody, sMailObjet, sXml, sMailDest, sIdFour, sNomAssure, sIdCertificat
Blob bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lTotDetail, lCptDet, lDeb, lFin, lIdProd
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString		
s_pass stPass
Integer iidAppli
String sMailCc, sMailCci
Boolean bPrestaSav 
Long lRowAssure

sMailCc=""
sSaut = char (10 )
sMailBody=""
sTypMail="SAMPEC"
iidAppli=2

lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))
sIdCertificat = idw_WSin.GetItemString ( 1, "ID_CONTRAT_ABONNE" )
If IsNull ( sIdCertificat ) Then sIdCertificat = ""

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
// [PC151259-2] // [PC171918]
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN ( 'CEA' ) " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd <= 0 Then 
	// ON continue sans mail
	Return TRUE
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers TREMBLAY, on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD951"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

F_RechDetPro ( lDeb, lFin, idw_DetPro, lIdProd, "-DP", 294 )

sMailFrom = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
If IsNull ( sMailFrom ) Then sMailFrom = ""

sMailDest = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_INFO_PEC", ";")
If IsNull ( sMailDest ) Then sMailDest = ""

sMailCci=""

sMailObjet= "SPB - confirmation de prise en charge " + sIdCertificat

// Assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )

lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )

sMailBody+= "Bonjour," + sSaut
sMailBody+= sSaut
sMailBody+= sSaut
sMailBody+= "Suite à la déclaration "

Choose Case lIdGti 
	Case 10
		sMailBody+= "d'un vol"

	Case 12
		sMailBody+= "d'une perte"		

	Case 24
		sMailBody+= "d'une oxydation"		

	Case Else
		sMailBody+= "d'un dommage"		

End Choose 

sMailBody+= " dans le cadre de l'Assurance Garanties Dommages Smartphone & Tablette, nous vous informons de la prise en charge du dossier : " + sSaut
sMailBody+= sSaut

sMailBody+= "Dossier : " + sIdSin + sSaut
sMailBody+= sSaut

sMailBody+= sNomAssure + sSaut
sMailBody+= Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_1" ) ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_2" ) ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_CPLT" ) ) + sSaut
sMailBody+= Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) ) + sSaut
sMailBody+= sSaut

lRowAssure=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())
sMailBody += "Tél. : " + F_GetItem3 ( idw_lstinter, lRowAssure, "NUM_TELD" ) + sSaut
sMailBody += "Mail : " + F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_MAIL" ) + sSaut
sMailBody+= sSaut

sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
If sFiltreOrigDDDW = "?" Then sFiltreOrigDDDW = ""
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+= "Type : " + Upper ( sVal ) + sSaut
sMailBody+= "Marque : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + sSaut
sMailBody+= "Modèle : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) + sSaut
sMailBody+= "IMEI/SERIE : " + Upper ( F_GetItem3 ( idw_wSin, 1, "NUM_IMEI_PORT" ) ) + sSaut

sMailBody+= sSaut

sMailBody+= "Conformément au process, à la suite de la déclaration de sinistre, nous transférons l'assuré vers vos services afin que vous conveniez ensemble des modalités d'enlèvement. Nous lui avons également indiqué vos coordonnées." + sSaut
sMailBody+= sSaut

sMailBody+= "Cordialement," + sSaut
sMailBody+= "SPB" + sSaut
sMailBody+= "SAMSUNG - Garanties Dommages Smartphone & Tablette" + sSaut
sMailBody+= "CS 90000" + sSaut
sMailBody+= "76095 LE HAVRE CEDEX" + sSaut

sMailBody+= sSaut
sMailBody+= sSaut



// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = sTypMail

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )


bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private function boolean uf_controlergestion_pm445 ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_PM445 (PRIVATE)
//* Auteur			: JFF
//* Date				: 04/10/2018
//* Libellé			: Fonction pilotant les modification liées au PM445
//* Commentaires	: [PM445-1]
//*
//* Arguments		: Val		String		asCas "PREPA_MOD", "CTRLEGES"
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*	    JFF 		 26/09/2018 [VDOC26840]
//*-----------------------------------------------------------------

Boolean bRet 
Long lPresenceRempl, lPresenceRegl, lPresenceDuCas , lVal, lPresenceAREMPL, lPresenceNEPASREMPL

bRet = TRUE

// [PM445-1]


lPresenceRempl = 0
lPresenceRegl = 0
lPresenceDuCas = 0

lVal = idw_LstwCommande.Find ( &
		"ID_REF_FOUR IN ( 'A_REPARER', 'A_DESOXYDER', 'A_DIAGNOSTIQUER' ) AND " + &
		"ISNULL ( DTE_RCP_FRN ) AND LEN ( ID_BON_TRANSP ) > 0 AND " + &
		"POS ( INFO_FRN_SPB_CPLT, 'PRBLE_LIVRAISON' ) > 0 AND " + &
		"POS ( INFO_FRN_SPB_CPLT, 'PERTE_ALLER' ) > 0 AND " + &
		"COD_ETAT IN ( 'ECT', 'ECL' )", &
		1, idw_LstwCommande.RoWCount () )

lPresenceDuCas = lVal

If lVal > 0 Then 

	lVal = idw_LstwCommande.GetItemNumber ( lVal, "ID_SEQ" )

//				" AND CPT_VALIDE > 0" +  &
	lPresenceRempl = idw_LstwCommande.Find ( &
			"( ID_TYP_ART NOT IN ( 'DEV', 'AEF', 'CAS', 'SMS', 'BAM', 'ALE', 'ACC', 'PCM', 'MAI', 'REL', 'PST', 'RES', 'REA', 'PRS', 'EDI', 'RST' ) " + &
			"  OR " + &
			"  ( ID_TYP_ART = 'RST' AND POS ( INFO_SPB_FRN_CPLT, 'RST_CMDE+SUIVI=OUI' ) > 0 ) " + &
			") " + &
			" AND ( STATUS_GC NOT IN ( 176 ) AND COD_ETAT <> 'ANN' ) " + &
 			" AND ID_SEQ > " + String ( lVal ) &					
			, 1, idw_LstwCommande.RowCount ()) 			
			
End If	

lPresenceRegl  = idw_wDetail.Find ( "ID_I_REG = 0 AND COD_ETAT IN (500, 600)", 1, idw_wDetail.RowCount() )


lPresenceAREMPL = idw_LstwCommande.Find ( &
		"ID_REF_FOUR IN ( 'A_REMPLACER' ) AND " + &
		"COD_ETAT <> 'ANN'", &
		1, idw_LstwCommande.RoWCount () )

lPresenceNEPASREMPL= idw_LstwCommande.Find ( &
		"ID_REF_FOUR IN ( 'NE_PAS_REMPLACER' ) AND " + &
		"COD_ETAT <> 'ANN'", &
		1, idw_LstwCommande.RoWCount () )


// Si présence du cas ET présence d'un réglement ou remplacement et Absence d'un flux A_REMPLACER, NE_PAS_REMPLACER alors bloquer
If bRet and lPresenceDuCas > 0 And( lPresenceRegl > 0 Or lPresenceRempl > 0 ) And lPresenceAREMPL <= 0 and lPresenceNEPASREMPL <= 0 Then
	bRet = False
	
	stMessage.sTitre		= "PM445"
	stMessage.Icon			= Information!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "WSIN830"
	
	F_Message ( stMessage )	
End If 


// Si présence du cas Et Si presta A_REMPLACER et Présence d'un règlement Ou d'un remplacement alors Bloquer
If bRet and lPresenceDuCas > 0 and lPresenceAREMPL > 0 And( lPresenceRegl > 0 Or lPresenceRempl > 0 )Then
	bRet = False
	
	stMessage.sTitre		= "PM445"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "WSIN828"
	
	F_Message ( stMessage )	
End If 

// Si présence du cas Et Si presta NE_PAS_REMPLACER et Absence d'un règlement ET d'un remplacement Alors prévenir Oui/NON
If bRet and lPresenceDuCas > 0 and lPresenceNEPASREMPL > 0 And lPresenceRegl <= 0 And lPresenceRempl <= 0 Then

	stMessage.sTitre		= "PM445"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= YESNO!
	stMessage.sCode		= "WSIN829"
	
	If F_Message ( stMessage )	= 2 Then 
		bRet = False
	End If
End If 


Return bRet 
end function

private function string uf_controlergestion_redrbtqcentralpsm ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_RedrBtqCentralPSM
//* Auteur			: Fabry JF
//* Date				: 05/02/2019
//* Libellé			: 
//* Commentaires	: [REDR_BTQ_PSM]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   Date	      Modification
//*-----------------------------------------------------------------

Long lCpt, lDeb, lTot, lVal
Int iPos1, iPos2
String sPos, sVal, sVal1, sVal2
n_cst_string lnvPFCString

sPos = ""

lTot = idw_LstwCommande.RowCount ()

For lCpt = 1 To lTot 
	
	If idw_LstwCommande.GetItemString ( lCpt , "ID_FOUR" ) = "PSM" Then
		sVal = idw_LstwCommande.GetItemString ( lCpt, "INFO_SPB_FRN_CPLT" )
		sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sVal, "CODE_BTQ_PSM_CENTRALE", ";"))
		If sVal1 = "" Then
			sVal2 = Trim ( lnvPFCString.of_getkeyvalue (sVal, "CODE_BTQ_PSM_PROXIMITE", ";"))
			If sVal2 <> "" Then
				iPos1 = Pos ( sVal2, "#" ) 
				iPos2 = Pos ( sVal2, "#", iPos1 + 1 ) 
				sVal2 = Trim ( Mid ( sVal2, iPos1 + 1, iPos2 - ( iPos1 + 1 ) ))
			End IF 
			
			If sVal2 = "" Then sVal2 = "33"
			
			lnvPFCString.of_Setkeyvalue ( sVal, "CODE_BTQ_PSM_CENTRALE", sVal2, ";")
			idw_LstwCommande.SetItem ( lCpt , "INFO_SPB_FRN_CPLT", sVal )
		End If 	
	End If 
Next 

Return sPos


end function

private function boolean uf_validation_finale_adviserepa_mail (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_validation_finale_adviserepa_mail  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 05/03/2019
//* Libellé       : Gestion Particulière pour ADVISE 5/6 et Répa AAS
//* Commentaires  : // [PC171918] // [DT401]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 		JFF	 23/02/2017   [MANTIS24068] chgt adr mail
// 		JFF	 29/03/2017   [VDOC23412] chgt de phrase
//       JFF    29/05/2017   [PC151259-2]
//       JFF    29/05/2017   [PC151259-2]
//       JFF    05/10/2017   [PC171918]
// 		JFF	 17/05/2018   [VDOC26177] maj mail
// 		JFF	 22/06/2018   [VDOC26344]
//       JFF    12/12/2018   [VDOC27245]
//       JFF	 16/04/2019	  [VDOC27852]
//*-----------------------------------------------------------------

Boolean bRet
String  sFiltreOrig, sFiltre, sRep, sIdSin, sFic, sRepFic, sNomMagasin, sIdGti, sIdEvt, sIdSousFourn 
String  sIdDetail, sRech, sMtValAchat, sVal, sFiltreOrigDDDW, sTypMail, sMailFrom, sSaut, sBoiteMail 
String sMailBody, sMailObjet, sXml, sMailDest, sIdFour, sNomAssure
Blob bMailBody
Long 	  lRow, lTotCmd, lCptCmd, lIdGti, lIdDetail, lTotDetail, lCptDet, lDeb, lFin, lIdProd
DataWindowChild dwChild
Decimal{2}	dcMtMaxTTC, dcMtLu, dcMtMaxLu
s_Plafond_Pec stPlafPec
U_Datawindow udwNull
n_cst_string lnvPFCString
s_pass stPass
Integer iidAppli
String sMailCc, sMailCci, sLibProduit
Boolean bPrestaSav 
Long lRowAssure

sMailCc=""
sSaut = char (10 )
sMailBody=""
sTypMail="PRSADV"
iidAppli=2

Choose Case asCas 
	Case "ADVISE_5" 
		sLibProduit = "ADVISE 5"
	Case "ADVISE_6" 
		sLibProduit = "ADVISE 6"
	Case Else 
		sLibProduit = "ADVISE"
End Choose

lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
// [PC151259-2] // [PC171918]
sFiltre = "ID_TYP_ART = 'PRS' AND " + &		
			 "COD_ETAT   = 'CNV' AND " + &  
			 "CPT_VALIDE <= 0    AND " + &
			 "ID_FOUR    IN ( 'EKO', 'DGC', 'NET', 'SMT', 'RAV', 'RTP', 'RAV', 'SFG', 'AAS' ) " 

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd <= 0 Then 
	// ON continue sans mail
	Return TRUE
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers TREMBLAY, on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Problème construction mail"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sCode		= "COMD951"

	F_Message ( stMessage ) 
	Return FALSE
End If

For lCptCmd = 1 To lTotCmd 
	If IsNull ( idw_LstwCommande.GetItemString ( lCptCmd, "ADR_LIVR2" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR2", "" ) 
	End If
	If IsNull ( idw_LstwCommande.GetItemString ( 1, "ADR_LIVR_CPL" ) ) Then
		idw_LstwCommande.SetItem ( lCptCmd, "ADR_LIVR_CPL", "" ) 
	End If
Next

sIdFour = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" ) 
sIdSousFourn = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "SOUS_FRN", ";")
If sIdSousFourn = "" Then sIdSousFourn = sIdFour 

bPrestaSav = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "A_REPARER_SAV", ";") = "OUI"
If Not bPrestaSav Then bPrestaSav = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "A_DESOXYDER_SAV", ";") = "OUI"
If Not bPrestaSav Then bPrestaSav = lnvPFCString.of_getkeyvalue (idw_LstwCommande.GetItemString ( 1, "INFO_SPB_FRN_CPLT" ), "A_CONTROLER_SAV", ";") = "OUI"

F_RechDetPro ( lDeb, lFin, idw_DetPro, lIdProd, "-DP", 252 )

sBoiteMail = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "BOITE_MAIL", ";")
If IsNull ( sBoiteMail ) Then sBoiteMail = ""
sMailFrom=sBoiteMail

// Armement sMailDest
sMailDest = space ( 128 )

// [PC151259-2]
If sIdFour = "AAS" Then
	sMailDest = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ADR_MAIL_AAS", ";")	
	If IsNull ( sMailDest ) Then sMailDest = ""	
Else 
	sMailDest = Trim ( uf_GestOng_Divers_Trouver("ADR_MAIL_REPA_ADH") )
	If IsNull ( sMailDest ) Then sMailDest = ""
End If 

If sMailDest = "" Then
	sMailDest = "servicesinistre@advise-assurance.com" // Défaut donné par S.Vabre.
End If

sMailCci=""

/*------------------------------------------------------------------*/
/* 1 : Ligne Objet du mail --> 1ère ligne du fichier Texte qui      */
/* devra être Découpé par EIN et placé en objet.                    */
/*------------------------------------------------------------------*/
If bPrestaSav Then 
	sMailObjet= "Demande de prise en charge SAV - Dossier n°" + sIdSin + " / " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) ) + " - " + sLibProduit + "/" + sIdSousFourn
Else
	// [VDOC27852]
	sMailObjet= "Demande de prestation - Dossier n°" + sIdSin + " / " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) ) + " " + Upper ( F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) ) + " - " + sLibProduit + "/" + sIdSousFourn
End If

// Assuré
sNomAssure = ""
idw_wsin.GetChild ( "COD_CIV", dwChild )
lRow = dwChild.Find ( "ID_CODE = " + F_GetItem3 ( idw_wsin, 1, "COD_CIV" ), 1, dwChild.RowCount())
If lRow > 0 Then
	sNomAssure = dwChild.GetItemString ( lRow, "LIB_CODE" )
End If
sNomAssure +=" " + F_GetItem3 ( idw_wsin, 1, "NOM" ) + " " + F_GetItem3 ( idw_wsin, 1, "PRENOM" )


sMailBody+= "Bonjour," + sSaut
sMailBody+= sSaut
sMailBody+= sSaut
sMailBody+= "Nous vous informons de la déclaration de sinistre de " + sNomAssure + " concernant le dommage de son appareil" + sSaut
sMailBody+= sSaut
sMailBody+= sSaut

sVal= This.uf_GestOng_Divers_Trouver ( "TYPE_APP" )
idw_WDivSin.GetChild ( "VAL_LST_CAR", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
If sFiltreOrigDDDW = "?" Then sFiltreOrigDDDW = ""
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_CODE = '" + sVal + "'", 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_CODE" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+= "Type : " + Upper ( sVal ) + sSaut
sMailBody+= "Marque : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MARQ_PORT" ) ) + sSaut
sMailBody+= "Modèle : " + Upper ( F_GetItem3 ( idw_wSin, 1, "MODL_PORT" ) ) + sSaut
sMailBody+= "IMEI/SERIE : " + Upper ( F_GetItem3 ( idw_wSin, 1, "NUM_IMEI_PORT" ) ) + sSaut

// [VDOC26344]
// [VDOC27852]
sMailBody += "Tél. : " + F_GetItem3 ( idw_wSin, 1, "NUM_PORT" ) + sSaut		
sMailBody+="Date d'achat de l'appareil sinistré : " + String ( idw_wSin.GetItemDateTime ( 1, "DTE_ACH_PORT" ), "dd/mm/yyyy" )  + sSaut  // [PI056]

lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )

lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )

If lRow > 0 Then
	sVal = String ( idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" ) )
	If IsNull ( sVal ) Then sVal = "Absente"
End If

sMailBody+="Montant de la valeur d'achat : " + sVal + " €" + sSaut	

sMailBody+= "Date de survenance du sinistre : " + String ( Date ( idw_wSin.GetItemDateTime ( 1, "DTE_SURV" )), "dd/mm/yyyy" )  + sSaut	

sVal = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
idw_LstGti.GetChild ( "ID_GTI", dwChild )
sFiltreOrigDDDW = dwChild.Describe ( "datawindow.table.filter" )
If sFiltreOrigDDDW = "?" Then sFiltreOrigDDDW = ""
dwChild.SetFilter ( "" ) 
dwChild.Filter ( ) 
lRow = dwChild.Find ( "ID_GTI = " + sVal, 1, dwChild.RowCount () )
sVal = dwChild.GetItemString ( lRow, "LIB_GTI" ) 
dwChild.SetFilter ( sFiltreOrigDDDW  ) 
dwChild.Filter ( ) 

sMailBody+= "Garantie : " + Upper ( sVal ) + sSaut
sMailBody+= "Description du problème : " 


sVal = Upper ( F_GetItem3 ( idw_LstwCommande, 1, "PROBLEME" ) )
Do While Len ( sVal ) > 0 
	sMailBody+=Left ( sVal, 60 ) + sSaut 
	sVal = Mid ( sVal, 61, Len ( sVal ) ) 
Loop

sMailBody+= sSaut
sMailBody+= sSaut


// [PC151259-1]
// [VDOC23412] 

// [VDOC27852]
Choose Case sIdFour
	Case "SFG"
	// [VDOC26177]
		sMailBody+= "Nous vous remercions de prendre contact avec l'assuré aux coordonnées ci-dessous afin :" + sSaut	
		sMailBody+= "   -  De trouver dans un premier temps une solution téléphonique" + sSaut
		sMailBody+= "   -  Où si impossible, intervenir à son domicile alors." + sSaut		
		
	Case "AAS" 
		sMailBody+= "Nous vous remercions d'adresser à l'assuré les éléments d'information en vue de réaliser la prestation." + sSaut	
		
	Case Else 
		sMailBody+= "Nous vous remercions de prendre contact avec l'assuré aux coordonnées ci-dessous afin :" + sSaut	
		sMailBody+= "   -  De trouver dans un premier temps une solution téléphonique" + sSaut
		sMailBody+= "   -  Où si impossible, intervenir en station alors." + sSaut					
End Choose
	
sMailBody+= sSaut

// [VDOC27852]
sMailBody+= "Nom : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_NOM" ) + sSaut
sMailBody+= "Prénom : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_PRENOM" ) + sSaut
sMailBody+= "Adresse postale : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR1" ) + " " 
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR2" ) + " " 
sMailBody+= F_GetItem3 ( idw_LstwCommande, 1, "ADR_LIVR_CPLT" ) + " " + sSaut
sMailBody+= "Code postal : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_CP" ) + " " + sSaut
sMailBody+= "Ville : " + F_GetItem3 ( idw_LstwCommande, 1, "ADR_VILLE" ) + " " + sSaut
sMailBody+= "Adresse mail : " + F_GetItem3 ( idw_LstInter, 1, "ADR_MAIL" ) + sSaut

// [VDOC26177]
// [VDOC27852]
lRowAssure=idw_lstinter.Find("COD_INTER='A'",1,idw_lstinter.RowCount())
sMailBody+= "N° de tél de l'assuré : " + F_GetItem3 ( idw_lstinter, lRowAssure, "NUM_TELD" ) + sSaut	
sMailBody+= sSaut

If Not bPrestaSav Then 
	
	sMailBody+= "Au cours de votre intervention, nous vous remercions de vérifier la conformité du n°IMEI/SERIE et d’effectuer une pré-expertise au regard des conditions d’exclusion du contrat d’assurance." + sSaut

	sMailBody+= sSaut
	sMailBody+= "Merci également de prendre en compte le montant du plafond d’indemnisation ci-dessous pour définir si l’appareil est réparable par vos soins." + sSaut
	sMailBody+= sSaut		
	
	/*------------------------------------------------------------------*/
	/* 7 : Montant Maximum majoré													  */
	/*------------------------------------------------------------------*/
	// mémorisation de la garantie
	lIdGti = idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" )
	sIdGti = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_GTI" ) )
	// mémorisation de l'événement
	lIdDetail = idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" )
	sIdDetail = String ( idw_LstwCommande.GetItemNumber ( 1, "ID_DETAIL" ) )
	
	lRow = idw_wDetail.Find ( "ID_GTI = " + sIdGti + " AND ID_DETAIL = " + sIdDetail, 1, idw_wDetail.RowCount () )
	dcMtMaxTTC = 0 
	If lRow > 0 Then
		dcMtMaxTTC = idw_wDetail.GetItemDecimal ( lRow, "MT_VAL_ACHAT" )
	End If
	
	
	//* F_Plafond_Pec 
	//* Retourne		: Structure s_plafond_pec (0 indique qu'il n'y a pas de plafond)
	//*					  Pour le type Autre, le retour est sous cette forme
	//*					  O[704][3]    => OUI, plaf 704, x3 (en cours + autre)
	//*					  N[704][1]		=> NON, plaf 704, x1 ( juste l'en cours)
	
	sVal = ""
	// [PC545].[BUG_BGE_721]
	//	[PC363].[10%]
	lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN' AND POS ( INFO_FRN_SPB_CPLT, 'APP_INCOMPLET=OUI', 1) >0", 1, idw_LstwCommande.RowCount () )
	sVal = "[###]"
	
	If lRow > 0 Then
		lnvPFCString.of_Setkeyvalue ( sVal, "APP_INCOMPLET", "OUI", ";")
	End If
	
	// [PC301].[V15_EVOL_VETUSTE]
	lTotDetail = idw_wDetail.RowCount ()
	dcMtLu = 0
	dcMtMaxLu = 0
	For lCptDet = 1 To lTotDetail	
		
		sRech	=		"ID_GTI = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_GTI" ) )	+ " AND " 	+ &
						"ID_DETAIL = "	+ String ( idw_wDetail.GetItemNumber ( lCptDet, "ID_DETAIL" ) )	+ " AND " 	+ &
						"UPPER ( NOM_ZONE ) = 'MT_MAX_PROPO_PLF722'"
			
		lRow = idw_wDivDet.Find ( sRech, 1, idw_wDivDet.RowCount () ) 
		If lRow > 0 Then
			dcMtLu = idw_wDivDet.GetItemDecimal ( lRow, "VAL_MT" )
			If dcMtLu > dcMtMaxLu Then
				dcMtMaxLu = dcMtLu 
			End If
		End If					
		
	Next
	
	If dcMtMaxLu > 0 Then
		lnvPFCString.of_Setkeyvalue ( sVal, "MT_MAX_PLAF_722", String ( dcMtMaxLu ), ";")
	End If
	// [PC301].[V15_EVOL_VETUSTE]
	// :[PC545].[BUG_BGE_721]
	
	stPlafPec = F_Plafond_Pec ( "3" + sVal, idw_WSin, idw_wDivSin, udwNull, idw_wdetail, idw_LstwCommande, idw_Plafond, idw_DetPro, idw_produit, idw_wDivDet, lIdGti, lIdDetail  )
	
	//[BUG_STRUCTPB11]
	/*n_cst_debug_struct_pb11 lnvDebugStPb11
	lnvDebugStPb11.uf_verifstruct( stPlafPec, gstppecdebug , "uf_validation_finale_darty_mail_nomade1")*/
	//:[BUG_STRUCTPB11]
	
	If ( dcMtMaxTTC > stPlafPec.dcPlafEvt And stPlafPec.dcPlafEvt > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafEvt
	If ( dcMtMaxTTC > stPlafPec.dcPlafValAch And stPlafPec.dcPlafValAch > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValAch
	If ( dcMtMaxTTC > stPlafPec.dcPlafGti  And stPlafPec.dcPlafGti  > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafGti  
	If ( dcMtMaxTTC > stPlafPec.dcPlafValPublique And stPlafPec.dcPlafValPublique > 0 ) Or dcMtMaxTTC <= 0 Then dcMtMaxTTC = stPlafPec.dcPlafValPublique
	If Left ( stPlafPec.sPlafAutre, 1 ) = "O" Then dcMtMaxTTC = 0 
	If dcMtMaxTTC <= 0 Then dcMtMaxTTC = 0
	
	// [VDOC27852]
	sMailBody+= "Montant du plafond : " + String ( dcMtMaxTTC , "#####0.00" ) + " Euros TTC." + sSaut // [VDOC27245]
	
End If 

sMailBody+= sSaut
// [MANTIS24068] chgt adr mail
// [PC171918] chgt adr mail en dur par variable dp/252
sMailBody+= "Votre retour doit être adressé impérativement à l’adresse mail " + sBoiteMail + " ; l’objet "
sMailBody+= "du mail précisera obligatoirement la mention "+ sLibProduit + " et la référence du dossier sinistre : "
sMailBody+= sLibProduit + " - dossier n°" + sIdSin + " / " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_NOM" )) + " " + Upper ( idw_LstwCommande.GetItemString ( 1, "ADR_PRENOM" )) + " - " + sLibProduit + "/" + sIdSousFourn + sSaut
sMailBody+= sSaut

sMailBody+= "Nous restons à votre entière disposition pour tout renseignement complémentaire et vous prions d’agréer, nos salutations distinguées."

/*------------------------------------------------------------------*/
/* 9 : Etat de retour pour le réparateur                            */
/*------------------------------------------------------------------*/
sMailBody+=sSaut
sMailBody+=sSaut
sMailBody+="=========================================================================" + sSaut
sMailBody+="================ ZONE RESERVEE AU REPARATEUR " + sIdSousFourn + " ========" + sSaut
sMailBody+= "========================================================================" + sSaut
sMailBody+=sSaut
sMailBody+="NUM_INTERVENTION : ________________________" + sSaut
sMailBody+="DATE_DE_RECEPTION_MATERIEL_EN_STATION (DATE_DE_TRAITEMENT_SI_A_DOMICILE) :   _ _ / _ _ / _ _ _ _" + sSaut
sMailBody+="DATE_DE_TRAITEMENT/ENVOI_CLIENT :   _ _ / _ _ / _ _ _ _" + sSaut
sMailBody+="BON_CHRONO (SI ENVOI)  : __________________________" + sSaut
sMailBody+="ETAT_PRESTATION_1 :  |_| Réparé" + sSaut
sMailBody+="ETAT_PRESTATION_2 :  |_| Irréparable couvert (Bris Visible Irréparable Economiquement)" + sSaut
sMailBody+=sSaut
// [PC171918]

Choose Case sIdFour
	Case "SFG", "AAS"
		sMailBody+="        Si irréparable couvert alors y a-t-il eu un SWAP ? : |_| " + sSaut
		sMailBody+="        Si oui, quelle marque : |_________________________________| " + sSaut
		sMailBody+="        Si oui, quel modèle   : |_________________________________| " + sSaut
		sMailBody+="        le numéro de série    : |_________________________________| " + sSaut
		sMailBody+="        le prix TTC           : |______________,_________________€| " + sSaut
		sMailBody+="        l'état                :  NEUF |_|    RECONDITIONNE |_|       " + sSaut

		// [VDOC27852]
		If sIdFour = "AAS" Then
			sMailBody+="        Si non:  |_| SWAP non honoré" + sSaut
			sMailBody+="               Les zones ci-dessous doivent être obligatoirement renseignées :" + sSaut
			sMailBody+="               MOTIF/COMMENTAIRES : |____________________________________________________|" + sSaut
			sMailBody+="               Accord pour indemnisation pécuniaire : |_|" + sSaut
		End If 
	
		sMailBody+=sSaut
End Choose 

sMailBody+="ETAT_PRESTATION_3 :  |_| Irréparable non couvert (Bris Non Visible)" + sSaut



// Construction du XML
stPass.ltab[1] = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" )
stPass.sTab[1] = idw_LstwCommande.GetItemString ( 1, "ID_FOUR" )
stPass.sTab[2] = idw_LstwCommande.GetItemString ( 1, "ID_TYP_ART" )
stPass.sTab[3] = "PRSADV"

sXml = uf_createxml_ksl( sMailObjet , sMailFrom, smaildest, "CMDKSL", "Mail_Commande", stpass)

idw_LstwCommande.SetFilter ( sFiltreOrig )
idw_LstwCommande.Filter ()

bMailBody = Blob ( sMailBody, EncodingANSI! )


bRet = SQLCA.PS_I02_MAILPUSH( &
	Long ( sIdSin ), &
	Upper ( SQLCA.DataBase ), &
	sMailFrom, &
	sMailDest, &
	sMailCc, &
	sMailCci, &
	sMailObjet, &
	bMailBody, &
	'', &
	sTypMail, &
	iIdAppli, &
	'KSL', &
	-1, &
	sXml &
	) = 0

If bRet Then 
	bRet = SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 
End If

Return bRet

end function

private subroutine uf_ajoutdynamiquedivpro ();//*-----------------------------------------------------------------
//*
//* Fonction      : U_Gs_Sp_Sinistre :: uf_AjoutDynamiqueDivPro ( PRIVATE )
//* Auteur        : FABRY JF
//* Date          : 08/03/2029 14:35:15
//* Libellé       : Ajouter dynamiquement des lignes dans div_pro, lignes non paramètrées
//* Commentaires  : [VDOC27557]
//*
//* Arguments     : 
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

Long lRowDP 

lRowDP = idw_DivPro.Find ( "Upper ( NOM_ZONE ) = 'DOSSIER_BLOQUE_DR'", 1, idw_DivPro.RowCount () ) 
If lRowDP <= 0 Then

	lRowDP = idw_DivPro.InsertRow (0)

	idw_DivPro.SetItem ( lRowDP, "ID_PROD", idw_wSin.GetItemNumber ( 1, "ID_PROD" ) )
	idw_DivPro.SetItem ( lRowDP, "NOM_ZONE", "dossier_bloque_dr" )
	idw_DivPro.SetItem ( lRowDP, "LIB_LABEL", "Dossier bloqué par DAR/DR (expert)" )
	idw_DivPro.SetItem ( lRowDP, "ID_TYP_LISTE", "-XX" )
	idw_DivPro.SetItem ( lRowDP, "ALT_LISTE_CODECAR", "N" )
	idw_DivPro.SetItem ( lRowDP, "ID_TYP_ZONE", "X" )
	idw_DivPro.SetItem ( lRowDP, "ALT_OBLIG", "N" )
	idw_DivPro.SetItem ( lRowDP, "CPT_TRI", 1010 )
End If
		

end subroutine

public function boolean uf_validation_finale_courhtmlviawssaga2 ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_CourHTMLviaWSSaga2  (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 11/03/2019
//* Libellé       : Gestion d'envoi de courrier en mode HTML via un WS Saga2
//* Commentaires  : 
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------


Boolean bRet
String  sMailCc, sSaut, sMailBody, sTypMail, sAdrMail, sLibProdAssure
Integer iIdAppli, iPos
Long 	  lIdProd, lTotCmd, lIdSeq, lRowAssure, lDeb, lFin
String  sIdSin, sFiltre, sFiltreOrig, sSql, sVal 
DataWindowChild ldwChild

bRet = True

sMailCc=""
sSaut = char (10 )
sMailBody=""
sTypMail="CWSSG2"
iidAppli=2

lIdProd = idw_WSin.GetItemNumber ( 1, "ID_PROD" )

sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ))

/*--------------------------------------------------------------------*/
/* Filtre pour ne récupérer que les prestations qui nous intéressent. */
/*--------------------------------------------------------------------*/
// [PC151259-2] // [PC171918]
sFiltre = "ID_TYP_ART = 'CAF' AND " + &		
			 "ID_FOUR    = 'CMA' AND " + &  
			 "POS ( INFO_SPB_FRN_CPLT, 'MAIL_CHAP_ENVOYE=OUI' ) <= 0 AND " + &
			 "POS ( INFO_SPB_FRN_CPLT, 'TYPE_ENVOI=DEMATERIALISE' ) > 0 AND " + &			 
			 "COD_ETAT IN ( 'CNV', 'ECT')"

/*------------------------------------------------------------------*/
/* Recherche sur liste des commandes se trouvant au niveau du       */
/* sinistre.                                                        */
/*------------------------------------------------------------------*/
sFiltreOrig = idw_LstwCommande.Describe ( "datawindow.table.filter" )
If sFiltreOrig = "?" Then sFiltreOrig = ""

idw_LstwCommande.SetFilter ( sFiltre )
idw_LstwCommande.Filter ()

lTotCmd = idw_LstwCommande.RowCount () 

If lTotCmd <= 0 Then 
	// ON continue sans Traitement de courrier WS Saga2
	Return TRUE
End If

/*------------------------------------------------------------------*/
/* Plus d'une prestation vers TREMBLAY, on stoppe.                  */
/*------------------------------------------------------------------*/
If lTotCmd > 1 Then 
	stMessage.sTitre		= "Nombre presta CARMA"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sVar[1]		= "CARMA"
	stMessage.sVar[2]		= String ( lTotCmd )
	stMessage.sCode		= "COMD985"
	F_Message ( stMessage ) 
	bRet = FALSE
End If

If bRet Then 
	lRowAssure = idw_lstinter.Find( "COD_INTER='A'" , 1, idw_lstinter.RowCount())
	sAdrMail = F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_MAIL" ) 
	
	// Contrôle adresse mail en recette
	If Upper ( SQLCA.DataBase ) <> "SIMPA2_PRO" Then
		iPos = Pos ( sAdrMail, "@" ) 
		sAdrMail = Upper(Right ( sAdrMail, Len ( sAdrMail ) -  iPos ))
		Choose Case sAdrMail 
			Case "SPB.FR", "SPB.EU"
				// OK
			Case Else 
				stMessage.sTitre		= "Adresse mail SPB"
				stMessage.Icon			= Exclamation!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= OK!
				stMessage.sCode		= "WSIN842"
				F_Message ( stMessage ) 			
				bRet = FALSE
		End Choose 
	End If 
End If 
	
	If bRet Then
		// EN autoinstanciate, donc j'auto-instancie que si on est sûr de s'en servir
		n_cst_sp_ws_generatemail_caller uSendMail
		generatemail_response uoResponse		
		
		lIdSeq = idw_LstwCommande.GetItemNumber ( 1, "ID_SEQ" ) 
	
	 sLibProdAssure=""
	 F_rechdetpro(lDeb, lFin,idw_detpro, lIdProd,"-DP",66)
	 if lDeb > 0 Then sLibProdAssure=idw_detpro.GetItemString(lDeb,"VAL_CAR")
	 
	 sAdrMail = F_GetItem3 ( idw_lstinter, lRowAssure, "ADR_MAIL" ) 
	 
	 // Création du mail
	 uSendMail.mailsubject="Votre sinistre Garantie " + sLibProdAssure + " Dossier " + string(idw_Wsin.GetItemNumber(1,"ID_SIN"))
	 usendMail.mailtypeid=198 // carma_BA_mail_chapeau
	 uSendMail.mailto=sAdrMail
	 
	 sVal=f_getitem3(idw_LstwCommande,1,"ADR_COD_CIV")
	 if sVal <> "" Then
		idw_wSin.GetChild("COD_CIV",ldwChild)
		lDeb=ldwChild.Find("ID_CODE=" + sVal,1,ldwChild.RowCount( ))
		sVal=""
		if lDeb > 0 Then sVal=ldwChild.GetItemString(lDeb,"LIB_CODE")
	 End if
	 uSendMail.uf_add_data( "civilite", sVal)
	 uSendMail.uf_add_data( "nom", f_getitem3(idw_LstwCommande,1,"ADR_NOM"))
	 uSendMail.uf_add_data( "prenom", f_getitem3(idw_LstwCommande,1,"ADR_PRENOM"))
	 uSendMail.uf_add_data( "montant_BA",String(idw_LstwCommande.GetItemdecimal( 1, "MT_TTC_CMDE"),"0.00"))
	 uSendMail.uf_add_data( "lib_prod_assure", sLibProdAssure)
	 uSendMail.uf_add_data( "id_sin", string(idw_Wsin.GetItemNumber(1,"ID_SIN")))	 
	 
	 // Envoi du mail
	 bRet=uSendMail.uf_sendmail( uoResponse)
End If 

 // [DT339] - à supprimer avec la clé
If bRet And Upper ( SQLCA.DataBase ) <> "SIMPA2_PRO" Then
	Int iClic 
	iClic = Messagebox ( "TEST", &
	 							"Le mail est bien parti. ~n~nSouhaitez-vous simuler un succès (OUI) ou un échec (NON) de l'envoi du mail par le WS SAGA2 ?", &
								Question!, & 
								YesNo!, &
								1 )
	bRet = iClic = 1
End if
 // :[DT339] - à supprimer avec la clé
 
// Gestion de l'erreur
If Not bRet Then 

	// Création d'un Contact/Travail
	sSql = "Exec sysadm.PS_I_CONTACT_TRAVAIL_DT339 " + & 
					String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "." + "," + &
					"'" + stGlb.sCodOper + "'"
					
	F_Execute ( sSql, SQLCA )


	// Ecriture sur la presta de l'envoi à NON
	sSql = "Exec sysadm.PS_U_COMMANDE_DT339_MAJ_PRESTA " + & 
					String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "." + "," + &
					String ( lIdSeq ) + "." + "," + &
					"'NON'"
					
	F_Execute ( sSql, SQLCA )

	Return bRet
End IF 

If bRet Then
	// Gestion du succès d'envoi du courrier.
	
	// Noter sur la presta, courrier WSSAGA2 envoye le / /
	// Ecriture sur la presta de l'envoi à OUI
	sSql = "Exec sysadm.PS_U_COMMANDE_DT339_MAJ_PRESTA " + & 
					String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "." + "," + &
					String ( lIdSeq ) + "." + "," + &
					"'OUI'"
					
	F_Execute ( sSql, SQLCA )
	
	// Tracer sur TraceMailPro
	sSql = "Exec sysadm.PS_I_MAILPUSH_DT339_VIRTUEL_SAGA2 " + & 
					String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "." 
					
	F_Execute ( sSql, SQLCA )
	
	// Volontairement, je n'exploite pas les retours SQL, car le WS a bien envoyé le mail, 
	// Donc il ne serait pas envisageable de faire un rollback sur ces 2 marquages, ils doivent être commiter quoi qu'il arriv
End If 

Return bRet

end function

private subroutine uf_preparermodifier_modifdynparam (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_PreparerModifier_ModifDynParam (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 17/09/2019 10:49:34
//* Libellé			: [DT447]
//* Commentaires	: Modification dynamique du param chargé.
//*
//* Arguments		: s_Pass			astPass			(Réf) Structure de passage
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ 			PAR		Date		  Modification
//*            JFF   30/09/2019    [DT447-1]
//*            JFF   07/05/2013    [DT447_2]
//*-----------------------------------------------------------------

DateTime dtCreeLeDos, dtDtePivotDT1288-1, dtDtePivotDT447, dtDtePivotDT447_2
Long lDeb, lFin, lTotDT288, lCptDT288
String sVal, sVal1, sVal2, sVal3
n_cst_string lnvString

asCas = Upper ( asCas )

dtCreeLeDos = idw_wSin.GetItemDateTime ( 1, "CREE_LE") // [DT288-1]

Choose Case asCas 
	Case "DT288-1"
		// [DT288-1]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 239 )
		If lDeb > 0 Then
			sVal = lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DTE_PIVOT_DT288-1", ";")
			If sVal <> "" And IsDate ( sVal ) Then
				dtDtePivotDT1288-1 = DateTime ( sVal )

				// Traitement avant MEP DT288-1
				If dtCreeLeDos < dtDtePivotDT1288-1 Then
					idw_DetPro.RowsDiscard ( lDeb, lFin, primary! )

					// supp de la 315 
					idw_DetPro.SetFilter ( "ID_CODE_DP = 315" ) 
					idw_DetPro.Filter ()
					idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )

					idw_DetPro.SetFilter ( "ID_CODE_DP = 200" ) 
					idw_DetPro.Filter ()

					lTotDT288 = idw_DetPro.RowCount ()
					For lCptDT288 = 1 To lTotDT288 
						sVal = idw_DetPro.GetItemString ( lCptDT288, "VAL_CAR" )
						lnvString.of_Setkeyvalue ( sVal, "ID_FOUR", "O2M", ";")
						idw_DetPro.SetItem ( lCptDT288, "VAL_CAR", sVal ) 
					Next

				Else
				// Traitement AprèsMEP DT288-1
					
					// supp de la 209 et la 317 devient la 209
					idw_DetPro.SetFilter ( "ID_CODE_DP = 209" ) 
					idw_DetPro.Filter ()
					idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )

					idw_DetPro.SetFilter ( "ID_CODE_DP = 317" ) 
					idw_DetPro.Filter ()
					lTotDT288 = idw_DetPro.RowCount ()
					For lCptDT288 = 1 To lTotDT288 
						idw_DetPro.SetItem ( lCptDT288, "ID_CODE_DP", 209 ) 
					Next
			
				End If
			End If
		End If
		// [DT288-1]

	Case "DT447"
		// [DT288-1]
		F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 342 )
		If lDeb > 0 Then
			sVal = lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DTE_PIVOT_DT447", ";")
			sVal1 = lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "CAS", ";")			

			// [DT447_2]
			sVal2 = lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "DTE_PIVOT_DT447_2", ";")
			sVal3 = lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "CAS_2", ";")			

			If sVal <> "" And IsDate ( sVal ) Then
				dtDtePivotDT447 = DateTime ( sVal )
				// Traitement avant MEP DT288-1
				If dtCreeLeDos >= dtDtePivotDT447 Then

					Choose Case sVal1 
						Case "80500", "35800"
			
								idw_DetPro.SetFilter ( "ID_CODE_DP = 95 AND POS ( VAL_CAR, 'ACTION=A_DIAGNOSTIQUER' ) > 0" ) 
								idw_DetPro.Filter ()
								idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )

								idw_DetPro.SetFilter ( "ID_CODE_DP = 110" ) 
								idw_DetPro.Filter ()
								idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )
							
						Case "80501", "35801"

								idw_DetPro.SetFilter ( "ID_CODE_DP = 95 AND POS ( VAL_CAR, 'ACTION=A_DIAGNOSTIQUER' ) > 0 AND POS ( TRIM ( VAL_CAR ) + TRIM ( VAL_CAR2 ), 'TYP_APP=CJP' ) > 0" ) 
								idw_DetPro.Filter ()
								idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )

								idw_DetPro.SetFilter ( "ID_CODE_DP = 168" ) 
								idw_DetPro.Filter ()								
								sVal1 = idw_DetPro.GetItemString ( 1, "VAL_CAR" )
								sVal = lnvString.of_getkeyvalue ( sVal1, "TYPE_APP", ";")
								sVal = F_Remplace ( sVal, "#CJP#", "#" ) 
								lnvString.of_Setkeyvalue ( sVal1, "TYPE_APP", sVal, ";")																		
								idw_DetPro.SetItem ( 1, "VAL_CAR", sVal1 )
								
								idw_DetPro.SetFilter ( "ID_CODE_DP = 110" ) 
								idw_DetPro.Filter ()
								idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )								
							
					End Choose 
				
				Else // If dtCreeLeDos < dtDtePivotDT447 Then
					Choose Case sVal1 
					
						Case "44502"

							// [DT447-1]
							idw_DetPro.SetFilter ( "ID_CODE_DP = 110 AND ID_CODE_CAR IN ( 'CJP', 'PCP' )" ) 
							idw_DetPro.Filter ()
							idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )
	
							idw_DetPro.SetFilter ( "ID_CODE_DP = 95 AND POS ( VAL_CAR, 'ACTION=A_REPARER' ) > 0 AND " + & 
														  " ( POS ( TRIM ( VAL_CAR ) + TRIM ( VAL_CAR2 ), 'TYP_APP=CJP' ) > 0 " + &
														  " OR " + &
														  "   POS ( TRIM ( VAL_CAR ) + TRIM ( VAL_CAR2 ), 'TYP_APP=PCP' ) > 0 " + &
														  " ) " )
							idw_DetPro.Filter ()
							idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )
								
					End Choose 				
				End IF 
				
			End If 
			
			// [DT447_2]
			If sVal2 <> "" And IsDate ( sVal2 ) Then
				dtDtePivotDT447_2 = DateTime ( sVal2 )

				If dtCreeLeDos >= dtDtePivotDT447_2 Then

					Choose Case sVal3 
							
						Case "44500", "44504"

								idw_DetPro.SetFilter ( "ID_CODE_DP = 95 AND POS ( VAL_CAR, 'ACTION=A_DIAGNOSTIQUER' ) > 0 " + &
															  "AND ( POS ( TRIM ( VAL_CAR ) + TRIM ( VAL_CAR2 ), 'TYP_APP=CJP' ) > 0" + &
															  " OR   POS ( TRIM ( VAL_CAR ) + TRIM ( VAL_CAR2 ), 'TYP_APP=PCP' ) > 0" + &
															  " OR   POS ( TRIM ( VAL_CAR ) + TRIM ( VAL_CAR2 ), 'TYP_APP=TPC' ) > 0" + &
															  "    )" ) 
								idw_DetPro.Filter ()
								idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )
							
								idw_DetPro.SetFilter ( "ID_CODE_DP = 110" ) 
								idw_DetPro.Filter ()
								idw_DetPro.RowsDiscard ( 1, idw_DetPro.Rowcount(), primary! )								
							
					End Choose 
				End If 
			End If 
		End IF 			

End Choose 

idw_DetPro.SetFilter ( "" ) 
idw_DetPro.Filter ()
idw_DetPro.Sort ()
end subroutine

public function boolean uf_controlergestion_rembfranchisecb ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_RembFranchiseCB
//* Auteur			: JFF
//* Date				: 03/10/2019
//* Libellé			: 
//* Commentaires	: [PM462-1][V3]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 
//*-----------------------------------------------------------------

boolean bLock
string sFilter, sOriFilter
integer iCountDetailTotal, iCountDetail1461
long lIdprod, lFacturation, lNonFacturation

bLock = False

sOriFilter = idw_wDetail.Describe ( "datawindow.table.filter" )
If sOriFilter = "?" Then sOriFilter = ""

sFilter = "COD_ETAT = 500"
idw_wDetail.SetFilter (sFilter)
idw_wDetail.Filter ()

iCountDetailTotal = idw_wDetail.rowcount()

sFilter = "COD_ETAT = 500 And ID_EVT = 1461"
idw_wDetail.SetFilter (sFilter)
idw_wDetail.Filter ()

iCountDetail1461 = idw_wDetail.rowcount()

idw_wDetail.SetFilter (sOriFilter)
idw_wDetail.Filter ()
idw_wDetail.Sort ()

bLock = iCountDetailTotal > iCountDetail1461 And iCountDetail1461 > 0 

If Not bLock Then bLock = iCountDetail1461 > 1 

return bLock
end function

private function boolean uf_controlergestion_dt458 ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_DT458 (PRIVATE)
//* Auteur			: JFF
//* Date				: 10/03/2020
//* Libellé			: Contrôles fonctionnels des 4 zones de reventes de billets.
//* Commentaires	: [DT458]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet, bAMU_Saisie, bDteRenvente_1, bMtRevente_1, bNbreBillet_1
String  sVal, sDteRenvente_1, sMtRevente_1, sNbreBillet_1
DateTime dtDteSurv
Long lRow 
Decimal {2} dcMtPEcMax 

bRet = TRUE
bAMU_Saisie = False

sVal = uf_GestOng_Divers_Trouver ( "REVENTE_TRAITE_1" ) 

If sVal = "O" Then Return TRUE

sDteRenvente_1 = uf_GestOng_Divers_Trouver ( "DTE_REVENTE_1" ) 
bAMU_Saisie = sDteRenvente_1 <> "" 
IF sDteRenvente_1 <> "" Then
	bDteRenvente_1 = IsDate ( sDteRenvente_1 ) And Not IsNull ( sDteRenvente_1 ) And sDteRenvente_1 <> "01/01/1900" 
End If 

If bDteRenvente_1 Then
	dtDteSurv = idw_wSin.GetItemDateTime ( 1, "DTE_SURV" ) 
	If ( DateTime ( sDteRenvente_1 ) < dtDteSurv ) OR ( DateTime ( sDteRenvente_1 ) > DateTime ( Today(), Now() ) ) Then
		stMessage.sTitre		= "Incohérence de date"
		stMessage.Icon		= Information!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sCode		= "WSIN857"
		bRet = False
	End IF 
	
End If 

If bRet Then 
	sMtRevente_1   = uf_GestOng_Divers_Trouver ( "MT_REVENTE_1" ) 
	If sMtRevente_1 = "0.00" Then sMtRevente_1 = ""
	If ( bAMU_Saisie And sMtRevente_1 = "" ) OR ( Not bAMU_Saisie And sMtRevente_1 <> "" )Then
		stMessage.sTitre		= "Saisie des données"
		stMessage.Icon		= Information!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sCode		= "WSIN856"
		bRet = False
	End If 
	
	If Not bAMU_Saisie Then bAMU_Saisie = sMtRevente_1 <> "" 
	IF sMtRevente_1 <> "" Then
		bMtRevente_1 = IsNumber ( sMtRevente_1 ) And Not IsNull ( sMtRevente_1 ) And Dec ( sMtRevente_1 ) > 0 
	End IF 
	
	If bRet and bMtRevente_1 Then
		dcMtPecMax = dec ( idw_LstGti.Describe ( "Evaluate ( 'max (mt_plaf_reg)', 0 )") )
		If IsNull ( dcMtPecMax ) Then dcMtPecMax = 0 
		
		If Dec ( sMtRevente_1 ) > dcMtPecMax Then
			stMessage.sTitre		= "Plafond"
			stMessage.Icon		= Information!
			stMessage.bErreurG	= FALSE
			stMessage.Bouton		= OK!
			stMessage.sVar [1]	= String ( dcMtPecMax, "#,##0.00" )
			
			If dcMtPecMax <= 0 Then
				stMessage.sCode		= "WSIN859"				
			Else 
				stMessage.sCode		= "WSIN858"
			End If 
			bRet = False			
		End If 
	End If 
	
End If 

If bRet Then 
	sNbreBillet_1  = uf_GestOng_Divers_Trouver ( "NBRE_BILLET_1" ) 
	If sNbreBillet_1 = "0" Then sNbreBillet_1 = ""
	If ( bAMU_Saisie And sNbreBillet_1 = "" ) Or ( Not bAMU_Saisie And sNbreBillet_1 <> "" ) Then
		stMessage.sTitre		= "Saisie des données"
		stMessage.Icon		= Information!
		stMessage.bErreurG	= FALSE
		stMessage.Bouton		= OK!
		stMessage.sCode		= "WSIN856"
		bRet = False
	End If 
	
	If Not bAMU_Saisie Then bAMU_Saisie = sNbreBillet_1 <> "" 
	IF sNbreBillet_1 <> "" Then
		bNbreBillet_1 = IsNumber ( sNbreBillet_1 ) And Not IsNull ( sNbreBillet_1 ) And Integer ( sNbreBillet_1 ) > 0 
	End IF 
End IF 

lRow = idw_WDivSin.Find ( "NOM_ZONE = 'revente_a_traiter_1'", 1,  idw_WDivSin.RowCount () )
If lRow > 0 Then
	If bRet And bAMU_Saisie And bDteRenvente_1 And bMtRevente_1 And bNbreBillet_1 Then
		This.uf_gestong_divers_majzone( "REVENTE_A_TRAITER_1", lRow, K_MAJZONE, "O" )
	Else 
		This.uf_gestong_divers_majzone( "REVENTE_A_TRAITER_1", lRow, K_MAJZONE, "N" )		
	End If
End If


Return bRet 
end function

private function string uf_controlergestion_pm506 ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_PM506 (PRIVATE)
//* Auteur			: JFF
//* Date				: 10/04/2020
//* Libellé			: Fonction pilotant le contrôles chez BeCLM via l'API REST dédiée à cela
//* Commentaires	: [PM506-1]
//*
//* Arguments		: 
//*
//* Retourne		: boolean	bLock
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//        JFF   28/02/2024 [MCO_190_191_BECLM]
//        JFF   27/03/2025 [PMO32_SPB175]
//*-----------------------------------------------------------------

Boolean bPresencePrestaCNV, bRetApplAPI
Decimal {2} dcMtAReg, dcMtDeclement, dcMtPec
String sVal, sNomAss, sPrenomAss, sPctRisque, sMess, sMtDeclement, sFlowNameBeCLM 
String sPos, sSaut, sMailBody, sIdSin, sMailBodyOrig, sObjet, sSql, sIdProd, sAdrMail, sNaissLieu, sNaissPays, sNaissDate
Long lIdCLient, lIdSin, lRow, lDeb, lFin, lRowCmd, lIdGti, lIdDetail, lRowDDet
Int iMaxMatchingScore, iPctRisque, iIdRev 
DateTime dtNaissDate
n_cst_string lnvPFCString

sPos = ""
iMaxMatchingScore  = 0

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 346 )
If lDeb <= 0 Then Return ""

If Upper ( SQLCA.DataBase ) <> "SIMPA2_PRO" And NOT F_CLE_A_TRUE ( "BECLM_EN_SIM" ) Then
	istPauseAPI_LAB.Show ()
	istPauseAPI_LAB.BringToTop	= TRUE
	
	// On appelle l'API
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'pm506_apirest_lab_appelee_le'", 1,  idw_WDivSin.RowCount () )
	If lRow > 0 Then
		This.uf_gestong_divers_majzone( "PM506_APIREST_LAB_APPELEE_LE", lRow, K_MAJZONE, DateTime ( Today(), Now () ) )
	End If	

	// On l'inscrit sur le sinistre
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'pm506_person_a_risque'", 1,  idw_WDivSin.RowCount () )
	If lRow > 0 Then
		This.uf_gestong_divers_majzone( "PM506_PERSON_A_RISQUE", lRow, K_MAJZONE, "0" + "%" )
	End If	
	
	// Sinon succès d'appel
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'pm506_etat_appel_apirest_lab'", 1,  idw_WDivSin.RowCount () )
	If lRow > 0 Then
		This.uf_gestong_divers_majzone( "PM506_ETAT_APPEL_APIREST_LAB", lRow, K_MAJZONE, "APISUC" )
	End If		

	istPauseAPI_LAB.Hide ()		
	
	Return sPos	
End If 


// Déclaration ici, car autoinstancitation (couteuse).
n_cst_sp_ws_lutte_anti_blanch_caller uLuttAntiBlanch
lutte_anti_blanch_response uoResponseLAB

sPctRisque = lnvPFCString.of_getkeyvalue( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "PCT_RISQUE", ";") 
sPctRisque = F_Remplace ( sPctRisque, "%", "" ) 
sPctRisque = Trim ( sPctRisque )
If IsNull ( sPctRisque ) Or sPctRisque = "" Then sPctRisque = "100"
If Not IsNumber ( sPctRisque ) Then sPctRisque = "100"
iPctRisque = Integer ( sPctRisque )

sMtDeclement = lnvPFCString.of_getkeyvalue( idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "MT_DECLENCHEMENT", ";") 
sMtDeclement = Trim ( sMtDeclement )
If IsNull ( sMtDeclement ) Or sMtDeclement = "" Then sMtDeclement = "0"
If Not IsNumber ( sMtDeclement ) Then sMtDeclement = "0"
dcMtDeclement = Dec ( sMtDeclement )

// On ne contrôle qu'une seule fois, ET ( si mt_a_reg > Ou si présence prest CNV )
dcMtAReg = idw_Wsin.GetItemDecimal ( 1, "MT_A_REG" )
lRowCmd = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount())
bPresencePrestaCNV = lRowCmd > 0 
dcMtPec = 0

// Si presta, alors on stocke le mt_pec
If bPresencePrestaCNV Then
	lIdGti = idw_LstwCommande.GetItemNumber ( lRowCmd, "ID_GTI" ) 
	lIdDetail = idw_LstwCommande.GetItemNumber ( lRowCmd, "ID_DETAIL" ) 	
	lRowDDet = idw_wDivDet.Find ( &
				"ID_GTI = " + String ( lIdGti ) + " AND " + &
				"ID_DETAIL = " + String ( lIdDetail ) + " AND " + &
				"NOM_ZONE = 'mt_pec'" &
				, 1, idw_wDivDet.Rowcount() ) 

	If lRowDDet  > 0 Then
		dcMtPec = idw_wDivDet.GetItemDecimal ( lRowDDet, "VAL_MT" ) 
		If IsNull ( dcMtPec ) Then dcMtPec = 0
	End If 
End If 


// L'API a-t-elle déjà été appelée ?
sVal = Trim ( uf_GestOng_Divers_Trouver ( "PM506_APIREST_LAB_APPELEE_LE" )) // [PM01].[LOT3&4]
// Le contrôle a déjà eu lieu une fois, on ne le refait pas qqsoit le résultat Succès ou Echec
If sVal <> "" Then 
	If dcMtAReg > 0 Or bPresencePrestaCNV Then 
		sVal = uf_GestOng_Divers_Trouver ( "PM506_PERSON_A_RISQUE" )
		sVal = F_Remplace ( sVal, "%", "" ) 
		sVal = Trim ( sVal )
		If IsNumber ( sVal ) Then 
			If integer ( sVal ) >= iPctRisque And Not ibPM506_AssureARisque Then
				
				stMessage.sTitre		= "ALERTE Lutte AB&AT"
				stMessage.Icon			= Exclamation!
				stMessage.bErreurG	= FALSE
				stMessage.Bouton		= YESNO!
				stMessage.sVar[1]    = sVal
				stMessage.sCode		= "WSIN863"
				
				If F_Message ( stMessage ) = 1 Then
					Return ""
				Else 
					Return "ALT_BLOC"
				End IF 
			End IF 
		End If 	
	End If 	
	Return ""
End If 


// Si aucun montant à régler ou présence d'une presta non validé, on ressort sans blocage
If Not ( dcMtAReg > 0 Or bPresencePrestaCNV ) Then Return ""

// Si un montant de déclenchement est paramètré Alors on vérifie avec les montantsz du dossiers.
If dcMtDeclement > 0 Then
	// Si aucun des deux montant (à régler ou de prise en charge) n'est strictement supérieur au mt de déclenchement ALORS on ressort en TRUE (pas de contrôle)
	If dcMtAReg < dcMtDeclement And dcMtPec < dcMtDeclement Then Return ""
End If 
// S'il na jamais eu lieu, on lance alors le contrôle.
// On récupère l'ID_CLIENT Sherpa, ainsi que le nom et le prénom de l'assuré.
// ON arme l'API
lIdSin =  idw_Wsin.GetItemNumber ( 1, "ID_SIN" )
SQLCA.PS_S_RECUP_ID_CLIENT ( lIdSin , lIdCLient )
sNomAss = Trim ( F_GetItem3 ( idw_Wsin, 1, "NOM" ))
sPrenomAss = Trim ( F_GetItem3 ( idw_Wsin, 1, "PRENOM" ))

// [PMO32_SPB175]
If F_CLE_A_TRUE ( "PMO32_SPB175" ) Then
	lRow = idw_lstinter.Find ( "COD_INTER='A'",1 , idw_lstinter.RowCount())
	If lRow > 0 Then
		dtNaissDate = idw_lstinter.GetItemDateTime ( lRow, "DTE_NAISS" )
		sNaissDate  = String ( dtNaissDate, "dd/mm/yyyy" )
		If IsNull ( sNaissDate ) Then sNaissDate = ""
		sNaissLieu  = Trim ( F_GetItem3 ( idw_lstinter, lRow, "VILLE_NAISS" ))
		sNaissPays  = Trim ( F_GetItem3 ( idw_lstinter, lRow, "PAYS_NAISS" )) 	
	End IF 
End IF 	

/*
// Pour les tests, retourne 100%
sNomAss = "AHMADI"
sPrenomAss = "MOHAMMAD"
*/

// [MCO_190_191_BECLM]
If F_CLE_A_TRUE ( "MCO_190_191_BECLM" ) Then
	iIdRev = idw_Wsin.GetItemNumber ( 1, "ID_REV" )
	sFlowNameBeCLM = Fill ( " ", 50 )
	SQLCA.PS_S_RECUP_FLOW_NAME_BECLM  ( lIdSin, iIdRev, sFlowNameBeCLM )
	uLuttAntiBlanch.uf_Add_Data ( "flow_name", sFlowNameBeCLM )
End If

uLuttAntiBlanch.uf_Add_Data ( "id_sin", String ( lIdSin ) )
uLuttAntiBlanch.uf_Add_Data ( "id_client", String ( lIdCLient ) )
uLuttAntiBlanch.uf_Add_Data ( "IdentNom", sNomAss)
uLuttAntiBlanch.uf_Add_Data ( "IdentPrenom", sPrenomAss )

// [PMO32_SPB175]
If F_CLE_A_TRUE ( "PMO32_SPB175" ) Then
	If sNaissDate <> "" Then uLuttAntiBlanch.uf_Add_Data ( "NaissDate", sNaissDate )
	uLuttAntiBlanch.uf_Add_Data ( "NaissLieu", sNaissLieu )
	uLuttAntiBlanch.uf_Add_Data ( "NaissPays", sNaissPays )
End If 

// On appelle l'API
lRow = idw_WDivSin.Find ( "NOM_ZONE = 'pm506_apirest_lab_appelee_le'", 1,  idw_WDivSin.RowCount () )
If lRow > 0 Then
	This.uf_gestong_divers_majzone( "PM506_APIREST_LAB_APPELEE_LE", lRow, K_MAJZONE, DateTime ( Today(), Now () ) )
End If	

istPauseAPI_LAB.Show ()
istPauseAPI_LAB.BringToTop	= TRUE
bRetApplAPI = uLuttAntiBlanch.call_api_put_check_risk ( uoResponseLAB )
istPauseAPI_LAB.Hide ()

lRow = idw_WDivSin.Find ( "NOM_ZONE = 'pm506_etat_appel_apirest_lab'", 1,  idw_WDivSin.RowCount () )

// Si ECHEC d'appel, on gère
If Not bRetApplAPI Then
	
	If lRow > 0 Then
		This.uf_gestong_divers_majzone( "PM506_ETAT_APPEL_APIREST_LAB", lRow, K_MAJZONE, "APIECH" )
	End If	
	
	lRow = idw_WDivSin.Find ( "NOM_ZONE = 'pm506_person_a_risque'", 1,  idw_WDivSin.RowCount () )
	If lRow > 0 Then
		This.uf_gestong_divers_majzone( "PM506_PERSON_A_RISQUE", lRow, K_MAJZONE, "Impossible de déterminer le risque" )
	End If	
	
	
	// VU avec Hélène si échec d'appel, on laisse passer.
	Return ""
End IF 

// Sinon succès d'appel
If lRow > 0 Then
	This.uf_gestong_divers_majzone( "PM506_ETAT_APPEL_APIREST_LAB", lRow, K_MAJZONE, "APISUC" )
End If	

// On récupére le maxMAtching (le pctage)
If IsValid ( uoResponseLAB.uoRefRisk ) Then
	iMaxMatchingScore = uoResponseLAB.uoRefRisk.iiMaxMatchingScore
End If 

If IsNull ( iMaxMatchingScore ) Then iMaxMatchingScore = 0

// On l'inscrit sur le sinistre
lRow = idw_WDivSin.Find ( "NOM_ZONE = 'pm506_person_a_risque'", 1,  idw_WDivSin.RowCount () )
If lRow > 0 Then
	This.uf_gestong_divers_majzone( "PM506_PERSON_A_RISQUE", lRow, K_MAJZONE, String (iMaxMatchingScore) + "%" )
End If	

// Ensuite on gère le pctage s'il dépasse le pctage max du param
IF iMaxMatchingScore < iPctRisque Then Return ""

// Je bloque le dossier pour le DR
lRow = idw_WDivSin.Find ( "NOM_ZONE = 'dossier_bloque_dr'", 1,  idw_WDivSin.RowCount () )
If lRow > 0 Then
	This.uf_gestong_divers_majzone( "DOSSIER_BLOQUE_DR", lRow, K_MAJZONE, "O" )
End If

// Mail
sPos = ""
sSaut = char ( 10 )
sIdSin = String ( idw_WSin.GetItemNumber ( 1, "ID_SIN" ) )
sIdProd = String ( idw_WSin.GetItemNumber ( 1, "ID_PROD" ) )
sAdrMail = ProfileString ( stGlb.sFichierIni, "AUDIT_ASSUREUR_ELSA", "ADR_MAIL_AUDIT_ASSUREUR_ELSA", "" )

// J'ajoute le GT à l'adresse mail
sAdrMail += "," + Lower ( Left ( stGlb.sPrenomOper, 1 ) ) + lower ( stGlb.sNomOper ) + "@spb.eu"

sObjet = "Alerte dossier à risque (Lutte Anti-Blanchiment&Anti-Terroriste) : " + sIdSin

sMailBodyOrig = "Bonjour Christelle," + sSaut 
sMailBodyOrig += sSaut 
sMailBodyOrig += "Si tu reçois ce mail, c'est que l'API extérieure que nous appelons chez BeCLM détecte cet assuré comme étant à risque. Tu trouveras le pourcentage de risque sur l'onglet Divers du sinistre. Vous devez consulter l'application de BeCLM pour en savoir plus sur cet assuré avant d'engager un règlement ou une prestation." + sSaut 
sMailBodyOrig += sSaut 
sMailBodyOrig += "Déclenchement alerte le : " + String ( Today (), "dd/mm/yyyy hh:mm:ss" ) + sSaut 
sMailBodyOrig += sSaut 
sMailBodyOrig += "Sinistre : " + sIdSin + sSaut 
sMailBodyOrig += "Créé le : " + String ( idw_WSin.GetItemDatetime ( 1, "CREE_LE" ) , "dd/mm/yyyy hh:mm:ss" )+ sSaut 
sMailBodyOrig += "Produit : " + sIdProd + sSaut 
sMailBodyOrig += sSaut 
sMailBodyOrig += "Instruit par le GT : "  + sSaut 
sMailBodyOrig += "Trigramme : " + stGlb.sCodoper + sSaut 
sMailBodyOrig += "Nom : " + stGlb.sNomOper + sSaut 
sMailBodyOrig += "Prénom : " + stGlb.sPrenomOper + sSaut 
sMailBodyOrig += sSaut 
sMailBodyOrig += "================== Données de l'assuré ====================" + sSaut 
sMailBodyOrig += sSaut 
sMailBodyOrig += "Nom assuré à risque : " + sNomAss  + sSaut 
sMailBodyOrig += "Prénom assuré à risque : " + sPrenomAss  + sSaut 
sMailBodyOrig += "Pourcentage de risque BeCLM : " + Trim ( uf_GestOng_Divers_Trouver ( "PM506_PERSON_A_RISQUE" ))  + sSaut 
sMailBodyOrig += sSaut 	
If dcMtDeclement > 0 Then
	sMailBodyOrig += "Montant de déclenchement paramétré : OUI (" + String ( dcMtDeclement ) + "€)" + sSaut 		
Else 
	sMailBodyOrig += "Montant de déclenchement paramétré : NON" + sSaut 		
End IF 

sMailBodyOrig += "Montant à régler : " + String ( dcMtAReg ) + "€" + sSaut 		
sMailBodyOrig += "Montant de prise en charge : " + String ( dcMtPec ) + "€" + sSaut 			


sMailBodyOrig = F_Remplace ( sMailBodyOrig, "'", "''" )

 sSql = "Exec sysadm.PS_S01_MAIL '" + sAdrMail + "', "  +&
		  "'" + sMailBodyOrig + "'"		 + ", " + &
		  "'" + sObjet + "'"		 + ", " + &
		  "'Alerte SIMPA2'"		    + ", " + &
		  "''"			 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"   				 		 + ", " + &
		  "null"

F_execute ( sSql, SQLCA )
F_Commit ( SQLCA, true )


// Contact 
sMess = "Lutte Anti-Blanchiment&Anti-Terroriste : Attention ! assuré détecté comme étant risque (" + Trim ( uf_GestOng_Divers_Trouver ( "PM506_PERSON_A_RISQUE" )) + " de risque). Le dossier doit être géré par le DR (message automatique du système)."
sSql = "Exec sysadm.PS_I_CONTACT_CLIENT " + sIdSin + ", '" + sMess + "', 300, '" + stGlb.sCodOper + "'"
F_execute ( sSql, SQLCA )
F_Commit ( SQLCA, true )

ibPM506_AssureARisque = True // [PM506-1]

// Message
/*
stMessage.sTitre		= "Lutte AB&AT"
stMessage.Icon			= Information!
stMessage.sCode		= "WSIN860"		
stMessage.bErreurG	= False

If This.uf_GetAutorisation2(208) Or This.uf_GetAutorisation2(227) Then
	sPos = ""			
	stMessage.sCode		= "WSIN861"		
	stMessage.Icon			= Exclamation!
End If

F_Message ( stMessage ) 
*/

Return sPos
  
end function

private function boolean uf_decoder_dp347 (long adcidgti, long adcidnatsin, long adcidmotif, ref string aslibmemoire, boolean abcocherresilautoadh, ref integer aicodresiladh);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Decoder_DP347 (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 22/04/2020
//* Libellé			: 
//* Commentaires	: [DT472]
//*
//* Arguments		: Aucun
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

Long lDeb, lFin, lRow, lRowCacResil 
n_cst_string lnvPFCString
Int iPos, iPos2
String sVal, sVal2, sValCacResil 
DateTime dtMajLe 

// FALSE = Param Non trouvé ou ne matche pas => Aucune résil
// TRUE  = Param trouvé ou matche => résil

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_wSin.GetItemNumber ( 1, "ID_PROD" ), '-DP', 347 )
If lDeb <= 0 Then Return FALSE


// Trouve-t-on le refus dans le refus_seul 
lRow = idw_DetPro.Find ( "ID_CODE_NUM = " + String ( adcidgti ), lDeb, lFin )

If lRow <= 0 Then Return False 

sVal = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lRow, "VAL_CAR" ), "REFUS_SEUL", ";")
iPos = Pos ( sVal, "#" + String ( adcIdMotif ) + "#" )

// Sinon est-il trouvé dans la recherche couplé à l'IdNatSin
If iPos <=0 Then
	sVal  = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lRow, "VAL_CAR" ), "REFUS_COUPLE", ";")
	sVal2 = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lRow, "VAL_CAR" ), "NATSIN", ";")
	iPos = Pos ( sVal, "#" + String ( adcIdMotif ) + "#" )
	iPos2 = Pos ( sVal2, "#" + String ( adcidnatsin ) + "#" )
	
	If iPos <= 0 Or iPos2 <= 0 then iPos = 0
	
End If 

asLibMemoire = lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lRow, "VAL_CAR" ), "LIB_MEMOIRE", ";")
aiCodResilAdh = Integer ( lnvPFCString.of_getkeyvalue (idw_DetPro.GetItemString ( lRow, "VAL_CAR" ), "COD_RESIL_ADH", ";"))


If abCocherResilAutoAdh Then
	If iPos > 0 Then

		lRowCacResil = idw_wdivsin.Find("UPPER(NOM_ZONE)='RESIL_AUTO_ADH'", 1, idw_wdivsin.RowCount())
		
		If lRow> 0 Then
			sValCacResil = idw_wdivsin.GetItemString (lRowCacResil, "VAL_CAR") 
		
			If sVal <> "O" Then
				This.uf_gestong_divers_majzone( "RESIL_AUTO_ADH", lRowCacResil, K_MAJZONE, "O" )
			End If
		End If
	
		Return TRUE
	Else 
		Return FALSE
	End If 
Else 
	Return iPos > 0
End IF 

Return False

end function

public subroutine uf_creerdossier (string asnomfichier);//*-----------------------------------------------------------------
//*
//* Fonction		: u_sp_gs_trait_etat::uf_creerdossier
//* Auteur			: F. Pinon
//* Date				: 07/12/2011 09:56:12
//* Libellé			: 
//* Commentaires	: [FPI.20111207]
//*
//* Arguments		: value string asnomfichier	 */
//*
//* Retourne		: (none)	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------
String sNomDir
Integer iRet

sNomDir=LeftA(asnomfichier,LenA(asnomfichier) - PosA(Reverse(asnomfichier), "\"))

if LenA(sNomDir) < 4 Then return // ne devrait pas arriver.

If not DirectoryExists(sNomDir) Then
	iRet=CreateDirectory ( sNomDir )
	If iRet=-1 Then uf_creerdossier(sNomDir)
	iRet=CreateDirectory ( sNomDir )
End if
end subroutine

private function boolean uf_gestionrepcourrierlocal ();//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_GestionRepCourrierLocal  (PRIVATE)
//* Auteur        : JFF
//* Date          : 31/03/2021
//* Libellé       : Gestion du répertoire local du courrier sous c:\temp\trg\courrier
//* Commentaires  : 	[PRBLE_PATCH_MS_WORD]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Boolean bRet
String sNomDir, sCheminRepCourrierLocal
Integer iRet

sCheminRepCourrierLocal = stGlb.sRepTempo + "COURRIER\"

bRet = True

CreateDirectory ( sCheminRepCourrierLocal )
stGLB.uoWin.Uf_FEraseAll ( sCheminRepCourrierLocal + "*.*")


// This.uf_creerdossier(sCheminRepCourrierLocal)
If RemoveDirectory ( sCheminRepCourrierLocal ) < 0 Then 

	stMessage.sTitre		= "Répertoire Courrier Local"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sVar[1]    = sCheminRepCourrierLocal
	stMessage.sCode		= "WSIN869"

	F_Message ( stMessage ) 	
	
	Return False 
End If 

Yield () // Impératif !

If CreateDirectory ( sCheminRepCourrierLocal ) < 0 Then 
	stMessage.sTitre		= "Répertoire Courrier Local"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= OK!
	stMessage.sVar[1]    = sCheminRepCourrierLocal
	stMessage.sCode		= "WSIN870"

	F_Message ( stMessage ) 	

	Return False 
End If 

Return bRet 

end function

public subroutine uf_modification_para_dynamique_dp359 (string asidnatcour, ref string astxtcompo);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_Modification_Para_Dynamique_dp359 (PRIVATE)
//* Auteur			: JFF
//* Date				: 18/08/2021
//* Libellé			: 
//* Commentaires	: [RS950]
//*
//* Arguments		: 
//*
//* Retourne		: 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

String sValCar, sIdParaDyn, sIdCasTrt, sVersion 
Long lDeb, lFin, lCpt, lRow
Int iPos
n_cst_string lnvString

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_WSin.GetItemNumber ( 1, "ID_PROD" ), "-DP", 359)
If lDeb <= 0 Then Return

sValCar = idw_DetPro.GetItemString(lDeb,"VAL_CAR" )

For lCpt = lDeb To lFin 

	sIdParaDyn = Upper ( lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "ID_PARA_DYN", ";"))
	sIdCasTrt = Upper ( lnvString.of_getkeyvalue (idw_DetPro.GetItemString ( lDeb, "VAL_CAR" ), "CAS_TRT", ";")	)

	Choose Case sIdCasTrt 
		Case "FCT_SOUPLESSE_BNP"  // RS950
			
			// Sommes-nous dans le cas ?
			lRow = idw_wdivdet.Find ( "POS ( LOWER ( NOM_ZONE ), 'souplesse_') > 0 AND VAL_CAR IN ( 'PSN', 'VSN') ",1 , idw_wdivdet.RowCount())			
		
			// Si une des deux souplesses (Perte Suite Négligences et/ou Vol Suite Négligences) est choisie par le GT Alors 
			If lRow > 0 Then
				Choose Case TRUE 
						
					// S’il y a au moins un règlement par virement dans ce courrier (donc code courrier de type ACVxxx )  Alors (Ce cas l’emporte sur tout autre cas)
					Case Left ( asidnatcour, 3) = "ACV"
						// Je substitue VD01.001 par le 1er paragraphe Z154 (cas Règlement Virement)
						// Je ne le fais que si je trouve le paragraphe dans le param en para info
						
						If idw_ParaProd.Find ( "ID_PARA = 'Z154'", 1, idw_ParaProd.Rowcount () ) > 0 Then
							
							// Je cherche la version du paragraphe IM_S02_PARAGRAPHE
							sVersion = space (3)
							SQLCA.IM_S02_PARAGRAPHE ( "Z154", sVersion )
							
							iPos = Pos ( asTxtCompo, sIdParaDyn ) 
							If iPos > 0 Then
								// +16 car on enlève VD01 et V011
								asTxtCompo = Left ( asTxtCompo, iPos -1 ) + "Z154" + "." + sVersion + Mid ( asTxtCompo, iPos + 16, Len ( asTxtCompo ) )
							End If 
						End If 

					// S’il y a au moins un règlement dans ce courrier (donc code courrier de type ACCxxx)  Alors (Ce cas l’emporte sur tout autre cas)
					Case Left ( asidnatcour, 3)  = "ACC"
						// Je substitue VD01.001 par le 1er paragraphe Z155 (cas Règlement chèque)
						// Je ne le fais que si je trouve le paragraphe dans le param en para info
						
						If idw_ParaProd.Find ( "ID_PARA = 'Z155'", 1, idw_ParaProd.Rowcount () ) > 0 Then
							
							// Je cherche la version du paragraphe IM_S02_PARAGRAPHE
							sVersion = space (3)
							SQLCA.IM_S02_PARAGRAPHE ( "Z155", sVersion )
							
							iPos = Pos ( asTxtCompo, sIdParaDyn ) 
							If iPos > 0 Then
								// +16 car on enlève VD01 et C005
								asTxtCompo = Left ( asTxtCompo, iPos -1 ) + "Z155" + "." + sVersion + Mid ( asTxtCompo, iPos + 16, Len ( asTxtCompo ) )
							End If 
						End If 
					
					
					// Sinon S’il y au moins une pièce demandée (sans règlement puisque traité au dessus, donc code courrier de type ACxPxx ou ACxPxx) ALORS
					Case Mid ( asidnatcour, 4, 1 ) = "P"
						// Je substitue VD01.001 par le 1er paragraphe Z153 (cas Dde de pièces)						
						// Je ne le fais que si je trouve le paragraphe dans le param en para info
						
						If idw_ParaProd.Find ( "ID_PARA = 'Z153'", 1, idw_ParaProd.Rowcount () ) > 0 Then
							
							// Je cherche la version du paragraphe IM_S02_PARAGRAPHE
							sVersion = space (3)
							SQLCA.IM_S02_PARAGRAPHE ( "Z153", sVersion )
							
							iPos = Pos ( asTxtCompo, sIdParaDyn ) 
							If iPos > 0 Then
								asTxtCompo = Left ( asTxtCompo, iPos -1 ) + "Z153" + "." + sVersion + Mid ( asTxtCompo, iPos + 8, Len ( asTxtCompo ) )
							End If 
						End If 	
					
					// Je supprime le paragraphe dynamique si aucune des options ci-dessus ne répond
					Case Else
							iPos = Pos ( asTxtCompo, sIdParaDyn ) 
							If iPos > 0 Then
								asTxtCompo = Left ( asTxtCompo, iPos -1 ) + Mid ( asTxtCompo, iPos + 8, Len ( asTxtCompo ) )
							End If 
					
				End Choose 				
			Else 
				// Je supprime le paragraphe dynamique si aucune souplesse cochée
				iPos = Pos ( asTxtCompo, sIdParaDyn ) 
				If iPos > 0 Then
					asTxtCompo = Left ( asTxtCompo, iPos -1 ) + Mid ( asTxtCompo, iPos + 8, Len ( asTxtCompo ) )
				End If 
			End If 
			
	End Choose

Next 

end subroutine

private function long uf_zn_trt_divsin_dysfonc_extranet_franch (string asdata, string asnomcol, long alrow);
//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_dysfonc_extranet_franch (PRIVATE)
//* Auteur			: JFF
//* Date				: 26/08/2021
//* Libellé			: Contrôle de la zone dysfonc_extranet_franchise
//* Commentaires	: [RS962_DYSFONC_EXTRA]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../.... 
//*-----------------------------------------------------------------

Integer iAction
Long lRow, lDeb, lFin
String sSql, sData

if asData="N" Then return 2

if not uf_getautorisation2( 29) Then return 2

iAction=0

sData = Upper ( This.uf_GestOng_Divers_Trouver ( "FRANCHISE_PAYBOX" ) )

If sData = "O" Then

	stMessage.sTitre      = "Dysfonctionnement Extranet"
	stMessage.Icon         = Information!
	stMessage.bErreurG   = FALSE
	stMessage.sCode      = "WSIN874"
	stMessage.Bouton      = Ok!
			
   F_Message ( stMessage ) 
	Return 2
	
End IF 

If idw_Wsin.GetItemNumber ( 1, "CPT_VALIDE") <= 0 Then
	stMessage.sTitre      = "Dysfonctionnement Extranet"
	stMessage.Icon         = Information!
	stMessage.bErreurG   = FALSE
	stMessage.sCode      = "WSIN876"
	stMessage.Bouton      = Ok!
			
   F_Message ( stMessage ) 
	Return 2
	
End If 


stMessage.sTitre      = "Dysfonctionnement Extranet"
stMessage.Icon         = Exclamation!
stMessage.bErreurG   = FALSE
stMessage.sCode      = "WSIN873"
stMessage.Bouton      = YesNo!
			
If F_Message ( stMessage ) = 2 Then
	iAction = 2 // Reject tha data
End If

If iAction=0 Then
	// Création d'un Contact/Travail
	sSql = "Exec sysadm.PS_I_FRANCHISE_PAR_CB_DYSFONCT_EXTRANET " + & 
					String ( idw_wsin.GetItemNumber  ( 1, "ID_SIN" ) ) + "." + "," + &
					"'" + stGlb.sCodOper + "'"
					
	F_Execute ( sSql, SQLCA )
	
	iPbControler.Enabled = False	
	
	stMessage.sTitre      = "Dysfonctionnement Extranet"
	stMessage.Icon         = Information!
	stMessage.bErreurG   = FALSE
	stMessage.sCode      = "WSIN875"
	stMessage.Bouton      = Ok!
			
   F_Message ( stMessage ) 	
	
End if



Return iAction

end function

private function string uf_controlergestion_interassureur ();//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::uf_ControlerGestion_InterAssureur (PRIVATE)
//* Auteur			: JFF
//* Date				: 29/08/2007
//* Libellé			: 
//* Commentaires	:  [PMO89_RS4822]
//*
//* Arguments		: 
//*
//* Retourne		: String sPos
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

String sPos, sValCar, sCodInter, sMsg, sNomInter, sLibInter, sVilleNaiss, sPaysNaiss
Long lTotInter, lTotCmde, lDeb, lFin, lCptInter, lCodEtatDossier, lCodeEtatInterAssureur, lVal1, lVal2
Boolean bPrestaCNV, bAMU200 
n_cst_string lnvString
DateTime	dtDteNaiss

sPos = "" 
sMsg = ""
bAMU200 = FALSE

F_RechDetPro ( lDeb, lFin, idw_DetPro, idw_Produit.GetItemNumber ( 1, "ID_PROD" ), '-DP', 365 )
If lDeb <= 0 Then Return sPos

idw_LstInter.SetFilter ( "" )
idw_LstInter.Filter ( )
idw_LstInter.Sort()

idw_LstwCommande.SetFilter ( "" )
idw_LstwCommande.Filter ( )
idw_LstwCommande.Sort()

lTotInter = idw_LstInter.RowCount()
lTotCmde = idw_LstInter.RowCount()
	
sValCar = lnvString.of_getkeyvalue(idw_DetPro.GetItemString(lDeb,"VAL_CAR" ), "TYP_INTER", ";") 

lCodEtatDossier = idw_Wsin.GetItemNumber ( 1, "COD_ETAT" ) 
bPrestaCNV = idw_LstwCommande.Find ( "COD_ETAT = 'CNV'", 1, idw_LstwCommande.RowCount() ) > 0 

For lCptInter = 1 To lTotInter 

	sCodInter = idw_LstInter.GetItemString ( lCptInter, "COD_INTER" ) 

	Choose Case sCodInter
		case "A"
			sLibInter = "Assuré"
		case "B"
			sLibInter = "Banque"
		case "F"
			sLibInter = "Fournisseur"
		case "L"
			sLibInter = "Livraison"
		case "T"
			sLibInter = "Autre"
		case Else
			sLibInter = "Non défini"
	End Choose			

	If Not ( Not IsNull ( sCodInter ) And Pos ( sValCar, "#" + sCodInter + "#" ) > 0 ) Then Continue
	
	lCodeEtatInterAssureur = idw_LstInter.GetItemNumber ( lCptInter, "COD_ETAT_CTRLE_INTER" ) 
	sNomInter = idw_LstInter.GetItemString ( lCptInter, "NOM" ) 
	
   
	Choose Case lCodeEtatInterAssureur 
		Case 300
			Continue
		Case 0, 100, 200
			If lCodeEtatInterAssureur = 0 And Not ( Not IsNull ( sCodInter ) And Pos ( sValCar, "#" + sCodInter + "#" ) > 0 ) Then Continue
			
			// Recherche de forçage sur le dossier

			// Un règlement a-t-il été forcé ?
			lVal1 =idw_wDetail.Find ( "ALT_REG = 'O'", 1, idw_wDetail.RowCount () )

			// Une PEC a-t-elle été forcée ?			
			lVal2 = idw_wDivDet.Find ( "UPPER ( NOM_ZONE ) = 'ALT_PEC' AND VAL_CAR = 'O'", 1, idw_wDivDet.Rowcount() )

			If lVal1 > 0 Or lVal2 > 0 Then
				Continue
			Else 
				If lCodEtatDossier = 500 or bPrestaCNV Then
					
					dtDteNaiss = idw_LstInter.GetItemDateTime ( lCptInter, "DTE_NAISS" ) 
					sVilleNaiss = Trim ( idw_LstInter.GetItemString ( lCptInter, "VILLE_NAISS" ))
					sPaysNaiss = Trim ( idw_LstInter.GetItemString ( lCptInter, "PAYS_NAISS" ))
					
					If IsNull ( dtDteNaiss ) Or IsNull ( sVilleNaiss ) Or sVilleNaiss = "" Or IsNull ( sPaysNaiss ) Or sPaysNaiss= "" Then
						stMessage.sTitre		= "PMO89/RS4822 : Contrôle interlocuteur par assureur"
						stMessage.Icon			= Information!
						stMessage.bErreurG	= FALSE
						stMessage.Bouton		= Ok!
						stMessage.sVar[1]    = sLibInter
						stMessage.sCode		= "WSIN895 "
						
						sPos = "ALT_BLOC"
						F_Message ( stMessage ) 	
						Return sPos
					End If 					
					
					
					sPos = "ALT_BLOC"
					sMsg += "- " + sNomInter + " (Type " + sLibInter +")" 
					If lCodeEtatInterAssureur = 100 Then
						sMsg += ", contrôle en cours chez l'assureur"
					End If 
					If lCodeEtatInterAssureur = 200 Then
						sMsg += ", rejeté par l'assureur"
						bAMU200 = TRUE
					End If 
					
					sMsg = sMsg + char(10)
					
				Else 
					Continue
				End If 
			End If 

			
	End Choose 
Next 

If sPos <> "" Then
	stMessage.sTitre		= "PMO89/RS4822 : Contrôle interlocuteur par assureur"
	stMessage.Icon			= Exclamation!
	stMessage.bErreurG	= FALSE
	stMessage.Bouton		= Ok!
	stMessage.sVar[1]    = sMsg

	stMessage.sCode		= "WSIN893"
	If bAMU200 then 	stMessage.sCode = "WSIN894"
	
	sPos = "ALT_BLOC"
	F_Message ( stMessage ) 	
End If


Return sPos



end function

private function string uf_validation_finale_sql_hubprestataire (ref datastore adshubdonneesprestasimpa2);//*-----------------------------------------------------------------
//*
//* Fonction      : u_gs_sp_sinistre::uf_Validation_Finale_Sql_HubPrestataire (PRIVATE)
//* Auteur        : JFF
//* Date          : 20/03/2024
//* Libellé       : Construction du SQL qui sera injecté dans le Hub Prestataire
//* Commentaires  : [HP252_276_HUB_PRESTA]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//*-----------------------------------------------------------------

Boolean bRet
String sTab [70,2], sChaineSqlRet, sVal
Int iTot, iCpt

sTab [1,1]="iCas"  ;  sTab [1,2]="number"
sTab [2,1]="iIdSin"  ;  sTab [2,2]="number"
sTab [3,1]="iIdSeq"  ;  sTab [3,2]="number"
sTab [4,1]="sIdHubPresta"  ;  sTab [4,2]="char(20)"
sTab [5,1]="sIdFour"  ;  sTab [5,2]="char(3)"
sTab [6,1]="sTypDommage"  ;  sTab [6,2]="char(100)"
sTab [7,1]="sPointService"  ;  sTab [7,2]="char(40)"
sTab [8,1]="sModeLogis"  ;  sTab [8,2]="char(40)"
sTab [9,1]="sCodePickUp"  ;  sTab [9,2]="char(20)"
sTab [10,1]="sAdrNomPickUp"  ;  sTab [10,2]="char(40)"
sTab [11,1]="sAdrReferenceAssPickUp"  ;  sTab [11,2]="char(40)"
sTab [12,1]="sAdr1PickUp"  ;  sTab [12,2]="char(40)"
sTab [13,1]="sAdr2PickUp"  ;  sTab [13,2]="char(40)"
sTab [14,1]="sAdrCpltPickUp"  ;  sTab [14,2]="char(40)"
sTab [15,1]="sAdrCpPickUp"  ;  sTab [15,2]="char(5)"
sTab [16,1]="sAdrVillePickUp"  ;  sTab [16,2]="char(40)"
sTab [17,1]="iCodeProcess"  ;  sTab [17,2]="number"
sTab [18,1]="sLibCodeProcess"  ;  sTab [18,2]="char(35)"
sTab [19,1]="iIdGti"  ;  sTab [19,2]="number"
sTab [20,1]="sLibPersoGti"  ;  sTab [20,2]="char(35)"
sTab [21,1]="iIdDetail"  ;  sTab [21,2]="number"
sTab [22,1]="iIdProd"  ;  sTab [22,2]="number"
sTab [23,1]="sLibProd"  ;  sTab [23,2]="char(35)"
sTab [24,1]="sIdProdAdh"  ;  sTab [24,2]="number"
sTab [25,1]="iIdEts"  ;  sTab [25,2]="number"
sTab [26,1]="sIdAdh"  ;  sTab [26,2]="char(19)"
sTab [27,1]="iIdSdos"  ;  sTab [27,2]="number"
sTab [28,1]="sIdTypArt"  ;  sTab [28,2]="char(3)"
sTab [29,1]="iCodCivLivr"  ;  sTab [29,2]="number"
sTab [30,1]="sLibCivLivrCourt"  ;  sTab [30,2]="char(35)"
sTab [31,1]="sLibCivLivrLong"  ;  sTab [31,2]="char(35)"
sTab [32,1]="IdContratAbonne"  ;  sTab [32,2]="char(20)"
sTab [33,1]="NomAss"  ;  sTab [33,2]="char(35)"
sTab [34,1]="PrenomAss"  ;  sTab [34,2]="char(35)"
sTab [35,1]="NomLivr"  ;  sTab [35,2]="char(35)"
sTab [36,1]="PrenomLivr"  ;  sTab [36,2]="char(35)"
sTab [37,1]="sAdr1Livr"  ;  sTab [37,2]="char(35)"
sTab [38,1]="sAdr2Livr"  ;  sTab [38,2]="char(35)"
sTab [39,1]="sAdr3Livr"  ;  sTab [39,2]="char(35)"
sTab [40,1]="sAdrCpLivr"  ;  sTab [40,2]="char(5)"
sTab [41,1]="sAdrVilleLivr"  ;  sTab [41,2]="char(35)"
sTab [42,1]="sNumTel1Ass"  ;  sTab [42,2]="char(20)"
sTab [43,1]="sNumTel2Ass"  ;  sTab [43,2]="char(20)"
sTab [44,1]="sNumTel3Ass"  ;  sTab [44,2]="char(20)"
sTab [45,1]="sMailAssure"  ;  sTab [45,2]="char(128)"
sTab [46,1]="sNumImeiAppSin"  ;  sTab [46,2]="char(20)"
sTab [47,1]="sNumSerieAppSin"  ;  sTab [47,2]="char(20)"
sTab [48,1]="sDescriptionProbleme"  ;  sTab [48,2]="char(255)"
sTab [49,1]="sCodEtat"  ;  sTab [49,2]="char(3)"
sTab [50,1]="dtValideLe"  ;  sTab [50,2]="datetime"
sTab [51,1]="sValidePar"  ;  sTab [51,2]="char(4)"
sTab [52,1]="dtCmdGenLe"  ;  sTab [52,2]="datetime"
sTab [53,1]="sIdRefFour"  ;  sTab [53,2]="char(20)"
sTab [54,1]="sOrdreAction"  ;  sTab [54,2]="char(20)"
sTab [55,1]="iIdAssureur"  ;  sTab [55,2]="number"
sTab [56,1]="sLibAssureur"  ;  sTab [56,2]="char(35)"
sTab [57,1]="sLibPolice"  ;  sTab [57,2]="char(35)"
sTab [58,1]="sTypAppSin"  ;  sTab [58,2]="char(3)"
sTab [59,1]="sLibTypAppSin"  ;  sTab [59,2]="char(35)"
sTab [60,1]="sMarqAppSin"  ;  sTab [60,2]="char(35)"
sTab [61,1]="sModlAppSin"  ;  sTab [61,2]="char(35)"
sTab [62,1]="sRefAppSin"  ;  sTab [62,2]="char(20)"
sTab [63,1]="sNumTelSin"  ;  sTab [63,2]="char(25)"
sTab [64,1]="mtValAchat"  ;  sTab [64,2]="decimal(2)"
sTab [65,1]="mtPriseEnCharge"  ;  sTab [65,2]="decimal(2)"
sTab [66,1]="dtDateAchat"  ;  sTab [66,2]="datetime"
sTab [67,1]="sEtatAppSin"  ;  sTab [67,2]="char(20)"
sTab [68,1]="sCodeVerrou"  ;  sTab [68,2]="char(20)"
sTab [69,1]="sDesimlocke"  ;  sTab [69,2]="char(20)"
sTab [70,1]="sInfo_spb_frn_cplt"  ;  sTab [70,2]="char(800)"


sChaineSqlRet = "Exec edi.PS_HP276_I_HP_VALIDATION_PRESTA_DANS_LE_HUB_PRESTATAIRE "  

iTot = UpperBound ( sTab ) 

For iCpt = 1 To iTot 
	
	Choose Case Left ( sTab [iCpt, 2 ], 4 ) 
		Case "char"
			sVal = adsHubDonneesPrestaSimpa2.GetItemString ( 1, sTab [iCpt, 1 ] )

		Case "deci"
			sVal = String ( adsHubDonneesPrestaSimpa2.GetItemDecimal ( 1, sTab [iCpt, 1 ] ), "##0.00" )

		Case "long", "numb"
			sVal = String ( adsHubDonneesPrestaSimpa2.GetItemNumber ( 1, sTab [iCpt, 1 ] ) )
			
		Case "date"
			sVal = String ( adsHubDonneesPrestaSimpa2.GetItemDateTime ( 1, sTab [iCpt, 1 ] ), "mm/dd/yyyy hh:mm:ss" )  // Date Anglaise sur le HUB
			
	End Choose 
	
	If IsNull ( sVal ) Then sVal = "null"
	
	sVal = F_Remplace ( sVal, "'", "''" )
	sVal = F_Remplace ( sVal, Char(9), " " ) // Tabulation
	
	If sVal <> "null" Then

		Choose Case Left ( sTab [iCpt, 2 ], 4 ) 
			Case "char", "date"
				sVal = "'" + sVal + "'"	
				
		End Choose 
	
	End If 

	If iCpt <> iTot Then sVal += ","	
	
	sChaineSqlRet += sVal 
	
Next 


Return sChaineSqlRet

end function

private function boolean uf_gestiontranssqlhubpresta (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: U_Gs_Sp_Sinistre::uf_GestionTransSqlHubPresta			(PRIVATE)
//* Auteur			: JFF
//* Date				: 21/03/2024
//* Libellé			: [HP252_276_HUB_PRESTA]
//* Commentaires	: Gestion de la transaction avec la base du HUB PRESTATAIRE
//*
//* Arguments		: Aucun
//*
//* Retourne		: Boolean			TRUE 	= Tout se passe bien
//*										 	FALSE	= Il y a un problème
//*
//*-----------------------------------------------------------------
//* MAJ      PAR      Date	  Modification
//*-----------------------------------------------------------------

Boolean bRet
String sSection

Choose Case asCas
	Case "CONNEXION_HUB"
		
		If Not IsValid ( itrHubPrestataire ) Then
			itrHubPrestataire = Create u_Transaction_Hub_Prestataire
		End IF 

		If Upper(SQLCA.Database) = "SIMPA2_PRO" Then
			sSection = "HUB PRESTATAIRE BASE"
		Else
			If F_CLE_NUMERIQUE ( "INSTANCE_PPR_REC_HUB" ) = 1 Then
				sSection = "HUB PRESTATAIRE BASE REC"
			Else
				sSection = "HUB PRESTATAIRE BASE PPR"				
			End If 
				
		End IF 

		bRet = f_ConnectSqlServer_Hub_Prestataire ( stGLB.sFichierIni   , &
											 sSection, &
											 itrHubPrestataire    , &
											 stGLB.sMessageErreur, &
											 stGlb.slibcourtappli, &
											 stGlb.sCodOper          ) 

	Case "DECONNEXION_HUB"
		
		Disconnect using itrHubPrestataire ;
		
		If IsValid ( itrHubPrestataire ) Then Destroy itrHubPrestataire

End CHoose 

		
Return ( bRet )
end function

public subroutine uf_initialiser_dw_desc (ref u_datawindow_detail adw_inter, ref u_datawindow_detail adw_gti, ref datawindow adw_norm[], ref u_libelle_dga aulibelle, ref u_datawindow_detail adw_contact, ref datawindow adw_corbeille, ref u_datawindow adw_dossuivipar, ref u_datawindow_detail adw_lstwcommande, ref u_datawindow adw_boitearchive, ref u_datawindow adw_wdivsin, ref u_datawindow_detail adw_wdivdet, ref picturebutton apbcontroler, ref statictext astpauseapi_lab, ref statictext astattente_diverse);//*-----------------------------------------------------------------
//*
//* Fonction		: Uf_Initialiser_Dw_Desc (Public)
//* Auteur			: Erick John Stark
//* Date				: 19/10/1997 18:47:02
//* Libellé			: 
//* Commentaires	: Initialisation des instances pour le NVUO
//*
//* Arguments		: U_DataWindow_Detail	adw_Inter			(Réf)	DataWindow sur les interlocuteurs
//*					  U_DataWindow_Detail	adw_Gti				(Réf)	DataWindow sur les garanties
//*					  DataWindow				adw_Norm[]			(Réf)	Tableau de DataWindow
//*					  U_Libelle_Dga			auLibelle			(Réf)	User Objet servant pour les variables
//*					  ....
//*					  U_DataWindow				adw_BoiteArchive	(Réf)	DataWindow pour la saisie des boites archives.
//*					  U_DataWindow				adw_wDivSin			(Réf)	DataWindow Divers Sinistres.
//*					  U_DataWindow_Detail	adw_wDivDet			(Réf)	DataWindow Divers Sinistres.
//*					  Picture_Button			apbControler	(Ref)	Ref sur Bouton controler	
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    CAG   06/02/2003   Ajout de la dw sur DetPro
//* #3	 CAG   05/03/2003	  DCMP 030135 : Ajout d'une table des boutiques
//* #4	 JFF   22/08/2003	  DCMP 030362 : Gestion des communes/CP
//* #5	 JFF	 24/03/2005   On ne lance plus le retrieve sur les TAC
//* #6	 PHG   09/11/2006	  [DCMP060405] Gestion Multiréférentiel
//			 FPI	 24/12/2010	  [24122010.FPI]
//        JFF   06/04/2020   [PM506-1]
//        JFF   26/10/2020   [PM506-1][VDOC29755]
//        JFF   09/09/2022   [PM80_FA12_FRANEX]
//        JFF   07/03/2024   [HP252_276_HUB_PRESTA]
//*-----------------------------------------------------------------

//u_DeclarationFuncky uoDeclarationFuncky //[I037] Migration FUNCKy
String sFic

iPbControler= apbControler

/*------------------------------------------------------------------*/
/* DataWindow sur les INTERLOCUTEURS. Liste => U_DataWindow_Detail. */
/*------------------------------------------------------------------*/
idw_LstInter	= adw_Inter
idw_LStInter.Uf_SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur les GARANTIES.      Liste => U_DataWindow_Detail. */
/*------------------------------------------------------------------*/
idw_LstGti		= adw_Gti
idw_LstGti.Uf_SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur les CONTACTS.      Liste => U_DataWindow_Detail.  */
/*------------------------------------------------------------------*/
idw_LstContact	= adw_Contact
idw_LstContact.Uf_SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur les COMMANDES.      Liste => U_DataWindow_Detail. */
/*------------------------------------------------------------------*/
idw_LstWCommande	= adw_LstwCommande
idw_LstWCommande.Uf_SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* On va utiliser un tableau de DW pour armer les instances du      */
/* NVUO, il faut les charger dans le bon ordre.                     */
/*------------------------------------------------------------------*/
/*------------------------------------------------------------------*/
/* DataWindow sur la table CODE GARANTIE                            */
/*------------------------------------------------------------------*/
idw_CodeGarantie	= adw_Norm[1]
idw_CodeGarantie.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table CODE CONDITION                           */
/*------------------------------------------------------------------*/
idw_CodeCondition	= adw_Norm[2]
idw_CodeCondition.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table PIECE                                    */
/*------------------------------------------------------------------*/
idw_Piece	= adw_Norm[3]
idw_Piece.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table MOTIF                                    */
/*------------------------------------------------------------------*/
idw_Motif	= adw_Norm[4]
idw_Motif.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table FRANCHISE                                */
/*------------------------------------------------------------------*/
idw_Franchise	= adw_Norm[5]
idw_Franchise.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table PLAFOND                                  */
/*------------------------------------------------------------------*/
idw_Plafond	= adw_Norm[6]
idw_Plafond.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table DELAI                                    */
/*------------------------------------------------------------------*/
idw_Delai	= adw_Norm[7]
idw_Delai.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table GARANTIE                                 */
/*------------------------------------------------------------------*/
idw_Garantie	= adw_Norm[8]
idw_Garantie.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table CONDITION                                */
/*------------------------------------------------------------------*/
idw_Condition	= adw_Norm[9]
idw_Condition.SetTransObject ( This.itrTrans )


/*------------------------------------------------------------------*/
/* DataWindow sur la table PARA_PROD                                */
/*------------------------------------------------------------------*/
idw_ParaProd= adw_Norm[10]
idw_ParaProd.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table W_PARA_INFO                              */
/*------------------------------------------------------------------*/
idw_wParaInfo	= adw_Norm[11]
idw_wParaInfo.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table W_DETAIL                                 */
/*------------------------------------------------------------------*/
idw_wDetail	= adw_Norm[12]
idw_wDetail.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table W_PIECE                                  */
/*------------------------------------------------------------------*/
idw_wPiece	= adw_Norm[13]
idw_wPiece.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table W_REFUS                                  */
/*------------------------------------------------------------------*/
idw_wRefus	= adw_Norm[14]
idw_wRefus.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table W_FRAIS                                  */
/*------------------------------------------------------------------*/
idw_wFrais	= adw_Norm[15]
idw_wFrais.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table W_COURRIER                               */
/*------------------------------------------------------------------*/
idw_wCourrier	= adw_Norm[16]
idw_wCourrier.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table POLICE/COMPAGNIE                         */
/*------------------------------------------------------------------*/
idw_Police	= adw_Norm[17]
idw_Police.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table W_PARA_PLAFOND                           */
/*------------------------------------------------------------------*/
idw_wParaPlafond	= adw_Norm[18]
idw_wParaPlafond.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table W_REG_GTI                                */
/*------------------------------------------------------------------*/
idw_wRegGti	= adw_Norm[19]
idw_wRegGti.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table ARTICLE											  */
/*------------------------------------------------------------------*/
idw_Article	= adw_Norm[20]
idw_Article.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table COMMANDE_TYPE pour les fournisseurs.	  */
/*------------------------------------------------------------------*/
idw_CmdTypFrn = adw_Norm[21]
idw_CmdTypFrn.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table COMMANDE_TYPE pour les articles.			  */
/*------------------------------------------------------------------*/
idw_CmdTypArt = adw_Norm[22]
idw_CmdTypArt.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* #1                                                               */
/*------------------------------------------------------------------*/
/* DataWindow sur la table DET_PRO 											  */
/*------------------------------------------------------------------*/
idw_DetPro = adw_Norm[23]
idw_DetPro.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* #3 : DataWindow sur la table BOUTIQUE									  */
/*------------------------------------------------------------------*/
idw_Boutique = adw_Norm[24]
idw_Boutique.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* #4 : DataWindow des communes												  */
/* Pas de SetTransObject puisque IMPORTFILE								  */
/*------------------------------------------------------------------*/
idw_Commune = adw_Norm[25]

/*------------------------------------------------------------------*/
/* DataWindow des TAC_IMEI														  */
/*------------------------------------------------------------------*/
idw_TacImei = adw_Norm[26]
idw_TacImei.SetTransObject ( This.itrTrans )
// #5
/*------------------------------------------------------------------*/
/* Suite à la nouvelle définition du TAC non plus sur 6 car mais    */
/* sur 8, il existe à présent plus de 17000 signatures, trop lourd  */
/* à charger dans une DW. L'accès à la base sera donc ponctuel.     */
/*------------------------------------------------------------------*/
//idw_TacImei.Retrieve ( )

/*------------------------------------------------------------------*/
/* DataWindow des MAIL															  */
/*------------------------------------------------------------------*/
idw_Mail = adw_Norm[27]

/*------------------------------------------------------------------*/
/* DataWindow des Autorisations.												  */
/*------------------------------------------------------------------*/
idw_Autorisation = adw_Norm[28] 
idw_Autorisation.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow onglets divers.													  */
/*------------------------------------------------------------------*/
idw_DivPro = adw_Norm[29] 
idw_DivPro.SetTransObject ( This.itrTrans )
idddw_CodeCar_wDivSin_Charg_Tempo = adw_Norm[30] 
idddw_CodeCar_wDivSin_Charg_Tempo .SetTransObject ( This.itrTrans )
idddw_Code_wDivSin_Charg_Tempo= adw_Norm[31] 
idddw_Code_wDivSin_Charg_Tempo.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow des Codes Equivalence											  */
/*------------------------------------------------------------------*/
idw_CodEqVal = adw_Norm[32] 
idw_CodEqVal.SetTransObject ( This.itrTrans )
idw_CodEqVal.Retrieve ( )

/*------------------------------------------------------------------*/
/* DataWindowS des Mobiles IFR distincts (toutes la les colonnes)   */
/*------------------------------------------------------------------*/
idw_Stk_Ifr = adw_Norm[33] 
idw_Stk_Ifr.SetTransObject ( This.itrTrans )
idw_Stk_Ifr.Retrieve ( )
idw_Stk_Ifr.Sort ()

/*------------------------------------------------------------------*/
/* Datawindows que des marques IFR distincts                        */
/*------------------------------------------------------------------*/
idddw_IfrMarque = adw_Norm[34] 
idddw_IfrMarque .SetTransObject ( This.itrTrans )
idddw_IfrMarque .Retrieve ( "MARQUE" )
idddw_IfrMarque .Sort ()

/*------------------------------------------------------------------*/
/* Datawindows que des marques/modele IFR distincts                 */
/*------------------------------------------------------------------*/
idddw_IfrModele = adw_Norm[35] 
idddw_IfrModele.SetTransObject ( This.itrTrans )
idddw_IfrModele.Retrieve ( "MODELE" )
idddw_IfrModele.Sort ()

/*------------------------------------------------------------------*/
/* DataWindowS des Codes MB													  */
/*------------------------------------------------------------------*/
/* #6 [DCMP060405] PHG 09/11/2006                                   */
/* Gestion Multi Référentiel - regroupement par famille de code.    */
/* On gère les marques par famille de code                          */
/* - Déport du chargement des marque dans uf_preparer_modifier      */
/*------------------------------------------------------------------*/
idw_CodeMB = adw_Norm[36] 
//idw_CodeMB.SetTransObject ( This.itrTrans )
//idw_CodeMB.Retrieve ( "-MB" )
//idw_CodeMB.SetSort ( "LIB_CODE A" )
//idw_CodeMB.Sort ()

/*------------------------------------------------------------------*/
/* Datawindows que des marques/modele DTY distincts                 */
/*------------------------------------------------------------------*/
idddw_DtyMarque = adw_Norm[37] 
idddw_DtyMarque.SetTransObject ( This.itrTrans )
idddw_DtyMarque.Retrieve ( "MARQUE" )
idddw_DtyMarque.Sort ()

/*------------------------------------------------------------------*/
/* Datawindows que des marques/modele DTY distincts                 */
/*------------------------------------------------------------------*/
idddw_DtyModele = adw_Norm[38] 
idddw_DtyModele.SetTransObject ( This.itrTrans )
idddw_DtyModele.Retrieve ( "MODELE" )
idddw_DtyModele.Sort ()

/*------------------------------------------------------------------*/
/* DataWindowS des Codes RF													  */
/*------------------------------------------------------------------*/
idw_CodeRF = adw_Norm[39] 
idw_CodeRF.SetTransObject ( This.itrTrans )
idw_CodeRF.Retrieve ( "-RF" )
idw_CodeRF.SetSort ( "ID_CODE A" )
idw_CodeRF.Sort ()

/*------------------------------------------------------------------*/
/* DataWindowS des Codes RF													  */
/*------------------------------------------------------------------*/
idwStkCodicDarty = adw_Norm[40] 
idwStkCodicDarty.SetTransObject ( This.itrTrans )
idwStkCodicDarty.Retrieve ()
idwStkCodicDarty.Sort ()

/*------------------------------------------------------------------*/
/* Onglets Divers sur grilles détails.										  */
/*------------------------------------------------------------------*/
idw_DivPDet = adw_Norm[41] 
idw_DivPDet.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow sur la table wreg_frais_annexe_frn                    */
/*------------------------------------------------------------------*/
idw_wreg_frais_annexe_frn = adw_Norm[42]
idw_wreg_frais_annexe_frn.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* DataWindow des données onglets divers.									  */
/*------------------------------------------------------------------*/
idw_wDivSin = adw_wDivSin
//idw_wDivSin.SetTransObject ( This.itrTrans )
idw_wDivSin.uf_SetTransObject ( This.itrTrans ) // [24122010.FPI]


/*------------------------------------------------------------------*/
/* DataWindow des données onglets divers sur détails.					  */
/*------------------------------------------------------------------*/
idw_wDivDet = adw_wDivDet			
//idw_wDivDet.SetTransObject ( This.itrTrans )
idw_wDivDet.uf_SetTransObject ( This.itrTrans ) // [24122010.FPI]

/*------------------------------------------------------------------*/
/* DGA. Le 21/08/2003.                                              */
/* Gestion des boites archives.                                     */
/*------------------------------------------------------------------*/
/* DataWindow sur la table ROUTAGE pour la gestion du N° de boîte   */ 
/* archive.                                                         */
/*------------------------------------------------------------------*/
idw_BoiteArchive = adw_BoiteArchive
idw_BoiteArchive.SetTransObject ( This.itrTrans )

/*------------------------------------------------------------------*/
/* User Objet servant pour la gestion des variables.                */
/*------------------------------------------------------------------*/
iuoLibelle = auLibelle

/*----------------------------------------------------------------------------*/
/* Corbeille accessible par le user courant                                   */
/*----------------------------------------------------------------------------*/
idw_Corbeille = adw_Corbeille

//uoDeclarationFuncky	= Create u_DeclarationFuncky
//isRepWin 				= uoDeclarationFuncky.Uf_WinDir () 
//Destroy uoDeclarationFuncky

/*------------------------------------------------------------------*/
/* DataWindow sur la table W_REG_GTI                                */
/*------------------------------------------------------------------*/
idw_DosSuiviPar = adw_DosSuiviPar
idw_DosSuiviPar.SetTransObject ( This.itrTrans )

// [PM506-1][VDOC29755]
istPauseAPI_LAB = astPauseAPI_LAB
// istPauseAPI_LAB.text = " ~n~rAppel de l'API extérieure chez BeCLM dans le cadre de la~n~rlutte Anti-Blanchiment et Anti-Terroriste. ~n~r~n~r" + "Veuillez patienter...~n~r~n~r(ne faites aucune action au clavier et à la souris pendant l'appel de l'API svp !)~n~r"
istPauseAPI_LAB.text = " ~n~rAppel d'un WebService extérieur à l'application. ~n~r~n~r" + "Veuillez patienter...~n~r~n~r(ne faites aucune action au clavier et à la souris pendant l'appel de l'API svp !)~n~r"

//istPauseAPI_LAB.BackColor 	= 12639424
istPauseAPI_LAB.X				=  941
istPauseAPI_LAB.Y				=  390
istPauseAPI_LAB.Height		=  470	
istPauseAPI_LAB.Width		= 1585	

// [HP252_276_HUB_PRESTA]
istAttenteDiverse = astattente_diverse

// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	idsHubDonneesPrestaSimpa2 = Create dataStore 
	idsHubDonneesPrestaSimpa2.DataObject = "d_stk_hub_presta_donnees_simpa2_w"
	idsHubDonneesPrestaSimpa2.SetTransObject ( This.itrTrans ) 
End If


// [20241112110249883][DIVOBJ][JFF]
iuoThis = this 
iUoGsSpSinistre2.uf_initialiser_1 (	&
	iuoThis, &
	idw_detpro, &
	idw_wsin, & 
	idw_lstwcommande, &
	idw_wdivsin, &
	idw_wdivdet, & 
	ibcodicdartyvalide, &
	istypetrt, &
	isreferentielapp, &
	K_MAJZONE, &
	idw_wDetail, &
	idw_LstGti, &
	istAttenteDiverse, &
	ibMIG1_CourEmailing, &
	idw_LstInter, &
	idw_wPiece, &
	idw_wRefus, &
	idw_Plafond, &
	idw_wFrais &
	)
// /[20241112110249883][DIVOBJ][JFF]
end subroutine

private function long uf_zn_trt_divsin_typ_presta (string asdata, string asnomcol, long alrow);//*-----------------------------------------------------------------
//*
//* Fonction		: u_gs_sp_sinistre::Uf_Zn_Trt_DivSin_Typ_Presta (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 12/08/2024
//* Libellé			: 
//* Commentaires	: [MCO602_PNEU]
//*
//* Arguments		: String 		asData			Val
//*					  String 		asNomCol			Val
//*					  Long			alRow				Val
//*
//* Retourne		: long
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Integer iAction

Long lRow, lDeb, lFin, lRow2

asData = Upper ( asData )
iAction = 0

lRow = idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () ) 

lRow = idw_wDetail.Find ( "( COD_ETAT = 600 OR COD_ETAT = 500 )", 1, idw_wDetail.RowCount () ) + &
	    idw_LstwCommande.Find ( "COD_ETAT <> 'ANN'", 1, idw_LstwCommande.RowCount () )

If lRow > 0 Then
	idw_wDivSin.iiErreur = 13
	iAction = 1
End If

Return iAction

end function

public subroutine uf_set_valinstance (string ascas, string asval);//*-----------------------------------------------------------------
//*
//* Fonction		: uf_set_valinstance (Public)
//* Auteur			: FABRY JF
//* Date				: 12/11/2024
//* Libellé			: 
//* Commentaires	: Valeur d'instance changeante
//*
//* Arguments		: Voir arguments
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------
//       JFF   19/12/2024 [MIG1_COUR_EMAILING]
//*-----------------------------------------------------------------


If IsNull ( asCas ) Then Return

asCas = Trim ( asCas ) 

If asCas = "" Then Return

Choose Case asCas 

	Case "isReferentielApp"
		isReferentielApp = asVal
		
	Case "ibMIG1_CourEmailing"
		ibMIG1_CourEmailing = Upper ( asVal ) = "TRUE" // [MIG1_COUR_EMAILING]

		
End Choose 
end subroutine

on u_gs_sp_sinistre.create
call super::create
end on

on u_gs_sp_sinistre.destroy
call super::destroy
end on

event destructor;call super::destructor;//*-----------------------------------------------------------------
//*
//* Fonction		: Destructeur
//* Auteur			: Fabry JF
//* Date				: 12/11/2024
//* Libellé			: 
//* Commentaires	: 
//*
//* Arguments		: 
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	If IsValid ( idsHubDonneesPrestaSimpa2 ) Then destroy ( idsHubDonneesPrestaSimpa2 ) 
End If

// [20241112110249883][DIVOBJ][JFF]
If IsValid ( iUoGsSpSinistre2 ) Then destroy ( iUoGsSpSinistre2 ) 
end event

event constructor;call super::constructor;//*-----------------------------------------------------------------
//*
//* Fonction		: Constructor
//* Auteur			: Fabry JF
//* Date				: 12/11/2024
//* Libellé			: [20241112110249883][DIVOBJ][JFF]
//* Commentaires	: Initialisation des instances pour le NVUO n°2
//*
//* Arguments		: 
//*
//* Retourne		: Rien
//*
//*-----------------------------------------------------------------

iUoGsSpSinistre2 = Create u_gs_sp_sinistre_2  // [20241112110249883][DIVOBJ][JFF]



end event


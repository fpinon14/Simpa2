$PBExportHeader$n_cst_int_fic_suivicmd.sru
$PBExportComments$Objet gérant l'intégration du fichier de suivi des commandes en provenance du fournisseur.
forward
global type n_cst_int_fic_suivicmd from nonvisualobject
end type
end forward

global type n_cst_int_fic_suivicmd from nonvisualobject
end type
global n_cst_int_fic_suivicmd n_cst_int_fic_suivicmd

type variables
Private :

Datawindow	idwFourn
Datawindow	idwFicFourn
Datawindow	idwSuiviTrt
Datawindow	idwTri
Datawindow	idwStkRepFourn 
DataStore	idwDetPro

StaticText	istxtNomFic	
ListBox		ilbListeFic

String		K_FIC1       = "MCD"
String		K_FIC2       = "MPR"
String		K_FIC3       = "SUI"
String		K_FIC4       = "SUIVI" //* [MICROMANIA]
String		K_FIC5       = "SPBCGE" //* [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
String		K_FIC6       = "SUIVI_CC_" // [PC363_AUCHAN]
String 		K_FIC7		 = "ED_SPB_GAR_AR_BA_" // [PC13321]
String 		K_FIC8		 = "SUIVICOMMANDES_" // [PM289]
String 		K_FIC9		 = "SUIVIANOMALIES_" // [PM289]
String 		K_FIC10		 = "RET_CTRLE_IMEI_OMT_" // [PC874_2_V1]
String 		K_FIC11		 = "RET_CTRLE_IMEI_OGP_" // [DT424]
String 		K_FIC12		 = "RET_CTRLE_IMEI_OOP_" // [DT424]
String 		K_FIC13		 = "Remboursements_SPB_retour_" // [PMO268_MIG65]


String		K_FICLOG = "LOGCMD\FIC_MOV.LOG"
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//String		K_FICTMP = "\TEMP\FICFOURN.TXT"
String		K_FICTMP = "FICFOURN.TXT"
String		K_FICTMP2 = "FICFOURN_TMP.TXT"  //* [MICROMANIA]
String		K_FIC_SORTIE_OPCON = "ERRSP2.DAT"
//String		K_FIC_FIN_OPCO = "\TEMP\FINOPCO"
String		K_FICFINTRT = "FIN_TRT"

String  		isRepFicOpCon	
String 		isTabFrIntSui[]   
String 		isNomFicOrig  // [PM254_V1]
String 		isIdFour  // [PI065]
String 		isIdTypMvt  // [PI065]
String 		isColLigErrImport // [PI065]
String 		isDataErrImport // [PI065]

Int		iiFicTrc

Boolean		ibErrIntegr // [PI065]
Boolean		ibPrestaHub // [HP252_276_HUB_PRESTA]
	
Long 			ilIdLotLog // [PI065]
Long 			ilNumLigErrImport

u_Transaction_Hub_Prestataire itrHubPrestataire  // [HP252_276_HUB_PRESTA]
end variables

forward prototypes
public subroutine uf_preparer ()
public subroutine uf_bouton_chxfichier ()
public function string uf_detection_auto_nomfic (string aidfourn)
public function integer uf_controler_saisie ()
public function integer uf_lancer_trt ()
private function long uf_charger_fichierfourn ()
private function integer uf_trace (string ascas, string astexte)
private function integer uf_ctrl_fichier_fournisseur ()
private function integer uf_integration_fichier_fournisseur ()
public subroutine uf_initialiser (ref s_pass astpass, ref statictext astxtnomfic, ref listbox alblistefic)
private subroutine uf_formatchaine (ref string asVal)
private function integer uf_sortie_opcon (string ascas, integer aicodeerreur, string astexte, boolean abbox)
public function integer uf_trt_opcon (string ascas)
private function integer uf_ctrl_fichier_dme ()
private function integer uf_integration_fichier_dme (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private subroutine uf_definir_codetat_dme (ref string asval, long alcpt)
private function integer uf_ctrl_fichier_sbe ()
private function integer uf_reglauto (long alidsin, long alidseq, string asidfour, datetime adtdtercpfrn, decimal adcmtfrais, ref string asmesretour)
private function integer uf_integration_envoimail (string asnomfic, string asdateheuretrt, string asidfourn, ref string asmessret)
private function integer uf_ctrl_fichier_mss ()
private function integer uf_integration_fichier_mss (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private subroutine uf_definir_codetat_mss (ref string asval, long alcpt)
private function integer uf_ctrl_fichier_cegetel ()
private function integer uf_integration_fichier_cegetel (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private subroutine uf_definir_codetat_cegetel (ref string asval, long alcpt)
private function integer uf_integration_fichier_cdiscount (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_cdiscount ()
private subroutine uf_definir_codetat_cdiscount (ref string asval, long alcpt)
private function decimal uf_determiner_montant_frais_envoi (string asfour, long alidsin, long alidseq)
public function boolean uf_ctrl_maj (long aidsin, long aidseq, long alcpt)
private function integer uf_integration_fichier_o2m (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_o2m ()
private function integer uf_ctrl_fichier_micromania ()
private subroutine uf_definir_codetat_micromania (ref string asval, long alcpt)
private function integer uf_integration_fichier_micromania (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_cdiscountpro ()
private function integer uf_ctrl_fichier_phoneandphone ()
private subroutine uf_definir_codetat_cdiscountpro (ref string asval, long alcpt)
private function integer uf_integration_fichier_cdiscountpro (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_integration_fichier_phoneandphone (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_sbetv ()
private function integer uf_integration_fichier_sbetv (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_transformationseparateur (string asfichiersource, string asseporig, string assepsubst, string ascas)
private function integer uf_ctrl_fichier_fnac ()
private subroutine uf_definir_codetat_fnac (ref string asval, long alcpt)
private function integer uf_integration_fichier_fnac (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_mss_diag ()
private subroutine uf_definir_codetat_mss_diag (ref string asval, long alcpt)
private function integer uf_integration_fichier_mss_diag (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function boolean uf_ctrl_general_bloquant (long aidsin, long aidseq, long alcpt, string asidfourctrl)
private subroutine uf_definir_codetat_sbetv (long alidsin, long alidseq, ref string asval, long alcpt)
private function integer uf_ctrl_fichier_auchan ()
private subroutine uf_definir_codetat_auchan (ref string asval, long alcpt)
private function integer uf_integration_fichier_auchan (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_carrefour ()
private subroutine uf_definir_codetat_carrefour (ref string asval, long alcpt)
private function integer uf_integration_fichier_carrefour (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_coriolis ()
private subroutine uf_definir_codetat_coriolis (ref string asval, long alcpt)
private function integer uf_integration_fichier_coriolis (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private subroutine uf_definir_codetat_o2m (ref string asval, long alcpt, long alidsin, long alidseq)
private function integer uf_ctrl_fichier_psm ()
private function integer uf_integration_fichier_psm (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_lbe ()
private function integer uf_integration_fichier_lbe (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private subroutine uf_definir_codetat_psm (ref string asval, long alcpt, long alidsin, long alidseq)
private function integer uf_ctrl_fichier_mtt ()
private subroutine uf_definir_codetat_mtt (ref string asval, long alcpt, long alidsin, long alidseq)
private function integer uf_integration_fichier_mtt (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_electrodepot ()
private subroutine uf_definir_codetat_electrodepot (ref string asval, long alcpt)
private function integer uf_integration_fichier_electrodepot (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_tamet ()
private subroutine uf_definir_codetat_tamet (ref string asval, long alcpt, long alidsin, long alidseq)
private function integer uf_integration_fichier_tamet (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_cdiscountpro_new ()
private function integer uf_integration_fichier_cdiscountpro_new (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_cdiscountpro_ano ()
private function integer uf_integration_fichier_cdiscountpro_ano (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_sbe_old ()
private subroutine uf_definir_codetat_sbe (ref string asval, long alcpt, long alidsin, long alidseq)
private function integer uf_integration_fichier_sbe (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
public function integer uf_mailpush (string ascas, long adcidsin, integer aiidseq, datetime adtdtercpfrn, datetime adtdteenvcli, string asdestcli, string asnumbontrsp, long alstatusgc, string aschaine, string ascommentfrn)
private function integer uf_ctrl_fichier_carma ()
private function integer uf_integration_fichier_carma (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_bak2 ()
private function integer uf_integration_fichier_bak2 (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private subroutine uf_definir_codetat_bak2 (ref string asval, long alcpt, long alidsin, long alidseq)
private function integer uf_ctrl_fichier_cordon ()
private subroutine uf_definir_codetat_cordon (ref string asval, long alcpt, long alidsin, long alidseq)
private function integer uf_integration_fichier_cordon (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
public function long uf_charger_fichierfournhalt (long alnumligerrimport, string ascolligerrimport, string asdata)
public subroutine uf_set_numligerrimport (long alnumligerrimport, string ascolligerrimport, string asdataerrimport)
private function integer uf_ctrl_date (string ascas, integer airet, long alcpt, long alidsin, long alidseq, string asidreffour, string aschainebcv, string asval, string asval1)
private subroutine uf_definir_codetat_phoneandphone (ref string asval, long alcpt, long alidsin, long alidseq)
public subroutine uf_definir_codetat_coriolis_pm426_1 (ref string asval, integer alcpt, long alidsin, long alidseq)
private function integer uf_ctrl_fichier_ceat ()
private subroutine uf_definir_codetat_ceat (ref string asval, long alcpt, long alidsin, long alidseq)
private function integer uf_integration_fichier_ceat (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_agora_place ()
private function integer uf_integration_fichier_agora_place (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
public subroutine uf_definir_codetat_agora_place (ref string asval, integer alcpt, long alidsin, long alidseq)
private function integer uf_ctrl_fichier_omt_ctrle_imei ()
private subroutine uf_definir_codetat_omt_ctrle_imei (ref string asval, long alcpt, long alidsin, long alidseq)
private function integer uf_integration_fichier_omt_ctrle_imei (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_orangegrandpublic ()
private function integer uf_ctrl_fichier_orangeopenpro ()
private function integer uf_integration_fichier_orangegrandpublic (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
public subroutine uf_definir_codetat_orangegrandpublic (ref string asval, integer alcpt, long alidsin, long alidseq)
public subroutine uf_definir_codetat_orangeopenpro (ref string asval, integer alcpt, long alidsin, long alidseq)
private function integer uf_integration_fichier_orangeopenpro (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_telstore ()
private function integer uf_integration_fichier_telstore (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_cardif ()
public subroutine uf_definir_codetat_cardif (ref string asval, integer alcpt, long alidsin, long alidseq)
private function integer uf_integration_fichier_cardif (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private function integer uf_ctrl_fichier_frn_hub ()
private function integer uf_integration_fichier_frn_hub (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee)
private subroutine uf_definir_codetat_frn_hub (ref string asval, long alcpt, long alidsin, long alidseq)
private function boolean uf_hub_gestiontranssqlhubpresta (string ascas)
private function string uf_hub_sql_hubprestataire (ref datastore adshubdonneesprestasimpa2)
end prototypes

public subroutine uf_preparer ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Preparer (PUBLIC)
//* Auteur			: Fabry JF
//* Date				: 30/08/2001
//* Libellé			: Preparer avant traitement
//* Commentaires	: 
//*
//* Arguments		: 
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//        JFF   21/03/2017   [PI065]
//* 
//*-----------------------------------------------------------------

DatawindowChild 	dwChild

isIdFour = "" // [PI065]
isIdTypMvt = "MPR" // [PI065]
ilIdLotLog = -1 // [PI065]
ibErrIntegr = False // [PI065]
isNomFicOrig = "" // [PI065]

/*------------------------------------------------------------------*/
/* Préparation dw fournisseur.                                      */
/*------------------------------------------------------------------*/
idwFourn.Reset ()
idwFourn.InsertRow ( 0 )
idwFourn.GetChild ( "ID_FOURN", dwChild )

If dwChild.Rowcount () = 1 Then 
	idwFourn.SetItem ( 1, "ID_FOURN", dwChild.GetItemString ( 1, "ID_CODE" ) )
	This.uf_Detection_Auto_NomFic ( dwChild.GetItemString ( 1, "ID_CODE" ) )
End If





end subroutine

public subroutine uf_bouton_chxfichier ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Bouton_ChxFichier (PUBLIC)
//* Auteur			: Fabry JF
//* Date				: 30/08/2001
//* Libellé			: Choix du fichier manuellement
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    30/08/2002  Le nom du répertoire de génération n'est plus le code
//*								  du fournisseur -FR mais le nom complet (<8 car) -FL
//*-----------------------------------------------------------------

String 	sNomComplet, sNomFic, sIdFourn, sRepFourn
String	sRepFicCmd, sNomFicCmd, sJoker
Int		iRetour
Long		lRow
			
idwFourn.AcceptText ()

sIdFourn = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) ) 

/*------------------------------------------------------------------*/
/* #1                                                               */
/*------------------------------------------------------------------*/
lRow = idwStkRepFourn.Find ( "ID_CODE = '" + sIdFourn + "'", 1, idwStkRepFourn.RowCount () )
If lRow > 0 Then
	sRepFourn = Upper ( idwStkRepFourn.GetItemString ( lRow, "LIB_CODE" ) )
End If

If sRepFourn = "" Then
	sRepFicCmd =  ProfileString ( stGlb.sFichierIni, "GEST_COMMANDES", "REP_GEN", "" ) 
Else
	sRepFicCmd =  ProfileString ( stGlb.sFichierIni, "GEST_COMMANDES", "REP_GEN", "" ) + &
					  sRepFourn  + &
					  ProfileString ( stGlb.sFichierIni, "GEST_COMMANDES", "REP_FIC_MOV", "" )
End If


sNomFicCmd = "M??" + &
			 String ( Day   ( Today () ), "00" ) + &
			 String ( Month ( Today () ), "00" ) + &
			 Right  ( String ( Year  ( Today () ) ), 1 )

sJoker = sNomFicCmd + ".*"
sNomComplet = Left ( sRepFicCmd, Len ( sRepFicCmd ) -1 )

iRetour = GetFileSaveName( "Fichier Articles/Stocks", sNomComplet, sNomFic, "", &
									"Du jour (" + sJoker + ")," + sJoker + "," + &
									"Non Traité (M*.0*),M*.0*," + &
									"Tous (M*.*),M*.*," + &
									"Tous Fichiers (*.*),*.*")

If iRetour = 0 Then 
	isTxtNomFic.Text = ""
ElseIf iRetour = 1 Then
	isTxtNomFic.Text = sNomComplet 
End If

end subroutine

public function string uf_detection_auto_nomfic (string aidfourn);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Detection_Auto_nomFic (PUBLIC) 
//* Auteur			: Fabry JF
//* Date				: 30/08/2001
//* Libellé			: Détection automatique du nom de fichier
//* Commentaires	: 
//*
//* Arguments		: aIdFourn		String		Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    30/08/2002  Le nom du répertoire de génération n'est plus le code
//*								  du fournisseur -FR mais le nom complet (<8 car) -FL
//* #2    JFF   05/09/08 	  [MICROMANIA]
//* #3    JFF   16/11/2009   [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
//*       JFF   30/06/2010   [PC363_AUCHAN]
//		FPI	18/10/2012	[PC884] LBE
//        JFF   02/03/2015   [PM289_CDP]
//        JFF   26/11/2018   [PC874_2_V1]
//        JFF   02/09/2019   [DT424]
//        JFF   07/03/2024   [HP252_276_HUB_PRESTA]
//        JFF   16/01/2025	  [HUB832_HUB_ORG_REUN] 
//        JFF   18/02/2025   [PMO268_MIG65]
//*-----------------------------------------------------------------

String	sRepFic, sNomFic, sFichier, sInd, sVar, sJoker, sItem, sRepFourn, sCas
Long		lInd, lCptCas, lTotLig, lCpt, lRow
Boolean  bFicTrouve

sCas = "" //* #2 [MICROMANIA]

/*------------------------------------------------------------------*/
/* #1                                                               */
/*------------------------------------------------------------------*/

// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	//	[HUB832_HUB_ORG_REUN] 
	If F_CLE_A_TRUE ( "HUB832_HUB_ORG_REUN" ) Then
		ibPrestaHub = SQLCA.PS_S_CODE_DANS_FAMILLE_CAR ( 1, aidfourn ) > 0 		
	Else
		ibPrestaHub = SQLCA.PS_S01_CODE_CAR ( isIdFour, '-WP') > 0 
	End If 
End If 


lRow = idwStkRepFourn.Find ( "ID_CODE = '" + aIdFourn + "'", 1, idwStkRepFourn.RowCount () )
If lRow > 0 Then
	sRepFourn = Upper ( idwStkRepFourn.GetItemString ( lRow, "LIB_CODE" ) )
Else
	Return ""
End If

sRepFic =  ProfileString ( stGlb.sFichierIni, "GEST_COMMANDES", "REP_GEN", "" ) + &
				  sRepFourn + &
				  ProfileString ( stGlb.sFichierIni, "GEST_COMMANDES", "REP_FIC_MOV", "" )

For lCptCas = 1 TO 13

// Ordre extrêmement important !
	CHOOSE CASE lCptCas
		CASE 1
			sVar = K_FIC1
			sNomFic = sVar + "*.0*"			
			sCas = ""
			
		CASE 2
			sVar = K_FIC2
			sNomFic = sVar + "*.0*"
			sCas = ""

		CASE 3  // [PC363_AUCHAN]
			/* [PMO268_MIG65]
			sVar = K_FIC6
			sNomFic = sVar + "*.0*"
			*/
		
			// [PMO268_MIG65]
			sVar = K_FIC13
			sNomFic = sVar + "*.TXT"
			sCas = "AUCHAN"			

		CASE 4  // Micromania //* #2 [MICROMANIA]
			sVar = K_FIC4
			sNomFic = sVar + "*.csv"
			sCas = "MICROMANIA"
			
		CASE 5  // C-Discount
			sVar = K_FIC3
			sNomFic = sVar + "*.0*"
			sCas = "CDISCOUNT" //* #2 [MICROMANIA]

		CASE 6  //* #3 [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
			sVar = K_FIC5
			sNomFic = sVar + "*.0*"
			sCas = "FNAC"			
			
		Case 7 // [PC884]
			sVar = K_FIC6
			sNomFic = sVar + "*.XML"
			sCas = "LBE"

		Case 8 // [PC13321]
			sVar = K_FIC7
			sNomFic = sVar + "*.csv"
			sCas = "ELECTRO_DEPOT"		

		Case 9 // [PM289_CDP]
			sVar = K_FIC8
			sNomFic = sVar + "*.TXT"
			sCas = "CDISCOUNT_PRO"		

		Case 10 // [PM289_CDP]
			sVar = K_FIC9
			sNomFic = sVar + "*.TXT"
			sCas = "CDISCOUNT_PRO_ANO"				

		Case 11 // [PC874_2_V1]
			sVar = K_FIC10
			sNomFic = sVar + "*.0*"
			sCas = "OMT_CTRLE_IMEI"				
			
		Case 12 // [DT424]
			sVar = K_FIC11
			sNomFic = sVar + "*.0*"
			sCas = "CTRLE_IMEI_OGP"				

		Case 13 // [DT424]
			sVar = K_FIC12
			sNomFic = sVar + "*.0*"
			sCas = "CTRLE_IMEI_OOP"				


			
	END CHOOSE

	sJoker = sRepFic + sNomFic
	ilbListeFic.DirList ( sJoker, 0 )
	
	lTotLig = ilbListeFic.TotalItems ()
	If lTotLig > 0 Then Exit
Next


idwTri.Reset ()

For lCpt = lTotLig To 1 Step -1
	ilbListeFic.SelectItem ( lCpt )
	sItem = ilbListeFic.SelectedItem ( )
	lRow = idwTri.InsertRow ( 0 )		

	Choose Case sCas  //* #2 [MICROMANIA]
		Case "CDISCOUNT" // C-Discount //* #2 [MICROMANIA]
			idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 3 ) ) )
			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 4, 1 ) ) 
			idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 5, 2 ) ) 
			idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 7, 2 ) ) 
			idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 

		Case "MICROMANIA"
			idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 5 ) ) )
			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 6, 4 ) ) 
			idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 10, 2 ) ) 
			idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 12, 2 ) ) 
			idwTri.SetItem ( lRow, "EXTENTION",   Mid  ( sItem, 14, 10 ) ) 

		Case "AUCHAN" // [PC363_AUCHAN]
			/* // [PMO268_MIG65]
			idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 9 ) ) )
			idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 10, 2 ) ) 
			idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 12, 2 ) ) 
			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 14, 1 ) ) 
			idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 
			*/
			idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 26 ) ) )
			idwTri.SetItem ( lRow, "JOUR",     "" ) 
			idwTri.SetItem ( lRow, "MOIS",     "" ) 
			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 27, 14 ) ) 
			idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 
			

		Case "FNAC" 
			idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 6 ) ) )
			idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 7, 2 ) ) 
			idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 9, 2 ) ) 
			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 11, 1 ) ) 
			idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 

		Case "LBE" 
			idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 9 ) ) )
			idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 10, 2 ) ) 
			idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 12, 2 ) ) 
//			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 14, 4 ) ) 
			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 14, Len(sItem) - 14 - 3  ))
			idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 

		// [PC13321]
		Case "ELECTRO_DEPOT"
			idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 17 ) ) )
			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 18, 4 ) ) 
			idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 22, 2 ) ) 
			idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 24, 9 ) ) 
			idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 

		// [PM289_CDP]
		Case "CDISCOUNT_PRO", "CDISCOUNT_PRO_ANO"	
			idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 15 ) ) )
			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 16, 4 ) ) 
			idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 20, 2 ) ) 
			idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 22, 9 ) ) 
			idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 

		// [PC874_2_V1] [DT424]
		Case "OMT_CTRLE_IMEI", "CTRLE_IMEI_OGP", "CTRLE_IMEI_OOP"
			idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 19 ) ) )
			idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 20, 4 ) ) 
			idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 24, 2 ) ) 
			idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 26, 2 ) ) 
			idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 

		Case Else
			
			// [HP252_276_HUB_PRESTA] 
			// Fournisseur lié au Hub Prestataire
			If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	
				// Par défaut, si le fournisseur est lié au HP, on affecte le DO HUB par défaut
				If ibPrestaHub Then
					idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 3 ) ) )
					idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 4, 2 ) ) 
					idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 6, 2 ) ) 
					idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 8, 4 ) ) 
					idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 
				Else
					idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 3 ) ) )
					idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 4, 2 ) ) 
					idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 6, 2 ) ) 
					idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 8, 1 ) ) 
					idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 
				End If 
				
			Else 
				idwTri.SetItem ( lRow, "TYPE_FIC", Upper ( Left ( sItem, 3 ) ) )
				idwTri.SetItem ( lRow, "JOUR",     Mid  ( sItem, 4, 2 ) ) 
				idwTri.SetItem ( lRow, "MOIS",     Mid  ( sItem, 6, 2 ) ) 
				idwTri.SetItem ( lRow, "ANNEE",    Mid  ( sItem, 8, 1 ) ) 
				idwTri.SetItem ( lRow, "EXTENTION",   Right  ( sItem, 4 ) ) 
			End IF 
			
			
			
		End Choose
		
	ilbListeFic.DeleteItem ( lCpt )

Next

idwTri.Sort ()


If idwTri.Rowcount () > 0 Then 

	// [PC874_2_V1] [DT424]
	Choose Case sCas  //* #2 [MICROMANIA]
		Case "CDISCOUNT", &
			  "MICROMANIA", &
			  "ELECTRO_DEPOT", &
			  "CDISCOUNT_PRO", &
			  "CDISCOUNT_PRO_ANO", &
			  "OMT_CTRLE_IMEI", &
			  "CTRLE_IMEI_OGP", &
			  "CTRLE_IMEI_OOP"
			  
			sFichier = idwTri.GetItemString ( 1, "TYPE_FIC" ) + &
						  idwTri.GetItemString ( 1, "ANNEE" )	  + &
						  idwTri.GetItemString ( 1, "MOIS" )	  + &
						  idwTri.GetItemString ( 1, "JOUR" )	  + &
						  idwTri.GetItemString ( 1, "EXTENTION" )
						  
		Case "AUCHAN"  // [PMO268_MIG65]

			sFichier = idwTri.GetItemString ( 1, "TYPE_FIC" ) + &
						  idwTri.GetItemString ( 1, "ANNEE" )	  + &
						  idwTri.GetItemString ( 1, "EXTENTION" )

		Case Else
			sFichier = idwTri.GetItemString ( 1, "TYPE_FIC" ) + &
						  idwTri.GetItemString ( 1, "JOUR" )	  + &
						  idwTri.GetItemString ( 1, "MOIS" )	  + &
						  idwTri.GetItemString ( 1, "ANNEE" )	  + &
						  idwTri.GetItemString ( 1, "EXTENTION" )
		End Choose


	sFichier = sRepFic + sFichier

Else
	sFichier = ""
End If

isTxtNomFic.Text = sFichier

Return sFichier

end function

public function integer uf_controler_saisie ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Controler_Saisie (PUBLIC)
//* Auteur			: Fabry JF
//* Date				: 30/08/2001
//* Libellé			: Controler de la saisie
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 		FPI	04/01/2010	[20110104.FPI] Amélioration contrôle du chemin du fichier (mis en Upper)
//			FPI	18/10/2012	[PC884] Fichier XML pour LBE
//*-----------------------------------------------------------------

Int iRet
String	sIdFourn, sNomFic, sRepFicCmd, sVal, sRepFourn
Long		lRow

iRet = 1

/*------------------------------------------------------------------*/
/* 1 : Le fournisseur est-il renseigné ?                            */
/*------------------------------------------------------------------*/
sIdfourn = idwFourn.GetItemString ( 1, "ID_FOURN" ) 
If IsNull ( sIdFourn ) Then 
	stMessage.sTitre = "Controle de saisie"
	stMessage.sCode = "COMD002"
	stMessage.icon = Information!
	This.uf_Sortie_OpCon ( "ECR", 300, "ERR300/CTRLSAI/1", TRUE )
	iRet = -1
End If

/*------------------------------------------------------------------*/
/* 2 : Le Nom du fichier est-il renseigné ?                         */
/*------------------------------------------------------------------*/
If iRet > 0 Then 
	sNomFic = isTxtNomFic.Text
	If IsNull ( sNomFic ) Or sNomFic = "" Then 
		stMessage.sTitre = "Controle de saisie"
		stMessage.sCode = "COMD003"
		stMessage.icon = Information!
		This.uf_Sortie_OpCon ( "ECR", 310, "ERR310/CTRLSAI/1", TRUE )
		iRet = -1
	End If
End If

/*------------------------------------------------------------------*/
/* 3 : Le Nom du fichier est-il correct par rapport au fournisseur  */
/*------------------------------------------------------------------*/
If iRet > 0 Then 

	/*------------------------------------------------------------------*/
	/* #1                                                               */
	/*------------------------------------------------------------------*/
	lRow = idwStkRepFourn.Find ( "ID_CODE = '" + sIdFourn + "'", 1, idwStkRepFourn.RowCount () )
	If lRow > 0 Then
		sRepFourn = Upper ( idwStkRepFourn.GetItemString ( lRow, "LIB_CODE" ) )

		sRepFicCmd =  ProfileString ( stGlb.sFichierIni, "GEST_COMMANDES", "REP_GEN", "" ) + &
						  sRepFourn + &
						  ProfileString ( stGlb.sFichierIni, "GEST_COMMANDES", "REP_FIC_MOV", "" )	

		If Pos ( Upper(sNomFic), Upper(sRepFicCmd), 1 ) <= 0 Then // [20110104.FPI]
			stMessage.sTitre = "Controle de saisie"
			stMessage.sCode = "COMD004"
			stMessage.icon = Information!
			This.uf_Sortie_OpCon ( "ECR", 320, "ERR320/CTRLSAI/1", TRUE )
			iRet = -1
		End If
	End If

End If

/*------------------------------------------------------------------*/
/* 4 : Le Nom du fichier n'est pas à la date du jour.					  */
/*------------------------------------------------------------------*/
/* Le 20/11/2001, JFF : Pour l'instant, je shunt ce contrôle sans   */
/* supprimer le code, en effet cette box "trouble" l'équipe ADD.    */
/*------------------------------------------------------------------*/
//If iRet > 0 Then 
//
//	// sur ...\MCD31081.009 on obtient 31081
//	sVal = Right ( Left ( Right ( sNomFic, 12 ), 8 ), 5 )
//	sVal = Left ( sVal, 2) + "/" + Mid ( sVal, 3, 2) + "/200" + Right ( sVal, 1 )
//
//	If Date ( sVal ) <> Today () Then
//		stMessage.sTitre = "Controle de saisie"
//		stMessage.sCode = "COMD007"
//		stMessage.icon = Exclamation!
//		stMessage.bouton = YesNo!
//		If F_Message ( stMessage ) = 2 Then iRet = -1
//	End If
//
//End If

/*------------------------------------------------------------------*/
/* 5 : Le Fichier a déjà été traité.										  */
/*------------------------------------------------------------------*/
If iRet > 0 Then 

	// [PC884] Ajout de la condition sur LBE
	If Upper ( Mid ( isTxtNomFic.Text, Len ( isTxtNomFic.Text ) - 2, 1 ) ) = "X" and sIdFourn <> "LBE" Then iRet = -1

	If sIdFourn="LBE" and Upper ( Mid ( isTxtNomFic.Text, Len ( isTxtNomFic.Text ) - 2, 4 ) ) <> "XML" Then iRet=-1

	If iRet=-1 Then
		stMessage.sTitre = "Controle de saisie"
		stMessage.sCode = "COMD010"
		stMessage.icon = Exclamation!
		stMessage.bouton = Ok!
		This.uf_Sortie_OpCon ( "ECR", 330, "ERR330/CTRLSAI/1", TRUE )
	End if

End If



return iRet
end function

public function integer uf_lancer_trt ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Lancer_Trt (PUBLIC)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Lancement du Traitement
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     		Modification
//* #1 	DGA       19/09/2006    Gestion d'un répertoire temporaire DCMP-060643
//*      JFF       21/03/2017    [PI065]
//*      JFF   	 07/03/2024   	[HP252_276_HUB_PRESTA]
//*      JFF		 16/01/2025		[HUB832_HUB_ORG_REUN] 
//*-----------------------------------------------------------------

Int		iRet
String	sNomFic, sIdFourn
Long		lTotLig

iRet = 1
sIdFourn = idwFourn.GetItemString ( 1, "ID_FOURN" )
isIdFour = sIdFourn // [PI065]

ibPrestaHub = FALSE
// [HP252_276_HUB_PRESTA]
If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
	//	[HUB832_HUB_ORG_REUN] 
	If F_CLE_A_TRUE ( "HUB832_HUB_ORG_REUN" ) Then
		ibPrestaHub = SQLCA.PS_S_CODE_DANS_FAMILLE_CAR ( 1, isIdFour ) > 0 		
	Else
		ibPrestaHub = SQLCA.PS_S01_CODE_CAR ( isIdFour, '-WP') > 0 
	End If 
End If 

/*------------------------------------------------------------------*/
/* Initialisation de la trace.                                      */
/*------------------------------------------------------------------*/
If uf_Trace ( "INIT", "") <= 0 Then iRet = -1

// [PI065]
This.uf_Trace ( "ECR", "Numéro de lot d'intégration : " + String ( ilIdLotLog ) )

/*------------------------------------------------------------------*/
/* Chargement du fichier fournisseur.                               */
/*------------------------------------------------------------------*/
If iRet > 0 Then
	If uf_Charger_FichierFourn () <= 0 Then 
		iRet = -1
		This.uf_Sortie_OpCon ( "ECR", 340, "ERR340/CHARGFICFOUR", FALSE )						
	End If
End If

/*------------------------------------------------------------------*/
/* Contrôle de la validité du fichier fournisseur.                  */
/*------------------------------------------------------------------*/
If iRet > 0 Then
	If uf_Ctrl_Fichier_Fournisseur () <= 0 Then iRet = -1
End If


/*------------------------------------------------------------------*/
/* Intégration du fichier fournisseur dans la base.                 */
/*------------------------------------------------------------------*/
If iRet > 0 Then
	If uf_Integration_Fichier_Fournisseur () <= 0 Then iRet = -1
End If

If iRet <= 0 Then 
	This.uf_Trace ( "ECR", "Le traitement se termine anormalement, le fichier n'a pas été traité !!!." )
Else
	This.uf_Trace ( "ECR", "Le traitement se termine normalement, le fichier a été traité." )
End If

idwSuiviTrt.ScrollToRow ( idwSuiviTrt.RowCount () )

/*------------------------------------------------------------------*/
/* On détruit le fichier temporaire.                                */
/*------------------------------------------------------------------*/

//Migration PB8-WYNIWYG-03/2006 CP
//If FileExists ( stGlb.sWinDir + K_FICTMP ) Then FileDelete ( stGlb.sWinDir + K_FICTMP )
/*------------------------------------------------------------------*/  
/* #1. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//If f_FileExists ( stGlb.sWinDir + K_FICTMP ) Then FileDelete ( stGlb.sWinDir + K_FICTMP )
If f_FileExists ( stGlb.sRepTempo + K_FICTMP ) Then FileDelete ( stGLB.sRepTempo + K_FICTMP )
//Fin Migration PB8-WYNIWYG-03/2006 CP

/*------------------------------------------------------------------*/
/* Enfin on regarde si un autre fichier est à traiter.              */
/*------------------------------------------------------------------*/
This.uf_Detection_Auto_NomFic ( sIdFourn )

Return iRet
end function

private function long uf_charger_fichierfourn ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Charger_FichierFourn (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Chargement du fichier fournisseur
//* Commentaires	: 18/09/2007 [ALAPAGE]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//* #1	 CAG	 20/09/2004	  DCMP 040381 : Ajout du frn MSS
//* #2	 CAG	 23/09/2004	  DCMP 040403 : Ajout des colonnes dte_emis_devis et mt_devis pour SBE
//* #3	 MADM	 06/02/2006	  [DCMP060119]: Ajout du frn AEVUM/AVM
//* #4	 MADM	 09/05/2006	  [DCMP060356]: Rempl du frn AEVUM/AVM par CORDON/COR
//* #5 	 DGA   19/09/2006   Gestion d'un répertoire temporaire DCMP-060643
//* #6	 JFF   18/09/2007   [ALAPAGE]
//* #7	 PHG	 29/11/2007	  [O2M]
//* #8    JFF   09/09/2008   [MICROMANIA]
//* #9    JFF   16/04/2009   [DCMP090102]
//* #10   JFF   16/04/2009   [DCMP090140]
//* #11   JFF   02/09/2009   [DCMP090327].[SBETV]
//* #12   JFF   16/11/2009   [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
//* #13   JFF   25/11/2009   [MSS_DIAG]
//*       JFF   30/06/2010   [PC363_AUCHAN]
//* 		 JFF   04/11/2010   [PC301].[LOT2]
//* 		 JFF     03/05/2011 [PM178][CORIOLIS]
// 		 JFF   13/02/2012   [PM200][PSM]
//		    FPI	18/10/2012	[PC884] LBE
//       JFF   30/12/2013 [PC13348&13408]
//       JFF   18/08/2014 [PM254_V1]
//       JFF   12/12/2014 [PC13321]
//       JFF   02/01/2015 [PC801_6_TAMET]
//       JFF   02/03/2015 [PM289_CDP]
//       JFF   11/10/2016 [DT076-2]
//       JFF   21/03/2017 [PI065]
//       JFF   05/12/2017 [PM426-1]
//       JFF   03/09/2018 [DT361]
//       JFF   17/09/2018 [PM444-1]
//       JFF   26/11/2018 [PC874_2_V1]
//       JFF   02/09/2019 [DT424]
//       JFF   19/12/2022 [RS4093_EVOL_ELD]
//       JFF   30/05/2023 [PMO89_RS4822]
//       JFF   07/03/2024 [HP252_276_HUB_PRESTA]
//       JFF   18/02/2025 [PMO268_MIG65]
//*-----------------------------------------------------------------

Int		iRet
String	sIdFourn, sNomFicOrig, sNomFicTmp
Long		lTotLig
Blob		blBlob

iRet = 1

sIdFourn = idwFourn.GetItemString ( 1, "ID_FOURN" )
sNomFicOrig = isTxtNomFic.Text
isNomFicOrig = sNomFicOrig // [PM254_V1][PI065]
idwFicFourn.Reset ()
idwFicFourn.DataObject = ""

This.uf_Trace ( "ECR", "Révision SVN : " + stGLB.sRevisionSvn )

This.uf_Trace ( "ECR", "Fournisseur sélectionné : (" + sIdFourn + ") " + &
								Upper ( idwFourn.Describe ( "Evaluate ( 'LookUpDisplay ( ID_FOURN )', 1 )" ) ) )
This.uf_Trace ( "ECR", "Fichier sélectionné : " + Upper ( sNomFicOrig ) )

/*------------------------------------------------------------------*/
/* Recopie du fichier original en un fichier temporaire en local    */
/* dont l'ext. est "TXT".                                           */
/*------------------------------------------------------------------*/
F_LireFichierBlob ( blBlob, sNomFicOrig ) 
/*------------------------------------------------------------------*/  
/* #5. DCMP-060643                                                  */
/* Le 19/09/2006. Gestion d'un répertoire temporaire parametrable.  */
/*------------------------------------------------------------------*/
//sNomFicTmp = stGlb.sWinDir + K_FICTMP
sNomFicTmp = stGLB.sRepTempo + K_FICTMP
F_EcrireFichierBlob ( blBlob, sNomFicTmp ) 

/*------------------------------------------------------------------*/
/* Choix du dataobject (format du fichier), en fonction du          */
/* fournisseur, en effet le fichier peut être différent d'un        */
/* fournisseur à l'autre.                                           */
/*------------------------------------------------------------------*/
CHOOSE CASE Upper ( sIdFourn )
	
	/*------------------------------------------------------------------*/
	/* Fournisseur : ORANGE/DME.                                     	  */
	/*------------------------------------------------------------------*/
	CASE "DME"
		idwFicFourn.DataObject = "d_trt_int_fic_SuiviCmd_DME"

	/*------------------------------------------------------------------*/
	/* Fournisseur : SBE.                                 	  			  */
	/*------------------------------------------------------------------*/
	CASE "SBE"
		/*------------------------------------------------------------------*/
		/* #2 CAG 23/09/2004 : DCMP 040403 : ajout de 2 colonnes            */
		/* (dte_emis_devis et mt_devis dans la dw )                         */
		/*------------------------------------------------------------------*/
	
		idwFicFourn.DataObject = "d_trt_int_fic_SuiviCmd_SBE"						
	

	/*------------------------------------------------------------------*/
	/* #1 CAG : 20/09/2004                                              */
	/*------------------------------------------------------------------*/
	/* Fournisseur : MSS.                                 	  			  */
	/*------------------------------------------------------------------*/
	CASE "MSS"
		idwFicFourn.DataObject = "d_trt_int_fic_SuiviCmd_MSS"

	/*------------------------------------------------------------------*/
	/* Fournisseur : CEGETEL/CEG.				                        	  */
	/*------------------------------------------------------------------*/
	CASE "CEG"
		idwFicFourn.DataObject = "d_trt_int_fic_SuiviCmd_CEGETEL"

	/*------------------------------------------------------------------*/
	/* Fournisseur : C-DISCOUNT/CDS												  */
	/*------------------------------------------------------------------*/
	CASE "CDS"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_cdiscount"

	/*------------------------------------------------------------------*/
	/* Fournisseur : AEVUM/AVM												        */
	/* #4	 MADM	 09/05/2006	[DCMP060356]: Rempl du frn AEVUM/AVM par CORDON/COR*/
	/*------------------------------------------------------------------*/
	
	CASE "COR" //#4
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_CORDON"	

	CASE "O2M" //#7 [O2M] Ajout fichier Entrant O2M
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_O2M"

	//* #8 [MICROMANIA]
	CASE "MCM"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_MICROMANIA"
		If This.uf_TransformationSeparateur ( sNomFicTmp, ";", "~t", "" ) < 0 Then
			This.uf_Trace ( "ECR", "ERREUR : Erreur lors de la substition du séparateur" )
			Return -1
		End If

	//* #9 [DCMP090102]
	CASE "CDP"
		// [PM289_CDP]
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_CDISCOUNTPRO"

	//* #9 [DCMP090102]
	CASE "CDA"
		// [PM289_CDP]
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_CDISCOUNTPRO_ano"


	//* #10 [DCMP090140]
	CASE "PAP" 
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_PHONEANDPHONE"

	//* #11   JFF   02/09/2009   [DCMP090327].[SBETV]
	CASE "SB1" 
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_SBETV"

	// #12 [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
	CASE "FNC"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_FNAC"
		If This.uf_TransformationSeparateur ( sNomFicTmp, ";", "~t", "FNAC_BGE" ) < 0 Then
			This.uf_Trace ( "ECR", "ERREUR : Erreur lors de la substition du séparateur" )
			Return -1
		End If		

	//* #13   JFF   25/11/2009   [MSS_DIAG]		
	CASE "MS1" 
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_mss_diag"

// [PC363_AUCHAN]
	CASE "AUC" 
		// [PMO268_MIG65]
		// idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_auchan"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_auchan_2"

	// [PC301].[LOT2]
	CASE "CAR"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_carrefour"

	//[PM178][CORIOLIS]		
	CASE "CIS"
		// [PM426-1]
		If F_CLE_A_TRUE ( "PM426-1" ) Then
			idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_coriolis_PM426_1"
		Else
			idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_coriolis"
		End If			
		

	// [PM200][PSM]
	CASE "PSM"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_psm"
		
	// [PC884]
	CASE "LBE"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_edel"

	// [PC13348&13408]
	CASE "MTT"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_mtt"
	
	// [PC13321]
	CASE "ELD"

		// [RS4093_EVOL_ELD]
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_ELECTRODEPOT_rs4093"
		
		If This.uf_TransformationSeparateur ( sNomFicTmp, ";", "~t", "" ) < 0 Then
			This.uf_Trace ( "ECR", "ERREUR : Erreur lors de la substition du séparateur" )
			Return -1
		End If
	
	// [PC801_6_TAMET]	
	CASE "TMT"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_tamet"
	
	// [DT111]
	CASE "CMA"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_carma"

	// [DT076-2]
	CASE "BK2"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_bak2"
	
	// [DT361]
	CASE "CEA"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_ceat"

	// [PM444-1]
	CASE "AGP"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_agora_place"

	// [PC874_2_V1]
	CASE "OMT"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_omt_ctrle_imei"
		
	// [DT424]
	CASE "OGP"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_orangegrandpublic"
		
	// [DT424]
	CASE "OOP"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_orangeopenpro"

	// [RS3200]
	CASE "TLS"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_telstore"
		
	// [PMO89_RS4822]
	CASE "CDF"
		idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_cardif"

	CASE Else

		// [HP252_276_HUB_PRESTA] 
		// Fournisseur lié au Hub Prestataire
		If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then

			// Par défaut, si le fournisseur est lié au HP, on affecte le DO HUB par défaut
			If ibPrestaHub Then
				idwFicFourn.DataObject = "d_trt_int_fic_suivicmd_hub_prestataire"	
			Else
				This.uf_Trace ( "ECR", "ERREUR : Ce fournisseur n'est pas déclaré dans le programme, il faut modifier le code pour ajouter son traitement" )
				Return -1
			End If 
			
		Else 
			This.uf_Trace ( "ECR", "ERREUR : Ce fournisseur n'est pas déclaré dans le programme, il faut modifier le code pour ajouter son traitement" )
			Return -1
		End IF 


END CHOOSE

/*------------------------------------------------------------------*/
/* Chargement du fichier.                                           */
/*------------------------------------------------------------------*/
If FileLength ( sNomFicTmp ) > 0 Then
	
	If sIdFourn="LBE" Then // [PC884]
		lTotLig = idwFicFourn.ImportFile ( XML!,sNomFicTmp )
	Else
		lTotLig = idwFicFourn.ImportFile ( sNomFicTmp )
	End if
	
	If lTotLig <= 0 Then
		iRet = -1
		ibErrIntegr = True // [PI065]
		This.uf_Trace ( "ECR", "Chargement du fichier : ERREUR IMPORTFILE (" + String ( lTotLig ) + ") ligne " + string (ilNumLigErrImport) + ", colonne " + Upper ( isColLigErrImport ) + ", problème de format de fichier, une donnée n'est pas du bon type ou est trop longue."  ) // [PI065]
		This.uf_Trace ( "ECR", "Chargement du fichier : Text posant problème : " + Trim ( isDataErrImport )  ) // [PI065]
	Else
		This.uf_Trace ( "ECR", "Chargement du fichier : " + String ( lTotLig ) + " ligne(s)"  )
	End If
Else
		This.uf_Trace ( "ECR", "Chargement du fichier : " + String ( lTotLig ) + " ligne(s)"  )
End If

Return iRet
end function

private function integer uf_trace (string ascas, string astexte);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Trace (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 30/08/2001
//* Libellé			: Trace des opérations
//* Commentaires	: 
//*
//* Arguments		: asCas			String		Val
//*					  asTexte		String		Val
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*      JFF   21/03/2017 [PI065]
//*-----------------------------------------------------------------

Int	iRet
String sRepFicGen, sMes, sSql
Long	lRow

sRepFicGen =  ProfileString ( stGlb.sFichierIni, "GEST_COMMANDES", "REP_GEN", "" ) + K_FICLOG
iRet = 1

CHOOSE CASE Upper ( asCas )

	CASE "INIT"
		iiFicTrc = FileOpen ( sRepFicGen, LineMode!, Write!, Shared!, Append! )

		If iiFicTrc <= 0 Then 
			iRet = -1
			stMessage.sTitre = "Fichier Trace"
			stMessage.sCode = "COMD005"
			stMessage.icon = StopSign!
			This.uf_Sortie_OpCon ( "ECR", 350, "ERR350/TRACE/INIT", TRUE )
		Else
			sMes = Fill( "*", 80 )
			FileWrite ( iiFicTrc, sMes )
			FileClose ( iiFicTrc )
			
			// [PI065]
			ilIdLotLog = -1
			SQLCA.PS_X_Incrementer( "ID_LOT_LOG", ilIdLotLog) 
	
			If SQLCA.SQLCODE <> 0 Or SQLCA.SQLDBCODE <> 0 Or IsNull ( ilIdLotLog ) Or ilIdLotLog <= 0 Then 
			
				f_Commit ( SQLCA, FALSE )
		
				stMessage.sTitre = "Fichier Trace en base"
				stMessage.sCode = "COMD964"
				stMessage.icon = StopSign!
	
				This.uf_Sortie_OpCon ( "ECR", 351, "ERR351/TRACE/INIT", TRUE )

			ELSE
				F_COMMIT ( SQLCA, TRUE  ) // Commit du numéro de lot
				
				sSql  = "Exec sysadm.PS_I_TRACE_LOG_MPR "
				sSql += "'" + isIdFour + "'," 
				sSql += string ( ilIdLotLog ) + ","
				sSql += "'" + isIdTypMvt + "',"
				sSql += "'" + Fill( "*", 80 ) + "',"
				sSql += "'" + stGlb.sCodOper + "'"		
				
				If F_Execute ( sSql, SQLCA ) Then 
					If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
						F_commit ( SQLCA, True ) 
					Else 
						iRet = -1
						F_commit ( SQLCA, False ) 
						This.uf_Trace ( "ECR", "ERREUR Trace1/Base : Problème d'Insert sur la table de trace sysadm.trace_log_mpr" ) 
					End If
				Else
					iRet = -1
					F_commit ( SQLCA, False ) 
					This.uf_Trace ( "ECR", "ERREUR Trace1/Base : Problème d'Insert sur la table de trace sysadm.trace_log_mpr" ) 
				End If					
				
			End If				
			
		End If				

	CASE "ECR"

			iiFicTrc = FileOpen ( sRepFicGen, LineMode!, Write!, Shared!, Append! )

			sMes = String ( Today() ) + "~t" + String ( Now () ) + "~t" + Upper ( stGlb.sCodOper ) + "~t" + asTexte
			FileWrite ( iiFicTrc, sMes )
			lRow = idwSuiviTrt.InsertRow ( 0 )
			idwSuiviTrt.SetItem ( lRow,  "TEXTE", String ( Today() ) + " " + String ( Now () ) + "   " + asTexte )

			FileClose ( iiFicTrc )
			
			// [PI065]
			asTexte = F_Remplace ( asTexte, "'", "''" )
			
			sSql  = "Exec sysadm.PS_I_TRACE_LOG_MPR "
			sSql += "'" + isIdFour + "'," 
			sSql += string ( ilIdLotLog ) + ","
			sSql += "'" + isIdTypMvt + "',"
			sSql += "'" + asTexte + "',"
			sSql += "'" + stGlb.sCodOper + "'"		
			
			If F_Execute ( sSql, SQLCA ) Then 
				If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
					F_commit ( SQLCA, True ) 
				Else 
					iRet = -1
					F_commit ( SQLCA, False ) 
					This.uf_Trace ( "ECR", "ERREUR Trace2/Base : Problème d'Insert sur la table de trace sysadm.trace_log_mpr" ) 
				End If
			Else
				iRet = -1
				F_commit ( SQLCA, False ) 
				This.uf_Trace ( "ECR", "ERREUR Trace2/Base : Problème d'Insert sur la table de trace sysadm.trace_log_mpr" ) 
			End If					

END CHOOSE



Return iRet
end function

private function integer uf_ctrl_fichier_fournisseur ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Crtl_Fichier_Fournisseur (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 30/08/2001
//* Libellé			: Controler de la validité du fichier fournisseur
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//* #1	 CAG	 20/09/2004	  DCMP 040381 : Ajout du frn MSS
//* #2	 MADM	 09/05/2006	  DCMP 060356 : Ajout du frn CORDON/COR
//* #3	 JFF   18/09/2007   [ALAPAGE]
//* #4	 PHG	 29/11/2007	  [PHG]
//* #5    JFF   05/09/2008	  [MICROMANIA]
//* #6    JFF   16/04/2009   [DCMP090102]
//* #7    JFF   16/04/2009   [DCMP090140]
//* #8    JFF   02/09/2009   [DCMP090327].[SBETV]
//* #9    JFF   16/11/2009   [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
//* #10   JFF   25/11/2009   [MSS_DIAG]
//*       JFF   30/06/2010   [PC363_AUCHAN]
//* 		 JFF   04/11/2010   [PC301].[LOT2]
//* 		 JFF	 03/05/2011   [PM178][CORIOLIS]
// 		 JFF   13/02/2012   [PM200][PSM]
//		FPI	18/10/2012	[PC884] LBE
//       JFF   30/12/2013 [PC13348&13408]
//       JFF   12/12/2014 [PC13321]
//       JFF   02/01/2015 [PC801_6_TAMET]
//		FPI	11/05/2016	[DT111]
//       JFF   11/10/2016 [DT076-2]
//       JFF   17/09/2018 [PM444-1]
//       JFF   26/11/2018 [PC874_2_V1]
//       JFF   02/09/2019 [DT424]
//       JFF   30/05/2023 [PMO89_RS4822]
//       JFF   07/03/2024  [HP252_276_HUB_PRESTA]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFourn

iRet = 1

sIdFourn = idwFourn.GetItemString ( 1, "ID_FOURN" )

CHOOSE CASE Upper ( sIdFourn )

	/*------------------------------------------------------------------*/
	/* Fournisseur : ORANGE/DME                                         */
	/*------------------------------------------------------------------*/
	CASE "DME"
		iRet = This.uf_Ctrl_Fichier_DME ()

	/*------------------------------------------------------------------*/
	/* Fournisseur : SBE				                                      */
	/*------------------------------------------------------------------*/
	CASE "SBE"
		iRet = This.uf_Ctrl_Fichier_SBE ()

	/*------------------------------------------------------------------*/
	/* #1 CAG : 20/09/2004                                              */
	/*------------------------------------------------------------------*/
	/* Fournisseur : MSS				                                      */
	/*------------------------------------------------------------------*/
	CASE "MSS"
		iRet = This.uf_Ctrl_Fichier_MSS ()

	/*------------------------------------------------------------------*/
	/* Fournisseur : CEGETEL/CEG													  */
	/*------------------------------------------------------------------*/
	CASE "CEG"
		iRet = This.uf_Ctrl_Fichier_CEGETEL ()

	/*------------------------------------------------------------------*/
	/* Fournisseur : C-DISCOUNT/CDS												  */
	/*------------------------------------------------------------------*/
	CASE "CDS"
		iRet = This.uf_Ctrl_Fichier_CDISCOUNT ()

	/*------------------------------------------------------------------*/
	/* #2 Fournisseur : CORDON/COR  												  */
	/*------------------------------------------------------------------*/
	CASE "COR"
		iRet = This.uf_Ctrl_Fichier_CORDON ()	

	// #4 [O2M] Controle du Fichier O2M
	CASE "O2M"
		iRet = This.uf_Ctrl_Fichier_O2M ()
		
	// #5 [MICROMANIA] Controle du Fichier O2M
	CASE "MCM"
		iRet = This.uf_Ctrl_Fichier_Micromania ()

//* #6 [DCMP090102]
	CASE "CDP"
		// [PM289_CDP]
		iRet = This.uf_Ctrl_Fichier_CDiscountPRO_New ()			

	CASE "CDA"
		// [PM289_CDP]
		iRet = This.uf_Ctrl_Fichier_CDiscountPRO_ano ()			

//* #7 [DCMP090140]
	CASE "PAP"
		iRet = This.uf_Ctrl_Fichier_PhoneAndPhone ()

//* #8 [DCMP090327].[SBETV]
	CASE "SB1"
		iRet = This.uf_Ctrl_Fichier_SBETV ()

//* #12 [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
	CASE "FNC"
		iRet = This.uf_Ctrl_Fichier_FNAC ()

//* #10 [MSS_DIAG]
	CASE "MS1"
		iRet = This.uf_Ctrl_Fichier_MSS_DIAG ()

// [PC363_AUCHAN]
	CASE "AUC"
		iRet = This.uf_Ctrl_Fichier_Auchan ()

// [PC301].[LOT2]
	CASE "CAR"
		iRet = This.uf_Ctrl_Fichier_Carrefour ()

// [PC301].[LOT2]
	CASE "CIS"
		iRet = This.uf_Ctrl_Fichier_Coriolis ()

// [PM200][PSM]
	CASE "PSM"
		iRet = This.uf_Ctrl_Fichier_PSM ()

// [PC884]
	CASE "LBE"
		iRet = This.uf_Ctrl_Fichier_LBE ()

// [PC13348&13408]
	CASE "MTT"
		iRet = This.uf_Ctrl_Fichier_MTT ()

// [PC13321]
	CASE "ELD"
		iRet = This.uf_Ctrl_Fichier_ElectroDepot ()

// [PC801_6_TAMET]
	CASE "TMT"
		iRet = This.uf_Ctrl_Fichier_Tamet ()

// [DT111]
	CASE "CMA"
		iRet = This.uf_Ctrl_Fichier_Carma ( )

// [DT076-2]
	CASE "BK2"
		iRet = This.uf_Ctrl_Fichier_Bak2 ( )

// [DT361]
	CASE "CEA"
		iRet = This.uf_Ctrl_Fichier_Ceat ( )
		
// [PM444-1]
	CASE "AGP"
		iRet = This.uf_Ctrl_Fichier_AGORA_PLACE ( )

// [PC874_2_V1]
	CASE "OMT"
		iRet = This.uf_Ctrl_Fichier_OMT_CTRLE_IMEI ( )

// [DT424]
	CASE "OGP"
		iRet = This.uf_Ctrl_Fichier_OrangeGrandPublic ( )

// [DT424]
	CASE "OOP"
		iRet = This.uf_Ctrl_Fichier_OrangeOpenPro ( )

// [RS32000]
	CASE "TLS"
		iRet = This.uf_Ctrl_Fichier_TELSTORE ()

// [PMO89_RS4822]
	CASE "CDF"
		iRet = This.uf_Ctrl_Fichier_CARDIF ()
		
	Case Else 
		// [HP252_276_HUB_PRESTA] 
		// Fournisseur lié au Hub Prestataire
		If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then

			// Par défaut, si le fournisseur est lié au HP, on appelle le CTRLE HUB par défaut
			If ibPrestaHub Then
				iRet = This.uf_Ctrl_Fichier_FRN_HUB ()		
			End If 
			
		End IF 
		
END CHOOSE

If iRet < 0 Then 
	stMessage.sTitre = "Chargement Fichier Fournisseur"
	stMessage.sCode = "COMD006"
	stMessage.bErreurG = FALSE
	stMessage.icon = Exclamation!
	ibErrIntegr = True // [PI065]
	This.uf_Sortie_OpCon ( "ECR", 360, "ERR360/CHARGFICFOUR", TRUE )	
End If

Return iRet

end function

private function integer uf_integration_fichier_fournisseur ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Integration_Fichier_Fournisseur (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Intégration du fichier fournisseur dans la base.
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    16/07/2004  DCMP 040206.
//* #2	 CAG	  20/09/2004  DCMP 040381 : Ajout du frn MSS
//* #3    MADM   06/02/2006  [DCMP060119]: Ajout du frn AVM
//* #4    MADM   09/05/2006  [DCMP060356]: Rempl du frn AVM par COR
//* #5    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #6	 JFF    18/09/2007  [ALAPAGE]
//* #7	 PHG	  29/11/2007  [O2M]
//* #8    JFF    05/09/2008  [MICROMANIA]
//* #9    JFF    16/04/2009  [DCMP090102]
//* #10   JFF    16/04/2009  [DCMP090140]
//* #11   JFF    02/09/2009  [DCMP090327].[SBETV]
//* #12   JFF    16/11/2009  [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
//* #13   JFF    10/12/2009  [20091210104642013] Shunt sur code mort
//* #14   JFF    25/11/2009  [MSS_DIAG]
//*       JFF    30/06/2010  [PC363_AUCHAN]
//* 		 JFF    04/11/2010  [PC301].[LOT2]
//* 		 JFF     03/05/2011 [PM178][CORIOLIS]
//		FPI	18/10/2012	[PC884] LBE
//       JFF   30/12/2013 [PC13348&13408]
//       JFF   12/12/2014 [PC13321]
//       JFF   02/01/2015 [PC801_6_TAMET]
//       JFF   02/03/2015 [PM289_CDP]
// 		FPI	12/05/2016 [DT111]
//       JFF   11/10/2016 [DT076-2]
//       JFF   03/09/2018 [DT361]
//       JFF   26/11/2018 [PC874_2_V1]
//       JFF   02/09/2019 [DT424]
//       JFF   30/05/2023 [PMO89_RS4822]
//       JFF   18/02/2025 [PMO268_MIG65]
//*-----------------------------------------------------------------
Int iRet 
String	sIdFourn, sNomFicOrig, sNomFicRen, sMetRet, sNomFic, sDateHeureTrt, sMessRet
Long		lNbLigMod, lNbLig, lNbLigNonTraitee
Boolean	bRet
Blob		blBlob
iRet = 1

sIdFourn = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

CHOOSE CASE Upper ( sIdFourn )

	/*------------------------------------------------------------------*/
	/* Fournisseur : ORANGE/DME                                         */
	/*------------------------------------------------------------------*/
	CASE "DME"
		iRet = This.uf_Integration_Fichier_DME ( lNbLig, lNbLigMod, lNbLigNonTraitee )

	/*------------------------------------------------------------------*/
	/* Fournisseur : SBE			                                         */
	/*------------------------------------------------------------------*/
	CASE "SBE"
		iRet = This.uf_Integration_Fichier_SBE ( lNbLig, lNbLigMod, lNbLigNonTraitee )

	/*------------------------------------------------------------------*/
	/* #2 CAG : 20/09/2004                                              */
	/*------------------------------------------------------------------*/
	/* Fournisseur : MSS			                                         */
	/*------------------------------------------------------------------*/
	CASE "MSS"
		iRet = This.uf_Integration_Fichier_MSS ( lNbLig, lNbLigMod, lNbLigNonTraitee )

	/*------------------------------------------------------------------*/
	/* Fournisseur : CEGETEL/CEG													  */
	/*------------------------------------------------------------------*/
	CASE "CEG"
		iRet = This.uf_Integration_Fichier_CEGETEL ( lNbLig, lNbLigMod, lNbLigNonTraitee )

	/*------------------------------------------------------------------*/
	/* Fournisseur : C-DISCOUNT/CDS												  */
	/*------------------------------------------------------------------*/
	CASE "CDS"
		iRet = This.uf_Integration_Fichier_CDISCOUNT ( lNbLig, lNbLigMod, lNbLigNonTraitee )

	/*------------------------------------------------------------------*/
	/* #3    MADM   06/02/2006  [DCMP060119]                            */
	/* Fournisseur : AEVUM/AVM												  		  */
	/* #4    MADM   09/05/2006  [DCMP060356] 									  */
	/* Rempl du frn AEVUM/AVM par CORDON/COR									  */
	/*------------------------------------------------------------------*/
	
	CASE "COR"
		iRet = This.uf_Integration_Fichier_CORDON ( lNbLig, lNbLigMod, lNbLigNonTraitee )	

	// #7 [O2M] Appel de l'intégratino du fichier.
	CASE "O2M"
		iRet = This.uf_Integration_Fichier_O2M ( lNbLig, lNbLigMod, lNbLigNonTraitee )

//* #8 [MICROMANIA]
	CASE "MCM"
		iRet = This.uf_Integration_Fichier_MICROMANIA ( lNbLig, lNbLigMod, lNbLigNonTraitee )

//* #9 [DCMP090102]
	CASE "CDP"
		// [PM289_CDP]
		iRet = This.uf_Integration_Fichier_CDISCOUNTPRO_new ( lNbLig, lNbLigMod, lNbLigNonTraitee )			

	CASE "CDA"
		// [PM289_CDP]
		iRet = This.uf_Integration_Fichier_CDISCOUNTPRO_ano ( lNbLig, lNbLigMod, lNbLigNonTraitee )			

//* #10 [DCMP090140]
	CASE "PAP"
		iRet = This.uf_Integration_Fichier_PHONEANDPHONE ( lNbLig, lNbLigMod, lNbLigNonTraitee )

//* #11 [DCMP090327].[SBETV]
	CASE "SB1"
		iRet = This.uf_Integration_Fichier_SBETV ( lNbLig, lNbLigMod, lNbLigNonTraitee )

//* #12 [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
	CASE "FNC"
		iRet = This.uf_Integration_Fichier_FNAC ( lNbLig, lNbLigMod, lNbLigNonTraitee )

//* #14 [MSS_DIAG]
	CASE "MS1"
		iRet = This.uf_Integration_Fichier_MSS_DIAG ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PC363_AUCHAN]
	CASE "AUC"
		iRet = This.uf_Integration_Fichier_AUCHAN ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PC301].[LOT2]
	CASE "CAR"
		iRet = This.uf_Integration_Fichier_Carrefour ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PM178][CORIOLIS]
	CASE "CIS"
		iRet = This.uf_Integration_Fichier_Coriolis ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PM200][PSM]
	CASE "PSM"
		iRet = This.uf_Integration_Fichier_PSM ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PC884]
	CASE "LBE"
		iRet = This.uf_Integration_Fichier_LBE ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PC13348&13408]
	CASE "MTT"
		iRet = This.uf_Integration_Fichier_MTT ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PC13321]
	CASE "ELD"
		iRet = This.uf_Integration_Fichier_ELECTRODEPOT ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PC801_6_TAMET]
	CASE "TMT"
		iRet = This.uf_Integration_Fichier_TAMET ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [DT111]
	CASE "CMA"
		iRet = This.uf_Integration_Fichier_Carma ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [DT076-2]
	CASE "BK2"
		iRet = This.uf_Integration_Fichier_BAK2 ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [DT361]
	CASE "CEA"
		iRet = This.uf_Integration_Fichier_CEAT ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PM444-1]
	CASE "AGP"
		iRet = This.uf_integration_fichier_agora_place ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PC874_2_V1]
	CASE "OMT"
		iRet = This.uf_integration_fichier_omt_ctrle_imei ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [DT424]
	CASE "OGP"
		iRet = This.uf_Integration_Fichier_OrangeGrandPublic ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [DT424]
	CASE "OOP"
		iRet = This.uf_Integration_Fichier_OrangeOpenPro ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [RS3200]
	CASE "TLS"
		iRet = This.uf_integration_fichier_telstore ( lNbLig, lNbLigMod, lNbLigNonTraitee )

// [PMO89_RS4822]
	CASE "CDF"
		iRet = This.uf_integration_fichier_cardif ( lNbLig, lNbLigMod, lNbLigNonTraitee )

	Case Else
		// [HP252_276_HUB_PRESTA] 
		// Fournisseur lié au Hub Prestataire
		If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then

			// Par défaut, si le fournisseur est lié au HP, on affecte le DO HUB par défaut
			If ibPrestaHub Then
				iRet = This.uf_Integration_Fichier_Frn_Hub ( lNbLig, lNbLigMod, lNbLigNonTraitee )
			Else
				This.uf_Trace ( "ECR", "ERREUR : Ce fournisseur n'est pas déclaré dans le programme d'intégration, il faut modifier le code pour ajouter son traitement" )
				Return -1
			End If 
		End IF 


END CHOOSE

/*------------------------------------------------------------------*/
/* MAJ de la table Article en base.                                 */
/*------------------------------------------------------------------*/
If iRet > 0 Then 
	This.uf_Trace ( "ECR", String ( lNbLigMod ) + " ligne(s) mise(s) à jour en base, sur " + String ( lNbLig ) + " lignes au total." )
	This.uf_Trace ( "ECR", String ( lNbLigNonTraitee ) + " ligne(s) non traitée(s), sur " + String ( lNbLig ) + " lignes au total." )
	This.uf_Trace ( "ECR", "Table Commande mise à jour normalement." )

	/*------------------------------------------------------------------*/
	/* #1 : DCMP 040206 : Envoi de mail suite réglement automatique ou  */
	/* rejets.                                                          */
	/*------------------------------------------------------------------*/
	sNomFic = isTxtNomFic.Text
	sDateHeureTrt = String ( Today () ) + " à " + String ( Now () )
	sMessRet = Fill ( " ", 250 )


	F_commit ( SQLCA, TRUE )
   // :#13 [20091210104642013] Shunt sur code mort	


	If iRet > 0 Then iRet = 1

	/*------------------------------------------------------------------*/
	/* On renomme le fichier fournisseur, afin de marquer le fait       */
	/* qu'il a été traité.                                              */
	/*------------------------------------------------------------------*/
	sNomFicOrig = isTxtNomFic.Text
	
	Choose Case sIdFourn
		// [PC884] 	// [PMO268_MIG65]
		Case "LBE", "AUC"
			sNomFicRen  = Left ( sNomFicOrig, Len ( sNomFicOrig ) - 3 ) + "OK"
		Case Else
			sNomFicRen  = Left ( sNomFicOrig, Len ( sNomFicOrig ) - 3 ) + "X" + Right ( sNomFicOrig, 2 ) 
	End Choose 
	
	/*------------------------------------------------------------------*/
	/* Recopie du fichier original vers le fichier renommé.				  */
	/* dont l'ext. est "TXT".                                           */
	/*------------------------------------------------------------------*/
	If Upper ( sNomFicOrig ) <> Upper ( sNomFicRen ) then 
		bRet = F_LireFichierBlob ( blBlob, sNomFicOrig )
		If bRet Then bRet = F_EcrireFichierBlob ( blBlob, sNomFicRen )
		If bRet Then FileDelete ( sNomFicOrig )
	Else 
		bRet = True
	End If

	If Not bRet Then 
		This.uf_Trace ( "ECR", "ERREUR : Impossible de renommer le fichier fournisseur !" )
		stMessage.sTitre = "Intégration Fichier Fournisseur"
		stMessage.sCode = "COMD009"
		stMessage.icon = Exclamation!
		This.uf_Sortie_OpCon ( "ECR", 370, "ERR370/INTFICFOUR", FALSE )				
	Else
		This.uf_Trace ( "ECR", "Fichier fournisseur renommé en " + Upper ( sNomFicRen ) )
		isTxtNomFic.Text = ""
	End If

Else
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR : Problème lors de l'UPDATE en base sur la table commande." )
	This.uf_Trace ( "ECR", String ( lNbLigMod ) + " ligne(s) mise(s) à jour en base, sur " + String ( lNbLig ) + " lignes au total." )
	This.uf_Trace ( "ECR", String ( lNbLigNonTraitee ) + " ligne(s) non traitée(s), sur " + String ( lNbLig ) + " lignes au total." )
	This.uf_Trace ( "ECR", "Le fichier n'est pas renommé, renommez à la main en .BAD et demandez au fournisseur de nous le retourner corrigé." )
End If

If iRet < 0 Then 
	stMessage.sTitre = "Intégration Fichier Fournisseur"
	stMessage.sCode = "COMD009"
	stMessage.icon = Exclamation!
	This.uf_Sortie_OpCon ( "ECR", 380, "ERR380/INTFICFOUR", FALSE )				
End If



Return iRet
end function

public subroutine uf_initialiser (ref s_pass astpass, ref statictext astxtnomfic, ref listbox alblistefic);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Initialiser (PUBLIC)
//* Auteur			: Fabry JF
//* Date				: 30/08/2001
//* Libellé			: Initialisation de l'objet
//* Commentaires	: 
//*
//* Arguments		: astPass		s_Pass		Ref
//*					  asTxtNomFic  StaticText	Ref					
//*					  aLbListeFic  ListBox		Ref					
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

DatawindowChild 	dwChild

idwFourn 		= astPass.dwNorm [1]
idwFicFourn 	= astPass.dwNorm [2]
idwSuiviTrt 	= astPass.dwNorm [3]
idwTri		 	= astPass.dwNorm [4]
idwStkRepFourn = astPass.dwNorm [5] 
isTxtNomFic	 	= asTxtNomFic
ilbListeFic		= albListeFic

/*------------------------------------------------------------------*/
/* Chargement liste fourns.                                         */
/*------------------------------------------------------------------*/
idwFourn .GetChild ( "ID_FOURN", dwChild )
dwChild.SetTransObject ( SQLCA )
dwChild.Retrieve ( "-FR" )

/*------------------------------------------------------------------*/
/* Chargement liste Rep fourns.                                     */
/*------------------------------------------------------------------*/
idwStkRepFourn.SetTransObject ( SQLCA )
idwStkRepFourn.Retrieve ( "-FL" )

/*------------------------------------------------------------------*/
/* Tableau des fournisseurs à traiter par OpCon/XPS.                */
/*------------------------------------------------------------------*/
isTabFrIntSui = stGlb.sTab_OpCon_XPS

idwDetPro = Create Datastore
idwDetPro.DataObject = "d_lst_det_pro"
idwDetPro.SetTransObject ( SQLCA )

/*------------------------------------------------------------------*/
/* Initialisation du fichier de Sortie OpCon                        */
/*------------------------------------------------------------------*/
If This.uf_Sortie_OpCon ( "INIT", 0, "", FALSE ) < 0 Then Halt

end subroutine

private subroutine uf_formatchaine (ref string asVal);//*-----------------------------------------------------------------
//*
//* Fonction      : N_Cst_Int_Fic_SuiviCmd::uf_FormatChaine
//* Auteur        : Catherine ABDMEZIEM
//* Date          : 18/10/2002 14:36:00
//* Libellé       : Remplace certains caractères dans une chaîne par des blancs
//* Commentaires  : 
//*
//* Arguments     : ( Ref )	String	asVal	:	chaîne à traiter
//*
//* Retourne      : Rien
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

String	sCar, sTabCar [], sTabSubst []
Long		lTotLet, lCpt, lTotSubst, lCptSubst

sTabCar		[1] = "'"
sTabSubst 	[1] = " "

lTotSubst = UpperBound ( sTabSubst )

/*------------------------------------------------------------------*/
/* On remplace les caractères voulus.										  */
/*------------------------------------------------------------------*/

lTotLet = Len ( asVal )
For lCpt = 1 To lTotLet

	sCar = Mid ( asVal, lCpt, 1 )	

	For lCptSubst = 1 To lTotSubst 
	
		If sCar = sTabCar	[ lCptSubst ] Then 
			asVal = Replace ( asVal, lCpt, 1, sTabSubst [ lCptSubst ] )			
			Exit
		End If
		
	Next
Next

end subroutine

private function integer uf_sortie_opcon (string ascas, integer aicodeerreur, string astexte, boolean abbox);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_in_fic_SuiviCmd::uf_Sortie_OpCon (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 16/12/2002
//* Libellé			: Fichier de sortie des erreurs pour OpCon
//* Commentaires	: 
//*
//* Arguments		: asCas			String		Val
//*					  aiCodeErreur	Integer		Val
//*					  asTexte		String		Val
//*					  abBox			Boolean		Val
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #1    JFF    05/04/2006  ajout du "+ K_FIC_SORTIE_OPCON" derrière isRepFicOpcon  
//        JFF    21/03/2017  [PI065]
//        JFF    14/04/2017  [DT288][MANTIS24757]
//*-----------------------------------------------------------------

Int	iRet, iFicOpcon
String sMes, sNomFicRen, sSql 
Long	lRow


/*------------------------------------------------------------------*/
/* Fichier de sortie Erreur pour OpCon                              */
/*------------------------------------------------------------------*/

CHOOSE CASE Upper ( asCas )

	CASE "INIT"

		isRepFicOpcon =  ProfileString ( stGlb.sFichierIni, "GEST_COMMANDES", "OPCON_OUT", &
							  ProfileString ( stGlb.sWinDir + "\MAJPOST.INI", "PARAM", "DESTINATION", "C:" ) + "\" )
		iRet = 1

//Migration PB8-WYNIWYG-03/2006 CP
//		If FileExists ( isRepFicOpcon ) Then 
		If f_FileExists ( isRepFicOpcon + K_FIC_SORTIE_OPCON ) Then // #1
//Fin Migration PB8-WYNIWYG-03/2006 CP
			
			If Not FileDelete ( isRepFicOpcon + K_FIC_SORTIE_OPCON ) Then // #1
				iRet = -1
			End If 
		End If 

	CASE "ECR"

		// [PI065]
		If ibErrIntegr Then
			Choose Case isIdFour
				Case "COR"
					// [DT288][MANTIS24757]
					isNomFicOrig = Upper ( isNomFicOrig )
					sNomFicRen = F_Remplace ( isNomFicOrig, "FIC_MOV\", "REJET_FIC_MOV\" ) 
					sNomFicRen = F_Remplace ( sNomFicRen, ".", ".BAD" ) + "__BAD_" + String ( DateTime ( Today(), Now()), "yyyymmddhhmmss" ) + "_" + stGlb.sCodOper				
				Case Else 
					sNomFicRen = F_Remplace ( isNomFicOrig, ".", ".BAD" ) + "__BAD_" + String ( DateTime ( Today(), Now()), "yyyymmddhhmmss" ) + "_" + stGlb.sCodOper				
			End Choose
			
			iRet = FileMove ( isNomFicOrig, sNomFicRen )
			
			If iRet < 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR renommage BAD " + &
				" : le système n'a pas pu renommer le fichier " + isNomFicOrig + " en BAD !" )					
			End If
			
			sSql  = "Exec sysadm.PS_S_ENVOI_MAIL_LOG_PRESTA "
			sSql += "'" + isIdFour + "'," 
			sSql += string ( ilIdLotLog ) + ","
			sSql += isIdTypMvt + ","
			sSql += "'" + isNomFicOrig + "'" 
			
			If F_Execute ( sSql, SQLCA ) Then 
				If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
					F_commit ( SQLCA, True ) 
				Else 
					iRet = -1
					F_commit ( SQLCA, False ) 
					This.uf_Trace ( "ECR", "ERREUR mail presta : Problème envoi mail/log presta PS_S_ENVOI_MAIL_LOG_PRESTA" ) 
				End If
			Else
				iRet = -1
				F_commit ( SQLCA, False ) 
				This.uf_Trace ( "ECR", "ERREUR mail presta : Problème envoi mail/log presta PS_S_ENVOI_MAIL_LOG_PRESTA" ) 
			End If					
			
		End If
		/*------------------------------------------------------------------*/
		/* On est connecté avec OpCon, donc sortie en fichier Erreur.       */
		/*------------------------------------------------------------------*/
		If gbOpCon Then 

			iFicOpcon = FileOpen ( isRepFicOpCon  + K_FIC_SORTIE_OPCON, LineMode!, Write!, Shared!, Append! )
			FileWrite ( iFicOpcon, String ( aiCodeErreur ) + "|" + asTexte )
			FileClose ( iFicOpcon )

		/*------------------------------------------------------------------*/
		/* Sinon Mes Box sur Demande                                        */
		/*------------------------------------------------------------------*/
		ElseIf abBox Then
			
			F_Message ( stMessage )

		End If

			

END CHOOSE



Return iRet
end function

public function integer uf_trt_opcon (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_article::uf_Trt_OpCon (PUBLIC)
//* Auteur			: Fabry JF
//* Date				: 16/12/2002
//* Libellé			: Traitement de certaines partie en Automatique
//* Commentaires	: 
//*
//* Arguments		: asCas			String		Val
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*       JFF   16/06/2010   [DCMP100428]
//*-----------------------------------------------------------------

Int iRet, iFicFinTrt 
Long	lTotFour, lCptFour

iRet = 1

Choose Case Upper ( asCas )

	Case "LANCER"

		lTotFour = UpperBound ( isTabFrIntSui )

		/*------------------------------------------------------------------*/
		/* Compte de fournisseur                                            */
		/*------------------------------------------------------------------*/
		For lCptFour = 1 To lTotFour

			/*------------------------------------------------------------------*/
			/* On Force le fournisseur.                                         */
			/*------------------------------------------------------------------*/
			idwFourn.SetItem ( 1, "ID_FOURN", isTabFrIntSui [ lCptFour ] ) 
			istxtNomFic.Text = ""
			
			This.uf_Detection_Auto_NomFic ( isTabFrIntSui [ lCptFour ] )

			// [DCMP100428]
			If isTabFrIntSui [ lCptFour ] = "MS1" Then
				If istxtNomFic.Text = "" Then
					This.uf_Sortie_OpCon ( "ECR", 390, "ERR390/FICHIER_ABSENT", FALSE )
					iRet = -1
				End If
			End If
			// [DCMP100428]

			/*------------------------------------------------------------------*/
			/* Compteur de fichier pour un même fournisseur                     */
			/*------------------------------------------------------------------*/
			DO UNTIL istxtNomFic.Text = "" Or iRet < 0
				iRet = This.uf_Lancer_Trt ()
				
				// On ne tient pas compte de l'érreur, on enchaine sur les autres fichiers.
				// Souhait de PI
				iRet = 1			
			LOOP

			If iRet < 0 Then Exit

		Next

	Case "FIN_TRT"

			iFicFinTrt = FileOpen ( isRepFicOpCon + K_FICFINTRT, LineMode!, Write!, Shared!, Replace! )
			FileClose ( iFicFinTrt )

End Choose


Return iRet

end function

private function integer uf_ctrl_fichier_dme ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_DME (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 30/08/2001
//* Libellé			: Controler de la validité du fichier du DME
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//* #1	 CAG	 18/10/2002	  Modification SFR : Ajout des colonnes ID_BSP et DTE_RET_PRET
//* #2	JCA	12/12/2007		DCMP 70918
//* #3    JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//       JFF   20/12/2012     [VDOC9337]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1, dtNUll
Long	lIdSin, lIdSeq //#2

Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn

iRet = 1



lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Un numéro d'IMEI doit contenir 15 chiffres" )
	End If

	If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Numéro d'IMEI non valide" )
	End If 


	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COD_ETAT_CMD														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "ANN", "RPC"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le code état doit être null ou égal à ANN ou RPC, mais pas " + sVal )
		END CHOOSE

	End If

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// :[VDOC9337]	

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_dme (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_DME (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Intégration du fichier du DME dans la base
//* Commentaires	: 
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	FPI	10/12/2009	[SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011 [ITSM62176] ajout du point de décimal
//       JFF   18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc
n_cst_string lnvPFCString 

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli
//#1 FIN

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	This.uf_definir_codetat_DME ( sVal, lCpt )
	sSql += "'" + sVal + "', "
	//#1
//	sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) ) // [LGY15]
	sDestEnvoi	= "CLIENT" // [LGY15] on force car sion le mail de swap ne part pas

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	sVal = "null"
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sVal, "NOM_FIC_FRN", isNomFicOrig, ";")		
	sSql += "'" + sVal + "'"


	//#1
  	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If
	//#1 FIN

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #4
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2
Return iRet 
end function

private subroutine uf_definir_codetat_dme (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_DME (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 30/08/2001
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: 
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli
DateTime dtDteRcpFrn, dtDteEnvCli
String	sDestEnvoi

asVal = Upper ( asVal ) 

/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return


/*------------------------------------------------------------------*/
/* !!!! Code état Déterminés en fonction des dates 					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Si le CodEtat du fichier n'est pas un de ces deux codes, alors   */
/* on va le déterminer à partir des dates.                          */
/*------------------------------------------------------------------*/
dtDteRcpFrn = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_FRN" ) 
dtDteEnvCli = idwFicFourn.GetItemDateTime ( alCpt, "DTE_ENV_CLI" )
sDestEnvoi	= idwFicFourn.GetItemString 	( alCpt, "DEST_ENVOI" )

dDteRcpFrn = Date ( dtDteRcpFrn )
dDteEnvCli = Date ( dtDteEnvCli )


If Not IsNull ( dDteEnvCli ) Then

	CHOOSE CASE sDestEnvoi	
		CASE "SPB"
			// Retourné à la SPB par le fournisseur
			asVal = "RSP"			

		CASE ELSE
			// ENVOYE AU CLIENT PAR LE FOURNISSEUR
			asVal = "ECL"			
	END CHOOSE

	// De plus si la dDteRcpFrn n'était pas renseigné
	//	On y met la dDteEnvCli
	If IsNull ( dDteRcpFrn ) Then idwFicFourn.SetItem ( alCpt, "DTE_RCP_FRN", dDteEnvCli )

ElseIf Not IsNull ( dDteRcpFrn ) Then

	// RECEPTIONNE CHEZ FOURNISSEUR
		asVal = "RCF"

Else
	// EN COURS CHEZ LE FOURNISSEUR
		asVal = "ECT"

End If



end subroutine

private function integer uf_ctrl_fichier_sbe ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_SBE (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 10/04/2015
//* Libellé			: Controler de la validité du fichier SBE
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//        JFF   09/04/2015 [DT141][MANTIS15487]
//        JFF   21/07/2015 [DT141][MODIF_SMAIN]
//        JFF   22/07/2015 [DT168]
//        JFF   31/07/2015 [VDOC18329]
//		    FPI	 18/08/2015	[DT168].Mantis16805 
//        JFF   11/03/2016 [VDOC19969]
//        JFF   19/04/2016 [DT209]
// 		 JFF	 22/09/2017 [CTRLE_DATE_INTRG_FOU]
//        JFF   28/01/2019 [PM450-1]
//*-----------------------------------------------------------------

Int iRet, iStatusGc, iInfoSpbFrn
String	sIdFour, sVal, sCar, sIdFourCtrl, sInfoFrnSpbCpltLu, sIMEICorr
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sVal1, sVal2, sVal3
String sInfoFrnSpbCplt
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datastore	dsCode
Long dcIdProd
String sInfoSpbFrnCplt, sChaineBCV
Long	lIdSin, lIdSeq //#2
datetime	dtVal, dtVal1
n_cst_string lnvPFCString  
Boolean bF_CLE_A_TRUE_DT209

bF_CLE_A_TRUE_DT209 = F_CLE_A_TRUE ( "DT209" )

sIdRefFour = fill(" ",20)
sCodEtat = fill(" ",3)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

iRet = 1

lTotLig = idwFicFourn.RowCount ()

// [MODIF_SUITE_REDR]
If lTotLig <= 0 And FileLength64 ( isTxtNomFic.Text ) > 0 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR : 0 Ligne chargée ! , pour PI : Taille du fichier positive et chargement à 0 ligne => Anormal. Réessayez l'intégration (cause éventuelle => le fichier est peut-être en format Unicode au lieu d'Ansi, à vérifier)." )
End If		

sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 		// #9

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sIdRefFour = fill(" ",20)
	sCodEtat = fill(" ",3)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
	// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If
	End If
	
	// [PM82][LOT1]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	// [BLCODE]
	If sVal <> sIdFour And sVal <> "BLC" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 
	// [BLCODE]

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_RCP_FRN										*/
	/*------------------------------------------------------------------*/
	// #9
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	// [DCMP100333]
	// [PM166][O2M] 177, 178
	Choose Case lVal
		Case 155, 156, 157, 158, 160, 161, 163, 164, 165, 174, 177, 178
			If Not isNull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End if

		// [PM01].[LOT3&4]
		// [PC499][PC501][PC545][-1x3][V5]
		// [VDOC8041] 232
		Case 151, 152, 153, 154, 159, 162, 166, 167, 168, 169, 2, 21, 175, 232
			// [PC13321][MANTIS14042]
			If isNull(dtVal) And iInfoSpbFrn <> 957 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être renseignée.")
			End if
			
			// [PC13321][MANTIS14042]			
			If Not isNull(dtVal) And iInfoSpbFrn = 957 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", et pour le process spécifique 957, la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End If			
			
	End Choose

	// Fin #9
	
	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	// [CTRL_IMEI_O2M]

	If lnvPFCString.of_getkeyvalue (sChaineBCV, "TYP_APP_DS", ";") = "TEL" Then
		sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )
	
		If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (NUM_IMEI_NOU) Un numéro d'IMEI doit contenir 15 chiffres" )
		End If
	
		If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (NUM_IMEI_NOU) Numéro d'IMEI non valide" )
		End If 
	End If
	
	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_ANC														  */
	/*------------------------------------------------------------------*/
	// [DT141] 
	// [CTRL_IMEI_O2M]
	
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "TYP_APP_DS", ";") = "TEL" Then
		Choose Case sIdRefFour 
			Case "A_DIAGNOSTIQUER", "A_REPARER", "A_DESOXYDER"
				sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_ANC" ) )
			
				If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (NUM_IMEI_ANC) Un numéro d'IMEI doit contenir 15 chiffres" )
				End If
			
				If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (NUM_IMEI_ANC) Numéro d'IMEI non valide" )
				End If 
		End choose 
	End If		

	// [DT141] 
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "FACT_PRESENTE" ) )
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 	
	Choose Case sIdRefFour
		Case "PEC_A_RECYCLER", "REFUSE_A_REEXP", "CMDE_A_CPLTER", "A_REPARER", "A_DESOXYDER" // [DT168]
			// Ok
		Case Else

			// [DT141][MANTIS15487]
			Choose Case lVal		
				Case 151, 152, 153, 154
					Choose Case sVal
						Case "OUI", "NON"
							// OK
						Case Else
							iRet = -1
							This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
							" : (FACT_PRESENTE) Cette zone ne peut contenir que la valeur OUI ou NON" )
					End Choose 
			End Choose 				
	End Choose 
	
	// [DT141] 
	// [DT209]
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "TYPE_SWAP" ) )
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 	
	If IsNull ( sVal ) Then sVal = ""
	Choose Case sIdRefFour
		Case "A_DIAGNOSTIQUER", "A_REPARER", "PEC_A_RECYCLER", "REFUSE_A_REEXP", "A_DESOXYDER", "BON_EMARGE"
			// Ok
		Case Else
			Choose Case lVal
				Case 176
					// Ok
					
				Case Else
					Choose Case Upper ( sVal )
						// [VDOC19969] "REPARATION_APP_ORIGINE"
						Case 	"SWAP REPARABLE", &
								"SWAP IRREPARABLE", &
								"SWAP VOL", &
								"SWAP GRADE A", &
								"REPARATION_APP_ORIGINE" // VDOC19969
							// OK
							
						Case Else
							iRet = -1
							This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
							" : (TYPE_SWAP) Cette zone ne peut contenir cette valeur : " + sVal )
					End Choose 
			End Choose 						
	End Choose 	
	// [DT141] 
	sVal = String ( idwFicFourn.GetItemDecimal ( lCpt, "MT_TTC_REMPL" ) ) 
	If Not IsNumber ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (MT_TTC_REMPL) Cette zone doit contenir une valeur numérique" )
	End if

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_FIN_TRAIT									  */
	/*------------------------------------------------------------------*/
	// #9
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	// [DCMP100333]
	// [PM01].[LOT3&4]
	// [PM166][O2M] 177
	// [PM01] Ajout de 167,168
	// [PC499][PC501][PC545][-1x3][V5]
	Choose Case lVal
		Case 151, 152, 153, 154, 155, 160, 161, 165, 166, 167, 168, 2, 21, 167, 168, 177, 178, 175

			// [PM82][LOT1]
			// [DT168].Mantis16805 
			if Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être renseignée.")
			End if
			// :[DT168].Mantis16805
			
		// [VDOC8041] 232
		Case 156, 157, 158, 159, 162, 163, 164, 169, 232, 174
			if Not Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être vide.")
			End if

		Case Else
			If ( lVal = 0 Or IsNull ( lVal ) ) And Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Lorsque la date de fin de traitement (DTE_FIN_TRAIT) est renseignée, un statut GC est obligatoire.")
			End If 
			
	End Choose
	// Fin #9

	/*------------------------------------------------------------------*/
	/* ZONE 6 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal
		Case 177, 178
			If IsNull ( sVal ) Or Len ( sVal ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) )
			End If
		//  [VDoc4752]
		Case 165
			If iInfoSpbFrn = 970 and (IsNull ( sVal ) Or Len ( sVal ) <= 0 ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) +  " pour le process 970.")
			End If
		// :[VDoc4752]
	End Choose

	// [MODIF_SUITE_REDR]
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "NUM_BON_TRP", Trim ( sVal ) )
	
	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )

	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
//	if dsCode.retrieve('-GC') > 0  then											// #9 - Chargement au début de la fct
			// #3 [FNAC_PROD_ECH_TECH] agrandissement jusqu'à 160
			// #4 [DCMP090109] ajout 2, 21
			// #5 [DCMP090085] ajout jusqu'à 169
			// #6 [DCMP090327].[SBETV] (171)
			// [PM166][O2M]
			// [MANTIS3067] ajout 231
			// [VDOC10641] 174
		if dsCode.find("( ID_CODE BETWEEN 151 AND 171 " + &
							"	OR ID_CODE IN (2, 21, 263, 264, 601, 602 ) " + &
							"  OR ID_CODE BETWEEN 174 AND 179 " + &
							"  OR ID_CODE BETWEEN 231 AND 239" + &							
							"  OR ID_CODE BETWEEN 301 AND 399" + &														
							") AND ID_CODE = "+sVal, 1, dsCode.RowCount()+1 ) = 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
		End If
//	End IF			// #9

// [PM166][O2M]
// [PM82][LOT1] je remonte cette linge plus haut.
// [RECUP_DONNEE_O2M] PCM 
// [VDOC4970]
// [PM250] Modif suite demande d'Hélène (et O2M)
	Choose Case Upper ( sIdTypArt ) 
		Case "EDI", "PRS", "PCM"
			Choose Case Long ( sVal ) 
				Case 177, 178
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC " + sVal + " n'est autorisé que pour les commandes de matériel (hors Batterie amovible BAM et Câble d'alimentation ALE)" )
			End Choose
		Case Else
			Choose Case Long ( sVal ) 
				Case 177, 178, 176, 233, 263, 234, 235, 236, 237,238, 239, 301
					
					// [PC938_ORANGE_V3]
					// C'est Ok
					// [MODIF_SUITE_REDR]
					If Long ( sVal ) = 234 Then
						If Not ( sIdTypArt = "PST" And Trim ( lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt, "TYP_RELAI", ";")) <> "PRET" ) Then
							iRet = -1
							This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
							" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Status GC " + sVal + " autorisé uniquement sur une presta de type PST sans PRET" )
						End If
					End If 
					
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Status GC " + sVal + " non autorisé pour une commande de matériel (hors Batterie amovible BAM et Câble d'alimentation ALE)" )

			End Choose
			
	End Choose
// :[PM166][O2M]

	// [VDOC3731]
	Choose Case iInfoSpbFrn
		// [VDOC5774] 435, 1502
		Case 1503, 1504, 435, 1502
			Choose Case Long ( sVal ) 
				Case 166
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
			
		Case 1505
			Choose Case Long ( sVal ) 
				Case 167, 168
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
		// [VDoc4752]
		Case 970
			Choose Case Long ( sVal )
					// [VDoc6082] ajout du statut_gc 164
				Case 165,164
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
			// :[VDoc4752]
			
		// [VDOC6300] // [PC877]
		Case 964, 969
			Choose Case Long ( sVal )
				Case 179
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose			
			
	End Choose		

	Choose Case Long ( sVal ) 
		Case 166
			// [VDOC5774] 435, 1502
			Choose Case iInfoSpbFrn
				Case 1503, 1504, 435, 1502
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		Case 167, 168
			Choose Case iInfoSpbFrn
				Case 1505
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		// [VDOC6300] // [PC877]
		Case 179
			Choose Case iInfoSpbFrn
				Case 964, 969
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
	End Choose			
	// :[VDOC3731]	

	// [VDOC8041]
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal 
		Case 232
			If Upper ( sIdTypArt ) <> "PRS" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If

	End Choose

	Choose Case sIdTypArt  
		Case "PRS"
			// OK
		Case Else
			If lVal = 232 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If

	End Choose
	// [VDOC8041]

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COMMENT_FRN														     */
	/*------------------------------------------------------------------*/
	// Pas de Controle Particulier
	// [MODIF_SUITE_REDR]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "COMMENT_FRN", Trim ( sVal ) )
	

	/*------------------------------------------------------------------*/
	/* ZONE   : info_frn_spb_cplt													  */
	/*------------------------------------------------------------------*/
	// [PM166][O2M]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	
	If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = "" 

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";"))
	If len ( Trim ( sVal ) ) > 0 And Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone sérialisée DTE_RCP_MOB_CLI ne contient pas une date valide" )
	End If 

	// [PC938_ORANGE_V3]
	If len ( Trim ( sVal ) ) > 0 Then 
		Choose Case lVal 
			Case 178, 233, 263, 234, 2, 21
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone sérialisée DTE_RCP_MOB_CLI ne peut être renseignée sans le statut 178, 233, 263, 234, 2, 21" )
		End Choose
	End If

	// [PC938_ORANGE_V3]
	If len ( Trim ( sVal ) ) > 0 And ( lVal = 178 Or lVal = 233 Or lVal = 263 ) And ( IsNull ( dtVal ) Or Date ( dtVal ) = 1900-01-01 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone DTE_FIN_TRAIT doit être renseignée avant de renseigner la zone DTE_RCP_MOB_CLI et de donner le statut 178 ou 233 ou 263" )
	End If

  /* [VDOC9908]		
	If lVal = 178 And len ( Trim ( sVal ) ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut 178 oblige à avoir la zone sérialisée DTE_RCP_MOB_CLI renseignée." )
	End If
	*/
	// [PM166][O2M]

	// [VDOC7926]
	Choose Case dcIdProd
		Case 41101, 41103 
			
			sVal  = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQUE_REMPL", ";"))	
			sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODELE_REMPL", ";"))	
			sVal2 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_PUBLIC", ";"))	
			sVal3 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_O2M", ";"))	

			If len ( Trim ( sVal ) ) > 0 OR len ( Trim ( sVal1 ) ) > 0 OR len ( Trim ( sVal2 ) ) > 0 OR len ( Trim ( sVal3 ) ) > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7926) : Les binômes clés/valeurs pour les clés MARQUE_REMPL, MODELE_REMPL, PRIX_TTC_PUBLIC, PRIX_TTC_FACTU_O2M ne sont pas autorisés pour le produit " + String ( dcIdProd ) + "." )
			End If
			
	End Choose
	// :[VDOC7926]

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	
	
	// [VDOC9907]
	// Mettre en place pour O2M ces règles, rejet du fichier MPR si : 
	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un status_gc différent de 21 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If lVal <> 21 And ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9907/A.RAULT) : présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un status_gc différent de 21 , interdit " )
	End IF

	// Mettre en place pour O2M ces règles, rejet du fichier MPR si : 
	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour à une commande avec action = A_REPARER ou A_REPARER_FORCE 
	// [PM222-1]	
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) &
		 And ( sIdRefFour = "A_REPARER" Or sIdRefFour = "A_REPARER_FORCE" ) &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &
	Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9907/A.RAULT) : présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour sur une commande sans demande de SAV (donc n’impliquant pas d’action = A_REPARER_SAV ou A_CONTROLER_SAV ), interdit" )
	End IF 
	// :[VDOC9907]
	
	// [VDOC10029]	
	sVal1 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_O2M", ";")
	sVal2 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_BLC", ";")
	sVal3 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_PUBLIC", ";")
	
	If IsNumber ( sVal1 ) Then
		sVal = sVal1
	End If	

	If IsNumber ( sVal2 ) Then
		sVal = sVal2
	End If	

	If IsNumber ( sVal ) And IsNumber ( sVal3 ) Then
		
		If Dec ( sVal ) > Dec ( sVal3 ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC10029/A.RAULT) : le montant du prix facturable par O2M concernant la proposition est supérieur au prix public indiqué, ce qui est incohérent" )
		End If
		
	End If
	// [VDOC10029]		

	// [PC938_ORANGE_V3]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "ORANGE_V3", ";") = "OUI" Then
		sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )

		If Pos ( sVal, "[BVIEOX]") > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (ORANGE V3) : Retour BVIEOX interdit sur Orange V3, toujours retourne BVIE." )
		End If
	End If 

	If lnvPFCString.of_getkeyvalue (sChaineBCV, "ORANGE_V3", ";") = "OUI" Then
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		If sIdRefFour = "A_DIAGNOSTIQUER" And lVal <> 151 And lVal <> 152 And lVal <> 159 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (ORANGE V3) : Pour Orange v3, seul le 151 ou 152 sont autorisé sur le Diag après remplacement" )
		End IF 
	End IF 			
	// [PC938_ORANGE_V3]
	
	// [20140728.FPI] 
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODL_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 35 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MODL_RST_FRN trop longue (35 caractères maximum autorisés)." )
	End if
	
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQ_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 35 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MARQ_RST_FRN trop longue (35 caractères maximum autorisés)." )
	End if

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_REF_FOUR_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 20 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée ID_REF_FOUR_RST_FRN trop longue (20 caractères maximum autorisés)." )
	End if
	// [20140728.FPI] 

	
	// [MODIF_SUITE_REDR]
	Choose Case iStatusGc
		Case 176, 151, 152, 2, 21
	
			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			// [VDOC17191] je ne déclenche pas le message sur le 159
			Choose Case lVal
				Case 301, 159, 156	
					// Ok
				Case Else
					If iStatusGc <> lVal Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
					End If

			End CHoose
			
	End CHoose
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 155 And sIdRefFour <> "REFUSE_A_REEXP" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " ne peut être renvoyé que sur une prestation de type REFUSE_A_REEXP" )
	End If
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	Choose Case sIdRefFour  
		Case "A_REPARER_FORCE", "A_DIAG_FORCE", "A_DESOXYDER_FORCE"

			If lVal > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il est interdit de répondre sur les prestations de type A_REPARER_FORCE, et A_DESOXYDER_FORCE, or vous renvoyez le Statut " + String ( lVal ) + ". Si une réponse doit être apportée, vous devez répondre sur la préstation d'origine liée à ce forçage." )
			End If
	End Choose		

	// [DT141][MODIF_SMAIN]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	Choose Case lVal
		Case 2, 21
			Choose Case sIdRefFour
				Case "A_REPARER", "A_DESOXYDER"
					// OK
				Case Else 
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Statut de retour (" + String ( lVal ) + ") autorisé uniquement pour la réparation." )
			End Choose
		Case 151, 152
			Choose Case sIdRefFour
				Case "A_DIAGNOSTIQUER"
					// Ok
				Case Else 
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Statut de retour (" + String ( lVal ) + ") autorisé uniquement pour le diagnostic." )
			End Choose
			
		// VDOC18329
		Case 176, 177, 178 
			Choose Case sIdRefFour
				Case "CMDE_A_CPLTER"
					// Ok
				Case Else 
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Statut de retour (" + String ( lVal ) + ") autorisé uniquement pour une commande de remplacement." )
			End Choose

		// VDOC18329				
		Case 155
			Choose Case sIdRefFour
				Case "REFUSE_A_REEXP"
					// Ok
				Case Else 
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Statut de retour (" + String ( lVal ) + ") autorisé uniquement pour un  Refusé à réexpédier (REFUSE_A_REEXP)." )
			End Choose
		
	End Choose				
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	Choose Case lVal
		Case 152, 21
			
			If IsNull ( sVal ) Or sVal = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " doit obligatoirement être accompagné d'un commentaire." )
			End If
			
	End CHoose

	// [PM251-2]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") <> "OUI" Then
		sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "REMIS_EN_STK", ";"))		
		If sVal1 = "OUI" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " n'est autorisé que pour une commande de remplacement." )
		End If	
		
	End If

	// [DT209]
	If bF_CLE_A_TRUE_DT209 Then
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		If sIdRefFour = "BON_EMARGE" Then
			Choose Case lVal
				Case 601, 602
					// OK
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " n'est pas autorisé sur une prestation de type BON EMARGE." )
			End Choose
		End If 
	End If

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  			
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "COLIS_PND", &
				  "COLIS_NRPAC", &
				  "COLIS_PERDU", &
				  "COLIS_BALNI", &
				  "COLIS_INCOR", &
				  "COLIS_REFUS", &
				  "ANNUL_REFAIT", &
				  "EN_ATTENTE", &
				  "AUTRE", &
				  "J1", &
				  "J2", &
				  "J3", &
				  "J4", &
				  "J5", &
				  "J6" 
			
					// Ok
					
			Case Else 

				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
	End If 
	
	// [PM450-1]
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";"))
	sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))	

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""		
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PEC_PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
		
		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la clé PEC_PRBLE_LIVRAISON n'est autorisée que si précédemment il y a au un clé PRBLE_LIVRAISON, qui est justement absente." )
		End If 			
	End If 	

	// #6 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then
		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

if isvalid(dsCode) Then destroy dsCode

Return iRet

end function

private function integer uf_reglauto (long alidsin, long alidseq, string asidfour, datetime adtdtercpfrn, decimal adcmtfrais, ref string asmesretour);//*-----------------------------------------------------------------
//*
//* Fonction      : n_cst_int_Fic_SuiviCmd::uf_ReglAuto (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 12/07/2004 13:00:12
//* Libellé       : 
//* Commentaires  : 
//*
//* Arguments     : 	Long					alIdSin			Val
//*				     	Long					alIdSeq			Val
//*						String				asIdFour			Val
//*					   DateTime 			adtDteRcpFrn	Val
//*						Decimal (11,2)		adcMtFrais		Val
//*						String   			asMesRetour  	Réf
//*
//* Retourne      :  0  DteRcpFrn non renseignée
//*						1  Ok, Réglement passé
//*						2  Le réglement Automatique n'est pas autorisé pour le produit/gti/four du sinistre lié
//*						-1 Erreur (asMesRetour)
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....
//*
//*-----------------------------------------------------------------

Long lRet
Boolean bReglAutoAutorise

asMesRetour = Fill ( " ", 250 )

/*------------------------------------------------------------------*/
/* Le produit/gti/fournisseur lié au sinistre ont-ils le paramètre  */
/* (-DP,23) permettant les réglement automatiques ?                 */
/*------------------------------------------------------------------*/
SQLCA.PS_S02_COMMANDE_TYPE ( alIdSin, alIdSeq, asIdFour, lRet)

bReglAutoAutorise = lRet > 0

If Not bReglAutoAutorise Then 
	asMesRetour = "Réglement automatique non autorisé le produit/gti/four du sinistre concerné"
	Return 2
End If 

lRet = SQLCA.PS_INSERTION_FRAIS_AUTOMATIQUE (alIdSin, alIdSeq, adcMtFrais, adtDteRcpFrn, asMesRetour )

If lRet > 0 And ( SQLCA.SQLCode <> 0 Or SQLCA.SQLDBCode <> 0 ) Then
	lRet = -1
End If

Return lRet

end function

private function integer uf_integration_envoimail (string asnomfic, string asdateheuretrt, string asidfourn, ref string asmessret);//*-----------------------------------------------------------------
//*
//* Fonction      : n_cst_int_Fic_SuiviCmd::uf_Integration_EnvoiMail (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 16/07/2004 11:21:26
//* Libellé       : Envoi de mail suite intégration fichier suivi Fournisseur
//*					  et Virement automatique
//* Commentaires  : 
//*
//* Arguments     : String asNomFic 			Val
//*					  String asDateHeureTrt 	Val
//*					  String asIdFourn			Val
//*					  String asMessRet			Réf
//*
//* Retourne      : 
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1   MADM   06/02/2006   [DCMP060119]: Ajout Frn AVM 
//* #2   MADM   09/05/2006   [DCMP060356]: Rempl du Frn AVM par COR
//*-----------------------------------------------------------------

Int iRet 
Boolean bFichierMPR  // Sinon, fichier TEL

bFichierMPR = Pos ( Upper (asNomFic), "FIC_MOV\MPR",  1 ) > 0

/*------------------------------------------------------------------*/
/* Information : Je mets ici en dur les fournisseurs pour lesquels  */
/* nous sommes suceptibles d'avoir fait des réglements auto. En     */
/* effet dans la fonction uf_ReglAuto, une procédure contrôle si    */
/* pour le produit/gti/frn l'option (-DP,23) est présente,          */
/* indiquant la gestion de réglement automatique pour le trinome    */
/* par sinistre. Mais ici nous n'avons plus connaissance des        */
/* produits, nous connaissons juste le fournisseur pour lequel      */
/* on a intégré le fichier. Si de nouveaux fournisseurs sont à      */
/* ajouter pour les réglements auto, il faudra penser à maintenir   */
/* cette fonction pour l'envoi des mails.                           */
/*------------------------------------------------------------------*/
/* VOIR Daniel pour la création obligatoire du répertoire sur Q2K !!*/
/*------------------------------------------------------------------*/
Choose Case bFichierMPR 
	
	// Fichier de réparation
	Case TRUE 

		Choose Case Upper ( asIdFourn )
			
			/*------------------------------------------------------------------*/
			/* #1   MADM   06/02/2006   [DCMP060119]: Ajout Frn AVM			     */
			/* #2   MADM   09/05/2006   [DCMP060356]: Rempl du Frn AVM par COR  */

			/*------------------------------------------------------------------*/
			Case "SBE" , "COR"

				iRet = SQLCA.PS_ENVOI_MAIL_SUITE_INSERTION_FRAIS( asNomFic, asDateHeureTrt, asIdFourn, asMessRet )

			Case Else
				Return 2
	
		End Choose
	
	// Autre fichier (commande)
	Case Else
		Return 2

End Choose

If Trim ( asMessRet ) = "" or iRet > 0 Then
	iRet = 1
Else 
	iRet = -1
End If

Return iRet
end function

private function integer uf_ctrl_fichier_mss ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_MSS (PRIVATE)
//* Auteur			: Catherine Abdmeziem
//* Date				: 20/09/2004
//* Libellé			: DCMP 040381 : Contrôle de la validité du fichier MSS
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #3    JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//       JFF   20/12/2012     [VDOC9337]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve

Long	lIdSin, lIdSeq //#1
datetime	dtVal, dtVal1

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #1
For lCpt = lTotLig To 1 Step -1

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nul, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : DTE_ELV_MOBILE														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "SAV FNAC"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SAV FNAC, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT_CMD														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "ANN", "RPC"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le code état doit être null ou égal à ANN ou RPC, mais pas " + sVal )
		END CHOOSE

	End If


	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// :[VDOC9337]

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 10 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_mss (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_MSS (PRIVATE)
//* Auteur			: Catherine Abdmeziem
//* Date				: 20/09/2004
//* Libellé			: DCMP 040381 : Intégration du fichier MSS dans la base
//* Commentaires	: 
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    12/07/2004  DCMP 040206
//* #2    JCA    09/06/2006  MAILPUSH
//* #3    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #4 	 PHG	  24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #5	FPI	10/12/2009	[SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011 [ITSM62176] ajout du point de décimal
//       JFF   18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq, lStatusGc
Decimal {2} dcMtFrais
n_cst_string lnvPFCString  
String sCommentFrn

//#2
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
DateTime	dtDteEnvCli
//#2 FIN

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	If lCpt = 1 Then sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#2
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	//#2
	sNumBonTrsp = stNul.str

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	This.uf_definir_codetat_MSS ( sVal, lCpt )
	sSql += "'" + sVal + "', "
	//#2
	sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ELV_MOBILE" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_EMIS_DEVIS" ) ) ), 19 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemDecimal ( lCpt, "MT_DEVIS" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #4 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	sVal = "null"
	// [PM254_V1]
	sVal = "null"
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sVal, "NOM_FIC_FRN", isNomFicOrig, ";")		
	sSql += "'" + sVal + "'"
	

	// #2
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #3
		F_commit ( SQLCA, False ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue // #3
	End If
	//#2 FIN
	
	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++		// #5
			F_commit ( SQLCA, True ) // #3
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #3

Return iRet 
end function

private subroutine uf_definir_codetat_mss (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_MSS (PRIVATE)
//* Auteur			: Catherine Abdmeziem
//* Date				: 20/09/2004
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: DCMP 040381 : ajout du nouveau fournisseur MSS
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli
DateTime dtDteRcpFrn, dtDteEnvCli
String	sDestEnvoi

asVal = Upper ( asVal ) 

/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return


/*------------------------------------------------------------------*/
/* !!!! Code état Déterminés en fonction des dates 					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Si le CodEtat du fichier n'est pas un de ces deux codes, alors   */
/* on va le déterminer à partir des dates.                          */
/*------------------------------------------------------------------*/
dtDteRcpFrn = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_FRN" ) 
dtDteEnvCli = idwFicFourn.GetItemDateTime ( alCpt, "DTE_ENV_CLI" )
sDestEnvoi	= idwFicFourn.GetItemString 	( alCpt, "DEST_ENVOI" )

dDteRcpFrn = Date ( dtDteRcpFrn )
dDteEnvCli = Date ( dtDteEnvCli )


If Not IsNull ( dDteEnvCli ) Then

	CHOOSE CASE sDestEnvoi	
		CASE "SPB"
			// Retourné à la SPB par le fournisseur
			asVal = "RSP"			

		CASE ELSE
			// ENVOYE AU CLIENT PAR LE FOURNISSEUR
			asVal = "ECL"			
	END CHOOSE

	// De plus si la dDteRcpFrn n'était pas renseigné
	//	On y met la dDteEnvCli
	If IsNull ( dDteRcpFrn ) Then idwFicFourn.SetItem ( alCpt, "DTE_RCP_FRN", dDteEnvCli )

ElseIf Not IsNull ( dDteRcpFrn ) Then

	// RECEPTIONNE CHEZ FOURNISSEUR
		asVal = "RCF"

Else
	// EN COURS CHEZ LE FOURNISSEUR
		asVal = "ECT"

End If



end subroutine

private function integer uf_ctrl_fichier_cegetel ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_CEGETEL (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 23/06/2005
//* Libellé			: Controler de la validité du fichier du CEGETEL
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #2	JFF	08/08/2008	  [DCMP080615]
//* #3   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, SIMEICorr , sIdFourCtrl
String   sIdRefFour1, sIdTypArt1 	// #2	[DCMP080615]
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
DateTime dtNull

Long	lIdSin, lIdSeq //#1

Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #1
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	// #2	[DCMP080615]
	If iRet > 0 Then
		sIdRefFour1 = Fill ( " ", 20 )
		sIdTypArt1  = Fill ( " ", 3 )
		SQLCA.PS_S10_COMMANDE (lIdSin, lIdSeq, sIdRefFour1, sIdTypArt1) 
	
		If sIdTypArt1 = "TEL" Then
			If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Un numéro d'IMEI doit contenir 15 chiffres" )
			End If
		
			If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then		
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Numéro d'IMEI non valide" )
			End If 
		End If
	End If
	// :#2	[DCMP080615]	
	
	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COD_ETAT_CMD														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "ANN", "RPC"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le code état doit être null ou égal à ANN ou RPC, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  // Normal, pas le choix
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If
	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_cegetel (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_CEGETEL (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 23/06/2005
//* Libellé			: Intégration du fichier du CEGETEL dans la base
//* Commentaires	: 
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	  24/04/2008  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	 FPI	  10/12/2009	[SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//        JFF    26/08/2013  [DT57_CMDE_IPHONE_SFR]
//       JFF   18/08/2014 [PM254_V1]
//       JFF   11/12/2024 [LGY15]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc
dateTime dtVal
n_cst_string lnvPFCString  

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli
// #1 FIN

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 


	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteRcpFrn = stNul.dtm

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
	

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
//	This.uf_definir_codetat_CEGETEL ( sVal, lCpt )
	sSql += "'" + sVal + "', "
	// #1
//	sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) ) // [LGY15]
	sDestEnvoi	= "CLIENT" // [LGY15] on force car sion le mail de swap ne part pas	

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	sVal = "null"
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sVal, "NOM_FIC_FRN", isNomFicOrig, ";")		
	sSql += "'" + sVal + "'"

	// #1
  	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If		
	// Fin #1

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
			alNbLigMod ++			// #4
			F_commit ( SQLCA, True ) // #2

		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private subroutine uf_definir_codetat_cegetel (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_CEGETEL (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 23/06/2005
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: 
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli
DateTime dtDteRcpFrn, dtDteEnvCli
String	sDestEnvoi

asVal = Upper ( asVal ) 

/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return


/*------------------------------------------------------------------*/
/* !!!! Code état Déterminés en fonction des dates 					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Si le CodEtat du fichier n'est pas un de ces deux codes, alors   */
/* on va le déterminer à partir des dates.                          */
/*------------------------------------------------------------------*/
dtDteRcpFrn = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_FRN" ) 
dtDteEnvCli = idwFicFourn.GetItemDateTime ( alCpt, "DTE_ENV_CLI" )
sDestEnvoi	= idwFicFourn.GetItemString 	( alCpt, "DEST_ENVOI" )

dDteRcpFrn = Date ( dtDteRcpFrn )
dDteEnvCli = Date ( dtDteEnvCli )


If Not IsNull ( dDteEnvCli ) Then

	CHOOSE CASE sDestEnvoi	
		CASE "SPB"
			// Retourné à la SPB par le fournisseur
			asVal = "RSP"			

		CASE ELSE
			// ENVOYE AU CLIENT PAR LE FOURNISSEUR
			asVal = "ECL"			
	END CHOOSE

	// De plus si la dDteRcpFrn n'était pas renseigné
	//	On y met la dDteEnvCli
	If IsNull ( dDteRcpFrn ) Then idwFicFourn.SetItem ( alCpt, "DTE_RCP_FRN", dDteEnvCli )

ElseIf Not IsNull ( dDteRcpFrn ) Then

	// RECEPTIONNE CHEZ FOURNISSEUR
		asVal = "RCF"

Else
	// EN COURS CHEZ LE FOURNISSEUR
		asVal = "ECT"

End If



end subroutine

private function integer uf_integration_fichier_cdiscount (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_CDISCOUNT (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 12/07/2005
//* Libellé			: Intégration du fichier du DEBITEL dans la base
//* Commentaires	: 
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #2 	 PHG	  24/04/2008  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #3	 FPI	  10/12/2009  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//        JFF   18/08/2014 [PM254_V1]
//        JFF   04/02/2020 [DT431]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig, sInfoFrnSpbCpltLu, sInfoFrnSpbCplt
Long		lTotLig, lCpt, lVal
n_cst_string lnvPFCString 

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemString ( lCpt, "DTE_SUIVI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
//	sVal = "null" [DT431]
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	/* [DT431]
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "CODE" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = ""
	This.uf_definir_codetat_CDISCOUNT ( sVal, lCpt )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "TYPE" ) ) )
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #2 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [DT431]
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemString ( lCpt, "DTE_MEP_BOA" ) ) ), 10 ) + "'"
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_MEP_BOA", sVal, ";")
	End If			

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		

	sSql += "'" + sInfoFrnSpbCplt + "'"
	
	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #1
		Else 
			iRet = -1
			alNbLigNonTraitee	++ // #1
			F_commit ( SQLCA, False ) // #1
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2
			Continue // #1
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++ // #1
		F_commit ( SQLCA, False ) // #1
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2
		Continue // #1
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #1

Return iRet 
end function

private function integer uf_ctrl_fichier_cdiscount ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_CDISCOUNT (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 12/07/2005
//* Libellé			: Controler de la validité du fichier du CDISCOUNT
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #2   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #3    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//			FPI	24/12/2013	[201312241000.FPI] Rejet des lignes Saga2
//       JFF   04/02/2020 [DT431]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve

Long	lIdSin, lIdSeq //#1

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #1
For lCpt = lTotLig To 1 Step -1

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		
		If lPos <= 0 Then 
			// [201312241000.FPI]
			If long ( sVal ) <= 5000000 Then
				This.uf_Trace ( "ECR", "INFO Ligne " + String ( lCpt ) + &
					" : C'est un sinistre SAGA2, la ligne ne sera pas traitée par SIMPA2." )
				idwFicFourn.Rowsdiscard( lCpt,lCpt, Primary!)
				Continue
			End If 
				
			This.uf_Trace ( "ECR", "INFO Ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB ne contient pas de '-', elle ne sera pas traitée." )
			idwFicFourn.Rowsdiscard( lCpt,lCpt, Primary!)
			Continue
			
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2

			If long ( sVal ) <= 5000000 Then
				This.uf_Trace ( "ECR", "INFO Ligne " + String ( lCpt ) + &
					" : C'est un sinistre SAGA2, la ligne ne sera pas traitée par SIMPA2." )
				idwFicFourn.Rowsdiscard( lCpt,lCpt, Primary!)
				Continue
			End If 
			
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : CODE																	  */
	/*------------------------------------------------------------------*/
	// Aucun contrôle

	/*------------------------------------------------------------------*/
	/* ZONE 4 : TYPE																	  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "TYPE" ) ) )

	If Not IsNumber ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le type doit être un nombre (et non '" + sval + "')" )
	End IF

	If iRet > 0 And ( Long (sVal) < 40 Or Long (sVal) > 43 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le type doit être compris entre 40 et 43 (et non '" + sVal + "')" )
	End IF

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_SUIVI															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DTE_SUIVI" ) ) )

	If Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : '" + sVal + "' n'est pas une date valide dans DTE_SUIVI" )
	End If 

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_MEP_BOA                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DTE_MEP_BOA" ) ) )

	If Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : '" + sVal + "' n'est pas une date valide dans DTE_MEP_BOA" )
	End If 


	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If
	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_cdiscount (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_CDISCOUNT (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 23/08/2001
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: 
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

asVal = "RFO"  // REPONSE FOURNISSEUR





end subroutine

private function decimal uf_determiner_montant_frais_envoi (string asfour, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction      : n_cst_w_commande3::uf_Determiner_Montant_Frais_Envoi (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 29/09/2005 11:06:05
//* Libellé       : DCMP 050549 M. Legac
//* Commentaires  : Gestion du montant des frais
//*
//* Arguments     : String		asFour				Val
//*					  Long		alIdSin				Val
//*					  Long		alIdSeq				Val
//*
//* Retourne      : Decimal	dcMtFrais	
//*						> 0      Montant des frais à régler
//*						-100		Aucun date de création de la commande trouvée.
//*						-200		Le reglement ne se fait pas SPB		
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1   MADM   09/05/2006   [DCMP060356] Remplacement du Fournisseur AEVUM/AVM par CORDON/COR	
//*
//*-----------------------------------------------------------------

/*------------------------------------------------------------------*/
/* Date pivot pour la mise en production. A partir du 11/10/2005,   */
/* on indique au client un remboursement de 8 Euros Sinon 10 E      */
/*------------------------------------------------------------------*/
DateTime dtCreeLe, dtCmdGenLe
String sMtFrais
Decimal {2} dcMtFrais			

Date dDatePivot_8_10, dCreeLe, dCmdGenLe, dDatePivotReglParSbe

dDatePivot_8_10 = 2005-10-11  // Jour de mise en production de 8E
dDatePivotReglParSbe	= 2005-12-19


/*------------------------------------------------------------------*/
/* Récupération de la date de création de la commande en base.      */
/*------------------------------------------------------------------*/
SQLCA.PS_S06_COMMANDE ( alIdSin, alIdSeq, dtCreeLe, dtCmdGenLe )
If SQLCA.SqlDbCode <> 0 Or SQLCA.SqlCode <> 0 Then return -100

dCreeLe = Date ( dtCreeLe )
If IsNull ( dCreeLe ) Or dCreeLe = 1900-01-01 Then return -100
dCmdGenLe = Date ( dtCmdGenLe )
If IsNull ( dCmdGenLe ) Or dCmdGenLe = 1900-01-01 Then return -100

Choose Case asFour

	// SBE
	Case "SBE"
		If dCreeLe >= dDatePivot_8_10 Then 
			If dCmdGenLe >= dDatePivotReglParSbe Then
				dcMtFrais = -200
			Else 
				dcMtFrais = 8
			End If 
		Else 
			dcMtFrais = 10
		End If
		
	/*--------------------------------------------------------------------------------------------*/	
	/* #1   MADM   09/05/2006   [DCMP060356] Remplacement du Fournisseur AEVUM/AVM par CORDON/COR */
	/*--------------------------------------------------------------------------------------------*/
	// Pour le Frn CORDON, SPB ne régle pas de frais d'envoi, c'est CORDON qui s'en charge.
	
	Case "COR"	
		dcMtFrais = -200

	Case Else
		dcMtFrais = -200

End Choose 

Return dcMtFrais



end function

public function boolean uf_ctrl_maj (long aidsin, long aidseq, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_ctrl_maj
//* Auteur			: JCA
//* Date				: 12/12/2007
//* Commentaires	: DCMP 70918
//*
//* Arguments		: 	aIdSin, Long, Val
//* 						aIdSeq, Long, Val
//* 						alCpt, long, val
//*
//* Retourne		:	Boolean
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #2	 JFF	 20/10/2008   [FNAC_PROD_ECH_TECH].[20090127140540720]
//* #3    JFF   02/09/2009   [DCMP090327].[SBETV]
//* #4    JFF   25/11/2009   [MSS_DIAG]
//* #5    JFF   15/01/2010   [O2M_DIAG_NOMADE].Lot2.JFF
//* #6    JFF   02/03/2010   [MSS_LOT2]
//*  		SBA	22/06/2010 	[DCMP100443]
//*			FPI	11/08/2010	[PM01] Gestion des -GC 167 & 168
//* 		 JFF     03/05/2011 [PM166][O2M]
//*       JFF   05/07/2011   [PC292][AUCHAN]
//*       JFF   19/09/2011   [PM82][LOT1]
// 		 JFF   13/02/2012   [VDOC6449]
//*      JFF   30/05/2012	   [VDOC7926]
//*      JFF   19/02/2013	   [VDOC9304_PM82_LOT1]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//       JFF   29/07/2013 [PC929-1]
//       JFF   30/12/2013 [PC13348&13408]
//       JFF   13/01/2014 [PM246]
//       JFF   28/03/2014 [DT081_EVOL_PRET_BRIS]
//       JFF   07/05/2013 [PM250-1]
//       JFF   02/10/2014 [VDOC15485]
//       JFF   25/11/2014 [PM251-2]
//       JFF   02/01/2015 [PC801_6_TAMET]
//       JFF   02/03/2015 [PM289_CDP]
//       JFF   09/04/2015 [DT141]
//       JFF   20/05/2015 [PM284-1]
//       JFF   24/06/2015 [ITSM302330]
//       JFF   30/06/2015 [DT156] ajout 304
// 		JFF   12/11/2015 [VDOC19112]
//       JFF   14/01/2016 [ITSM355855]   <> "ANN" partout
//       JFF   19/04/2016 [DT209]
// 		FPI	12/05/2016	[DT111]
//       JFF   11/10/2016 [DT076-2]
//       JFF   21/02/2107 [DT288]
//       JFF   29/08/2017 [DT288-3_LOT1_2EME_VS]
//       JFF   06/11/2017 [PC171933]
//       JFF   05/12/2017 [PM426-1]
//       JFF   30/05/2023 [PMO89_RS4822]
//       JFF   07/03/2024 [HP252_276_HUB_PRESTA]
//*-----------------------------------------------------------------

boolean bRet// [PM166][O2M]
string sIdFour, sCodEtat, sVal, sIdRefFour, sIdTypArt
integer iStatusGc, iInfoSpbFrn, iStatusGcLuFic
Long dcIdProd 
String sInfoSpbFrnCplt, sChaineBCV, sVal1, sVal2, sIdFournTrt
String sInfoFrnSpbCplt
n_cst_string lnvPFCString
DateTime dtVal 
Int iVal 

sIdFour = fill(" ", 3)
sCodEtat = fill(" ", 3)
sIdRefFour = fill(" ", 20) // 	[DCMP100443]
sIdTypArt = fill(" ", 3) // [PM166][O2M]

sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

bRet = true

sIdFournTrt = idwFourn.GetItemString ( 1, "ID_FOURN" )

//	[DCMP100443]
SQLCA.PS_S11_COMMANDE_V07 ( aidsin, aidseq, sIdFour, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV)

choose case sIdFour

	//* #1 [FNAC_PROD_ECH_TECH]
	//* #6 [FNAC_PROD_ECH_TECH].[20090127140540720] (165)
	//* #3 [DCMP090327].[SBETV]
	//* #4 [MSS_DIAG]
	//* #5 [O2M_DIAG_NOMADE].Lot2.JFF Ajout 166
	//* #6 [MSS_LOT2] ajout 176, 175
	//* [PC292][AUCHAN]
	//  [PM82][LOT1]
	//  [BLCODE]
	// [PC13348&13408]
	// [DT141] 
	// [DT209] 601, 602
	// [DT076-2]
	// [DT288]
	// [PC171933]
	// [RS3200]

//  "CIS"
	case "O2M", "MS1", "BLC", "MTT", "SBE", "BK2", "COR", "PAP", "CEA", "AGP", "TLS"

		// [PM246]
		sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "INFO_FRN_SPB_CPLT" ) ) )
		sVal = lnvPFCString.of_getkeyvalue (sVal1, "PRBLE_LIVRAISON", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_ARR_PLATFORM", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_ARR_CENTR_DISTRIB", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If
		
		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_DEP_CENTR_DISTRIB", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_RCP_MOB_CLI", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If			

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "CODE_ERREUR_LIVR", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If			

		// [PM251-2]
		sVal = lnvPFCString.of_getkeyvalue (sVal1, "REMIS_EN_STK", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If			

		// [DT081_EVOL_PRET_BRIS]
		sVal = lnvPFCString.of_getkeyvalue (sVal, "DTE_RESTIT_APP_PRET", ";")
		sVal2 = lnvPFCString.of_getkeyvalue (sVal, "ETAT_APP_PRET", ";")
		If ( Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 ) Or ( Not IsNull ( sVal2 ) And Len ( Trim ( sVal2 ) ) > 0 ) And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If			
			

		// [VDOC19112]
		sVal = Trim ( Upper ( lnvPFCString.of_getkeyvalue (sChaineBCV, "ID_BON_TRANSP", ";")))
		sVal2 = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "NUM_BON_TRP" ) ) )

		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And Not IsNull ( sVal2 ) And Len ( Trim ( sVal2 ) ) > 0 &
			And sVal <> sVal2 And sCodEtat <> "ANN" Then
		// On laisse, on accepte l'écrasement
			Return bRet
		End If			

		// [DT288-3_LOT1_2EME_VS]
		iStatusGcLuFic = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 
		If iStatusGcLuFic = 612 And iStatusGc <> 612 then
		// On laisse, on accepte l'écrasement
			Return bRet
		End If				

		choose case sCodEtat 
			case "RPC", "ANN", "RFO", "RSP"
				idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
				bRet = false
				Return bRet
		end choose

		// [VDOC25312]	269
		Choose Case iStatusGc
			Case 2, 21, 151 TO 155, 157, 160, 161, 165, 166, 170, 171, 172, 173, 176, 175, 167, 168, 178, 179, 303, 304, 601, 602  // [PM01] Ajout de 167,168, [PM284-1]
				
				// [PM82][LOT1]
				// [VDOC9304_PM82_LOT1]
				// [VDOC15485]
				If ( ( iStatusGc = 153 Or iStatusGc = 154 ) And sIdTypArt = "PRS" ) Then
					// On laisse, on accepte l'écrasement
				Else
					idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
					bRet = false
				End If
				
		End Choose
	//* :#1 [FNAC_PROD_ECH_TECH]		

		iStatusGcLuFic = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 
		If iStatusGcLuFic = 311 And iStatusGc <> 308 then
			idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
			bRet = True
		End If

	//* #3 [DCMP090327].[SBETV]
	case "SB1"
		
		// [VDOC19112]
		// [PM246]
		sVal = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "INFO_FRN_SPB_CPLT" ) ) )
		sVal = lnvPFCString.of_getkeyvalue (sVal, "PRBLE_LIVRAISON", ";")
		
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		// [PM250-1]
		sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "INFO_FRN_SPB_CPLT" ) ) )

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_ARR_PLATFORM", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_ARR_CENTR_DISTRIB", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If
		
		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_DEP_CENTR_DISTRIB", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_RCP_MOB_CLI", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If			

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "CODE_ERREUR_LIVR", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = Trim ( Upper ( lnvPFCString.of_getkeyvalue (sChaineBCV, "ID_BON_TRANSP", ";")))
		sVal2 = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "NUM_BON_TRP" ) ) )

		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And Not IsNull ( sVal2 ) And Len ( Trim ( sVal2 ) ) > 0 &
			And sVal <> sVal2 And sCodEtat <> "ANN" Then
		// On laisse, on accepte l'écrasement
			Return bRet
		End If
		
		Choose Case iStatusGc
			Case 153 TO 155, 157, 160, 161, 165

				idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
				bRet = false

			// [PC929-1]							
			Case 151, 171, 21, 152, 170
				// [VDOC6449]
				sVal = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "DTE_LIVR_SBE" ) ) )

				// Si sVal est une date valide, on laisse passer pour maj plus tard.
				If Not IsDate ( sVal ) Then
					idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
					bRet = false
				End If

		End Choose		
	//* :#3 [DCMP090327].[SBETV]
	
	Case "CDS"
		if iStatusGc > 0 then
			idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
			bRet = false
		end if

// [PC938_ORANGE_V3]
	Case "PSM"		
		
		// [PM246]
		sVal = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "INFO_FRN_SPB_CPLT" ) ) )
		sVal = lnvPFCString.of_getkeyvalue (sVal, "PRBLE_LIVRAISON", ";")
		
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		// [PM250-1]
		sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "INFO_FRN_SPB_CPLT" ) ) )

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_ARR_PLATFORM", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_ARR_CENTR_DISTRIB", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If
		
		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_DEP_CENTR_DISTRIB", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_RCP_MOB_CLI", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If			

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "CODE_ERREUR_LIVR", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If			


		// [VDOC19112]
		sVal = Trim ( Upper ( lnvPFCString.of_getkeyvalue (sChaineBCV, "ID_BON_TRANSP", ";")))
		sVal2 = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "NUM_BON_TRP" ) ) )

		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And Not IsNull ( sVal2 ) And Len ( Trim ( sVal2 ) ) > 0 &
			And sVal <> sVal2 And sCodEtat <> "ANN" Then
		// On laisse, on accepte l'écrasement
			Return bRet
		End If			
	
		
		Choose Case iStatusGc
			Case 263
				idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
				bRet = false
				
			Case Else
				choose case sCodEtat 
					case "RPC", "ANN", "RFO", "RSP"
						idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
						bRet = false
				end choose
				
		End Choose				

	// [PC801_6_TAMET]
	Case "TMT"
		
		// [PM246]
		sVal = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "INFO_FRN_SPB_CPLT" ) ) )
		sVal = lnvPFCString.of_getkeyvalue (sVal, "PRBLE_LIVRAISON", ";")
		
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		// [PM250-1]
		sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "INFO_FRN_SPB_CPLT" ) ) )

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_ARR_PLATFORM", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_ARR_CENTR_DISTRIB", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If
		
		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_DEP_CENTR_DISTRIB", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "DTE_RCP_MOB_CLI", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If			

		sVal = lnvPFCString.of_getkeyvalue (sVal1, "CODE_ERREUR_LIVR", ";")
		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
			// On laisse, on accepte l'écrasement
			Return bRet
		End If			


		// [VDOC19112]
		sVal = Trim ( Upper ( lnvPFCString.of_getkeyvalue (sChaineBCV, "ID_BON_TRANSP", ";")))
		sVal2 = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "NUM_BON_TRP" ) ) )

		If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And Not IsNull ( sVal2 ) And Len ( Trim ( sVal2 ) ) > 0 &
			And sVal <> sVal2 And sCodEtat <> "ANN" Then
		// On laisse, on accepte l'écrasement
			Return bRet
		End If			
		
		
		Choose Case iStatusGc
			Case 263
				idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
				bRet = false
				
			Case Else
				choose case sCodEtat 
					case "RPC", "ANN", "RFO", "RSP"
						idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
						bRet = false
				end choose
				
		End Choose		

	// [PM289_CDP]		
	Case "CDP"
		// Sinon, en prod lors dela désact de de clé, aucun contrôle, on prend tout 
		// le temps l'egnr car il peut s'agir du fichier d'anomalie			
	
		// [ITSM302330]
		If sIdFournTrt = "CDP" Then
			choose case sCodEtat 
				case "RPC", "ANN", "RFO", "RSP"
					idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
					bRet = false
			end choose
		End If
	
	// [DT111]
	Case "CMA"
		bRet=True

	// [PMO89_RS4822]
	Case "CDF"

		choose case sCodEtat 
			case "RPC", "ANN", "RFO", "RSP"
				idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
				bRet = false
				Return bRet
		end choose

		// [VDOC25312]	269
		Choose Case iStatusGc
			Case 810, 820
				
				idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
				bRet = false
				
		End Choose
		
	case else
		
		// [HP252_276_HUB_PRESTA]
		If F_CLE_A_TRUE ( "HP252_276_HUB_PRESTA" ) Then
			// Par défaut, si le fournisseur est lié au HP
			If ibPrestaHub Then
				sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( alCpt, "INFO_FRN_SPB_CPLT" ) ) )

				sVal = idwFicFourn.GetItemString ( alCpt, "NUM_BON_TRP" )
				iVal = idwFicFourn.GetItemNumber  ( alCpt, "STATUS_GC" )
				If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" And iVal = 0 Then
					// On laisse, on accepte l'écrasement
					Return bRet
				End If

				sVal = idwFicFourn.GetItemString ( alCpt, "NOM_TRANSPORTEUR" )
				iVal = idwFicFourn.GetItemNumber  ( alCpt, "STATUS_GC" )
				If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" And iVal = 0 Then
					// On laisse, on accepte l'écrasement
					Return bRet
				End If
				
				// [PM246]
				sVal = idwFicFourn.GetItemString ( alCpt, "PRBLE_LIVRAISON" )
				If Not IsNull ( sVal ) And Len ( Trim ( sVal ) ) > 0 And sCodEtat <> "ANN" Then
					// On laisse, on accepte l'écrasement
					Return bRet
				End If

				dtVal = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_APP_CLI" )
				If Not IsNull ( dtVal ) And sCodEtat <> "ANN" Then
					// On laisse, on accepte l'écrasement
					Return bRet
				End If			

				sVal = lnvPFCString.of_getkeyvalue (sVal1, "DDE_SAV", ";")
				If sVal="OUI" And sCodEtat <> "ANN" Then
					// On laisse, on accepte l'écrasement
					Return bRet
				End If			

				sVal = lnvPFCString.of_getkeyvalue (sVal1, "AUTO_PEC_RAR", ";")
				If sVal="OUI" And sCodEtat <> "ANN" Then
					// On laisse, on accepte l'écrasement
					Return bRet
				End If			

				choose case sCodEtat 
					case "RPC", "ANN", "RFO", "RSP"
						idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
						bRet = false
						Return bRet
				end choose
		
				Choose Case iStatusGc
					Case 2, 11, 12, 21, 151, 152, 155, 157, 160, 161, 165, 166, 170, 171, 172, 173, 176, 175, 167, 168, 178, 179, 303, 304, 601, 602  // [PM01] Ajout de 167,168, [PM284-1]
						
						idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
						bRet = false
						
				End Choose
				
			Else
				choose case sCodEtat 
					case "RPC", "ANN", "RFO", "RSP"
						idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
						bRet = false
				end choose
			End If		
		Else
			choose case sCodEtat 
				case "RPC", "ANN", "RFO", "RSP"
					idwFicFourn.RowsDiscard ( alCpt, alCpt, primary!)
					bRet = false
			end choose
		End If
		
		
end choose

return bRet
end function

private function integer uf_integration_fichier_o2m (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_O2M (PRIVATE)
//* Auteur			: PHG
//* Date				: 29/11/2007
//* Libellé			: Intégration du fichier O2M dans la base
//* Commentaires	: [O2M] Intégration de Fichier O2M
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #2    JFF   28/04/2008   [DCMP080202] MailPush O2M
//* #3	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #4	 FPI	 10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF   30/06/2010   [PC363_AUCHAN]
//*       JFF   07/03/2011   [VDOC3290]
//*       JFF   11/03/2011   [ITSM62176] ajout du point de décimal
//*       JFF   19/09/2011   [PM82][LOT1]
//*       JFF   05/01/2012   [RECUP_DONNEE_O2M]
//        JFF   06/08/2012   [BLCODE]
//       JFF   07/05/2013 	  [PC938_ORANGE_V3]
//       JFF   03/07/2013 		[VDOC9908]
//       JFF   08/04/2014 [PM255]
//       JFF   07/05/2013 [PM250-1]
//       JFF   02/06/2014 [PC929_CDISCOUNT][PC929-2-V3]
// 		FPI	21/07/2014 [PM250-1].FPI Correction réinit de date avant lecture de la ligne
//       JFF   18/08/2014 [PM254_V1]
//       JFF   25/08/2014 [DT100]
//       JFF   16/09/2014 [PM250-2]
//			JFF	25/09/2014		[MODIF_SUITE_REDR]
//       JFF   25/11/2014 		[PM251-2]
//       JFF   31/03/2016 [PM287-3]
//       JFF   17/05/2016 [PM280-2]
//       JFF   10/03/2017 [PM383-1]
//       JFF   04/04/2017 [VDOC23499]
//       JFF   06/11/2017 [PC171933]
//       JFF   07/02/2017 [VDOC25657]
//       JFF   07/02/2017 [VDOC25770]
//       JFF   17/04/2018 [DT288-4]
//       JFF   01/10/2018 [PM445-1]
//       JFF   28/01/2019 [PM450-1]
//       JFF   06/04/2023 [PMO139_RS4926]
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn, dtDteArrPlatForm, dtDteDepPlatForm 
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq
Decimal {2} dcMtFrais
String sInfoFrnSpbCplt  	// #3 [FNAC_PROD_ECH_TECH]
n_cst_string lnvPFCString  // [PC363_AUCHAN]

// #2 [DCMP080202]
Int iRetMailPush 
String sDestEnvoi, sNumBonTrsp 
DateTime dtDteEnvCli
// :#2 

String sCasRetour, sIdAppli, sBase, sCommentFrn 
Long lStatusGc 

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

sInfoFrnSpbCplt = ""
iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	// [MANTIS14172]
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	// [BLCODE]
	sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 			
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
 	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// [PM255] // [PM250-2]
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_O2M ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "
//	sCommentFrn = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	If Not IsNull( sInfoFrnSpbCpltLu ) and Trim ( sInfoFrnSpbCpltLu ) <> "" Then 
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 
		If IsDate ( sVal ) Then
			sVal = "'" + sVal + "'" 
		Else
			sVal = "null"		
		End IF			
	Else
		sVal = "null"		
	End If
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	  												  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "PIECE_JOINTE" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ", " // #1 [DCMP080199]

	/*------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#1 [DCMP080199]			  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NOM_TRANSPORTEUR" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ","

	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "


	// Préparation zone INFO_FRN_SPB_CPLT 
	// Trt zone virtuelle RDV_CONF vers sInfoFrnSpbCplt
	//* #3 [FNAC_PROD_ECH_TECH]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "RDV_CONF" ) ) )
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
// [PC363_AUCHAN]
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RDV_CONF", sVal, ";")
	End If
// [PC363_AUCHAN]

// [PC363_AUCHAN]
	If Not IsNull( sInfoFrnSpbCpltLu ) and Trim ( sInfoFrnSpbCpltLu ) <> "" Then 
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQUE_REMPL", ";")
		If Len ( Trim ( sVal ) ) > 0 Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQUE_REMPL", sVal, ";")
		End If

		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODELE_REMPL", ";")
		If Len ( Trim ( sVal ) ) > 0 Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODELE_REMPL", sVal, ";")		
		End If

		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_O2M", ";")
		If Len ( Trim ( sVal ) ) > 0 Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRIX_TTC_FACTU_O2M", sVal, ";")		
		End If	

		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_BLC", ";")
		If Len ( Trim ( sVal ) ) > 0 Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRIX_TTC_FACTU_BLC", sVal, ";")		
		End If	
		
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_PUBLIC", ";")
		If Len ( Trim ( sVal ) ) > 0 Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRIX_TTC_PUBLIC", sVal, ";")
		End If			
	End If

	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	// [VDOC3290]
	Choose Case sVal 
		Case "169" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")
		Case "162" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SYMP_NON_DETEC_EN_24H", "OUI", ";")			

		// [PM82][LOT1]
		Case "153" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_153", "OUI", ";")			
		// [PM82][LOT1]			
		Case "154" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_154", "OUI", ";")
		
		// [PM287-3]
		Case "311" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_311", "OUI", ";")

		
	End Choose
	// [VDOC3290]

	// [RECUP_DONNEE_O2M]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CGU_PRESENT", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CGU_PRESENT", sVal, ";")
	End If	
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DONNEES_RECUPEREES", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DONNEES_RECUPEREES", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_RECUPERE_PAR_ASSURE", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_RECUPERE_PAR_ASSURE", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PCT_DONNEES_RECUP", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PCT_DONNEES_RECUP", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "LOGIN_AXALOT", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "LOGIN_AXALOT", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DONNEES_TRANSFEREES_SUR_NOUVEL_APP", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DONNEES_TRANSFEREES_SUR_NOUVEL_APP", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MDP_AXALOT", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MDP_AXALOT", sVal, ";")
	End If	

	// [PC938_ORANGE_V3]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RESTIT_APP_PRET", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RESTIT_APP_PRET", sVal, ";")

		// [PM250-2]
		If IsNull ( dtDteRcpFrn ) And IsDate ( sVal ) Then
			dtDteRcpFrn = DateTime ( sVal )
		End If
	End If

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ETAT_APP_PRET", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ETAT_APP_PRET", sVal, ";")
	End If	
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQ_RST_FRN", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQ_RST_FRN", sVal, ";")
	End If		
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODL_RST_FRN", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODL_RST_FRN", sVal, ";")
	End If		

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_REF_FOUR_RST_FRN", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ID_REF_FOUR_RST_FRN", sVal, ";")
	End If		

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_HT_RST_FRN", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRIX_HT_RST_FRN", sVal, ";")
	End If		

	// [PM246]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If		
	// [PM246]

	// [PM250-1]
	SetNull(dtDteArrPlatForm) // [PM250-1].FPI
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_ARR_PLATFORM", ";")
	If IsDate ( sVal ) Then 
		dtDteArrPlatForm = DateTime ( sVal )
	End If
	
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_ARR_PLATFORM", sVal, ";")
	End If		

	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_ARR_CENTR_DISTRIB", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_ARR_CENTR_DISTRIB", sVal, ";")
	End If		
	
	SetNull(dtDteDepPlatForm) // [PM250-1].FPI
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_DEP_CENTR_DISTRIB", ";")
	If IsDate ( sVal ) Then 
		dtDteDepPlatForm = DateTime ( sVal )
	End If

	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_DEP_CENTR_DISTRIB", sVal, ";")
	End If		
	
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RCP_MOB_CLI", sVal, ";")
	End If		
	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CODE_ERREUR_LIVR", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CODE_ERREUR_LIVR", sVal, ";")
	End If		
	
	// [PC929_CDISCOUNT][PC929-2-V3]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "RDV_CONF", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RDV_CONF", sVal, ";")
	End If		

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	// [PM251-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "REMIS_EN_STK", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "REMIS_EN_STK", sVal, ";")
	End If		

	// [PM287-3]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "IFDNMQ_RET", sVal, ";")
	End If		

	// [PM280-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DECLASS_PCT", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DECLASS_PCT", sVal, ";")
	End If		

	// [PM280-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "A_CHARGE", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "A_CHARGE", sVal, ";")
	End If		

	// [DT280]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_SWAP", sVal, ";")
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TGR_APPSW", sVal, ";")	// Trigger Technique 
	End If		
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQSW", sVal, ";")
	End If			
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODLSW", sVal, ";")
	End If			

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MTTTCSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MTTTCSW", sVal, ";")
	End If			

	// [VDOC23499]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NEUF_REC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NEUF_REC", sVal, ";")
	End If		
	
	// [PM383-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "SOUS_GC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SOUS_GC", sVal, ";")
	End If			
		
	// [PC171933]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NOTIF_REPA", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOTIF_REPA", sVal, ";")
	End If		
	
	// [VDOC25657]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "GRADE_REC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "GRADE_REC", sVal, ";")
	End If	
	
	// [VDOC25770]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PROV_REC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PROV_REC", sVal, ";")
	End If	

	// [PM445-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "TYP_BA_ALLER", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TYP_BA_ALLER", sVal, ";")
	End If			

	// [PM445-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PERTE_ALLER", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PERTE_ALLER", sVal, ";")
	End If	
	
	// [PM450-1]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
	End If

	// [PMO139_RS4926]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DIAG_VIDEO_ENGAGE", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DIAG_VIDEO_ENGAGE", sVal, ";")
	End If
	
	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sSql += "'" + sInfoFrnSpbCplt + "'"

	// [DT288-4]
   sChaineMailRempl = sInfoFrnSpbCplt


	// #2 [DCMP080202]
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ 
		F_commit ( SQLCA, False ) 
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue 
	End If
	// :#2

	// [PM255] // [DT100] [PM250-2]
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, "CLIENT", sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If	

	// [PM250-1]
	iRetMailPush = SQLCA.PS_S_MAILPUSH_ARR_PLATFORM ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteArrPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_ARR_PLATFORM, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	
	iRetMailPush = SQLCA.PS_S_MAILPUSH_DEP_CENTRDISTRIB ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteDepPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_DEP_CENTRDISTRIB, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	// [PM250-1]	


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
	//		alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #4
			F_commit ( SQLCA, True )
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		
		// [MODIF_SUITE_REDR]
		sVal = SQLCA.SQLErrText		
		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")	

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + sVal )

		F_commit ( SQLCA, False )
			
		Continue 
	End If
	
	// [RECUP_DONNEE_O2M] Ici absolument, les données sont relues de la base !
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	Choose Case lVal	
		Case 178
			// Aucune action
/*		Case Else
			iRetMailPush = This.uf_MailPush ( "RECUP_DONNEES_MAIL_AXALOT", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
			If iRetMailPush <> 0 Then
				iRet = -1
				alNbLigNonTraitee	++ 
				F_commit ( SQLCA, False ) 
				This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECUP_DONNEES_MAIL_AXALOT, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
				Continue 
			End If */
	End Choose
Next

If alNbLigNonTraitee	> 0 Then iRet = -1

Return iRet 
end function

private function integer uf_ctrl_fichier_o2m ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_O2M (PRIVATE)
//* Auteur			: PHG
//* Date				: 29/11/2007
//* Libellé			: Controler de la validité du fichier O2M
//* Commentaires	: [O2M]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #2	JCA	12/12/2007		DCMP 70918
//* #3   JFF	20/10/2008		[FNAC_PROD_ECH_TECH]
//* #4   JFF	30/04/2009		[DCMP090109]
//* #5   JFF	14/05/2009		[DCMP090085]
//* #6   JFF   02/09/2009 		[DCMP090327].[SBETV]
//* #7   JFF   07/12/2009     [MSS_DIAG].[20091207111441740]
//* #8   JFF   28/12/2009     [20091228114718123]
//* #9	FPI	25/01/2010	   [DCMP090759] 
//*      JFF   04/05/2010     [DCMP100333]
//*   	SBA	25/06/2010 	   [BUG.CTRLFICSUIVI]
//*		FPI	11/08/2010	   [PM01] Ajout des retours 167 & 168
//*      JFF   22/09/2010     [PM01].[LOT3&4]
//* 		JFF   03/05/2011     [PM166][O2M]
//* 		JFF   06/05/2011     [VDOC3731]
//* 		FPI   19/08/2011     [VDoc4752]
//*      JFF   09/09/2011     [PC499][PC501][PC545][-1x3][V5]
//*      JFF   19/09/2011     [PM82][LOT1]
//* 		JFF   06/05/2011     [VDOC5774]
//* 		FPI   01/12/2011     [VDoc6082]
//*      JFF   05/01/2012 		[RECUP_DONNEE_O2M]
//*      JFF   23/01/2012     [VDOC6300]
//*      JFF   20/03/2012     [CTRL_IMEI_O2M] ajout contrôle IMEI
//*      JFF   04/04/2012     [MANTIS3067] satut 231
//*      JFF   30/05/2012	   [VDOC7926]
//       JFF   06/08/2012     [BLCODE]
//       JFF   30/08/2012     [VDOC8041]
//       JFF   26/11/2012     [PC877]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   10/01/2013     [VDOC9907]
//       JFF   10/01/2013     [VDOC10029]
//       JFF   19/02/2013	   [VDOC9304_PM82_LOT1]
//       JFF   07/05/2013 		[PC938_ORANGE_V3]
//       JFF   03/07/2013 		[VDOC9908]
//       JFF   09/09/2013 		[VDOC10641]
//       JFF   09/09/2013 		[PM222-1]
//       JFF   30/12/2013 [PC13348&13408]
//		   FPI	28/07/2014	[20140728.FPI] Ajout ctl de longueur
//			JFF	25/09/2014		[MODIF_SUITE_REDR]
//       JFF   02/10/2014 [VDOC15485]
// 		JFF   05/02/2015 [PC13321][MANTIS14042]
// 		JFF	24/03/2015 [VDOC17191]
//       JFF   20/05/2015 [PM284-1]
//		   FPI	02/06/2015 [PM222-1]
//       JFF   05/06/2015 [VDOC17633]
//       JFF   20/07/2015 [DT150]
//       JFF   11/09/2015 [VDOC18200]
//		   FPI	22/09/2015 [ITSM326003] ajout ctl IMEI sur commande de rempl
//       JFF   06/11/2015 [VDOC18931]
//       JFF   29/03/2016 [DT200]
//       JFF   31/03/2016 [PM287-3]
//       JFF   17/05/2016 [PM280-2]
//       JFF   21/11/2016 [DT280]
//       JFF   23/01/2017 [DT290]
//       JFF   10/03/2017 [PM383-1]
//       JFF   04/04/2017 [VDOC23499]
//       JFF   04/05/2017 [DT288-1_LOT2]
//       JFF   21/06/2017 [IRREP_QUALIFIE]
// 		JFF	25/08/2017 [CTRLE_REF_A_REEXP]
//       JFF   29/08/2017 [DT288-3_LOT1_2EME_VS]
// 		JFF	22/09/2017 [CTRLE_DATE_INTRG_FOU]
//       JFF   07/02/2017 [VDOC25657]
//       JFF   22/02/2017 [VDOC25770]
//       JFF   23/05/2018 [PM280-2][V3]
//       JFF   01/10/2018 [PM445-1]
//       JFF   21/11/2018 [VDOC27123]
//       JFF   28/01/2019 [PM450-1]
//       JFF   15/05/2019 [DT386_EXTR_AXA]
//       JFF   20/09/2021 [BUG_RST_PRIX_O2M]
//       JFF   06/04/2023 [PMO139_RS4926]
//*-----------------------------------------------------------------
Int iRet, iStatusGc, iInfoSpbFrn
String	sIdFour, sVal, sCar, sIdFourCtrl, sInfoFrnSpbCpltLu, sIMEICorr
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sVal1, sVal2, sVal3
String sInfoFrnSpbCplt, sIdTypArtSin
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal, lVal1
Boolean	bTrouve
datastore	dsCode
Long dcIdProd, lTot
String sInfoSpbFrnCplt, sChaineBCV
String sTabVal[], sTabNull[]

Long	lIdSin, lIdSeq //#2
datetime	dtVal, dtVal1
n_cst_string lnvPFCString  

iRet = 1

lTotLig = idwFicFourn.RowCount ()

// [MODIF_SUITE_REDR]
If lTotLig <= 0 And FileLength64 ( isTxtNomFic.Text ) > 0 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR : 0 Ligne chargée ! , pour PI : Taille du fichier positive et chargement à 0 ligne => Anormal. Réessayez l'intégration (cause éventuelle => le fichier est peut-être en format Unicode au lieu d'Ansi, à vérifier)." )
End If		

sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 		// #9

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	// [PM445-1]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = "" 

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
	// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If
	End If
	
	// [PM82][LOT1]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	
	sIdTypArtSin = lnvPFCString.of_getkeyvalue (sChaineBCV, "TYP_APP_DS", ";") 
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	// [BLCODE]
	If sVal <> sIdFour And sVal <> "BLC" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 
	// [BLCODE]

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_RCP_FRN										*/
	/*------------------------------------------------------------------*/
	// #9
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	// [DCMP100333]
	// [PM166][O2M] 177, 178
	Choose Case lVal
		Case 155, 156, 157, 158, 160, 161, 163, 164, 165, 174, 177, 178
			If Not isNull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End if

		// [PM01].[LOT3&4]
		// [PC499][PC501][PC545][-1x3][V5]
		// [VDOC8041] 232
		// [PM445-1]
		Case 151, 152, 153, 154, 159, 162, 166, 167, 168, 169, 2, 21, 175, 232
			// [PC13321][MANTIS14042]
			sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PERTE_ALLER", ";"))
			If isNull(dtVal) And iInfoSpbFrn <> 957 And sVal <> "OUI" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être renseignée.")
			End if
			
			// [PC13321][MANTIS14042]			
			If Not isNull(dtVal) And iInfoSpbFrn = 957 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", et pour le process spécifique 957, la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End If			

	End Choose

	If Not IsNull ( dtVal ) And Date ( dtVal ) <> 1900-01-01 Then
		If Year ( Date (dtVal )) < 2000 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") l'année de la date de réception n'est pas valide." )
		End If
	End If
	// Fin #9
	
	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	// [CTRL_IMEI_O2M]
	If sIdTypArtSin = "TEL" Then 
		sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )
	
		If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Un numéro d'IMEI doit contenir 15 chiffres" )
		End If
	
		If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Numéro d'IMEI non valide" )
		End If 
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_FIN_TRAIT									  */
	/*------------------------------------------------------------------*/
	// #9
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	// [DCMP100333]
	// [PM01].[LOT3&4]
	// [PM166][O2M] 177
	// [PM01] Ajout de 167,168
	// [PC499][PC501][PC545][-1x3][V5]
	Choose Case lVal
		Case 151, 152, 153, 154, 155, 160, 161, 165, 166, 167, 168, 2, 21, 167, 168, 177, 178, 175

			// [PM82][LOT1]
			If ( lVal = 153 Or lVal = 154 ) And sIdTypArt = "PRS" Then
				If Not Isnull (dtVal) Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					", PM82_LOT1 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + " en réparation, la date de fin de traitement (DTE_FIN_TRAIT) ne doit pas être renseignée.")
				End If

			Elseif Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être renseignée.")
			End if
		// [VDOC8041] 232
		Case 156, 157, 158, 159, 162, 163, 164, 169, 232, 174
			if Not Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être vide.")
			End if
			
		Case Else
			If ( lVal = 0 Or IsNull ( lVal ) ) And Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Lorsque la date de fin de traitement (DTE_FIN_TRAIT) est renseignée, un statut GC est obligatoire.")
			End If 
			
	End Choose
	// Fin #9

	If Not IsNull ( dtVal ) and  Date ( dtVal ) <> 1900-01-01 Then
		If Year ( Date (dtVal )) < 2000 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") l'année de la date DTE_FIN_TRAIT n'est pas valide." )
		End If
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 6 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
	If IsNull ( sVal ) Then sVal = ""	
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal
			
		Case 177, 178
			If IsNull ( sVal ) Or Len ( sVal ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) )
			End If
		//  [VDoc4752]
		Case 165
			If iInfoSpbFrn = 970 and (IsNull ( sVal ) Or Len ( sVal ) <= 0 ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) +  " pour le process 970.")
			End If
		// :[VDoc4752]
	End Choose

	// [MODIF_SUITE_REDR]
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "NUM_BON_TRP", Trim ( sVal ) )
	
	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )

	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
//	if dsCode.retrieve('-GC') > 0  then											// #9 - Chargement au début de la fct
			// #3 [FNAC_PROD_ECH_TECH] agrandissement jusqu'à 160
			// #4 [DCMP090109] ajout 2, 21
			// #5 [DCMP090085] ajout jusqu'à 169
			// #6 [DCMP090327].[SBETV] (171)
			// [PM166][O2M]
			// [MANTIS3067] ajout 231
			// [VDOC10641] 174
			// [PM287-3] not in 305, 306
		if dsCode.find("( ID_CODE BETWEEN 151 AND 171 " + &
							"	OR ID_CODE IN (2, 21, 263, 264, 266 ) " + &
							"  OR ID_CODE BETWEEN 174 AND 179 " + &
							"  OR ID_CODE BETWEEN 231 AND 239" + &							
							"  OR ID_CODE BETWEEN 301 AND 399" + &														
							") AND ID_CODE = " + sVal + &
							"  AND ID_CODE NOT IN ( 305, 306, 232, 309, 310 ) " &
							, 1, dsCode.RowCount()+1 ) = 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
		End If			
//	End IF			// #9

// [PM166][O2M]
// [PM82][LOT1] je remonte cette linge plus haut.
// [RECUP_DONNEE_O2M] PCM 
// [VDOC4970]
// [PM250] Modif suite demande d'Hélène (et O2M)
	Choose Case Upper ( sIdTypArt ) 
		Case "EDI", "PRS", "PCM"
			Choose Case Long ( sVal ) 
				Case 177, 178
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC " + sVal + " n'est autorisé que pour les commandes de matériel (hors Batterie amovible BAM et Câble d'alimentation ALE)" )
			End Choose
		Case Else
			Choose Case Long ( sVal ) 
				Case 177, 178, 176, 233, 263, 234, 235, 236, 237,238, 239, 301, 304
					
					// [PC938_ORANGE_V3]
					// C'est Ok
					// [MODIF_SUITE_REDR]
					If Long ( sVal ) = 234 Then
						If Not ( sIdTypArt = "REA") And Not ( sIdTypArt = "PST" And Trim ( lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt, "TYP_RELAI", ";")) <> "PRET" ) Then
							iRet = -1
							This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
							" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Status GC " + sVal + " autorisé uniquement sur une presta de type PST sans PRET ou une presta de type REA" )
						End If
					End If 
					
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Status GC " + sVal + " non autorisé pour une commande de matériel (hors Batterie amovible BAM et Câble d'alimentation ALE)" )

			End Choose
			
	End Choose
// :[PM166][O2M]

	// [VDOC3731]
	Choose Case iInfoSpbFrn
		// [VDOC5774] 435, 1502
		Case 1503, 1504, 435, 1502, 1506
			Choose Case Long ( sVal ) 
				Case 166
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
			
		Case 1505
			Choose Case Long ( sVal ) 
				Case 167, 168
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
		// [VDoc4752]
		Case 970
			Choose Case Long ( sVal )
					// [VDoc6082] ajout du statut_gc 164
				Case 165,164
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
			// :[VDoc4752]
			
		// [VDOC6300] // [PC877]
		Case 964, 969
			Choose Case Long ( sVal )
				Case 179
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose			
			
	End Choose		

	Choose Case Long ( sVal ) 
		Case 166
			// [VDOC5774] 435, 1502
			Choose Case iInfoSpbFrn
				Case 1503, 1504, 435, 1502, 1506
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		Case 167, 168
			Choose Case iInfoSpbFrn
				Case 1505
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		// [VDOC6300] // [PC877]
		Case 179
			Choose Case iInfoSpbFrn
				Case 964, 969
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
	End Choose			
	// :[VDOC3731]	

	// [VDOC8041]
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal 
		Case 232
			If Upper ( sIdTypArt ) <> "PRS" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If

	End Choose

	Choose Case sIdTypArt  
		Case "PRS"
			// OK
		Case Else
			If lVal = 232 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If

	End Choose
	// [VDOC8041]

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COMMENT_FRN														     */
	/*------------------------------------------------------------------*/
	// Pas de Controle Particulier
	// [MODIF_SUITE_REDR]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "COMMENT_FRN", Trim ( sVal ) )
	
	/*------------------------------------------------------------------*/
	/* ZONE 9 : PJ	: Controle et Transformation								  */
	/*					  Doit Etre O ou N											  */
	/*------------------------------------------------------------------*/
		// [PC13348&13408]
		Choose Case sIdFour
			Case "MTT"
				// Zone absence, on ne controle pas
			Case Else	
				sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "PIECE_JOINTE" ) )
			
				CHOOSE CASE sVal
					CASE	'O'
						idwFicFourn.SetItem( lCpt, "PIECE_JOINTE", '1') 
					CASE	'N'
						idwFicFourn.SetItem( lCpt, "PIECE_JOINTE", '2') 
					CASE ELSE
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") L'indicateur PIECE_JOINTE doit contenir 'O' ou 'N'" )
				End Choose	
	   END CHOOSE

	/*------------------------------------------------------------------*/
	/* ZONE   : info_frn_spb_cplt													  */
	/*------------------------------------------------------------------*/
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	
	If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = "" 

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";"))
	If len ( Trim ( sVal ) ) > 0 And Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone sérialisée DTE_RCP_MOB_CLI ne contient pas une date valide" )
	End If 

	If Not IsNull ( sVal ) And Date ( sVal ) <> 1900-01-01 Then
		If Year ( Date (sVal )) < 2000 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") l'année de la date DTE_RCP_MOB_CLI n'est pas valide." )
		End If
	End If


	// [PC938_ORANGE_V3]
	If len ( Trim ( sVal ) ) > 0 Then 
		Choose Case lVal 
			Case 178, 233, 263, 234, 2, 21
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone sérialisée DTE_RCP_MOB_CLI ne peut être renseignée sans le statut 178, 233, 263, 234, 2, 21" )
		End Choose
	End If

	// [PC938_ORANGE_V3]
	If len ( Trim ( sVal ) ) > 0 And ( lVal = 178 Or lVal = 233 Or lVal = 263 ) And ( IsNull ( dtVal ) Or Date ( dtVal ) = 1900-01-01 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone DTE_FIN_TRAIT doit être renseignée avant de renseigner la zone DTE_RCP_MOB_CLI et de donner le statut 178 ou 233 ou 263" )
	End If

  /* [VDOC9908]		
	If lVal = 178 And len ( Trim ( sVal ) ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut 178 oblige à avoir la zone sérialisée DTE_RCP_MOB_CLI renseignée." )
	End If
	*/
	// [PM166][O2M]

	// [VDOC7926]
	Choose Case dcIdProd
		Case 41101, 41103 
			
			sVal  = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQUE_REMPL", ";"))	
			sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODELE_REMPL", ";"))	
			sVal2 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_PUBLIC", ";"))	
			sVal3 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_O2M", ";"))	

			If len ( Trim ( sVal ) ) > 0 OR len ( Trim ( sVal1 ) ) > 0 OR len ( Trim ( sVal2 ) ) > 0 OR len ( Trim ( sVal3 ) ) > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7926) : Les binômes clés/valeurs pour les clés MARQUE_REMPL, MODELE_REMPL, PRIX_TTC_PUBLIC, PRIX_TTC_FACTU_O2M ne sont pas autorisés pour le produit " + String ( dcIdProd ) + "." )
			End If
			
	End Choose
	// :[VDOC7926]

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	
	
	// [VDOC9907]
	// Mettre en place pour O2M ces règles, rejet du fichier MPR si : 
	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un status_gc différent de 21 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If lVal <> 21 And ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9907/A.RAULT) : présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un status_gc différent de 21 , interdit " )
	End IF

	// Mettre en place pour O2M ces règles, rejet du fichier MPR si : 
	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour à une commande avec action = A_REPARER ou A_REPARER_FORCE 
	// [PM222-1]	
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) &
		 And ( sIdRefFour = "A_REPARER" Or sIdRefFour = "A_REPARER_FORCE" ) &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REP_GARANTIE", ";") <> "OUI" &		 
	Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9907/A.RAULT) : présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour sur une commande sans demande de SAV (donc n’impliquant pas d’action = A_REPARER_SAV ou A_CONTROLER_SAV ), interdit" )
	End IF 
	// :[VDOC9907]
	
	// [VDOC10029]	
	sVal1 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_O2M", ";")
	sVal2 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_BLC", ";")
	sVal3 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_PUBLIC", ";")
	
	If IsNumber ( sVal1 ) Then
		sVal = sVal1
	End If	

	If IsNumber ( sVal2 ) Then
		sVal = sVal2
	End If	

	If IsNumber ( sVal ) And IsNumber ( sVal3 ) Then
		
		If Dec ( sVal ) > Dec ( sVal3 ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC10029/A.RAULT) : le montant du prix facturable par O2M concernant la proposition est supérieur au prix public indiqué, ce qui est incohérent" )
		End If
		
	End If
	// [VDOC10029]		
	
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "ORANGE_V3", ";") = "OUI" Then
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		If sIdRefFour = "A_DIAGNOSTIQUER" And lVal <> 151 And lVal <> 152 And lVal <> 159 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (ORANGE V3) : Pour Orange v3, seul le 151 ou 152 sont autorisé sur le Diag après remplacement" )
		End IF 
	End IF 			
	// [PC938_ORANGE_V3]

	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	If sIdRefFour = "RUPTURE_STOCK" And lVal = 178 Then

		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODL_RST_FRN", ";"))						
		If sVal = "" or Len(sVal) <=0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MODL_RST_FRN obligatoire pour une commande de type INFO_RUPTURE_STOCK." )
		End if
		
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQ_RST_FRN", ";"))						
		If sVal = "" or Len(sVal) <=0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MARQ_RST_FRN obligatoire pour une commande de type INFO_RUPTURE_STOCK." )
		End if
	
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_REF_FOUR_RST_FRN", ";"))						
		If sVal = "" or Len(sVal) <=0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée ID_REF_FOUR_RST_FRN obligatoire pour une commande de type INFO_RUPTURE_STOCK." )
		End if
		
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_HT_RST_FRN", ";"))						
		If sVal = "" or Len(sVal) <=0 Then			
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée PRIX_HT_RST_FRN obligatoire pour une commande de type INFO_RUPTURE_STOCK." )
		End if		

		// [BUG_RST_PRIX_O2M]
		If IsNumber ( sVal ) Then
			If Long ( sVal) = 0 Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée PRIX_HT_RST_FRN obligatoire pour une commande de type INFO_RUPTURE_STOCK." )
			End if		
		End If 
		
		// [VDOC23499]
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NEUF_REC", ";"))
		Choose Case sVal
			Case "NEU", "REC"
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280/VDOC23499) : le BCV NEUF_REC est obligatoire pour une commande de type INFO_RUPTURE_STOCK et doit contenir les valeurs NEU ou REC." )
		End Choose 			
		
		// [VDOC25657]
		If Pos ( sInfoFrnSpbCpltLu, "GRADE_REC=" ) > 0 Then
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "GRADE_REC", ";"))
			If IsNull ( sVal ) Then sVal = 'vide'
			If Not IsNumber ( sVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (vDoc25657) : La valeur " + sVal + " n'est pas autorisée pour le bcv GRADE_REC. La valeur doit être numérique entre 0 et 9." )
			End If
		End If
		
		// [VDOC25770]
		If Pos ( sInfoFrnSpbCpltLu, "PROV_REC=" ) > 0 Then
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PROV_REC", ";"))
			If IsNull ( sVal ) Then sVal = 'vide'

			Choose Case sVal
				Case "AIG", "O2M"
					// OK
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (vDoc25770) : La valeur " + sVal + " n'est pas autorisée pour le bcv GRADE_REC. La valeur doit être AIG ou O2M." )
			End CHoose 				
		End If
	End If
	
	// [20140728.FPI] 
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODL_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 35 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MODL_RST_FRN trop longue (35 caractères maximum autorisés)." )
	End if
	
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQ_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 35 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MARQ_RST_FRN trop longue (35 caractères maximum autorisés)." )
	End if

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_REF_FOUR_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 20 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée ID_REF_FOUR_RST_FRN trop longue (20 caractères maximum autorisés)." )
	End if
	
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_HT_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 0 And Not IsNumber ( sVal )  Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée PRIX_HT_RST_FRN doit être un nombre décimal (montant)." )
	End if		
	
	// [20140728.FPI] 

	
	// [MODIF_SUITE_REDR]
	Choose Case iStatusGc
		Case 176, 151, 152, 2, 21
	
			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			// [VDOC17191] je ne déclenche pas le message sur le 159
			Choose Case lVal
				Case 301, 159, 156
					// Ok
				Case Else
					If iStatusGc <> lVal Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
					End If

			End CHoose
			
	End CHoose
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 155 And sIdRefFour <> "REFUSE_A_REEXP" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " ne peut être renvoyé que sur une prestation de type REFUSE_A_REEXP" )
	End If

	// [CTRLE_REF_A_REEXP]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal <> 155 And sIdRefFour = "REFUSE_A_REEXP" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") une prestation de type REFUSE_A_REEXP ne peut recevoir qu'un Statut 155 en retour, et non " + String ( lVal ) + "." )
	End If
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	Choose Case sIdRefFour  
		Case "A_REPARER_FORCE", "A_DIAG_FORCE"

			If lVal > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il est interdit de répondre sur les prestations de type A_REPARER_FORCE, et A_DIAG_FORCE, or vous renvoyez le Statut " + String ( lVal ) + ". Si une réponse doit être apportée, vous devez répondre sur la préstation d'origine liée à ce forçage." )
			End If
	End Choose		
	
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	// [DT288-3_LOT1_2EME_VS] 612
	Choose Case lVal
		Case 152, 21, 612
			
			If IsNull ( sVal ) Or sVal = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " doit obligatoirement être accompagné d'un commentaire." )
			End If
			
	End CHoose

	// [PM251-2]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") <> "OUI" Then
		sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "REMIS_EN_STK", ";"))		
		If sVal1 = "OUI" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " n'est autorisé que pour une commande de remplacement." )
		End If	
	End If

	// [PM284-1]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	If lVal = 303 Then
		Choose Case dcIdProd
			Case 35800, 35801, 35802, 35803, 80500, 80501, 80502, 80503, 44500, 44501, 44502, 44503
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " n'est pas autorisé pour le produit " + string ( dcIdProd ) + "." )
		End Choose 
	End If			
	
	// [PM222-1]

	// [DT150]
	/*
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
		If lVal = 305 And lnvPFCString.of_getkeyvalue (sChaineBCV, "GESTION_GEOLOCALISATION", ";") <> "OUI" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le produit " + String ( dcIdprod ) + " n'est pas éligible au projet DT150 gérant la géolocalisation. Si ce projet doit rentrer dans ce périmètre, voir avec DPG pour ajouter le produit, sinon transmettre l'information au fournisseur que ce produit est interdit pour ce code retour." )
		End If
		
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
		If lVal = 306 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Statut de retour interdit ! " + String ( lVal ) + "." )
		End If 
	*/
	
	// [ITSM326003]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") = "OUI" Then
		sVal1 = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI" ))
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
		Choose Case lVal 
			Case 177, 178
				If isnull(sVal1) Or sVal1 = "" Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le numéro de série/IMEI de l'appareil de remplacement n'est pas renseigné." )
				End If	
		End Choose 
	End If
	
	// [VDOC18200]
	If Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "ETAT_APP_PRET", ";") ) > 0 Then
		If Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "DTE_RESTIT_APP_PRET", ";") ) <= 0 And &
			Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCplt, "DTE_RESTIT_APP_PRET", ";") ) <= 0 Then 

			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") : Retour du BCV ETAT_APP_PRET sans le BCV DTE_RESTIT_APP_PRET, interdit." )
		End If
	End If
	// [VDOC18200]	
	
	// [DT200]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt, "NE_PAS_REPARER", ";"))
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	If sVal = "OUI" Then
			Choose Case lVal
				Case 2
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Réparation interdite sur ce type de prestation, il faut répondre 21 Irréparable dans tous les cas et qualifier l'irréparabilité dans le commentaire par un mot clé." )
			End Choose 
	End if

	// [PM287-3]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
/*
	If lVal = iStatusGc And lVal = 308 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le statut retour 308 est déjà présent sur ce dossier, le fournisseur l'a déjà envoyé et doit donc attendre le retour de l'assuré et ne plus retourner d'information sur cette prestation pour l'instant, voir livraison PM287-3." )
	End If
*/	

	// [DT288-1_LOT2]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 311 And iStatusGc <> 308 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le statut retour 311 n'est autorisé que si le dernier statut envoyé par le fournisseur est 308, voir livraison PM287-3." )
	End If

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	lVal1 = Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") )
	If lVal = 308 And lVal1 <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le statut retour 308 vous oblige à renseigner le bcv IFDNMQ_RET (InFos DoNnées ManQuante RETour) avec un codage particulier, voir livraison PM287-3." )
	End If

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	lVal1 = Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") )
	If lVal <> 308 And lVal1 > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + String ( lVal ) + " interdit la présence du bcv IFDNMQ_RET (InFos DoNnées ManQuante RETour) dans la zone sérialisée, voir livraison PM287-3." )
	End If


	If lVal = 308 And lVal1 > 0 Then
		sVal2 = "#305#232#"
		sVal  = lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") 
		sVal3 = lnvPFCString.of_getkeyvalue (sChaineBCV, "DNCX_STATUS_GC", ";") 
		lnvPFCString.of_parsetoarray( sVal,"#", sTabVal )

		lTot = UpperBound ( sTabVal ) 

		For lCptVal = 1 To lTot
			If IsNull ( sTabVal [lCptVal] ) Or Trim ( sTabVal [lCptVal] ) = "" Then Continue 
			
			If Pos ( sVal2, "#" + sTabVal [lCptVal] + "#" ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La valeur #" + sTabVal [lCptVal] + "# n'est pas autorisée dans le BCV IFDNMQ_RET pour le statut 308, voir livraison PM287-3." )
			End If

			If iRet > 0  Then
				If Pos ( sVal3, "#" + sTabVal [lCptVal] + "#" ) > 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La valeur #" + sTabVal [lCptVal] + "# est interdite pour le statut 308/BCV IFDNMQ_RET pour le produit " + String ( dcIdprod ) + ", voir livraison PM287-3." )
				End If
			End If
		Next 
	
	End IF
	
	// [PM280-2]
	// [PM280-2][V3] PNV
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REP_GARANTIE", ";") 
	sVal1= String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	
	
	// [VDOC27123]
	If lVal = 21 And sVal = "OUI" And &
		( Pos ( sVal1, "[PNC]") <= 0 And &
		  Pos ( sVal1, "[BRIS]") <= 0 And &
		  Pos ( sVal1, "[SAV_NO_OK]") <= 0 And &
		  Pos ( sVal1, "[BVIEOX]") <= 0 And &
		  Pos ( sVal1, "[EXP]") <= 0  And &			  
		  Pos ( sVal1, "[BVIE]") <= 0  And &			  
		  Pos ( sVal1, "[NOSPBS]") <= 0 And &
		  Pos ( sVal1, "[PNV]") <= 0 And &
		  Pos ( sVal1, "[BVID]") <= 0 And & 
		  Pos ( sVal1, "[BVIP]") <= 0 And & 				 
		  Pos ( sVal1, "[BVIT]") <= 0 ) & 				 
		  Then

			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" /PM280-2 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il manque dans le commentaire un des mots clés obligatoire qualifiant l'irréparable." )

	End If 
	
	
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "A_CHARGE", ";"))
	If Len ( sVal ) > 0 Then
		Choose Case sVal 
			Case "O2M", "SPB"
				// Ok
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" /PM280-2 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Les seules valeurs possbiles pour le bcv A_CHARGE sont : O2M et SPB (voir FTU PM280-2)." )
				
		End Choose 
		
		If sIdRefFour <> "CONTEST_SUR_REMPL" Then
			iRet = -1				
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" /PM280-2 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le bcv A_CHARGE ne peut être donné que sur une prestation de contestation (voir FTU PM280-2)." )
		End If
		
	End If

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DECLASS_PCT", ";"))
	If Len ( sVal ) > 0 Then
		If Not IsNumber ( sVal ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" /PM280-2 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le bcv DECLASS_PCT doit avoir une valeur numérique entre 0 et 100 (valeur entre 0.x et 1 exclues)." )
		End If
		
		If sIdRefFour <> "CONTEST_SUR_REMPL" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" /PM280-2 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le bcv DECLASS_PCT ne peut être donné que sur une prestation de contestation (voir FTU PM280-2)." )
		End If
		
	End If


	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DECLASS_PCT", ";"))
	If Len ( sVal ) > 0 And IsNumber ( sVal ) Then
		If Dec ( sVal ) >= 0.01 And Dec ( sVal ) < 1 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" /PM280-2 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le bcv DECLASS_PCT doit avoir une valeur numérique entre 0 et 100 (valeur entre 0.x et 1 exclues)." )
		End If

	End If

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	If sIdRefFour = "CONTEST_SUR_REMPL" Then
		// [PM280-2][V3] 159
		Choose Case lVal
			Case 151, 152, 153, 154, 159
				// ok
			
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" /PM280-2 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Les prestations de contestation n'autorise que les retours 151, 152, 153, 154." )
				
		End Choose 
	End If
		
	// [DT280]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))		
	If sVal = "OUI" Then
		
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		


		// [VDOC27123]BVID/BVIP/BVIT
		If ( &
				( lVal = 21 ) And Not ( Pos (sVal,  "[BVIE]" ) > 0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &
				Or &
				( lVal = 23 ) And Not ( Pos (sVal,  "[BVIEOX]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &					
				Or &
				( lVal <> 21 And lVal <> 23 ) &
			) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Le SWAP O2M n'est autorisé que sur un irréparable 21/23 avec un mot clé [BVIE]/[BVID]/[BVIP]/[BVIT]/[BVIEOX] ou [PIE]." )
		End If 				
			
		If iRet > 0 Then
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";"))		
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP O2M le BCV MARQSW doit être renseignée avec la marque IFR du nouveau matériel." )
			End If 	
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";"))		
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP O2M le BCV MODLSW doit être renseigné avec le modèle IFR du nouveau matériel." )
			End If 					

			If iRet > 0 Then
				Choose Case sIdTypArtSin
					Case "TEL", "TPC"
						// Autorisé
					Case Else 
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Type d'appareil (" + sIdTypArt+ ") non autorisé pour un SWAP O2M." )
				End Choose
			End If 

			// Controle binome marq/modl appartient à IFR à ajouter
			If iRet > 0 Then
				sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";"))
				sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";"))
				If SQLCA.PS_S_VERIF_MARQ_MODL_IFR_V01 ( dcIdprod, sIdTypArtSin, sVal, sVal1 ) <= 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP O2M, pour ce dossier, la Marque et le Modèle du nouveau matériel (" + sVal + " " + sVal1 + ") doivent appartenir au référentiel IFR." )
				End If
			End If
			
			sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI" ) ) // Le ctrle de validité est faite plus haut
			If Trim ( sVal ) = "" Or IsNull ( sVal )  Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP O2M la zone NUM_IMEI doit être renseignée par l'IMEI (ou numéro de série si Tablette) du nouveau matériel." )
			End If 					


			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MTTTCSW", ";"))
			If Trim ( sVal ) = "" Or Not IsNumber ( sVal ) Or Pos ( sVal, ",") > 0 Or Pos ( sVal, "E") > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP O2M le BCV MTTTCSW doit être renseigné avec le montant TTC de l'appareil de remplacement (avec un point en séparateur de décimal)." )
			End If 

			// [BUG_RST_PRIX_O2M]
			If IsNumber ( sVal ) Then
				If Long ( sVal) = 0 Then 
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP O2M le BCV MTTTCSW doit être renseigné avec le montant TTC de l'appareil de remplacement (avec un montant positif)." )
				End if		
			End If 


			// [VDOC23499]
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NEUF_REC", ";"))
			Choose Case sVal
				Case "NEU", "REC"
					// Ok
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280/VDOC23499) : le BCV NEUF_REC est obligatoire et doit contenir les valeurs NEU ou REC." )
			End Choose 

			// [VDOC25657]
			If Pos ( sInfoFrnSpbCpltLu, "GRADE_REC=" ) > 0 Then
				sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "GRADE_REC", ";"))
				If IsNull ( sVal ) Then sVal = 'vide'
				If Not IsNumber ( sVal ) Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (vDoc25657) : La valeur " + sVal + " n'est pas autorisée pour le bcv GRADE_REC. La valeur doit être numérique entre 0 et 9." )
				End If
			End If

			// [VDOC25770]
			If Pos ( sInfoFrnSpbCpltLu, "PROV_REC=" ) > 0 Then
				sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PROV_REC", ";"))
				If IsNull ( sVal ) Then sVal = 'vide'

				Choose Case sVal
					Case "AIG", "O2M"
						// OK
					Case Else
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (vDoc25770) : La valeur " + sVal + " n'est pas autorisée pour le bcv GRADE_REC. La valeur doit être AIG ou O2M." )
				End CHoose 				
			End If
	
			
			sVal = idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) 
			sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		

			If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP O2M, Le numéro de bon transporteur est obligatoire." )
			End IF 

		End If		
	End If
	
	// [DT290]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))					
	If iInfoSpbFrn = 984 And sVal <> "OUI" And sIdTypArt <> "PST" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT290) : Sur un process 984, le SWAP est obligatoire, pas de process alternatif donc le bcv APP_SWAP doit obligatoirement être à OUI." )
	End If
	
	// [PM383-1]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "SOUS_GC", ";"))
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	
	If sVal = "OUI" Then
		Choose case lVal 
			Case 2, 22
				//ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM383-1) : le bcv SOUS_GC=OUI n'est accepté qu'avec le retour 2 (réparé)." )
		End Choose 
	End If
	// [PM383-1]
	
	// IRREP_QUALIFIE
	sVal1= String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	
	// [PM280-2][V3] PNV
	// [VDOC27123]BVID/BVIP/BVIT
	// [PMO139_RS4926] [PRDV]
	If lVal = 21 And &
		( &
		  Pos ( sVal1, "[BNVSOX]") <= 0 And &
		  Pos ( sVal1, "[CRSMTPEC]") <= 0 And &
		  Pos ( sVal1, "[BNV]") <= 0 And &
		  Pos ( sVal1, "[OXY]") <= 0 And &
		  Pos ( sVal1, "[PIE]") <= 0 And &
		  Pos ( sVal1, "[PNC]") <= 0 And &
		  Pos ( sVal1, "[BRIS]") <= 0 And &
		  Pos ( sVal1, "[SAV_NO_OK]") <= 0 And &
		  Pos ( sVal1, "[BVIEOX]") <= 0 And &
		  Pos ( sVal1, "[EXP]") <= 0  And &			  
		  Pos ( sVal1, "[BVIE]") <= 0  And &			  
  		  Pos ( sVal1, "[PNV]") <= 0  And &			  
		  Pos ( sVal1, "[NOSPBS]") <= 0 And & 
		  Pos ( sVal1, "[BVID]") <= 0 And & 
		  Pos ( sVal1, "[BVIP]") <= 0 And & 				 
		  Pos ( sVal1, "[BVIT]") <= 0 And &
		  Pos ( sVal1, "[PRDV]") <= 0 &		  
		  ) &
		  Then

			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il manque dans le commentaire un des mots clés obligatoire qualifiant l'irréparable." )

	End If 

	// [DT288-3_LOT1_2EME_VS]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If sIdRefFour = "INFORMATION" And lVal <> 612 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") : un flux de type INFORMATION ne peut avoir pour réponse qu'un statut 612" )
	End IF 

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  			
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "COLIS_PND", &
				  "COLIS_NRPAC", &
				  "COLIS_PERDU", &
				  "COLIS_BALNI", &
				  "COLIS_INCOR", &
				  "COLIS_REFUS", &
				  "ANNUL_REFAIT", &
				  "EN_ATTENTE", &
				  "AUTRE", &
				  "J1", &
				  "J2", &
				  "J3", &
				  "J4", &
				  "J5", &
				  "J6" 
			
					// Ok
					
			Case Else 

				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
	End If 

	// [PM445-1]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") <> "OUI" Then
		sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "TYP_BA_ALLER", ";"))
		If IsNull ( sVal ) Then sVal = ""

		sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
		If IsNull ( sVal1 ) Then sVal1 = ""		

		dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")			
		
		If IsNull ( dtVal ) And sVal1 <> "" And sVal = "" And sIdRefFour <> "REFUSE_A_REEXP" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Un numéro de tracking ALLER doit être accompagné du bcv TYP_BA_ALLER." )
		End IF
		
		If sVal <> "" Then
			Choose Case sVal
				Case "BPPAYE", &
					  "RPICKUP"
				
						// Ok
						
				Case Else 
	
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé TYP_BA_ALLER, n'est pas valide." )
	
			End Choose 
		End If 
		
		// [PM445-1]
		sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PERTE_ALLER", ";"))
		If IsNull ( sVal ) Then sVal = ""

		IF sVal = "OUI" Then

			sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))
			If IsNull ( sVal1 ) Then sVal1 = ""
	
			sVal2 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "TYP_BA_ALLER", ";"))
			If IsNull ( sVal2 ) Then sVal2 = ""
	
			sVal3 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
			If IsNull ( sVal3 ) Then sVal3 = ""	
	
			dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	
			lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
			If IsNull ( lVal ) Then lVal = 0				
			
			If sVal2 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le type de BA aller n'est compatible avec une perte aller." )
			End If 
			
			If sVal1 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le bcv PRBLE_LIVRAISON doit être renseigné." )
			End If 
			
			If sVal3 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le numéro de tracking (NUM_BON_TRP) doit être renseigné." )
			End If 

			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, la date de réception ne doit pas être renseignée." )
			End If 
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))		
			If lVal <> 0 AND ( lVal <> 21 AND sVal <> "OUI" ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le statut ne doit pas être renseigné." )
			End If 
		End IF 
	End If	

	// [PM450-1]
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";"))
	sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))	

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""		
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PEC_PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
		
		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la clé PEC_PRBLE_LIVRAISON n'est autorisée que si précédemment il y a au un clé PRBLE_LIVRAISON, qui est justement absente." )
		End If 			
	End If 	
	
	// [DT386_EXTR_AXA]
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	sVal =  lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "BUYBACK", ";") 

	If lVal = 152 And sVal = "OUI" Then
		// Qualificatif du 152 Non Conforme 
		sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "QUALIF_NC", ";"))
	
		If IsNull ( sVal ) Then sVal = ""

		Choose Case sVal
			Case "APP_DEGRADE", &
				  "APP_INCOMPLET", &
				  "APP_DETERIORE", &
				  "DTE_ACH_NC", &
				  "PRIX_ACH_NC", &
				  "BIEN_NC"
					// Ok
					
			Case Else 
				If sVal = "" Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") sur un retour 152/BuyBack, le BCV QUALIF_NC est obligatoire dans la chaine sérialisée avec une valeur valide." )
				Else 
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé QUALIF_NC, n'est pas valide." )
				End If	
		End Choose 
		
	End If 

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
	Choose Case sIdRefFour 
		Case "A_REPARER"
			
			Choose Case lVal 
					
				Case 151, 152, 170, 171
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le code retour " + String ( lVal ) + " n'est pas valide pour un retour de REPARATION (c'est un retour valable pour un diagnostic)." )
			
			End Choose 				
			
	End Choose 

	// [PMO139_RS4926]
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "DIAG_VIDEO_ENGAGE", ";"))

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé DIAG_VIDEO_ENGAGE, n'est pas valide. les valeurs autorisées sont OUI ou NON." )

		End Choose 
	End If 	

	// Coder au dessus de cette ligne.

	
	// #6 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then
		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

if isvalid(dsCode) Then destroy dsCode

Return iRet

end function

private function integer uf_ctrl_fichier_micromania ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_MICROMANIA (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 09/09/2008
//* Libellé			: Controler de la validité du fichier MICROMANIA
//* Commentaires	: [MICROMANIA]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    02/09/2009  [MICROMANIA].[20090902155334733] on tronque aux 20 premiers
//* #3    JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sVal2, sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
Long	lIdSin, lIdSeq //#2

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )


//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_SIN_FLX                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_SIN_FLX" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DECISION 															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "DECISION" ) )
	
	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone DECISION est vide." )
	End If 
	
	If NOT ISNUMBER ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone DECISION attend une valeur numérique." )
	End If
	
	If ISNUMBER ( sVal ) Then
		If Long ( sVal ) < 201 or Long ( sVal )  > 203 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : La valeur de la zone DECISION est incorrect." )
		End If
	End If
	
	/*------------------------------------------------------------------*/
	/* ZONE 4 : DTE_DECISION                                            */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DTE_DECISION" ) ) )

	sVal2 = Right ( sVal, 2) + "/" + Mid ( sVal, 5, 2 ) + "/" + Left ( sVal , 4 ) 

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone DTE_DECISION est vide." )
	End If 

	If NOT ISDATE ( sVal2 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone DTE_DECISION ne contient pas une date valide." )
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 5 : MARQ_APP    														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "MARQ_APP" ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone MARQ_APP est vide." )
	End If 

	/*------------------------------------------------------------------*/
	/* ZONE 6 : MODL_APP    														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "MODL_APP" ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone MODL_APP est vide." )
	End If 

	/*------------------------------------------------------------------*/
	/* ZONE 7 : PRIX_TTC																  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "PRIX_TTC" ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone PRIX_TTC est vide." )
	End If 
	
	If NOT ISNUMBER ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone PRIX_TTC attend une valeur numérique." )
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_SERIE" ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone NUM_SERIE est vide." )
	// #1 [MICROMANIA].[20090902155334733] 
	Else
		sVal = Left ( sVal, 20 )
		idwFicFourn.SetItem ( lCpt, "NUM_SERIE", sVal )
	End If 	
	// :#1 [MICROMANIA].[20090902155334733] 

	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If
	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_micromania (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_MICROMANIA (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 09/09/2008
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [MICROMANIA]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli
DateTime dtDteRcpFrn, dtDteEnvCli
String	sDestEnvoi

asVal = Upper ( asVal ) 
asVal = "RPC"


end subroutine

private function integer uf_integration_fichier_micromania (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_MICROMANIA (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 09/09/2008
//* Libellé			: Intégration du fichier du MICROMANIA dans la base
//* Commentaires	: [MICROMANIA]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    11/02/2009 [20090211133609560]
//* #2	FPI	10/12/2009	[SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011 [ITSM62176] ajout du point de décimal
//        JFF    18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet
DateTime dtDteRcpFrn, dtDteEnvCli
String	sSql, sVal, sSqlOrig, sIdFour, sVal2 
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq, lStatusGc
Decimal {2}  dcMtFrais 
n_cst_string lnvPFCString
String sCommentFrn

//#2
String   sMesRetour, sNumBonTrsp, sDestEnvoi	
Int iRetMailPush

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 
	
	If lCpt = 1 Then sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_SERIE" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = Left ( Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_DECISION" ) ), 8 ) 
	sVal2 = "'" + Right ( sVal, 2) + "/" + Mid ( sVal, 5, 2 ) + "/" + Left ( sVal , 4 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal2 + ", "
	//#2
	dtDteEnvCli = DateTime ( Date ( sVal2 ), 00:00:00 )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	sNumBonTrsp = ""

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = "RPC"
	This.uf_definir_codetat_MICROMANIA ( sVal, lCpt )
	sSql += "'" + sVal + "', "
	//#2
	sDestEnvoi	= "CLIENT"

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = idwFicFourn.GetItemString ( lCpt, "DECISION" ) 
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_EMIS_DEVIS" ) ) ), 19 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal+ ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = String ( idwFicFourn.GetItemDecimal ( lCpt, "MT_DEVIS" ) )
//	If IsNull ( sVal ) Then sVal = "0"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "ALT_DEV_ACP" ) ) )
//	If IsNull ( sVal ) Then sVal = "N"
//	sSql += "'" + sVal + "', "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_DEV_ACP" ) ) ), 10 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_BTE_FRN" ) ) ), 19 ) + "'"
//
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_BTE_CLI" ) ) ), 19 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_DEP_BTE_CLI" ) ) ), 19 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #5 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "MARQ_APP" ) ) )
	If IsNull ( sVal ) Then sVal = ""
	sSql += "'" + sVal + "', "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "MODL_APP" ) ) )
	If IsNull ( sVal ) Then sVal = ""
	sSql += "'" + sVal + "', "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "PRIX_TTC" ) ) )
	If IsNull ( sVal ) Then sVal = ""
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	sVal = "null"
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sVal, "NOM_FIC_FRN", isNomFicOrig, ";")		
	sSql += "'" + sVal + "'"


	/*------------------------------------------------------------------*/
	/* #1 : Reglement automatique                                       */
	/*------------------------------------------------------------------*/
/* #1 [20090211133609560]
	dcMtFrais = This.uf_Determiner_Montant_Frais_Envoi ( sIdFour, lIdSin, lIdSeq )

	Choose Case dcMtFrais 
		Case -100
			iRet = -1
		Case -200
			// SPB ne règle rien, c'est le fournisseur qui s'en charge.
		Case Else 
			iRet = This.uf_ReglAuto ( lIdSin, &
											  lIdSeq, &
											 sIdFour ,&
											 dtDteRcpFrn, &
											 dcMtFrais , &
											 sMesRetour )
	End Choose 
*/

	If iRet >=0 Then iRet = 1
	If iRet < 0 Then 
		iRet = -1
		alNbLigNonTraitee	++ // #3
		F_commit ( SQLCA, False ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème d'insertion règlement automatique " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : " + sMesRetour  ) // #3
		Continue // #3
	End If


	// #2
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #3
		F_commit ( SQLCA, False ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue // #3
	End If
	
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #3
		F_commit ( SQLCA, False ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue // #3
	End If				
	// Fin #2

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #2
			F_commit ( SQLCA, True ) // #3
		Else 
			iRet = -1
			alNbLigNonTraitee	++ // #3
			F_commit ( SQLCA, False ) // #3
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #4
			Continue // #3
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++ // #3
		F_commit ( SQLCA, False ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #4
		Continue // #3
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #3

Return iRet 
end function

private function integer uf_ctrl_fichier_cdiscountpro ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_CDISCOUNTPRO (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 20/04/2009
//* Libellé			: Controler de la validité du fichier du CDISCOUNTPRO
//* Commentaires	: [DCMP090102]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #2   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #3    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//       JFF   20/12/2012     [VDOC9337]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sTypArtOrig, sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1
Long	lIdSin, lIdSeq //#2

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	sTypArtOrig = space ( 3 )
	SQLCA.PS_S13_COMMANDE ( lIdSin, lIdSeq, sTypArtOrig )
	
	If sTypArtOrig = "TEL" Then
		If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Un numéro d'IMEI doit contenir 15 chiffres" )
		End If
	
		If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Numéro d'IMEI non valide" )
		End If 
	Else
		If IsNull ( sVal ) Or sVal = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : La zone NUM_SERIE est vide." )
		End If 
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COD_ETAT_CMD														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "ANN", "RPC"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le code état doit être null ou égal à ANN ou RPC, mais pas " + sVal )
		END CHOOSE

	End If

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// :[VDOC9337]	

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	// #2 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_ctrl_fichier_phoneandphone ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_PHONEANDPHONE (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 20/04/2009
//* Libellé			: Controler de la validité du fichier du PHONEANDPHONE
//* Commentaires	: [DCMP090140]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #3    JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//          JFF   20/12/2012     [VDOC9337]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr,sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1
Long	lIdSin, lIdSeq //#2
datastore	dsCode
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 	

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Un numéro d'IMEI doit contenir 15 chiffres" )
	End If

	If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Numéro d'IMEI non valide" )
	End If 

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.


	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	
//	if dsCode.retrieve('-GC') > 0  then											// #9 - Chargement au début de la fct
			// #3 [FNAC_PROD_ECH_TECH] agrandissement jusqu'à 160
			// #4 [DCMP090109] ajout 2, 21
			// #5 [DCMP090085] ajout jusqu'à 169
			// #6 [DCMP090327].[SBETV] (171)
			// [PM166][O2M]
			// [MANTIS3067] ajout 231
			// [VDOC10641] 174
			// [PM287-3] not in 305, 306

		if dsCode.find("  ID_CODE = " + sVal + &
							"  AND ID_CODE IN ( 178 ) " &
							, 1, dsCode.RowCount()+1 ) = 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
		End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// :[VDOC9337]	

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_cdiscountpro (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_CDISCOUNTPRO (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/03/2006
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [DCMP090102]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli
DateTime dtDteRcpFrn, dtDteEnvCli
String	sDestEnvoi

asVal = Upper ( asVal ) 

/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return


/*------------------------------------------------------------------*/
/* !!!! Code état Déterminés en fonction des dates 					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Si le CodEtat du fichier n'est pas un de ces deux codes, alors   */
/* on va le déterminer à partir des dates.                          */
/*------------------------------------------------------------------*/
dtDteRcpFrn = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_FRN" ) 
dtDteEnvCli = idwFicFourn.GetItemDateTime ( alCpt, "DTE_ENV_CLI" )
sDestEnvoi	= idwFicFourn.GetItemString 	( alCpt, "DEST_ENVOI" )

dDteRcpFrn = Date ( dtDteRcpFrn )
dDteEnvCli = Date ( dtDteEnvCli )


If Not IsNull ( dDteEnvCli ) Then

	CHOOSE CASE sDestEnvoi	
		CASE "SPB"
			// Retourné à la SPB par le fournisseur
			asVal = "RSP"			

		CASE ELSE
			// ENVOYE AU CLIENT PAR LE FOURNISSEUR
			asVal = "ECL"			
	END CHOOSE

	// De plus si la dDteRcpFrn n'était pas renseigné
	//	On y met la dDteEnvCli
	If IsNull ( dDteRcpFrn ) Then idwFicFourn.SetItem ( alCpt, "DTE_RCP_FRN", dDteEnvCli )

ElseIf Not IsNull ( dDteRcpFrn ) Then

	// RECEPTIONNE CHEZ FOURNISSEUR
		asVal = "RCF"

Else
	// EN COURS CHEZ LE FOURNISSEUR
		asVal = "ECT"

End If



end subroutine

private function integer uf_integration_fichier_cdiscountpro (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_CDiscountPRO (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Intégration du fichier du CDiscountPRO dans la base
//* Commentaires	: 
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	FPI	10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//       JFF   18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc
String sCommentFrn

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli
n_cst_string lnvPFCString  

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteRcpFrn =  idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	This.uf_definir_codetat_CDISCOUNTPRO ( sVal, lCpt )
	sSql += "'" + sVal + "', "
	//#1
	sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	sval = "null"
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sVal, "NOM_FIC_FRN", isNomFicOrig, ";")		
	sSql += "'" + sVal + "'"


	// #1
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If				
	// Fin #1

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++					// #4
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private function integer uf_integration_fichier_phoneandphone (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_PhoneAndPhone (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Intégration du fichier du CDiscountPRO dans la base
//* Commentaires	: 
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	FPI	10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//       JFF   18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc
String sCommentFrn, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu

//#1
String   sNumBonTrsp, sDestEnvoi, sIdFour
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli
n_cst_string lnvPFCString 

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteRcpFrn =  idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_PHONEANDPHONE ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "
	//#1

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")

	// [PM246]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If		
	// [PM246]
		
	sSql += "'" + sInfoFrnSpbCplt + "'"


	// #1
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If				
	// Fin #1

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #4
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++ // #2
			F_commit ( SQLCA, False ) // #2			
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2
			Continue // #2
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2			
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2
		Continue // #2
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private function integer uf_ctrl_fichier_sbetv ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_SBETV (PRIVATE)
//* Auteur			: JFF
//* Date				: 02/09/2009
//* Libellé			: Controler de la validité du fichier SBETV
//* Commentaires	: [DCMP090327].[SBETV]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #2	JCA	12/12/2007		DCMP 70918
//* #3   JFF	20/10/2008		[FNAC_PROD_ECH_TECH]
//* #4   JFF	30/04/2009		[DCMP090109]
//* #5   JFF	14/05/2009		[DCMP090085]
//* #6    JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//* #7    JFF   28/12/2009  [20091228114718123]
//* #8	FPI	25/01/2010	[DCMP090759] 
//* #9	FPI	05/02/2010	[DCMP090759].[20100205.FPI] Ajout du même contrôle pour SBE TV
//*		SBA	22/06/2010 [DCMP100443]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//* 		 JFF     04/11/2010 [PC301].[LOT2]
//			FPI	19/10/2011	[VDoc5609] Renforcement des contrôles
//			FPI	05/11/2011	[VDoc6249] Correction cotrôle sur GC 170 & 171
//			JFF   23/12/2011  [VDOC6410] sur PEC_A_RECYCLER, DTE_LIVR_BROKER obligatoire
// 		 JFF   13/02/2012   [VDOC6449]
//*      JFF   30/05/2012	   [VDOC7926]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   09/09/2013 		[VDOC10641]
//       JFF   02/06/2014 [PC929_CDISCOUNT][PC929-2-V3]
//*-----------------------------------------------------------------

Int iRet, iStatusGc, iInfoSpbFrn
String	sIdFour, sVal, sCar, sCodEtat, sIdFourCtrl,sIdRefFour, sIdTypArt, sIdFourBase, sChaineBCV
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datastore	dsCode
String   sInfoFrnSpbCpltLu, sVal1
String sInfoFrnSpbCplt
n_cst_string lnvPFCString
Long dcIdProd 
String sInfoSpbFrnCplt
datetime	dtVal, dtVal1

Long	lIdSin, lIdSeq //#2
iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.Retrieve( "-GC" )	// #8

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sIdFourBase = fill(" ", 3)
	sCodEtat = fill(" ", 3)
	sIdRefFour = fill(" ", 20) // 	[DCMP100443]
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	// #9 [DCMP090759].[20100205.FPI] 
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	
	If Not isNull(dtVal) Then
		lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
		// 	[VDoc5609]
		Choose Case lVal
			Case 156, 157, 158, 160, 161, 163, 174 // 	[VDoc5609] Ajout du 174
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
		End Choose
		
	Else
		// 	[VDoc5609] Date obligatoire
		lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
		Choose Case lVal
			// 	[VDoc6249] Suppr GC 170,171
			Case 151, 152, 162, 169
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être renseignée.")
		End Choose
		// 	:[VDoc5609]
	End if
	// Fin  #9
	
	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	// [O2M].M383 : Anomalie Mantis : On ne vérifie pas l'IMEI.
	
//	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI" ) )
//
//	If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
//		iRet = -1
//		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
//		" : Un numéro d'IMEI doit contenir 15 chiffres" )
//	End If

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_FIN_TRAIT									  */
	/*------------------------------------------------------------------*/
	// #9 [DCMP090759].[20100205.FPI] 
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	
	Choose Case lVal
		Case 151, 152, 153, 154, 155, 161, 165, 2, 21, 170, 171
			if Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être remplie.")
			End if
		Case 156, 157, 158, 159, 160, 162, 163, 164, 169
			if Not Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être vide.")
			End if
	End Choose
	// Fin #9
	
	/*------------------------------------------------------------------*/
	/* ZONE 6 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.

	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )

	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
//	if dsCode.retrieve('-GC') > 0  then											// #8 - déplacement du retrieve
			// #3 [FNAC_PROD_ECH_TECH] agrandissement jusqu'à 160
			// #4 [DCMP090109] ajout 2, 21
			// #5 [DCMP090085] ajout jusqu'à 169
		if dsCode.find("( ( ID_CODE BETWEEN 151 AND 174 ) Or ( ID_CODE IN ( 2, 21 ) ) ) AND ID_CODE = "+sVal, 1, dsCode.RowCount()+1 ) = 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le Status GC est inconnu !" )
		End If
//	End IF			// #8

	// Demandé par AUR le 18/09 suite retour de test de recette.
	// [DCMP100443]
	SQLCA.PS_S11_COMMANDE_V07 ( lIdSin, lIdSeq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )
	Choose Case Long ( sVal )
		Case 170, 171
			If iStatusGc = 162 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le statut 171 ou 170 incohérent alors qu'un statut GC 162 se trouve déjà en base." )
			End If
			
	End Choose
	
	// [VDoc6249]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	if Long(sVal)=171 and isNull(dtVal) And iInfoSpbFrn <> 1120 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être renseignée.")
	End if
	//:[VDoc6249]
	
	// [PC301].[LOT2]
	Choose Case Long ( sVal )
		Case 170, 171, 156, 174
			// Code Accepté	
		Case Else
			If iInfoSpbFrn = 1120 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Code retour interdit (" + sVal + ") pour un process 1120." )
			End If 
	End Choose
	// :[PC301].[LOT2]

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COMMENT_FRN														     */
	/*------------------------------------------------------------------*/
	// Pas de Controle Particulier
	
	/*------------------------------------------------------------------*/
	/* ZONE 9 : PJ	: Controle et Transformation								  */
	/*					  Doit Etre O ou N											  */
	/*------------------------------------------------------------------*/
	idwFicFourn.SetItem( lCpt, "PIECE_JOINTE", '2') 

	//* #6   JFF   02/09/2009 		[DCMP090327].[SBETV]
	// Ctrl dte rdv
	// [VDOC6449]
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_LIVR_SBE" ) )
	If Not IsNull ( sVal ) or Len ( sVal ) > 0 Then
		If Not Isdate ( sVal ) Then
			iRet =-1
			// [VDOC6449]
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : La date de centralisation chez SBE/2ES n'est pas valide" )
		End If
	End If

	// [VDOC6410] 		
	// [VDOC6449]	
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_LIVR_SBE" ) )
	If sIdRefFour = "PEC_A_RECYCLER" and ( IsNull ( sVal ) Or Len ( sVal ) <= 0 ) Then
		iRet =-1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La DTE_LIVR_SBE est obligatoire (sur zone sérialisée) pour une prestation du type PEC_A_RECYCLER" )
	End If

	/*------------------------------------------------------------------*/
	/* ZONE   : info_frn_spb_cplt													  */
	/*------------------------------------------------------------------*/
	// [PM166][O2M]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = "" 

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ETAT_SG", ";"))
	If len ( Trim ( sVal ) ) > 0 And sVal <> "REPARE" And sVal <> "IRREPARABLE" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Mauvaise valeur dans la zone ETAT_SG" )
	End If 
	
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "TV_HG", ";"))
	If len ( Trim ( sVal ) ) > 0 And sVal <> "OUI" And sVal <> "NON" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Mauvaise valeur dans la zone TV_HG" )
	End If 

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ETAT_SG", ";"))
	If len ( Trim ( sVal ) ) > 0  Then
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DATE_ETAT_SG", ";"))

		If Not IsDate ( sVal ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si ETAT_SG est renseigné, DATE_ETAT_SG doit contenir une date valide" )
		End If
	End If 

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DATE_ETAT_SG", ";"))
	If len ( Trim ( sVal ) ) > 0  Then
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ETAT_SG", ";"))

		If len ( Trim ( sVal ) ) <= 0  Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si DATE_ETAT_SG est renseigné, ETAT_SG doit être renseigé" )
		End If
	End If 
	
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "TV_HG", ";"))
	If len ( Trim ( sVal ) ) > 0  Then
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DATE_TV_HG", ";"))

		If Not IsDate ( sVal ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si TV_HG est renseigné, DATE_TV_HG doit contenir une date valide" )
		End If
	End If 

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DATE_TV_HG", ";"))
	If len ( Trim ( sVal ) ) > 0  Then
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "TV_HG", ";"))

		If len ( Trim ( sVal ) ) <= 0  Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si DATE_TV_HG est renseigné, TV_HG doit être renseigé" )
		End If
	End If 

	sVal1 = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_LIVR_SBE" ) )
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ETAT_SG", ";"))
	If len ( Trim ( sVal1 ) ) <= 0 And len ( Trim ( sVal ) ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si ETAT_SG est renseigné, DTE_LIVR_SBE doit contenir une date valide" )
	End If

	sVal1 = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_LIVR_SBE" ) )
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "TV_HG", ";"))
	If len ( Trim ( sVal1 ) ) <= 0 And len ( Trim ( sVal ) ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si TV_HG est renseigné, DTE_LIVR_SBE doit contenir une date valide" )
	End If

	sVal1 = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_LIVR_SBE" ) )
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DATE_ETAT_SG", ";"))
	If len ( Trim ( sVal1 ) ) <= 0 And len ( Trim ( sVal ) ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si DATE_ETAT_SG est renseigné, DTE_LIVR_SBE doit contenir une date valide" )
	End If

	sVal1 = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_LIVR_SBE" ) )
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DATE_TV_HG", ";"))
	If len ( Trim ( sVal1 ) ) <= 0 And len ( Trim ( sVal ) ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si DATE_TV_HG est renseigné, DATE_TV_HG doit contenir une date valide" )
	End If

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	

	
	// #6 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

if isvalid(dsCode) Then destroy dsCode

Return iRet

end function

private function integer uf_integration_fichier_sbetv (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_SuiviCmd::uf_Integration_Fichier_SBETV (PRIVATE)
//* Auteur			: JFF
//* Date				: 29/11/2007
//* Libellé			: Intégration du fichier O2M dans la base
//* Commentaires	: [DCMP090327].[SBETV] Intégration de Fichier SBETV
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #2    JFF   28/04/2008   [DCMP080202] MailPush O2M
//* #3	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #4	FPI	10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF   07/03/2011   [VDOC3290]
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
// 		 JFF   13/02/2012   [VDOC6449]
//       JFF   18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq, lStatusGc
Decimal {2} dcMtFrais
String sInfoFrnSpbCplt  	//* #3 [FNAC_PROD_ECH_TECH]
String sCommentFrn
n_cst_string lnvPFCString  

// #2 [DCMP080202]
Int iRetMailPush 
String sDestEnvoi, sNumBonTrsp 
DateTime dtDteEnvCli
// :#2 

sInfoFrnSpbCplt = ""
iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	
	If lCpt = 1 Then sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
 	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_SBETV ( lIdSin, lIdSeq, sVal, lCpt )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]	

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	  												  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "PIECE_JOINTE" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ", " // #1 [DCMP080199]

	/*------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#1 [DCMP080199]			  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NOM_TRANSPORTEUR" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ","

	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	// Trt zone virtuelle RDV_CONF vers sInfoFrnSpbCplt
	//* #3 [FNAC_PROD_ECH_TECH]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "RDV_CONF" ) ) )
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RDV_CONF", sVal, ";")
	End If

	// [VDOC6449]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DTE_LIVR_SBE" ) ) )
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		If sInfoFrnSpbCplt <> "" Then sInfoFrnSpbCplt += ";"

		// [VDOC6449]
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_LIVR_SBE", sVal, ";")	
	End If

	// [VDOC3290]
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	Choose Case sVal 
		Case "169" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")
		Case "162" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SYMP_NON_DETEC_EN_24H", "OUI", ";")			
	End Choose
	// [VDOC3290]	

	//[VDOC6449]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ETAT_SG", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ETAT_SG", sVal, ";")
	End If

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DATE_ETAT_SG", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DATE_ETAT_SG", sVal, ";")
	End If

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "TV_HG", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TV_HG", sVal, ";")
	End If

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DATE_TV_HG", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DATE_TV_HG", sVal, ";")
	End If
	
	// [PC929-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "SITE", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SITE", sVal, ";")
	End If
	
	//[VDOC6449]
	
	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sSql += "'" + sInfoFrnSpbCplt + "'"

	// #2 [DCMP080202]
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ 
		F_commit ( SQLCA, False ) 
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue 
	End If
	// :#2

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #4
			F_commit ( SQLCA, True )
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			F_commit ( SQLCA, False )
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) )
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		F_commit ( SQLCA, False )
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) )
		Continue 
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1

Return iRet 
end function

private function integer uf_transformationseparateur (string asfichiersource, string asseporig, string assepsubst, string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_TransformationSeparateur (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 18/09/2008 13:46:43
//* Libellé			: //* [MICROMANIA]
//* Commentaires	: 
//*
//* Arguments		: 	value string asFichierSource
//* 						value string asSepOrig
//* 						value string asSepSubst
//*						value string asCas  [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   16/11/2009   [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
//* 
//*-----------------------------------------------------------------

Int iiFicSource, iiFicDest, iCtrlFnac
String sNomFicTmp, schaine
Blob blBlob

sNomFicTmp = stGLB.sRepTempo + K_FICTMP2
asSepOrig = Trim ( asSepOrig )
asSepSubst = Trim ( asSepSubst )
asCas = Upper ( asCas ) // #1 [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
iCtrlFnac = 0 // #1 [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]

iiFicSource = FileOpen ( asFichierSource, LineMode!, Read!, LockRead!, Append! )

If FileExists ( sNomFicTmp ) Then
	If Not FileDelete ( sNomFicTmp ) Then Return -1
End If
iiFicDest  = FileOpen ( sNomFicTmp, LineMode!, Write!, LockWrite!, Replace! )

If iiFicSource < 0 Or iiFicDest < 0 Then return -1

Do While ( FileRead ( iiFicSource, schaine)  > 0 )

	// #1 [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
	If asCas = "FNAC_BGE" Then
		Choose Case Upper ( left ( sChaine, 1 ))
			Case "D", "F"
				iCtrlFnac ++
				Continue
		End Choose
	End If
	// :#1 [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]	

	sChaine = F_Remplace ( sChaine, asSepOrig, asSepSubst )
	If FileWrite ( iiFicDest, schaine ) < 0 Then
			Return -1
	End If
Loop

If Fileclose ( iiFicDest ) < 0 Then Return -1
If Fileclose ( iiFicSource ) < 0 Then Return -1

If Not FileDelete ( asFichierSource ) Then Return -1

F_LireFichierBlob ( blBlob, sNomFicTmp ) 
F_EcrireFichierBlob ( blBlob, asFichierSource ) 

If Not FileDelete ( sNomFicTmp ) Then Return -1

// #1 [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
If asCas = "FNAC_BGE" And iCtrlFnac <> 2 Then Return -1

Return 1




end function

private function integer uf_ctrl_fichier_fnac ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_FNAC (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 09/09/2008
//* Libellé			: Controler de la validité du fichier FNAC
//* Commentaires	: [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    18/11/2009  [FNAC_PROD_ECH_TECH].[BGE].[20091118100834793]
//* #2    JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//*      JFF   30/05/2012	   [VDOC7926]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sVal2, sIdRefFour, sIdTypArt
String sInfoFrnSpbCplt
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
string   sIdFourBase, sCodEtatBase
integer  iStatusGcBase, iInfoSpbFrn
Long 		dcIdProd 
String	sIdSin, sIdSeq //#2
String 	sInfoSpbFrnCplt, sChaineBCV

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )


//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtatBase = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	/*------------------------------------------------------------------*/
	/* ZONE 1 : TYP                                                     */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "TYP" ) )

	If sVal <> "E" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Donnée éronnée sur la zone TYP (contacter Véronique Si ALI au 2905)" )
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : CPRES		                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "C_PRES" ) ) )
	If sVal <> "0100" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Donnée éronnée sur la zone C_PRES (contacter Véronique Si ALI au 2905)" )
	End If


	/*------------------------------------------------------------------*/
	/* ZONE 3 : D_ENC_BGE 															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "D_ENC_BGE" ) )
	sVal2 = Trim ( idwFicFourn.GetItemString ( lCpt, "H_ENC_BGE" ) )
	
	sVal = Left ( sVal, 2) + "/" + Mid ( sVal, 3, 2) + "/" + Right ( sVal, 4 )
	
	If Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone D_ENC_BGE contient une date non valide (contacter Véronique Si ALI au 2905)" )
	End If		

	If Not IsTime ( sVal2 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone H_ENC_BGE contient une Heure non valide (contacter Véronique Si ALI au 2905)" )
	End If		

	If iRet > 0 Then
		idwFicFourn.SetItem ( lCpt, "SPBCTRL_DTE_ENCAISS", sVal + " " + sVal2 )
	End If 
	
	/*------------------------------------------------------------------*/
	/* ZONE 4 : N_BGE                                            */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "N_BGE" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone N_BGE est vide (contacter Véronique Si ALI au 2905)" )
	End If 

	If Not ISNUMBER ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : le N_BGE contient des caractères autre que des chiffres (contacter Véronique Si ALI au 2905)" )
	End If 

	If iRet > 0 Then
			
		Choose Case Len ( sVal ) 
	
			Case 8 // Ancien Format
				sIdsin = Left ( sVal, 7 ) 
				sIdSeq = Right ( sVal, 1 ) 
			Case 20 // Nouveau Format
				sIdsin = Mid ( sVal, 5, 7 )
				sIdSeq = Mid ( sVal, 12, 1 )
		
		End Choose

		idwFicFourn.SetItem ( lCpt, "SPBCTRL_ID_SIN", sIdsin )
		idwFicFourn.SetItem ( lCpt, "SPBCTRL_ID_SEQ", sIdSeq )			

		sIdFourBase = fill(" ", 3)
		sCodEtatBase = fill(" ", 3)
		sIdRefFour = fill(" ", 20) //  [DCMP100443]
		sIdTypArt = fill(" ", 3) // [PM166][O2M]		
		
	End If
	
	If iRet > 0 Then

		// #1 [FNAC_PROD_ECH_TECH].[BGE].[20091118100834793] - [DCMP100443]
		SQLCA.PS_S11_COMMANDE_V07 ( Long ( sidsin) , Long ( sidseq), sIdFourBase, sCodEtatBase, iStatusGcBase, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

		If sIdFourBase <> "FNC" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : le N_BGE ne correspond pas un BGE FNAC (contacter Véronique Si ALI au 2905)" )
		End If
		// :#1 [FNAC_PROD_ECH_TECH].[BGE].[20091118100834793]		
	End If

	If iRet > 0 Then
		If Not uf_ctrl_maj( Long ( sIdSin ), Long ( sIdSeq ), lCpt) then
			Continue
		End If
	End If
	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_fnac (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_FNAC (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 16/11/2009
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

String sDteEnvCli

asVal = Upper ( asVal ) 

/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return


/*------------------------------------------------------------------*/
/* !!!! Code état Déterminés en fonction des dates 					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Si le CodEtat du fichier n'est pas un de ces deux codes, alors   */
/* on va le déterminer à partir des dates.                          */
/*------------------------------------------------------------------*/
sDteEnvCli = idwFicFourn.GetItemString ( alCpt, "SPBCTRL_DTE_ENCAISS" )

If Not IsNull ( sDteEnvCli ) Then
		asVal = "RPC"
Else
		asVal = "ECT"
End If

end subroutine

private function integer uf_integration_fichier_fnac (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_Fnac (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 09/09/2008
//* Libellé			: Intégration du fichier du FNAC dans la base
//* Commentaires	: [FNAC_PROD_ECH_TECH].[BGE].[20091116163039640]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	FPI	10/12/2009	[SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011 [ITSM62176] ajout du point de décimal.
//       JFF   18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet
DateTime dtDteRcpFrn
String	sSql, sVal, sSqlOrig, sIdFour, sVal2 
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq
Decimal {2}  dcMtFrais 
n_cst_string lnvPFCString 

//#2
String   sMesRetour, sNumBonTrsp, sDestEnvoi	
Int iRetMailPush

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 
	
	If lCpt = 1 Then sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "SPBCTRL_ID_SIN" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( sVal)

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "SPBCTRL_ID_SEQ" ) )
	lIdSeq = Long ( sVal ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "SPBCTRL_DTE_ENCAISS" ) )
	If IsNull ( sVal ) Then sVal = "null"
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	sNumBonTrsp = ""

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_FNAC ( sVal, lCpt )
	sSql += "'" + sVal + "', "
	//#2

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_EMIS_DEVIS" ) ) ), 19 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal+ ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = String ( idwFicFourn.GetItemDecimal ( lCpt, "MT_DEVIS" ) )
//	If IsNull ( sVal ) Then sVal = "0"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "ALT_DEV_ACP" ) ) )
//	If IsNull ( sVal ) Then sVal = "N"
//	sSql += "'" + sVal + "', "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_DEV_ACP" ) ) ), 10 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_BTE_FRN" ) ) ), 19 ) + "'"
//
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_BTE_CLI" ) ) ), 19 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_DEP_BTE_CLI" ) ) ), 19 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #5 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	sVal = "null"
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sVal, "NOM_FIC_FRN", isNomFicOrig, ";")		
	sSql += "'" + sVal + "'"
	

	If iRet >=0 Then iRet = 1
	If iRet < 0 Then 
		iRet = -1
		alNbLigNonTraitee	++ // #3
		F_commit ( SQLCA, False ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème d'insertion règlement automatique " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : " + sMesRetour  ) // #3
		Continue // #3
	End If

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++			// #1
			F_commit ( SQLCA, True ) // #3
		Else 
			iRet = -1
			alNbLigNonTraitee	++ // #3
			F_commit ( SQLCA, False ) // #3
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #4
			Continue // #3
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++ // #3
		F_commit ( SQLCA, False ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #4
		Continue // #3
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #3

Return iRet 
end function

private function integer uf_ctrl_fichier_mss_diag ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_MSS_DIAG (PRIVATE)
//* Auteur			: PHG
//* Date				: 29/11/2007
//* Libellé			: Controler de la validité du fichier O2M
//* Commentaires	: [MSS_DIAG]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #2	JCA	12/12/2007		DCMP 70918
//* #3   JFF	20/10/2008		[FNAC_PROD_ECH_TECH]
//* #4   JFF	30/04/2009		[DCMP090109]
//* #5   JFF	14/05/2009		[DCMP090085]
//* #6   JFF   02/09/2009 		[DCMP090327].[SBETV]
//* #7    JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//* #8    JFF   28/12/2009  [20091228114718123]
//* #9	FPI	25/01/2010	[DCMP090759] 
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//			FPI	25/02/2011	[DCMP100574] Contrôle de dates
//       JFF   20/12/2012     [VDOC9337]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar , sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datastore	dsCode
datetime	dtVal, dtVal1
Long	lIdSin, lIdSeq //#2

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC')  // #9

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.
	// [DCMP100574]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	Choose case lVal
		Case 155, 156, 158, 160, 163, 164, 165, 172, 176
			If Not isNull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End if
		Case 151, 152, 153, 154, 159, 162, 169, 173, 175
			If isNull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être renseignée.")
			End if
	End Choose

	// :[DCMP100574]
	
	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	// [O2M].M383 : Anomalie Mantis : On ne vérifie pas l'IMEI.
	
//	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI" ) )
//
//	If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
//		iRet = -1
//		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
//		" : Un numéro d'IMEI doit contenir 15 chiffres" )
//	End If

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_FIN_TRAIT 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.
	// [DCMP100574]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	Choose case lVal
		Case 156, 158, 159, 162, 163, 164, 169
			If Not isNull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_FIN_TRAIT) doit être vide.")
			End if
		Case 151, 152, 153, 154, 155, 160, 165, 172, 173, 175, 176
			If isNull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_FIN_TRAIT) doit être renseignée.")
			End if
	End Choose

	// :[DCMP100574]


	/*------------------------------------------------------------------*/
	/* ZONE 6 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.

	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	
	// if dsCode.retrieve('-GC') > 0  then		// #9
			// #3 [FNAC_PROD_ECH_TECH] agrandissement jusqu'à 160
			// #4 [DCMP090109] ajout 2, 21
			// #5 [DCMP090085] ajout jusqu'à 169
			// #6 [DCMP090327].[SBETV] (171)

		if dsCode.find("( ID_CODE BETWEEN 151 AND 176 OR ID_CODE IN (2, 21 )) AND ID_CODE = "+sVal, 1, dsCode.RowCount()+1 ) = 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le Status GC est inconnu !" )
		End If
//	End IF					// #9

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COMMENT_FRN														     */
	/*------------------------------------------------------------------*/
	// Pas de Controle Particulier
	
	/*------------------------------------------------------------------*/
	/* ZONE 9 : PJ	: Controle et Transformation								  */
	/*					  Doit Etre O ou N											  */
	/*------------------------------------------------------------------*/
	idwFicFourn.SetItem( lCpt, "PIECE_JOINTE", '2') 

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]					
				
				
	// #7 [MSS_DIAG].[20091207111441740]
	If iRet > 0 Then
		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

if isvalid(dsCode) Then destroy dsCode

Return iRet

end function

private subroutine uf_definir_codetat_mss_diag (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_MSS_DIAG (PRIVATE)
//* Auteur			: PHG
//* Date				: 29/11/2007
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [MSS_DIAG]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF   02/03/2010   [MSS_LOT2]
//*-----------------------------------------------------------------


Choose Case idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

	//* #6 [MSS_LOT2] 176, 175
	Case 2,21,151,152,153,154,155,157,160,161, 165, 170, 171, 172, 173, 176, 175
		
		asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)
		
	Case else
		asVal = "ECT" // EN COURS DE TRAITEMENT
		
End Choose		


end subroutine

private function integer uf_integration_fichier_mss_diag (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_MSS_DIAG (PRIVATE)
//* Auteur			: FABRY JF
//* Date				: 29/11/2007
//* Libellé			: Intégration du fichier O2M dans la base
//* Commentaires	: [MSS_DIAG] Intégration de Fichier MSS DIAG (MS1)
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #2    JFF   28/04/2008   [DCMP080202] MailPush O2M
//* #3	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #4	FPI	10/12/2009	[SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF   07/03/2011   [VDOC3290]
//*       JFF    11/03/2011 [ITSM62176] ajout du point de décimal
//*-----------------------------------------------------------------

// [MSS_DIAG].[##] 

Int iRet 
DateTime dtDteRcpFrn
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour
String sCommentFrn
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq, lStatusGc
Decimal {2} dcMtFrais
String sInfoFrnSpbCplt  	//* #3 [FNAC_PROD_ECH_TECH]
n_cst_string lnvPFCString  

// #2 [DCMP080202]
Int iRetMailPush 
String sDestEnvoi, sNumBonTrsp 
DateTime dtDteEnvCli
// :#2 

sInfoFrnSpbCplt = ""
iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]

	If lCpt = 1 Then sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
 	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_MSS_DIAG ( sVal, lCpt )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]	

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	  												  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "PIECE_JOINTE" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ", " // #1 [DCMP080199]

	/*------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#1 [DCMP080199]			  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NOM_TRANSPORTEUR" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ","

	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	// Trt zone virtuelle RDV_CONF vers sInfoFrnSpbCplt
	//* #3 [FNAC_PROD_ECH_TECH]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "RDV_CONF" ) ) )
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		If sInfoFrnSpbCplt <> "" Then sInfoFrnSpbCplt += ";"
		sInfoFrnSpbCplt += "RDV_CONF=" + sVal 
	End If
	
	// [VDOC3290]
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	Choose Case sVal 
		Case "169" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")
		Case "162" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SYMP_NON_DETEC_EN_24H", "OUI", ";")			
	End Choose
	// [VDOC3290]

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sSql += "'" + sInfoFrnSpbCplt + "'"

	// #2 [DCMP080202]
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ 
		F_commit ( SQLCA, False ) 
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue 
	End If
	// :#2

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++						// #4
			F_commit ( SQLCA, True )
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			F_commit ( SQLCA, False )
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) )
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		F_commit ( SQLCA, False )
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) )
		Continue 
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1

Return iRet 
end function

private function boolean uf_ctrl_general_bloquant (long aidsin, long aidseq, long alcpt, string asidfourctrl);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_ctrl_general_Bloquant (Private)
//* Auteur			: JFF
//* Date				: 07/12/2009
//* Commentaires	: [MSS_DIAG].[20091207111441740]
//*
//* Arguments		: 	aIdSin, Long, Val
//* 						aIdSeq, Long, Val
//* 						alCpt, long, val
//*						asIdFourCtrl, string, val [20091228114718123]
//*
//* Retourne		:	Boolean
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #2	 JFF	 20/10/2008   [FNAC_PROD_ECH_TECH].[20090127140540720]
//* #3    JFF   02/09/2009   [DCMP090327].[SBETV]
//* #4    JFF   25/11/2009   [MSS_DIAG]
//* #5	 FPI	 22/12/2009   [MSS_DIAG.Correctif] Correction nom de colonne du fournisseur
//* #6    JFF   28/12/2009   [20091228114718123] Annulation correctif #5, je refais la autrement.
//* #7	FPI	31/12/2009	[20091231.FPI] Ajout d'un message plus explicite si commande inexistante
//* #8	FPI	07/01/2010 [20100701.FPI] Ajout de l'id_sin & id_seq dans le message d'erreur
//			fpi		25/06/2010	[BUG.CTRLFICSUIVI]
//*      JFF   30/05/2012	   [VDOC7926]
//*      JFF   20/08/2012	   [BLCODE]
//*      JFF   21/11/2012	   [SAGA2][MICROMANIA]
//*-----------------------------------------------------------------

boolean bRet
integer iStatusGc, iInfoSpbFrn
string sIdFour, sCodEtat, sVal, sIdRefFour, sIdTypArt, sChaineBCV
String sInfoFrnSpbCplt
Long lPos		// #5
Long dcIdProd 
String 	sInfoSpbFrnCplt

sIdFour = fill(" ", 3)
sCodEtat = fill(" ", 3)
sIdRefFour = fill(" ",20) // [DCMP100443]
sIdTypArt = fill(" ", 3) // [PM166][O2M]


sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

bRet = true

// Ctrl 1
// [DCMP100443]
SQLCA.PS_S11_COMMANDE_V07 ( aidsin, aidseq, sIdFour, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

// #7 
If Isnull(sIdfour) or Trim(sIdfour) = "" Then
		bRet = False
		
		// [SAGA2][MICROMANIA]
		// On ne fait plus les contrôles Micromania, demande Thomas Gaiddon le 21/11/2012
		If asIdFourCtrl = "MCM" Then
			bRet = True
		Else
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
						" - Cet enregistrement (" + string(aidsin) + "-" + string(aidseq) + ") ne réfère aucune prestation en base." ) // #8
		End If
		// [SAGA2][MICROMANIA]
		
Else
//Fin #7

	//If idwFicFourn.GetItemString ( alCpt, "ID_FOUR" ) <> sIdfour Then
	// If idwFicFourn.GetItemString ( alCpt, "FOURNISSEUR" ) <> sIdfour Then // #5
	// #6 [20091228114718123] rmpl par asIdFourCtrl
	// [BLCODE]  And Not ( asIdFourCtrl = "O2M" And sIdfour = "BLC" )
	If ( Upper ( asIdFourCtrl )  <> Upper ( sIdfour ) ) Then // #5
		bRet = False
		
		// [SAGA2][MICROMANIA]
		// On ne fait plus les contrôles Micromania, demande Thomas Gaiddon le 21/11/2012
		If asIdFourCtrl = "MCM" Then
			bRet = True
/*
			This.uf_Trace ( "ECR", "AVERTISSEMENT ligne " + String ( alCpt ) + &
			" - Cet enregistrement " +  Upper ( asIdFourCtrl ) + "  (" + string(aidsin) + "-" + string(aidseq) + ") présent dans le fichier réfère en base une prestation " + sIdFour ) // #5 // #8
*/			
		// [SAGA2][MICROMANIA]

		Else
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
						" - Cet enregistrement " +  Upper ( asIdFourCtrl ) + "  (" + string(aidsin) + "-" + string(aidseq) + ") présent dans le fichier réfère en base une prestation " + sIdFour ) // #5 // #8
		End If


	End If
	
End if // #7

// Ctrl 2
// ...

if bRet Then uf_ctrl_maj(  aidsin, aidseq, alcpt ) //[BUG.CTRLFICSUIVI]

return bRet

end function

private subroutine uf_definir_codetat_sbetv (long alidsin, long alidseq, ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_SBETV (PRIVATE)
//* Auteur			: JFF
//* Date				: 02/09/2009
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [DCMP090327].[SBETV]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       SBA	 22/06/2010 	[DCMP100443]
//*       JFF   13/10/2011    [PC479].[POINT35]
//*      JFF   30/05/2012	   [VDOC7926]
//       JFF   07/05/2013 [PC929-1]
//*-----------------------------------------------------------------

String sIdFour, sCodEtat, sIdRefFour, sIdTypArt
Integer iStatusGc, iInfoSpbFrn
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt

// [DCMP100443]
sIdRefFour = fill(" ",20)
sCodEtat = fill(" ",3)
sIdFour = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]


sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)


SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFour, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

// [PC479].[POINT35] ajout "REFUSE_A_REEXP" // [PC929-1]
Choose Case sIdRefFour 
	Case "A_DIAGNOSTIQUER", "REFUSE_A_REEXP", "A_REPARER"
		Choose Case idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 
				
			Case 2,21,151,152,153,154,155,157,160,161,165, 170, 171
				
				asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)
				
			Case else
				asVal = "ECT" // EN COURS DE TRAITEMENT
				
		End Choose		

	Case Else
		asVal = sCodEtat	
		
End Choose




end subroutine

private function integer uf_ctrl_fichier_auchan ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_Auchan (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 06/07/2010
//* Libellé			: 
//* Commentaires	: [PC363_AUCHAN]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #2   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #3    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
// 		JFF	22/09/2017 [CTRLE_DATE_INTRG_FOU]
//       JFF   18/02/2025 [PMO268_MIG65]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sTypArtOrig, sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve

Long	lIdSin, lIdSeq //#2
DateTime dtNull

Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

//	If lCpt = 1 Then continue // On passe la première ligne qui est la ligne d'entête.

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If
	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_ENV_CC															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_ENV_CC_AUC" ) )

	If IsNull ( sVal) or Not IsDate ( sVal ) or Trim ( sVal ) = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Date envoi carte cadeau non valide" )
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_CMDE_CC															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_CC_AUC" ) )

	// [PMO268_MIG65]
	/*
	If IsNull ( sVal) or Not IsNumber ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" :Numéro carte cadeau non valide, nous attendons un numérique (cf NDC PC363 Auchan)" )
	End If

	If Len ( sVal ) <> 6 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" :Numéro carte cadeau non valide, nous attendons un numérique de 6 chiffre (cf NDC PC363 Auchan)" )
	End If
	*/

	// [PMO268_MIG65]
	If IsNull ( sVal) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" :Numéro carte cadeau obligatoire" )
	End If
	
	If Len ( sVal ) <> 10 Or Left ( sVal, 2 ) <> "MA" Or Not IsNumber ( Right ( sVal, 8 ) ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" :Numéro carte cadeau non valide, nous attendons le format MA00000000" )
	End If
	

	If iRet > 0 Then
		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If


Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_auchan (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_AUCHAN (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 06/07/2010
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [PC363_AUCHAN]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli
DateTime dtDteRcpFrn, dtDteEnvCli
String	sDestEnvoi

asVal = Upper ( asVal ) 
asVal = "RPC"


end subroutine

private function integer uf_integration_fichier_auchan (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_AUCHAN (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 06/07/10
//* Libellé			: Intégration du fichier du AUCHAN dans la base
//* Commentaires	: [MICROMANIA]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    11/02/2009 [20090211133609560]
//* #2	 FPI	  10/12/2009 [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011 [ITSM62176] ajout du point de décimal
//        JFF   18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet
DateTime dtDteRcpFrn, dtDteEnvCli
String	sSql, sVal, sSqlOrig, sIdFour, sVal2, sVal1 
String sInfoFrnSpbCplt
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq
Decimal {2}  dcMtFrais 
n_cst_string lnvPFCString  

//#2
String   sMesRetour, sNumBonTrsp, sDestEnvoi	
Int iRetMailPush

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

//	If lCpt = 1 Then continue // On passe la première ligne qui est la ligne d'entête.

	sInfoFrnSpbCplt = "" 
	
	If lCpt = 1 Then sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

	// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_ENV_CC_AUC" ) )
	If IsNull ( sVal ) Then 
		sVal = "null"
	Else
		sVal = "'" + sVal + "'"
	End If
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	sNumBonTrsp = ""

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = "RPC"
	This.uf_Definir_CodEtat_AUCHAN ( sVal, lCpt )
	sSql += "'" + sVal + "', "
	//#2
	sDestEnvoi	= "CLIENT"

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_CC_AUC" ) ) 
	sVal1 = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_ENV_CC_AUC" ) )
	IF Not IsNull ( sVal ) And Trim ( sVal ) <> "" and Not IsNull ( sVal1 ) And Trim ( sVal1 ) <> "" Then
		sVal = "401"
	Else 
		sVal = "402"		
	End IF 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_EMIS_DEVIS" ) ) ), 19 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal+ ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = String ( idwFicFourn.GetItemDecimal ( lCpt, "MT_DEVIS" ) )
//	If IsNull ( sVal ) Then sVal = "0"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "ALT_DEV_ACP" ) ) )
//	If IsNull ( sVal ) Then sVal = "N"
//	sSql += "'" + sVal + "', "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_DEV_ACP" ) ) ), 10 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_BTE_FRN" ) ) ), 19 ) + "'"
//
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_BTE_CLI" ) ) ), 19 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
// #4
//	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_DEP_BTE_CLI" ) ) ), 19 ) + "'"
//	If IsNull ( sVal ) Then sVal = "null"
//	sSql += sVal + ", "
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #5 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_CC_AUC" ) ) 
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NUM_CMD_CC_AUC", sVal, ";")
	
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "DTE_ENV_CC_AUC" ) )
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_ENV_CC_AUC", sVal, ";")
	
	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		

	sSql += "'" + sInfoFrnSpbCplt + "'"

	/*------------------------------------------------------------------*/
	/* #1 : Reglement automatique                                       */
	/*------------------------------------------------------------------*/
/* #1 [20090211133609560]
	dcMtFrais = This.uf_Determiner_Montant_Frais_Envoi ( sIdFour, lIdSin, lIdSeq )

	Choose Case dcMtFrais 
		Case -100
			iRet = -1
		Case -200
			// SPB ne règle rien, c'est le fournisseur qui s'en charge.
		Case Else 
			iRet = This.uf_ReglAuto ( lIdSin, &
											  lIdSeq, &
											 sIdFour ,&
											 dtDteRcpFrn, &
											 dcMtFrais , &
											 sMesRetour )
	End Choose 
*/

	If iRet >=0 Then iRet = 1
	If iRet < 0 Then 
		iRet = -1
		alNbLigNonTraitee	++ // #3
		F_commit ( SQLCA, False ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème d'insertion règlement automatique " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : " + sMesRetour  ) // #3
		Continue // #3
	End If


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #2
			F_commit ( SQLCA, True ) // #3
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #3

Return iRet 
end function

private function integer uf_ctrl_fichier_carrefour ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_Carrefour (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 10/11/2010
//* Libellé			: Controler de la validité du fichier du Carrefour
//* Commentaires	: [PC301].[LOT2]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #3   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve

Long	lIdSin, lIdSeq //#2

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_RCP_MOB_CLI													  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemDate ( lCpt, "DTE_RCP_MOB_CLI" ) )
	If Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Date non valide." )
	End If
	
	If iRet > 0 Then
		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_carrefour (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_BRIGHTPOINT (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/03/2006
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [PC301].[LOT2]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Date 	dDteRcpMobCli

asVal = Upper ( asVal ) 

/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return


/*------------------------------------------------------------------*/
/* !!!! Code état Déterminés en fonction des dates 					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Si le CodEtat du fichier n'est pas un de ces deux codes, alors   */
/* on va le déterminer à partir des dates.                          */
/*------------------------------------------------------------------*/
dDteRcpMobCli = idwFicFourn.GetItemDate ( alCpt, "DTE_RCP_MOB_CLI" )

If Not IsNull ( dDteRcpMobCli ) Then
	asVal = "RPC"			
Else
	// EN COURS CHEZ LE FOURNISSEUR
		asVal = "ECT"
End If



end subroutine

private function integer uf_integration_fichier_carrefour (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_Carrefour (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Intégration du fichier du BrightPointdans la base
//* Commentaires	: [PC301].[LOT2]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	FPI	10/12/2009	[SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011 [ITSM62176] ajout du point de décimal
//       JFF   18/08/2014 [PM254_V1]
//       JFF   11/12/2024 [LGY15]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli
n_cst_string lnvPFCString  

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = ""
	This.uf_definir_codetat_Carrefour ( sVal, lCpt )
	sSql += "'" + sVal + "', "

	sDestEnvoi	= "CLIENT" // [LGY15] on force car sion le mail de swap ne part pas

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDate ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	sVal = "null"
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sVal, "NOM_FIC_FRN", isNomFicOrig, ";")		
	sSql += "'" + sVal + "'"


	// #1
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If				
	// Fin #1

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue	
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private function integer uf_ctrl_fichier_coriolis ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_CORIOLIS (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/03/2006
//* Libellé			: Controler de la validité du fichier du CORIOLIS
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #3   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//* 		 JFF     03/05/2011 [PM178][CORIOLIS]
//* 		 JFF     23/11/2012 [VDOC9416]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   28/01/2019 [PM450-1]
//*-----------------------------------------------------------------

n_cst_string lnvPFCString
Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl, sVal2, sInfoFrnSpbCpltLu 
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1, dtNull
Long	lIdSin, lIdSeq //#2
Boolean bPM426
datastore	dsCode
Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn


// [PM426-1]
bPM426 = F_CLE_A_TRUE ( "PM426-1" )

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

// [PM426-1]
If bPM426 Then
	dsCode = Create datastore
	dsCode.Dataobject = 'dddw_spb_code'
	dsCode.SetTransObject(SQLCA)
	
	dsCode.retrieve('-GC') 
End IF

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	// [PM426-1]
	If bPM426 Then
		sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	End If
	
	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	// [PM426-1]	
	If bPM426 Then
		Choose Case iStatusGc
			Case 176, 178
	
				lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
				
				// [VDOC17191] je ne déclenche pas le message sur le 159
				If iStatusGc <> lVal Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
				End If
	
		End CHoose
	End If
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Un numéro d'IMEI doit contenir 15 chiffres" )
	End If

	If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Numéro d'IMEI non valide" )
	End If 

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// [PM426-1]	
	If bPM426 Then
		sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
		lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
		Choose Case lVal
			Case 177, 178
				If IsNull ( sVal ) Or Len ( sVal ) <= 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) )
				End If
		End Choose
	
		// [MODIF_SUITE_REDR]
		sVal = f_remplace(sVal,"'"," ")
		sVal = f_remplace(sVal,'"'," ")
		sVal = f_remplace(sVal,Char(9),"")
		sVal = f_remplace(sVal,Char(10),"")		
		sVal = f_remplace(sVal,Char(11),"")				
		sVal = f_remplace(sVal,Char(13),"")				
		idwFicFourn.SetItem ( lCpt, "NUM_BON_TRP", Trim ( sVal ) )		
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [PM426-1]	
	If bPM426 Then
		sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
		If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
		
			if dsCode.find("( ID_CODE IN (176, 178 ) "+ &
								") AND ID_CODE = " + sVal &
								, 1, dsCode.RowCount()+1 ) = 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
			End If			
	//	End IF			// #9
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COD_ETAT_CMD														  */
	/*------------------------------------------------------------------*/
	// [PM426-1]	
	If Not bPM426 Then
		sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	
		If Not IsNull ( sVal ) Then
			CHOOSE CASE sVal
				CASE "ANN", "RPC"
					
				CASE ELSE	
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : Le code état doit être null ou égal à ANN ou RPC, mais pas " + sVal )
			END CHOOSE
	
		End If
		
		// [VDOC9416]
		sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
		sVal2 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) )  
		
		If ( sVal = "RPC" And IsNull ( sVal2 ) ) Or ( sVal <> "RPC" And Not IsNull ( sVal2 ) ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le code état RPC et la date de réception du matériel par l'assuré doivent être transmises simultanément.")
		End If
		
		sVal2 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
		If Pos ( sVal2, "INSTANCE" ) > 0 And sVal <> "RPC" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Si la chaine INSTANCE est présente dans le commentaire, alors le code état RPC est obligatoire.")
		End If
	End If
	
	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	// [PM426-1]
	If bPM426 Then
		// PRBLE_LIVRAISON 
		sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))

		If IsNull ( sVal ) Then sVal = ""
		
		If sVal <> "" Then	
			Choose Case sVal
				Case "COLIS_PND", &
					  "COLIS_NRPAC", &
					  "COLIS_PERDU", &
					  "COLIS_BALNI", &
					  "COLIS_INCOR", &
					  "COLIS_REFUS", &
					  "ANNUL_REFAIT", &
					  "EN_ATTENTE", &
					  "AUTRE", &
					  "J1", &
					  "J2", &
					  "J3", &
					  "J4", &
					  "J5", &
					  "J6" 
				
						// Ok
						
				Case Else 
	
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PRBLE_LIVRAISON, n'est pas valide." )
	
			End Choose 
			
			// [PM450-1]

			// PRBLE_LIVRAISON 
			sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";"))
			sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))	
	
			If IsNull ( sVal ) Then sVal = ""
			If IsNull ( sVal1 ) Then sVal1 = ""		
			
			If sVal <> "" Then
				Choose Case sVal
					Case "OUI", &
						  "NON"
					
							// Ok
							
					Case Else 
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PEC_PRBLE_LIVRAISON, n'est pas valide." )
		
				End Choose 
				
				If sVal1 = "" Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la clé PEC_PRBLE_LIVRAISON n'est autorisée que si précédemment il y a au un clé PRBLE_LIVRAISON, qui est justement absente." )
				End If 			
			End If 	
		
		End IF 	
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.
	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If


Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_coriolis (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_Coriolis (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/03/2006
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [PM178][CORIOLIS]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli
DateTime dtDteRcpFrn, dtDteEnvCli
String	sDestEnvoi

asVal = Upper ( asVal ) 


/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return

/*------------------------------------------------------------------*/
/* !!!! Code état Déterminés en fonction des dates 					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Si le CodEtat du fichier n'est pas un de ces deux codes, alors   */
/* on va le déterminer à partir des dates.                          */
/*------------------------------------------------------------------*/
dtDteRcpFrn = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_FRN" ) 
dtDteEnvCli = idwFicFourn.GetItemDateTime ( alCpt, "DTE_ENV_CLI" )
sDestEnvoi	= idwFicFourn.GetItemString 	( alCpt, "DEST_ENVOI" )

dDteRcpFrn = Date ( dtDteRcpFrn )
dDteEnvCli = Date ( dtDteEnvCli )


If Not IsNull ( dDteEnvCli ) Then

	CHOOSE CASE sDestEnvoi	
		CASE "SPB"
			// Retourné à la SPB par le fournisseur
			asVal = "RSP"			

		CASE ELSE
			// ENVOYE AU CLIENT PAR LE FOURNISSEUR
			asVal = "ECL"			
	END CHOOSE

	// De plus si la dDteRcpFrn n'était pas renseigné
	//	On y met la dDteEnvCli
	If IsNull ( dDteRcpFrn ) Then idwFicFourn.SetItem ( alCpt, "DTE_RCP_FRN", dDteEnvCli )

ElseIf Not IsNull ( dDteRcpFrn ) Then

	// RECEPTIONNE CHEZ FOURNISSEUR
		asVal = "RCF"

Else
	// EN COURS CHEZ LE FOURNISSEUR
		asVal = "ECT"

End If



end subroutine

private function integer uf_integration_fichier_coriolis (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_Coriolis (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Intégration du fichier du Coriolis dans la base
//* Commentaires	: //[PM178][CORIOLIS]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	  24/04/2008  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	 FPI	  10/12/2009  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//  			FPI	04/08/2011	[FPI.04082011] Prise en compte de la date de réception des mobiles par les assurés
//       JFF   18/08/2014 [PM254_V1]
//		FPI	18/07/2018	[ITSM546478]
//       JFF   28/01/2019 [PM450-1]
//       JFF   21/08/2019 [DT361-1]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc
n_cst_string lnvPFCString

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli
boolean  bPM426

bPM426 = F_CLE_A_TRUE ( "PM426-1" )

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0


// [DT361-1]
For lCpt = 1 To lTotLig 

	// [PM426]
	If bPM426 Then
		sInfoFrnSpbCplt = "" 
		sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
		If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""
	End If

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteRcpFrn =  idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	If bPM426 Then
		This.uf_definir_codetat_CORIOLIS_PM426_1 ( sVal, lCpt, lIdSin, lIdSeq )
	Else
		sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
		This.uf_definir_codetat_CORIOLIS ( sVal, lCpt )
	End If
	
	sSql += "'" + sVal + "', "
	//#1
	sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	If bPM426 Then
		sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
		If IsNull ( sVal ) Then sVal = "0"
		sSql += sVal + ", "
		lStatusGc = Long ( sVal )
	Else
		sVal = "0"
		sSql += sVal + ", "
		lStatusGc = Long ( sVal ) // [PM246]
	End If
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	// [FPI.04082011]
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	If bPM426 then	

		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
		if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
		End If
		
		// [PM450-1]	
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";") 		
		If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
		End If
		
		// [PM254_V1]
		If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
		
		sSql += "'" + sInfoFrnSpbCplt + "'"

	Else 
		// [PM254_V1]
		sVal = "null"
		If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
		lnvPFCString.of_Setkeyvalue ( sVal, "NOM_FIC_FRN", isNomFicOrig, ";")		
		sSql += "'" + sVal + "'"
	End If

	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) 
	IF IsNull ( sVal ) Then sVal = ""
	lnvPFCString.of_Setkeyvalue ( sChaineMailRempl, "NUM_IMEI_NOU", sVal, ";")		

	// #1
	// [DT361-1]
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If				
	// Fin #1
	
	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private subroutine uf_definir_codetat_o2m (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_O2M (PRIVATE)
//* Auteur			: PHG
//* Date				: 29/11/2007
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [O2M][PM82][LOT1]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*					  alIdSin	Long			Val	
//*					  alIdSeq	Long			Val	
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #2	 JFF	20/10/2008    [FNAC_PROD_ECH_TECH].[20090127140540720]
//* #3    JFF  02/09/2009    [DCMP090327].[SBETV]
//* #4    JFF  15/01/2010  [O2M_DIAG_NOMADE].Lot2.JFF
//*		 FPI	11/08/2010	[PM01] Ajout des GC 167,168
//* 		 JFF  03/05/2011 [PM166][O2M]
//*       JFF  05/07/2011    [PC292][AUCHAN]
//*       JFF  09/09/2011   [PC499][PC501][PC545][-1x3][V5]
//*       JFF  19/09/2011   [PM82][LOT1]
//*       JFF  05/01/2012    [RECUP_DONNEE_O2M]
//*       JFF  30/05/2012	   [VDOC7926]
//*       JFF  19/02/2013	   [VDOC9304_PM82_LOT1]
//*       JFF   07/05/2013 [PC938_ORANGE_V3]
//*       JFF   02/10/2014 [VDOC15485]
//        JFF   20/05/2015 [PM284-1]
//        JFF   30/06/2015 [DT156] ajout 304
//*-----------------------------------------------------------------

//* #1 [FNAC_PROD_ECH_TECH]
//* #2 [FNAC_PROD_ECH_TECH].[20090127140540720] (165)
//* #3 [DCMP090327].[SBETV] 170,171

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString


sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	// [PM284-1] 303
	Case 2,21,151,152,153,154,155,157,160,161, 165, 166, 170, 171, 167, 168, 179 , 175, 176, 237, 303, 304

		// [VDOC9304_PM82_LOT1]
		// [VDOC15485]
		If ( ( lVal = 153 Or lVal = 154 ) And sIdTypArt = "PRS" ) Then
			asVal = "ECT"  // EN COURS DE TRAITEMENT
		Else
			asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)
		End If

	Case 178, 263, 234 // [PM166][O2M] // [PC938_ORANGE_V3]

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		

// [RECUP_DONNEE_O2M]
Choose Case sIdRefFour
	Case "PEC_A_RECYCLER", "PAS_DE_COMMANDE"
		asVal = "RFO"
End Choose 


end subroutine

private function integer uf_ctrl_fichier_psm ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_PSM (PRIVATE)
//* Auteur			: JFF
//* Date				: 09/05/2006
//* Libellé			: Controle de la validité du fichier PSM/PSM
//* Commentaires	: [PM200][PSM]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #2	JCA	12/12/2007		DCMP 70918
//* #3   JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//* #4   JFF   28/12/2009   [20091228114718123]
//*   	SBA	25/06/2010   [BUG.CTRLFICSUIVI]
//*      JFF   13/04/2012   [VDOC7572]
//       JFF     17/04/2012   [PM200][LOT2][DESOX]
//       JFF     23/11/2012   [VDOC8945]
//       JFF     29/11/2012   [VDOC9142]
//       JFF     26/11/2012   [PC877]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   20/03/2013     [ITSM150483]
//       JFF   25/06/2013     [VDOC11296] ajout => And Pos ( sVal, "[BRIS]") <= 0 &
//       JFF   09/09/2013 		[PM222-1]
//       JFF   18/08/2014		[PM254_V1]
//       JFF   20/05/2015 		[PM284-1]
//		   FPI	02/06/2015 [PM222-1]
//       JFF   28/07/2015 [PM295-1]
//       JFF   31/03/2016 [PM287-3]
//       JFF   29/08/2016 [DT200-1]
//       JFF   02/11/2016 [DT276]
//       JFF   10/03/2017 [PM383-1]
//       JFF   04/04/2017 [VDOC23499]
//       JFF   21/06/2017 [IRREP_QUALIFIE]
// 		JFF	25/08/2017 [CTRLE_REF_A_REEXP]
//       JFF   29/08/2017 [DT288-3_LOT1_2EME_VS]
// 		JFF	22/09/2017 [CTRLE_DATE_INTRG_FOU]
// 		JFF	05/01/2017 [VDOC25312]
// 		JFF	05/04/2018 [VDOC25984]
//       JFF   01/10/2018 [PM445-1]
//       JFF   21/11/2018 [VDOC27123]
//       JFF   28/01/2019 [PM450-1]
//       JFF   25/03/2019 [DT398]
//       JFF   20/09/2021 [BUG_RST_PRIX_O2M]
//       JFF   06/06/2025 [20250606091224420] Modif sur ajustement de date
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIdFourCtrl, sIMEICorr, sInfoFrnSpbCpltLu, sVal1, sVal2, sVal3
String   sTabVal[], sTabNull []
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal, lVal1, lTot
Boolean	bTrouve
datastore	dsCode
n_cst_string lnvPFCString
Long	lIdSin, lIdSeq //#2
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sChaineBCV, sIdTypArtSin 
Int iStatusGc,  iInfoSpbFrn 
Long  dcIdprod
String sInfoSpbFrnCplt
datetime	dtVal, dtVal1
String sInfoFrnSpbCplt
Long lNbreLignDeb, lNbreLignFin
Boolean bF_CLE_A_TRUE_PM445_1_PSM, bF_CLE_A_TRUE_20250606091224420 

bF_CLE_A_TRUE_PM445_1_PSM = F_CLE_A_TRUE ( "PM445_1_PSM" )
bF_CLE_A_TRUE_20250606091224420 = F_CLE_A_TRUE ( "20250606091224420" )

iRet = 1

lTotLig = idwFicFourn.RowCount ()
// [MODIF_SUITE_REDR]
If lTotLig <= 0 And FileLength64 ( isTxtNomFic.Text ) > 0 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR : 0 Ligne chargée ! , pour PI : Taille du fichier positive et chargement à 0 ligne => Anormal. Réessayez l'intégration (cause éventuelle => le fichier est peut-être en format Unicode au lieu d'Ansi, à vérifier)." )
End If	

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 	

// [VDOC25984]
// Contrôle entete et fin
If lTotLig < 2 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
	" : Le fichier doit comporter au minimum 2 engistrements : entête & fin")
	lTotLig = 0
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( 1, "NUM_CMD_SPB" ) )
	If Pos ( sVal, "DEBUT#" ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne d'entête n'est pas conforme (attendu : DEBUT#xx)")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( 1, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "DEBUT#", "" ) 
	If Not IsNumber ( sVal )  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne d'entête n'est pas conforme, la valeur dérrière DEBUT# doit être un nombre")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( 1, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "DEBUT#", "" ) 
	lNbreLignDeb = Long ( sVal )
	idwFicFourn.RowsDisCard ( 1, 1, Primary! )
	lTotLig = idwFicFourn.RowCount ()	
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( lTotLig, "NUM_CMD_SPB" ) )
	If Pos ( sVal, "FIN#" ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne de fin n'est pas conforme (attendu : FIN#xx)")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( lTotLig, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "FIN#", "" ) 
	If Not IsNumber ( sVal )  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne de fin n'est pas conforme, la valeur dérrière FIN# doit être un nombre")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( lTotLig, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "FIN#", "" ) 
	lNbreLignFin = Long ( sVal )
	idwFicFourn.RowsDisCard ( lTotLig, lTotLig, Primary! )
	lTotLig = idwFicFourn.RowCount ()	
End If

If iRet > 0 Then
	If lNbreLignDeb <> lNbreLignFin Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le nombre de ligne entre la ligne d'entête et la ligne de fin n'est pas identique")
		lTotLig = 0		
	End If 
End If

If iRet > 0 Then
	If lNbreLignDeb <> lTotLig Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le nombre de ligne du fichier dans la ligne d'entête (" + String ( lNbreLignDeb ) + ") ne correspond pas au nombre de ligne réel du fichier (" + String ( lTotLig ) + ")" )
		lTotLig = 0		
	End If 
End If
// [VDOC25984]


//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	If bF_CLE_A_TRUE_PM445_1_PSM Then
		sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
		If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = "" 
	ENd If 

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	
	sIdTypArtSin = lnvPFCString.of_getkeyvalue (sChaineBCV, "TYP_APP_DS", ";") 
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	// [ITSM150483]
	If sIdTypArtSin = "TEL" Then 
		If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Un numéro d'IMEI doit contenir 15 chiffres" )
		End If
	
		If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Numéro d'IMEI non valide" )
		End If 
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	dtVal = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )
	If Not IsNull ( dtVal ) And Date ( dtVal ) <> 1900-01-01 Then
		If Year ( Date (dtVal )) < 2000 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") l'année de la date de réception n'est pas valide." )
		End If
	End If
	
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	// [PM445-1]
	If bF_CLE_A_TRUE_PM445_1_PSM Then
		// [DCMP100333]
		// [PM166][O2M] 177, 178
		Choose Case lVal
			Case 155, 156, 157, 158, 160, 161, 163, 164, 165, 174, 177, 178
				If Not isNull(dtVal) Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
				End if
	
			// [PM01].[LOT3&4]
			// [PC499][PC501][PC545][-1x3][V5]
			// [VDOC8041] 232
			// [PM445-1]
			Case 151, 152, 153, 154, 159, 162, 166, 167, 168, 169, 2, 21, 175, 232
				// [PC13321][MANTIS14042]
				sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PERTE_ALLER", ";"))
				If isNull(dtVal) And iInfoSpbFrn <> 957 And sVal <> "OUI" Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être renseignée.")
				End if
				
				// [PC13321][MANTIS14042]			
				If Not isNull(dtVal) And iInfoSpbFrn = 957 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", et pour le process spécifique 957, la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
				End If			
	
		End Choose
	End If 
	
	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	dtVal = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )
	If Not IsNull ( dtVal ) And Date ( dtVal ) <> 1900-01-01 Then
		If Year ( Date (dtVal )) < 2000 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") l'année de la date de traitement/envoi client n'est pas valide." )
		End If
	End If


	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If ( lVal = 0 Or IsNull ( lVal ) ) And Not IsNull ( dtVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Lorsque la date de fin de traitement (DTE_ENV_CLI) est renseignée, un statut GC est obligatoire.")
	End If 
	

	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.
	
	/*------------------------------------------------------------------*/
	/* ZONE 9 : COD_ETAT_CMD														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "ANN", "RPC"

				// [VDOC8945]
				If sVal = "RPC" Then
					sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 
					If sVal = "CLIENT" Then
						sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  
						
						If IsNull ( sVal)  Then
							iRet = -1
							This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
							" : (vDoc8945) Le code RPC avec un DEST_ENVOI=CLIENT impose la présent d'une DTE_ENV_CLI" )
						End IF
					End If
				End If
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le code état doit être null ou égal à ANN ou RPC, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.

	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	
	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc ) 
	
	// [PM200][LOT2][DESOX] 22, 23
	// [DT150-1] 305, 306
	// [PM287-3] not in 305, 306
	// [VDOC25312]
	if dsCode.find("( ID_CODE BETWEEN 151 AND 158 " + &
						"	OR ID_CODE IN (2, 21, 22, 23, 169, 160, 261, 262, 263, 234, 235, 236, 237, 239, 264, 265, 266, 267, 268, 301, 303, 305, 306, 308, 311, 269 ) " + &
						") AND ID_CODE = "+ sVal + &
						"  AND ID_CODE NOT IN ( 305, 306, 232, 309, 310 ) " &
						, 1, dsCode.RowCount()+1 ) = 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
	End If		
	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/


	/*------------------------------------------------------------------*/
	/* ZONE INFO_FRN_SPB_CPLT														  */
	/*------------------------------------------------------------------*/

	If Not bF_CLE_A_TRUE_PM445_1_PSM Then
		sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
		If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = "" 
	ENd If 
	
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NOM_PDV", ";"))
	If len ( Trim ( sVal ) ) > 0 Then
		sVal = F_REMPLACE ( sVal, "'", " " )
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCpltLu, "NOM_PDV", sVal, ";")
		idwFicFourn.SetItem ( lCpt, "INFO_FRN_SPB_CPLT", sInfoFrnSpbCpltLu ) 
	End If	

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_EN_PDV", ";"))
	If Upper ( sVal ) = "OUI" Then
		
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NOM_PDV", ";"))
		If len ( Trim ( sVal ) ) <= 0 Or IsNull ( sVal ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si l'assuré s'est rendu en point vente, il faut renseigner le nom point du vente (voir CDC)" )
		End If			
		
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NUM_PDV", ";"))
		If len ( Trim ( sVal ) ) <= 0 Or IsNull ( sVal ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si l'assuré s'est rendu en point vente, il faut renseigner le numéro du point de vente (voir CDC)" )
		End If			
	
	End If 

	// Contrôle supplèmentaire vDoc7572
	// [VDOC7572]	
	// présence d’un status_gc 2 mais avec une zone COMMENTAIRES vide = rejet. 
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	// [DT288-3_LOT1_2EME_VS] 612
	Choose Case lVal
		Case 2, 612
			
			If IsNull ( sVal ) Or sVal = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " doit obligatoirement être accompagné d'un commentaire." )
			End If
			
	End CHoose

	
	// présence d’un status_gc 21 mais avec une zone COMMENTAIRES sans clé de type [BVIE], [BNV], etc. = rejet. 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemstring ( lCpt, "COMMENT_FRN" ) )
	
	If lVal = 21 And Not ( Pos ( sVal, "[") >0 And Pos ( sVal, "]") >0 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : Le statut 21 doit obligatoirement être accompagné d'un mot clé entre crochet dans le commentaire" )
	End If			
	
	// présence d’une clé de type [BVIE], [BNV], etc. dans la zone COMMENTAIRES, mais sans status_gc = rejet. 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	
	If lVal = 0 And Pos ( sVal, "[") >0 And Pos ( sVal, "]") >0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La présence d'un mot clé dans le commentaire doit être accompagné d'une statut" )
	End If			

	// présence d’une date de réception par l’assuré (ou date de restitution en proximité) antérieure à la date de réception initiale chez PSM = rejet. 
	sVal = String ( Date ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) )
	sVal1 = String ( Date ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) )

	If Not IsNull ( sVal1 ) And Date ( sVal1 ) <> 1900-01-01 Then
		If Year ( Date (sVal )) < 2000 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") l'année de la date DTE_RCP_MOB_CLI n'est pas valide." )
		End If
	End If
	
	If Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La date de réception fournisseur est invalide" )
	End If			

	If Not IsDate ( sVal1 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La date de réception de l'appareil par l'assuré est invalide" )
	End If			
	
	If IsDate ( sVal1 ) And IsDate ( sVal1 ) And Date ( sVal1 ) < Date ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La date de réception de l'appareil par l'assuré doit être postérieure ou égale à la date de réception du matériel sinistré par PSM" )
	End If			

	// présence d’une date de réception par l’assuré (ou date de restitution en proximité) 
	// avec un status_gc 21 ET une clé [BVIE] ou [BVIEOX] = rejet. 
	sVal1 = String ( Date ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) )
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	
	// [VDOC27123]BVID/BVIP/BVIT
	If IsDate ( sVal1 ) And lVal = 21 And ( Pos ( sVal, "[BVIE]") >0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos ( sVal, "[PIE]") >0 Or Pos ( sVal, "[BVIEOX]") >0 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La présence d'une date réception par l'assuré avec une statut 21 et un des mots clé [BVIE]/[BVID]/[BVIP]/[BVIT] ou [BVIEOX] est incohérent" )
	End If			
	

	// [PM200][LOT2][DESOX]
	//	présence d’un status_gc 23 sans une clé de type [BNVSOX] OU [BVIEOX] Ou [BRIS] Ou  [SAV_NO_OK] Ou [OXY] = rejet
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	
	If lVal = 23 And &
		Pos ( sVal, "[BNVSOX]") <= 0 And &
		Pos ( sVal, "[BVIEOX]") <= 0 And &
		Pos ( sVal, "[BRIS]") <= 0 And &
		Pos ( sVal, "[SAV_NO_OK]") <= 0 And &
		Pos ( sVal, "[OXY]") <= 0 &
		Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM200LOT2) : Le statut 23 doit obligatoirement avoir d'un mot clé dans le commentaire (confère CDC)" )
	End If			

	// présence d’un status_gc 23 avec tout autre clé différente de [BNVSOX] OU [BVIEOX] Ou [BRIS] Ou  [SAV_NO_OK] Ou [OXY] = rejet
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	sVal = F_REMPLACE ( sVal, "[BNVSOX]", "" )
	sVal = F_REMPLACE ( sVal, "[BVIEOX]", "" )
	sVal = F_REMPLACE ( sVal, "[BRIS]", "" )
	sVal = F_REMPLACE ( sVal, "[SAV_NO_OK]", "" )
	sVal = F_REMPLACE ( sVal, "[OXY]", "" )
	
	If lVal = 23 And Pos ( sVal, "[") > 0 And Pos ( sVal, "]") > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM200LOT2) : Le statut 23 n'autorise pas ce mot clé dans le commentaire" )
	End If			

	// présence d’un status_gc 23 avec un binôme clé/valeur PRESENCE_OX=OUI ET la clé de type [BNVSOX] = rejet
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRESENCE_OX", ";"))
	
	If lVal = 23 And Upper ( sVal1 ) = "OUI" And Pos ( sVal, "[BNVSOX]") > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM200LOT2) : Le Trinôme Statut à 23 ET Presence_OX à OUI ET Clé commentaire [BNVSOX] est incohérent" )
	End If			

	// [VDOC9142]
	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -   en retour à une commande avec ACTION = A_REPARER, clé de type [OXY], [BRIS], ou [BNVSOX] dans la zone COMMENTAIRES 
	// [PM222-1]
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	If ( Pos ( sVal, "[OXY]" ) > 0 Or Pos ( sVal,"[BRIS]"  ) > 0 Or Pos ( sVal, "[BNVSOX]" ) > 0 ) &
											And ( sIdRefFour = "A_REPARER" Or sIdRefFour = "A_REPARER_FORCE" ) &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &
											Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : Retour à une presta ACTION=A_REPARER ou A_REPARER_FORCE avec clé dédiée SAV de type [OXY], [BRIS], ou [BNVSOX] dans la zone COMMENTAIRES, interdit" )
	End IF 

	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -   présence d’un status_gc 21 sans une clé de type [BVIE], ou [BVIEOX], ou [BNV] dans la zone COMMENTAIRES 
	// Ajout [PNC] [PC877]
	// [VDOC27123]BVID/BVIP/BVIT
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	If sIdRefFour = "A_REPARER" And lVal = 21 And Pos (sVal,  "[PNC]" ) <= 0 &
															And Pos (sVal,  "[BVIE]" ) <= 0 &
															And Pos (sVal,  "[BVID]" ) <= 0 &
															And Pos (sVal,  "[BVIP]" ) <= 0 &
															And Pos (sVal,  "[BVIT]" ) <= 0 &															
															And Pos (sVal,  "[PIE]" ) <= 0 &
															And Pos (  sVal,"[BVIEOX]" ) <= 0 &
															And Pos ( sVal, "[BNV]" ) <= 0 &
															And Pos ( sVal, "[SAV_NO_OK]" ) <= 0 &
															And Pos ( sVal, "[BRIS]" ) <= 0 &																
															Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : présence d’un status_gc 21 sans une clé de type [PNC], ou [BVIE], ou [BVIEOX], ou [BNV] dans la zone COMMENTAIRES, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -   présence d’un status_gc 155 utilisée en réponse à une action A_REPARER ou A_REPARER_FORCE ou A_REPARER_SAV 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 155 And ( sIdRefFour = "A_REPARER" Or &
							  sIdRefFour = "A_REPARER_FORCE" Or &
							  lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") = "OUI" OR &
							  lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") = "OUI" &
							  ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : présence d’un status_gc 155 utilisée en réponse à une action A_REPARER ou A_REPARER_FORCE ou A_REPARER_SAV, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -  présence d’une clé de type [SAV_NO_OK] avec un status_gc différent de 21 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If sIdRefFour = "A_REPARER" And lVal <> 21 And Pos ( sVal, "[SAV_NO_OK]" ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : présence d’une clé de type [SAV_NO_OK] avec un status_gc différent de 21, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -   présence d’une clé de type [SAV_NO_OK] dans un retour sur une commande avec action = A_REPARER ou A_REPARER_FORCE 
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If Pos ( sVal, "[SAV_NO_OK]" ) > 0 And ( sIdRefFour = "A_REPARER" Or sIdRefFour = "A_REPARER_FORCE" ) &
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &
	Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : présence d’une clé de type [SAV_NO_OK] dans un retour sur une commande sans demande de SAV (donc n’impliquant pas d’action = A_REPARER_SAV ou A_CONTROLER_SAV), interdit" )
	End IF 

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	// -   en retour à une commande avec ACTION = A_DESOXYDER, clé de type [OXY], [BRIS], ou [BNV] dans la zone COMMENTAIRES 
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	If ( Pos (sVal, "[OXY]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 Or Pos ( sVal, "[BNV]" ) > 0 ) &
											And ( sIdRefFour = "A_DESOXYDER" Or sIdRefFour = "A_DESOXYDER_FORCE" ) &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_DESOXYDER_SAV", ";") <> "OUI" &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &											
											Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : Retour à une presta ACTION=A_DESOXYDER ou A_DESOXYDER_FORCE avec clé dédiée SAV de type [OXY], [BRIS], ou [BNV] dans la zone COMMENTAIRES, interdit" )
	End IF 

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	// -   présence d’un status_gc 23 sans une clé de type [BVIEOX], ou [BNVSOX] dans la zone COMMENTAIRES 
	// [VDOC11296] ajout => And Pos ( sVal, "[BRIS]") <= 0 &
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	If sIdRefFour = "A_DESOXYDER" And lVal = 23 And Pos ( sVal, "[BVIEOX]" ) <= 0 &
															  And Pos ( sVal, "[BNVSOX]" ) <= 0 &
															  And Pos ( sVal, "[SAV_NO_OK]" ) <= 0 &
															  And Pos ( sVal, "[OXY]" ) <= 0 &
															  And Pos ( sVal, "[BRIS]") <= 0 &
															  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : présence d’un status_gc 23 sans une clé de type [BVIEOX], ou [BNVSOX] dans la zone COMMENTAIRES, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	// -   présence d’un status_gc 155 utilisée en réponse à une action A_DESOXYDER ou A_DESOXYDER_FORCE ou A_DESOXYDER_SAV 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 155 And ( sIdRefFour = "A_DESOXYDER" Or &
							  sIdRefFour = "A_DESOXYDER_FORCE" Or &
							  lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_DESOXYDER_SAV", ";") = "OUI" &
							  ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : présence d’un status_gc 155 utilisée en réponse à une action A_DESOXYDER ou A_DESOXYDER_FORCE ou A_DESOXYDER_SAV, interdit " )
	End IF 		

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	// -   présence d’une clé de type [SAV_NO_OK] avec un status_gc différent de 23 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If sIdRefFour = "A_DESOXYDER" And lVal <> 23 And Pos ( sVal, "[SAV_NO_OK]" ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : présence d’une clé de type [SAV_NO_OK] avec un status_gc différent de 23, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	//- présence d’une clé de type [SAV_NO_OK] dans un retour sur une commande avec action = A_DESOXYDER ou A_DESOXYDER_FORCE 
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If Pos (sVal,  "[SAV_NO_OK]" ) > 0 And ( sIdRefFour = "A_DESOXYDER" Or sIdRefFour = "A_DESOXYDER_FORCE" ) &
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_DESOXYDER_SAV", ";") <> "OUI" & 
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &												  
												  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : présence d’une clé de type [SAV_NO_OK] dans un retour sur une commande sans demande de SAV (donc n’impliquant pas d’action = A_DESOXYDER_SAV), interdit" )			
	End IF 

	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :
	// -   présence d’un COD_ETAT_CMD à RPC et d’une clé de type [BVIE], ou [BVIEOX], ou [BNV], ou [BNVSOX], dans la zone COMMENTAIRES		
	// [VDOC27123]BVID/BVIP/BVIT	
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	If sVal1 = "RPC" And ( Pos ( sVal, "[BVIEOX]" ) > 0 Or Pos ( sVal, "[BVIE]" ) > 0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos ( sVal, "[PIE]" ) > 0 Or Pos ( sVal, "[BNV]" ) > 0 Or Pos ( sVal, "[BNVSOX]" ) > 0) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : présence d’un COD_ETAT_CMD à RPC et d’une clé de type [BVIE]/[BVID]/[BVIP]/[BVIT], ou [PIE] ou [BVIEOX], ou [BNV], ou [BNVSOX], dans la zone COMMENTAIRES, interdit " )
	End IF 
	
	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :
	// - présence d’un COD_ETAT_CMD à RPC sans date indiquée dans la zone DTE_ENV_CLI 
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  
	sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	If sVal1 = "RPC" And isNull( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : présence d’un COD_ETAT_CMD à RPC sans date indiquée dans la zone DTE_ENV_CLI, interdit " )
	End IF 

	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :
	// -   absence d’une information dans la zone NUM_BON_TRP et présence d’une date dans la zone DTE_ENV_CLI et présence du BCV ASSURE_ENVOIE_S=OUI dans la zone INFO_FRN_SPB_CPLT.
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) 
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		

	Choose Case lVal
		Case 2, 22
			If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And (not isnull ( sVal1 )) And lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_ENVOIE_COLIS", ";") = "OUI" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : absence d’une information dans la zone NUM_BON_TRP et présence d’une date dans la zone DTE_ENV_CLI et présence du BCV ASSURE_ENVOIE_COLIS=OUI dans la zone INFO_FRN_SPB_CPLT, interdit " )
			End IF 
	End Choose 

	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :		
	// -   présence d’une date dans la zone DTE_RCP_FRN, et Absence d’un BCV ASSURE_ENVOIE_COLIS=OUI ou d’un BCV NUM_PDV=XX (où XX est le n° du point de vente PSM) dans la zone INFO_FRN_SPB_CPLT 
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) 
	
	If (not isnull ( sVal )) And lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "INTER_A_DOMICILE", ";") <> "OUI" And &
											 lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_ENVOIE_COLIS", ";") <> "OUI" and &
									 Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NUM_PDV", ";")) = ""  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : présence d’une date dans la zone DTE_RCP_FRN, et Absence d’un BCV ASSURE_ENVOIE_COLIS=OUI ou d’un BCV NUM_PDV=XX (où XX est le n° du point de vente PSM) dans la zone INFO_FRN_SPB_CPLT, interdit " )
	End IF 

	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :		
	// -   présence d’un status_gc 153 ou 154 avec un COD_ETAT_CMD à RPC 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	If ( lVal = 153 Or lVal = 154 ) And sVal1 = "RPC" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : présence d’un status_gc 153 ou 154 avec un COD_ETAT_CMD à RPC, interdit " )
	End IF 
	// :[VDOC9142]

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	
	
	// [PM254_V1]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		

	// [VDOC27123]BVID/BVIP/BVIT
	If Pos (sVal,  "[SWAP]" ) > 0 And & 
		( &
			( lVal = 21 ) And Not ( Pos (sVal,  "[BVIE]" ) > 0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &
			Or &
			( lVal = 23 ) And Not ( Pos (sVal,  "[BVIEOX]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &					
			Or &
			( lVal <> 21 And lVal <> 23 ) &
		) &
		Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM254) : le mot clé [SWAP] ne peut être placé que sur un irréparable 21/23 avec un mot clé [BVIE]/[BVID]/[BVIP]/[BVIT]/[BVIEOX] ou [PIE]." )
	End If 
	// [PM254_V1]


	// [PM284-1]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	If lVal = 303 Then
		Choose Case dcIdProd
			Case 35800, 35801, 35802, 35803, 80500, 80501, 80502, 80503, 44500, 44501, 44502, 44503
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " n'est pas autorisé pour le produit " + string ( dcIdProd ) + "." )
		End Choose 
	End If			
	
	// [PM222-1]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	
	If  Trim ( lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt, "A_CONTROLER_SAV", ";")) ="OUI" and lVal <> 21 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Seul le retour 21 est autorisé pour une prestation de type A_CONTROLER_SAV." )
	End if
	// :[PM222-1]

	
	// [PM295-1]
	/* Annulé par Marion
	If F_C_L_E_A_TRUE ( "PM295-1" ) Then
		If lnvPFCString.of_getkeyvalue (sChaineBCV, "CHGT_CARTE_MERE", ";") <> "OUI" And &
			Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CHGT_CM", ";")) ="OUI" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM295-1/M.DESCHAMPS) : Le code produit sinistre lié à ce dossier n'est pas éligible à un changement de carte mère." )
		End If

		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
		If lnvPFCString.of_getkeyvalue (sChaineBCV, "CHGT_CARTE_MERE", ";") = "OUI" And &
			Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CHGT_CM", ";")) ="OUI" Then
			Choose Case lVal 
				Case 2, 21
					If ( Pos ( sIdRefFour, "A_DESOXYDER" ) > 0 Or &
						  lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_DESOXYDER_SAV", ";") = "OUI" &
						  ) Then
					
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM295-1/M.DESCHAMPS) : Retour 2 et 21 interdits sur les actions de désoxydation sur les codes produits sinistres éligibles au PM295-1" )
					End If
			End Choose
		End If

		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
		If lVal = 22 And &
			lnvPFCString.of_getkeyvalue (sChaineBCV, "CHGT_CARTE_MERE", ";") = "OUI" Then
			
			Choose Case Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CHGT_CM", ";"))
				Case "OUI", "NON"
					// Ok
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM295-1/M.DESCHAMPS) : Sur le retour 22, pour les codes produits sinistres éligibles au PM295-1, une valeur OUI ou NON est obligatoire sur le BCV CHGT_CM" )

			End Choose
		End If

		// [DT150-1]
		/*
			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
			If lVal = 305 And lnvPFCString.of_getkeyvalue (sChaineBCV, "GESTION_GEOLOCALISATION", ";") <> "OUI" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le produit " + String ( dcIdprod ) + " n'est pas éligible au projet DT150 gérant la géolocalisation. Si ce projet doit rentrer dans ce périmètre, voir avec DPG pour ajouter le produit, sinon transmettre l'information au fournisseur que ce produit est interdit pour ce code retour." )
			End If
			
			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
			If lVal = 306 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Statut de retour interdit ! " + String ( lVal ) + "." )
			End If 
		*/
	
	End If
	*/
	
	// [PM287-3]
	
	// [DT288-1_LOT2]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 311 And iStatusGc <> 308 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le statut retour 311 n'est autorisé que si le dernier statut envoyé par le fournisseur est 308, voir livraison PM287-3." )
	End If
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	lVal1 = Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") )
	If lVal = 308 And lVal1 <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le statut retour 308 vous oblige à renseigner le bcv IFDNMQ_RET (InFos DoNnées ManQuante RETour) avec un codage particulier, voir livraison PM287-3." )
	End If

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	lVal1 = Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") )
	If lVal <> 308 And lVal1 > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + String ( lVal ) + " interdit la présence du bcv IFDNMQ_RET (InFos DoNnées ManQuante RETour) dans la zone sérialisée, voir livraison PM287-3." )
	End If


	If lVal = 308 And lVal1 > 0 Then
		sVal2 = "#305#232#"
		sVal  = lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") 
		sVal3 = lnvPFCString.of_getkeyvalue (sChaineBCV, "DNCX_STATUS_GC", ";") 
		lnvPFCString.of_parsetoarray( sVal,"#", sTabVal )

		lTot = UpperBound ( sTabVal ) 

		For lCptVal = 1 To lTot
			If IsNull ( sTabVal [lCptVal] ) Or Trim ( sTabVal [lCptVal] ) = "" Then Continue 
			
			If Pos ( sVal2, "#" + sTabVal [lCptVal] + "#" ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La valeur #" + sTabVal [lCptVal] + "# n'est pas autorisée dans le BCV IFDNMQ_RET pour le statut 308, voir livraison PM287-3." )
			End If

			If iRet > 0  Then
				If Pos ( sVal3, "#" + sTabVal [lCptVal] + "#" ) > 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La valeur #" + sTabVal [lCptVal] + "# est interdite pour le statut 308/BCV IFDNMQ_RET pour le produit " + String ( dcIdprod ) + ", voir livraison PM287-3." )
				End If
			End If
		Next 
	
	End IF

	// [DT200-1]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt, "NE_PAS_REPARER", ";"))
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	If sVal = "OUI" Then
			Choose Case lVal
				Case 2
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Réparation interdite sur ce type de prestation, il faut répondre 21 Irréparable dans tous les cas et qualifier l'irréparabilité dans le commentaire par un mot clé." )
			End Choose 
	End if

	// [DT276]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))		
	If sVal = "OUI" Then
		
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		

		// [VDOC27123]BVID/BVIP/BVIT
		If ( &
				( lVal = 21 ) And Not ( Pos (sVal,  "[BVIE]" ) > 0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &
				Or &
				( lVal = 23 ) And Not ( Pos (sVal,  "[BVIEOX]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &					
				Or &
				( lVal <> 21 And lVal <> 23 ) &
			) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Le SWAP PSM n'est autorisé que sur un irréparable 21/23 avec un mot clé [BVIE]/[BVID]/[BVIP]/[BVIT]//[BVIEOX] ou [PIE]." )
		End If 				
			
		If iRet > 0 Then
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";"))		
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP PSM le BCV MARQSW doit être renseignée avec la marque IFR du nouveau matériel." )
			End If 	
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";"))		
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP PSM le BCV MODLSW doit être renseigné avec le modèle IFR du nouveau matériel." )
			End If 					

			If iRet > 0 Then
				Choose Case sIdTypArtSin
					Case "TEL", "TPC"
						// Autorisé
					Case Else 
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Type d'appareil (" + sIdTypArt+ ") non autorisé pour un SWAP PSM." )
				End Choose
			End If
		
			// Controle binome marq/modl appartient à IFR à ajouter
			If iRet > 0 Then
				sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";"))
				sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";"))
				If SQLCA.PS_S_VERIF_MARQ_MODL_IFR_V01 ( dcIdprod, sIdTypArtSin, sVal, sVal1 ) <= 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP PSM, pour ce dossier, la Marque et le Modèle du nouveau matériel (" + sVal + " " + sVal1 + ") doivent appartenir au référentiel IFR." )
				End If
			End If
		

			sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) // Le ctrle de validité est faite plus haut
			If Trim ( sVal ) = "" Or IsNull ( sVal )  Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP PSM la zone NUM_IMEI_NOUV doit être renseignée par l'IMEI (ou numéro de série si Tablette) du nouveau matériel." )
			End If 					

			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MTTTCSW", ";"))
			If Trim ( sVal ) = "" Or Not IsNumber ( sVal ) Or Pos ( sVal, ",") > 0 Or Pos ( sVal, "E") > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP PSM le BCV MTTTCSW doit être renseigné avec le montant TTC de l'appareil de remplacement (avec un point en séparateur de décimal)." )
			End If 

			// [BUG_RST_PRIX_O2M]
			If IsNumber ( sVal ) Then
				If Long ( sVal) = 0 Then 
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP PSM le BCV MTTTCSW doit être renseigné avec le montant TTC de l'appareil de remplacement (avec un montant positif)." )
				End if		
			End If 


			// [VDOC23499]
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NEUF_REC", ";"))
			Choose Case sVal
				Case "NEU", "REC"
					// Ok
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276/VDOC23499) : le BCV NEUF_REC est obligatoire et doit contenir les valeurs NEU ou REC." )
			End Choose 
			
			
			sVal = idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) 
			sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		

			If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_ENVOIE_COLIS", ";") = "OUI" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP PSM en << Envoi colis >> Le numéro de bon transporteur est obligatoire." )
			End IF 

		End If		
	
	End If
	
	// [PM383-1]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "SOUS_GC", ";"))
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	
	If sVal = "OUI" Then
		Choose case lVal 
			Case 2, 22
				//ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM383-1) : le bcv SOUS_GC=OUI n'est accepté qu'avec les retours 2 (réparé) ou 22 (désoxydé)." )
		End Choose 
	End If
	// [PM383-1]

	// IRREP_QUALIFIE
	sVal1= String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	
	// [VDOC27123]BVID/BVIP/BVIT
	If lVal = 21 And &
		( &
		  Pos ( sVal1, "[BNVSOX]") <= 0 And &
		  Pos ( sVal1, "[CRSMTPEC]") <= 0 And &
		  Pos ( sVal1, "[BNV]") <= 0 And &
		  Pos ( sVal1, "[OXY]") <= 0 And &
		  Pos ( sVal1, "[PIE]") <= 0 And &
		  Pos ( sVal1, "[PNC]") <= 0 And &
		  Pos ( sVal1, "[BRIS]") <= 0 And &
		  Pos ( sVal1, "[SAV_NO_OK]") <= 0 And &
		  Pos ( sVal1, "[BVIEOX]") <= 0 And &
		  Pos ( sVal1, "[EXP]") <= 0  And &			  
		  Pos ( sVal1, "[BVIE]") <= 0  And &			  
		  Pos ( sVal1, "[BVID]") <= 0  And &			  
		  Pos ( sVal1, "[BVIP]") <= 0  And &			  
		  Pos ( sVal1, "[BVIT]") <= 0  And &			  		  
		  Pos ( sVal1, "[NOSPBS]") <= 0 ) &
		  Then

			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il manque dans le commentaire un des mots clés obligatoire qualifiant l'irréparable." )

	End If 

	// [VDOC25312]
	// [CTRLE_REF_A_REEXP]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If IsNull ( lVal ) Then lVal = 0
	
	If sIdRefFour <> "REFUSE_A_REEXP" Then
		Choose Case lVal
			Case 155, 269 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " ne peut être renvoyé que sur une prestation de type REFUSE_A_REEXP" )
		End Choose					
	End If
		
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If IsNull ( lVal ) Then lVal = 0
	
	If sIdRefFour = "REFUSE_A_REEXP" Then
		Choose Case lVal
			Case 155, 269 
				// OK
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") une prestation de type REFUSE_A_REEXP ne peut recevoir qu'un Statut 155 ou 269 en retour, et non " + String ( lVal ) + "." )
		End Choose 				
	End If

	// [DT288-3_LOT1_2EME_VS]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If sIdRefFour = "INFORMATION" And lVal <> 612 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") : un flux de type INFORMATION ne peut avoir pour réponse qu'un statut 612" )
	End IF 

	// [CTRLE_DATE_INTRG_FOU]
	// [20250606091224420]
	If bF_CLE_A_TRUE_20250606091224420 Then
		choose case sCodEtat 
			case "RPC", "ANN", "RFO", "RSP"
				// Pas de contrôle
			Case Else
				sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  			
				sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
				iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
		End Choose 
	Else
		sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  			
		sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
		iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	End IF 
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "COLIS_PND", &
				  "COLIS_NRPAC", &
				  "COLIS_PERDU", &
				  "COLIS_BALNI", &
				  "COLIS_INCOR", &
				  "COLIS_REFUS", &
				  "ANNUL_REFAIT", &
				  "EN_ATTENTE", &
				  "AUTRE", &
				  "J1", &
				  "J2", &
				  "J3", &
				  "J4", &
				  "J5", &
				  "J6" 
			
					// Ok
					
			Case Else 

				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
	End IF 

	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "ASSURE_ENVOIE_COLIS", ";"))
	sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "ASSURE_EN_PDV", ";"))
	
	If sVal = "OUI" And sVal1 = "OUI" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") incohérence sur les clés ASSURE_ENVOIE_COLIS/ASSURE_EN_PDV, l'assuré ne peut pas avoir envoyé son colis en centralisation ET s'être déplacé en proximité pour le déposer." )
	End If

	// [DT398]
	sVal2 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "TCH_BPP", ";"))		
	If sVal1 = "OUI" And sVal2 = "OUI" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") incohérence sur les clés TCH_BPP/ASSURE_EN_PDV, l'assuré ne peut pas avoir téléchargé un BPP ET s'être déplacé en proximité pour déposer son colis." )
	End If
	
	If sVal <> "OUI" And sVal2 = "OUI" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") incohérence sur les clés TCH_BPP/ASSURE_ENVOIE_COLIS, Le téléchargement du BPP ne peut être à OUI que si l'assuré a envoyé son colis." )
	End If


	// [PM445-1]
	If bF_CLE_A_TRUE_PM445_1_PSM Then
		If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") <> "OUI" Then		
			sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "TYP_BA_ALLER", ";"))
			If IsNull ( sVal ) Then sVal = ""
	
			sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
			If IsNull ( sVal1 ) Then sVal1 = ""		
	
			dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")			
			
			If IsNull ( dtVal ) And sVal1 <> "" And sVal = "" And sIdRefFour <> "REFUSE_A_REEXP" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Un numéro de tracking ALLER doit être accompagné du bcv TYP_BA_ALLER." )
			End IF
			
			If sVal <> "" Then
				Choose Case sVal
					Case "BPPAYE", &
						  "RPICKUP"
					
							// Ok
							
					Case Else 
		
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé TYP_BA_ALLER, n'est pas valide." )
		
				End Choose 
			End If 
		End If 
		
		// [PM445-1]
		sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PERTE_ALLER", ";"))
		If IsNull ( sVal ) Then sVal = ""

		IF sVal = "OUI" Then

			sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))
			If IsNull ( sVal1 ) Then sVal1 = ""
	
			sVal2 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "TYP_BA_ALLER", ";"))
			If IsNull ( sVal2 ) Then sVal2 = ""
	
			sVal3 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
			If IsNull ( sVal3 ) Then sVal3 = ""	
	
			dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	
			lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
			If IsNull ( lVal ) Then lVal = 0				
			
			If sVal2 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le type de BA aller n'est compatible avec une perte aller." )
			End If 
			
			If sVal1 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le bcv PRBLE_LIVRAISON doit être renseigné." )
			End If 
			
			If sVal3 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le numéro de tracking (NUM_BON_TRP) doit être renseigné." )
			End If 

			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, la date de réception ne doit pas être renseignée." )
			End If 
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))		
			If lVal <> 0 AND ( lVal <> 21 AND sVal <> "OUI" ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le statut ne doit pas être renseigné." )
			End If 
		End IF 		
	End If	

	// [PM450-1]
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";"))
	sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))	

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""		
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PEC_PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
		
		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la clé PEC_PRBLE_LIVRAISON n'est autorisée que si précédemment il y a au un clé PRBLE_LIVRAISON, qui est justement absente." )
		End If 			
	End If 
	// Coder au dessus de cette ligne.


	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If
	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_psm (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_PSM (PRIVATE)
//* Auteur			: JFF
//* Date				: 13/02/2012
//* Libellé			: Intégration du fichier de CORDON dans la base
//* Commentaires	: [PM200][PSM]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    12/07/2004  DCMP 040206
//* #2	 CAG	  23/09/2004  DCMP 040403 : ajout des colonnes dte_emis_devis et mt_devis
//* #3	 MADM	  09/05/2006  DCMP 060356 : Rempl du frn AEVUM/AVM par CORDON/COR
//* #4    JCA    09/06/2006  MAILPUSH
//* #5    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #6 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #7    JFF    29/07/2009  [20090729111054510] Optimisation intégration (suppression Regl Auto)
//* #8	FPI	10/12/2009	[SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011 [ITSM62176] ajout du point de décimal
//*       JFF   19/09/2011   [PM82][LOT1]
//       JFF     17/04/2012   [PM200][LOT2][DESOX]
//       JFF    26/11/2012  [PC877]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//       JFF   07/05/2013 [PC929-1]
//       JFF   13/01/2014 [PM246]
// 		FPI	21/07/2014 [PM250-1].FPI Correction réinit de date avant lecture de la ligne
//       JFF   18/08/2014 [PM254_V1]
//       JFF   28/07/2015 [PM295-1]
//       JFF   02/11/2016 [DT276]
//       JFF   10/03/2017 [PM383-1]
//       JFF   04/04/2017 [VDOC23499]
//       JFF   17/04/2018 [DT288-4]
//       JFF   01/10/2018 [PM445-1]
//       JFF   28/01/2019 [PM450-1]
//       JFF   25/03/2019 [DT398]
//       JFF   11/12/2024 [LGY15]
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn, dtDteArrPlatForm, dtDteDepPlatForm
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu, sCasRetour, sIdAppli, sBase, sCommentFrn
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq, lStatusGc
Decimal {2} dcMtFrais

//#4
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
DateTime	dtDteEnvCli
//#4 FIN
n_cst_string lnvPFCString 

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	// [PM82][LOT1]
	sInfoFrnSpbCplt = "" 
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	// [MANTIS14172]
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	If lCpt = 1 Then sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#4
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )
	

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#4
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )	

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT	#3															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	This.uf_definir_codetat_PSM ( sVal, lCpt, lIdSin, lIdSeq ) // [PC938_ORANGE_V3]
	sSql += "'" + sVal + "', "
	//#4
	// sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) ) // [LGY15]
	sDestEnvoi	= "CLIENT" // [LGY15] on force car sion le mail de swap ne part pas

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "
//	sCommentFrn = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	/* #2 CAG : 23/09/2004                                              */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	/* #2 CAG : 23/09/2004                                              */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 19 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal  + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #6 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	// Préparation zone INFO_FRN_SPB_CPLT 
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	// [VDOC3290]
	Choose Case sVal 
		// [PM82][LOT1]
		Case "153" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_153", "OUI", ";")			
		// [PM82][LOT1]			
		Case "154" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_154", "OUI", ";")
		Case "169" 
			// [PC929-1]
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")				
		// [PM287-3]
		Case "311" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_311", "OUI", ";")
		

	End Choose
	// [VDOC3290]

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_EN_PDV", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ASSURE_EN_PDV", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NOM_PDV", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_PDV", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NUM_PDV", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NUM_PDV", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_ENVOIE_COLIS", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ASSURE_ENVOIE_COLIS", sVal, ";")
	End If	

	// [PC869]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DONNEES_RECUPEREES", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DONNEES_RECUPEREES", sVal, ";")
	End If	

	// [PM200][LOT2][DESOX]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRESENCE_OX", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRESENCE_OX", sVal, ";")
	End If	

	// [PC938_ORANGE_V3]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RESTIT_APP_PRET", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RESTIT_APP_PRET", sVal, ";")
	End If

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ETAT_APP_PRET", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ETAT_APP_PRET", sVal, ";")
	End If		
	
	// [PM246]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If		
	// [PM246]

	// [PM250-1]
	SetNull(dtDteArrPlatForm) // [PM250-1].FPI
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_ARR_PLATFORM", ";")
	If IsDate ( sVal ) Then 
		dtDteArrPlatForm = DateTime ( sVal )
	End If
	
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_ARR_PLATFORM", sVal, ";")
	End If		

	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_ARR_CENTR_DISTRIB", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_ARR_CENTR_DISTRIB", sVal, ";")
	End If		
	
	SetNull(dtDteDepPlatForm) // [PM250-1].FPI
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_DEP_CENTR_DISTRIB", ";")
	If IsDate ( sVal ) Then 
		dtDteDepPlatForm = DateTime ( sVal )
	End If

	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_DEP_CENTR_DISTRIB", sVal, ";")
	End If		
	
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RCP_MOB_CLI", sVal, ";")
	End If		
	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CODE_ERREUR_LIVR", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CODE_ERREUR_LIVR", sVal, ";")
	End If		

	// [PM295-1]
	/* Annulé par Marion
	If F_C_L_E_A_TRUE ( "PM295-1" ) Then
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CHGT_CM", ";") 		
		if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CHGT_CM", sVal, ";")
		End If	
	End If
	*/

	// [PM287-3]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "IFDNMQ_RET", sVal, ";")
	End If		

	// [DT276]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_SWAP", sVal, ";")
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TGR_APPSW", sVal, ";")	// Trigger Technique 
	End If		
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQSW", sVal, ";")
	End If			
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODLSW", sVal, ";")
	End If			

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MTTTCSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MTTTCSW", sVal, ";")
	End If		

	// [VDOC23499]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NEUF_REC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NEUF_REC", sVal, ";")
	End If		
		
	// [PM383-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "SOUS_GC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SOUS_GC", sVal, ";")
	End If			

	// [PM445-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "TYP_BA_ALLER", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TYP_BA_ALLER", sVal, ";")
	End If			

	// [PM445-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PERTE_ALLER", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PERTE_ALLER", sVal, ";")
	End If

	// [PM450-1]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
	End If

	// [DT398]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "TCH_BPP", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TCH_BPP", sVal, ";")
	End If

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	// [PM250-1]	
	
	
	sSql += "'" + sInfoFrnSpbCplt + "'"
	

	// [DT288-4]
   sChaineMailRempl = sInfoFrnSpbCplt
	

	If iRet >=0 Then iRet = 1
	
	// #4
	If lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_EN_PDV", ";") <> "OUI" Then
		iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
		If iRetMailPush <> 0 Then
			iRet = -1
			alNbLigNonTraitee	++ // #5
			F_commit ( SQLCA, False ) // #5
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #5
			Continue // #5
		End If
	End If
	//#4 FIN

	// [PC877]
	If lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_EN_PDV", ";") <> "OUI" Then
		iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
		If iRetMailPush <> 0 Then
			iRet = -1
			alNbLigNonTraitee	++ // #4
			F_commit ( SQLCA, False ) // #4
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
			Continue // #4
		End If
	End if 

	// [PM250-1]
	iRetMailPush = SQLCA.PS_S_MAILPUSH_ARR_PLATFORM ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteArrPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_ARR_PLATFORM, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	
	iRetMailPush = SQLCA.PS_S_MAILPUSH_DEP_CENTRDISTRIB ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteDepPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_DEP_CENTRDISTRIB, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	// [PM250-1]		
	
	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++			//  #8
			F_commit ( SQLCA, True ) // #5
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #5


Return iRet 
end function

private function integer uf_ctrl_fichier_lbe ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_LBE (PRIVATE)
//* Auteur			: FPI
//* Date				: 18/10/2012
//* Libellé			: 
//* Commentaires	: [PC884]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Int iRet 
String	 sVal, sNoCmdActuel, sNoCmdLu
Long		lTotLig, lCpt, lCol, lPos

Long	lIdSin, lIdSeq //#2
String sColOblig[]={"IDCMD","TYPECMD","DTEEXP"}
String sColOblig2[]={"TYPECARTE","NOCARTE","NOCARTEABREGE"}

iRet = 1

lTotLig = idwFicFourn.RowCount ()

sNoCmdActuel="-"

For lCpt = 1 to lTotLig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "REFCMD" ) )
	if isNull(sVal) then sVal=""
	
	sNoCmdLu=sVal
	
	If sNoCmdLu="" And sNoCmdActuel="" Then Continue  // Le n° commande n'est pas renseigné
	
	If sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR commande " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR commande " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref. CMD." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR commande " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref. CMD." )
			End If
		End if
		
		If iRet=1 Then 
			sNoCmdActuel=sNoCmdLu
		Else
			sNoCmdActuel=""
		End if
	Else
		If sNoCmdActuel="-" or sNoCmdActuel="" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR commande " + String ( lCpt ) + &
				" : Le n° de commande SPB n'est pas renseigné." )
			End if
	End If

	If iRet=-1 Then Continue
	
	/*------------------------------------------------------------------*/
	/* ZONES Obligatoires                                                      */
	/*------------------------------------------------------------------*/
	If sNoCmdLu<> "" Then
		For lCol=1 to UpperBound(sColOblig2)
			sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, sColOblig[lCol] ) ) )

			If IsNull ( sVal ) Or sVal = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR Commande " +sNoCmdActuel + &
				" : La zone " + sColOblig[lCol] + " est vide." )
			End If 
		Next
	End if
	
	For lCol=1 to UpperBound(sColOblig2)
		sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, sColOblig2[lCol] ) ) )

		If IsNull ( sVal ) Or sVal = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR Commande " +sNoCmdActuel + &
			" : La zone " + sColOblig2[lCol] + " est vide." )
		End If 
	Next
	
	/*------------------------------------------------------------------*/
	/* ZONE MNTCARTE													  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "MNTCARTE" ) )

	If IsNull ( sVal) or Not IsNumber ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR commande " +sNoCmdActuel + &
		" : le montant de la carte est incorrect." )
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_lbe (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_SuiviCmd::uf_Integration_Fichier_LBE (PRIVATE)
//* Auteur			: FPI
//* Date				: 18/10/2012
//* Libellé			: Intégration du fichier du LBE dans la base
//* Commentaires	: [PC884]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//       JFF   18/08/2014 [PM254_V1]
// 		FPI	02/02/2015 [SUIVI_EDEL] Correction pour ne plus utiliser PS_U02_COMMANDE_EDEL
//        JFF   05/08/2024  [MCO602_PNEU]
//*-----------------------------------------------------------------

Int iRet, iCptCarte, iCptCol
DateTime dtDteRcpFrn, dtDteEnvCli
String	sSql, sVal, sSqlOrig, sVal2 , sSqlInfoFrn
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq
Decimal {2}  dcMtFrais 
n_cst_string lnvPFCString

String   sMesRetour, sNumBonTrsp, sDestEnvoi	, sRefCmdPrec, sRefCmdActu
Int iRetMailPush
String sColARecopier[]={"REFCMD","IDCMD","TYPECMD","NOEXP","TYPEEXP","DTEEXP"}

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "
sSqlInfoFrn = "EXEC sysadm.PS_U02_COMMANDE_EDEL "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

sRefCmdPrec=""

For lCpt = 1 To lTotLig 
	
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "REFCMD" ) )

	// Recopie des zones - plusieurs cartes possible/dossier
	If IsNull ( sVal ) Or sVal = "" Then 
		
		if lCpt = 1 or sRefCmdPrec="" Then
			alNbLigNonTraitee	++
			This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
			Continue		
		End if
				
		iCptCarte++
		
		For iCptCol=1 To UpperBound(sColARecopier)
			idwFicFourn.SetItem(lCpt, sColARecopier[iCptCol], idwFicFourn.GetItemString(lCpt - 1,sColARecopier[iCptCol]) )
		Next
		
		sRefCmdActu=""
		sVal=sRefCmdPrec
	Else
		iCptCarte=1
		sRefCmdPrec=sVal
		sRefCmdActu=sVal
	End if
	
	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

	// [MCO602_PNEU]
	// Cas des sinistre SAGA2, que je shunte, je ne les traite pas.
	If F_CLE_A_TRUE ( "MCO602_PNEU" ) Then
		If lIdSin <= 4000000 Then Continue
	End If

	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "IDCMD" ) ) 
	If IsNull ( sVal ) Then 
		sVal = "null"
	else
		sVal="'" + sVal + "'"
	End if
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "DTEEXP" ) )
	If IsNull ( sVal ) Then 
		sVal = "null"
	Else
		dtDteEnvCli=DateTime(sVal)
		sVal=String(dtDteEnvCli,"dd/mm/yyyy")
		
		sVal = "'" + sVal + "'"
	End If
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NOEXP" ) )
	If IsNull ( sVal ) Then 
		sVal = "null"
	Else
		sVal = "'" + Left(sVal,35) + "'" // On le coupe car sur 50 maxi dans le xml
	End If
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = "RPC"
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	 							  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " 

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	                  */
	/*---------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "TYPEEXP" ) ) 
	If IsNull ( sVal ) Then 
		sVal = "null"
	else
		sVal="'" + sVal + "'"
	End if
	
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) 			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) 			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) 			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )           */
	/*------------------------------------------------------------------*/
	sVal=""

	// TYPE_CARTE
	/*	sVal2 = Trim ( idwFicFourn.GetItemString ( lCpt, "TYPECARTE" ) ) 
	If IsNull ( sVal ) Then 
		sVal2 = ""
	Else
		sVal2="TYPE_CARTE_" + String(iCptCarte) + "=" + sVal2 + ""
	End if

	if sVal2 <> ""And  sVal<> "" Then sVal+=";"
	sVal+=sVal2
	*/
	
	// [OPTIM_LBE"]
	// MNT_CARTE
	sVal2 = Trim ( idwFicFourn.GetItemString ( lCpt, "MNTCARTE" ) ) 
	If Not IsNull ( sVal2 ) Then 
		lnvPFCString.of_Setkeyvalue ( sVal, "MONTANT_CARTE_" + String(iCptCarte), sVal2, ";")		
	End if
	
	// NO_CARTE
	sVal2 = Trim ( idwFicFourn.GetItemString ( lCpt, "NOCARTE" ) ) 
	If Not IsNull ( sVal2 ) Then 
		lnvPFCString.of_Setkeyvalue ( sVal, "NO_CARTE_" + String(iCptCarte), sVal2, ";")		
	End if
	
	// NO_CARTE_ABREGE
	sVal2 = Trim ( idwFicFourn.GetItemString ( lCpt, "NOCARTEABREGE" ) ) 
	If Not IsNull ( sVal2 ) Then 
		lnvPFCString.of_Setkeyvalue ( sVal, "NO_CARTE_ABREGE_" + String(iCptCarte), sVal2, ";")		
	End if

	
	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sVal, "NOM_FIC_FRN", isNomFicOrig, ";")		

	
	if sVal="" Then 
		sVal="NULL"
	Else
		sVal="'" + sVal + "'"
	End if
	
	// [SUIVI_EDEL] Mise en commentaire
/*	If sRefCmdActu="" Then
		// Maj de la zone d'info fournisseur
		sSql=sSqlInfoFrn +  String ( lIdSin ) + "., " + String ( lIdSeq ) + ", "
	End if
	*/
	
	sSql += sVal 


	/*------------------------------------------------------------------*/
	/* #1 : Reglement automatique                                       */
	/*------------------------------------------------------------------*/

	If iRet >=0 Then iRet = 1

	If iRet < 0 Then 
		iRet = -1
		alNbLigNonTraitee	++ 
		F_commit ( SQLCA, False ) 
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : " + sMesRetour  ) 
		Continue 
	End If


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
			alNbLigMod ++				
			F_commit ( SQLCA, True )
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 

Return iRet 
end function

private subroutine uf_definir_codetat_psm (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_PSM (PRIVATE)
//* Auteur			: MADM
//* Date				: 09/05/2006
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	:  [DCMP060356]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF   19/09/2011   [PM82][LOT1]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//       JFF   20/05/2015 [PM284-1]
// 		JFF	17/09/2015 [ITSM324255] 155
//       JFF   25/08/2016 [VDOC21652]
// 		JFF	05/01/2017 [VDOC25312]
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli, dDteRcpMobCli
DateTime dtDteRcpFrn, dtDteEnvCli, dtDteRcpMobCli
String	sDestEnvoi, sVal, sChaineBCV
n_cst_string lnvPFCString
Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt
String sInfoFrnSpbCplt


sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

asVal = Upper ( asVal ) 

/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return


/*------------------------------------------------------------------*/
/* !!!! Code état Déterminés en fonction des dates 					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Si le CodEtat du fichier n'est pas un de ces deux codes, alors   */
/* on va le déterminer à partir des dates.                          */
/*------------------------------------------------------------------*/
dtDteRcpFrn = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_FRN" ) 
dtDteEnvCli = idwFicFourn.GetItemDateTime ( alCpt, "DTE_ENV_CLI" )
sDestEnvoi	= idwFicFourn.GetItemString 	( alCpt, "DEST_ENVOI" )
dtDteRcpMobCli = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_MOB_CLI" )

dDteRcpFrn = Date ( dtDteRcpFrn )
dDteEnvCli = Date ( dtDteEnvCli )
dDteRcpMobCli = Date ( dtDteRcpMobCli )

// [PC938_ORANGE_V3]
SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

If Not IsNull ( dDteEnvCli ) Then

	CHOOSE CASE sDestEnvoi	
		CASE "SPB"
			// Retourné à la SPB par le fournisseur
			asVal = "RSP"			

		CASE ELSE
			// ENVOYE AU CLIENT PAR LE FOURNISSEUR
			asVal = "ECL"			
	END CHOOSE

	// De plus si la dDteRcpFrn n'était pas renseigné
	//	On y met la dDteEnvCli
	If IsNull ( dDteRcpFrn ) Then idwFicFourn.SetItem ( alCpt, "DTE_RCP_FRN", dDteEnvCli )

ElseIf Not IsNull ( dDteRcpFrn ) Then

	// RECEPTIONNE CHEZ FOURNISSEUR
		asVal = "RCF"

// [PM82][LOT1]		
// [VDOC25312]
ElseIf idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) = 155 OR &
	    idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) = 269 Then 
		asVal = "RPC" 
		
Else
	// EN COURS CHEZ LE FOURNISSEUR
		asVal = "ECT"

End If

// [PC938_ORANGE_V3]
lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 
Choose Case lVal
	Case 262
		sVal = lnvPFCString.of_getkeyvalue (sInfoSpbFrnCplt, "TYP_RELAI", ";")
		
		If sVal = "REMPL" Then
			asVal = "RPC" 
		End If
		
 	// [ITSM324255] 155
	// [VDOC25312] 269
	Case 263, 237, 155, 269
		asVal = "RPC" 

	// [PM284-1]
	Case 151, 152, 303
		asVal = "RFO" 
		
End Choose

// [VDOC21652] au moment de la désact, remettre le 
lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 
Choose Case lVal
	Case 2, 21, 22, 23
		asVal = "RPC" 	
End Choose 


end subroutine

private function integer uf_ctrl_fichier_mtt ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_MTT (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/03/2006
//* Libellé			: Controler de la validité du fichier du MTT
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #3   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//       JFF   20/12/2012     [VDOC9337]
//*-----------------------------------------------------------------


Return This.uf_Ctrl_Fichier_O2M ()

end function

private subroutine uf_definir_codetat_mtt (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_MTT (PRIVATE)
//* Auteur			: JFF
//* Date				: 30/12/2013
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [PC13348&13408]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*					  alIdSin	Long			Val	
//*					  alIdSeq	Long			Val	
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	 JFF	20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #2	 JFF	20/10/2008    [FNAC_PROD_ECH_TECH].[20090127140540720]
//* #3    JFF  02/09/2009    [DCMP090327].[SBETV]
//* #4    JFF  15/01/2010  [O2M_DIAG_NOMADE].Lot2.JFF
//*		 FPI	11/08/2010	[PM01] Ajout des GC 167,168
//* 		 JFF  03/05/2011 [PM166][O2M]
//*       JFF  05/07/2011    [PC292][AUCHAN]
//*       JFF  09/09/2011   [PC499][PC501][PC545][-1x3][V5]
//*       JFF  19/09/2011   [PM82][LOT1]
//*       JFF  05/01/2012    [RECUP_DONNEE_O2M]
//*       JFF  30/05/2012	   [VDOC7926]
//*       JFF  19/02/2013	   [VDOC9304_PM82_LOT1]
//*       JFF   07/05/2013 [PC938_ORANGE_V3]
//*       JFF   02/10/2014 [VDOC15485]
//*-----------------------------------------------------------------

//* #1 [FNAC_PROD_ECH_TECH]
//* #2 [FNAC_PROD_ECH_TECH].[20090127140540720] (165)
//* #3 [DCMP090327].[SBETV] 170,171

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt


sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	Case 2,21,151,152,153,154,155,157,160,161, 165, 166, 170, 171, 167, 168, 179 , 175, 176, 237

		// [VDOC9304_PM82_LOT1]
		// [VDOC15485]
		If ( ( lVal = 153 Or lVal = 154 ) And sIdTypArt = "PRS" ) Then
			asVal = "ECT"  // EN COURS DE TRAITEMENT
		Else
			asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)
		End If

	Case 178, 263, 234 // [PM166][O2M] // [PC938_ORANGE_V3]
		
		asVal = "RPC"  // Cloture Commande
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		

// [RECUP_DONNEE_O2M]
Choose Case sIdRefFour
	Case "PEC_A_RECYCLER", "PAS_DE_COMMANDE"
		asVal = "RFO"
End Choose 


end subroutine

private function integer uf_integration_fichier_mtt (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_MTT (PRIVATE)
//* Auteur			: PHG
//* Date				: 29/11/2007
//* Libellé			: Intégration du fichier MTT dans la base
//* Commentaires	: [O2M] Intégration de Fichier MTT
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #2    JFF   28/04/2008   [DCMP080202] MailPush O2M
//* #3	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #4	 FPI	 10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF   30/06/2010   [PC363_AUCHAN]
//*       JFF   07/03/2011   [VDOC3290]
//*       JFF   11/03/2011   [ITSM62176] ajout du point de décimal
//*       JFF   19/09/2011   [PM82][LOT1]
//*       JFF   05/01/2012   [RECUP_DONNEE_O2M]
//        JFF   06/08/2012   [BLCODE]
//       JFF   07/05/2013 	  [PC938_ORANGE_V3]
//       JFF   03/07/2013 		[VDOC9908]
//       JFF   18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq
Decimal {2} dcMtFrais
String sInfoFrnSpbCplt  	// #3 [FNAC_PROD_ECH_TECH]
n_cst_string lnvPFCString  // [PC363_AUCHAN]

// #2 [DCMP080202]
Int iRetMailPush 
String sDestEnvoi, sNumBonTrsp 
DateTime dtDteEnvCli
// :#2 

String sCasRetour, sIdAppli, sBase, sCommentFrn 
Long lStatusGc 

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

sInfoFrnSpbCplt = ""
iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	// [BLCODE]
	sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 			
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
 	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	sNumBonTrsp = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_MTT ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "
//	sCommentFrn = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	If Not IsNull( sInfoFrnSpbCpltLu ) and Trim ( sInfoFrnSpbCpltLu ) <> "" Then 
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 
		If IsDate ( sVal ) Then
			sVal = "'" + sVal + "'" 
		Else
			sVal = "null"		
		End IF			
	Else
		sVal = "null"		
	End If
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #1 [DCMP080199]

	/*------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#1 [DCMP080199]			  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NOM_TRANSPORTEUR" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ","

	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	// [VDOC3290]
	Choose Case sVal 
		Case "169" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")
		Case "162" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SYMP_NON_DETEC_EN_24H", "OUI", ";")			

		// [PM82][LOT1]
		Case "153" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_153", "OUI", ";")			
		// [PM82][LOT1]			
		Case "154" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_154", "OUI", ";")			
	End Choose
	// [VDOC3290]

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		

	
	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sSql += "'" + sInfoFrnSpbCplt + "'"

	// #2 [DCMP080202]
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ 
		F_commit ( SQLCA, False ) 
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue 
	End If
	// :#2

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
	//		alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #4
			F_commit ( SQLCA, True )
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
	End If
	
	// [RECUP_DONNEE_O2M] Ici absolument, les données sont relues de la base !
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	Choose Case lVal	
		Case 178
			// Aucune action
	/*	Case Else
			iRetMailPush = This.uf_MailPush ( "RECUP_DONNEES_MAIL_AXALOT", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )
			If iRetMailPush <> 0 Then
				iRet = -1
				alNbLigNonTraitee	++ 
				F_commit ( SQLCA, False ) 
				This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECUP_DONNEES_MAIL_AXALOT, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
				Continue 
			End If */
	End Choose
Next

If alNbLigNonTraitee	> 0 Then iRet = -1

Return iRet 
end function

private function integer uf_ctrl_fichier_electrodepot ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_ElectroDepot (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 18/12/2014
//* Libellé			: Controler de la validité du fichier du ElectroDepot
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF     08/08/2017 [INTRG_ELD_MSG] Modification du message
// 		 JFF     05/04/2019 [VDOC27799]
//        JFF     19/12/2022 [RS4093_EVOL_ELD]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl, sVal2, sVal1 
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1, dtNull
Long	lIdSin, lIdSeq //#2

Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV
Int iStatusGc, iInfoSpbFrn

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	/*------------------------------------------------------------------*/
	/* ZONE : NUM_TICKET                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_TICKET" ) )

	If IsNull ( sVal ) Or Trim ( sVal ) = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone NUM_TICKET (référence sinistre) est vide." )
	End If
	
	If Not IsNumber ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone NUM_TICKET (référence sinistre) n'est pas valide" )
	End If

	lIdSin = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE : ID_SEQ                                                    */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CARTE_ED" ) )

	// [RS4093_EVOL_ELD]
	If IsNull ( sVal ) Or Trim ( sVal ) = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone NUM_CARTE_ED (référence prestation) est vide." )
	End If

	If iRet >= 1 Then
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de référence SPB id_sin-id_seq ne contient pas de '-'." )
		Else
			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			Else
				lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
				lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2
			End If
		End If
	End If 

	idwFicFourn.SetItem ( lCpt, "ID_SEQ", String ( lIdSeq ) ) 


	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	/*------------------------------------------------------------------*/
	/* ZONE : FOURNISSEUR                                               */
	/*------------------------------------------------------------------*/

//	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )
//
//	If IsNull ( sVal ) Or sVal = "" Then
//		iRet = -1
//		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + "/" + String ( lIdSin ) + "-" + String ( lIdSeq ) + &
//		" : La zone FOURNISSEUR est vide." )
//	End If 
//
//	If sVal <> sIdFour Then
//		iRet = -1
//		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + "/" + String ( lIdSin ) + "-" + String ( lIdSeq ) + &
//		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
//	End If 
//
//	If Len ( sVal ) > 3 Then
//		iRet = -1
//		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + "/" + String ( lIdSin ) + "-" + String ( lIdSeq ) + &
//		" : La longueur du fournisseur doit être sur 3 caractères." )
//	End If
//
//	//* [20091228114718123]
//	sIdFourCtrl = sVal
	
	sIdFourCtrl = "ELD"
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : RES_TRT_RCP															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "RES_TRT_RCP" ) ) )
	
	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + "/" + String ( lIdSin ) + "-" + String ( lIdSeq ) + &
		" : La zone RES_TRT_RCP est vide." )
	End If 

	If sVal <> "OK" And sVal <> "KO" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + "/" + String ( lIdSin ) + "-" + String ( lIdSeq ) + &
		" : La zone RES_TRT_RCP ne peut contenir que les valeur OK ou KO, mais pas " + sVal + "." )
	End If 

	
	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	// [CTRLE_DATE_INTRG_FOU]
	sVal = idwFicFourn.GetItemString ( lCpt, "DTE_EMISS" ) 
	sVal = right ( sVal, 2) + "/" + mid ( sVal, 5, 2) + "/" + Left ( sVal, 4 )
	sVal1 = idwFicFourn.GetItemString ( lCpt, "DTE_EMISS" ) 
	sVal1 = right ( sVal1, 2) + "/" + mid ( sVal1, 5, 2) + "/" + Left ( sVal1, 4 )			
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If


Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_electrodepot (ref string asval, long alcpt);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_ElectroDepot (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 12/12/2014
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [PC13321]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
// 		 JFF   05/04/2019   [VDOC27799]
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli
DateTime dtDteRcpFrn, dtDteEnvCli
String	sDestEnvoi

asVal = Upper ( asVal ) 

/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return

// [VDOC27799]
Choose Case asVal 
	Case "OK"
		asVal = "RPC"
	Case "KO" 
		asVal = "ANN"
	Case Else 
		asVal = "ANN"					
End Choose 

end subroutine

private function integer uf_integration_fichier_electrodepot (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_ElectroDepot (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 12/12/2014
//* Libellé			: Intégration du fichier du ElectroDepot dans la base
//* Commentaires	: [PC13321]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	  24/04/2008  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	 FPI	  10/12/2009  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//  			FPI	04/08/2011	[FPI.04082011] Prise en compte de la date de réception des mobiles par les assurés
//       JFF   18/08/2014 [PM254_V1]
// 		JFF   05/04/2019 [VDOC27799]
//       JFF   19/12/2022 [RS4093_EVOL_ELD]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig, sVal1
String sCommentFrn, sInfoFrnSpbCplt
Long		lTotLig, lCpt, lVal, lStatusGc
n_cst_string lnvPFCString

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli


iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sSql = sSqlOrig
	
	sInfoFrnSpbCplt = "" // [RS4093_EVOL_ELD]

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_TICKET" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	// [ITSM62176] ajout du point de décimal
	sSql += sVal + "., "
	// #1
	lIdSin = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "ID_SEQ" ) )

	sSql += sVal + ", "
	// #1
	lIdSeq = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + String ( Today (), "dd/mm/yyyy" ) + "'"
//	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "RES_TRT_RCP" ) ) ) 
	This.uf_definir_codetat_ELECTRODEPOT ( sVal, lCpt )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "RES_TRT_RCP" ) ) ) 
	
	// [VDOC27799]
	Choose Case sVal 
		Case "OK"
			sVal = "'Carte marquée et prête à être consommée'"
		Case "KO" 

			// [RS4093_EVOL_ELD]
			sVal = "'Carte non autorisée, prestation automatiquement annulée'"
			
		Case Else 
			sVal = "null"					
	End Choose 

	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "RES_TRT_RCP" ) ) ) 
	// [VDOC27799]
	Choose Case sVal 
		Case "OK"
			sVal = "401"
		Case "KO" 
			sVal = "402"
		Case Else 
			sVal = "0"					
	End Choose 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	sInfoFrnSpbCplt = ""
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")	

	// [RS4093_EVOL_ELD]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_CARTE_ED2" ) ) ) 	
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NUM_CC_ELD_RET", sVal, ";")
	End If	
	
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "CODE_SECURITE" ) )  	
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CODE_SECURITE", sVal, ";")
	End If	
	
	If IsNull ( sInfoFrnSpbCplt ) Then sInfoFrnSpbCplt = ""
	sSql += "'" + sInfoFrnSpbCplt + "'"

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_TICKET" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_TICKET" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private function integer uf_ctrl_fichier_tamet ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_TAMET (PRIVATE)
//* Auteur			: JFF
//* Date				: 09/05/2006
//* Libellé			: Controle de la validité du fichier TAMET/TAMET
//* Commentaires	: [PM200][TAMET]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #2	JCA	12/12/2007		DCMP 70918
//* #3   JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//* #4   JFF   28/12/2009   [20091228114718123]
//*   	SBA	25/06/2010   [BUG.CTRLFICSUIVI]
//*      JFF   13/04/2012   [VDOC7572]
//       JFF     17/04/2012   [PM200][LOT2][DESOX]
//       JFF     23/11/2012   [VDOC8945]
//       JFF     29/11/2012   [VDOC9142]
//       JFF     26/11/2012   [PC877]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   20/03/2013     [ITSM150483]
//       JFF   25/06/2013     [VDOC11296] ajout => And Pos ( sVal, "[BRIS]") <= 0 &
//       JFF   09/09/2013 		[PM222-1]
//       JFF   18/08/2014		[PM254_V1]
// 		JFF	22/09/2017 [CTRLE_DATE_INTRG_FOU]
//       JFF   21/11/2018 [VDOC27123]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIdFourCtrl, sIMEICorr, sInfoFrnSpbCpltLu, sVal1
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datastore	dsCode
n_cst_string lnvPFCString
Long	lIdSin, lIdSeq //#2
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sChaineBCV
Int iStatusGc,  iInfoSpbFrn 
Long  dcIdprod
String sInfoSpbFrnCplt
datetime	dtVal, dtVal1
String sInfoFrnSpbCplt


iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 	

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	// [ITSM150483]
	If sIdTypArt = "TEL" Then 
		If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Un numéro d'IMEI doit contenir 15 chiffres" )
		End If
	
		If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Numéro d'IMEI non valide" )
		End If 
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COD_ETAT_CMD														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "ANN", "RPC"

				// [VDOC8945]
				If sVal = "RPC" Then
					sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 
					If sVal = "CLIENT" Then
						sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  
						
						If IsNull ( sVal)  Then
							iRet = -1
							This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
							" : (vDoc8945) Le code RPC avec un DEST_ENVOI=CLIENT impose la présent d'une DTE_ENV_CLI" )
						End IF
					End If
				End If
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le code état doit être null ou égal à ANN ou RPC, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.

	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )

	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )

	// [PM200][LOT2][DESOX] 22, 23
	if dsCode.find("( ID_CODE BETWEEN 151 AND 158 " + &
						"	OR ID_CODE IN (2, 21, 22, 23, 169, 160, 261, 262, 263, 234, 235, 236, 237, 239, 264, 265, 266, 267, 268, 301 ) " + &
						") AND ID_CODE = "+sVal, 1, dsCode.RowCount()+1 ) = 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/


	/*------------------------------------------------------------------*/
	/* ZONE INFO_FRN_SPB_CPLT														  */
	/*------------------------------------------------------------------*/

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_ENVOIE_COLIS", "OUI", ";")  // [PC801_6_TAMET]

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_EN_PDV", ";"))
	If Upper ( sVal ) = "OUI" Then
		
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NOM_PDV", ";"))
		If len ( Trim ( sVal ) ) <= 0 Or IsNull ( sVal ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si l'assuré s'est rendu en point vente, il faut renseigner le nom point du vente (voir CDC)" )
		End If			
		
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NUM_PDV", ";"))
		If len ( Trim ( sVal ) ) <= 0 Or IsNull ( sVal ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Si l'assuré s'est rendu en point vente, il faut renseigner le numéro du point de vente (voir CDC)" )
		End If			
	
	End If 

	// Contrôle supplèmentaire vDoc7572
	// [VDOC7572]	
	// présence d’un status_gc 2 mais avec une zone COMMENTAIRES vide = rejet. 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	
	If lVal = 2 And ( len ( Trim ( sVal ) ) <= 0 Or IsNull ( sVal ) ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : Le statut 2 doit obligatoirement est accompagné d'un commentaire" )
	End If			
	
	
	// présence d’un status_gc 21 mais avec une zone COMMENTAIRES sans clé de type [BVIE], [BNV], etc. = rejet. 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemstring ( lCpt, "COMMENT_FRN" ) )
	
	If lVal = 21 And Not ( Pos ( sVal, "[") >0 And Pos ( sVal, "]") >0 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : Le statut 21 doit obligatoirement être accompagné d'un mot clé entre crochet dans le commentaire" )
	End If			
	
	// présence d’une clé de type [BVIE], [BNV], etc. dans la zone COMMENTAIRES, mais sans status_gc = rejet. 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	
	If lVal = 0 And Pos ( sVal, "[") >0 And Pos ( sVal, "]") >0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La présence d'un mot clé dans le commentaire doit être accompagné d'une statut" )
	End If			


	// présence d’une date de réception par l’assuré (ou date de restitution en proximité) antérieure à la date de réception initiale chez TAMET = rejet. 
	sVal = String ( Date ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) )
	sVal1 = String ( Date ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) )
	
	If Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La date de réception fournisseur est invalide" )
	End If			

	If Not IsDate ( sVal1 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La date de réception de l'appareil par l'assuré est invalide" )
	End If			
	
	If IsDate ( sVal1 ) And IsDate ( sVal1 ) And Date ( sVal1 ) < Date ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La date de réception de l'appareil par l'assuré doit être postérieure ou égale à la date de réception du matériel sinistré par TAMET" )
	End If			

	// présence d’une date de réception par l’assuré (ou date de restitution en proximité) 
	// avec un status_gc 21 ET une clé [BVIE] ou [BVIEOX] = rejet. 
	sVal1 = String ( Date ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) )
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	
	// [VDOC27123]BVID/BVIP/BVIT
	If IsDate ( sVal1 ) And lVal = 21 And ( Pos ( sVal, "[BVIE]" ) >0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos ( sVal, "[PIE]") >0 Or Pos ( sVal, "[BVIEOX]") >0 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7572) : La présence d'une date réception par l'assuré avec une statut 21 et un des mots clé [BVIE] ou [BVIEOX] est incohérent" )
	End If			
	

	// [PM200][LOT2][DESOX]
	//	présence d’un status_gc 23 sans une clé de type [BNVSOX] OU [BVIEOX] Ou [BRIS] Ou  [SAV_NO_OK] Ou [OXY] = rejet
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	
	If lVal = 23 And &
		Pos ( sVal, "[BNVSOX]") <= 0 And &
		Pos ( sVal, "[BVIEOX]") <= 0 And &
		Pos ( sVal, "[BRIS]") <= 0 And &
		Pos ( sVal, "[SAV_NO_OK]") <= 0 And &
		Pos ( sVal, "[OXY]") <= 0 &
		Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM200LOT2) : Le statut 23 doit obligatoirement avoir d'un mot clé dans le commentaire (confère CDC)" )
	End If			

	// présence d’un status_gc 23 avec tout autre clé différente de [BNVSOX] OU [BVIEOX] Ou [BRIS] Ou  [SAV_NO_OK] Ou [OXY] = rejet
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	sVal = F_REMPLACE ( sVal, "[BNVSOX]", "" )
	sVal = F_REMPLACE ( sVal, "[BVIEOX]", "" )
	sVal = F_REMPLACE ( sVal, "[BRIS]", "" )
	sVal = F_REMPLACE ( sVal, "[SAV_NO_OK]", "" )
	sVal = F_REMPLACE ( sVal, "[OXY]", "" )
	
	If lVal = 23 And Pos ( sVal, "[") > 0 And Pos ( sVal, "]") > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM200LOT2) : Le statut 23 n'autorise pas ce mot clé dans le commentaire" )
	End If			

	// présence d’un status_gc 23 avec un binôme clé/valeur PRESENCE_OX=OUI ET la clé de type [BNVSOX] = rejet
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRESENCE_OX", ";"))
	
	If lVal = 23 And Upper ( sVal1 ) = "OUI" And Pos ( sVal, "[BNVSOX]") > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM200LOT2) : Le Trinôme Statut à 23 ET Presence_OX à OUI ET Clé commentaire [BNVSOX] est incohérent" )
	End If			

	// [VDOC9142]
	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -   en retour à une commande avec ACTION = A_REPARER, clé de type [OXY], [BRIS], ou [BNVSOX] dans la zone COMMENTAIRES 
	// [PM222-1]
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	If ( Pos ( sVal, "[OXY]" ) > 0 Or Pos ( sVal,"[BRIS]"  ) > 0 Or Pos ( sVal, "[BNVSOX]" ) > 0 ) &
											And ( sIdRefFour = "A_REPARER" Or sIdRefFour = "A_REPARER_FORCE" ) &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &
											Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : Retour à une presta ACTION=A_REPARER ou A_REPARER_FORCE avec clé dédiée SAV de type [OXY], [BRIS], ou [BNVSOX] dans la zone COMMENTAIRES, interdit" )
	End IF 

	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -   présence d’un status_gc 21 sans une clé de type [BVIE], ou [BVIEOX], ou [BNV] dans la zone COMMENTAIRES 
	// Ajout [PNC] [PC877]
	// [VDOC27123]BVID/BVIP/BVIT
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	If sIdRefFour = "A_REPARER" And lVal = 21 And Pos (sVal,  "[PNC]" ) <= 0 &
															And Pos (sVal,  "[BVIE]" ) <= 0 &
															And Pos (sVal,  "[BVID]" ) <= 0 &															
															And Pos (sVal,  "[BVIP]" ) <= 0 &
															And Pos (sVal,  "[BVIT]" ) <= 0 &															
															And Pos (sVal,  "[PIE]" ) <= 0 &
															And Pos (  sVal,"[BVIEOX]" ) <= 0 &
															And Pos ( sVal, "[BNV]" ) <= 0 &
															And Pos ( sVal, "[SAV_NO_OK]" ) <= 0 &
															And Pos ( sVal, "[BRIS]" ) <= 0 &																
															Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : présence d’un status_gc 21 sans une clé de type [PNC], ou [BVIE]/[BVID]/[BVIP]/[BVIT], ou [BVIEOX], ou [BNV] dans la zone COMMENTAIRES, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -   présence d’un status_gc 155 utilisée en réponse à une action A_REPARER ou A_REPARER_FORCE ou A_REPARER_SAV 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 155 And ( sIdRefFour = "A_REPARER" Or &
							  sIdRefFour = "A_REPARER_FORCE" Or &
							  lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") = "OUI" OR &
							  lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") = "OUI" &
							  ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : présence d’un status_gc 155 utilisée en réponse à une action A_REPARER ou A_REPARER_FORCE ou A_REPARER_SAV, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -  présence d’une clé de type [SAV_NO_OK] avec un status_gc différent de 21 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If sIdRefFour = "A_REPARER" And lVal <> 21 And Pos ( sVal, "[SAV_NO_OK]" ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : présence d’une clé de type [SAV_NO_OK] avec un status_gc différent de 21, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la réparation, rejet du fichier si : 
	// -   présence d’une clé de type [SAV_NO_OK] dans un retour sur une commande avec action = A_REPARER ou A_REPARER_FORCE 
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If Pos ( sVal, "[SAV_NO_OK]" ) > 0 And ( sIdRefFour = "A_REPARER" Or sIdRefFour = "A_REPARER_FORCE" ) &
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &
	Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/REPARATION) : présence d’une clé de type [SAV_NO_OK] dans un retour sur une commande sans demande de SAV (donc n’impliquant pas d’action = A_REPARER_SAV ou A_CONTROLER_SAV), interdit" )
	End IF 

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	// -   en retour à une commande avec ACTION = A_DESOXYDER, clé de type [OXY], [BRIS], ou [BNV] dans la zone COMMENTAIRES 
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	If ( Pos (sVal, "[OXY]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 Or Pos ( sVal, "[BNV]" ) > 0 ) &
											And ( sIdRefFour = "A_DESOXYDER" Or sIdRefFour = "A_DESOXYDER_FORCE" ) &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_DESOXYDER_SAV", ";") <> "OUI" &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
											And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &											
											Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : Retour à une presta ACTION=A_DESOXYDER ou A_DESOXYDER_FORCE avec clé dédiée SAV de type [OXY], [BRIS], ou [BNV] dans la zone COMMENTAIRES, interdit" )
	End IF 

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	// -   présence d’un status_gc 23 sans une clé de type [BVIEOX], ou [BNVSOX] dans la zone COMMENTAIRES 
	// [VDOC11296] ajout => And Pos ( sVal, "[BRIS]") <= 0 &
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	If sIdRefFour = "A_DESOXYDER" And lVal = 23 And Pos ( sVal, "[BVIEOX]" ) <= 0 &
															  And Pos ( sVal, "[BNVSOX]" ) <= 0 &
															  And Pos ( sVal, "[SAV_NO_OK]" ) <= 0 &
															  And Pos ( sVal, "[OXY]" ) <= 0 &
															  And Pos ( sVal, "[BRIS]") <= 0 &
															  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : présence d’un status_gc 23 sans une clé de type [BVIEOX], ou [BNVSOX] dans la zone COMMENTAIRES, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	// -   présence d’un status_gc 155 utilisée en réponse à une action A_DESOXYDER ou A_DESOXYDER_FORCE ou A_DESOXYDER_SAV 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 155 And ( sIdRefFour = "A_DESOXYDER" Or &
							  sIdRefFour = "A_DESOXYDER_FORCE" Or &
							  lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_DESOXYDER_SAV", ";") = "OUI" &
							  ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : présence d’un status_gc 155 utilisée en réponse à une action A_DESOXYDER ou A_DESOXYDER_FORCE ou A_DESOXYDER_SAV, interdit " )
	End IF 		

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	// -   présence d’une clé de type [SAV_NO_OK] avec un status_gc différent de 23 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If sIdRefFour = "A_DESOXYDER" And lVal <> 23 And Pos ( sVal, "[SAV_NO_OK]" ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : présence d’une clé de type [SAV_NO_OK] avec un status_gc différent de 23, interdit " )
	End IF 

	// Règles de cohérence à respecter sur la désoxydation, rejet du fichier si : 
	//- présence d’une clé de type [SAV_NO_OK] dans un retour sur une commande avec action = A_DESOXYDER ou A_DESOXYDER_FORCE 
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If Pos (sVal,  "[SAV_NO_OK]" ) > 0 And ( sIdRefFour = "A_DESOXYDER" Or sIdRefFour = "A_DESOXYDER_FORCE" ) &
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_DESOXYDER_SAV", ";") <> "OUI" & 
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
												  And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &												  
												  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT/DESOXYDATION) : présence d’une clé de type [SAV_NO_OK] dans un retour sur une commande sans demande de SAV (donc n’impliquant pas d’action = A_DESOXYDER_SAV), interdit" )			
	End IF 

	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :
	// -   présence d’un COD_ETAT_CMD à RPC et d’une clé de type [BVIE], ou [BVIEOX], ou [BNV], ou [BNVSOX], dans la zone COMMENTAIRES		
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 

	// [VDOC27123]BVID/BVIP/BVIT
	If sVal1 = "RPC" And ( Pos ( sVal, "[BVIEOX]" ) > 0 Or Pos ( sVal, "[BVIE]" ) > 0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos ( sVal, "[PIE]" ) > 0 Or Pos ( sVal, "[BNV]" ) > 0 Or Pos ( sVal, "[BNVSOX]" ) > 0) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : présence d’un COD_ETAT_CMD à RPC et d’une clé de type [BVIE]/[BVID]/[BVIP]/[BVIT], ou [PIE] ou [BVIEOX], ou [BNV], ou [BNVSOX], dans la zone COMMENTAIRES, interdit " )
	End IF 
	
	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :
	// - présence d’un COD_ETAT_CMD à RPC sans date indiquée dans la zone DTE_ENV_CLI 
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  
	sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	If sVal1 = "RPC" And isNull( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : présence d’un COD_ETAT_CMD à RPC sans date indiquée dans la zone DTE_ENV_CLI, interdit " )
	End IF 

	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :
	// -   absence d’une information dans la zone NUM_BON_TRP et présence d’une date dans la zone DTE_ENV_CLI et présence du BCV ASSURE_ENVOIE_S=OUI dans la zone INFO_FRN_SPB_CPLT.
	sVal = idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) 
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And (not isnull ( sVal1 )) And lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_ENVOIE_COLIS", ";") = "OUI" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : absence d’une information dans la zone NUM_BON_TRP et présence d’une date dans la zone DTE_ENV_CLI et présence du BCV ASSURE_ENVOIE_COLIS=OUI dans la zone INFO_FRN_SPB_CPLT, interdit " )
	End IF 

	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :		
	// -   présence d’une date dans la zone DTE_RCP_FRN, et Absence d’un BCV ASSURE_ENVOIE_COLIS=OUI ou d’un BCV NUM_PDV=XX (où XX est le n° du point de vente TAMET) dans la zone INFO_FRN_SPB_CPLT 
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) 
	
	If (not isnull ( sVal )) And lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "INTER_A_DOMICILE", ";") <> "OUI" And &
											 lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_ENVOIE_COLIS", ";") <> "OUI" and &
									 Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NUM_PDV", ";")) = ""  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : présence d’une date dans la zone DTE_RCP_FRN, et Absence d’un BCV ASSURE_ENVOIE_COLIS=OUI ou d’un BCV NUM_PDV=XX (où XX est le n° du point de vente TAMET) dans la zone INFO_FRN_SPB_CPLT, interdit " )
	End IF 

	// Règles de cohérence à respecter sur les deux process, rejet du fichier si :		
	// -   présence d’un status_gc 153 ou 154 avec un COD_ETAT_CMD à RPC 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	If ( lVal = 153 Or lVal = 154 ) And sVal1 = "RPC" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9142/A.RAULT) : présence d’un status_gc 153 ou 154 avec un COD_ETAT_CMD à RPC, interdit " )
	End IF 
	// :[VDOC9142]

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	
	
	// [PM254_V1]
	// [VDOC27123]BVID/BVIP/BVIT
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If Pos (sVal,  "[SWAP]" ) > 0 And lVal <> 21 And Pos (sVal,  "[BVIE]" ) <= 0 And Pos (sVal,  "[BVID]" ) <= 0 And Pos (sVal,  "[BVIP]" ) <= 0 And Pos (sVal,  "[BVIT]" ) <= 0 And Pos (sVal,  "[PIE]" ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM254) : le mot clé [SWAP] ne peut être placé que sur un irréparable 21 avec un mot clé [BVIE]/[BVID]/[BVIP]/[BVIT]." )
	End If 
	// [PM254_V1]

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  			
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If
	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_tamet (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_Tamet (PRIVATE)
//* Auteur			: MADM
//* Date				: 09/05/2006
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	:  [DCMP060356]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF   19/09/2011   [PM82][LOT1]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli, dDteRcpMobCli
DateTime dtDteRcpFrn, dtDteEnvCli, dtDteRcpMobCli
String	sDestEnvoi, sVal, sChaineBCV
n_cst_string lnvPFCString
Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt
String sInfoFrnSpbCplt


sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

asVal = Upper ( asVal ) 

/*------------------------------------------------------------------*/
/* !!!! Code état Fixés !!!! 					     							  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est ANNULEE PAR GESTIONNAIRE,    */
/* on le laisse s'écrire en base.                                   */
/*------------------------------------------------------------------*/
If asVal = "ANN" Then Return

/*------------------------------------------------------------------*/
/* Le code état lu dans le fichier est RECU PAR LE CLIENT, on le    */
/* s'écrire en base.                                                */
/*------------------------------------------------------------------*/
If asVal = "RPC" Then Return


/*------------------------------------------------------------------*/
/* !!!! Code état Déterminés en fonction des dates 					  */
/*------------------------------------------------------------------*/

/*------------------------------------------------------------------*/
/* Si le CodEtat du fichier n'est pas un de ces deux codes, alors   */
/* on va le déterminer à partir des dates.                          */
/*------------------------------------------------------------------*/
dtDteRcpFrn = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_FRN" ) 
dtDteEnvCli = idwFicFourn.GetItemDateTime ( alCpt, "DTE_ENV_CLI" )
sDestEnvoi	= idwFicFourn.GetItemString 	( alCpt, "DEST_ENVOI" )
dtDteRcpMobCli = idwFicFourn.GetItemDateTime ( alCpt, "DTE_RCP_MOB_CLI" )

dDteRcpFrn = Date ( dtDteRcpFrn )
dDteEnvCli = Date ( dtDteEnvCli )
dDteRcpMobCli = Date ( dtDteRcpMobCli )

// [PC938_ORANGE_V3]
SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

If Not IsNull ( dDteEnvCli ) Then

	CHOOSE CASE sDestEnvoi	
		CASE "SPB"
			// Retourné à la SPB par le fournisseur
			asVal = "RSP"			

		CASE ELSE
			// ENVOYE AU CLIENT PAR LE FOURNISSEUR
			asVal = "ECL"			
	END CHOOSE

	// De plus si la dDteRcpFrn n'était pas renseigné
	//	On y met la dDteEnvCli
	If IsNull ( dDteRcpFrn ) Then idwFicFourn.SetItem ( alCpt, "DTE_RCP_FRN", dDteEnvCli )

ElseIf Not IsNull ( dDteRcpFrn ) Then

	// RECEPTIONNE CHEZ FOURNISSEUR
		asVal = "RCF"

// [PM82][LOT1]		
ElseIf idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) = 155 Then
		asVal = "RPC" 
		
Else
	// EN COURS CHEZ LE FOURNISSEUR
		asVal = "ECT"

End If

// [PC938_ORANGE_V3]
lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 
Choose Case lVal
	Case 262
		sVal = lnvPFCString.of_getkeyvalue (sInfoSpbFrnCplt, "TYP_RELAI", ";")
		
		If sVal = "REMPL" Then
			asVal = "RPC" 
		End If
		
		
	Case 263, 237
		asVal = "RPC" 
		
	Case 151, 152
		asVal = "RFO" 

		
		
End Choose


end subroutine

private function integer uf_integration_fichier_tamet (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_TAMET (PRIVATE)
//* Auteur			: JFF
//* Date				: 13/02/2012
//* Libellé			: Intégration du fichier de CORDON dans la base
//* Commentaires	: [PM200][PSM]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JFF    12/07/2004  DCMP 040206
//* #2	 CAG	  23/09/2004  DCMP 040403 : ajout des colonnes dte_emis_devis et mt_devis
//* #3	 MADM	  09/05/2006  DCMP 060356 : Rempl du frn AEVUM/AVM par CORDON/COR
//* #4    JCA    09/06/2006  MAILPUSH
//* #5    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #6 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #7    JFF    29/07/2009  [20090729111054510] Optimisation intégration (suppression Regl Auto)
//* #8	FPI	10/12/2009	[SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011 [ITSM62176] ajout du point de décimal
//*       JFF   19/09/2011   [PM82][LOT1]
//       JFF     17/04/2012   [PM200][LOT2][DESOX]
//       JFF    26/11/2012  [PC877]
//       JFF   07/05/2013 [PC938_ORANGE_V3]
//       JFF   07/05/2013 [PC929-1]
//       JFF   13/01/2014 [PM246]
// 		FPI	21/07/2014 [PM250-1].FPI Correction réinit de date avant lecture de la ligne
//       JFF   18/08/2014 [PM254_V1]
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn, dtDteArrPlatForm, dtDteDepPlatForm
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu, sCasRetour, sIdAppli, sBase, sCommentFrn
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq, lStatusGc
Decimal {2} dcMtFrais

//#4
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
DateTime	dtDteEnvCli
//#4 FIN
n_cst_string lnvPFCString 

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	// [PM82][LOT1]
	sInfoFrnSpbCplt = "" 
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	// [MANTIS14172]
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	If lCpt = 1 Then sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#4
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )
	

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#4
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )	

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT	#3															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 
	This.uf_definir_codetat_TAMET ( sVal, lCpt, lIdSin, lIdSeq ) // [PC938_ORANGE_V3]
	sSql += "'" + sVal + "', "
	//#4
	sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "
//	sCommentFrn = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	/* #2 CAG : 23/09/2004                                              */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	/* #2 CAG : 23/09/2004                                              */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 19 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal  + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #6 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	// Préparation zone INFO_FRN_SPB_CPLT 
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	// [VDOC3290]
	Choose Case sVal 
		// [PM82][LOT1]
		Case "153" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_153", "OUI", ";")			
		// [PM82][LOT1]			
		Case "154" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_154", "OUI", ";")
		Case "169" 
			// [PC929-1]
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")				

	End Choose
	// [VDOC3290]

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_EN_PDV", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ASSURE_EN_PDV", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NOM_PDV", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_PDV", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NUM_PDV", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NUM_PDV", sVal, ";")
	End If	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_ENVOIE_COLIS", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ASSURE_ENVOIE_COLIS", sVal, ";")
	End If	

	// [PC869]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DONNEES_RECUPEREES", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DONNEES_RECUPEREES", sVal, ";")
	End If	

	// [PM200][LOT2][DESOX]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRESENCE_OX", ";")
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRESENCE_OX", sVal, ";")
	End If	
	
	// [PC938_ORANGE_V3]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RESTIT_APP_PRET", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RESTIT_APP_PRET", sVal, ";")
	End If

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ETAT_APP_PRET", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ETAT_APP_PRET", sVal, ";")
	End If		
	
	// [PM246]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If		
	// [PM246]

	// [PM250-1]
	SetNull(dtDteArrPlatForm) // [PM250-1].FPI
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_ARR_PLATFORM", ";")
	If IsDate ( sVal ) Then 
		dtDteArrPlatForm = DateTime ( sVal )
	End If
	
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_ARR_PLATFORM", sVal, ";")
	End If		

	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_ARR_CENTR_DISTRIB", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_ARR_CENTR_DISTRIB", sVal, ";")
	End If		
	
	SetNull(dtDteDepPlatForm) // [PM250-1].FPI
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_DEP_CENTR_DISTRIB", ";")
	If IsDate ( sVal ) Then 
		dtDteDepPlatForm = DateTime ( sVal )
	End If

	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_DEP_CENTR_DISTRIB", sVal, ";")
	End If		
	
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RCP_MOB_CLI", sVal, ";")
	End If		
	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CODE_ERREUR_LIVR", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CODE_ERREUR_LIVR", sVal, ";")
	End If		

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	// [PM250-1]	
	
	
	sSql += "'" + sInfoFrnSpbCplt + "'"

	If iRet >=0 Then iRet = 1
	
	// #4
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #5
		F_commit ( SQLCA, False ) // #5
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #5
		Continue // #5
	End If
	//#4 FIN

	// [PC877]
	If lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ASSURE_EN_PDV", ";") <> "OUI" Then
		iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
		If iRetMailPush <> 0 Then
			iRet = -1
			alNbLigNonTraitee	++ // #4
			F_commit ( SQLCA, False ) // #4
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
			Continue // #4
		End If
	End if 

	// [PM250-1]
	iRetMailPush = SQLCA.PS_S_MAILPUSH_ARR_PLATFORM ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteArrPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_ARR_PLATFORM, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	
	iRetMailPush = SQLCA.PS_S_MAILPUSH_DEP_CENTRDISTRIB ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteDepPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_DEP_CENTRDISTRIB, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	// [PM250-1]		
	
	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++			//  #8
			F_commit ( SQLCA, True ) // #5
		Else 
			iRet = -1
			alNbLigNonTraitee	++ // #5
			F_commit ( SQLCA, False ) // #5
			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #5
			Continue // #5
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++ // #5
		F_commit ( SQLCA, False ) // #5
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #5
		Continue // #5
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #5


Return iRet 
end function

private function integer uf_ctrl_fichier_cdiscountpro_new ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_CDISCOUNTPRO (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 20/04/2009
//* Libellé			: Controler de la validité du fichier du CDISCOUNTPRO
//* Commentaires	: [DCMP090102]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #2   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #3    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   02/03/2015 [PM289_CDP]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sTypArtOrig, sIdFourCtrl, sVal1
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1, dtNull
Long	lIdSin, lIdSeq //#2

iRet = 1

Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV
Int iStatusGc, iInfoSpbFrn

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	//* [20091228114718123]
	sIdFourCtrl = "CDP"
	
	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.


	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	// #2 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_cdiscountpro_new (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_CDiscountPRO (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Intégration du fichier du CDiscountPRO dans la base
//* Commentaires	: 
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	FPI	10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//       JFF   18/08/2014 [PM254_V1]
//       JFF   02/03/2015 [PM289_CDP]
//       JFF   10/12/2015 [VDOC19376]
//       JFF   07/07/2016 [VDOC21299]
//       JFF   22/02/2020 [VDOC30171]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig, sVal1, sVal2
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc
String sCommentFrn, sInfoFrnSpbCplt

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli
n_cst_string lnvPFCString  

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ), "dd/mm/yyyy" ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	If Trim ( sVal ) = "''" Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "CDV_CODETA" ) ) )
	sVal2 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "EVE_CODETA" ) ) )
	If IsNull ( sVal1 ) Then sVal1 = ""
	If IsNull ( sVal2 ) Then sVal2 = ""	

	// [VDOC30171]
	// [VDOC19376]
	//	[VDOC21299] S
	Choose Case sVal2
		Case "A"
			sVal = "ANN"				

		Case "V", "S"
			sVal = "RPC"

		// [VDOC30171]
		Case "P", "C"
			Choose Case sVal1 
				Case "S" 
					sVal = "RPC"
				Case Else
					sVal = "ECT"						
			End Choose 
			
		Case Else
			sVal = "ECT"
	End Choose	
	// [VDOC19376]
		

	sSql += "'" + sVal + "', "
	//#1
	sDestEnvoi = "CLIENT"

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = ""
	sCommentFrn = sVal	

	// [VDOC30171]
	Choose Case True
		Case sVal2 = "A"
			sVal = "Commande annulée par le fournisseur, veuillez repasser une commande"

		Case sVal1 = "C" And sVal2 = ""
			sVal = "Commande créée, non validée, non expédiée."

		Case sVal1 = "V" And sVal2 = ""
			sVal = "Commande créée, validée, non expédiée."
			
		Case ( sVal1 = "V" And sVal2 = "P" ) OR ( sVal1 = "" And sVal2 = "P" ) Or ( sVal1 = "V" And sVal2 = "C" ) Or ( sVal1 = "" And sVal2 = "C" )
			sVal = "Commande créée, validée, en préparation d'expédition."
			
		Case sVal2 = "V"  Or sVal2 = "S" 
			sVal = "Commande créée, validée, expédiée."

		// [VDOC30171]
		Case sVal2 = "P" Or sVal2 = "C"
			Choose Case sVal1 
				Case "S" 
					sVal = "Commande créée, validée, expédiée."
				Case Else
					sVal = ""
			End Choose 
			
		Case Else
			sVal = ""
	End Choose	
		
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'" 
	sCommentFrn = sVal			
	
	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	// On regarde en fait que EVE (cf EDB)
	// [VDOC19376]
	//	[VDOC21299] S
	// [VDOC30171]

	Choose Case sVal2
		Case "A"
			sVal = "176"	

		Case "V", "S"
			sVal = "178"

		// [VDOC30171]
		Case "P", "C"
			Choose Case sVal1 
				Case "S" 
					sVal = "178"
				Case Else
					sVal = "0"
					
			End Choose 
			
		Case Else
			sVal = "0"
	End Choose		
	
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	sInfoFrnSpbCplt = ""

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "CDV_CODETA" ) ) )
	If IsNull ( sVal ) Then sVal = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CDV_CODETA", sVal, ";")			

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "EVE_CODETA" ) ) )
	If IsNull ( sVal ) Then sVal = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "EVE_CODETA", sVal, ";")			

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	sSql += "'" + sInfoFrnSpbCplt + "'"


	// #1
	setNull ( dtDteRcpFrn )
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If				
	// Fin #1

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++					// #4
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private function integer uf_ctrl_fichier_cdiscountpro_ano ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_CDISCOUNTPRO_ano (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 04/03/2015
//* Libellé			: 
//* Commentaires	: [PM289_CDP]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #2   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #3    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   02/03/2015 [PM289_CDP]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sTypArtOrig, sIdFourCtrl
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1
Long	lIdSin, lIdSeq //#2

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	//* [20091228114718123]
	sIdFourCtrl = "CDP" // Et surtout pas CDA !
	

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.


	// #2 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_cdiscountpro_ano (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_CDiscountPRO_ano (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Intégration du fichier du CDiscountPRO dans la base
//* Commentaires	: 
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	FPI	10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//       JFF   18/08/2014 [PM254_V1]
//       JFF   02/03/2015 [PM289_CDP]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig, sMesErr
Long		lTotLig, lCpt, lVal, lStatusGc
String sCommentFrn, sInfoFrnSpbCplt

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli
n_cst_string lnvPFCString  

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sSql = sSqlOrig

	sMesErr = Trim ( idwFicFourn.GetItemString ( lCpt, "MESSAGEERROR" ) )
	If IsNull ( sMesErr ) Then sMesErr = ""
	If Left ( sMesErr, 11) <> "Non traitée" Then Continue

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	sVal = "ANN"
	sSql += "'" + sVal + "', "
	//#1

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = sMesErr
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + ". Commande annulée par le fournisseur, veuillez règler l''assuré en numéraire" + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = "176"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // [O2M] JFF le 07/01/2008

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	sInfoFrnSpbCplt = ""

	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ANO_CDP", "OUI", ";")			
	
	sSql += "'" + sInfoFrnSpbCplt + "'"

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++					// #4
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue		
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private function integer uf_ctrl_fichier_sbe_old ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_SBE (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 21/06/2003
//* Libellé			: Controler de la validité du fichier SBE
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #2    JFF   07/12/2009   [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIdFourCtrl, sIMEICorr 
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datastore	dsCode

Long	lIdSin, lIdSeq //#1

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 	

//For lCpt = 1 To lTotLig // #1
For lCpt = lTotLig To 1 Step -1

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #1
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #1

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Un numéro d'IMEI doit contenir 15 chiffres" )
	End If

	If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Numéro d'IMEI non valide" )
	End If 

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COD_ETAT_CMD														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COD_ETAT_CMD" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "ANN", "RPC"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le code état doit être null ou égal à ANN ou RPC, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	// #2 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private subroutine uf_definir_codetat_sbe (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_SBE (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 12/07/2004
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: 
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF   19/09/2011   [PM82][LOT1]
//        JFF   19/04/2016   [DT209]
//*-----------------------------------------------------------------

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	// [DT209] 601, 602
	Case 2,21,151,152,153,154,155,157,160,161, 165, 166, 170, 171, 167, 168, 179 , 175, 176, 237, 601, 602

		// [VDOC9304_PM82_LOT1]
		// [VDOC15485]
		If ( ( lVal = 153 Or lVal = 154 ) And sIdTypArt = "PRS" ) Then
			asVal = "ECT"  // EN COURS DE TRAITEMENT
		Else
			asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)
		End If

	Case 178, 263, 234 // [PM166][O2M] // [PC938_ORANGE_V3]

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		

// [RECUP_DONNEE_O2M]
Choose Case sIdRefFour
	Case "PEC_A_RECYCLER", "PAS_DE_COMMANDE"
		asVal = "RFO"
End Choose 


end subroutine

private function integer uf_integration_fichier_sbe (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_SBE (PRIVATE)
//* Auteur			: JFF
//* Date				: 10/04/2015
//* Libellé			: Intégration du fichier SBE dans la base
//* Commentaires	: // [DT141]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #2    JFF   28/04/2008   [DCMP080202] MailPush O2M
//* #3	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #4	 FPI	 10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF   30/06/2010   [PC363_AUCHAN]
//*       JFF   07/03/2011   [VDOC3290]
//*       JFF   11/03/2011   [ITSM62176] ajout du point de décimal
//*       JFF   19/09/2011   [PM82][LOT1]
//*       JFF   05/01/2012   [RECUP_DONNEE_O2M]
//        JFF   06/08/2012   [BLCODE]
//       JFF   07/05/2013 	  [PC938_ORANGE_V3]
//       JFF   03/07/2013 		[VDOC9908]
//       JFF   08/04/2014 [PM255]
//       JFF   07/05/2013 [PM250-1]
//       JFF   02/06/2014 [PC929_CDISCOUNT][PC929-2-V3]
// 		FPI	21/07/2014 [PM250-1].FPI Correction réinit de date avant lecture de la ligne
//       JFF   18/08/2014 [PM254_V1]
//       JFF   25/08/2014 [DT100]
//       JFF   16/09/2014 [PM250-2]
//			JFF	25/09/2014		[MODIF_SUITE_REDR]
//       JFF   25/11/2014 		[PM251-2]
//       JFF   19/04/2016 [DT209]
//       JFF   28/01/2019 [PM450-1]
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn, dtDteArrPlatForm, dtDteDepPlatForm 
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq
Decimal {2} dcMtFrais
String sInfoFrnSpbCplt  	// #3 [FNAC_PROD_ECH_TECH]
n_cst_string lnvPFCString  // [PC363_AUCHAN]
Int iRetMailPush 
String sDestEnvoi, sNumBonTrsp 
DateTime dtDteEnvCli
String sCasRetour, sIdAppli, sBase, sCommentFrn 
Long lStatusGc 
Boolean bF_CLE_A_TRUE_DT209

bF_CLE_A_TRUE_DT209 = F_CLE_A_TRUE ( "DT209" )

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

sInfoFrnSpbCplt = ""
iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	// [MANTIS14172]
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	// [BLCODE]
	sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 			
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
 	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOUV" ) ) + "'"
	If IsNull ( sVal ) Then 
		sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_ANC" ) ) + "'"
		If IsNull ( sVal ) Then 
			sVal = "null"
		End If
	End If 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// [PM255] // [PM250-2]
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	// [DT209]
	If bF_CLE_A_TRUE_DT209 Then
		This.uf_definir_codetat_SBE ( sVal, lCpt, lIdSin, lIdSeq )
	Else
		This.uf_definir_codetat_O2M ( sVal, lCpt, lIdSin, lIdSeq )
	End If
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "
//	sCommentFrn = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "


	/*------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#1 [DCMP080199]			  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NOM_TRANSPORTEUR" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ","

	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "


	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FACT_PRESENTE" ) ) ) 
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "FACT_PRESENTE", sVal, ";")
	End If
	
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "MARQ_REMPL" ) ) ) 
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQ_REMPL", sVal, ";")
		lnvPFCString.of_Setkeyvalue ( sChaineMailRempl, "MARQ_REMPL", sVal, ";")		
	End If

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "MODL_REMPL" ) ) ) 
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODL_REMPL", sVal, ";")
		lnvPFCString.of_Setkeyvalue ( sChaineMailRempl, "MODL_REMPL", sVal, ";")				
	End If

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "TYPE_SWAP" ) ) ) 
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TYPE_SWAP", sVal, ";")
	End If

	sVal = Trim ( String ( idwFicFourn.GetItemDecimal ( lCpt, "MT_TTC_REMPL" ) ) ) 
	If IsNull ( sVal ) Then sVal = "0"
	If Len ( Trim ( sVal ) ) > 0 Then
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MT_TTC_REMPL", sVal, ";")
	End If

	// Préparation zone INFO_FRN_SPB_CPLT 
	/*
	If Not IsNull( sInfoFrnSpbCpltLu ) and Trim ( sInfoFrnSpbCpltLu ) <> "" Then 
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQUE_REMPL", ";")
		If Len ( Trim ( sVal ) ) > 0 Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQUE_REMPL", sVal, ";")
		End If
	End If
	*/

	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	// [VDOC3290]
	Choose Case sVal 
		Case "169" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")
		Case "162" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SYMP_NON_DETEC_EN_24H", "OUI", ";")			

		// [PM82][LOT1]
		Case "153" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_153", "OUI", ";")			
		// [PM82][LOT1]			
		Case "154" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_154", "OUI", ";")			
	End Choose
	// [VDOC3290]


	// [PM246]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If		
	// [PM246]

	// [PM250-1]
	SetNull(dtDteArrPlatForm) // [PM250-1].FPI
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_ARR_PLATFORM", ";")
	If IsDate ( sVal ) Then 
		dtDteArrPlatForm = DateTime ( sVal )
	End If
	
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_ARR_PLATFORM", sVal, ";")
	End If		

	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_ARR_CENTR_DISTRIB", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_ARR_CENTR_DISTRIB", sVal, ";")
	End If		
	
	SetNull(dtDteDepPlatForm) // [PM250-1].FPI
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_DEP_CENTR_DISTRIB", ";")
	If IsDate ( sVal ) Then 
		dtDteDepPlatForm = DateTime ( sVal )
	End If

	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_DEP_CENTR_DISTRIB", sVal, ";")
	End If		
	
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RCP_MOB_CLI", sVal, ";")
	End If		
	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CODE_ERREUR_LIVR", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CODE_ERREUR_LIVR", sVal, ";")
	End If		
	
	// [PC929_CDISCOUNT][PC929-2-V3]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "RDV_CONF", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RDV_CONF", sVal, ";")
	End If		

	// [PM251-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "REMIS_EN_STK", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "REMIS_EN_STK", sVal, ";")
	End If		
	// [PM250-1]	

	// [PM450-1]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
	End If

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	
	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sSql += "'" + sInfoFrnSpbCplt + "'"

	// #2 [DCMP080202]
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ 
		F_commit ( SQLCA, False ) 
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue 
	End If
	// :#2

	// [PM255] // [DT100] [PM250-2]
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, "CLIENT", sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If	

	// [PM250-1]
	iRetMailPush = SQLCA.PS_S_MAILPUSH_ARR_PLATFORM ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteArrPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_ARR_PLATFORM, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	
	iRetMailPush = SQLCA.PS_S_MAILPUSH_DEP_CENTRDISTRIB ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteDepPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_DEP_CENTRDISTRIB, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	// [PM250-1]	


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
	//		alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #4
			F_commit ( SQLCA, True )
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		
		// [MODIF_SUITE_REDR]
		sVal = SQLCA.SQLErrText		
		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")	

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + sVal )

		F_commit ( SQLCA, False )
			
		Continue 
	End If
	

Next

If alNbLigNonTraitee	> 0 Then iRet = -1

Return iRet 
end function

public function integer uf_mailpush (string ascas, long adcidsin, integer aiidseq, datetime adtdtercpfrn, datetime adtdteenvcli, string asdestcli, string asnumbontrsp, long alstatusgc, string aschaine, string ascommentfrn);//*-----------------------------------------------------------------
//*
//* Fonction      : n_cst_int_Fic_SuiviCmd::uf_MailPush (PRIVATE)
//* Auteur        : Fabry JF
//* Date          : 08/06/2006 
//* Libellé       : Envoi de mail en Push sur Evt déclencheur en provenance du Frn
//* Commentaires  : 
//*
//* Arguments     : String asCas					Val
//*					  Long	adcIdSin 			Val
//*					  Int		aiIdSeq				Val
//*					  DateTime adtDteRcpFrn		Val
//*					  DateTime adtDteEnvCli		Val
//*					  String asDestCli				Val
//*					  String asNumBonTrsp			Val
//*
//* Retourne      : <0 Si Erreur SPB
//*					  >0 Si Erreur SQLServer
//*					  =0 SI oK
//*					
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF     05/01/2012 [RECUP_DONNEE_O2M]
//*-----------------------------------------------------------------

String sIdAppli
String sBase
String sCasRetour
Long lRet
Boolean bCasTrouve 

lRet = 0
bCasTrouve = True
sCasRetour = Fill ( " ", 50 )

sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )

Choose Case asCas
	Case "RECP_APP_EN_CTR"
		lRet = SQLCA.PS_S02_MAILPUSH_RECP_APP_EN_CTR ( sIdAppli, sBase, adcIdSin, aiIdSeq, adtDteRcpFrn, sCasRetour ) // [RECUP_DONNEE_O2M]

	Case "ENVTEL_REMP_REPAR"
		lRet = SQLCA.PS_S03_MAILPUSH_ENVTEL_REMP_REPAR_V03 ( sIdAppli, sBase, adcIdSin, aiIdSeq, adtDteEnvCli, asDestCli, asNumBonTrsp, alStatusGC, asCommentFrn, asChaine, sCasRetour ) 

	// [RECUP_DONNEE_O2M]
	Case "RECUP_DONNEES_MAIL_AXALOT"
		 // lRet = SQLCA.PS_S_MAILPUSH_MAIL_AXALOT ( sIdAppli, sBase, adcIdSin, aiIdSeq, "1ER_MAIL", sCasRetour ) 		

	Case Else
		bCasTrouve = False
		
End Choose 		

If bCasTrouve Then
	If lRet <> 0 Then Return lRet
	If SQLCA.SQLCode <> 0 Or SQLCA.SQLDBCode <> 0 Then Return -100
End If 	

Return lRet

end function

private function integer uf_ctrl_fichier_carma ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_Carma (PRIVATE)
//* Auteur			: FPI
//* Date				: 11/05/2016
//* Libellé			: Controle de la validité du fichier Carma
//* Commentaires	: [DT111]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
// 		 JFF	22/09/2017 [CTRLE_DATE_INTRG_FOU]
//*-----------------------------------------------------------------

Int iRet 
String	sIdFour, sVal, sCar, sIdFourCtrl, sIMEICorr, sInfoFrnSpbCpltLu, sVal1
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datastore	dsCode
n_cst_string lnvPFCString
Long	lIdSin, lIdSeq //#2
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sChaineBCV
Int iStatusGc,  iInfoSpbFrn 
Long  dcIdprod
String sInfoSpbFrnCplt
datetime	dtVal, dtVal1, dtNull 
String sInfoFrnSpbCplt


iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )


	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	sIdFourCtrl = sVal


	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  	
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If
	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_carma (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_Carma (PRIVATE)
//* Auteur			: FPI
//* Date				: 12/05/2016
//* Libellé			: Intégration du fichier de CARMA dans la base
//* Commentaires	: [DT111]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn, dtDteArrPlatForm, dtDteDepPlatForm
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu, sCasRetour, sIdAppli, sBase, sCommentFrn
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq, lStatusGc
Decimal {2} dcMtFrais

//#4
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
DateTime	dtDteEnvCli
//#4 FIN
n_cst_string lnvPFCString 

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" 
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )


	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	If lCpt = 1 Then sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
		/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )
	

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )	

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT	#3															  */
	/*------------------------------------------------------------------*/
	sVal = "RPC"
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "''"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal ) // [PM246]

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	/* #2 CAG : 23/09/2004                                              */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	/* #2 CAG : 23/09/2004                                              */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal  + ", " 

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " 

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sInfoFrnSpbCplt= sInfoFrnSpbCpltLu
		
	sSql += "'" + sInfoFrnSpbCplt + "'"

	If iRet >=0 Then iRet = 1
	
	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
			alNbLigMod ++			
			F_commit ( SQLCA, True ) 
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1 


Return iRet 
end function

private function integer uf_ctrl_fichier_bak2 ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_bak2 (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/03/2006
//* Libellé			: Controler de la validité du fichier du CORIOLIS
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #3   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//* 		 JFF     03/05/2011 [PM178][CORIOLIS]
//* 		 JFF     23/11/2012 [VDOC9416]
//       JFF   20/12/2012     [VDOC9337]
// 		JFF	22/09/2017 [CTRLE_DATE_INTRG_FOU]
//       JFF   28/01/2019 [PM450-1]
//*-----------------------------------------------------------------

n_cst_string lnvPFCString
Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl, sVal2, sInfoFrnSpbCpltLu 
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1
Long	lIdSin, lIdSeq //#2
datastore	dsCode

Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC')

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)


	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Un numéro d'IMEI doit contenir 15 chiffres" )
	End If

	If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Numéro d'IMEI non valide" )
	End If 

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	

	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.


	/*------------------------------------------------------------------*/
	/* ZONE 10 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )

	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
//	if dsCode.retrieve('-GC') > 0  then											// #9 - Chargement au début de la fct
			// #3 [FNAC_PROD_ECH_TECH] agrandissement jusqu'à 160
			// #4 [DCMP090109] ajout 2, 21
			// #5 [DCMP090085] ajout jusqu'à 169
			// #6 [DCMP090327].[SBETV] (171)
			// [PM166][O2M]
			// [MANTIS3067] ajout 231
			// [VDOC10641] 174
			// [PM287-3] not in 305, 306
			if dsCode.find("ID_CODE IN (178, 176 ) " , 1, dsCode.RowCount()+1 ) = 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
			End If

	/*------------------------------------------------------------------*/
	/* ZONE 11 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.
	
	// [CTRLE_DATE_INTRG_FOU]
	sVal  = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  	
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "COLIS_PND", &
				  "COLIS_NRPAC", &
				  "COLIS_PERDU", &
				  "COLIS_BALNI", &
				  "COLIS_INCOR", &
				  "COLIS_REFUS", &
				  "ANNUL_REFAIT", &
				  "EN_ATTENTE", &
				  "AUTRE", &
				  "J1", &
				  "J2", &
				  "J3", &
				  "J4", &
				  "J5", &
				  "J6" 
			
					// Ok
					
			Case Else 

				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
	End IF 
	
	// [PM450-1]
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";"))
	sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))	

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""		
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PEC_PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
		
		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la clé PEC_PRBLE_LIVRAISON n'est autorisée que si précédemment il y a au un clé PRBLE_LIVRAISON, qui est justement absente." )
		End If 			
	End If 	
	
	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If


Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

if isvalid(dsCode) Then destroy dsCode

Return iRet


end function

private function integer uf_integration_fichier_bak2 (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_Bak2 (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 31/08/2001
//* Libellé			: Intégration du fichier du Coriolis dans la base
//* Commentaires	: //[PM178][CORIOLIS]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	  24/04/2008  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	 FPI	  10/12/2009  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//  			FPI	04/08/2011	[FPI.04082011] Prise en compte de la date de réception des mobiles par les assurés
//       JFF   18/08/2014 [PM254_V1]
//       JFF   28/01/2019 [PM450-1]
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn
String sChaineMailRempl, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu
Long		lTotLig, lCpt, lVal, lStatusGc
n_cst_string lnvPFCString

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "


lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0


For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" 
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteRcpFrn =  idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_BAK2 ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "
	//#1
	sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	// [FPI.04082011]
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	// [PM254_V1]
	sVal = "null"
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")	
	
	// [PM246]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If		
	// [PM246]
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CODE_ERREUR_LIVR", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CODE_ERREUR_LIVR", sVal, ";")
	End If		
	
	// [PM450-1]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
	End If
	
	sSql += "'" + sInfoFrnSpbCplt + "'"

	// #1
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If				
	// Fin #1

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private subroutine uf_definir_codetat_bak2 (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_Bak2 (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 12/20/2016
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: // [DT076-2]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

Date 	dDteRcpFrn, dDteEnvCli
DateTime dtDteRcpFrn, dtDteEnvCli
String	sDestEnvoi


Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
	Case 178, 176
		asVal = "RPC"  
	Case Else 
		asVal = "ECT"  
	
End CHoose 


end subroutine

private function integer uf_ctrl_fichier_cordon ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_CORDON (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 24/02/2017
//* Libellé			: Controler de la validité du fichier CORDON
//* Commentaires	: [DT288]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #2	JCA	12/12/2007		DCMP 70918
//* #3   JFF	20/10/2008		[FNAC_PROD_ECH_TECH]
//* #4   JFF	30/04/2009		[DCMP090109]
//* #5   JFF	14/05/2009		[DCMP090085]
//* #6   JFF   02/09/2009 		[DCMP090327].[SBETV]
//* #7   JFF   07/12/2009     [MSS_DIAG].[20091207111441740]
//* #8   JFF   28/12/2009     [20091228114718123]
//* #9	FPI	25/01/2010	   [DCMP090759] 
//*      JFF   04/05/2010     [DCMP100333]
//*   	SBA	25/06/2010 	   [BUG.CTRLFICSUIVI]
//*		FPI	11/08/2010	   [PM01] Ajout des retours 167 & 168
//*      JFF   22/09/2010     [PM01].[LOT3&4]
//* 		JFF   03/05/2011     [PM166][O2M]
//* 		JFF   06/05/2011     [VDOC3731]
//* 		FPI   19/08/2011     [VDoc4752]
//*      JFF   09/09/2011     [PC499][PC501][PC545][-1x3][V5]
//*      JFF   19/09/2011     [PM82][LOT1]
//* 		JFF   06/05/2011     [VDOC5774]
//* 		FPI   01/12/2011     [VDoc6082]
//*      JFF   05/01/2012 		[RECUP_DONNEE_O2M]
//*      JFF   23/01/2012     [VDOC6300]
//*      JFF   20/03/2012     [CTRL_IMEI_O2M] ajout contrôle IMEI
//*      JFF   04/04/2012     [MANTIS3067] satut 231
//*      JFF   30/05/2012	   [VDOC7926]
//       JFF   06/08/2012     [BLCODE]
//       JFF   30/08/2012     [VDOC8041]
//       JFF   26/11/2012     [PC877]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   10/01/2013     [VDOC9907]
//       JFF   10/01/2013     [VDOC10029]
//       JFF   19/02/2013	   [VDOC9304_PM82_LOT1]
//       JFF   07/05/2013 		[PC938_ORANGE_V3]
//       JFF   03/07/2013 		[VDOC9908]
//       JFF   09/09/2013 		[VDOC10641]
//       JFF   09/09/2013 		[PM222-1]
//       JFF   30/12/2013 [PC13348&13408]
//		   FPI	28/07/2014	[20140728.FPI] Ajout ctl de longueur
//			JFF	25/09/2014		[MODIF_SUITE_REDR]
//       JFF   02/10/2014 [VDOC15485]
// 		JFF   05/02/2015 [PC13321][MANTIS14042]
// 		JFF	24/03/2015 [VDOC17191]
//       JFF   20/05/2015 [PM284-1]
//		   FPI	02/06/2015 [PM222-1]
//       JFF   05/06/2015 [VDOC17633]
//       JFF   20/07/2015 [DT150]
//       JFF   11/09/2015 [VDOC18200]
//		   FPI	22/09/2015 [ITSM326003] ajout ctl IMEI sur commande de rempl
//       JFF   06/11/2015 [VDOC18931]
//       JFF   29/03/2016 [DT200]
//       JFF   31/03/2016 [PM287-3]
//       JFF   17/05/2016 [PM280-2]
//       JFF   21/11/2016 [DT280]
//       JFF   23/01/2017 [DT290]
//       JFF   10/03/2017 [PM383-1]	
//       JFF   04/04/2017 [DT288][M24505]
//       JFF   04/04/2017 [VDOC23499]
//       JFF   04/05/2017 [DT288-1_LOT2]
// 		JFF	25/08/2017 [CTRLE_REF_A_REEXP]
//       JFF   29/08/2017 [DT288-3_LOT1_2EME_VS]
// 		JFF	22/09/2017 [CTRLE_DATE_INTRG_FOU]
//       JFF   01/10/2018 [PM445-1]
//       JFF   21/11/2018 [VDOC27123]
//       JFF   28/01/2019 [PM450-1]
//       JFF   20/09/2021 [BUG_RST_PRIX_O2M]
//*-----------------------------------------------------------------

Int iRet, iStatusGc, iInfoSpbFrn
String	sIdFour, sVal, sCar, sIdFourCtrl, sInfoFrnSpbCpltLu, sIMEICorr
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sVal1, sVal2, sVal3
String sInfoFrnSpbCplt, sIdTypArtSin
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal, lVal1
Boolean	bTrouve
datastore	dsCode
Long dcIdProd, lTot
String sInfoSpbFrnCplt, sChaineBCV, sNumImeiSerie
String sTabVal[], sTabNull[]
Long lNbreLignDeb, lNbreLignFin
Long	lIdSin, lIdSeq //#2
datetime	dtVal, dtVal1
n_cst_string lnvPFCString  
Boolean bF_CLE_A_TRUE_PM445_1_COR

// [PM445-1]
bF_CLE_A_TRUE_PM445_1_COR = F_CLE_A_TRUE ( "PM445_1_COR" )

iRet = 1

lTotLig = idwFicFourn.RowCount ()

// [MODIF_SUITE_REDR]
If lTotLig <= 0 And FileLength64 ( isTxtNomFic.Text ) > 0 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR : 0 Ligne chargée ! , pour PI : Taille du fichier positive et chargement à 0 ligne => Anormal. Réessayez l'intégration (cause éventuelle => le fichier est peut-être en format Unicode au lieu d'Ansi, à vérifier)." )
End If		

sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 		// #9

// [DT288][M24505]
// Contrôle entete et fin
If lTotLig < 2 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
	" : Le fichier doit comporter au minimum 2 engistrements : entête & fin")
	lTotLig = 0
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( 1, "NUM_CMD_SPB" ) )
	If Pos ( sVal, "DEBUT#" ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne d'entête n'est pas conforme (attendu : DEBUT#xx)")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( 1, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "DEBUT#", "" ) 
	If Not IsNumber ( sVal )  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne d'entête n'est pas conforme, la valeur dérrière DEBUT# doit être un nombre")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( 1, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "DEBUT#", "" ) 
	lNbreLignDeb = Long ( sVal )
	idwFicFourn.RowsDisCard ( 1, 1, Primary! )
	lTotLig = idwFicFourn.RowCount ()	
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( lTotLig, "NUM_CMD_SPB" ) )
	If Pos ( sVal, "FIN#" ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne de fin n'est pas conforme (attendu : FIN#xx)")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( lTotLig, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "FIN#", "" ) 
	If Not IsNumber ( sVal )  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne de fin n'est pas conforme, la valeur dérrière FIN# doit être un nombre")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( lTotLig, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "FIN#", "" ) 
	lNbreLignFin = Long ( sVal )
	idwFicFourn.RowsDisCard ( lTotLig, lTotLig, Primary! )
	lTotLig = idwFicFourn.RowCount ()	
End If

If iRet > 0 Then
	If lNbreLignDeb <> lNbreLignFin Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le nombre de ligne entre la ligne d'entête et la ligne de fin n'est pas identique")
		lTotLig = 0		
	End If 
End If

If iRet > 0 Then
	If lNbreLignDeb <> lTotLig Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le nombre de ligne du fichier dans la ligne d'entête (" + String ( lTotLig ) + ") ne correspond pas au nombre de ligne réel du fichier (" + String ( lNbreLignDeb ) + ")" )
		lTotLig = 0		
	End If 
End If
// /[DT288][M24505]


For lCpt = lTotLig To 1 Step -1

	sIdRefFour = fill(" ",20)
	sCodEtat = fill(" ",3)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)


	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
	// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If
	End If
	
	// [PM82][LOT1]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	
	sIdTypArtSin = lnvPFCString.of_getkeyvalue (sChaineBCV, "TYP_APP_DS", ";") 
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	// [BLCODE]
	If sVal <> sIdFour And sVal <> "BLC" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 
	// [BLCODE]

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_RCP_FRN										*/
	/*------------------------------------------------------------------*/
	// #9
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	// [DCMP100333]
	// [PM166][O2M] 177, 178
	Choose Case lVal
		Case 155, 156, 157, 158, 160, 161, 163, 164, 165, 174, 177, 178
			If Not isNull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End if

		// [PM01].[LOT3&4]
		// [PC499][PC501][PC545][-1x3][V5]
		// [VDOC8041] 232
		// [PM445-1]
		Case 151, 152, 153, 154, 159, 162, 166, 167, 168, 169, 2, 21, 175, 232
			// [PC13321][MANTIS14042]
			sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PERTE_ALLER", ";"))
			If isNull(dtVal) And iInfoSpbFrn <> 957 And sVal <> "OUI" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être renseignée.")
			End if
			
			// [PC13321][MANTIS14042]			
			If Not isNull(dtVal) And iInfoSpbFrn = 957 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", et pour le process spécifique 957, la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End If			

	End Choose

	// Fin #9
	
	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	// [CTRL_IMEI_O2M]
	// [DT288]
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOUV" ) )
	If IsNull ( sVal ) Then sVal = ""
	sVal1 = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_SERIE_NOUV" ) )
	If IsNull ( sVal1 ) Then sVal1 = ""

	sVal2 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))		
	sVal3 = lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") 

	If ( sVal <> "" OR sVal1 <> "" ) And sVal2 <> "OUI" And sVal3 <> "OUI" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Les zones NUM_IMEI_NOUV et NUM_IMEI_SERIE ne peuvent être renseignés que sur un SWAP ou une commande de Remplacement." )
	End If

	If iRet > 0 And sVal <> "" And sVal1 <> "" And ( sVal2 = "OUI" Or sVal3 = "OUI" ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Les zones deux zones NUM_IMEI_NOUV et NUM_IMEI_SERIE ne peuvent pas être renseignées toutes les deux, choisissez." )
	End If

	sNumImeiSerie = ""
	If Len ( sVal ) > 0 And Not IsNull ( sVal ) Then sNumImeiSerie = sVal
	If sNumImeiSerie = "" And Len ( sVal1 ) > 0 And Not IsNull ( sVal1 ) Then sNumImeiSerie = sVal1
	
	If iRet > 0 And sIdTypArtSin = "TEL" And iRet > 0 And ( sVal2 = "OUI" Or sVal3 = "OUI" ) Then 
		sVal = sNumImeiSerie 
	
		If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Un numéro d'IMEI doit contenir 15 chiffres" )
		End If
	
		If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Numéro d'IMEI non valide" )
		End If 
	End If

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_FIN_TRAIT									  */
	/*------------------------------------------------------------------*/
	// #9
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	// [DCMP100333]
	// [PM01].[LOT3&4]
	// [PM166][O2M] 177
	// [PM01] Ajout de 167,168
	// [PC499][PC501][PC545][-1x3][V5]
	Choose Case lVal
		Case 151, 152, 153, 154, 155, 160, 161, 165, 166, 167, 168, 2, 21, 167, 168, 177, 178, 175

			// [PM82][LOT1]
			If ( lVal = 153 Or lVal = 154 ) And sIdTypArt = "PRS" Then
				If Not Isnull (dtVal) Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					", PM82_LOT1 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + " en réparation, la date de fin de traitement (DTE_FIN_TRAIT) ne doit pas être renseignée.")
				End If

			Elseif Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être renseignée.")
			End if
		// [VDOC8041] 232
		Case 156, 157, 158, 159, 162, 163, 164, 169, 232, 174
			if Not Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être vide.")
			End if
			
		Case Else

			If ( lVal = 0 Or IsNull ( lVal ) ) And Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Lorsque la date de fin de traitement (DTE_FIN_TRAIT) est renseignée, un statut GC est obligatoire.")
			End If 
	
			
	End Choose
	// Fin #9

	/*------------------------------------------------------------------*/
	/* ZONE 6 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
	If IsNull ( sVal ) Then sVal = ""		
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	
	Choose Case lVal
			
		Case 177, 178
			If IsNull ( sVal ) Or Len ( sVal ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) )
			End If
		//  [VDoc4752]
		Case 165
			If iInfoSpbFrn = 970 and (IsNull ( sVal ) Or Len ( sVal ) <= 0 ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) +  " pour le process 970.")
			End If
		// :[VDoc4752]
	End Choose

	// [MODIF_SUITE_REDR]
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "NUM_BON_TRP", Trim ( sVal ) )
	
	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
//	if dsCode.retrieve('-GC') > 0  then											// #9 - Chargement au début de la fct
			// #3 [FNAC_PROD_ECH_TECH] agrandissement jusqu'à 160
			// #4 [DCMP090109] ajout 2, 21
			// #5 [DCMP090085] ajout jusqu'à 169
			// #6 [DCMP090327].[SBETV] (171)
			// [PM166][O2M]
			// [MANTIS3067] ajout 231
			// [VDOC10641] 174
			// [PM287-3] not in 305, 306
		if dsCode.find("( ID_CODE BETWEEN 151 AND 171 " + &
							"	OR ID_CODE IN (2, 21, 263, 264, 266, 611, 612 ) " + &
							"  OR ID_CODE BETWEEN 174 AND 179 " + &
							"  OR ID_CODE BETWEEN 231 AND 239" + &							
							"  OR ID_CODE BETWEEN 301 AND 399" + &														
							") AND ID_CODE = " + sVal + &
							"  AND ID_CODE NOT IN ( 305, 306, 232, 309, 310 ) " &
							, 1, dsCode.RowCount()+1 ) = 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
		End If			
//	End IF			// #9

// [PM166][O2M]
// [PM82][LOT1] je remonte cette linge plus haut.
// [RECUP_DONNEE_O2M] PCM 
// [VDOC4970]
// [PM250] Modif suite demande d'Hélène (et CORDON)
	Choose Case Upper ( sIdTypArt ) 
		Case "EDI", "PRS", "PCM"
			Choose Case Long ( sVal ) 
				Case 177, 178
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC " + sVal + " n'est autorisé que pour les commandes de matériel (hors Batterie amovible BAM et Câble d'alimentation ALE)" )
			End Choose
		Case Else
			Choose Case Long ( sVal ) 
				Case 177, 178, 176, 233, 263, 234, 235, 236, 237,238, 239, 301, 304
					
					// [PC938_ORANGE_V3]
					// C'est Ok
					// [MODIF_SUITE_REDR]
					If Long ( sVal ) = 234 Then
						If Not ( sIdTypArt = "REA") And Not ( sIdTypArt = "PST" And Trim ( lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt, "TYP_RELAI", ";")) <> "PRET" ) Then
							iRet = -1
							This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
							" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Status GC " + sVal + " autorisé uniquement sur une presta de type PST sans PRET ou une presta de type REA" )
						End If
					End If 
					
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Status GC " + sVal + " non autorisé pour une commande de matériel (hors Batterie amovible BAM et Câble d'alimentation ALE)" )

			End Choose
			
	End Choose
// :[PM166][O2M]

	// [VDOC3731]
	Choose Case iInfoSpbFrn
		// [VDOC5774] 435, 1502
		Case 1503, 1504, 435, 1502
			Choose Case Long ( sVal ) 
				Case 166
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
			
		Case 1505
			Choose Case Long ( sVal ) 
				Case 167, 168
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
		// [VDoc4752]
		Case 970
			Choose Case Long ( sVal )
					// [VDoc6082] ajout du statut_gc 164
				Case 165,164
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
			// :[VDoc4752]
			
		// [VDOC6300] // [PC877]
		Case 964, 969
			Choose Case Long ( sVal )
				Case 179
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose			
			
	End Choose		

	Choose Case Long ( sVal ) 
		Case 166
			// [VDOC5774] 435, 1502
			Choose Case iInfoSpbFrn
				Case 1503, 1504, 435, 1502
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		Case 167, 168
			Choose Case iInfoSpbFrn
				Case 1505
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		// [VDOC6300] // [PC877]
		Case 179
			Choose Case iInfoSpbFrn
				Case 964, 969
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
	End Choose			
	// :[VDOC3731]	

	// [VDOC8041]
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal 
		Case 232
			If Upper ( sIdTypArt ) <> "PRS" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If

	End Choose

	Choose Case sIdTypArt  
		Case "PRS"
			// OK
		Case Else
			If lVal = 232 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If

	End Choose
	// [VDOC8041]

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COMMENT_FRN														     */
	/*------------------------------------------------------------------*/
	// Pas de Controle Particulier
	// [MODIF_SUITE_REDR]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "COMMENT_FRN", Trim ( sVal ) )


	/*------------------------------------------------------------------*/
	/* ZONE   : info_frn_spb_cplt													  */
	/*------------------------------------------------------------------*/
	// [PM166][O2M]
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	
	If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = "" 

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";"))
	If len ( Trim ( sVal ) ) > 0 And Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone sérialisée DTE_RCP_MOB_CLI ne contient pas une date valide" )
	End If 

	// [PC938_ORANGE_V3]
	If len ( Trim ( sVal ) ) > 0 Then 
		Choose Case lVal 
			Case 178, 233, 263, 234, 2, 21
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone sérialisée DTE_RCP_MOB_CLI ne peut être renseignée sans le statut 178, 233, 263, 234, 2, 21" )
		End Choose
	End If

	// [PC938_ORANGE_V3]
	If len ( Trim ( sVal ) ) > 0 And ( lVal = 178 Or lVal = 233 Or lVal = 263 ) And ( IsNull ( dtVal ) Or Date ( dtVal ) = 1900-01-01 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone DTE_FIN_TRAIT doit être renseignée avant de renseigner la zone DTE_RCP_MOB_CLI et de donner le statut 178 ou 233 ou 263" )
	End If

  /* [VDOC9908]		
	If lVal = 178 And len ( Trim ( sVal ) ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut 178 oblige à avoir la zone sérialisée DTE_RCP_MOB_CLI renseignée." )
	End If
	*/
	// [PM166][O2M]

	// [VDOC7926]
	Choose Case dcIdProd
		Case 41101, 41103 
			
			sVal  = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQUE_REMPL", ";"))	
			sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODELE_REMPL", ";"))	
			sVal2 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_PUBLIC", ";"))	
			sVal3 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_O2M", ";"))	

			If len ( Trim ( sVal ) ) > 0 OR len ( Trim ( sVal1 ) ) > 0 OR len ( Trim ( sVal2 ) ) > 0 OR len ( Trim ( sVal3 ) ) > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7926) : Les binômes clés/valeurs pour les clés MARQUE_REMPL, MODELE_REMPL, PRIX_TTC_PUBLIC, PRIX_TTC_FACTU_O2M ne sont pas autorisés pour le produit " + String ( dcIdProd ) + "." )
			End If
			
	End Choose
	// :[VDOC7926]

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	
	
	// [VDOC9907]
	// Mettre en place pour CORDON ces règles, rejet du fichier MPR si : 
	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un status_gc différent de 21 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If lVal <> 21 And ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9907/A.RAULT) : présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un status_gc différent de 21 , interdit " )
	End IF

	// Mettre en place pour CORDON ces règles, rejet du fichier MPR si : 
	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour à une commande avec action = A_REPARER ou A_REPARER_FORCE 
	// [PM222-1]	
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) &
		 And ( sIdRefFour = "A_REPARER" Or sIdRefFour = "A_REPARER_FORCE" ) &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REP_GARANTIE", ";") <> "OUI" &		 
	Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9907/A.RAULT) : présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour sur une commande sans demande de SAV (donc n’impliquant pas d’action = A_REPARER_SAV ou A_CONTROLER_SAV ), interdit" )
	End IF 
	// :[VDOC9907]
	
	// [VDOC10029]	
	sVal1 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_O2M", ";")
	sVal2 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_BLC", ";")
	sVal3 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_PUBLIC", ";")
	
	If IsNumber ( sVal1 ) Then
		sVal = sVal1
	End If	

	If IsNumber ( sVal2 ) Then
		sVal = sVal2
	End If	

	If IsNumber ( sVal ) And IsNumber ( sVal3 ) Then
		
		If Dec ( sVal ) > Dec ( sVal3 ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC10029/A.RAULT) : le montant du prix facturable par CORDON concernant la proposition est supérieur au prix public indiqué, ce qui est incohérent" )
		End If
		
	End If
	// [VDOC10029]		
	
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "ORANGE_V3", ";") = "OUI" Then
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		If sIdRefFour = "A_DIAGNOSTIQUER" And lVal <> 151 And lVal <> 152 And lVal <> 159 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (ORANGE V3) : Pour Orange v3, seul le 151 ou 152 sont autorisé sur le Diag après remplacement" )
		End IF 
	End IF 			
	// [PC938_ORANGE_V3]
	
	// [20140728.FPI] 
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODL_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 35 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MODL_RST_FRN trop longue (35 caractères maximum autorisés)." )
	End if
	
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQ_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 35 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MARQ_RST_FRN trop longue (35 caractères maximum autorisés)." )
	End if

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_REF_FOUR_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 20 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée ID_REF_FOUR_RST_FRN trop longue (20 caractères maximum autorisés)." )
	End if
	// [20140728.FPI] 

	
	// [MODIF_SUITE_REDR]
	Choose Case iStatusGc
		Case 176, 151, 152, 2, 21
	
			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			// [VDOC17191] je ne déclenche pas le message sur le 159
			Choose Case lVal
				Case 301, 159, 156
					// Ok
				Case Else
					If iStatusGc <> lVal Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
					End If

			End CHoose
			
	End CHoose
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 155 And sIdRefFour <> "REFUSE_A_REEXP" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " ne peut être renvoyé que sur une prestation de type REFUSE_A_REEXP" )
	End If

	// [CTRLE_REF_A_REEXP]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal <> 155 And sIdRefFour = "REFUSE_A_REEXP" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") une prestation de type REFUSE_A_REEXP ne peut recevoir qu'un Statut 155 en retour, et non " + String ( lVal ) + "." )
	End If
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	Choose Case sIdRefFour  
		Case "A_REPARER_FORCE", "A_DIAG_FORCE"

			If lVal > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il est interdit de répondre sur les prestations de type A_REPARER_FORCE, et A_DIAG_FORCE, or vous renvoyez le Statut " + String ( lVal ) + ". Si une réponse doit être apportée, vous devez répondre sur la préstation d'origine liée à ce forçage." )
			End If
	End Choose		
	
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	
	// [DT288-3_LOT1_2EME_VS] 612
	Choose Case lVal
		Case 152, 21, 612
			
			If IsNull ( sVal ) Or sVal = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " doit obligatoirement être accompagné d'un commentaire." )
			End If
			
	End CHoose

	// [PM251-2]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") <> "OUI" Then
		sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "REMIS_EN_STK", ";"))		
		If sVal1 = "OUI" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " n'est autorisé que pour une commande de remplacement." )
		End If	
	End If

	// [DT288]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") = "OUI" Then	
		sVal = idwFicFourn.GetItemString ( lCpt, "SWAP_GSX" ) 
		If Trim ( sVal ) = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT288) : Sur une commande de remplacement, la zone SWAP_GSX doit être renseignée par OUI ou NON." )
		End If 					
	
		// [DT288]
		sVal = idwFicFourn.GetItemString ( lCpt, "REF_ORANGE" ) 
		If Trim ( sVal ) = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT288) : Sur commande de remplacement, la zone REF_ORANGE doit être renseignée." )
		End If 
	End If
	
	// [PM284-1]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	If lVal = 303 Then
		Choose Case dcIdProd
			Case 35800, 35801, 35802, 35803, 80500, 80501, 80502, 80503, 44500, 44501, 44502, 44503
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " n'est pas autorisé pour le produit " + string ( dcIdProd ) + "." )
		End Choose 
	End If			
	
	// [PM222-1]

	// [DT150]
	/*
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
		If lVal = 305 And lnvPFCString.of_getkeyvalue (sChaineBCV, "GESTION_GEOLOCALISATION", ";") <> "OUI" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le produit " + String ( dcIdprod ) + " n'est pas éligible au projet DT150 gérant la géolocalisation. Si ce projet doit rentrer dans ce périmètre, voir avec DPG pour ajouter le produit, sinon transmettre l'information au fournisseur que ce produit est interdit pour ce code retour." )
		End If
		
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
		If lVal = 306 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Statut de retour interdit ! " + String ( lVal ) + "." )
		End If 
	*/
	
	// [ITSM326003]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") = "OUI" Then
		sVal1 = sNumImeiSerie
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
		Choose Case lVal 
			Case 177, 178
				If isnull(sVal1) Or sVal1 = "" Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le numéro de série/IMEI de l'appareil de remplacement n'est pas renseigné." )
				End If	
		End Choose 
	End If
	
	// [VDOC18200]
	If Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "ETAT_APP_PRET", ";") ) > 0 Then
		If Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "DTE_RESTIT_APP_PRET", ";") ) <= 0 And &
			Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCplt, "DTE_RESTIT_APP_PRET", ";") ) <= 0 Then 

			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") : Retour du BCV ETAT_APP_PRET sans le BCV DTE_RESTIT_APP_PRET, interdit." )
		End If
	End If
	// [VDOC18200]	
	
	// [DT200]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt, "NE_PAS_REPARER", ";"))
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	If sVal = "OUI" Then
			Choose Case lVal
				Case 2
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Réparation interdite sur ce type de prestation, il faut répondre 21 Irréparable dans tous les cas et qualifier l'irréparabilité dans le commentaire par un mot clé." )
			End Choose 
	End if

	// [PM287-3]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
/*
	If lVal = iStatusGc And lVal = 308 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le statut retour 308 est déjà présent sur ce dossier, le fournisseur l'a déjà envoyé et doit donc attendre le retour de l'assuré et ne plus retourner d'information sur cette prestation pour l'instant, voir livraison PM287-3." )
	End If
*/	

	// [DT288-1_LOT2]
	/*
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	Choose Case iStatusGc 
		Case 308, 309
			// OK
		Case Else
			If lVal = 311 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le statut retour 311 n'est autorisé que si le dernier statut envoyé par le fournisseur est 308, voir livraison PM287-3." )
			End If
	End Choose 				
	*/

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	lVal1 = Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") )
	If lVal = 308 And lVal1 <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le statut retour 308 vous oblige à renseigner le bcv IFDNMQ_RET (InFos DoNnées ManQuante RETour) avec un codage particulier, voir livraison PM287-3." )
	End If

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	lVal1 = Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") )
	If lVal <> 308 And lVal1 > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + String ( lVal ) + " interdit la présence du bcv IFDNMQ_RET (InFos DoNnées ManQuante RETour) dans la zone sérialisée, voir livraison PM287-3." )
	End If


	If lVal = 308 And lVal1 > 0 Then
		sVal2 = "#305#232#"
		sVal  = lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") 
		sVal3 = lnvPFCString.of_getkeyvalue (sChaineBCV, "DNCX_STATUS_GC", ";") 
		lnvPFCString.of_parsetoarray( sVal,"#", sTabVal )

		lTot = UpperBound ( sTabVal ) 

		For lCptVal = 1 To lTot
			If IsNull ( sTabVal [lCptVal] ) Or Trim ( sTabVal [lCptVal] ) = "" Then Continue 
			
			If Pos ( sVal2, "#" + sTabVal [lCptVal] + "#" ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La valeur #" + sTabVal [lCptVal] + "# n'est pas autorisée dans le BCV IFDNMQ_RET pour le statut 308, voir livraison PM287-3." )
			End If

			If iRet > 0  Then
				If Pos ( sVal3, "#" + sTabVal [lCptVal] + "#" ) > 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La valeur #" + sTabVal [lCptVal] + "# est interdite pour le statut 308/BCV IFDNMQ_RET pour le produit " + String ( dcIdprod ) + ", voir livraison PM287-3." )
				End If
			End If
		Next 
	
	End IF
	
	// [DT280]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))		
	If sVal = "OUI" Then
		
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		

		// [VDOC27123]BVID/BVIP/BVIT
		If ( &
				( lVal = 21 ) And Not ( Pos (sVal,  "[BVIE]" ) > 0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &
				Or &
				( lVal = 23 ) And Not ( Pos (sVal,  "[BVIEOX]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &					
				Or &
				( lVal <> 21 And lVal <> 23 ) &
			) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Le SWAP CORDON n'est autorisé que sur un irréparable 21/23 avec un mot clé [BVIE]/[BVID]/[BVIP]/[BVIT]/[BVIEOX] ou [PIE]." )
		End If 				
			
		If iRet > 0 Then
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";"))		
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CORDON le BCV MARQSW doit être renseignée avec la marque IFR du nouveau matériel." )
			End If 	
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";"))		
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CORDON le BCV MODLSW doit être renseigné avec le modèle IFR du nouveau matériel." )
			End If 					

			If iRet > 0 Then
				Choose Case sIdTypArtSin
					Case "TEL", "TPC"
						// Autorisé
					Case Else 
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Type d'appareil (" + sIdTypArt+ ") non autorisé pour un SWAP CORDON." )
				End Choose
			End If 

			// Controle binome marq/modl appartient à IFR à ajouter
			If iRet > 0 Then
				sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";"))
				sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";"))
				If SQLCA.PS_S_VERIF_MARQ_MODL_IFR_V01 ( dcIdprod, sIdTypArtSin, sVal, sVal1 ) <= 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP CORDON, pour ce dossier, la Marque et le Modèle du nouveau matériel (" + sVal + " " + sVal1 + ") doivent appartenir au référentiel IFR." )
				End If
			End If
			
			sVal = sNumImeiSerie // Le ctrle de validité est faite plus haut
			If Trim ( sVal ) = "" Or IsNull ( sVal )  Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CORDON la zone NUM_IMEI_NOUV ou NUM_SERIE_NOUV doit être renseignée par l'IMEI/SERIE du nouveau matériel." )
			End If 					


			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MTTTCSW", ";"))
			If Trim ( sVal ) = "" Or Not IsNumber ( sVal ) Or Pos ( sVal, ",") > 0 Or Pos ( sVal, "E") > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CORDON le BCV MTTTCSW doit être renseigné avec le montant TTC de l'appareil de remplacement (avec un point en séparateur de décimal)." )
			End If 

			// [BUG_RST_PRIX_O2M]
/* // On coupe le contrôle qui gêne CORDON
				If IsNumber ( sVal ) Then
					If Long ( sVal) = 0 Then 
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CORDON le BCV MTTTCSW doit être renseigné avec le montant TTC de l'appareil de remplacement (avec un montant positif)." )
					End if		
				End If 
*/


			// [VDOC23499]
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NEUF_REC", ";"))
			Choose Case sVal
				Case "NEU", "REC"
					// Ok
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280/VDOC23499) : le BCV NEUF_REC est obligatoire et doit contenir les valeurs NEU ou REC." )
			End Choose 
			
			sVal = idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) 
			sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) )  		

			If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CORDON, Le numéro de bon transporteur est obligatoire." )
			End IF 

			// [DT288]
			sVal = idwFicFourn.GetItemString ( lCpt, "SWAP_GSX" ) 
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT288) : Sur un SWAP CORDON la zone SWAP_GSX doit être renseignée par OUI ou NON." )
			End If 					

			// [DT288]
			sVal = idwFicFourn.GetItemString ( lCpt, "REF_ORANGE" ) 
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT288) : Sur un SWAP CORDON la zone REF_ORANGE doit être renseignée." )
			End If 					

		End If		
		
	End If
	
	// [DT290]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))					
	If iInfoSpbFrn = 984 And sVal <> "OUI" And sIdTypArt <> "PST" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT290) : Sur un process 984, le SWAP est obligatoire, pas de process alternatif donc le bcv APP_SWAP doit obligatoirement être à OUI." )
	End If

	// [PM383-1]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "SOUS_GC", ";"))
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	
	If sVal = "OUI" Then
		Choose case lVal 
			Case 2, 22
				//ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM383-1) : le bcv SOUS_GC=OUI n'est accepté qu'avec le retour 2 (réparé)." )
		End Choose 
	End If
	// [PM383-1]	
	
	// IRREP_QUALIFIE
	sVal1= String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	
	If lVal = 21 And &
		( &
		  Pos ( sVal1, "[BNVSOX]") <= 0 And &
		  Pos ( sVal1, "[CRSMTPEC]") <= 0 And &
		  Pos ( sVal1, "[BNV]") <= 0 And &
		  Pos ( sVal1, "[OXY]") <= 0 And &
		  Pos ( sVal1, "[PIE]") <= 0 And &
		  Pos ( sVal1, "[PNC]") <= 0 And &
		  Pos ( sVal1, "[BRIS]") <= 0 And &
		  Pos ( sVal1, "[SAV_NO_OK]") <= 0 And &
		  Pos ( sVal1, "[BVIEOX]") <= 0 And &
		  Pos ( sVal1, "[EXP]") <= 0  And &			  
		  Pos ( sVal1, "[BVIE]") <= 0  And &			  
		  Pos ( sVal1, "[BVID]") <= 0  And &			  
		  Pos ( sVal1, "[BVIP]") <= 0  And &			  
		  Pos ( sVal1, "[BVIT]") <= 0  And &			  		  
		  Pos ( sVal1, "[NOSPBS]") <= 0 ) &
		  Then

			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il manque dans le commentaire un des mots clés obligatoire qualifiant l'irréparable." )

	End If 
	
	// [DT288-3_LOT1_2EME_VS]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If sIdRefFour = "INFORMATION" And lVal <> 612 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") : un flux de type INFORMATION ne peut avoir pour réponse qu'un statut 612" )
	End IF 

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  			
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "COLIS_PND", &
				  "COLIS_NRPAC", &
				  "COLIS_PERDU", &
				  "COLIS_BALNI", &
				  "COLIS_INCOR", &
				  "COLIS_REFUS", &
				  "ANNUL_REFAIT", &
				  "EN_ATTENTE", &
				  "AUTRE", &
				  "J1", &
				  "J2", &
				  "J3", &
				  "J4", &
				  "J5", &
				  "J6" 
			
					// Ok
					
			Case Else 

				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
	End If 
	
	
	// [PM445-1]
	If bF_CLE_A_TRUE_PM445_1_COR Then
		If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") <> "OUI" Then
			sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "TYP_BA_ALLER", ";"))
			If IsNull ( sVal ) Then sVal = ""
	
			sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
			If IsNull ( sVal1 ) Then sVal1 = ""		
	
			dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")			
			
			If IsNull ( dtVal ) And sVal1 <> "" And sVal = "" And sIdRefFour <> "REFUSE_A_REEXP" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Un numéro de tracking ALLER doit être accompagné du bcv TYP_BA_ALLER." )
			End IF
			
			If sVal <> "" Then
				Choose Case sVal
					Case "BPPAYE", &
						  "RPICKUP"
					
							// Ok
							
					Case Else 
		
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé TYP_BA_ALLER, n'est pas valide." )
		
				End Choose 
			End If 
		End IF 
		
		// [PM445-1]
		sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PERTE_ALLER", ";"))
		If IsNull ( sVal ) Then sVal = ""

		IF sVal = "OUI" Then

			sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))
			If IsNull ( sVal1 ) Then sVal1 = ""
	
			sVal2 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "TYP_BA_ALLER", ";"))
			If IsNull ( sVal2 ) Then sVal2 = ""
	
			sVal3 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
			If IsNull ( sVal3 ) Then sVal3 = ""	
	
			dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	
			lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
			If IsNull ( lVal ) Then lVal = 0				
			
			If sVal2 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le type de BA aller n'est compatible avec une perte aller." )
			End If 
			
			If sVal1 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le bcv PRBLE_LIVRAISON doit être renseigné." )
			End If 
			
			If sVal3 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le numéro de tracking (NUM_BON_TRP) doit être renseigné." )
			End If 

			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, la date de réception ne doit pas être renseignée." )
			End If 
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))		
			If lVal <> 0 AND ( lVal <> 21 AND sVal <> "OUI" ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le statut ne doit pas être renseigné." )
			End If 
		End IF 

	End If	
	
	// [PM450-1]
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";"))
	sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))	

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""		
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PEC_PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
		
		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la clé PEC_PRBLE_LIVRAISON n'est autorisée que si précédemment il y a au un clé PRBLE_LIVRAISON, qui est justement absente." )
		End If 			
	End If 	
	
	// Coder au dessus de cette ligne.

	
	// #6 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then
		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

if isvalid(dsCode) Then destroy dsCode

Return iRet

end function

private subroutine uf_definir_codetat_cordon (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_CORDON (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 02/01/2017
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [DT253]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF   19/09/2011   [PM82][LOT1]
//        JFF   19/04/2016   [DT209]
//*-----------------------------------------------------------------

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	// [DT209] 601, 602
	// [DT288-3_LOT2] Ajout 169
	Case 2,21,151,152,153,154,155,157,160,161, 165, 166, 170, 171, 167, 168, 179 , 175, 176, 237, 601, 602, 169

		// [VDOC9304_PM82_LOT1]
		// [VDOC15485]
		If ( ( lVal = 153 Or lVal = 154 ) And sIdTypArt = "PRS" ) Then
			asVal = "ECT"  // EN COURS DE TRAITEMENT
		Else
			asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)
		End If

	Case 178, 263, 234 // [PM166][O2M] // [PC938_ORANGE_V3]

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		

// [RECUP_DONNEE_O2M]
Choose Case sIdRefFour
	Case "PEC_A_RECYCLER", "PAS_DE_COMMANDE"
		asVal = "RFO"
End Choose 


end subroutine

private function integer uf_integration_fichier_cordon (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_CORDON (PRIVATE)
//* Auteur			: JFF
//* Date				: 24/01/2017
//* Libellé			: Intégration du fichier CORDON dans la base
//* Commentaires	: [DT288]
//*
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #2    JFF   28/04/2008   [DCMP080202] MailPush O2M
//* #3	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #4	 FPI	 10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF   30/06/2010   [PC363_AUCHAN]
//*       JFF   07/03/2011   [VDOC3290]
//*       JFF   11/03/2011   [ITSM62176] ajout du point de décimal
//*       JFF   19/09/2011   [PM82][LOT1]
//*       JFF   05/01/2012   [RECUP_DONNEE_O2M]
//        JFF   06/08/2012   [BLCODE]
//       JFF   07/05/2013 	  [PC938_ORANGE_V3]
//       JFF   03/07/2013 		[VDOC9908]
//       JFF   08/04/2014 [PM255]
//       JFF   07/05/2013 [PM250-1]
//       JFF   02/06/2014 [PC929_CDISCOUNT][PC929-2-V3]
// 		FPI	21/07/2014 [PM250-1].FPI Correction réinit de date avant lecture de la ligne
//       JFF   18/08/2014 [PM254_V1]
//       JFF   25/08/2014 [DT100]
//       JFF   16/09/2014 [PM250-2]
//			JFF	25/09/2014		[MODIF_SUITE_REDR]
//       JFF   25/11/2014 		[PM251-2]
//       JFF   31/03/2016 [PM287-3]
//       JFF   17/05/2016 [PM280-2]
//       JFF   10/03/2017 [PM383-1]
//       JFF   04/04/2017 [VDOC23499]
//       JFF   18/09/2017 [DT288-3_LOT2]
//       JFF   17/04/2018 [DT288-4]
//       JFF   01/10/2018 [PM445-1]
//       JFF   28/01/2019 [PM450-1]
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn, dtDteArrPlatForm, dtDteDepPlatForm 
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq
Decimal {2} dcMtFrais
String sInfoFrnSpbCplt  	// #3 [FNAC_PROD_ECH_TECH]
n_cst_string lnvPFCString  // [PC363_AUCHAN]

// #2 [DCMP080202]
Int iRetMailPush 
String sDestEnvoi, sNumBonTrsp 
DateTime dtDteEnvCli
// :#2 

String sCasRetour, sIdAppli, sBase, sCommentFrn 
Long lStatusGc 

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

sInfoFrnSpbCplt = ""
iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0


For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	// [MANTIS14172]
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	// [BLCODE]
	sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 			
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
 	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	// [DT288]	
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOUV" ) ) 
	If IsNull ( sVal ) Then sVal = ""
	If sVal = "" Then
		sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_SERIE_NOUV" ) ) 
	End If 
	
	If Not IsNull ( sVal ) Then sVal = "'" + sVal + "'"
	If IsNull ( sVal ) Then sVal = "null"
	
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// [PM255] // [PM250-2]
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	// [DT288-3_LOT2]
	This.uf_Definir_CodEtat_CORDON ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "
//	sCommentFrn = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	If Not IsNull( sInfoFrnSpbCpltLu ) and Trim ( sInfoFrnSpbCpltLu ) <> "" Then 
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 
		If IsDate ( sVal ) Then
			sVal = "'" + sVal + "'" 
		Else
			sVal = "null"		
		End IF			
	Else
		sVal = "null"		
	End If
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #1 [DCMP080199]

	/*------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#1 [DCMP080199]			  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NOM_TRANSPORTEUR" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ","

	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "


	// Préparation zone INFO_FRN_SPB_CPLT 
	// Trt zone virtuelle RDV_CONF vers sInfoFrnSpbCplt

	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	// [VDOC3290]
	Choose Case sVal 
		Case "169" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")
		Case "162" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SYMP_NON_DETEC_EN_24H", "OUI", ";")			

		// [PM82][LOT1]
		Case "153" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_153", "OUI", ";")			
		// [PM82][LOT1]			
		Case "154" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_154", "OUI", ";")
		
		// [DT288]
		Case "611" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_611", "OUI", ";")

		// [PM287-3]
		Case "311" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_311", "OUI", ";")
		
		
	End Choose
	// [VDOC3290]

	// [PM246]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If		
	// [PM246]

	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RCP_MOB_CLI", sVal, ";")
	End If		
	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CODE_ERREUR_LIVR", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CODE_ERREUR_LIVR", sVal, ";")
	End If		

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	// [PM251-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "REMIS_EN_STK", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "REMIS_EN_STK", sVal, ";")
	End If		

	// [PM287-3]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "IFDNMQ_RET", sVal, ";")
	End If		

	// [PM280-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DECLASS_PCT", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DECLASS_PCT", sVal, ";")
	End If		

	// [PM280-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "A_CHARGE", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "A_CHARGE", sVal, ";")
	End If		

	// [DT280]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_SWAP", sVal, ";")
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TGR_APPSW", sVal, ";")	// Trigger Technique 
	End If		
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQSW", sVal, ";")
	End If			
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODLSW", sVal, ";")
	End If			

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MTTTCSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MTTTCSW", sVal, ";")
	End If			

	// [VDOC23499]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NEUF_REC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NEUF_REC", sVal, ";")
	End If		

	// [DT288]
	sVal = idwFicFourn.GetItemString ( lCpt, "SWAP_GSX" ) 
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SWAP_GSX", sVal, ";")
	End If			

	sVal = Left ( idwFicFourn.GetItemString ( lCpt, "REF_ORANGE" ) , 30 ) // Je n'en prend que 30, ne connaissant pas la longueur de cette donnée.
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "REF_ORANGE", sVal, ";")
	End If			
	
	// [PM383-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "SOUS_GC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SOUS_GC", sVal, ";")
	End If			

	// [PM445-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "TYP_BA_ALLER", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TYP_BA_ALLER", sVal, ";")
	End If			

	// [PM445-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PERTE_ALLER", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PERTE_ALLER", sVal, ";")
	End If

	
	// [PM450-1]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
	End If
	
	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sSql += "'" + sInfoFrnSpbCplt + "'"

	// [DT288-4]
   sChaineMailRempl = sInfoFrnSpbCplt

	// #2 [DCMP080202]
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ 
		F_commit ( SQLCA, False ) 
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue 
	End If
	// :#2

	// [PM255] // [DT100] [PM250-2]
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, "CLIENT", sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If	

	// [PM250-1]
	iRetMailPush = SQLCA.PS_S_MAILPUSH_ARR_PLATFORM ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteArrPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_ARR_PLATFORM, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	
	iRetMailPush = SQLCA.PS_S_MAILPUSH_DEP_CENTRDISTRIB ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteDepPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_DEP_CENTRDISTRIB, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	// [PM250-1]	


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
	//		alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #4
			F_commit ( SQLCA, True )
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		
		// [MODIF_SUITE_REDR]
		sVal = SQLCA.SQLErrText		
		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")	

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + sVal )

		F_commit ( SQLCA, False )
			
		Continue 
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1

Return iRet 
end function

public function long uf_charger_fichierfournhalt (long alnumligerrimport, string ascolligerrimport, string asdata);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Charger_FichierFournHALT (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 10/04/2017
//* Libellé			: Stoppe l'appli sans blocage sur la fenêtre Continue de l'importfile.
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Int		iRet
Long     lTotLig 

iRet = 1 // C'est le 1 du return ItemError, mais ça n'aura pas d'importance, je stoppe l'appli à cet endroit

If Not gbOpCon Then Return 0

iRet = -1
lTotLig = -4
ibErrIntegr = True // [PI065]
This.uf_Trace ( "ECR", "Chargement du fichier : ERREUR IMPORTFILE (" + String ( lTotLig ) + ") ligne " + string (alNumLigErrImport) + ", colonne " + Upper ( asColLigErrImport ) + ", problème de format de fichier, une donnée n'est pas du bon type ou est trop longue."  ) // [PI065]
This.uf_Trace ( "ECR", "Chargement du fichier : Text posant problème : " + Trim ( asData)  ) // [PI065]

This.uf_Sortie_OpCon ( "ECR", 340, "ERR340/CHARGFICFOUR", FALSE )						

This.uf_Trace ( "ECR", "Le traitement se termine anormalement, le fichier n'a pas été traité !!!." )

// idwSuiviTrt.ScrollToRow ( idwSuiviTrt.RowCount () )

If f_FileExists ( stGlb.sRepTempo + K_FICTMP ) Then FileDelete ( stGLB.sRepTempo + K_FICTMP )

This.uf_Trt_OpCon ( "FIN_TRT" )

// Test RunTime
RUN ( "taskkill /f  /im P_FR_APP_Simpa2_main_2022.EXE /T", minimized! )

Return iRet
end function

public subroutine uf_set_numligerrimport (long alnumligerrimport, string ascolligerrimport, string asdataerrimport);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Set_NumLigErrImport (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/04/2017
//* Libellé			: 
//*					  retourné dans le fichier.
//* Commentaires	: 
//*
//* Arguments		: 
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

ilNumLigErrImport = alNumLigErrImport
isColLigErrImport = asColLigErrImport
isDataErrImport  = asDataErrImport 

end subroutine

private function integer uf_ctrl_date (string ascas, integer airet, long alcpt, long alidsin, long alidseq, string asidreffour, string aschainebcv, string asval, string asval1);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Date (PRIVATE)
//* Auteur			: JFF
//* Date				: 22/09/2017
//* Libellé			: 
//* Commentaires	: [CTRLE_DATE_INTRG_FOURN]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//        JFF   02/09/2019 [DT424]
//*-----------------------------------------------------------------

Date dtDteRcpFrnFic, dtDteRcpFrnBase, dtDteEnvcliFic, dtDteEnvcliBase, dtToday, dtCreeLeSin, dtDte1, dtDte2 
String sToDay, sCreeLeSin
n_cst_string lnvPFCString

dtToday = Date ( Today() )
sToDay = String ( dtToday )

dtDteRcpFrnBase = Date ( lnvPFCString.of_getkeyvalue (asChaineBCV, "DTE_RCP_FRN", ";") )
dtDteEnvcliBase = Date ( lnvPFCString.of_getkeyvalue (asChaineBCV, "DTE_ENV_CLI", ";") )
dtCreeLeSin		 = Date ( lnvPFCString.of_getkeyvalue (asChaineBCV, "CREE_LE_SIN", ";") )

Choose Case asCas
	Case "CAS1"

		dtDteRcpFrnFic = Date ( asVal ) 
		dtDteEnvcliFic = Date ( asVal1 ) 	
				
		// dte_env_cli et dte_rcp_frn ne peuvent pas être postérieure à la date du jour d’intégration.
		If dtDteRcpFrnFic > dtToday Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de réception du matériel (" + String ( dtDteRcpFrnFic, "dd/mm/yyyy" ) + ") chez le fournisseur ne peut pas être postérieure au jour d'intégration (" + sToday + ")" )
		End If
		
		// dte_env_cli et dte_rcp_frn ne peuvent pas être postérieure à la date du jour d’intégration.
		If dtDteEnvcliFic > dtToday Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de traitement/envoi du matériel (" + String ( dtDteEnvcliFic, "dd/mm/yyyy" ) + ") par le fournisseur ne peut pas être postérieure au jour d'intégration (" + sToday + ")" )
		End If

		// dte_env_cli et dte_rcp_frn ne peuvent pas être antérieures à la date de création du sinistre
		If dtDteRcpFrnFic < dtCreeLeSin Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de réception du matériel (" + String ( dtDteRcpFrnFic, "dd/mm/yyyy" ) + ") chez le fournisseur ne peut pas être antérieure à la date de création du sinistre (" + String ( dtCreeLeSin, "dd/mm/yyyy" ) + ")" )
		End If
		
		// dte_env_cli et dte_rcp_frn ne peuvent pas être antérieures à la date de création du sinistre
		If dtDteEnvcliFic < dtCreeLeSin Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de traitement/envoi du matériel (" + String ( dtDteEnvcliFic, "dd/mm/yyyy" ) + ") par le fournisseur ne peut pas être antérieure à la date de création du sinistre (" + String ( dtCreeLeSin, "dd/mm/yyyy" ) + ")" )
		End If

		// dte_env_cli ne peut pas être antérieure à dte_rcp_frn
		If dtDteEnvcliFic < dtDteRcpFrnBase Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de traitement/envoi du matériel (" + String ( dtDteEnvcliFic, "dd/mm/yyyy" ) + ") par le fournisseur ne peut pas être antérieure à la date de réception du matériel (" + String ( dtDteRcpFrnBase, "dd/mm/yyyy" ) + ")" )
		End If

		// dte_env_cli ne peut pas être antérieure à dte_rcp_frn
		If dtDteEnvcliFic < dtDteRcpFrnFic And ( IsNull ( dtDteRcpFrnBase ) OR dtDteRcpFrnBase = 1900-01-01 ) Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de traitement/envoi du matériel (" + String ( dtDteEnvcliFic, "dd/mm/yyyy" ) + ") par le fournisseur ne peut pas être antérieure à la date de réception du matériel (" + String ( dtDteRcpFrnFic, "dd/mm/yyyy" ) + ")" )
		End If


// [DT424]
Case "CAS2"

		dtDte1 = Date ( asVal ) 
		dtDte2 = Date ( asVal1 ) 	
				
		// dte_fin_trait ne peut pas être postérieure à la date du jour d’intégration.
		If dtDte1 > dtToday Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de traitement (" + String ( dtDte1, "dd/mm/yyyy" ) + ") chez le fournisseur ne peut pas être postérieure au jour d'intégration (" + sToday + ")" )
		End If

		// dte_fin_trait ne peut pas être antérieures à la date de création du sinistre
		If dtDte1 < dtCreeLeSin Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de traitement (" + String ( dtDte1, "dd/mm/yyyy" ) + ") chez le fournisseur ne peut pas être antérieure à la date de création du sinistre (" + String ( dtCreeLeSin, "dd/mm/yyyy" ) + ")" )
		End If

// [DT424]
Case "CAS3"

		dtDte1 = Date ( asVal ) 
		dtDte2 = Date ( asVal1 ) 	

		// dte_fin_trait ne peut pas être postérieure à la date du jour d’intégration.
		If dtDte1 > dtToday Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de traitement (" + String ( dtDte1, "dd/mm/yyyy" ) + ") chez le fournisseur ne peut pas être postérieure au jour d'intégration (" + sToday + ")" )
		End If				
				
		// dte_env_cli ne peut pas être antérieure à dte_rcp_frn
		If dtDte2 < dtDte1 Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de dernière utilisation  (" + String ( dtDte2, "dd/mm/yyyy" ) + ") ne peut pas être antérieure à la date de 1ère utilisation (" + String ( dtDte1, "dd/mm/yyyy" ) + ")" )
		End If

// [PMO89_RS4822]
Case "CAS4"

		dtDte1 = Date ( asVal ) 
		dtDte2 = Date ( asVal1 ) 	

		If dtDte1 > dtToday Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de réception du flux (" + String ( dtDte1, "dd/mm/yyyy" ) + ") chez le fournisseur ne peut pas être postérieure au jour d'intégration (" + sToday + ")" )
		End If				

		If dtDte2 > dtToday Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de traitement du flux (" + String ( dtDte1, "dd/mm/yyyy" ) + ") chez le fournisseur ne peut pas être postérieure au jour d'intégration (" + sToday + ")" )
		End If				

		If dtDte2 < dtDte1 Then
			aiRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( alCpt ) + &
			" : (" + String ( alIdsin) + "-" + String (alIdSeq) + ") : La date de traitement du flux (" + String ( dtDte2, "dd/mm/yyyy" ) + ") ne peut pas être antérieure à La date de réception du flux (" + String ( dtDte1, "dd/mm/yyyy" ) + ")" )
		End If

End CHoose 


Return aiRet


end function

private subroutine uf_definir_codetat_phoneandphone (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_PHONEANDPHONE (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 21/04/2009
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [DCMP090140]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* 
//*-----------------------------------------------------------------

//* #1 [FNAC_PROD_ECH_TECH]
//* #2 [FNAC_PROD_ECH_TECH].[20090127140540720] (165)
//* #3 [DCMP090327].[SBETV] 170,171

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	// [PM284-1] 303
	Case 2,21,151,152,153,154,155,157,160,161, 165, 166, 170, 171, 167, 168, 179 , 175, 176, 237, 303, 304

		// [VDOC9304_PM82_LOT1]
		// [VDOC15485]
		If ( ( lVal = 153 Or lVal = 154 ) And sIdTypArt = "PRS" ) Then
			asVal = "ECT"  // EN COURS DE TRAITEMENT
		Else
			asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)
		End If

	Case 178, 263, 234 // [PM166][O2M] // [PC938_ORANGE_V3]

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		

// [RECUP_DONNEE_O2M]
Choose Case sIdRefFour
	Case "PEC_A_RECYCLER", "PAS_DE_COMMANDE"
		asVal = "RFO"
End Choose 



end subroutine

public subroutine uf_definir_codetat_coriolis_pm426_1 (ref string asval, integer alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_Coriolis (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/03/2006
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [PM178][CORIOLIS]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//        JFF   05/12/2017 [PM426-1]
//* 
//*-----------------------------------------------------------------

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	// [PM284-1] 303
	Case 176

		asVal = "ANN"  // Cloture Commande

	Case 178

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		


end subroutine

private function integer uf_ctrl_fichier_ceat ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_CEAT (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 04/09/2018
//* Libellé			: Controler de la validité du fichier CEAT
//* Commentaires	: [DT361]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//* #2	JCA	12/12/2007		DCMP 70918
//* #3   JFF	20/10/2008		[FNAC_PROD_ECH_TECH]
//* #4   JFF	30/04/2009		[DCMP090109]
//* #5   JFF	14/05/2009		[DCMP090085]
//* #6   JFF   02/09/2009 		[DCMP090327].[SBETV]
//* #7   JFF   07/12/2009     [MSS_DIAG].[20091207111441740]
//* #8   JFF   28/12/2009     [20091228114718123]
//* #9	FPI	25/01/2010	   [DCMP090759] 
//*      JFF   04/05/2010     [DCMP100333]
//*   	SBA	25/06/2010 	   [BUG.CTRLFICSUIVI]
//*		FPI	11/08/2010	   [PM01] Ajout des retours 167 & 168
//*      JFF   22/09/2010     [PM01].[LOT3&4]
//* 		JFF   03/05/2011     [PM166][O2M]
//* 		JFF   06/05/2011     [VDOC3731]
//* 		FPI   19/08/2011     [VDoc4752]
//*      JFF   09/09/2011     [PC499][PC501][PC545][-1x3][V5]
//*      JFF   19/09/2011     [PM82][LOT1]
//* 		JFF   06/05/2011     [VDOC5774]
//* 		FPI   01/12/2011     [VDoc6082]
//*      JFF   05/01/2012 		[RECUP_DONNEE_O2M]
//*      JFF   23/01/2012     [VDOC6300]
//*      JFF   20/03/2012     [CTRL_IMEI_O2M] ajout contrôle IMEI
//*      JFF   04/04/2012     [MANTIS3067] satut 231
//*      JFF   30/05/2012	   [VDOC7926]
//       JFF   06/08/2012     [BLCODE]
//       JFF   30/08/2012     [VDOC8041]
//       JFF   26/11/2012     [PC877]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   10/01/2013     [VDOC9907]
//       JFF   10/01/2013     [VDOC10029]
//       JFF   19/02/2013	   [VDOC9304_PM82_LOT1]
//       JFF   07/05/2013 		[PC938_ORANGE_V3]
//       JFF   03/07/2013 		[VDOC9908]
//       JFF   09/09/2013 		[VDOC10641]
//       JFF   09/09/2013 		[PM222-1]
//       JFF   30/12/2013 [PC13348&13408]
//		   FPI	28/07/2014	[20140728.FPI] Ajout ctl de longueur
//			JFF	25/09/2014		[MODIF_SUITE_REDR]
//       JFF   02/10/2014 [VDOC15485]
// 		JFF   05/02/2015 [PC13321][MANTIS14042]
// 		JFF	24/03/2015 [VDOC17191]
//       JFF   20/05/2015 [PM284-1]
//		   FPI	02/06/2015 [PM222-1]
//       JFF   05/06/2015 [VDOC17633]
//       JFF   20/07/2015 [DT150]
//       JFF   11/09/2015 [VDOC18200]
//		   FPI	22/09/2015 [ITSM326003] ajout ctl IMEI sur commande de rempl
//       JFF   06/11/2015 [VDOC18931]
//       JFF   29/03/2016 [DT200]
//       JFF   31/03/2016 [PM287-3]
//       JFF   17/05/2016 [PM280-2]
//       JFF   21/11/2016 [DT280]
//       JFF   23/01/2017 [DT290]
//       JFF   10/03/2017 [PM383-1]	
//       JFF   04/04/2017 [DT288][M24505]
//       JFF   04/04/2017 [VDOC23499]
//       JFF   04/05/2017 [DT288-1_LOT2]
// 		JFF	25/08/2017 [CTRLE_REF_A_REEXP]
//       JFF   29/08/2017 [DT288-3_LOT1_2EME_VS]
// 		JFF	22/09/2017 [CTRLE_DATE_INTRG_FOU]
//       JFF   21/11/2018 [VDOC27123]
//       JFF   28/01/2019 [PM450-1]
//       JFF   20/09/2021 [BUG_RST_PRIX_O2M]
//*-----------------------------------------------------------------

Int iRet, iStatusGc, iInfoSpbFrn
String	sIdFour, sVal, sCar, sIdFourCtrl, sInfoFrnSpbCpltLu, sIMEICorr
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sVal1, sVal2, sVal3
String sInfoFrnSpbCplt, sIdTypArtSin
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal, lVal1
Boolean	bTrouve
datastore	dsCode
Long dcIdProd, lTot
String sInfoSpbFrnCplt, sChaineBCV, sNumImeiSerie
String sTabVal[], sTabNull[]
Long lNbreLignDeb, lNbreLignFin

Long	lIdSin, lIdSeq //#2
datetime	dtVal, dtVal1
n_cst_string lnvPFCString  

iRet = 1

lTotLig = idwFicFourn.RowCount ()

// [MODIF_SUITE_REDR]
If lTotLig <= 0 And FileLength64 ( isTxtNomFic.Text ) > 0 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR : 0 Ligne chargée ! , pour PI : Taille du fichier positive et chargement à 0 ligne => Anormal. Réessayez l'intégration (cause éventuelle => le fichier est peut-être en format Unicode au lieu d'Ansi, à vérifier)." )
End If		

sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 		// #9

// [DT288][M24505]
// Contrôle entete et fin
If lTotLig < 2 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
	" : Le fichier doit comporter au minimum 2 engistrements : entête & fin")
	lTotLig = 0
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( 1, "NUM_CMD_SPB" ) )
	If Pos ( sVal, "DEBUT#" ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne d'entête n'est pas conforme (attendu : DEBUT#xx)")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( 1, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "DEBUT#", "" ) 
	If Not IsNumber ( sVal )  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne d'entête n'est pas conforme, la valeur dérrière DEBUT# doit être un nombre")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( 1, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "DEBUT#", "" ) 
	lNbreLignDeb = Long ( sVal )
	idwFicFourn.RowsDisCard ( 1, 1, Primary! )
	lTotLig = idwFicFourn.RowCount ()	
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( lTotLig, "NUM_CMD_SPB" ) )
	If Pos ( sVal, "FIN#" ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne de fin n'est pas conforme (attendu : FIN#xx)")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( lTotLig, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "FIN#", "" ) 
	If Not IsNumber ( sVal )  Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La ligne de fin n'est pas conforme, la valeur dérrière FIN# doit être un nombre")
		lTotLig = 0
	End If
End If

If iRet > 0 Then
	sVal = Trim ( idwFicFourn.GetItemString ( lTotLig, "NUM_CMD_SPB" ) )
	sVal = F_REMPLACE ( sVal, "FIN#", "" ) 
	lNbreLignFin = Long ( sVal )
	idwFicFourn.RowsDisCard ( lTotLig, lTotLig, Primary! )
	lTotLig = idwFicFourn.RowCount ()	
End If

If iRet > 0 Then
	If lNbreLignDeb <> lNbreLignFin Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le nombre de ligne entre la ligne d'entête et la ligne de fin n'est pas identique")
		lTotLig = 0		
	End If 
End If

If iRet > 0 Then
	If lNbreLignDeb <> lTotLig Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le nombre de ligne du fichier dans la ligne d'entête (" + String ( lTotLig ) + ") ne correspond pas au nombre de ligne réel du fichier (" + String ( lNbreLignDeb ) + ")" )
		lTotLig = 0		
	End If 
End If
// /[DT288][M24505]


For lCpt = lTotLig To 1 Step -1

	sIdRefFour = fill(" ",20)
	sCodEtat = fill(" ",3)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
	// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If
	End If
	
	// [PM82][LOT1]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	
	sIdTypArtSin = lnvPFCString.of_getkeyvalue (sChaineBCV, "TYP_APP_DS", ";") 
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	// [BLCODE]
	If sVal <> sIdFour And sVal <> "BLC" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 
	// [BLCODE]

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_RCP_FRN										*/
	/*------------------------------------------------------------------*/
	// #9
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	// [DCMP100333]
	// [PM166][O2M] 177, 178
	Choose Case lVal
		Case 155, 156, 157, 158, 160, 161, 163, 164, 165, 174, 177, 178
			If Not isNull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End if

		// [PM01].[LOT3&4]
		// [PC499][PC501][PC545][-1x3][V5]
		// [VDOC8041] 232
		Case 151, 152, 153, 154, 159, 162, 166, 167, 168, 169, 2, 21, 175, 232
			// [PC13321][MANTIS14042]
			If isNull(dtVal) And iInfoSpbFrn <> 957 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être renseignée.")
			End if
			
			// [PC13321][MANTIS14042]			
			If Not isNull(dtVal) And iInfoSpbFrn = 957 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", et pour le process spécifique 957, la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End If			

	End Choose

	// Fin #9
	
	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_FIN_TRAIT									  */
	/*------------------------------------------------------------------*/
	// #9
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	// [DCMP100333]
	// [PM01].[LOT3&4]
	// [PM166][O2M] 177
	// [PM01] Ajout de 167,168
	// [PC499][PC501][PC545][-1x3][V5]
	Choose Case lVal
		Case 151, 152, 153, 154, 155, 160, 161, 165, 166, 167, 168, 2, 21, 167, 168, 177, 178, 175

			// [PM82][LOT1]
			If ( lVal = 153 Or lVal = 154 ) And sIdTypArt = "PRS" Then
				If Not Isnull (dtVal) Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					", PM82_LOT1 : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + " en réparation, la date de fin de traitement (DTE_FIN_TRAIT) ne doit pas être renseignée.")
				End If

			Elseif Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être renseignée.")
			End if
		// [VDOC8041] 232
		Case 156, 157, 158, 159, 162, 163, 164, 169, 232, 174
			if Not Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être vide.")
			End if
			
		Case Else
			If ( lVal = 0 Or IsNull ( lVal ) ) And Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Lorsque la date de fin de traitement (DTE_FIN_TRAIT) est renseignée, un statut GC est obligatoire.")
			End If 
		
	End Choose
	// Fin #9

	/*------------------------------------------------------------------*/
	/* ZONE 6 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal
		Case 177, 178
			If IsNull ( sVal ) Or Len ( sVal ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) )
			End If
		//  [VDoc4752]
		Case 165
			If iInfoSpbFrn = 970 and (IsNull ( sVal ) Or Len ( sVal ) <= 0 ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) +  " pour le process 970.")
			End If
		// :[VDoc4752]
	End Choose

	// [MODIF_SUITE_REDR]
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "NUM_BON_TRP", Trim ( sVal ) )
	
	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
//	if dsCode.retrieve('-GC') > 0  then											// #9 - Chargement au début de la fct
			// #3 [FNAC_PROD_ECH_TECH] agrandissement jusqu'à 160
			// #4 [DCMP090109] ajout 2, 21
			// #5 [DCMP090085] ajout jusqu'à 169
			// #6 [DCMP090327].[SBETV] (171)
			// [PM166][O2M]
			// [MANTIS3067] ajout 231
			// [VDOC10641] 174
			// [PM287-3] not in 305, 306
		if dsCode.find("( ID_CODE BETWEEN 151 AND 171 " + &
							"	OR ID_CODE IN (2, 21, 263, 264, 266, 611, 612 ) " + &
							"  OR ID_CODE BETWEEN 174 AND 179 " + &
							"  OR ID_CODE BETWEEN 231 AND 239" + &							
							"  OR ID_CODE BETWEEN 301 AND 399" + &														
							") AND ID_CODE = " + sVal + &
							"  AND ID_CODE NOT IN ( 305, 306, 232, 309, 310 ) " &
							, 1, dsCode.RowCount()+1 ) = 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
		End If			
//	End IF			// #9

// [PM166][O2M]
// [PM82][LOT1] je remonte cette linge plus haut.
// [RECUP_DONNEE_O2M] PCM 
// [VDOC4970]
// [PM250] Modif suite demande d'Hélène (et CEAT)
	Choose Case Upper ( sIdTypArt ) 
		Case "EDI", "PRS", "PCM"
			Choose Case Long ( sVal ) 
				Case 177, 178
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC " + sVal + " n'est autorisé que pour les commandes de matériel (hors Batterie amovible BAM et Câble d'alimentation ALE)" )
			End Choose
		Case Else
			Choose Case Long ( sVal ) 
				Case 177, 178, 176, 233, 263, 234, 235, 236, 237,238, 239, 301, 304
					
					// [PC938_ORANGE_V3]
					// C'est Ok
					// [MODIF_SUITE_REDR]
					If Long ( sVal ) = 234 Then
						If Not ( sIdTypArt = "REA") And Not ( sIdTypArt = "PST" And Trim ( lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt, "TYP_RELAI", ";")) <> "PRET" ) Then
							iRet = -1
							This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
							" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Status GC " + sVal + " autorisé uniquement sur une presta de type PST sans PRET ou une presta de type REA" )
						End If
					End If 
					
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Status GC " + sVal + " non autorisé pour une commande de matériel (hors Batterie amovible BAM et Câble d'alimentation ALE)" )

			End Choose
			
	End Choose
// :[PM166][O2M]

	// [VDOC3731]
	Choose Case iInfoSpbFrn
		// [VDOC5774] 435, 1502
		Case 1503, 1504, 435, 1502
			Choose Case Long ( sVal ) 
				Case 166
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
			
		Case 1505
			Choose Case Long ( sVal ) 
				Case 167, 168
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
		// [VDoc4752]
		Case 970
			Choose Case Long ( sVal )
					// [VDoc6082] ajout du statut_gc 164
				Case 165,164
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose
			// :[VDoc4752]
			
		// [VDOC6300] // [PC877]
		Case 964, 969
			Choose Case Long ( sVal )
				Case 179
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Status GC " + sVal + " n'est pas autorisé en retour" )
			End Choose			
			
	End Choose		

	Choose Case Long ( sVal ) 
		Case 166
			// [VDOC5774] 435, 1502
			Choose Case iInfoSpbFrn
				Case 1503, 1504, 435, 1502
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		Case 167, 168
			Choose Case iInfoSpbFrn
				Case 1505
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		// [VDOC6300] // [PC877]
		Case 179
			Choose Case iInfoSpbFrn
				Case 964, 969
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
	End Choose			
	// :[VDOC3731]	

	// [VDOC8041]
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal 
		Case 232
			If Upper ( sIdTypArt ) <> "PRS" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If

	End Choose

	Choose Case sIdTypArt  
		Case "PRS"
			// OK
		Case Else
			If lVal = 232 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If

	End Choose
	// [VDOC8041]

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COMMENT_FRN														     */
	/*------------------------------------------------------------------*/
	// Pas de Controle Particulier
	// [MODIF_SUITE_REDR]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "COMMENT_FRN", Trim ( sVal ) )


	/*------------------------------------------------------------------*/
	/* ZONE   : info_frn_spb_cplt													  */
	/*------------------------------------------------------------------*/
	// [PM166][O2M]
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	
	If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = "" 

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";"))
	If len ( Trim ( sVal ) ) > 0 And Not IsDate ( sVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone sérialisée DTE_RCP_MOB_CLI ne contient pas une date valide" )
	End If 

	// [PC938_ORANGE_V3]
	If len ( Trim ( sVal ) ) > 0 Then 
		Choose Case lVal 
			Case 178, 233, 263, 234, 2, 21
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone sérialisée DTE_RCP_MOB_CLI ne peut être renseignée sans le statut 178, 233, 263, 234, 2, 21" )
		End Choose
	End If

	// [PC938_ORANGE_V3]
	If len ( Trim ( sVal ) ) > 0 And ( lVal = 178 Or lVal = 233 Or lVal = 263 ) And ( IsNull ( dtVal ) Or Date ( dtVal ) = 1900-01-01 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone DTE_FIN_TRAIT doit être renseignée avant de renseigner la zone DTE_RCP_MOB_CLI et de donner le statut 178 ou 233 ou 263" )
	End If

  /* [VDOC9908]		
	If lVal = 178 And len ( Trim ( sVal ) ) <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut 178 oblige à avoir la zone sérialisée DTE_RCP_MOB_CLI renseignée." )
	End If
	*/
	// [PM166][O2M]

	// [VDOC7926]
	Choose Case dcIdProd
		Case 41101, 41103 
			
			sVal  = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQUE_REMPL", ";"))	
			sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODELE_REMPL", ";"))	
			sVal2 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_PUBLIC", ";"))	
			sVal3 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_O2M", ";"))	

			If len ( Trim ( sVal ) ) > 0 OR len ( Trim ( sVal1 ) ) > 0 OR len ( Trim ( sVal2 ) ) > 0 OR len ( Trim ( sVal3 ) ) > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC7926) : Les binômes clés/valeurs pour les clés MARQUE_REMPL, MODELE_REMPL, PRIX_TTC_PUBLIC, PRIX_TTC_FACTU_O2M ne sont pas autorisés pour le produit " + String ( dcIdProd ) + "." )
			End If
			
	End Choose
	// :[VDOC7926]

	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	
	
	// [VDOC9907]
	// Mettre en place pour CEAT ces règles, rejet du fichier MPR si : 
	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un status_gc différent de 21 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If lVal <> 21 And ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9907/A.RAULT) : présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un status_gc différent de 21 , interdit " )
	End IF

	// Mettre en place pour CEAT ces règles, rejet du fichier MPR si : 
	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour à une commande avec action = A_REPARER ou A_REPARER_FORCE 
	// [PM222-1]	
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) &
		 And ( sIdRefFour = "A_REPARER" Or sIdRefFour = "A_REPARER_FORCE" ) &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REP_GARANTIE", ";") <> "OUI" &		 
	Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9907/A.RAULT) : présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour sur une commande sans demande de SAV (donc n’impliquant pas d’action = A_REPARER_SAV ou A_CONTROLER_SAV ), interdit" )
	End IF 
	// :[VDOC9907]
	
	// [VDOC10029]	
	sVal1 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_O2M", ";")
	sVal2 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_FACTU_BLC", ";")
	sVal3 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRIX_TTC_PUBLIC", ";")
	
	If IsNumber ( sVal1 ) Then
		sVal = sVal1
	End If	

	If IsNumber ( sVal2 ) Then
		sVal = sVal2
	End If	

	If IsNumber ( sVal ) And IsNumber ( sVal3 ) Then
		
		If Dec ( sVal ) > Dec ( sVal3 ) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC10029/A.RAULT) : le montant du prix facturable par CEAT concernant la proposition est supérieur au prix public indiqué, ce qui est incohérent" )
		End If
		
	End If
	// [VDOC10029]		
	
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "ORANGE_V3", ";") = "OUI" Then
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		If sIdRefFour = "A_DIAGNOSTIQUER" And lVal <> 151 And lVal <> 152 And lVal <> 159 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (ORANGE V3) : Pour Orange v3, seul le 151 ou 152 sont autorisé sur le Diag après remplacement" )
		End IF 
	End IF 			
	// [PC938_ORANGE_V3]
	
	// [20140728.FPI] 
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODL_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 35 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MODL_RST_FRN trop longue (35 caractères maximum autorisés)." )
	End if
	
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQ_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 35 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée MARQ_RST_FRN trop longue (35 caractères maximum autorisés)." )
	End if

	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_REF_FOUR_RST_FRN", ";"))						
	If sVal <> "" And Len(sVal) > 20 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Donnée ID_REF_FOUR_RST_FRN trop longue (20 caractères maximum autorisés)." )
	End if
	// [20140728.FPI] 

	
	// [MODIF_SUITE_REDR]
	Choose Case iStatusGc
		Case 176, 151, 152, 2, 21
	
			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			// [VDOC17191] je ne déclenche pas le message sur le 159
			Choose Case lVal
				Case 301, 159, 156	
					// Ok
				Case Else
					If iStatusGc <> lVal Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
					End If

			End CHoose
			
	End CHoose
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 155 And sIdRefFour <> "REFUSE_A_REEXP" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " ne peut être renvoyé que sur une prestation de type REFUSE_A_REEXP" )
	End If

	// [CTRLE_REF_A_REEXP]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal <> 155 And sIdRefFour = "REFUSE_A_REEXP" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") une prestation de type REFUSE_A_REEXP ne peut recevoir qu'un Statut 155 en retour, et non " + String ( lVal ) + "." )
	End If
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	Choose Case sIdRefFour  
		Case "A_REPARER_FORCE", "A_DIAG_FORCE"

			If lVal > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il est interdit de répondre sur les prestations de type A_REPARER_FORCE, et A_DIAG_FORCE, or vous renvoyez le Statut " + String ( lVal ) + ". Si une réponse doit être apportée, vous devez répondre sur la préstation d'origine liée à ce forçage." )
			End If
	End Choose		
	
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	
	// [DT288-3_LOT1_2EME_VS] 612
	Choose Case lVal
		Case 152, 21, 612
			
			If IsNull ( sVal ) Or sVal = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " doit obligatoirement être accompagné d'un commentaire." )
			End If
			
	End CHoose

	// [PM251-2]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") <> "OUI" Then
		sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "REMIS_EN_STK", ";"))		
		If sVal1 = "OUI" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " n'est autorisé que pour une commande de remplacement." )
		End If	
	End If

	// [DT288]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") = "OUI" Then	
		sVal = idwFicFourn.GetItemString ( lCpt, "SWAP_GSX" ) 
		If Trim ( sVal ) = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT288) : Sur une commande de remplacement, la zone SWAP_GSX doit être renseignée par OUI ou NON." )
		End If 					
	
		// [DT288]
		sVal = idwFicFourn.GetItemString ( lCpt, "REF_ORANGE" ) 
		If Trim ( sVal ) = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT288) : Sur commande de remplacement, la zone REF_ORANGE doit être renseignée." )
		End If 
	End If
	
	// [PM284-1]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	If lVal = 303 Then
		Choose Case dcIdProd
			Case 35800, 35801, 35802, 35803, 80500, 80501, 80502, 80503, 44500, 44501, 44502, 44503
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " n'est pas autorisé pour le produit " + string ( dcIdProd ) + "." )
		End Choose 
	End If			
	
	// [PM222-1]

	// [DT150]
	/*
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
		If lVal = 305 And lnvPFCString.of_getkeyvalue (sChaineBCV, "GESTION_GEOLOCALISATION", ";") <> "OUI" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le produit " + String ( dcIdprod ) + " n'est pas éligible au projet DT150 gérant la géolocalisation. Si ce projet doit rentrer dans ce périmètre, voir avec DPG pour ajouter le produit, sinon transmettre l'information au fournisseur que ce produit est interdit pour ce code retour." )
		End If
		
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
		If lVal = 306 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Statut de retour interdit ! " + String ( lVal ) + "." )
		End If 
	*/
	
	// [ITSM326003]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") = "OUI" Then
		sVal1 = sNumImeiSerie
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
		Choose Case lVal 
			Case 177, 178
				If isnull(sVal1) Or sVal1 = "" Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le numéro de série/IMEI de l'appareil de remplacement n'est pas renseigné." )
				End If	
		End Choose 
	End If
	
	// [VDOC18200]
	If Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "ETAT_APP_PRET", ";") ) > 0 Then
		If Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "DTE_RESTIT_APP_PRET", ";") ) <= 0 And &
			Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCplt, "DTE_RESTIT_APP_PRET", ";") ) <= 0 Then 

			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") : Retour du BCV ETAT_APP_PRET sans le BCV DTE_RESTIT_APP_PRET, interdit." )
		End If
	End If
	// [VDOC18200]	
	
	// [DT200]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt, "NE_PAS_REPARER", ";"))
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	If sVal = "OUI" Then
			Choose Case lVal
				Case 2
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Réparation interdite sur ce type de prestation, il faut répondre 21 Irréparable dans tous les cas et qualifier l'irréparabilité dans le commentaire par un mot clé." )
			End Choose 
	End if

	// [PM287-3]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	lVal1 = Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") )
	If lVal = 308 And lVal1 <= 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le statut retour 308 vous oblige à renseigner le bcv IFDNMQ_RET (InFos DoNnées ManQuante RETour) avec un codage particulier, voir livraison PM287-3." )
	End If

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	lVal1 = Len ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") )
	If lVal <> 308 And lVal1 > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + String ( lVal ) + " interdit la présence du bcv IFDNMQ_RET (InFos DoNnées ManQuante RETour) dans la zone sérialisée, voir livraison PM287-3." )
	End If


	If lVal = 308 And lVal1 > 0 Then
		sVal2 = "#305#232#"
		sVal  = lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") 
		sVal3 = lnvPFCString.of_getkeyvalue (sChaineBCV, "DNCX_STATUS_GC", ";") 
		lnvPFCString.of_parsetoarray( sVal,"#", sTabVal )

		lTot = UpperBound ( sTabVal ) 

		For lCptVal = 1 To lTot
			If IsNull ( sTabVal [lCptVal] ) Or Trim ( sTabVal [lCptVal] ) = "" Then Continue 
			
			If Pos ( sVal2, "#" + sTabVal [lCptVal] + "#" ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La valeur #" + sTabVal [lCptVal] + "# n'est pas autorisée dans le BCV IFDNMQ_RET pour le statut 308, voir livraison PM287-3." )
			End If

			If iRet > 0  Then
				If Pos ( sVal3, "#" + sTabVal [lCptVal] + "#" ) > 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La valeur #" + sTabVal [lCptVal] + "# est interdite pour le statut 308/BCV IFDNMQ_RET pour le produit " + String ( dcIdprod ) + ", voir livraison PM287-3." )
				End If
			End If
		Next 
	
	End IF
	

	// [DT280]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))		
	If sVal = "OUI" Then
		
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		

		// [VDOC27123]BVID/BVIP/BVIT
		If ( &
				( lVal = 21 ) And Not ( Pos (sVal,  "[BVIE]" ) > 0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &
				Or &
				( lVal = 23 ) And Not ( Pos (sVal,  "[BVIEOX]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &					
				Or &
				( lVal <> 21 And lVal <> 23 ) &
			) Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Le SWAP CEAT n'est autorisé que sur un irréparable 21/23 avec un mot clé [BVIE]/[BVID]/[BVIP]/[BVIT]/[BVIEOX] ou [PIE]." )
		End If 				
			
		If iRet > 0 Then
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";"))		
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CEAT le BCV MARQSW doit être renseignée avec la marque IFR du nouveau matériel." )
			End If 	
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";"))		
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CEAT le BCV MODLSW doit être renseigné avec le modèle IFR du nouveau matériel." )
			End If 					

			If iRet > 0 Then
				Choose Case sIdTypArtSin
					Case "TEL", "TPC"
						// Autorisé
					Case Else 
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Type d'appareil (" + sIdTypArt+ ") non autorisé pour un SWAP CEAT." )
				End Choose
			End If 

			// Controle binome marq/modl appartient à IFR à ajouter
			If iRet > 0 Then
				sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";"))
				sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";"))
				If SQLCA.PS_S_VERIF_MARQ_MODL_IFR_V01 ( dcIdprod, sIdTypArtSin, sVal, sVal1 ) <= 0 Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Sur un SWAP CEAT, pour ce dossier, la Marque et le Modèle du nouveau matériel (" + sVal + " " + sVal1 + ") doivent appartenir au référentiel IFR." )
				End If
			End If
			
			sVal = sNumImeiSerie // Le ctrle de validité est faite plus haut
			If Trim ( sVal ) = "" Or IsNull ( sVal )  Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CEAT la zone NUM_IMEI_NOUV ou NUM_SERIE_NOUV doit être renseignée par l'IMEI/SERIE du nouveau matériel." )
			End If 					


			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MTTTCSW", ";"))
			If Trim ( sVal ) = "" Or Not IsNumber ( sVal ) Or Pos ( sVal, ",") > 0 Or Pos ( sVal, "E") > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CEAT le BCV MTTTCSW doit être renseigné avec le montant TTC de l'appareil de remplacement (avec un point en séparateur de décimal)." )
			End If 

			// [BUG_RST_PRIX_O2M]
			If IsNumber ( sVal ) Then
				If Long ( sVal) = 0 Then 
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CEAT le BCV MTTTCSW doit être renseigné avec le montant TTC de l'appareil de remplacement (avec un montant positif)." )
				End if		
			End If 

			// [VDOC23499]
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NEUF_REC", ";"))
			Choose Case sVal
				Case "NEU", "REC"
					// Ok
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280/VDOC23499) : le BCV NEUF_REC est obligatoire et doit contenir les valeurs NEU ou REC." )
			End Choose 
			
			sVal = idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) 
			sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) )  		

			If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT280) : Sur un SWAP CEAT, Le numéro de bon transporteur est obligatoire." )
			End IF 

			// [DT288]
			sVal = idwFicFourn.GetItemString ( lCpt, "SWAP_GSX" ) 
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT288) : Sur un SWAP CEAT la zone SWAP_GSX doit être renseignée par OUI ou NON." )
			End If 					

			// [DT288]
			sVal = idwFicFourn.GetItemString ( lCpt, "REF_ORANGE" ) 
			If Trim ( sVal ) = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT288) : Sur un SWAP CEAT la zone REF_ORANGE doit être renseignée." )
			End If 					

		End If		
		
	End If
	
	// [DT290]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";"))					
	If iInfoSpbFrn = 984 And sVal <> "OUI" And sIdTypArt <> "PST" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT290) : Sur un process 984, le SWAP est obligatoire, pas de process alternatif donc le bcv APP_SWAP doit obligatoirement être à OUI." )
	End If

	// [PM383-1]
	sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "SOUS_GC", ";"))
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	
	If sVal = "OUI" Then
		Choose case lVal 
			Case 2, 22
				//ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (PM383-1) : le bcv SOUS_GC=OUI n'est accepté qu'avec le retour 2 (réparé)." )
		End Choose 
	End If
	// [PM383-1]	
	
	// IRREP_QUALIFIE
	sVal1= String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		

	// [VDOC27123]BVID/BVIP/BVIT
	If lVal = 21 And &
		( &
		  Pos ( sVal1, "[BNVSOX]") <= 0 And &
		  Pos ( sVal1, "[CRSMTPEC]") <= 0 And &
		  Pos ( sVal1, "[BNV]") <= 0 And &
		  Pos ( sVal1, "[OXY]") <= 0 And &
		  Pos ( sVal1, "[PIE]") <= 0 And &
		  Pos ( sVal1, "[PNC]") <= 0 And &
		  Pos ( sVal1, "[BRIS]") <= 0 And &
		  Pos ( sVal1, "[SAV_NO_OK]") <= 0 And &
		  Pos ( sVal1, "[BVIEOX]") <= 0 And &
		  Pos ( sVal1, "[EXP]") <= 0  And &			  
		  Pos ( sVal1, "[BVIE]") <= 0  And &			  
		  Pos ( sVal1, "[BVID]") <= 0  And &			  
		  Pos ( sVal1, "[BVIP]") <= 0  And &			  
  		  Pos ( sVal1, "[BVIT]") <= 0  And &			  
		  Pos ( sVal1, "[NOSPBS]") <= 0 ) &
		  Then

			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il manque dans le commentaire un des mots clés obligatoire qualifiant l'irréparable." )

	End If 
	
	// [DT288-3_LOT1_2EME_VS]
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If sIdRefFour = "INFORMATION" And lVal <> 612 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") : un flux de type INFORMATION ne peut avoir pour réponse qu'un statut 612" )
	End IF 

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  			
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "COLIS_PND", &
				  "COLIS_NRPAC", &
				  "COLIS_PERDU", &
				  "COLIS_BALNI", &
				  "COLIS_INCOR", &
				  "COLIS_REFUS", &
				  "ANNUL_REFAIT", &
				  "EN_ATTENTE", &
				  "AUTRE", &
				  "J1", &
				  "J2", &
				  "J3", &
				  "J4", &
				  "J5", &
				  "J6" 
			
					// Ok
					
			Case Else 

				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
	End If 

	// [PM450-1]
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";"))
	sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))	

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""		
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PEC_PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
		
		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la clé PEC_PRBLE_LIVRAISON n'est autorisée que si précédemment il y a au un clé PRBLE_LIVRAISON, qui est justement absente." )
		End If 			
	End If 	
	
	// Coder au dessus de cette ligne.

	
	// #6 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then
		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

if isvalid(dsCode) Then destroy dsCode

Return iRet

end function

private subroutine uf_definir_codetat_ceat (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_CEAT (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 02/01/2017
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [DT253]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF   19/09/2011   [PM82][LOT1]
//        JFF   19/04/2016   [DT209]
//*-----------------------------------------------------------------

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	// [DT209] 601, 602
	// [DT288-3_LOT2] Ajout 169
	Case 2,21,151,152,153,154,155,157,160,161, 165, 166, 170, 171, 167, 168, 179 , 175, 176, 237, 601, 602, 169

		// [VDOC9304_PM82_LOT1]
		// [VDOC15485]
		If ( ( lVal = 153 Or lVal = 154 ) And sIdTypArt = "PRS" ) Then
			asVal = "ECT"  // EN COURS DE TRAITEMENT
		Else
			asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)
		End If

	Case 178, 263, 234 // [PM166][O2M] // [PC938_ORANGE_V3]

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		

// [RECUP_DONNEE_O2M]
Choose Case sIdRefFour
	Case "PEC_A_RECYCLER", "PAS_DE_COMMANDE"
		asVal = "RFO"
End Choose 


end subroutine

private function integer uf_integration_fichier_ceat (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_CEAT (PRIVATE)
//* Auteur			: JFF
//* Date				: 24/01/2017
//* Libellé			: Intégration du fichier CORDON dans la base
//* Commentaires	: [DT288]
//*
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1 	 PHG	 24/04/2008	  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #2    JFF   28/04/2008   [DCMP080202] MailPush O2M
//* #3	 JFF	 20/10/2008	  [FNAC_PROD_ECH_TECH]
//* #4	 FPI	 10/12/2009	  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF   30/06/2010   [PC363_AUCHAN]
//*       JFF   07/03/2011   [VDOC3290]
//*       JFF   11/03/2011   [ITSM62176] ajout du point de décimal
//*       JFF   19/09/2011   [PM82][LOT1]
//*       JFF   05/01/2012   [RECUP_DONNEE_O2M]
//        JFF   06/08/2012   [BLCODE]
//       JFF   07/05/2013 	  [PC938_ORANGE_V3]
//       JFF   03/07/2013 		[VDOC9908]
//       JFF   08/04/2014 [PM255]
//       JFF   07/05/2013 [PM250-1]
//       JFF   02/06/2014 [PC929_CDISCOUNT][PC929-2-V3]
// 		FPI	21/07/2014 [PM250-1].FPI Correction réinit de date avant lecture de la ligne
//       JFF   18/08/2014 [PM254_V1]
//       JFF   25/08/2014 [DT100]
//       JFF   16/09/2014 [PM250-2]
//			JFF	25/09/2014		[MODIF_SUITE_REDR]
//       JFF   25/11/2014 		[PM251-2]
//       JFF   31/03/2016 [PM287-3]
//       JFF   17/05/2016 [PM280-2]
//       JFF   10/03/2017 [PM383-1]
//       JFF   04/04/2017 [VDOC23499]
//       JFF   18/09/2017 [DT288-3_LOT2]
//       JFF   17/04/2018 [DT288-4]
//       JFF   28/01/2019 [PM450-1]
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn, dtDteArrPlatForm, dtDteDepPlatForm 
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq
Decimal {2} dcMtFrais
String sInfoFrnSpbCplt  	// #3 [FNAC_PROD_ECH_TECH]
n_cst_string lnvPFCString  // [PC363_AUCHAN]

// #2 [DCMP080202]
Int iRetMailPush 
String sDestEnvoi, sNumBonTrsp 
DateTime dtDteEnvCli
// :#2 

String sCasRetour, sIdAppli, sBase, sCommentFrn 
Long lStatusGc 

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

sInfoFrnSpbCplt = ""
iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0


For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	// [MANTIS14172]
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	// [BLCODE]
	sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 			
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
 	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	// [DT288]	
	sVal = "null"	
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// [PM255] // [PM250-2]
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	// [DT288-3_LOT2]
	This.uf_Definir_CodEtat_CEAT ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "
//	sCommentFrn = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	If Not IsNull( sInfoFrnSpbCpltLu ) and Trim ( sInfoFrnSpbCpltLu ) <> "" Then 
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 
		If IsDate ( sVal ) Then
			sVal = "'" + sVal + "'" 
		Else
			sVal = "null"		
		End IF			
	Else
		sVal = "null"		
	End If
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #1 [DCMP080199]

	/*------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#1 [DCMP080199]			  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NOM_TRANSPORTEUR" ) ) ) + "'"
	if isnull(sVal) then sVal = "null"
	sSql += sVal + ","

	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "


	// Préparation zone INFO_FRN_SPB_CPLT 
	// Trt zone virtuelle RDV_CONF vers sInfoFrnSpbCplt

	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	// [VDOC3290]
	Choose Case sVal 
		Case "169" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")
		Case "162" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SYMP_NON_DETEC_EN_24H", "OUI", ";")			

		// [PM82][LOT1]
		Case "153" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_153", "OUI", ";")			
		// [PM82][LOT1]			
		Case "154" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_154", "OUI", ";")
		
		// [DT288]
		Case "611" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_611", "OUI", ";")

		// [PM287-3]
		Case "311" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_311", "OUI", ";")
		
		
	End Choose
	// [VDOC3290]

	// [PM246]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If		
	// [PM246]

	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RCP_MOB_CLI", sVal, ";")
	End If		
	

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CODE_ERREUR_LIVR", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CODE_ERREUR_LIVR", sVal, ";")
	End If		

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	// [PM251-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "REMIS_EN_STK", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "REMIS_EN_STK", sVal, ";")
	End If		

	// [PM287-3]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "IFDNMQ_RET", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "IFDNMQ_RET", sVal, ";")
	End If		

	// [PM280-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DECLASS_PCT", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DECLASS_PCT", sVal, ";")
	End If		

	// [PM280-2]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "A_CHARGE", ";") 		
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "A_CHARGE", sVal, ";")
	End If		

	// [DT280]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "APP_SWAP", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_SWAP", sVal, ";")
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TGR_APPSW", sVal, ";")	// Trigger Technique 
	End If		
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQSW", sVal, ";")
	End If			
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODLSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODLSW", sVal, ";")
	End If			

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MTTTCSW", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MTTTCSW", sVal, ";")
	End If			

	// [VDOC23499]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NEUF_REC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NEUF_REC", sVal, ";")
	End If		

	// [PM383-1]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "SOUS_GC", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SOUS_GC", sVal, ";")
	End If			

	// [PM450-1]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
	End If
	
	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sSql += "'" + sInfoFrnSpbCplt + "'"

	// [DT288-4]
	sChaineMailRempl = sInfoFrnSpbCplt

	// #2 [DCMP080202]
	iRetMailPush = This.uf_MailPush ( "RECP_APP_EN_CTR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ 
		F_commit ( SQLCA, False ) 
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/RECP_APP_EN_CTR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #3
		Continue 
	End If
	// :#2

	// [PM255] // [DT100] [PM250-2]
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, "CLIENT", sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If	

	// [PM250-1]
	iRetMailPush = SQLCA.PS_S_MAILPUSH_ARR_PLATFORM ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteArrPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_ARR_PLATFORM, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	
	iRetMailPush = SQLCA.PS_S_MAILPUSH_DEP_CENTRDISTRIB ( sIdAppli, sBase, lIdSin, lIdSeq, dtDteDepPlatForm, lStatusGc, sCommentFrn, sNumBonTrsp, sCasRetour ) 
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/PS_S_MAILPUSH_DEP_CENTRDISTRIB, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
		Continue // #2
	End If				
	// [PM250-1]	


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
	//		alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #4
			F_commit ( SQLCA, True )
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		
		// [MODIF_SUITE_REDR]
		sVal = SQLCA.SQLErrText		
		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")	

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + sVal )

		F_commit ( SQLCA, False )
			
		Continue 
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1

Return iRet 
end function

private function integer uf_ctrl_fichier_agora_place ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_AGORA_PLACE (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/03/2006
//* Libellé			: Controler de la validité du fichier du AGORA_PLACE
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #3   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//* 		 JFF     03/05/2011 [PM178][CORIOLIS]
//* 		 JFF     23/11/2012 [VDOC9416]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   28/01/2019 [PM450-1]
//*-----------------------------------------------------------------

n_cst_string lnvPFCString
Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl, sVal2, sInfoFrnSpbCpltLu 
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1, dtNull
Long	lIdSin, lIdSeq //#2
datastore	dsCode

Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn


iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""
	
	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	Choose Case iStatusGc
		Case 176, 178

			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			// [VDOC17191] je ne déclenche pas le message sur le 159
			If iStatusGc <> lVal Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
			End If

	End CHoose
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )

	If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Un numéro d'IMEI doit contenir 15 chiffres" )
	End If

	If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Numéro d'IMEI non valide" )
	End If 

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  
	If IsNull ( sVal )  Then sVal = ""
	
	If sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La date de réception du flux SPB chez AGORA PLACE est obligatoire" )		
	End IF 

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  
	If IsNull ( sVal )  Then sVal = ""
	
	If sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La date de traitement/envoi par AGORA PLACE est obligatoire que le statut soit 178 ou 176." )		
	End IF 

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If ( lVal = 0 Or IsNull ( lVal ) ) And sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Lorsque la date de fin de traitement (DTE_ENV_CLI) est renseignée, un statut GC est obligatoire.")
	End If 


	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If


	/*------------------------------------------------------------------*/
	/* ZONE 7 : DTE_RCP_MOB_CLI													  */
	/*------------------------------------------------------------------*/
	sVal = String ( Date ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) )  
	If IsNull ( sVal )  Then sVal = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", sVal, ";")
	idwFicFourn.SetItem  ( lCpt, "INFO_FRN_SPB_CPLT", sInfoFrnSpbCpltLu )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal
		Case 177, 178
			If IsNull ( sVal ) Or Len ( sVal ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) )
			End If
	End Choose

	// [MODIF_SUITE_REDR]
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "NUM_BON_TRP", Trim ( sVal ) )		

	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [PM426-1]	
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	
	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
	if dsCode.find("( ID_CODE IN (176, 178 ) "+ &
						") AND ID_CODE = " + sVal &
						, 1, dsCode.RowCount()+1 ) = 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
	End If			

	
	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then	
		Choose Case sVal
			Case "COLIS_PND", &
				  "COLIS_NRPAC", &
				  "COLIS_PERDU", &
				  "COLIS_BALNI", &
				  "COLIS_INCOR", &
				  "COLIS_REFUS", &
				  "ANNUL_REFAIT", &
				  "EN_ATTENTE", &
				  "AUTRE", &
				  "J1", &
				  "J2", &
				  "J3", &
				  "J4", &
				  "J5", &
				  "J6" 
			
					// Ok
					
			Case Else 

				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
	End IF 	

	// [PM450-1]
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";"))
	sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))	

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""		
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PEC_PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
		
		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la clé PEC_PRBLE_LIVRAISON n'est autorisée que si précédemment il y a au un clé PRBLE_LIVRAISON, qui est justement absente." )
		End If 			
	End If 	

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.
	// #3 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If


Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_agora_place (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_AGORA_PLACE (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 17/09/2018
//* Libellé			: Intégration du fichier du Coriolis dans la base
//* Commentaires	: //[PM444-1]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	  24/04/2008  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	 FPI	  10/12/2009  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//  			FPI	04/08/2011	[FPI.04082011] Prise en compte de la date de réception des mobiles par les assurés
//       JFF   18/08/2014 [PM254_V1]
//		FPI	18/07/2018	[ITSM546478]
//       JFF   11/12/2024 [LGY15]
//*-----------------------------------------------------------------
Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc
n_cst_string lnvPFCString

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" 
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteRcpFrn =  idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	This.uf_definir_codetat_AGORA_PLACE ( sVal, lCpt, lIdSin, lIdSeq )
	
	sSql += "'" + sVal + "', "
	//#1
	// sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) )
	sDestEnvoi	= "CLIENT" // [LGY15] on force car sion le mail de swap ne part pas


	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	// [FPI.04082011]
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If	
	
	sVal = Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 10 ) 
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RCP_MOB_CLI", sVal, ";")
	End If	

	// [PM450-1]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
	End If
	
	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	sSql += "'" + sInfoFrnSpbCplt + "'"


	// #1
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If				
	// Fin #1
	
	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

public subroutine uf_definir_codetat_agora_place (ref string asval, integer alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_definir_codetat_agora_place (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 17/09/2018
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [PM444-1]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 
//*-----------------------------------------------------------------

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	// [PM284-1] 303
	Case 176

		asVal = "ANN"  // Cloture Commande

	Case 178

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		


end subroutine

private function integer uf_ctrl_fichier_omt_ctrle_imei ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_OMT_ctrle_imei (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 28/11/2018
//* Libellé			: Controler de la validité du fichier IMEI OMT
//* Commentaires	: [PC874_2_V1]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #..   ...   ../../....   
//*-----------------------------------------------------------------

Int iRet, iStatusGc, iInfoSpbFrn
String	sIdFour, sVal, sCar, sIdFourCtrl, sInfoFrnSpbCpltLu, sIMEICorr
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sVal1, sVal2, sVal3
String sInfoFrnSpbCplt, sIdTypArtSin
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal, lVal1
Boolean	bTrouve
datastore	dsCode
Long dcIdProd, lTot
String sInfoSpbFrnCplt, sChaineBCV, sNumImeiSerie
String sTabVal[], sTabNull[]
Long lNbreLignDeb, lNbreLignFin
Long	lIdSin, lIdSeq //#2
datetime	dtVal, dtVal1, dtNul
n_cst_string lnvPFCString  

SetNull ( dtNul )
iRet = 1

lTotLig = idwFicFourn.RowCount ()

// [MODIF_SUITE_REDR]
If lTotLig <= 0 And FileLength64 ( isTxtNomFic.Text ) > 0 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR : 0 Ligne chargée ! , pour PI : Taille du fichier positive et chargement à 0 ligne => Anormal. Réessayez l'intégration (cause éventuelle => le fichier est peut-être en format Unicode au lieu d'Ansi, à vérifier)." )
End If		

sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )
dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 		// #9


For lCpt = lTotLig To 1 Step -1

	sIdRefFour = fill(" ",20)
	sCodEtat = fill(" ",3)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
	// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If
	End If
	
	// [PM82][LOT1]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_FIN_TRAIT									  */
	/*------------------------------------------------------------------*/
	// #9
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")
	lVal =   idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	Choose case lVal

		Case 621
			If IsNull ( dtVal ) Or Not IsDate ( String ( Date ( dtVal ) )) Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La date de fin de dernière utilisation de l'IMEI est obligatoire pour le retour 621 et doit être une date valide.")
			End If 
			
		Case 622

//			idwFicFourn.SetItem ( lCpt, "DTE_FIN_TRAIT", dtNul )

			If Not IsNull ( dtVal ) Then 
				If Not IsDate ( String ( Date ( dtVal ) )) Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La date de fin de dernière utilisation de l'IMEI doit être une date valide si elle est transmise pour le retour 622.")
				End If 
			End If 
		
	End Choose 

	// Fin #9

	
	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [O2M] : Vérification de l'appartenance du code retourné au paramétrage.
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )

	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )

	if dsCode.find("( ID_CODE IN (621, 622 ) " + &
						") AND ID_CODE = " + sVal  &
						, 1, dsCode.RowCount()+1 ) = 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
	End If			
	
	
	// Coder au dessus de cette ligne.

	
	// #6 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then
		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

	
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

if isvalid(dsCode) Then destroy dsCode

Return iRet

end function

private subroutine uf_definir_codetat_omt_ctrle_imei (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_OMT_CTRLE_IME (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 28/11/2018
//* Libellé			: 
//* Commentaires	: [PC874_2_V1]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	// [DT209] 601, 602
	// [DT288-3_LOT2] Ajout 169
	Case 621, 622

		asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)

	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		


end subroutine

private function integer uf_integration_fichier_omt_ctrle_imei (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_integration_fichier_omt_ctrle_imei (PRIVATE)
//* Auteur			: JFF
//* Date				: 28/11/2018
//* Libellé			: Intégration du fichier OMT dans la base
//* Commentaires	: [PC874_2_V1]
//*
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//
//*-----------------------------------------------------------------

Int iRet 
DateTime dtDteRcpFrn, dtDteArrPlatForm, dtDteDepPlatForm 
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq
Decimal {2} dcMtFrais
String sInfoFrnSpbCplt  	// #3 [FNAC_PROD_ECH_TECH]
n_cst_string lnvPFCString  // [PC363_AUCHAN]

// #2 [DCMP080202]
Int iRetMailPush 
String sDestEnvoi, sNumBonTrsp 
DateTime dtDteEnvCli
// :#2 

String sCasRetour, sIdAppli, sBase, sCommentFrn 
Long lStatusGc 

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

sInfoFrnSpbCplt = ""
iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )

	// [MANTIS14172]
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	// [BLCODE]
	sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 			
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
 	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "


	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// [PM255] // [PM250-2]
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	// [DT288-3_LOT2]
	This.uf_Definir_CodEtat_OMT_CTRLE_IMEI ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	If Not IsNull( sInfoFrnSpbCpltLu ) and Trim ( sInfoFrnSpbCpltLu ) <> "" Then 
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", ";") 
		If IsDate ( sVal ) Then
			sVal = "'" + sVal + "'" 
		Else
			sVal = "null"		
		End IF			
	Else
		sVal = "null"		
	End If
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #1 [DCMP080199]

	/*------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#1 [DCMP080199]			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	
	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sInfoFrnSpbCplt = ""
	sSql += "'" + sInfoFrnSpbCplt + "'"

	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
	//		alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++				// #4
			F_commit ( SQLCA, True )
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		
		// [MODIF_SUITE_REDR]
		sVal = SQLCA.SQLErrText		
		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")	

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + sVal )

		F_commit ( SQLCA, False )
			
		Continue 
	End If

Next

If alNbLigNonTraitee	> 0 Then iRet = -1

Return iRet 
end function

private function integer uf_ctrl_fichier_orangegrandpublic ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_OrangeGrandPublic (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 06/09/2019
//* Libellé			: Controler de la validité du fichier du OrangeGrandPublic
//* Commentaires	: [DT424]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

n_cst_string lnvPFCString
Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl, sVal2, sInfoFrnSpbCpltLu 
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1, dtNull
Long	lIdSin, lIdSeq //#2
datastore	dsCode
Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	
	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	Choose Case iStatusGc
		Case 710, 715, 720, 725, 730, 735, 740

			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			// [VDOC17191] je ne déclenche pas le message sur le 159
			If iStatusGc <> lVal Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
			End If

	End CHoose
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_FIN_TRT															  */
	/*------------------------------------------------------------------*/
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")

	If IsNull ( dtVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la date de traitement (DTE_FIN_TRT) doit être renseignée dans tous les cas.")
	End if	
	
	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS2", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	

	/*------------------------------------------------------------------*/
	/* ZONE 4 :   DTE_1_UTIL_1														  */
	/*------------------------------------------------------------------*/
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_1"))
	lVal  = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )

	Choose Case lVal 
		Case 740
			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de 1ère utilisation (DTE_1_UTIL_1) ne doit pas être renseignée.")
			End if	

		Case Else 

			If IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de 1ère utilisation (DTE_1_UTIL_1) doit être renseignée.")
			End if	

	End Choose 

	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	/*------------------------------------------------------------------*/
	/* ZONE 5 :    DTE_DDU_1														  */
	/*------------------------------------------------------------------*/
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_1") )

	Choose Case lVal 
		Case 740
			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de dernière utilisation (DTE_DDU_1) ne doit pas être renseignée.")
			End if	

		Case Else 

			If IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de dernière utilisation (DTE_DDU_1) doit être renseignée.")
			End if	

	End Choose 

	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	dtVal =  Datetime ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_1"))
	dtVal1=  Datetime ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_1"))
	
	sVal = String ( dtVal )
	sVal1 = String ( dtVal1 )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	/*------------------------------------------------------------------*/
	/* ZONE 5 : IMSI_1  (numéro carte SIM)                              */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "IMSI_1" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro de carte SIM (IMSI_1) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Or Len ( sVal ) <> 14 Or Not IsNumber ( sVal ) Then // 14 en France          Len ( sVal ) < 12 Or Len ( sVal ) > 20 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro de carte SIM (IMSI_1) doit être renseigné et être valide (numéro de 14 chiffres en France).")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 6 : MSISDN_1  (numéro du tel) 			 						    */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "MSISDN_1" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro du téléphone (MSISDN_1) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Or Len ( sVal ) <> 10 Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro du téléphone (MSISDN_1) doit être renseigné et être valide (numéro de 10 chiffres).")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 7 :  NOM_CLI_1                                              */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NOM_CLI_1" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 715, 740
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le nom du client (NOM_CLI_1) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le nom du client (NOM_CLI_1) doit être renseigné.")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 8 :  PRENOM_CLI_1                                           */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "PRENOM_CLI_1" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 715, 740
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le prénom du client (PRENOM_CLI_1) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le prénom du client (PRENOM_CLI_1) doit être renseigné.")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 9 :   DTE_1_UTIL_2														  */
	/*------------------------------------------------------------------*/
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_2"))
	lVal  = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de 1ère utilisation (DTE_1_UTIL_2) ne doit pas être renseignée.")
			End if	

		Case Else 

			If IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de 1ère utilisation (DTE_1_UTIL_2) doit être renseignée.")
			End if	

	End Choose 

	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	/*------------------------------------------------------------------*/
	/* ZONE 5 :    DTE_DDU_2														  */
	/*------------------------------------------------------------------*/
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_2"))

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de dernière utilisation (DTE_DDU_2) ne doit pas être renseignée.")
			End if	

		Case Else 

			If IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de dernière utilisation (DTE_DDU_2) doit être renseignée.")
			End if	

	End Choose 

	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_2"))
	dtVal1=  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_2"))
	
	sVal = String ( dtVal )
	sVal1 = String ( dtVal1 )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	/*------------------------------------------------------------------*/
	/* ZONE 5 : IMSI_2  (numéro carte SIM)                              */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "IMSI_2" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro de carte SIM (IMSI_2) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Or Len ( sVal ) <> 14 Then // 14 en France          Len ( sVal ) < 12 Or Len ( sVal ) > 20 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro de carte SIM (IMSI_2) doit être renseigné et être valide (numéro de 14 chiffres en France).")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 6 : MSISDN_2  (numéro du tel) 			 						    */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "MSISDN_2" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro du téléphone (MSISDN_2) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Or Len ( sVal ) <> 10 Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro du téléphone (MSISDN_2) doit être renseigné et être valide (numéro de 10 chiffres).")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 7 :  NOM_CLI_2                                              */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NOM_CLI_2" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le nom du client (NOM_CLI_2) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le nom du client (NOM_CLI_2) doit être renseigné.")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 8 :  PRENOM_CLI_2                                           */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "PRENOM_CLI_2" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le prénom du client (PRENOM_CLI_2) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le prénom du client (PRENOM_CLI_2) doit être renseigné.")
			End if	

	End Choose 


	/*------------------------------------------------------------------*/
	/* ZONE 15 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	
	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
	if dsCode.find("( ID_CODE IN ( 710, 715, 720, 725, 730, 735, 740 ) "+ &
						") AND ID_CODE = " + sVal &
						, 1, dsCode.RowCount()+1 ) = 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
	End If			


	/*------------------------------------------------------------------*/
	/* ZONE 16 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 17 : INFO_FRN_SPB_CPLT												  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier pour l'instant.

	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If


Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_ctrl_fichier_orangeopenpro ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_OrangeOpenPro (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 06/09/2019
//* Libellé			: Controler de la validité du fichier du OrangeOpenPro
//* Commentaires	: [DT424]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

n_cst_string lnvPFCString
Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl, sVal2, sInfoFrnSpbCpltLu 
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1, dtNull
Long	lIdSin, lIdSeq //#2
datastore	dsCode
Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn

iRet = 1

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	
	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	// [CTRLE_DATE_INTRG_FOU]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	Choose Case iStatusGc
		Case 710, 715, 720, 725, 730, 735, 740

			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			// [VDOC17191] je ne déclenche pas le message sur le 159
			If iStatusGc <> lVal Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
			End If

	End CHoose
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : DTE_FIN_TRT															  */
	/*------------------------------------------------------------------*/
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")

	If IsNull ( dtVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la date de traitement (DTE_FIN_TRT) doit être renseignée dans tous les cas.")
	End if	
	
	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS2", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	

	/*------------------------------------------------------------------*/
	/* ZONE 4 :   DTE_1_UTIL_1														  */
	/*------------------------------------------------------------------*/
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_1"))
	lVal  = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )

	Choose Case lVal 
		Case 740
			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de 1ère utilisation (DTE_1_UTIL_1) ne doit pas être renseignée.")
			End if	

		Case Else 

			If IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de 1ère utilisation (DTE_1_UTIL_1) doit être renseignée.")
			End if	

	End Choose 

	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	/*------------------------------------------------------------------*/
	/* ZONE 5 :    DTE_DDU_1														  */
	/*------------------------------------------------------------------*/
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_1") )

	Choose Case lVal 
		Case 740
			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de dernière utilisation (DTE_DDU_1) ne doit pas être renseignée.")
			End if	

		Case Else 

			If IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de dernière utilisation (DTE_DDU_1) doit être renseignée.")
			End if	

	End Choose 

	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	dtVal =  Datetime ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_1"))
	dtVal1=  Datetime ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_1"))
	
	sVal = String ( dtVal )
	sVal1 = String ( dtVal1 )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	/*------------------------------------------------------------------*/
	/* ZONE 5 : IMSI_1  (numéro carte SIM)                              */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "IMSI_1" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro de carte SIM (IMSI_1) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Or Len ( sVal ) <> 14 Or Not IsNumber ( sVal ) Then // 14 en France          Len ( sVal ) < 12 Or Len ( sVal ) > 20 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro de carte SIM (IMSI_1) doit être renseigné et être valide (numéro de 14 chiffres en France).")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 6 : MSISDN_1  (numéro du tel) 			 						    */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "MSISDN_1" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro du téléphone (MSISDN_1) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Or Len ( sVal ) <> 10 Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro du téléphone (MSISDN_1) doit être renseigné et être valide (numéro de 10 chiffres).")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 7 :  NOM_CLI_1                                              */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NOM_CLI_1" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 715, 740
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le nom du client (NOM_CLI_1) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le nom du client (NOM_CLI_1) doit être renseigné.")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 8 :  PRENOM_CLI_1                                           */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "PRENOM_CLI_1" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 715, 740
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le prénom du client (PRENOM_CLI_1) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le prénom du client (PRENOM_CLI_1) doit être renseigné.")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 9 :   DTE_1_UTIL_2														  */
	/*------------------------------------------------------------------*/
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_2"))
	lVal  = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de 1ère utilisation (DTE_1_UTIL_2) ne doit pas être renseignée.")
			End if	

		Case Else 

			If IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de 1ère utilisation (DTE_1_UTIL_2) doit être renseignée.")
			End if	

	End Choose 

	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	/*------------------------------------------------------------------*/
	/* ZONE 5 :    DTE_DDU_2														  */
	/*------------------------------------------------------------------*/
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_2"))

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de dernière utilisation (DTE_DDU_2) ne doit pas être renseignée.")
			End if	

		Case Else 

			If IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", la date de dernière utilisation (DTE_DDU_2) doit être renseignée.")
			End if	

	End Choose 

	sVal = String ( dtVal )
	sVal1 = String ( dtVal )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	
	dtVal =  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_2"))
	dtVal1=  DateTime ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_2"))
	
	sVal = String ( dtVal )
	sVal1 = String ( dtVal1 )  		
	iRet = This.Uf_Ctrl_Date ( "CAS3", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	/*------------------------------------------------------------------*/
	/* ZONE 5 : IMSI_2  (numéro carte SIM)                              */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "IMSI_2" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro de carte SIM (IMSI_2) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Or Len ( sVal ) <> 14 Then // 14 en France          Len ( sVal ) < 12 Or Len ( sVal ) > 20 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro de carte SIM (IMSI_2) doit être renseigné et être valide (numéro de 14 chiffres en France).")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 6 : MSISDN_2  (numéro du tel) 			 						    */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "MSISDN_2" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro du téléphone (MSISDN_2) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Or Len ( sVal ) <> 10 Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le numéro du téléphone (MSISDN_2) doit être renseigné et être valide (numéro de 10 chiffres).")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 7 :  NOM_CLI_2                                              */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NOM_CLI_2" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le nom du client (NOM_CLI_2) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le nom du client (NOM_CLI_2) doit être renseigné.")
			End if	

	End Choose 

	/*------------------------------------------------------------------*/
	/* ZONE 8 :  PRENOM_CLI_2                                           */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "PRENOM_CLI_2" ) )

	If IsNull ( sVal ) Then sVal = ""

	Choose Case lVal 
		Case 740, 710, 715, 720, 725
			If sVal <> "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le prénom du client (PRENOM_CLI_2) ne doit pas être renseigné.")
			End if	

		Case Else 

			If sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut GC " + String(lVal)  + ", le prénom du client (PRENOM_CLI_2) doit être renseigné.")
			End if	

	End Choose 


	/*------------------------------------------------------------------*/
	/* ZONE 15 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )

	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
	if dsCode.find("( ID_CODE IN ( 710, 715, 720, 725, 730, 735, 740 ) "+ &
						") AND ID_CODE = " + sVal &
						, 1, dsCode.RowCount()+1 ) = 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
	End If			


	/*------------------------------------------------------------------*/
	/* ZONE 16 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 17 : INFO_FRN_SPB_CPLT												  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier pour l'instant.

	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If


Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_orangegrandpublic (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_OrangeGrandPublic (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 10/09/2019
//* Libellé			: Intégration du fichier du OrangeGrandPublic dans la base
//* Commentaires	: //[DT424]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc
n_cst_string lnvPFCString

//#1
String   sNumBonTrsp
Int		iRetMailPush
Long		lIdSin, lIdseq


iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0


For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" 
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI (DTE_FIN_TRAIT)                             */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_OrangeGrandPublic ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/

	sVal = Trim ( String ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_1" ) ) )
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_1_UTIL_1", sVal, ";")
	End If	
	
	sVal = Trim ( String ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_1" ) ) )
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_DDU_1", sVal, ";")
	End If	

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "IMSI_1" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "IMSI_1", sVal, ";")
	End If
	
	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "MSISDN_1" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MSISDN_1", sVal, ";")
	End If	

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "NOM_CLI_1" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_CLI_1", sVal, ";")
	End If		

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "PRENOM_CLI_1" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRENOM_CLI_1", sVal, ";")
	End If		

	sVal = Trim ( String ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_2" ) ) )
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_1_UTIL_2", sVal, ";")
	End If	
	
	sVal = Trim ( String ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_2" ) ) )
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_DDU_2", sVal, ";")
	End If	

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "IMSI_2" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "IMSI_2", sVal, ";")
	End If
	
	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "MSISDN_2" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MSISDN_2", sVal, ";")
	End If	

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "NOM_CLI_2" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_CLI_2", sVal, ";")
	End If		

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "PRENOM_CLI_2" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRENOM_CLI_2", sVal, ";")
	End If		
	
	
	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	sSql += "'" + sInfoFrnSpbCplt + "'"


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

public subroutine uf_definir_codetat_orangegrandpublic (ref string asval, integer alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_OrangeGrandPublic (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 10/09/2019
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [DT424]]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 
//*-----------------------------------------------------------------

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal

	Case 710, 715, 720, 725, 730, 735, 740

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		


end subroutine

public subroutine uf_definir_codetat_orangeopenpro (ref string asval, integer alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_OrangeOpenPro (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 10/09/2019
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [DT424]]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 
//*-----------------------------------------------------------------

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal

	Case 710, 715, 720, 725, 730, 735, 740

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		


end subroutine

private function integer uf_integration_fichier_orangeopenpro (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_OrangeOpenPro (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 10/09/2019
//* Libellé			: Intégration du fichier de OrangeOpenPro dans la base
//* Commentaires	: //[DT424]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------

Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu
String sChaineMailRempl
Long		lTotLig, lCpt, lVal, lStatusGc
n_cst_string lnvPFCString

//#1
String   sNumBonTrsp
Int		iRetMailPush
Long		lIdSin, lIdseq


iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0


For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" 
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI (DTE_FIN_TRAIT)                             */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_OrangeOpenPro ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/

	sVal = Trim ( String ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_1" ) ) )
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_1_UTIL_1", sVal, ";")
	End If	
	
	sVal = Trim ( String ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_1" ) ) )
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_DDU_1", sVal, ";")
	End If	

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "IMSI_1" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "IMSI_1", sVal, ";")
	End If
	
	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "MSISDN_1" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MSISDN_1", sVal, ";")
	End If	

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "NOM_CLI_1" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_CLI_1", sVal, ";")
	End If		

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "PRENOM_CLI_1" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRENOM_CLI_1", sVal, ";")
	End If		

	sVal = Trim ( String ( idwFicFourn.GetItemDate ( lCpt, "DTE_1_UTIL_2" ) ) )
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_1_UTIL_2", sVal, ";")
	End If	
	
	sVal = Trim ( String ( idwFicFourn.GetItemDate ( lCpt, "DTE_DDU_2" ) ) )
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_DDU_2", sVal, ";")
	End If	

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "IMSI_2" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "IMSI_2", sVal, ";")
	End If
	
	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "MSISDN_2" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MSISDN_2", sVal, ";")
	End If	

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "NOM_CLI_2" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_CLI_2", sVal, ";")
	End If		

	sVal = Trim ( idwFicFourn.GetItemString  ( lCpt, "PRENOM_CLI_2" ) ) 
	If Not IsNull (sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRENOM_CLI_2", sVal, ";")
	End If		
	
	
	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	sSql += "'" + sInfoFrnSpbCplt + "'"


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 

end function

private function integer uf_ctrl_fichier_telstore ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_TELSTORE (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 17/08/2022
//* Libellé			: Controler de la validité du fichier du TELSTORE
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1	JCA	12/12/2007		DCMP 70918
//* #3   JFF   07/12/2009    [MSS_DIAG].[20091207111441740]
//* #4    JFF   28/12/2009  [20091228114718123]
//*   		SBA	25/06/2010 [BUG.CTRLFICSUIVI]
//* 		 JFF     03/05/2011 [PM178][CORIOLIS]
//* 		 JFF     23/11/2012 [VDOC9416]
//       JFF   20/12/2012     [VDOC9337]
//       JFF   28/01/2019 [PM450-1]
//       JFF   20/02/2023 [RS4616_RET_TLS]
//*-----------------------------------------------------------------

n_cst_string lnvPFCString
Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl, sVal2, sInfoFrnSpbCpltLu, sVal3, sIdTypArtSin
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1, dtNull
Long	lIdSin, lIdSeq //#2
datastore	dsCode

Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn


iRet = 1

// Suite demande de Julien Bergère et Rafaële adam le 11/10, la première ligne sera une ligne d'entête, à ne pas integrer donc.
// On supprime donc la première ligne
/* Annulé par Camille le 03/11/22 car au final TLS n'envoie pas de 1ère et donc je supprime chaque 1ère ligne de cmde !! :-(
If idwFicFourn.RowCount () > 0 Then
	idwFicFourn.RowsDiscard ( 1, 1, primary! ) 
End IF 
*/

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""
	
	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	sIdTypArtSin = lnvPFCString.of_getkeyvalue (sChaineBCV, "TYP_APP_DS", ";") 

	Choose Case iStatusGc
		Case 176, 178

			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			// [VDOC17191] je ne déclenche pas le message sur le 159
			If iStatusGc <> lVal Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
			End If

	End CHoose
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 4 : NUM_IMEI_NOU														  */
	/*------------------------------------------------------------------*/
	If sIdTypArtSin = "TEL" Then 
		sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) )
	
		If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Un numéro d'IMEI doit contenir 15 chiffres" )
		End If
	
		If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Numéro d'IMEI non valide" )
		End If 
	End If 
	
	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  
	If IsNull ( sVal )  Then sVal = ""
	
	If sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La date de réception du flux SPB chez TELSTORE est obligatoire" )		
	End IF 

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  
	If IsNull ( sVal )  Then sVal = ""
	
	If sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La date de traitement/envoi par TELSTORE est obligatoire que le statut soit 178 ou 176." )		
	End IF 

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If ( lVal = 0 Or IsNull ( lVal ) ) And sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Lorsque la date de fin de traitement (DTE_FIN_TRAIT) est renseignée, un ETAT_RETOUR est obligatoire.")
	End If 


	/*------------------------------------------------------------------*/
	/* ZONE 7 : DEST_ENVOI	 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DEST_ENVOI" ) ) ) 

	If Not IsNull ( sVal ) Then
		CHOOSE CASE sVal
			CASE "CLIENT", "SPB"
				
			CASE ELSE	
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le Destinataire de l'envoi doit être null ou égal à SPB ou CLIENT, mais pas " + sVal )
		END CHOOSE

	End If


	/*------------------------------------------------------------------*/
	/* ZONE 7 : DTE_RCP_MOB_CLI													  */
	/*------------------------------------------------------------------*/
	/*
	sVal = String ( Date ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) )  
	If IsNull ( sVal )  Then sVal = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCpltLu, "DTE_RCP_MOB_CLI", sVal, ";")
	idwFicFourn.SetItem  ( lCpt, "INFO_FRN_SPB_CPLT", sInfoFrnSpbCpltLu )
	*/

	/*------------------------------------------------------------------*/
	/* ZONE 8 : NUM_BON_TRP 														  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal
		Case 177, 178
			If IsNull ( sVal ) Or Len ( sVal ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La zone NUM_BON_TRP doit être renseignée sur le statut " + String ( lVal ) )
			End If
	End Choose

	// [MODIF_SUITE_REDR]
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "NUM_BON_TRP", Trim ( sVal ) )		

	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [PM426-1]	
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	
	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
	if dsCode.find("( ID_CODE IN (176, 178 ) "+ &
						") AND ID_CODE = " + sVal &
						, 1, dsCode.RowCount()+1 ) = 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Status GC est inconnu !" )
	End If			

	
	// [VDOC9337]
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_ENV_CLI")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal1 < dtVal Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (VDOC9337) : la DTE_ENV_CLI doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If
	// [VDOC9337]	

	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.


	/*------------------------------------------------------------------*/
	/* ZONE   : info_frn_spb_cplt													  */
	/*------------------------------------------------------------------*/


	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then	
		Choose Case sVal
			Case "COLIS_PND", &
				  "COLIS_NRPAC", &
				  "COLIS_PERDU", &
				  "COLIS_BALNI", &
				  "COLIS_INCOR", &
				  "COLIS_REFUS", &
				  "ANNUL_REFAIT", &
				  "EN_ATTENTE", &
				  "AUTRE", &
				  "J1", &
				  "J2", &
				  "J3", &
				  "J4", &
				  "J5", &
				  "J6" 
			
					// Ok
					
			Case Else 

				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
	End IF 	

	// [PM450-1]
	// PRBLE_LIVRAISON 
	sVal = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";"))
	sVal1 = Trim ( lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";"))	

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""		
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur la clé PEC_PRBLE_LIVRAISON, n'est pas valide." )

		End Choose 
		
		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la clé PEC_PRBLE_LIVRAISON n'est autorisée que si précédemment il y a au un clé PRBLE_LIVRAISON, qui est justement absente." )
		End If 			
	End If 	


	// [RS4616_RET_TLS]
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	If lVal = 178 THen
		sVal  = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQ_REMPL", ";"))	
		sVal1 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODL_REMPL", ";"))	
		sVal2 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "COUL_REMPL", ";"))	
		sVal3 = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CAP_STK_REMPL", ";"))	
		
		If sVal = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La marque de remplacement est obligatoire." )
		End If 		

		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le modèle de remplacement est obligatoire." )
		End If 		
		
		If sVal2 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La couleur de remplacement est obligatoire." )
		End If 		
		
		If sVal3 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La capacité de stockage de remplacement est obligatoire." )
		End If 		
	End If 		
	
	
	/*------------------------------------------------------------------*/
	/* FIN ZONE																			  */
	/*------------------------------------------------------------------*/
	
	
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If


Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

private function integer uf_integration_fichier_telstore (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_TELSTORE (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 17/08/2022
//* Libellé			: Intégration du fichier du TELSTORE dans la base
//* Commentaires	: 
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* #1    JCA    09/06/2006  MAILPUSH
//* #2    JFF    23/08/2006  Modif apportée suite problème lenteur
//* #3 	 PHG	  24/04/2008  [DCMP080199] Prise en Compte du Champs "Nom Transporteur"
//* #4	 FPI	  10/12/2009  [SQLNRows] Correction sur le retour SQLNRows incorrect à cause des triggers
//*       JFF    11/03/2011  [ITSM62176] ajout du point de décimal
//  			FPI	04/08/2011	[FPI.04082011] Prise en compte de la date de réception des mobiles par les assurés
//       JFF   18/08/2014 [PM254_V1]
//		FPI	18/07/2018	[ITSM546478]
//       JFF   20/02/2023 [RS4616_RET_TLS]
//       JFF   11/12/2024 [LGY15]
//*-----------------------------------------------------------------
Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu
String sChaineMailRempl, sModlRempl, sCoulRempl, sCapStkRempl
Long		lTotLig, lCpt, lVal, lStatusGc
n_cst_string lnvPFCString

//#1
String   sNumBonTrsp, sDestEnvoi
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteEnvCli

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" 
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_NOU" ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteRcpFrn =  idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteEnvCli = idwFicFourn.GetItemDateTime ( lCpt, "DTE_ENV_CLI" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	//#1
	sNumBonTrsp = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	This.uf_definir_codetat_AGORA_PLACE ( sVal, lCpt, lIdSin, lIdSeq )
	
	sSql += "'" + sVal + "', "
	//#1
	// sDestEnvoi	= Trim ( Upper ( idwFicFourn.GetItemString 	( lCpt, "DEST_ENVOI" ) ) )
	sDestEnvoi	= "CLIENT" // [LGY15] on force car sion le mail de swap ne part pas
	
	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	// [FPI.04082011]
	//sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 10 ) + "'"
	//If IsNull ( sVal ) Then sVal = "null"
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRBLE_LIVRAISON", ";")
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If	
	
	/*
	sVal = Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 10 ) 
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DTE_RCP_MOB_CLI", sVal, ";")
	End If	
	*/

	// [PM450-1]	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PEC_PRBLE_LIVRAISON", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
	End If
	
	
	// [RS4616_RET_TLS]
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MARQ_REMPL", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQ_REMPL", sVal, ";")
	End If
	
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "MODL_REMPL", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODL_REMPL", sVal, ";")
		sModlRempl = sVal
	End If

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "COUL_REMPL", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "COUL_REMPL", sVal, ";")
		sCoulRempl = sVal
	End If

	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CAP_STK_REMPL", ";") 		
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CAP_STK_REMPL", sVal, ";")
		sCapStkRempl = sVal
		If Pos ( sCapStkRempl, "GO" ) <= 0 And Pos ( sCapStkRempl, "GB" ) <= 0 Then sCapStkRempl += "GB"
	End If		
		
	
	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	sSql += "'" + sInfoFrnSpbCplt + "'"

	// [RS4616_RET_TLS]
	sChaineMailRempl = sInfoFrnSpbCplt
	lnvPFCString.of_Setkeyvalue ( sChaineMailRempl, "MODL_REMPL", sModlRempl+ " " + sCoulRempl + " " + sCapStkRempl, ";")		

	
	// #1
	iRetMailPush = This.uf_MailPush ( "ENVTEL_REMP_REPAR", lIdSin, lIdSeq, dtDteRcpFrn, dtDteEnvCli, sDestEnvoi, sNumBonTrsp, lStatusGc, sChaineMailRempl, sCommentFrn )	
	If iRetMailPush <> 0 Then
		iRet = -1
		alNbLigNonTraitee	++ // #2
		F_commit ( SQLCA, False ) // #2		
		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + ", enregistrement non traité : Problème MAILPUSH/ENVTEL_REMP_REPAR, Erreur " + String ( iRetMailPush  ) + ", num_cmde " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) ) // #2 ajout ", ligne " + String ( lcpt ) 
	//	Exit  #2
		Continue // #2
	End If				
	// Fin #1
	
	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private function integer uf_ctrl_fichier_cardif ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_CARDIF (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/06/2023
//* Libellé			: Controler de la validité du fichier du CARDIF
//* Commentaires	: // [PMO89_RS4822]
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//*-----------------------------------------------------------------

n_cst_string lnvPFCString
Int iRet 
String	sIdFour, sVal, sCar, sIMEICorr, sIdFourCtrl, sVal2, sInfoFrnSpbCpltLu, sVal3
Long		lTotLig, lCpt, lCptVal, lLen, lPos, lVal
Boolean	bTrouve
datetime	dtVal, dtVal1, dtNull
Long	lIdSin, lIdSeq //#2
datastore	dsCode

Long dcIdprod
String sIdFourBase, sCodEtat, sIdRefFour, sIdTypArt, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV, sVal1
Int iStatusGc, iInfoSpbFrn


iRet = 1

// Suite demande de Julien Bergère et Rafaële adam le 11/10, la première ligne sera une ligne d'entête, à ne pas integrer donc.
// On supprime donc la première ligne
/* Annulé par Camille le 03/11/22 car au final TLS n'envoie pas de 1ère et donc je supprime chaque 1ère ligne de cmde !! :-(
If idwFicFourn.RowCount () > 0 Then
	idwFicFourn.RowsDiscard ( 1, 1, primary! ) 
End IF 
*/

lTotLig = idwFicFourn.RowCount ()
sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

dsCode = Create datastore
dsCode.Dataobject = 'dddw_spb_code'
dsCode.SetTransObject(SQLCA)

dsCode.retrieve('-GC') 

//For lCpt = 1 To lTotLig // #2
For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) // [PM166][O2M]
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""
	
	/*------------------------------------------------------------------*/
	/* ZONE 1 : NUM_CMD_SPB                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
		// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If

	End If

	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	Choose Case iStatusGc
		Case 810, 820

			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			// [VDOC17191] je ne déclenche pas le message sur le 159
			If iStatusGc <> lVal Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
			End If

	End CHoose
	
	/*------------------------------------------------------------------*/
	/* ZONE 2 : FOURNISSEUR                                             */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	//* [20091228114718123]
	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* ZONE 3 : NUM_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  
	If IsNull ( sVal )  Then sVal = ""
	
	If sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La date de réception du flux SPB chez CARDIF est obligatoire" )		
	End IF 

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_TRT 														  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_TRT" ) )  
	If IsNull ( sVal )  Then sVal = ""
	
	If sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : La date de traitement par CARDIF est obligatoire que le statut soit 810 ou 820." )		
	End IF 

	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If ( lVal = 0 Or IsNull ( lVal ) ) And sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Lorsque la date de fin de traitement (DTE_FIN_TRAIT) est renseignée, un ETAT_RETOUR est obligatoire.")
	End If 


	/*------------------------------------------------------------------*/
	/* ZONE 7 : STATUS_GC														     */
	/*------------------------------------------------------------------*/
	// [PM426-1]	
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	
	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	
	if dsCode.find("( ID_CODE IN (810, 820 ) "+ &
						") AND ID_CODE = " + sVal &
						, 1, dsCode.RowCount()+1 ) = 0 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut retour est inconnu !" )
	End If			


	// [CTRLE_DATE_INTRG_FOU]
	sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_TRT" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS2", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )

	/*------------------------------------------------------------------*/
	/* ZONE 10 : COMMENT_FRN														  */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.


	/*------------------------------------------------------------------*/
	/* ZONE   : info_frn_spb_cplt													  */
	/*------------------------------------------------------------------*/

	/*------------------------------------------------------------------*/
	/* FIN ZONE																			  */
	/*------------------------------------------------------------------*/
	
	
	If iRet > 0 Then

		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If


Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")

Return iRet


end function

public subroutine uf_definir_codetat_cardif (ref string asval, integer alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_definir_codetat_cardif (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/06/2023
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [PMO89_RS4822]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//* 
//*-----------------------------------------------------------------

Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString

sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal

	Case 810, 820

		asVal = "RFO"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		


end subroutine

private function integer uf_integration_fichier_cardif (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_CARDIF (PRIVATE)
//* Auteur			: Fabry JF
//* Date				: 07/06/2023
//* Libellé			: Intégration du fichier du CARDIF dans la base
//* Commentaires	: [PMO89_RS4822]
//*
//* Arguments		: Long		alNbLig		Ref
//*					  Long		alNbLigMod	Ref
//*					  Long		alNbLigNonTraitee	Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//*-----------------------------------------------------------------
Int iRet 
String	sSql, sVal, sSqlOrig
String sCommentFrn, sInfoFrnSpbCplt, sInfoFrnSpbCpltLu
String sChaineMailRempl, sModlRempl, sCoulRempl, sCapStkRempl
Long		lTotLig, lCpt, lVal, lStatusGc
n_cst_string lnvPFCString
//#1
Int		iRetMailPush
Long		lIdSin, lIdseq
DateTime	dtDteRcpFrn, dtDteTrt

iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

For lCpt = 1 To lTotLig 

	sInfoFrnSpbCplt = "" 
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	// [ITSM62176] ajout du point de décimal
	sSql += Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) + "., "
	// #1
	lIdSin = Long (Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ))

	/*------------------------------------------------------------------*/
	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	sSql += Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) + ", "
	// #1
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) )

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteRcpFrn =  idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )
	
	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_TRT" ) ) ), 10 ) + "'"
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	// #1
	dtDteTrt = idwFicFourn.GetItemDateTime ( lCpt, "DTE_TRT" )

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	This.uf_definir_codetat_CARDIF ( sVal, lCpt, lIdSin, lIdSeq )
	
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )

	If IsNull ( sVal ) Then sVal = ""
	sVal = Trim ( sVal ) 
	
	Choose Case lVal
		Case 810 
			sVal += ". Interlocuteur accepté (OK) par l'assureur."
		Case 820
			sVal += ". Interlocuteur rejeté (KO) par l'assureur."			
	End Choose 
	
	sCommentFrn = sVal	
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If IsNull ( sVal ) Or sVal = "" Or sVal = "''" Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	// [PM426-1]
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )
	
	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'" 
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/

	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	// [FPI.04082011]
	//sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_MOB_CLI" ) ) ), 10 ) + "'"
	//If IsNull ( sVal ) Then sVal = "null"
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	#x02Mx [O2M]								  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", " // #3 [DCMP080199]

	/*---------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#5 [DCMP080199] [MICROMANIA] */
	/*---------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/*------------------------------------------------------------------*/
	sInfoFrnSpbCplt = ""

	
	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	sSql += "'" + sInfoFrnSpbCplt + "'"


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then
//			alNbLigMod += SQLCA.SqlnRows
			alNbLigMod ++
			F_commit ( SQLCA, True ) // #2
		Else 
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else
		iRet = -1
		alNbLigNonTraitee	++
		// [MODIF_SUITE_REDR]

		sVal = SQLCA.SQLErrText

		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")				

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + + sVal )

		F_commit ( SQLCA, False )
			
		Continue
	End If
Next

If alNbLigNonTraitee	> 0 Then iRet = -1 // #2

Return iRet 
end function

private function integer uf_ctrl_fichier_frn_hub ();//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Ctrl_Fichier_frn_Hub (PRIVATE)
//* Auteur			: JFF
//* Date				: 30/04/2024
//* Libellé			: [HP252_276_HUB_PRESTA]
//* Commentaires	: 
//*
//* Arguments		: 
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*       JFF	16/01/2025	[HUB832_HUB_ORG_REUN]
//        JFF  23/04/2025  [HUB1267]
//			 JFF  12/05/2025  [20250512134745313] On reprend le bon de trans de la presta en base.
//    	 JFF  30/07/2025  [20250730153200137]
//    	 JFF  30/07/2025  [HUB1896]
//*-----------------------------------------------------------------

Int iRet, iStatusGc, iInfoSpbFrn
String	sIdFour, sVal, sIdFourCtrl, sInfoFrnSpbCpltLu, sIMEICorr, sNumCmdSpb 
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sVal1, sVal2, sVal3
String 	sInfoFrnSpbCplt, sIdTypArtSin
Long		lTotLig, lCpt, lPos, lVal, dcIdProd, lIdSin, lIdSeq, lRow
String 	sInfoSpbFrnCplt, sChaineBCV
datetime	dtVal, dtVal1, dtDteRcpFrn
n_cst_string lnvPFCString  
String sIdDepotHub, sIdHubPresta
Boolean bRet 
String sSqlHub
Long lErrorHubPresta, lIndentityHubPresta, lRowCountHubPresta
Boolean  bF_CLE_A_TRUE_HUB1267

// [HUB1267]
bF_CLE_A_TRUE_HUB1267 = F_CLE_A_TRUE ( "HUB1267" )

iRet = 1
lTotLig = idwFicFourn.RowCount ()

// [MODIF_SUITE_REDR]
If lTotLig <= 0 And FileLength64 ( isTxtNomFic.Text ) > 0 Then
	iRet = -1
	This.uf_Trace ( "ECR", "ERREUR : 0 Ligne chargée ! , pour PI : Taille du fichier positive et chargement à 0 ligne => Anormal. Réessayez l'intégration (cause éventuelle => le fichier est peut-être en format Unicode au lieu d'Ansi, à vérifier)." )
End If		

// connexion au Hub Prestataire

bRet = This.uf_Hub_GestionTransSqlHubPresta ( "CONNEXION_HUB" )

If Not bRet Then
	
	iRet = -1

	sVal = itrHubPrestataire.SQLErrText		
	sVal = f_remplace(sVal,Char(9)," ")
	sVal = f_remplace(sVal,Char(10)," ")		
	sVal = f_remplace(sVal,Char(11)," ")				
	sVal = f_remplace(sVal,Char(13)," ")	

	This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème de connexion (Ctrl) au Hub Prestataire, msg SqlServer => : " + sVal )
	
	Return iRet
			
End If 


sIdFour = Upper ( idwFourn.GetItemString ( 1, "ID_FOURN" ) )

For lCpt = lTotLig To 1 Step -1

	sCodEtat = fill(" ",3)
	sIdRefFour = fill(" ",20)
	sIdFourBase = fill(" ",3)
	sIdTypArt = fill(" ", 3) 
	sInfoSpbFrnCplt = fill(" ", 800)
	sInfoFrnSpbCplt = fill(" ", 800)
	sChaineBCV = fill(" ", 255)

	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	If IsNull( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = "" 

	sIdDepotHub = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "id_depot_hub" ) ) )
	sIdHubPresta = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "id_hub_presta" ) ) )
	
	/*------------------------------------------------------------------*/
	/* NUM_CMD_SPB                                             			  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )
	sNumCmdSpb = sVal

	// Le n° de Cmde peut être nulle, en effet système de gestion de commandes
	// n'était peut-être pas encore en production au moment de cette cmde par les 
	// gestionnaires.
	If Not IsNull ( sVal ) And sVal <> "" Then
	// Le n° de commande doit êtr du type ID_SIN + "-" + ID_SEQ soit 487497-2
		lPos = Pos ( sVal, "-", 1 )
		If lPos <= 0 Then 
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : Le n° de commande SPB ne contient pas de '-'." )
		Else
			lIdSin = Long ( Left ( sVal, lPos - 1 ) ) // #2
			lIdSeq = Long ( Right ( sVal, Len ( sVal ) - lPos ) ) // #2

			If Not IsNumber ( Left ( sVal, lPos - 1 ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : Le n° de commande SPB est erroné sur la partie Ref.Sin." )

			ElseIf Not IsNumber ( Right ( sVal, Len ( sVal ) - lPos ) ) Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : Le n° de commande SPB est erroné sur la partie Id.Cmde." )
			End If
		End If
	End If
	
   sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DDE_SAV", ";") 
	If sVal = "OUI" Then
		sChaineBCV = Trim ( sChaineBCV )
		lnvPFCString.of_Setkeyvalue ( sChaineBCV, "DDE_SAV", sVal, ";")
		sChaineBCV = Left ( sChaineBCV + Space ( 255 ), 255 )
	End If 
	
	// [PM82][LOT1]
	SQLCA.PS_S11_COMMANDE_V07 ( lidsin, lidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdprod, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

	/*------------------------------------------------------------------*/
	/* Stockage de certaines données                                    */
	/*------------------------------------------------------------------*/	
	// TYP_APP_DS
	sIdTypArtSin = lnvPFCString.of_getkeyvalue (sChaineBCV, "TYP_APP_DS", ";") 
	
	// DTE_RCP_FRN
	dtVal = idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")			
	If IsNull ( dtVal ) Then 
		sVal2 = lnvPFCString.of_getkeyvalue (sChaineBCV, "DTE_RCP_FRN", ";")
		IF Not IsNull ( sVal2 ) And sVal2 <> "" Then
			dtVal = Datetime ( sVal2 )
		End If 
	End IF 

	If IsNull ( dtVal ) Then 
		lRow = idwFicFourn.Find ( "NUM_CMD_SPB = '" + sNumCmdSpb + "' AND STATUS_GC = 159", 1, idwFicFourn.RowCount())
		If lRow > 0 Then
			dtVal =  idwFicFourn.GetItemDatetime( lRow, "DTE_RCP_FRN")
		End If 
	End IF 
	SetNull ( dtDteRcpFrn )
	If Not IsNull ( dtVal ) Then dtDteRcpFrn = dtVal

	/*------------------------------------------------------------------*/
	/* Contrôle systeme HUB															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "SYSTEME" ) ) )
	sVal1= Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If sVal = "HUB" and Not ibPrestaHub Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : Ce fournisseur (" + sVal1 + ") n'est pas déclaré comme étant lié au Hub Prestataire (FamilleCar 1)." )	// [HUB832_HUB_ORG_REUN] 	
	End If 
	
	If sVal <> "HUB" and ibPrestaHub Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : Ce fichier ne provient du Hub Prestataire or le fournisseur (" + sVal1 + ") est déclaré comme étant lié au Hub Prestataire." )		
	End If 
	
	/*------------------------------------------------------------------*/
	/* FOURNISSEUR                                                      */
	/*------------------------------------------------------------------*/
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) ) )

	If IsNull ( sVal ) Or sVal = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : La zone fournisseur est vide." )
	End If 

	If sVal <> sIdFour Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : Le fournisseur " + sVal + " ne correspond pas au fournisseur sélectionné " + sIdFour )
	End If 

	If Len ( sVal ) > 3 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : La longueur du fournisseur doit être sur 3 caractères." )
	End If

	sIdFourCtrl = sVal
	
	/*------------------------------------------------------------------*/
	/* NUM_CMD_FRN															           */
	/*------------------------------------------------------------------*/
	// Pas de contrôle particulier.

	
	/*------------------------------------------------------------------*/
	/* STATUS_GC														              */
	/*------------------------------------------------------------------*/
	// Vérification de l'appartenance au paramétrage du code retourné .
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )

/*
	sVal1 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu , "AUTO_PEC_RAR", ";")	
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_APP_CLI")

	If ( IsNull ( sVal ) Or Trim ( sVal ) = "" ) And iStatusGc > 0 Then sVal = String ( iStatusGc )
	If IsNull ( sVal ) Or Trim ( sVal ) = ""  Then sVal = "0"
	
	// Cas spécial à gérer où il n'y a pas de statut retourné mais il peux y avoir un date de fin de trait repris d'un précédent eng sur le hub
	If sVal = "0" Then
		Choose Case TRUE
			Case sVal1 = "OUI" 
				idwFicFourn.SetItem ( lCpt, "DTE_FIN_TRAIT", stNul.dtm )
			Case Not IsNull ( dtVal )
				idwFicFourn.SetItem ( lCpt, "DTE_FIN_TRAIT", stNul.dtm )				
		End Choose
	End If 
*/
	
	Choose Case Upper ( sIdTypArt ) 
		Case "EDI", "PRS"
			Choose Case Long ( sVal ) 
				Case 177, 178
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le Statut " + sVal + " n'est autorisé que pour les commandes de remplacement." )
			End Choose
		Case Else
			Choose Case Long ( sVal ) 
				Case 177, 178, 176
					// C'est Ok
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Statut " + sVal + " non autorisé pour une commande de remplacement." )

			End Choose
			
	End Choose

	Choose Case iInfoSpbFrn
		Case 1503, 1504, 435, 1502, 1506
			Choose Case Long ( sVal ) 
				Case 166
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Statut " + sVal + " n'est pas autorisé en retour" )
			End Choose
			
		Case 1505
			Choose Case Long ( sVal ) 
				Case 167, 168
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Statut " + sVal + " n'est pas autorisé en retour" )
			End Choose
		// [VDoc4752]
		Case 970
			Choose Case Long ( sVal )
					// [VDoc6082] ajout du statut_gc 164
				Case 165,164
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Statut " + sVal + " n'est pas autorisé en retour" )
			End Choose
			// :[VDoc4752]
			
		// [VDOC6300] // [PC877]
		Case 964, 969
			Choose Case Long ( sVal )
				Case 179
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un code process " + String ( iInfoSpbFrn ) + " envoyé sur la prestation d'origine, le Statut " + sVal + " n'est pas autorisé en retour" )
			End Choose			
			
	End Choose

	Choose Case Long ( sVal ) 
		Case 166
			// [VDOC5774] 435, 1502
			Choose Case iInfoSpbFrn
				Case 1503, 1504, 435, 1502, 1506
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		Case 167, 168
			Choose Case iInfoSpbFrn
				Case 1505
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
			
		Case 179
			Choose Case iInfoSpbFrn
				Case 964, 969
					// Autorisé
				Case Else
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est pas autorisé sur le process " + String ( iInfoSpbFrn ) )
			End Choose
	End Choose			

/* Je Shunte, on demande le code verrou même pour des Diag.
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	Choose Case lVal 
		Case 232
			If Upper ( sIdTypArt ) <> "PRS" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If

	End Choose

	Choose Case sIdTypArt  
		Case "PRS"
			// OK
		Case Else
			If lVal = 232 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut " + sVal + " n'est autorisé que sur une action de REPARATION." )
			End If
	End Choose
*/

	/*------------------------------------------------------------------*/
	/* TYP_BA_ALLER													              */
	/*------------------------------------------------------------------*/
	// [PM445-1]
	If lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") <> "OUI" Then
		sVal = idwFicFourn.GetItemString ( lCpt, "TYP_BA_ALLER" )
		If IsNull ( sVal ) Then sVal = ""

		sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
		If IsNull ( sVal1 ) Then sVal1 = ""		

		dtVal = dtDteRcpFrn
		
		If IsNull ( dtVal ) And sVal1 <> "" And sVal = "" And sIdRefFour <> "REFUSE_A_REEXP" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Un numéro de tracking ALLER doit être accompagné du champ TYP_BA_ALLER renseigné." )
		End IF
		
		/*
		If sVal <> "" Then
			Choose Case sVal
				Case "BPPAYE", &
					  "RPICKUP"
				
						// Ok
						
				Case Else 
	
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur le champ TYP_BA_ALLER, n'est pas valide." )
	
			End Choose 
		End If 
		*/

	/*------------------------------------------------------------------*/
	/* PERTE_ALLER														              */
	/*------------------------------------------------------------------*/
		
		// [PM445-1]
		sVal = idwFicFourn.GetItemString ( lCpt, "PERTE_ALLER" )
		If IsNull ( sVal ) Then sVal = ""

		IF sVal = "OUI" Then

			sVal1 = idwFicFourn.GetItemString ( lCpt, "PRBLE_LIVRAISON" )
			If IsNull ( sVal1 ) Then sVal1 = ""
	
			sVal2 = idwFicFourn.GetItemString ( lCpt, "TYP_BA_ALLER" )
			If IsNull ( sVal2 ) Then sVal2 = ""
	
			sVal3 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) )
			If IsNull ( sVal3 ) Then sVal3 = ""	
			// [20250512134745313]
			If sVal3 = "" Then sVal3 = lnvPFCString.of_getkeyvalue (sChaineBCV, "ID_BON_TRANSP", ";") 
			If IsNull ( sVal3 ) Then sVal3 = ""	
			// /[20250512134745313]
	
			// dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
			dtVal =  dtDteRcpFrn
	
			lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
			If IsNull ( lVal ) Then lVal = 0				
			
			If sVal2 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le type de BA aller n'est compatible avec une perte aller." )
			End If 
			
			If sVal1 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le champ PRBLE_LIVRAISON doit être renseigné." )
			End If 
			
			If sVal3 = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le numéro de tracking (NUM_BON_TRP) doit être renseigné." )
			End If 

			If Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, la date de réception ne doit pas être renseigné." )
			End If 
			
			sVal = idwFicFourn.GetItemString ( lCpt, "APP_SWAP" )		
			If lVal <> 0 AND ( lVal <> 21 AND sVal <> "OUI" ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" (PM445-1) : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur une perte aller, le statut ne doit pas être renseigné." )
			End If 
		End IF 
	End If	

	/*------------------------------------------------------------------*/
	/* DIAG_VIDEO_ENGAGE														        */
	/*------------------------------------------------------------------*/
	// [PMO139_RS4926]
	sVal = idwFicFourn.GetItemString ( lCpt, "DIAG_VIDEO_ENGAGE" )

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur le champ DIAG_VIDEO_ENGAGE, n'est pas valide. les valeurs autorisées sont OUI ou NON." )

		End Choose 
	End If 	


	/*------------------------------------------------------------------*/
	/* RESOLU_DIAG_VIDEO														        */
	/*------------------------------------------------------------------*/
	sVal = idwFicFourn.GetItemString ( lCpt, "resolu_diag_video" )

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur le champ RESOLU_DIAG_VIDEO, n'est pas valide. les valeurs autorisées sont OUI ou NON." )

		End Choose 
	End If 	

	sVal = idwFicFourn.GetItemString ( lCpt, "resolu_diag_video" )
	sVal1 = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1) Then sVal1 = ""	
	
	If sVal = "OUI" And sVal1 = "2" THen
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " (Oui) contenue sur le champ RESOLU_DIAG_VIDEO, n'est cohérente avec le statut (2) <<Réparé>> de la prestation." )
	End IF 


	/*------------------------------------------------------------------*/
	/* dte_rdv_conf   														        */
	/*------------------------------------------------------------------*/
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "dte_rdv_conf")			
	sVal = idwFicFourn.GetItemString ( lCpt, "SITE_ACTION" )
	sVal1 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCplt , "SITE_ACTION", ";")

	If Not IsNull ( dtVal ) Then
		Choose Case sVal 
			Case "DISTANCE", "DOMICILE"
					// Ok
					
			Case Else 
				
				Choose Case sVal1 
					Case "DISTANCE", "DOMICILE"
							// Ok

					Case Else 
				
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il n'est pas logique d'avoir une date de confirmation de rdv en dehors des site action DISTANCE et DOMICILE." )
			End Choose 				
		End Choose 
	End If 	


	/*------------------------------------------------------------------*/
	/* mode_logis_ret																	  */
   /* point_service_ret																  */
	/*------------------------------------------------------------------*/
	sVal  = idwFicFourn.GetItemString ( lCpt, "mode_logis_ret" )
	sVal1 = idwFicFourn.GetItemString ( lCpt, "point_service_ret" )

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""

	If sVal <> "" Then
		Choose Case sVal
			Case "PROXIMITY", &
				  "CENTRALIZATION", &
				  "AT_HOME", &
				  "REMOTELY", &
				  "PROXI_CENTRALIZATION"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur le champ MODE_LOGIS_RET, n'est pas valide. les valeurs autorisées sont PROXIMITE (PROXIMITY) ou CENTRALISATION (CENTRALIZATION)." )

		End Choose 
	End If 

	If sVal1 <> "" And iRet > 0 And sVal = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") si un point de service de retour est fourni (" + sVal1 + "), alors un mode logistique de retour doit aussi être fourni." )
	End If 

	If sVal <> "" And iRet > 0 And sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") si un mode logistique de retour est fourni (" + sVal + "), alors un point de service de retour doit aussi être fourni." )
	End If 


	/*------------------------------------------------------------------*/
	/* DTE_RCP_FRN										                          */
	/*------------------------------------------------------------------*/
	//dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal = dtDteRcpFrn
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	Choose Case lVal
		Case 155, 156, 157, 158, 160, 161, 163, 164, 165, 174, 177, 178
			If Not isNull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End if

		Case 151, 152, 153, 154, 159, 162, 166, 167, 168, 169, 2, 21, 175, 232
			sVal = idwFicFourn.GetItemString ( lCpt, "PERTE_ALLER" )
			
			If isNull(dtVal) And iInfoSpbFrn <> 957 And sVal <> "O" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut " + String(lVal)  + ", la date de réception fournisseur (DTE_RCP_FRN) doit être renseigné.")
			End if
			
			If Not isNull(dtVal) And iInfoSpbFrn = 957 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut " + String(lVal)  + ", et pour le process spécifique 957, la date de réception fournisseur (DTE_RCP_FRN) doit être vide.")
			End If			

	End Choose

	If Not IsNull ( dtVal ) And Date ( dtVal ) <> 1900-01-01 Then
		If Year ( Date (dtVal )) < 2020 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") l'année de la date de réception n'est pas valide." )
		End If
	End If

	If lVal = 159 And IsNull ( dtVal ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le statut (159) de la récéption du matériel doit absolument s'accompagner de la date de réception du matériel (DTE_RCP_FRN)." )
	End If 


	/*------------------------------------------------------------------*/
	/* SITE_ACTION										                          */
	/*------------------------------------------------------------------*/
	sVal = idwFicFourn.GetItemString ( lCpt, "SITE_ACTION" )

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "STATION", &
				  "DOMICILE", &
				  "DISTANCE" 
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur le champ SITE_ACTION, n'est pas valide. les valeurs autorisées sont STATION ou DOMICILE." )

		End Choose 
	End If 	

	/*------------------------------------------------------------------*/
	/* APP_INCOMPLET									                          */
	/*------------------------------------------------------------------*/
	sVal = idwFicFourn.GetItemString ( lCpt, "APP_INCOMPLET" )

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur le champ APP_INCOMPLET, n'est pas valide. les valeurs autorisées sont OUI ou NON." )

		End Choose 
	End If 	
	
	
	/*------------------------------------------------------------------*/
	/* NUM_IMEI_REMPL																	  */
	/*------------------------------------------------------------------*/
	If sIdTypArtSin = "TEL" Then 
		sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_REMPL" ) )
		If IsNull ( sVal ) Then sVal = ""
	
		If Len ( sVal ) <> 15 And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Un numéro d'IMEI doit contenir 15 chiffres (" + sVal + ")" )
		End If
	
		If Not F_IMEI ( sVal, sIMEICorr ) And Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Numéro d'IMEI non valide (" + sVal + ")" )
		End If 
	End If

	/*------------------------------------------------------------------*/
	/* NUM_SERIE_REMPL																  */
	/*------------------------------------------------------------------*/
	If sIdTypArtSin = "TEL" Then 
		sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_SERIE_REMPL" ) )
		If IsNull ( sVal ) Then sVal = ""

		If Len ( sVal ) > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour un appareil de type TEL, le numéro de série ne doit pas être renseigné  (" + sVal + "), seul l'IMEI doit être renseigné sur le champ NUM_IMEI_REMPL." )
		End If
		

	End If 


	/*------------------------------------------------------------------*/
	/* DTE_FIN_TRAIT									  								  */
	/*------------------------------------------------------------------*/
	dtVal  =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")
	// dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal1 = dtDteRcpFrn
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 

	Choose Case lVal
		Case 151, 152, 153, 154, 155, 160, 161, 165, 166, 167, 168, 2, 21, 167, 168, 177, 178, 175

			If ( lVal = 153 Or lVal = 154 )  Then // And sIdTypArt = "PRS"
				If Not Isnull (dtVal) Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut " + String(lVal)  + " en réparation, la date de fin de traitement (DTE_FIN_TRAIT) ne doit pas être renseigné.")
				End If

			Elseif Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être renseigné.")
			End if

		Case 156, 157, 158, 159, 162, 163, 164, 169, 232, 174
			if Not Isnull(dtVal) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour le statut " + String(lVal)  + ", la date de fin de traitement (DTE_FIN_TRAIT) doit être vide.")
			End if
			
		Case Else
			If ( lVal = 0 Or IsNull ( lVal ) ) And Not IsNull ( dtVal ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Lorsque la date de fin de traitement (DTE_FIN_TRAIT) est renseigné, un statut est obligatoire.")
			End If 
			
	End Choose

	If Not IsNull ( dtVal ) and  Date ( dtVal ) <> 1900-01-01 Then
		If Year ( Date (dtVal )) < 2020 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") l'année de la date DTE_FIN_TRAIT n'est pas valide." )
		End If
	End If

	// dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_FRN")
	dtVal = dtDteRcpFrn
	dtVal1 =  idwFicFourn.GetItemDatetime( lCpt, "DTE_FIN_TRAIT")	
	If Not IsNull ( dtVal ) And Not IsNull ( dtVal1 ) And dtVal > dtVal1 Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la DTE_FIN_TRAIT doit être postérieure ou égale à la DTE_RCP_FRN." )
	End If



	/*------------------------------------------------------------------*/
	/* COMMENT_FRN														     			  */
	/*------------------------------------------------------------------*/
	// Pas de Controle Particulier
	// [MODIF_SUITE_REDR]
	sVal = idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" )  
	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "COMMENT_FRN", Trim ( sVal ) )

	/*------------------------------------------------------------------*/
	/* NUM_BON_TRP 														  			  */
	/*------------------------------------------------------------------*/
	sVal = Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) )
	sVal1 = idwFicFourn.GetItemString ( lCpt, "mode_logis_ret" )
	lVal =  idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) 
	
	If IsNull ( sVal ) Then sVal = ""	
	If IsNull ( sVal1 ) Then sVal1 = ""		

	Choose Case lVal

		// [HUB1896] plus à ce moment
		/*
		Case 177, 178
			If IsNull ( sVal ) Or Len ( sVal ) <= 0 And sVal1 <> "PROXIMITE" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le champ NUM_BON_TRP doit être renseigné sur le statut " + String ( lVal ) )
			End If
		*/
		
		Case 165
			If iInfoSpbFrn = 970 and (IsNull ( sVal ) Or Len ( sVal ) <= 0 ) Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") La champ NUM_BON_TRP doit être renseigné sur le statut " + String ( lVal ) +  " pour le process 970.")
			End If
	End Choose

	sVal = f_remplace(sVal,"'"," ")
	sVal = f_remplace(sVal,'"'," ")
	sVal = f_remplace(sVal,Char(9),"")
	sVal = f_remplace(sVal,Char(10),"")		
	sVal = f_remplace(sVal,Char(11),"")				
	sVal = f_remplace(sVal,Char(13),"")				
	idwFicFourn.SetItem ( lCpt, "NUM_BON_TRP", Trim ( sVal ) )

	
	/*------------------------------------------------------------------*/
	/* NOM_TRANSPORTEUR													  			  */
	/*------------------------------------------------------------------*/
	sVal = Upper ( idwFicFourn.GetItemString ( lCpt, "NOM_TRANSPORTEUR" ) )
	sVal1 = Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) )
	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""
	
	If sVal = "" And sVal1 <> "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le NOM_TRANSPORTEUR doit être renseigné si un NUM_BON_TRP est renseigné.")
	End If 

	If sVal <> "" And sVal1 = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le NUM_BON_TRP doit être renseigné si un NOM_TRANSPORTEUR est renseigné.")
	End If 

	/*------------------------------------------------------------------*/
	/* DTE_RCP_APP_CLI                                                  */
	/*------------------------------------------------------------------*/
	dtVal =  idwFicFourn.GetItemDatetime( lCpt, "DTE_RCP_APP_CLI")
	lVal =  iStatusGc
	
	If Date ( dtVal ) = 1900-01-01 Then SetNull ( dtVal ) 
	If Date ( dtVal1 ) = 1900-01-01 Then SetNull ( dtVal1 ) 

	If Not IsNull ( dtVal ) Then 

		Choose Case lVal 
			// [20250730153200137], 153, 154, 169, 305
			Case 178, 233, 263, 234, 2, 21, 152, 153, 154, 169, 305
				// Ok
			Case Else
				lRow = idwFicFourn.Find ( "NUM_CMD_SPB = '" + sNumCmdSpb + "' AND STATUS_GC IN ( 178, 233, 263, 234, 2, 21, 152, 153, 154, 169, 305 )", 1, idwFicFourn.RowCount())
				If lRow > 0 Then
					lVal =  idwFicFourn.GetItemNumber ( lRow, "STATUS_GC")
				End If 
		End Choose	
		
		Choose Case lVal 
			// [20250730153200137], 153, 154, 169, 305				
			Case 178, 233, 263, 234, 2, 21, 152, 153, 154, 169, 305
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Le champ DTE_RCP_APP_CLI ne peut être renseigné sans le statut 178, 233, 263, 234, 2, 21, 152, 153, 154, 169, 305" )
		End Choose
	End If

	/*------------------------------------------------------------------*/
	/* APP_SWAP																			  */
	/* MARQUE_REMPL																	  */
	/* MODELE_REMPL																	  */
	/* NUM_IMEI_REMPL																	  */
 	/* NUM_SERIE_REMPL																  */
	/*	COULEUR_REMPL																	  */
	/*	CAP_STK_REMPL																	  */
	/* NEUF_REC_REMPL																	  */
	/* PRIX_TTC_REMPL         														  */
	/*------------------------------------------------------------------*/
	sVal = idwFicFourn.GetItemString ( lCpt, "APP_SWAP" )
	sVal1 = 	lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") 

	If sVal = "OUI" Then
		
		lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
		sVal = idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) 	

		// [VDOC27123]BVID/BVIP/BVIT
		If ( &
				( lVal = 21 ) And Not ( Pos (sVal,  "[BVIE]" ) > 0 Or Pos (sVal,  "[BVID]" ) > 0 Or Pos (sVal,  "[BVIP]" ) > 0 Or Pos (sVal,  "[BVIT]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &
				Or &
				( lVal = 23 ) And Not ( Pos (sVal,  "[BVIEOX]" ) > 0 Or Pos (sVal,  "[PIE]" ) > 0 ) &					
				Or &
				( lVal <> 21 And lVal <> 23 ) &
			) Or sVal1 = "OUI" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") : Le SWAP n'est autorisé que sur un irréparable 21/23 avec un mot clé [BVIE]/[BVID]/[BVIP]/[BVIT]/[BVIEOX] ou [PIE]." )
		End If 				
		
	End If 

	If iRet > 0 Then
		sVal1 = 	lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") 
		sVal = idwFicFourn.GetItemString ( lCpt, "APP_SWAP" )	

		sVal2 = Trim ( idwFicFourn.GetItemString ( lCpt, "MARQUE_REMPL" )) + &
				  Trim ( idwFicFourn.GetItemString ( lCpt, "MODELE_REMPL" )) + &		
				  Trim ( idwFicFourn.GetItemString ( lCpt, "COULEUR_REMPL" )) + &		
				  Trim ( idwFicFourn.GetItemString ( lCpt, "CAP_STK_REMPL" )) + &		
				  Trim ( idwFicFourn.GetItemString ( lCpt, "NEUF_REC_REMPL" )) + &
				  String ( idwFicFourn.GetItemDecimal ( lCpt, "PRIX_TTC_REMPL" ) )
		
		If IsNull ( sVal2 ) Then sVal2 = ""
		If IsNull ( sVal ) Then sVal = ""
		If IsNull ( sVal1 ) Then sVal1 = ""
		
		If Len ( sVal2 ) > 0 And sVal1 <> "OUI" And sVal <> "OUI" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") : Les champ MARQUE_REMPL, MODELE_REMPL, COULEUR_REMPL, CAP_STK_REMPL, NEUF_REC_REMPL, PRIX_TTC_REMPL, ne sont autorisés que sur un SWAP suite app irréparable OU une Commande de Remplacement." )
		End If 	
		
	End If 


	sVal1 = 	lnvPFCString.of_getkeyvalue (sChaineBCV, "CMDE_REMPL", ";") 
	sVal = idwFicFourn.GetItemString ( lCpt, "APP_SWAP" )	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	
	If iRet > 0 And ( sVal1 = "OUI" Or sVal = "OUI" ) And lVal <> 176 Then
			
		sVal = idwFicFourn.GetItemString ( lCpt, "MARQUE_REMPL" )
		If IsNull ( sVal ) Then sVal = ""		
		If Trim ( sVal ) = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement le champ MARQUE_REMPL doit être renseigné avec la marque du nouveau matériel." )
		End If 	
		
		sVal = idwFicFourn.GetItemString ( lCpt, "MODELE_REMPL" )
		If IsNull ( sVal ) Then sVal = ""				
		If Trim ( sVal ) = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement le champ MODELE_REMPL doit être renseigné avec la marque du nouveau matériel." )
		End If 	

		/*
		If iRet > 0 Then
			Choose Case sIdTypArtSin
				Case "TEL", "TPC"
					// Autorisé
				Case Else 
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne " + String ( lCpt ) + &
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") (DT276) : Type d'appareil (" + sIdTypArt+ ") non autorisé pour un SWAP O2M." )
			End Choose
		End If 
		*/

		// Controle binome marq/modl appartient à IFR ou pas 
		/*
		sVal = idwFicFourn.GetItemString ( lCpt, "REF_APP_REMPL" )
		If IsNull ( sVal ) Then sVal = ""			
	
		If sVal = "IFR" Then
			sVal  = idwFicFourn.GetItemString ( lCpt, "MARQUE_REMPL" )
			sVal1 = idwFicFourn.GetItemString ( lCpt, "MODELE_REMPL" )
			If SQLCA.PS_S_VERIF_MARQ_MODL_IFR_V01 ( dcIdprod, sIdTypArtSin, sVal, sVal1 ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement, si le champ REF_APP_REMPL indique le référentiel de contrôle IFR, alors la Marque et le Modèle du nouveau matériel (" + sVal + " " + sVal1 + ") doivent appartenir au référentiel IFR, ce qui n'est pas le cas." )
			End If
		End If

		If sVal = "IFR" and sVal1 <> "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement, si le champ REF_APP_REMPL indique le référentiel de contrôle IFR, alors le champ AUTRES_INFOS_REMPL doit être null." )
		End If 
		*/


		Choose Case sIdTypArtSin
			Case "TEL"
				sVal = idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_REMPL" )  // Le ctrle de validité est faite plus haut
				If Trim ( sVal ) = "" Or IsNull ( sVal )  Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement le champ NUM_IMEI_REMPL doit être renseigné par l'IMEI du nouveau matériel." )
				End If 					
			Case Else 
				sVal = idwFicFourn.GetItemString ( lCpt, "NUM_SERIE_REMPL" )  
				If Trim ( sVal ) = "" Or IsNull ( sVal )  Then
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement le champ NUM_SERIE_REMPL (Hors TEL) doit être renseigné par le numéro de série du nouveau matériel." )
				End If 					
		End Choose

		sVal = idwFicFourn.GetItemString ( lCpt, "AUTRES_INFOS_REMPL" )
		If IsNull ( sVal ) Then sVal = ""		
		
		If sVal <> "" and iRet > 0 Then
			Choose Case sVal
				case "COULEUR_ET_CAPACITE"
					sVal = idwFicFourn.GetItemString ( lCpt, "COULEUR_REMPL" )
					If IsNull ( sVal ) Then sVal = ""		
					If sVal = "" Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement, si le champ AUTRES_INFOS_REMPL est renseigné avec COULEUR_ET_CAPACITE, la couleur doit donc être renseignée." )
					End If 					

					sVal = idwFicFourn.GetItemString ( lCpt, "CAP_STK_REMPL" )
					If IsNull ( sVal ) Then sVal = ""		
					If sVal = "" Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement, si le champ AUTRES_INFOS_REMPL est renseigné avec COULEUR_ET_CAPACITE, la capacité de stockage doit donc être renseignée." )
					End If 					
					
					
				case "COULEUR"
					
					sVal = idwFicFourn.GetItemString ( lCpt, "COULEUR_REMPL" )
					If IsNull ( sVal ) Then sVal = ""		
					If sVal = "" Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement, si le champ AUTRES_INFOS_REMPL est renseigné avec COULEUR, la couleur doit donc être renseignée." )
					End If 						
					
				case "CAPACITE"
					
					sVal = idwFicFourn.GetItemString ( lCpt, "CAP_STK_REMPL" )
					If IsNull ( sVal ) Then sVal = ""		
					If sVal = "" Then
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement, si le champ AUTRES_INFOS_REMPL est renseigné avec CAPACITE, la capacité de stockage doit donc être renseignée." )
					End If 					
										
			End Choose 
		End If 

		sVal = String ( idwFicFourn.GetItemDecimal ( lCpt, "PRIX_TTC_REMPL" ))
		If IsNull ( sVal ) Then sVal = "0"

		If sVal = "" Or Not IsNumber ( sVal ) Or Pos ( sVal, ",") > 0 Or Pos ( sVal, "E") > 0 Or Pos ( sVal, "€") > 0 Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Sur un SWAP ou un Remplacement le champ PRIX_TTC_REMPL doit être renseigné avec le montant TTC de l'appareil de remplacement avec un point en séparateur de décimal et aucun symbole de monnaie." )
		End If 

		If IsNumber ( sVal ) Then
			If Long ( sVal) = 0 Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") sur un SWAP ou un Remplacement le champ PRIX_TTC_REMPL doit être renseigné avec le montant TTC de l'appareil de remplacement avec un montant positif." )
			End if		
		End If 


		sVal = idwFicFourn.GetItemString ( lCpt, "NEUF_REC_REMPL" )  
		Choose Case sVal
			Case "NEU", "REC", "NDI"
				// Ok
			Case Else
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") sur un SWAP ou un Remplacement le champ NEUF_REC_REMPL est obligatoire et doit contenir les valeurs NEU ou REC ou NDI." )
		End Choose 
		
	End If		

	/*------------------------------------------------------------------*/
	/* PRBLE_LIVRAISON 																  */
	/*------------------------------------------------------------------*/	
	sVal = idwFicFourn.GetItemString ( lCpt, "PRBLE_LIVRAISON" )  

	If IsNull ( sVal ) Then sVal = ""
	
	If sVal <> "" Then
		Choose Case sVal
			Case "COLIS_PND", &
				  "COLIS_NRPAC", &
				  "COLIS_PERDU", &
				  "COLIS_BALNI", &
				  "COLIS_INCOR", &
				  "COLIS_REFUS", &
				  "ANNUL_REFAIT", &
				  "EN_ATTENTE", &
				  "AUTRE"
			Case Else 

				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur le champ PRBLE_LIVRAISON n'est pas valide." )

		End Choose 
	End If 


	/*------------------------------------------------------------------*/
	/* PEC_PRBLE_LIVRAISON [PM450-1]												  */
	/*------------------------------------------------------------------*/
	sVal  = idwFicFourn.GetItemString ( lCpt, "PEC_PRBLE_LIVRAISON" )  
	sVal1 = idwFicFourn.GetItemString ( lCpt, "PRBLE_LIVRAISON" )  

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1 ) Then sVal1 = ""		
	
	If sVal <> "" Then
		Choose Case sVal
			Case "OUI", &
				  "NON"
			
					// Ok
					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la valeur " + Upper ( sVal ) + " contenue sur le champ PEC_PRBLE_LIVRAISON, n'est pas valide (attendu OUI ou NON)." )

		End Choose 
		
		If sVal1 = "" Then
			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le champ PEC_PRBLE_LIVRAISON n'est autorisé que si précédemment il y a eu une valeur sur PRBLE_LIVRAISON, qui est justement absente." )
		End If 			
	End If 	


	/*------------------------------------------------------------------*/
	/* INFO_FRN_SPB_CPLT													  			  */
	/*------------------------------------------------------------------*/
	// Dde de SAV
	sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu , "DDE_SAV", ";")
	If IsNull ( sVal ) Then sVal = ""
	
	If sVal = "OUI" Then
		Choose Case sCodEtat
			Case "RFO", "RPC"
				
				Choose case iStatusGc
					Case 2
						// OK
					Case Else 
						iRet = -1
						This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
						" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour demander un SAV, la prestation d'origine doit être en état <<Répara>> (2)" )
				End Choose					
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Pour demander un SAV, la prestation d'origine doit Fermée (non annulée)" )
				
		End Choose
	End If 
	
	// Demande automatique de PEC_A_RECYCLER ou REFUSE_A_REEXP par le fournisseur
	sVal  = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu , "AUTO_PEC_RAR", ";")	
	sVal1 = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu , "PRESTA_AUTO", ";")	
//	sVal2 = lnvPFCString.of_Getkeyvalue ( sChaineBcv, "DERN_ID_REF_FOUR", ";")	

	If IsNull ( sVal ) Then sVal = ""
	If IsNull ( sVal1) Then sVal1 = ""
//	If IsNull ( sVal2) Then sVal2 = ""	

	If sVal = "OUI" Then
		
		Choose Case sVal1
			Case "PEC_A_RECYCLER", "REFUSE_A_REEXP"
				//
			Case Else 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le bcv AUTO_PEC_RAR ne peut attendre que deux valeurs qui sont PEC_A_RECYCLER et REFUSE_A_REEXP" )
				
		End CHoose 

		If iRet = 0 Then
			Choose Case iStatusGc 
				Case 2, 11, 12, 21, 151, 152, 155, 157, 160, 161, 165, 166, 170, 171, 172, 173, 176, 175, 167, 168, 178, 179, 303, 304, 601, 602 
	
					Choose Case sIdRefFour
						Case "A_DIAGNOSTIQUER", "A_REPARER"
							// Ok
						Case Else 
							iRet = -1
							This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
							" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Les demandes automatique de PEC_A_RECYCLER ou REFUSE_A_REEXP ne peuvent se faire que sur une prestation d'origine fermée" )
					End CHoose 					
			End Choose 
			
		End If 		
		
	End If 


	/*------------------------------------------------------------------*/
	/* AUTRES CONTROLES de comparaison de données                       */ 
	/*------------------------------------------------------------------*/
	
	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un status_gc différent de 21 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If lVal <> 21 And ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") présence d’une clé de type [SAV_NO_OK] ou [BRIS] avec un statut différent de 21 => interdit " )
	End IF

	// - présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour à une commande avec action = A_REPARER ou A_REPARER_FORCE 
	sVal = String ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) )		
	If ( Pos ( sVal, "[SAV_NO_OK]" ) > 0 Or Pos ( sVal, "[BRIS]" ) > 0 ) &
		 And ( sIdRefFour = "A_REPARER" Or sIdRefFour = "A_REPARER_FORCE" ) &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REPARER_SAV", ";") <> "OUI" &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_CONTROLER_SAV", ";") <> "OUI" &
		 And lnvPFCString.of_Getkeyvalue ( sInfoSpbFrnCplt , "A_REP_GARANTIE", ";") <> "OUI" &		 
	Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") présence d’une clé de type [SAV_NO_OK] ou [BRIS] dans un retour sur une commande sans demande de SAV (donc n’impliquant pas d’action = A_REPARER_SAV ou A_CONTROLER_SAV ) => interdit" )
	End IF 

	// Le statut en base ne peut plus être modifié
	Choose Case iStatusGc
		Case 2, 11, 12, 21, 151, 152, 155, 157, 160, 161, 165, 166, 170, 171, 172, 173, 176, 175, 167, 168, 178, 179, 303, 304, 601, 602
	
			lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
			
			If iStatusGc <> lVal And lVal > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut en base (" + String ( iStatusGc ) + ") ne permet plus l'acceptation d'un autre statut (" + string (lVal) + "). Le fournisseur doit intégrer cette règle dans son système." )
			End If

	End CHoose
	
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal = 155 And sIdRefFour <> "REFUSE_A_REEXP" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " ne peut être renvoyé que sur une prestation de type REFUSE_A_REEXP" )
	End If


	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	If lVal <> 155 And sIdRefFour = "REFUSE_A_REEXP" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") une prestation de type REFUSE_A_REEXP ne peut recevoir qu'un Statut 155 en retour, et non " + String ( lVal ) + "." )
	End If
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	Choose Case sIdRefFour  
		Case "A_REPARER_FORCE", "A_DIAG_FORCE"

			If lVal > 0 Then
				iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il est interdit de répondre sur les prestations de type A_REPARER_FORCE, et A_DIAG_FORCE, or vous renvoyez le Statut " + String ( lVal ) + ". Si une réponse doit être apportée, vous devez répondre sur la préstation d'origine liée à ce forçage." )
			End If
	End Choose		
	
	
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) )
	Choose Case lVal
		Case 152, 21, 612
			
			If IsNull ( sVal ) Or sVal = "" Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le Statut " + String ( lVal ) + " doit obligatoirement être accompagné d'un commentaire." )
			End If
			
	End CHoose
	
	
	// IRREP_QUALIFIE
	sVal1= idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) 
	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )		
	
	If lVal = 21 And &
		( &
		  Pos ( sVal1, "[BNVSOX]") <= 0 And &
		  Pos ( sVal1, "[CRSMTPEC]") <= 0 And &
		  Pos ( sVal1, "[BNV]") <= 0 And &
		  Pos ( sVal1, "[OXY]") <= 0 And &
		  Pos ( sVal1, "[PIE]") <= 0 And &
		  Pos ( sVal1, "[PNC]") <= 0 And &
		  Pos ( sVal1, "[BRIS]") <= 0 And &
		  Pos ( sVal1, "[SAV_NO_OK]") <= 0 And &
		  Pos ( sVal1, "[BVIEOX]") <= 0 And &
		  Pos ( sVal1, "[EXP]") <= 0  And &			  
		  Pos ( sVal1, "[BVIE]") <= 0  And &			  
  		  Pos ( sVal1, "[PNV]") <= 0  And &			  
		  Pos ( sVal1, "[NOSPBS]") <= 0 And & 
		  Pos ( sVal1, "[BVID]") <= 0 And & 
		  Pos ( sVal1, "[BVIP]") <= 0 And & 				 
		  Pos ( sVal1, "[BVIT]") <= 0 And &
		  Pos ( sVal1, "[PRDV]") <= 0 And &		  
		  Pos ( sVal1, "[DNCAD]") <= 0 &		  
		  ) &
		  Then

			iRet = -1
			This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
			" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Il manque dans le commentaire un des mots clés obligatoire qualifiant l'irréparable." )

	End If 

	// [CTRLE_DATE_INTRG_FOU]
	// sVal = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) )  			
	sVal = String ( dtDteRcpFrn )
	sVal1 = String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) )  		
	iRet = This.Uf_Ctrl_Date ( "CAS1", iRet, lCpt, lIdSin, lIdseq, sIdRefFour, sChaineBCV, sVal, sVal1 )
	


	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
	Choose Case sIdRefFour 
		Case "A_REPARER"
			
			Choose Case lVal 
					
				Case 151, 152, 170, 171
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le code retour " + String ( lVal ) + " n'est pas valide pour un retour de REPARATION (c'est un retour valable pour un diagnostic)." )
			
			End Choose 				
			
	End Choose 


	lVal = idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" )				
	Choose Case sIdRefFour 
		Case "A_DIAGNOSTIQUER"
			
			Choose Case lVal 
					
				Case 2, 21
					iRet = -1
					This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
					" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") le code retour " + String ( lVal ) + " n'est pas valide pour un retour de DIAGNOSTIC (c'est un retour valable pour un réparation)." )
			
			End Choose 				
			
	End Choose 	

	// Contrôle des données liées au SAV
   sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DDE_SAV", ";") 
	sVal1 = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "id_hub_presta_sav" ) ) )
	
	If IsNull ( sVal1 ) Then sVal1 = ""
	
	If sVal = "OUI" And sVal1 = "" Then
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") la demande d'une prestation de SAV doit obligatoirement s'accompagner d'un ID_HUB_PRESTA_SAV transmis par le Hub Prestataire." )
	End IF 


	// Marquage du nbre de SAV actuel, exploité dans l'intégration physique en Aval
	If sVal = "OUI" And sVal1 <> "" Then
		sVal = lnvPFCString.of_getkeyvalue (sChaineBCV, "NBRE_SAV_ACTUEL", ";")
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCpltLu, "NBRE_SAV_ACTUEL", sVal, ";")
		idwFicFourn.SetItem  ( lCpt, "INFO_FRN_SPB_CPLT", sInfoFrnSpbCpltLu )
	End If 

	// [HUB1267]
	If bF_CLE_A_TRUE_HUB1267 Then
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CMDE_REMPL_AUTO", ";") 
		If sVal = "OUI" Then
			sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_FOUR_REMPL", ";")
			If IsNull ( sVal ) Then sVal = ""
			
			If SQLCA.PS_S_CODE_DANS_FAMILLE_CAR ( 1, sVal ) <= 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Dans le cadre du remplacement automatique, le prestataire " + sVal + " n'est pas un prestataire existant sur le HUB en lien avec SIMPA2." )
			End If 
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_HUB_PRESTA_REMPL", ";"))
			If IsNull ( sVal ) Then sVal = ""
			
			IF sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Dans le cadre du remplacement automatique, l'ID_HUB_PRESTA_REMPL (id_benefit) de la prestation de remplacement engagée, est obligatoire." )
			End If 
			
			If SQLCA.PS_S_RECH_ID_HUB_PRESTA_SUR_UN_DOSSIER ( lidsin, sVal ) > 0 Then
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Dans le cadre du remplacement automatique, l'ID_HUB_PRESTA_REMPL (id_benefit) de la prestation de remplacement, existe déjà pour ce dossier de sinistre." )
			End If 
			
			
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_POINT_SERV_REMPL", ";"))
			If IsNull ( sVal ) Then sVal = ""
			
			IF sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Dans le cadre du remplacement automatique, l'ID_POINT_SERV_REMPL de la prestation de remplacement engagée, est obligatoire." )
			End If 

			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_MODE_LOGIS_REMPL", ";"))
			If IsNull ( sVal ) Then sVal = ""
			
			IF sVal = "" Then 
				iRet = -1
				This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
				" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Dans le cadre du remplacement automatique, l'ID_MODE_LOGIS_REMPL de la prestation de remplacement engagée, est obligatoire." )
			End If 		
		
		End IF		
		
	End If 
	
	

	//////////////////////////////////////////////////////
	// Coder au dessus de cette ligne pour les contrôle //
	//////////////////////////////////////////////////////
	
	// #6 [MSS_DIAG].[20091207111441740]
	// [20091228114718123]
	If iRet > 0 Then
		if not uf_ctrl_general_bloquant (lIdSin, lIdSeq, lCpt, sIdFourCtrl ) Then
			iRet = -1
		end if
	End If

	// Maj du rejet côté Hub
	sVal = lnvPFCString.of_getkeyvalue (sInfoFrnSpbCpltLu, "ID_DEPOT_HUB", ";")	
	If iRet = -1 Then // Rejet (R)
		sSqlHub = "Update edi.DepotHubToSimpa2Presta Set alt_trt = 'R' where id_depot_hub = '" + sVal + "'"
	Else // Traité (O)
		sSqlHub = "Update edi.DepotHubToSimpa2Presta Set alt_trt = 'O' where id_depot_hub = '" + sVal + "'"		
	End If 
	lErrorHubPresta = F_Execute_Hub_Prestataire ( sSqlHub, itrHubPrestataire, lIndentityHubPresta, lRowCountHubPresta )
	bRet = lErrorHubPresta = 0 And itrHubPrestataire.SqlCode = 0 And itrHubPrestataire.SqlDBCode = 0
	
	If bRet Then
		F_Commit_Hub_Prestataire ( itrHubPrestataire, True)			
	Else
		F_Commit_Hub_Prestataire ( itrHubPrestataire, False )	
		iRet = -1
		This.uf_Trace ( "ECR", "ERREUR ligne : " + String ( lCpt ) + " / IdDepotHub : " + sIdDepotHub + " / IdHubPresta : " + sIdHubPresta + & 
		" : (" + String ( lIdsin) + "-" + String (lIdSeq) + ") Problème de mise à R/O sur le HUB lors du contrôle (id_depot_hub = " + String (sVal) + "." )
	End If 
Next

If iRet < 0 Then This.uf_Trace ( "ECR", "ERREUR : Le fichier fournisseur n'a pas été chargé.")


// connexion au Hub Prestataire
This.uf_Hub_GestionTransSqlHubPresta ( "DECONNEXION_HUB" )

Return iRet

end function

private function integer uf_integration_fichier_frn_hub (ref long alnblig, ref long alnbligmod, ref long alnblignontraitee);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_pg_in_fic_SuiviCmd::uf_Integration_Fichier_Frn_Hub (PRIVATE)
//* Auteur			: JFF
//* Date				: 28/05/2024
//* Libellé			: Intégration des fichier en base des frn lié au Hub
//* Commentaires	: [HP252_276_HUB_PRESTA] Intégration de Fichier Hub Presta
//*
//* Arguments		: Long		alNbLig		Ref
//*					  
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//       JFF   31/03/2025 [MIG82_JOURN_EVT]
//       JFF   23/04/2025 [HUB1267]
//       JFF   23/05/2025 [HUB1530]
//*-----------------------------------------------------------------

Int iRet, iCleNum, iIdSeqSavRet
DateTime dtDteRcpFrn, dtDteArrPlatForm, dtDteDepPlatForm 
String	sSql, sVal, sSqlOrig, sIdFour, sMesRetour, sInfoFrnSpbCpltLu, sVal1
String sChaineMailRempl, sSqlHub 
Long		lTotLig, lCpt, lVal, lIdSin, lIdSeq, lErrorHubPresta, lIndentityHubPresta, lRowCountHubPresta
Decimal {2} dcMtFrais
String sInfoFrnSpbCplt  	
n_cst_string lnvPFCString  
Boolean bSwap, bDemandeSavHubPresta, bRet, bDdeCreationReellePrestaSav, bCmdeRemplAuto
Int iRetMailPush 
String sDestEnvoi 
String sCasRetour, sIdAppli, sBase, sCommentFrn 
Long lStatusGc 
DataStore dsHubDonneesPrestaSimpa2 	
Boolean bF_CLE_A_TRUE_MIG82_JOURN_EVT
Boolean  bF_CLE_A_TRUE_HUB1267

// [HUB1267]
bF_CLE_A_TRUE_HUB1267 = F_CLE_A_TRUE ( "HUB1267" )

// [MIG82_JOURN_EVT]
bF_CLE_A_TRUE_MIG82_JOURN_EVT = F_CLE_A_TRUE ( "MIG82_JOURN_EVT" )

sCasRetour = Fill ( " ", 50 )
sIdAppli = "SIMPA2"
sBase = Upper ( SQLCA.DataBase )		

sInfoFrnSpbCplt = ""
iRet = 1
sSqlOrig = "EXEC sysadm.PS_U01_COMMANDE "

lTotLig = idwFicFourn.RowCount ()
alNbLig = lTotLig
alNbLigMod = 0
alNbLigNonTraitee	= 0

// connexion au Hub Prestataire
bRet = This.uf_Hub_GestionTransSqlHubPresta ( "CONNEXION_HUB" )

If Not bRet Then
	
	iRet = -1

	sVal = itrHubPrestataire.SQLErrText		
	sVal = f_remplace(sVal,Char(9)," ")
	sVal = f_remplace(sVal,Char(10)," ")		
	sVal = f_remplace(sVal,Char(11)," ")				
	sVal = f_remplace(sVal,Char(13)," ")	

	This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème de connexion au Hub Prestataire, msg SqlServer => : " + sVal )
	
	F_commit ( SQLCA, False )
	Return iRet
			
End If 			

dsHubDonneesPrestaSimpa2 = Create dataStore
dsHubDonneesPrestaSimpa2.DataObject = "d_stk_hub_presta_donnees_simpa2"
dsHubDonneesPrestaSimpa2.SetTransObject ( SQLCA )

iCleNum = F_CLE_NUMERIQUE ( "HP252_276_HUB_PRESTA" )

For lCpt = 1 To lTotLig 

	bSwap = False
	bDemandeSavHubPresta = False
	bCmdeRemplAuto = False // [HUB1267]
	bDdeCreationReellePrestaSav = False
	sInfoFrnSpbCplt = "" //* #3 [FNAC_PROD_ECH_TECH]
	sInfoFrnSpbCpltLu = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "INFO_FRN_SPB_CPLT" ) ) )
	iIdSeqSavRet = 0

	// [MANTIS14172]
	If IsNull ( sInfoFrnSpbCpltLu ) Then sInfoFrnSpbCpltLu = ""

	// [BLCODE]
	sIdFour = idwFicFourn.GetItemString ( lCpt, "FOURNISSEUR" ) 			
	sSql = sSqlOrig

	/*------------------------------------------------------------------*/
	/* ZONE 1 : ID_SIN	                                               */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) )

	// Le n° de Cmde peut être nulle, en effet le système de gestion de commandes
	// n'était peut-être pas encore en production au moment de "cette" cmde par les 
	// gestionnaires.

	If IsNull ( sVal ) Or sVal = "" Then 
		alNbLigNonTraitee	++
		This.uf_Trace ( "ECR", "AVERTISSEMENT ! : Enregistrement " + String ( lCpt ) + " non traité, pas de n° de Commande..." )
		Continue		
	End If 

	lIdSin = Long ( Left ( sVal, Pos ( sVal, "-", 1 ) - 1 ) )

// [ITSM62176] ajout du point de décimal
	sSql += String ( lIdSin ) + "., "

	/*------------------------------------------------------------------*/
 	/* ZONE 2 : ID_SEQ	                                               */
	/*------------------------------------------------------------------*/
	lIdSeq = Long ( Right ( sVal, Len ( sVal ) - Pos ( sVal, "-", 1 ) ) ) 
	sSql += String ( lIdSeq ) + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 3 : ID_CMD_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_FRN" ) ) + "'"
	If Trim ( sVal ) = "" Or Trim ( sVal ) = "''" Then SetNull ( sVal )
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 4 : ID_SERIE_NOUV														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_IMEI_REMPL" ) ) + "'"
	If IsNull ( sVal ) Or sVal = "" Then 
		sVal = "'" + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_SERIE_REMPL" ) ) + "'"		
	End If 
	If Trim ( sVal ) = "" Or Trim ( sVal ) = "''" Then SetNull ( sVal )
	If IsNull ( sVal ) Then sVal = "null"	
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 5 : DTE_RCP_FRN 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" ) ) ), 10 ) + "'"
	If Trim ( sVal ) = "" Or Trim ( sVal ) = "''" Then SetNull ( sVal )
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "
	dtDteRcpFrn = idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_FRN" )

	/*------------------------------------------------------------------*/
	/* ZONE 6 : DTE_ENV_CLI 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_FIN_TRAIT" ) ) ), 10 ) + "'"
	If Trim ( sVal ) = "" Or Trim ( sVal ) = "''" Then SetNull ( sVal )
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 7 : ID_BON_TRANSP 														  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NUM_BON_TRP" ) ) ) + "'"
	If Trim ( sVal ) = "" Or Trim ( sVal ) = "''" Then SetNull ( sVal )
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 8 : COD_ETAT																  */
	/*------------------------------------------------------------------*/
	This.uf_definir_codetat_Frn_Hub ( sVal, lCpt, lIdSin, lIdSeq )
	sSql += "'" + sVal + "', "

	/*------------------------------------------------------------------*/
	/* ZONE 9 : COMMENT_FRN															  */
	/*------------------------------------------------------------------*/
	sVal = Trim ( idwFicFourn.GetItemString ( lCpt, "COMMENT_FRN" ) ) 
	sCommentFrn = sVal
	This.uf_FormatChaine ( sVal )
	sVal = "'" + sVal + "'"

	If Trim ( sVal ) = "" Or Trim ( sVal ) = "''" Then SetNull ( sVal )
	If IsNull ( sVal ) Then sVal = "null"

	sSql += sVal + ", "
//	sCommentFrn = sVal

	/*------------------------------------------------------------------*/
	/* ZONE 10 : ID_BSP																  */
	/*------------------------------------------------------------------*/
	sSql += "0, "

	/*------------------------------------------------------------------*/
	/* ZONE 11 : DTE_RET_PRET														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 12 : DTE_ELV_MOBILE													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 13 : STATUS_GC															  */
	/*------------------------------------------------------------------*/
	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	If IsNull ( sVal ) Then sVal = "0"
	sSql += sVal + ", "
	lStatusGc = Long ( sVal )

	/*------------------------------------------------------------------*/
	/* ZONE 14 : DTE_EMIS_DEVIS													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal+ ", "

	/*------------------------------------------------------------------*/
	/* ZONE 15 : MT_DEVIS															  */
	/*------------------------------------------------------------------*/
	sVal = "0"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 16 : ALT_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "'N'"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 17 : DTE_DEV_ACP														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 18 : DTE_RET_LOGIS														  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 19 : DTE_RET_PRET_MIN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 20 : DTE_RET_PRET_MAX													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 21 : DTE_ENV_BTE_FRN													  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 22 : DTE_RCP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 23 : DTE_DEP_BTE_CLI  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 24 : DTE_ENV_ST			  												  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 25 : DTE_RCP_MOB_CLI	  												  */
	/*------------------------------------------------------------------*/
	sVal = "'" + Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RCP_APP_CLI" ) ) ), 10 ) + "'"
	If Trim ( sVal ) = "" Or Trim ( sVal ) = "''" Then SetNull ( sVal )
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 26 : ID_ORIAN_MODELE	  												  */
	/*------------------------------------------------------------------*/
	sVal = "2" // Indique "Pas de piece" pour traitement normal dans PS_U01_COMMANDE
	sSql += sVal + ", "

	/*------------------------------------------------------------------*/
	/* ZONE 27 : NOM_TRANSPORTEUR (adrfc_nom)	#1 [DCMP080199]			  */
	/*------------------------------------------------------------------*/
	sVal = "'"+Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NOM_TRANSPORTEUR" ) ) ) + "'"
	If Trim ( sVal ) = "" Or Trim ( sVal ) = "''" Then SetNull ( sVal )
	If IsNull ( sVal ) Then sVal = "null"
	sSql += sVal + ","

	/*------------------------------------------------------------------*/
	/* ZONE 28 : MARQUE (id_marq_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 29 : MODELE (id_modl_art) [MICROMANIA]			 				  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "
	
	/*------------------------------------------------------------------*/
	/* ZONE 30 : PRIX TTC ( mt_ttc_cmde ) [MICROMANIA]			 			  */
	/*------------------------------------------------------------------*/
	sVal = "null"
	sSql += sVal + ", "


	// Préparation zone INFO_FRN_SPB_CPLT 
	// Trt zone virtuelle RDV_CONF vers sInfoFrnSpbCplt
	
	sVal =  Left ( Trim ( String ( idwFicFourn.GetItemDateTime ( lCpt, "DTE_RDV_CONF" ) ) ), 10 )
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RDV_CONF", sVal, ";")
	End If

	// [PM445-1]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "TYP_BA_ALLER" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TYP_BA_ALLER", sVal, ";")
	End If			

	// [PM445-1]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "PERTE_ALLER" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PERTE_ALLER", sVal, ";")
	End If	

	// [PM246]
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "PRBLE_LIVRAISON" ) ) )
	if Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRBLE_LIVRAISON", sVal, ";")
	End If		
	// [PM246]	
	
	// [PM450-1]	
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "PEC_PRBLE_LIVRAISON" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PEC_PRBLE_LIVRAISON", sVal, ";")
	End If

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "DIAG_VIDEO_ENGAGE" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DIAG_VIDEO_ENGAGE", sVal, ";")
	End If

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "RESOLU_DIAG_VIDEO" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RESOLU_DIAG_VIDEO", sVal, ";")
	End If

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "MODE_LOGIS_RET" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODE_LOGIS_RET", sVal, ";")
	End If

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "POINT_SERVICE_RET" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "POINT_SERVICE_RET", sVal, ";")
	End If

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "SITE_ACTION" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SITE_ACTION", sVal, ";")
		
		// On mémorise pour ne pas le perdre qu'il y a eu inter par DISTANCE au début, même si ensuite on en a DOMICILE
		IF sVal = "DISTANCE" Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "SITE_ACTION_ORIG", sVal, ";")			
		End IF 
		
	End If

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "AUTRES_INFOS_REMPL" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "AUTRES_INFOS_REMPL", sVal, ";")
	End If			

	// Traitement sur SWAP
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "APP_SWAP" ) ) )
	If sVal = "OUI" Then
		bSwap = True
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_SWAP", sVal, ";")
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "TGR_APPSW", sVal, ";")	// Trigger Technique 
	End If 		

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "MARQUE_REMPL" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		If bSwap Then 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQSW", sVal, ";")
		Else 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MARQ_REMPL", sVal, ";")			
		End If 
	End If			
	
	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "MODELE_REMPL" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		If bSwap Then 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODLSW", sVal, ";")
		Else
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MODL_REMPL", sVal, ";")
		End If 
	End If			

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "COULEUR_REMPL" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "COUL_REMPL", sVal, ";")
	End If			

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "CAP_STK_REMPL" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CAP_STK_REMPL", sVal, ";")
	End If			

	sVal = String ( idwFicFourn.GetItemDecimal ( lCpt, "PRIX_TTC_REMPL" ), "##0.00" ) 
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		If bSwap Then 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MTTTCSW", sVal, ";")
		Else	
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "MT_TTC_REMPL", sVal, ";")
		End If 
	End If			

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "NEUF_REC_REMPL" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NEUF_REC", sVal, ";")
	End If		

	sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "APP_INCOMPLET" ) ) )
	If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
		lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", sVal, ";")
	End If
	
	// [MIG82_JOURN_EVT]
	If bF_CLE_A_TRUE_MIG82_JOURN_EVT Then
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "INFO_JOURNAL", ";") 		
		If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "INFO_JOURNAL", sVal, ";")
		End If
	End IF 	

	// [HUB1267]
	If bF_CLE_A_TRUE_HUB1267 Then
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "CMDE_REMPL_AUTO", ";") 
		If sVal = "OUI" Then
			bCmdeRemplAuto = True
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "CMDE_REMPL_AUTO", sVal, ";")

			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_FOUR_REMPL", ";"))
			If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
				lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ID_FOUR_REMPL", sVal, ";")
			End If
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_HUB_PRESTA_REMPL", ";"))
			If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
				lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ID_HUB_PRESTA_REMPL", sVal, ";")
			End If
			
			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_POINT_SERV_REMPL", ";"))
			If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
				lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ID_POINT_SERV_REMPL", sVal, ";")
			End If

			sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "ID_MODE_LOGIS_REMPL", ";"))
			If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
				lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ID_MODE_LOGIS_REMPL", sVal, ";")
			End If

		End IF 
	End If 


	sVal = String ( idwFicFourn.GetItemNumber ( lCpt, "STATUS_GC" ) )
	// [VDOC3290]
	Choose Case sVal 
		Case "169" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "APP_INCOMPLET", "OUI", ";")

		// [PM82][LOT1]
		Case "153" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_153", "OUI", ";")
			
		// [PM82][LOT1]			
		Case "154" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_154", "OUI", ";")

		// [20250416135954333]
		Case "305" 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "RETOUR_305", "OUI", ";")

		
	End Choose
	// [VDOC3290]

	// [PM254_V1]
	If IsNull ( isNomFicOrig ) Then isNomFicOrig = ""
	lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NOM_FIC_FRN", isNomFicOrig, ";")		
	
	/* Section pour renseigner la chaine bcv sInfoFrnSpbCplt à partir de la chaine bcv sInfoFrnSpbCpltLu */
	If Not IsNull( sInfoFrnSpbCpltLu ) and Trim ( sInfoFrnSpbCpltLu ) <> "" Then 

		// DDE_SAV
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "DDE_SAV", ";")
		If Len ( Trim ( sVal ) ) > 0 Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "DDE_SAV", sVal, ";")
			
			If sVal = "OUI" Then

				sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "NBRE_SAV_ACTUEL", ";")
				lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "NBRE_SAV_ACTUEL", sVal, ";")				

				Choose Case sVal
					Case "0", "1"
						bDemandeSavHubPresta = TRUE
					
					Case Else 
						bDemandeSavHubPresta = FALSE
				End Choose
				
				sVal = Trim ( Upper ( idwFicFourn.GetItemString ( lCpt, "ID_HUB_PRESTA_SAV" ) ) )
				
				If Len ( Trim ( sVal ) ) > 0 Then
					lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "ID_HUB_PRESTA_SAV", sVal, ";")
				End If
			End If 
		End If

		// AUTO_PEC_RAR
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "AUTO_PEC_RAR", ";")
		If Len ( Trim ( sVal ) ) > 0 Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "AUTO_PEC_RAR", sVal, ";")
		End If 
		
		// PRESTA_AUTO lié à AUTO_PEC_RAR
		sVal = lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "PRESTA_AUTO", ";")
		If Len ( Trim ( sVal ) ) > 0 Then
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "PRESTA_AUTO", sVal, ";")
		End If 
		
		// [HUB1530]
		sVal = Trim ( lnvPFCString.of_Getkeyvalue ( sInfoFrnSpbCpltLu, "URL_BPPAYE", ";"))
		If Not IsNull(sVal) and Trim ( sVal ) <> "" Then 
			lnvPFCString.of_Setkeyvalue ( sInfoFrnSpbCplt, "URL_BPPAYE", sVal, ";")
		End If
		
		
	End IF 


	
	/*------------------------------------------------------------------*/
	/* ZONE 31 : INFO_FRN_SPB_CPLT ( zone multiple )[FNAC_PROD_ECH_TECH]*/
	/* Une seule affectation à sSql                                     */
	/*------------------------------------------------------------------*/
	sSql += "'" + sInfoFrnSpbCplt + "'"


	/*------------------------------------------------------------------*/
	/* Execution SQL                                                    */
	/*------------------------------------------------------------------*/
	If F_Execute ( sSql, SQLCA ) Then 
		If SQLCA.SQLCode = 0 And SQLCA.SQLDBCode = 0 Then

			// Cas Standard, normal, sans SAV Hub
			// [HUB1267]
			If Not bDemandeSavHubPresta And Not bCmdeRemplAuto Then
				alNbLigMod ++				// #4				
				F_commit ( SQLCA, True )
				Continue
			End If 
			
			// Traitement particulier pour le SAV, Insertion de la Presta dans la base du HUB
			// [HUB1267] C'est exactement le même traitement pour le rempl auto que le SAV
			//           même la PS_HP276_S_S2_RECUPERER_ID_SEQ_SAV ne fait que récupérer l'ID_SEQ max en fait, 
			//           rien à voir avec le "SAV"
			If bDemandeSavHubPresta or bCmdeRemplAuto Then
				SQLCA.PS_HP276_S_S2_RECUPERER_ID_SEQ_SAV  ( lIdSin, iIdSeqSavRet ) 
				
				If Not ( iIdSeqSavRet > 0 ) Then
					iRet = -1

					// [HUB1267]
					If bDemandeSavHubPresta Then 
						This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème de récupération de l'iIdSeqSavRet sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) )
					End If 

					// [HUB1267]
					If bCmdeRemplAuto Then 
						This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème de récupération de l'iIdSeqSavRet (Cas de Rempl. Auto, pas de SAV) sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) )
					End If 
					
		
					F_commit ( SQLCA, False )					
					Continue
				End If 
			
				
				dsHubDonneesPrestaSimpa2.Retrieve ( iCleNum, lIdSin, iIdSeqSavRet )  
				sSqlHub = This.uf_Hub_sql_hubprestataire ( dsHubDonneesPrestaSimpa2 )

				lErrorHubPresta = F_Execute_Hub_Prestataire ( sSqlHub, itrHubPrestataire, lIndentityHubPresta, lRowCountHubPresta )
				bRet = lErrorHubPresta = 0 And itrHubPrestataire.SqlCode = 0 And itrHubPrestataire.SqlDBCode = 0

				If bRet Then
					sSql = "Exec sysadm.PS_HP276_U_S2_MAJ_GEN_PRESTA " + String ( lIdSin ) + "., " + String ( iIdSeqSavRet ) + ", " + String ( lIndentityHubPresta )
					F_Execute ( sSql, SQLCA )
					bRet = SQLCA.SqlCode = 0 And SQLCA.SqlDBCode = 0			
	
					If bRet Then 
	
						alNbLigMod ++				// #4				
						F_commit ( SQLCA, True )
						F_Commit_Hub_Prestataire ( itrHubPrestataire, True )
						Continue
						
					Else // 2ème Maj SIMPA2 Non Ok donc rollback Hub et SIMPA2
						iRet = -1
						alNbLigNonTraitee	++
						// [MODIF_SUITE_REDR]
			
						sVal = SQLCA.SQLErrText
			
						sVal = f_remplace(sVal,Char(9)," ")
						sVal = f_remplace(sVal,Char(10)," ")		
						sVal = f_remplace(sVal,Char(11)," ")				
						sVal = f_remplace(sVal,Char(13)," ")				
			
						This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update PS_HP276_U_S2_MAJ_GEN_PRESTA sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + sVal )
	
						F_Commit_Hub_Prestataire ( itrHubPrestataire, False)
						F_commit ( SQLCA, False)
						
					End If 
				Else // Maj Hub Non Ok donc rollback Hub et SIMPA2
					
					iRet = -1
					alNbLigNonTraitee	++
					// [MODIF_SUITE_REDR]
		
					sVal = itrHubPrestataire.SQLErrText
		
					sVal = f_remplace(sVal,Char(9)," ")
					sVal = f_remplace(sVal,Char(10)," ")		
					sVal = f_remplace(sVal,Char(11)," ")				
					sVal = f_remplace(sVal,Char(13)," ")				
		
					This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'INSERT de la prestation sur le Hub Prestataire sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + ", msg SqlServer => : " + sVal )
				
					F_Commit_Hub_Prestataire ( itrHubPrestataire, False)
					F_commit ( SQLCA, False)
				End If 
			End IF 
			

			
			
		Else // Maj Simpa2 Non Ok (seule)
			iRet = -1
			alNbLigNonTraitee	++
			// [MODIF_SUITE_REDR]

			sVal = SQLCA.SQLErrText

			sVal = f_remplace(sVal,Char(9)," ")
			sVal = f_remplace(sVal,Char(10)," ")		
			sVal = f_remplace(sVal,Char(11)," ")				
			sVal = f_remplace(sVal,Char(13)," ")				

			This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + sVal )

			F_commit ( SQLCA, False )
				
			Continue
		End If
	Else // Maj Simpa2 Non Ok (seule)
		iRet = -1
		alNbLigNonTraitee	++
		
		// [MODIF_SUITE_REDR]
		sVal = SQLCA.SQLErrText		
		sVal = f_remplace(sVal,Char(9)," ")
		sVal = f_remplace(sVal,Char(10)," ")		
		sVal = f_remplace(sVal,Char(11)," ")				
		sVal = f_remplace(sVal,Char(13)," ")	

		This.uf_Trace ( "ECR", "ERREUR ligne " + string ( lCpt ) + " : Problème d'Update sur " + Trim ( idwFicFourn.GetItemString ( lCpt, "NUM_CMD_SPB" ) ) + " msg SqlServer => : " + sVal )

		F_commit ( SQLCA, False )
			
		Continue 
	End If
	
Next

// connexion au Hub Prestataire
This.uf_Hub_GestionTransSqlHubPresta ( "DECONNEXION_HUB" )


If alNbLigNonTraitee	> 0 Then iRet = -1

Return iRet 
end function

private subroutine uf_definir_codetat_frn_hub (ref string asval, long alcpt, long alidsin, long alidseq);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Definir_CodEtat_Frn_Hub (PRIVATE)
//* Auteur			: JFF
//* Date				: 28/05/2024
//* Libellé			: Définition de la commande en fonction des données 
//*					  retourné dans le fichier.
//* Commentaires	: [HP252_276_HUB_PRESTA]
//*
//* Arguments		: asVal		String		Ref
//*					  alcpt		Long			Val
//*					  alIdSin	Long			Val	
//*					  alIdSeq	Long			Val	
//*
//* Retourne		: integer	
//*
//*-----------------------------------------------------------------
//* MAJ   PAR      Date	     Modification
//*-----------------------------------------------------------------
Int iStatusGc, iInfoSpbFrn
String   sCodEtat, sIdRefFour, sIdTypArt, sIdFourBase, sValeur
Long  lVal
Long dcIdProd 
String 	sInfoSpbFrnCplt, sChaineBCV
String sInfoFrnSpbCplt
n_cst_string lnvPFCString


sCodEtat = fill(" ",3)
sIdRefFour = fill(" ",20)
sIdFourBase = fill(" ",3)
sIdTypArt = fill(" ", 3) // [PM166][O2M]
sInfoSpbFrnCplt = fill(" ", 800)
sInfoFrnSpbCplt = fill(" ", 800)
sChaineBCV = fill(" ", 255)

SQLCA.PS_S11_COMMANDE_V07 ( alidsin, alidseq, sIdFourBase, sCodEtat, iStatusGc, sIdRefFour, iInfoSpbFrn, sIdTypArt, dcIdProd, sInfoSpbFrnCplt, sInfoFrnSpbCplt, sChaineBCV )

lVal = idwFicFourn.GetItemNumber ( alCpt, "STATUS_GC" ) 

Choose Case lVal
		
	//* #4 [O2M_DIAG_NOMADE].Lot2.JFF
	// [PM01] Ajout de 167,168	
	//  [PC499][PC501][PC545][-1x3][V5]
	// [VDOC4970] ajout 176
	// [PM284-1] 303
	Case 2,11,12,21,151,152,153,154,155,157,160,161, 165, 166, 170, 171, 167, 168, 179 , 175, 176, 237, 303, 304

		// [VDOC9304_PM82_LOT1]
		// [VDOC15485]
		If ( lVal = 153 ) Then 		// And sIdTypArt = "PRS" ) Then    sortie (Or lVal = 154 ) on ferme vu avec Olfa le 25/02/25
			asVal = "ECT"  // EN COURS DE TRAITEMENT
		Else
			asVal = "RFO"  // REPONSE FOURNISSEUR (Cloture)
		End If

	Case 178, 263, 234 // [PM166][O2M] // [PC938_ORANGE_V3]

		asVal = "RPC"  // Cloture Commande
		
		
	Case else
		asVal = "ECT"  // EN COURS DE TRAITEMENT
		
End Choose		

// [RECUP_DONNEE_O2M]
Choose Case sIdRefFour
	Case "PEC_A_RECYCLER", "PAS_DE_COMMANDE"
		asVal = "RFO"
End Choose 


end subroutine

private function boolean uf_hub_gestiontranssqlhubpresta (string ascas);//*-----------------------------------------------------------------
//*
//* Fonction		: n_cst_int_fic_suivicmd::uf_Hub_GestionTransSqlHubPresta			(PRIVATE)
//* Auteur			: JFF
//* Date				: 21/03/2024
//* Libellé			: [HP252_276_HUB_PRESTA]
//* Commentaires	: Gestion de la transaction avec la base du HUB PRESTATAIRE
//*
//* Arguments		: Aucun
//*
//* Retourne		: Boolean			TRUE 	= Tout se passe bien
//*										 	FALSE	= Il y a un problème
//*
//*-----------------------------------------------------------------
//* MAJ      PAR      Date	  Modification
//*-----------------------------------------------------------------

Boolean bRet
String sSection

Choose Case asCas
	Case "CONNEXION_HUB"
		
		If Not IsValid ( itrHubPrestataire ) Then
			itrHubPrestataire = Create u_Transaction_Hub_Prestataire
		End IF 

		If Upper(SQLCA.Database) = "SIMPA2_PRO" Then
			sSection = "HUB PRESTATAIRE BASE"
		Else
			If F_CLE_NUMERIQUE ( "INSTANCE_PPR_REC_HUB" ) = 1 Then
				sSection = "HUB PRESTATAIRE BASE REC"
			Else
				sSection = "HUB PRESTATAIRE BASE PPR"				
			End If 
				
		End IF 

		bRet = f_ConnectSqlServer_Hub_Prestataire ( stGLB.sFichierIni   , &
											 sSection, &
											 itrHubPrestataire    , &
											 stGLB.sMessageErreur, &
											 stGlb.slibcourtappli, &
											 stGlb.sCodOper          ) 

	Case "DECONNEXION_HUB"
		
		Disconnect using itrHubPrestataire ;
		
		If IsValid ( itrHubPrestataire ) Then Destroy itrHubPrestataire

End CHoose 

		
Return ( bRet )
end function

private function string uf_hub_sql_hubprestataire (ref datastore adshubdonneesprestasimpa2);//*-----------------------------------------------------------------
//*
//* Fonction      : n_cst_int_fic_suivicmd::uf_hub_sql_hubprestataire (PRIVATE)
//* Auteur        : JFF
//* Date          : 20/03/2024
//* Libellé       : Construction du SQL qui sera injecté dans le Hub Prestataire
//* Commentaires  : [HP252_276_HUB_PRESTA]
//*
//* Arguments     : 
//*
//* Retourne      : Boolean	
//*
//*-----------------------------------------------------------------
//*-----------------------------------------------------------------

Boolean bRet
String sTab [70,2], sChaineSqlRet, sVal
Int iTot, iCpt


sTab [1,1]="iCas"  ;  sTab [1,2]="number"
sTab [2,1]="iIdSin"  ;  sTab [2,2]="number"
sTab [3,1]="iIdSeq"  ;  sTab [3,2]="number"
sTab [4,1]="sIdHubPresta"  ;  sTab [4,2]="char(20)"
sTab [5,1]="sIdFour"  ;  sTab [5,2]="char(3)"
sTab [6,1]="sTypDommage"  ;  sTab [6,2]="char(100)"
sTab [7,1]="sPointService"  ;  sTab [7,2]="char(20)"
sTab [8,1]="sModeLogis"  ;  sTab [8,2]="char(20)"
sTab [9,1]="sCodePickUp"  ;  sTab [9,2]="char(20)"
sTab [10,1]="sAdrNomPickUp"  ;  sTab [10,2]="char(40)"
sTab [11,1]="sAdrReferenceAssPickUp"  ;  sTab [11,2]="char(40)"
sTab [12,1]="sAdr1PickUp"  ;  sTab [12,2]="char(40)"
sTab [13,1]="sAdr2PickUp"  ;  sTab [13,2]="char(40)"
sTab [14,1]="sAdrCpltPickUp"  ;  sTab [14,2]="char(40)"
sTab [15,1]="sAdrCpPickUp"  ;  sTab [15,2]="char(5)"
sTab [16,1]="sAdrVillePickUp"  ;  sTab [16,2]="char(40)"
sTab [17,1]="iCodeProcess"  ;  sTab [17,2]="number"
sTab [18,1]="sLibCodeProcess"  ;  sTab [18,2]="char(35)"
sTab [19,1]="iIdGti"  ;  sTab [19,2]="number"
sTab [20,1]="sLibPersoGti"  ;  sTab [20,2]="char(35)"
sTab [21,1]="iIdDetail"  ;  sTab [21,2]="number"
sTab [22,1]="iIdProd"  ;  sTab [22,2]="number"
sTab [23,1]="sLibProd"  ;  sTab [23,2]="char(35)"
sTab [24,1]="sIdProdAdh"  ;  sTab [24,2]="number"
sTab [25,1]="iIdEts"  ;  sTab [25,2]="number"
sTab [26,1]="sIdAdh"  ;  sTab [26,2]="char(19)"
sTab [27,1]="iIdSdos"  ;  sTab [27,2]="number"
sTab [28,1]="sIdTypArt"  ;  sTab [28,2]="char(3)"
sTab [29,1]="iCodCivLivr"  ;  sTab [29,2]="number"
sTab [30,1]="sLibCivLivrCourt"  ;  sTab [30,2]="char(35)"
sTab [31,1]="sLibCivLivrLong"  ;  sTab [31,2]="char(35)"
sTab [32,1]="IdContratAbonne"  ;  sTab [32,2]="char(20)"
sTab [33,1]="NomAss"  ;  sTab [33,2]="char(35)"
sTab [34,1]="PrenomAss"  ;  sTab [34,2]="char(35)"
sTab [35,1]="NomLivr"  ;  sTab [35,2]="char(35)"
sTab [36,1]="PrenomLivr"  ;  sTab [36,2]="char(35)"
sTab [37,1]="sAdr1Livr"  ;  sTab [37,2]="char(35)"
sTab [38,1]="sAdr2Livr"  ;  sTab [38,2]="char(35)"
sTab [39,1]="sAdr3Livr"  ;  sTab [39,2]="char(35)"
sTab [40,1]="sAdrCpLivr"  ;  sTab [40,2]="char(5)"
sTab [41,1]="sAdrVilleLivr"  ;  sTab [41,2]="char(35)"
sTab [42,1]="sNumTel1Ass"  ;  sTab [42,2]="char(20)"
sTab [43,1]="sNumTel2Ass"  ;  sTab [43,2]="char(20)"
sTab [44,1]="sNumTel3Ass"  ;  sTab [44,2]="char(20)"
sTab [45,1]="sMailAssure"  ;  sTab [45,2]="char(128)"
sTab [46,1]="sNumImeiAppSin"  ;  sTab [46,2]="char(20)"
sTab [47,1]="sNumSerieAppSin"  ;  sTab [47,2]="char(20)"
sTab [48,1]="sDescriptionProbleme"  ;  sTab [48,2]="char(255)"
sTab [49,1]="sCodEtat"  ;  sTab [49,2]="char(3)"
sTab [50,1]="dtValideLe"  ;  sTab [50,2]="datetime"
sTab [51,1]="sValidePar"  ;  sTab [51,2]="char(4)"
sTab [52,1]="dtCmdGenLe"  ;  sTab [52,2]="datetime"
sTab [53,1]="sIdRefFour"  ;  sTab [53,2]="char(20)"
sTab [54,1]="sOrdreAction"  ;  sTab [54,2]="char(20)"
sTab [55,1]="iIdAssureur"  ;  sTab [55,2]="number"
sTab [56,1]="sLibAssureur"  ;  sTab [56,2]="char(35)"
sTab [57,1]="sLibPolice"  ;  sTab [57,2]="char(35)"
sTab [58,1]="sTypAppSin"  ;  sTab [58,2]="char(3)"
sTab [59,1]="sLibTypAppSin"  ;  sTab [59,2]="char(35)"
sTab [60,1]="sMarqAppSin"  ;  sTab [60,2]="char(35)"
sTab [61,1]="sModlAppSin"  ;  sTab [61,2]="char(35)"
sTab [62,1]="sRefAppSin"  ;  sTab [62,2]="char(20)"
sTab [63,1]="sNumTelSin"  ;  sTab [63,2]="char(25)"
sTab [64,1]="mtValAchat"  ;  sTab [64,2]="decimal(2)"
sTab [65,1]="mtPriseEnCharge"  ;  sTab [65,2]="decimal(2)"
sTab [66,1]="dtDateAchat"  ;  sTab [66,2]="datetime"
sTab [67,1]="sEtatAppSin"  ;  sTab [67,2]="char(20)"
sTab [68,1]="sCodeVerrou"  ;  sTab [68,2]="char(20)"
sTab [69,1]="sDesimlocke"  ;  sTab [69,2]="char(20)"
sTab [70,1]="sInfo_spb_frn_cplt"  ;  sTab [70,2]="char(800)"


sChaineSqlRet = "Exec edi.PS_HP276_I_HP_VALIDATION_PRESTA_DANS_LE_HUB_PRESTATAIRE "  

iTot = UpperBound ( sTab ) 

For iCpt = 1 To iTot 
	
	Choose Case Left ( sTab [iCpt, 2 ], 4 ) 
		Case "char"
			sVal = adsHubDonneesPrestaSimpa2.GetItemString ( 1, sTab [iCpt, 1 ] )

		Case "deci"
			sVal = String ( adsHubDonneesPrestaSimpa2.GetItemDecimal ( 1, sTab [iCpt, 1 ] ), "##0.00" )

		Case "long", "numb"
			sVal = String ( adsHubDonneesPrestaSimpa2.GetItemNumber ( 1, sTab [iCpt, 1 ] ) )
			
		Case "date"
			sVal = String ( adsHubDonneesPrestaSimpa2.GetItemDateTime ( 1, sTab [iCpt, 1 ] ), "mm/dd/yyyy hh:mm:ss" )  // Date Anglaise sur le HUB
			
	End Choose 
	
	If IsNull ( sVal ) Then sVal = "null"
	
	sVal = F_Remplace ( sVal, "'", "''" )
	sVal = F_Remplace ( sVal, Char(9), " " ) // Tabulation
	
	If sVal <> "null" Then

		Choose Case Left ( sTab [iCpt, 2 ], 4 ) 
			Case "char", "date"
				sVal = "'" + sVal + "'"	
				
		End Choose 
	
	End If 

	If iCpt <> iTot Then sVal += ","	
	
	sChaineSqlRet += sVal 
	
Next 


Return sChaineSqlRet

end function

on n_cst_int_fic_suivicmd.create
call super::create
TriggerEvent( this, "constructor" )
end on

on n_cst_int_fic_suivicmd.destroy
TriggerEvent( this, "destructor" )
call super::destroy
end on

event destructor;

If ISValid ( idwDetPro ) Then Destroy idwDetPro
end event

